<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="elements/pebble-icons/pebble-icons.html">
<link rel="import" href="elements/pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="elements/pebble-styles-app/pebble-styles-app.html">
<link rel="import" href="elements/pebble-elements/pebble-elements.html">
<link rel="import" href="elements/rock-elements/rock-elements.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="elements/bedrock-helpers/data-helper.html">

<!--
`main-app`
Main os app for riversand ui framework

@demo demo/index.html 
-->
<dom-module id="main-app">
	<template>
		<style is="custom-style" include="app-theme">
			app-header {
				color: #fff;
				width:100%;
				min-height: var(--app-header-height);
			}
			
			app-header div[align="left"] {
				width: 410px;
				padding-left: 45px;
			}
			
			app-header div[align="right"] {
				width: calc(100% - 410px);
			}
			
			paper-progress {
				width: 100%;
			}
			
			app-header paper-icon-button {
				--paper-icon-button-ink-color: #fff;
			}
			
			app-drawer-layout {
				--app-drawer-layout-content-transition: margin 0.2s;
			}
			
			app-drawer {
				--app-drawer-content-container: {
					background-color: #eee;
				}
			}
			
			.drawer-content {
				background-color: #036BC3;
				color: white !important;
				overflow-x: hidden;
				height: 100%;
			}
			
			.drawer-content::-webkit-scrollbar-track {
				-webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
				background-color: #A9A9AA;
			}
			
			.drawer-content::-webkit-scrollbar {
				width: 4px;
				background-color: #A9A9AA;
			}
			
			.drawer-content::-webkit-scrollbar-thumb {
				background-color: #A9A9AA;
				border: 1px solid #A9A9AA;
			}
			
			app-toolbar {
				color: #7d8690;
				background-color: white;
				height: var(--app-header-height);
			}
			
			app-toolbar a {
				text-decoration: none;
			}
			
			pebble-vertical-divider {
				--pebble-vertical-divider-color: #ccc;
			}
		</style>
		<style is="custom-style" include="pebble-styles-shared"></style>
		<style is="custom-style" include="pebble-styles-app"></style>
		<style>
			:host {
				--app-primary-color: #4285f4;
				--app-secondary-color: black;
				display: block;
			}
			
			drawer-list {
				margin: 0 20px;
			}
			
			.drawer-list a {
				display: block;
				padding: 0 16px;
				text-decoration: none;
				color: var(--app-secondary-color);
				line-height: 40px;
			}
			
			.drawer-list a.iron-selected {
				color: black;
				font-weight: bold;
			}
			
			#middle-container {
				height: 100%;
				margin-left: 48px;
			}
			
			.profile-style {
				width: 200px;                
				margin-left: 15px;
			}
			.profile-style #userProfile{
				--name-box-styles: {
					color: #000000;
					font-size: 14px;
				};
				--usertype-box-styles: {
					color: #000000;
					font-size: 12px;
				}
			}
			
			#mdmNotifications{
				--notification-badge {
					--pebble-badge-background: orange;
					--pebble-badge-margin-left: -5px;
					--pebble-badge-margin-bottom: -5px;
				}
			}
			#popoverNotifications{
				margin-right: -110px;
				--pebble-popover-width: 250px;				
				--pebble-popover-max-height: 260px;											
			}

			#popoverProfile{	
				--pebble-popover-max-height: 460px;											*/
			}

			#notificationsList{
				--notification-font-size: 14px;	
				--desc-box-styles: {
					text-align: left;
				}														
			}
			
			#appProgress{
				--paper-progress-container: {
					z-index: -1;
				}
			}

			.icon-button {
					--pebble-button: {
						height: 28px;
						min-width: 0.5em;
						vertical-align: middle;
					}
            	}

			.rock-header-style {
				--search-icon-fill-color: #09c021;
			}
			app-header-layout::shadow #contentContainer{
				padding-top: 68px !important;
			}
		</style>
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subRoute}}"></app-route>
		<app-route route="{{subRoute}}" pattern="/:id" data="{{subRouteData}}"></app-route>
		<app-header-layout fullbleed>
			<app-header fixed effects="waterfall">
				<app-toolbar>
					<div align="left">
						<pebble-main-logo logo-url="../src/images/logo.svg" on-logo-click="onDataRouteClick"></pebble-main-logo>
						<pebble-vertical-divider></pebble-vertical-divider>
						<pebble-tenant-logo logo-url="../src/images/Beiersdorf_logo.svg" logo-text="Beiersdorf" on-logo-click="onDataRouteClick"></pebble-tenant-logo>
						<pebble-vertical-divider></pebble-vertical-divider>
					</div>
					<div id="toastArea" align="center"></div>
					<div align="right">
						<rock-header-search class="rock-header-style"></rock-header-search>
						<!--<paper-icon-button icon="pebble-icons:refresh" class="refresh-icon" on-click="onRefreshClick"></paper-icon-button>-->
						<pebble-button icon="pebble-icons:Help" class="icon-button" onclick="window.open('http://docs.riversand.com/docportal')"></pebble-button>				
						<!-- Notifications Section -->
						<rock-notification id="mdmNotifications" label="6" on-click="showNotifications"></rock-notification>
						<pebble-popover id="popoverNotifications" for="mdmNotifications" auto-fit-on-attach no-overlap display-arrow-as-per-target horizontal-align="right">
							<rock-notification-list id="notificationsList" show-line-index="1"
							 notifications='[{"src": "/src/images/no-photo.jpg", "alt": "Notification", "when": "2 hrs ago", "desc": "Delete drafts in #1500000"}, {"src": "/src/images/no-photo.jpg", "alt": "Notification", "when": "November 15, 2016", "desc": "2 merchandising import"}, {"src": "/src/images/no-photo.jpg", "alt": "Notification", "when": "August 01, 2016", "desc": "10 items failed validation"}, {"src": "/src/images/no-photo.jpg", "alt": "Notification", "when": "Apr 10, 2016", "desc": "Delete drafts in #1500000"}, {"src": "/src/images/no-photo.jpg", "alt": "Notification", "when": "November 15, 2016", "desc": "2 merchandising import"}, {"src": "/src/images/no-photo.jpg", "alt": "Notification", "when": "August 01, 2016", "desc": "10 items failed validation"}]
							 '></rock-notification-list>
						</pebble-popover>
					</div>
					<!-- Profile Section -->
					<div class="profile-style">
						<rock-profile id="userProfile" src="images/no-photo.jpg" name="John Smith" usertype="User" icon="pebble-icons:ExpandMore"
										on-click="showProfile"></rock-profile>
						<pebble-popover id="popoverProfile" for="userProfile" auto-fit-on-attach no-overlap horizontal-align="right">
							<pebble-image-viewer src="images/profile.jpg"></pebble-image-viewer>							
						</pebble-popover>
					</div>
				</app-toolbar>
				<paper-progress id="appProgress" class="middle fit" value="0" min="0" max="1000"></paper-progress>
			</app-header>
			<div id="middle-container">
				<rock-content-view-manager id="contentViewManager" on-open="onViewOpen" on-close="onViewClose"></rock-content-view-manager>
			</div>
			<pebble-toast id="toast1">
				New window opened.
			</pebble-toast>
			<!--<rock-footer></rock-footer>-->
		</app-header-layout>
		<app-drawer id="drawerLayout" on-app-drawer-transitioned="onAppDrawerTransitioned" persistent opened has-scrolling-region>
			<div class="drawer-content">
				<iron-ajax auto url="data/menuitems.json" handle-as="json" last-response="{{menuItems}}"></iron-ajax>
				<iron-ajax auto url="../src/data/menurouteitems.json" handle-as="json" last-response="{{menuRouteItems}}"></iron-ajax>
				<rock-navmenu id="navMenu" page="{{page}}" menu-items="{{menuItems}}" active-items="{{activeItems}}" route="{{routeData}}" on-menu-click="onMenuClick" on-menu-close-click="onMenuCloseClick"></rock-navmenu>
			</div>
		</app-drawer>
		<pebble-toast id="pebbleAppToast" vertical-align="top">
				[[toastText]]
		</pebble-toast>
	</template>
	<script>
    Polymer({

    is: 'main-app',
	attached: function(){

		var progress, repeat, maxRepeat = 1, animating = false;
		
		function nextProgress() {
			animating = true;
			if (progress.value < progress.max) {
				progress.value += 10;
			} 
			else {
				if (++repeat >= maxRepeat) {
					animating = false;
					progress.value = 0;
					return;
				}
				progress.value = progress.min;
			}
			requestAnimationFrame(nextProgress);
		}

		function startProgress() {
			repeat = 0;
			progress.value = progress.min;
			if (!animating) {
				nextProgress();
			}
		}
		progress = this.$.appProgress;
		startProgress();
	},
	/**
	* Fired when route is changed.
	*
	* @event route-changed (pub-sub event)
	* @param {Object} detail
	* @param {Object} detail.item item to be collapsed
	*/
	properties:{
		cols: '2',
		page: {
			type: String
		},
		menuItems: {
			type: Array,
			notify: true
		},
		menuRouteItems: {
			type: Object,
			notify: true
		},
		activeItems:{
		    type: Array,
			notify:true,
			value: function () {
				return [];
            }
		},
		toastText: {
			type: String
		}
	  },
      observers: [
        '_routePageChanged(routeData.page)',
        '_pageChanged(page,menuRouteItems,menuItems)'
      ],
      _routePageChanged: function(page) {
        this.page = page || '';
	},

	  _pageChanged: function(page,menuRouteItems,menuItems) {

		if(menuRouteItems && menuItems)
		{
		    if(page==""){
		        var menu= menuItems.filter(
                    function(menu){ return menu.isLandingPage == true }
                );
		        if(menu && menu.length>0){
		           page=menu[0].data_route;
				}
			}
			this.$.contentViewManager.openView(page, this.menuRouteItems[page]);
            this.$.navMenu._collapseExpandDrawer();
		}
		this.fire('bedrock-event', { name: "route-changed", data: {route : this.route} });
      },

      //_showPage404: function() {
      //  this.page = 'view404';
      //},

	  onDataRouteClick: function() {
          var drawer = this.drawerLayout;
		  //ToDo: remove hard coded style and use class toggle
		  drawer.style.width = "256px"; 
	  },

	  // Scroll page to top and expand header
      scrollPageToTop: function() {
         document.getElementById('mainContainer').scrollTop = 0;
	  },

	  onMenuClick: function(e, customArgs) {
		//   debugger;
		//   this.page = customArgs.item.name;
		//   this.$.contentViewManager.openView(customArgs.item.name, customArgs.item);
	  },
	  onMenuCloseClick: function(e, customArgs) {
		  this.$.contentViewManager.closeView(customArgs.item.name);
	  },

	onRefreshClick: function(){
		location.reload();
	},

	onViewOpen: function(e, customArgs) {
		for(var i=0;i<this.menuItems.length;i++) {
			if(this.menuItems[i].data_route == customArgs.viewName) {
				return;
			}
			if(this.menuItems[i].menuItems){
                for(var j=0;j<this.menuItems[i].menuItems.length;j++) {
                    if(this.menuItems[i].menuItems[j].data_route == customArgs.viewName) {
                        return;
                    }
				}
			}
		}
        for(var i=0;i<this.activeItems.length;i++) {
            if(this.activeItems[i].data_route == customArgs.viewName) {
                return;
            }
        }
		this.push("activeItems",customArgs.config);
		this.toastText = "New Window Opened!!"
		this.$.pebbleAppToast.show();
	},
	onViewClose: function(e, customArgs) {
		var viewIndex;
		for(var i=0; i<this.activeItems.length;i++) {
		if(this.activeItems[i].data_route == customArgs.viewName) {
			viewIndex = i;
		}
		}
		this.splice("activeItems", viewIndex, 1);
	},
	showNotifications: function(){		
		this.$.popoverNotifications.show();
	},
	showProfile: function(){		
		this.$.popoverProfile.show();
	}
   });

  </script>
</dom-module>