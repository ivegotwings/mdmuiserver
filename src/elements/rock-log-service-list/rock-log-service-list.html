<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
`<rock-log-service-list>`
<b><i>Content development is under progress... </b></i>

@group rock Elements
@element rock-log-service-list
@demo demo/index.html
-->

<dom-module id="rock-log-service-list">
    <template>
            <style include="bedrock-style-common bedrock-style-gridsystem">
                :host{
                    display: block;
                    height:100%;
                }
               
                rock-grid {
                    --pebble-grid-container:{
                        margin-top:10px;
                        margin-left:20px;
                        margin-right:0px;
                        margin-bottom:0;
                    };
                    --data-table-cell-width:{
                        flex-basis: 0px;
                    };
                }
                .rock-log-servie-wrapper{
                    height:calc(100% - 50px)
                }
                #buttonContainer{
                    padding-top:20px;
                    text-align: center;
                }
                _:-ms-lang(x), _:-webkit-full-screen {
                    vertical-align: top;
                }
            </style>
             <div class="rock-log-servie-wrapper">
            <rock-grid id="importlistGrid" config="{{gridConfig}}" attribute-models="{{_attributeModels}}" page-size="50" data="[[loggerArray]]">
                    <pebble-toolbar id="toolbar" readonly="[[readonly]]" slot="toolbar" config-data="[[_toolbarConfig]]"></pebble-toolbar>
                    <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="toolbar"></bedrock-pubsub>
            </rock-grid>
            <div id="buttonContainer" hidden>
                <pebble-checkbox id="tenantFilterChkBox" class="checkbox-label-color m-r-10" on-change="_onTenantFilterChange">All Tenants</pebble-checkbox>
                <pebble-checkbox id="userFilterChkBox" class="checkbox-label-color m-r-10" on-change="_onUserFilterChange">All Users</pebble-checkbox>

                <pebble-button class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_cancelAction" noink></pebble-button>
                <pebble-button id="statusIcon" class="btn btn-success log-save-button" button-text="Save" on-click="_handleSave"></pebble-button>
                
            </div>
            </div>
            <liquid-rest id="loggerConfigGet" url="/data/logger/get" method="GET" on-liquid-response="_onLoggerConfigGetResponse" on-liquid-error="_onLoggerConfigGetError"></liquid-rest>
            <liquid-rest id="loggerConfigSave" url="/data/logger/set" method="POST" on-liquid-response="_onLoggerConfigSaveResponse" on-liquid-error="_onLoggerConfigSaveError"></liquid-rest>
            
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-log-service-list',

                properties: {
                    config: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    loggerObj: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                    },
                    _toolbarConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                    },
                    loggerArray: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    logger: {
                        type: Array,
                        value: [{
                            "value": "trace",
                            "title": "trace"
                        },
                        {
                            "value": "debug",
                            "title": "debug"
                        },
                        {
                            "value": "info",
                            "title": "info"
                        },
                        {
                            "value": "warn",
                            "title": "warn"
                        },
                        {
                            "value": "error",
                            "title": "error"
                        },
                        {
                            "value": "fatal",
                            "title": "fatal"
                        }]
                    },
                    attributeModelObject: {
                        type: String,
                        value: function () {
                        return {};
                        }
                    },


                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],
                listeners: {
                    'editMode': '_onEditMode'
                },
                _onTenantFilterChange: function(e) {
                    var chkbox = e.currentTarget;
                    if (chkbox.checked) {
                        this.enableAccrossTenant = true;
                    } else {
                        this.enableAccrossTenant = "";
                    }
                },
                _onUserFilterChange: function(e) {
                    var chkbox = e.currentTarget;
                    if (chkbox.checked) {
                        this.enableAccrossUsers = true;
                    } else {
                        this.enableAccrossUsers = "";
                    }
                },
                _onEditMode: function(){
                    var buttonContainer = this.shadowRoot.querySelector('div[id=buttonContainer]');
                    if (buttonContainer) {
                        buttonContainer.hidden = false;
                    }
                } , 
                _cancelAction: function(){
                    this.set("gridConfig.mode", "Read");
                },
                ready: function () {
                    this._getLoggerConfigData();
                },
                _onToolbarEvent: function (e, detail) {
                    this.fireBedrockEvent("rock-toolbar-button-event", detail);
                },
                _onLoggerConfigGetResponse: function (e) {
                    this.set("loggerObj", e.detail.response);
                    this._setLoggerData();
                },
                _getLoggerConfigData: function () {
                    var loggerConfigGet = this.shadowRoot.querySelector("#loggerConfigGet");
                    loggerConfigGet.generateRequest();
                },
                _setLoggerData: function (keywordSearchText) {
                    var arr = []; 
                    var _level;
                    for (var key in this.loggerObj) { 
                        if(this.loggerObj[key] && this.loggerObj[key].level){
                            _level = this.loggerObj[key].level;
                            if (keywordSearchText){
                                if(key.indexOf(keywordSearchText) > -1) {
                                    arr.push({ logName: key, logLevel: _level });
                                }
                            }else{
                                arr.push({ logName: key, logLevel: _level });
                            }  
                        }                           
                    }
                    this.set("loggerArray", arr);
                },
                _handleSave: function () {
                    //todo need to handle save functionality
                    var finalObj = {};
                    for (var i = 0; i < this.loggerArray.length; i++) {
                        finalObj[this.loggerArray[i]["logName"]] = { level: this.loggerArray[i]["logLevel"] }
                    }
                    if(DataHelper.compareObjects(finalObj, this.loggerObj)){
                        this.showInformationToast("No changes to save.");
                    }else{
                        finalObj.globalSettings = {tenant: this.enableAccrossTenant, user: this.enableAccrossUsers};
                        this.generateSaveRequest(finalObj, "update");
                    }
                },
                generateSaveRequest: function (reqData, operation) {
                    var configSaveService = this.shadowRoot.querySelector('#loggerConfigSave');

                    if (configSaveService) {
                    configSaveService.operation = operation;
                    configSaveService.requestData = reqData;
                    configSaveService.generateRequest();
                    }
                },
                _onLoggerConfigSaveResponse: function (e) {
                    this.set("loggerObj", e.detail.response);
                    this._setLoggerData();
                    this.showSuccessToast("Logs Update request submitted successfully.");
                },
                _onLoggerConfigSaveError: function (e) {
                    this.showErrorToast("Error in updating logs, please contact administrator.");
                    console.log("logConfigError", JSON.stringify(e.detail, null, 2))
                },
                observers: ['_contextDataChanged(contextData)'],

                _contextDataChanged: function (contextData) {
                    Polymer.RenderStatus.afterNextRender(this,()=>{
                            if (!_.isEmpty(contextData)) {
                            var context = DataHelper.cloneObject(this.contextData);
                            //App specific
                            var appName = ComponentHelper.getCurrentActiveAppName();
                            if(appName) {
                                context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                    "app": appName
                                }];
                            }
                            this.requestConfig('rock-log-service-list', context);
                        }
                    });                    
                },
                onConfigLoaded: function (componentConfig) {
                    if (componentConfig && componentConfig.config) {
                        this.config = componentConfig.config;
                        if(this.config.gridConfig){
                            var _gridConfig = this.config.gridConfig;
                        }
                        var _attributeModelObject = {
                            "logLevel": {
                                "name": "logLevel", "externalName": "Component Rule",
                                "description": "",
                                "dataType": "string",
                                "groupName": "Basic",
                                "displayType": "Dropdown",
                                "displaySequence": "",
                                "allowedValues": this.logger,
                                "hasWritePermission": true,
                            }

                        };
                        var buttonItems = {
                            "basic": {
                                "buttons": {
                                    "edit": {
                                        "name": "edit",
                                        "icon": "pebble-icon:action-edit",
                                        "text": "",
                                        "visible": true,
                                        "tooltip": "Edit",
                                        "intent": "write"
                                    }
                                }
                            }
                        }
                        var writePermission = true;
                        if (_gridConfig.hasOwnProperty('hasWritePermission')) {
                            writePermission = _gridConfig.hasWritePermission;
                        };
                        buttonItems = DataHelper.convertObjectToArray(buttonItems);
                        for (var i = 0; i < buttonItems.length; i++) {
                            buttonItems[i].buttons = DataHelper.convertObjectToArray(buttonItems[i].buttons);
                            var buttons = buttonItems[i].buttons;
                            if (!writePermission) {
                                for (var j = 0; j < buttons.length; j++) {
                                    if (buttons[j].intent === "write") {
                                        buttons[j].visible = false;
                                    }
                                }
                            }
                        }
                        this.set("_toolbarConfig", { buttonItems })
                        this.set("_attributeModels", _attributeModelObject);
                        this.set("gridConfig", _gridConfig);
                    }
                }
            });
        })();
    </script>

</dom-module>