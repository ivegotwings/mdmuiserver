<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
`<rock-log-service-list>`
<b><i>Content development is under progress... </b></i>

@group rock Elements
@element rock-log-service-list
@demo demo/index.html
-->

<dom-module id="rock-log-service-list">
    <template>
            <style include="bedrock-style-common bedrock-style-gridsystem">
               
                rock-grid {
                    --rock-grid-height: 260px;
                    --pebble-grid-container:{
                        margin-top:20PX;
                        margin-left:0;
                        margin-right:0;
                        margin-bottom:0;
                    };
                }

                _:-ms-lang(x), _:-webkit-full-screen {
                    vertical-align: top;
                }
                .log-save-button{
                    margin-left: 45%;
                    margin-top: 2%
                }
                #input {
                outline: 0;
                cursor: text;
                font-family: var(--default-font-family, 'Roboto', Helvetica, Arial, sans-serif);
                background: transparent;
                color: var(--search-text-color, #75808b);
                font-size: var(--font-size-sm, 12px);
                width: 100%;
                border: 1px solid var(--default-border-color, #c1cad4);
                border-radius: 3px;
                padding: 5px 10px 5px;
                height: 30px;
            }
            </style>
            <input id="input" type="text" value="{{inputValue::input}}" placeholder="Enter Search text">
            <rock-grid id="importlistGrid" no-header config="{{gridConfig}}" page-size="50" data="[[loggerArray]]"></rock-grid>
            <pebble-button id="statusIcon" class="btn btn-success log-save-button" button-text="Save" on-click="_handleSave"></pebble-button>
            <liquid-rest id="loggerConfigGet" url="/data/logger/get" method="GET" on-liquid-response="_onLoggerConfigGetResponse" on-liquid-error="_onLoggerConfigGetError"></liquid-rest>
            <liquid-rest id="loggerConfigSave" url="/data/logger/set" method="POST" on-liquid-response="_onLoggerConfigSaveResponse" on-liquid-error="_onLoggerConfigSaveError"></liquid-rest>
  
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-log-service-list',

                properties: {
                    config: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    loggerObj: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                    },
                    loggerArray: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    inputValue: {
                        type: String,
                        value: "",
                        observer: "_onInputChange"
                    },

                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],
             
                ready: function () {
                    this._getLoggerConfigData();
                },
                _onLoggerConfigGetResponse: function (e) {
                    this.set("loggerObj", e.detail.response);
                    this._setLoggerData();
                },
                _getLoggerConfigData: function () {
                    var loggerConfigGet = this.shadowRoot.querySelector("#loggerConfigGet");
                    loggerConfigGet.generateRequest();
                },
                _setLoggerData: function (keywordSearchText) {
                    var arr = []; 
                    var _level;
                    for (var key in this.loggerObj) { 
                        if(this.loggerObj[key] && this.loggerObj[key].level){
                            _level = this.loggerObj[key].level;
                            if (keywordSearchText){
                                if(key.indexOf(keywordSearchText) > -1) {
                                    arr.push({ title: key, level: _level });
                                }
                            }else{
                                arr.push({ title: key, level: _level });
                            }  
                        }                           
                    }
                    this.set("loggerArray", arr);
                    
                },
                _handleSave: function () {
                    //todo need to handle save functionality
                    var finalObj = {};
                    for (var i = 0; i < this.loggerArray.length; i++) {
                        finalObj[this.loggerArray[i]["title"]] = { level: this.loggerArray[i]["level"] }
                    }
                    if(DataHelper.compareObjects(finalObj, this.loggerObj)){
                        this.showInformationToast("No changes to save.");
                    }else{
                        this.generateSaveRequest(finalObj, "update");
                    }
                },
                generateSaveRequest: function (reqData, operation) {
                    var configSaveService = this.shadowRoot.querySelector('#loggerConfigSave');

                    if (configSaveService) {
                    configSaveService.operation = operation;
                    configSaveService.requestData = reqData;
                    configSaveService.generateRequest();
                    }
                },
                _onLoggerConfigSaveResponse: function (e) {
                    this.set("loggerObj", e.detail.response);
                    this._setLoggerData();
                    this.showSuccessToast("Logs Update request submitted successfully.");
                },
                _onLoggerConfigSaveError: function (e) {
                    this.showErrorToast("Error in updating logs, please contact administrator.");
                    console.log("logConfigError", JSON.stringify(e.detail, null, 2))
                },
                observers: ['_contextDataChanged(contextData)'],

                _contextDataChanged: function (contextData) {
                    Polymer.RenderStatus.afterNextRender(this,()=>{
                            if (!_.isEmpty(contextData)) {
                            var context = DataHelper.cloneObject(this.contextData);
                            //App specific
                            var appName = ComponentHelper.getCurrentActiveAppName();
                            if(appName) {
                                context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                    "app": appName
                                }];
                            }
                            this.requestConfig('rock-log-service-list', context);
                        }
                    });                    
                },
                onConfigLoaded: function (componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        this.config=componentConfig.config;
                        this.set("gridConfig",this.config.gridConfig);
                    }
                },
                _onInputChange: function(){
                    if (this.inputValue && this.inputValue.trim() != "") {
                        this._setLoggerData(this.inputValue)
                    }else{
                        this._setLoggerData()
                    }
                }
            });
        })();
    </script>

</dom-module>