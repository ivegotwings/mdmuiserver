<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-bulk-action-result">
    <template>
        <style include="pebble-styles-shared">
            :host {
                padding-top: 20px;
            }

            #grid-container {
                padding-top: 20px;
                padding-bottom: 20px;
            }

            #user-actions {
                padding-top: 20px;
                padding-bottom: 20px;
            }

            pebble-data-table {
                --iron-data-table-header: {
                    height: 45px;
                }
                --iron-data-table: {
                    height: 275px;
                }
            }

            #inputDiv {
                width: 250px;
                border-bottom: 1px solid #d2d8de;
                height: 42px;
            }

            .attributes-span .context-span {
                line-height: 56px;
            }

            #iconDiv {
                align-self: flex-end;
                -webkit-align-self: flex-end;
                padding-bottom: 5px;
                margin-left: -20px;
                cursor: pointer;
            }

            .dropdown-icon {
                --pebble-icon-height: 10px !important;
                --pebble-icon-width: 10px !important;
            }

            .actionButton {
                margin-right: var(--default-margin, 10px);
            }
            
            pebble-data-table data-table-cell .cell{
                overflow: visible;
            }

            pebble-data-table data-table-cell span{
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                display: block;
            }
        </style>
        <div align="center">[[message]]</div>
        <div id="grid-container" hidden="[[_noGrid]]">
            <pebble-data-table id="bulk-results-grid" items="[[_gridData]]">
                <template is="dom-repeat" items="[[_gridColumns]]" as="column">
                    <data-table-column slot="column-slot" name="[[column]]">
                        <template>
                            <div slot="cell-slot-content" class="cell tooltip-bottom" data-tooltip$="[[_itemValue(item, column)]]"><span>[[_itemValue(item, column)]]</span></div>
                        </template>
                    </data-table-column>
                </template>
            </pebble-data-table>
        </div>
        <div id="user-actions" align="center">
            <template is="dom-repeat" items="[[businessFunctionData.actions]]" as="action">
                <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" icon="pebble-md-icons:actions" button-text="[[action.text]]" 
                    data="[[action]]" on-tap="_onActionTap"></pebble-button>
            </template>
        </div>
        <liquid-entity-data-get name="entityGetService" operation="getbyids" request-data="{{entityRequest}}" on-response="_onEntityGetResponse" 
            on-error="_onEntityGetError"></liquid-entity-data-get>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-bulk-action-result",

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i>
                      */
                    businessFunctionData: {
                        type: Object,
                        value: function () { return {}; }
                    },

                    resultAttributes: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },

                    _gridColumns: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _noGrid: {
                        type: Boolean,
                        value: false
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [
                    'onBusinessFunctionChange(businessFunctionData)'
                ],

                _itemValue: function (item, column) {                    
                    if(!_.isEmpty(item)) {
                        if(!_.isEmpty(this.resultAttributes)) {
                            //Column name is external name, so need name to fetch data 
                            var resultAttr = this.resultAttributes.find(attr => attr.externalName == column.name);
                            if(resultAttr) {
                                return item[resultAttr.name];
                            }
                        }
                        return item[column.name];           
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i>
                  */
                onBusinessFunctionChange: function () {
                    if (!_.isEmpty(this.businessFunctionData)) {
                        var contextData = this.businessFunctionData.contextData;
                        var processedEntities = this.businessFunctionData.processedEntities;
                        var messages = this.businessFunctionData.messages;

                        if(!_.isEmpty(this.resultAttributes) && !_.isEmpty(contextData) 
                           && !_.isEmpty(processedEntities) && !_.isEmpty(messages)) {
                            //Prepare request
                            var entityIds = [...new Set(processedEntities.map((obj) => obj.id))];
                            var entityTypes = [...new Set(processedEntities.map((obj) => obj.type))];
                            var entityAttributes = [...new Set(this.resultAttributes.map((obj) => obj.name))];

                            contextData.ItemContexts = [{
                                "attributeNames": entityAttributes
                            }];

                            this.entityRequest = DataRequestHelper.createEntityGetRequest(contextData);
                            this.entityRequest.params.query.ids = entityIds;
                            this.entityRequest.params.query.filters.typesCriterion = entityTypes;
                            delete this.entityRequest.params.options;
                            var liquidDataGet = this.$$("[name=entityGetService]");
                            if (liquidDataGet) {
                                liquidDataGet.generateRequest();
                            }
                        } else {
                            this._setBulkResponse();
                        }
                    }
                },

                _onEntityGetResponse: function (e) {
                    if (DataHelper.isValidObjectPath(e, "detail.response.content.entities") && 
                       !_.isEmpty(e.detail.response.content.entities)) {
                           var entites = e.detail.response.content.entities;
                           var messages = this.businessFunctionData.messages;
                           var key = this.businessFunctionData.messageKey;

                           this._setColumnsForGrid(messages);

                           for (var i = 0; i < messages.length; i++) {
                               var entity = entites.find(obj => obj.id == messages[i][key]);
                               if (entity) {
                                   for (var j = 0; j < this.resultAttributes.length; j++) {
                                       messages[i][this.resultAttributes[j].name] = AttributeHelper.getFirstAttributeValue(entity.data.attributes[this.resultAttributes[j].name]);
                                   }
                               }
                           }
                    }

                    this._setBulkResponse();
                },

                _setColumnsForGrid: function (messages) {
                    if(_.isEmpty(messages)) {
                        return;
                    }

                    var columns = [];
                    for (var key in messages[0]) {
                        columns.push(key);
                    }

                    for(var i = 0; i < this.resultAttributes.length; i++) {
                        var index = i + 1; // after first column
                        columns.splice(index, 0, this.resultAttributes[i].externalName);
                    }

                    this._gridColumns = columns;
                },

                _onEntityGetError: function (e) {
                    this.logError("Entity get failed");
                    this._setBulkResponse();
                },

                _setBulkResponse: function () {
                    if (this.businessFunctionData.noGrid) {
                        this._noGrid = this.businessFunctionData.noGrid;
                    }

                    if (!this._noGrid) {
                        var messages = this.businessFunctionData.messages;

                        if(_.isEmpty(messages)) {
                            return;
                        }

                        if(_.isEmpty(this._gridColumns)) {
                            var columns = [];
                            for (var key in messages[0]) {
                                columns.push(key);
                            }

                            this._gridColumns = columns;
                        }

                        this._gridData = messages;
                    }
                    else {
                        if (this.businessFunctionData.message) {
                            this.message = this.businessFunctionData.message;
                        }
                    }
                },

                _onActionTap: function (e) {
                    if (e && e.currentTarget && e.currentTarget.data) {
                        var actionData = e.currentTarget.data;
                        actionData.closeBusinessFunction = true;
                        var eventName = "onNext";
                        this.fireBedrockEvent(eventName, actionData, {
                            ignoreId: true
                        });
                    }
                }
            });
        })();
    </script>
</dom-module>