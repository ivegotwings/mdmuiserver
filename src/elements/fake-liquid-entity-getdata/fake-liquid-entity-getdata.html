<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../liquid-behavior/liquid-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<!--
`fake-liquid-entity-getdata`
Boolean control

@demo demo/index.html 
-->
<dom-module id="fake-liquid-entity-getdata">
    <template>
        <!--<iron-ajax url="SampleOutput.json" handle-as="json" last-response="{{entityData}}"> -->
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'fake-liquid-entity-getdata',
                attached: function () {
                     
                },
                ready: function () {
                },
                properties: {
                    lastResponse:{
                        type: Object,
                        notify: true,
                        value: function() {
                            return {};
                        }
                    },
                    requestData:{
                        type: Object,
                        notify: true,
                        value: function() {
                            return {};
                        }
                    },
                    entityData:{
                        type: Object,
                        value: { 
                            "content":{
                                "entities":{
                                    "e6": {
                                        "id": "e6",
                                        "entityInfo": {
                                            "entityType": "nart"
                                        },
                                        "systemInfo": {
                                            "tenantId": "t1"
                                        },
                                        "properties": {
                                            "createdBy": "vishal"
                                        },
                                        "data": {
                                            "ctxInfo": {
                                                "productMaster#@#nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry#@#SAP#@#en-US": {
                                                    "attributes": {
                                                        "ProductName": {
                                                            "values": [
                                                                {
                                                                    "attribute": "attributes/ProductName",
                                                                    "source": "SAP",
                                                                    "locale": "en-US",
                                                                    "value": "Soft Shampoo & Bath"
                                                                },
                                                                {
                                                                    "attribute": "attributes/ProductName",
                                                                    "source": "SAP",
                                                                    "locale": "de-DE",
                                                                    "value": "Soft Shampoo & Bath"
                                                                },
                                                                {
                                                                    "attribute": "attributes/ProductName",
                                                                    "source": "PIM",
                                                                    "locale": "en-US",
                                                                    "value": "Soft Shampoo & Bath"
                                                                },
                                                                {
                                                                    "attribute": "attributes/ProductName",
                                                                    "source": "PIM",
                                                                    "locale": "de-DE",
                                                                    "value": "Soft Shampoo & Bath"
                                                                }
                                                            ]
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                observers:[
                    '_formatResponse(requestData)'
                ],
                _formatResponse: function() {
                    if(this.requestData && this.requestData.params) {

                        var query = this.requestData.params.query;
                        var lists = [];
                        var sources = [];
                        var locales = [];

                        if(query.ctx) {
                            query.ctx.forEach(function(item) {
                                lists.push(item.list);
                            }, this);
                        }

                        if(query.valCtx) {
                            query.valCtx.forEach(function(item) {
                                if(sources.indexOf(item.source) < 0){
                                    sources.push(item.source);
                                }

                                if(locales.indexOf(item.locale) < 0){
                                    locales.push(item.locale);
                                }
                            }, this);
                        }

                        if(this.entityData) {
                            var clonedEntity = DataHelper.cloneObject(this.entityData);
                            if(this.entityData) {
                                var ctxInfo = this.entityData.content.entities["e6"].data.ctxInfo;
                                var attribute = ctxInfo[Object.keys(ctxInfo)[0]].attributes["ProductName"];
                                var selectedValues = [];

                                attribute.values.forEach(function(item) {
                                    if(sources.indexOf(item.source) >= 0 && locales.indexOf(item.locale) >= 0) {
                                        selectedValues.push(item);
                                    }
                                }, this);

                                clonedEntity.content.entities["e6"].data.ctxInfo[Object.keys(ctxInfo)[0]].attributes["ProductName"].values = selectedValues;
                                this.lastResponse = clonedEntity;
                            }
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>