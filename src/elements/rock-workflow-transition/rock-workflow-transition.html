<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">

<dom-module id="rock-workflow-transition">
    <template>
        <style include="pebble-styles-shared">           
            .message {
                text-align: center;
            }            
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>
        <liquid-entity-model-get id="getWorkflowMappingDefinition" operation="getbyids" request-id="wfDefinitionRequest"                          request-data={{workflowMappingDefinitionRequest}}
                                 on-response="_onWorkflowMappingsResponse" on-error="_onWorkflowMappingsError">
        </liquid-entity-model-get>                      
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-workflow-transition',

                properties: {
                    contextData: {
                         type:Object,
                         value: function() {
                            return {};
                         }
                    },

                    selectedEntities: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },

                    currentWorkflow: {
                        type: Object
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },

                    workflowMappingDefinitionRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },                    
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [
                    '_executeTransitionProcess(contextData, selectedEntities, currentWorkflow)'
                ],
                
                _executeTransitionProcess: function () {
                    // Start process when all the details are available
                    if(this.contextData && !_.isEmpty(this.contextData) && 
                       this.selectedEntities && this.selectedEntities.length > 0 &&
                       this.currentWorkflow) {

                           this._loading = true;
                           this._message = "Transition execution process started";

                           //Show actions and UI as per model definition
                           this._getWorkflowDefinition()

                           this._triggerFinishStep();
                    }     
                },

                _getWorkflowDefinition: function() {
                    var itemContext = this.getFirstItemContext();
                    itemContext.workflowNames = [this.currentWorkflow.name];
                    this.workflowMappingDefinitionRequest = DataRequestHelper.createWorkflowMappingGetRequest(this.contextData);
                    this.$$('#getWorkflowMappingDefinition').generateRequest();
                },

                _onWorkflowMappingsResponse: function(e, detail) {
                    if (detail.response) {
                        console.log(detail.response);
                        //Based on the response display UI/Actions
                    }
                },

                _onActionTap: function() {
                    
                },

                _onWorkflowMappingsError: function(e, detail) {
                    console.warn("Failed to get workflow mappings");
                },

                _triggerFinishStep: function() {
                                        
                    var _message = "Completed the bulk transitions. What do you want to do now?";

                    var data = {
                                "messages": [
                                    {
                                        "message": _message
                                    }
                                ],
                                "actions": [                                    
                                    {
                                        "name": "goBack",
                                        "text": "Take me back to where I started",
                                        "isNotApp": true
                                    }                                    
                                ]                                
                            };

                        this.businessFunctionData = data;
                        var eventName = "onComplete";
                        var eventDetail = {
                            name: eventName
                        }

                        this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                        });
                        
                        this._message = "About to complete, please wait...";
                        this._loading = true;
                }              
            });
        })();
    </script>
</dom-module>