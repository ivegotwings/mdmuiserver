<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<!--
@group rock Elements
@element rock-entity-actions
@demo demo/index.html
-->
<dom-module id="rock-entity-actions">
    <template>
        <style include="bedrock-style-common"></style>
        <pebble-toolbar id="toolbar" readonly$="[[readonly]]" config-data="[[_toolbarConfig]]"></pebble-toolbar>
        <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="toolbar"></bedrock-pubsub>
    </template>
    <script>
        class RockEntityActions
            extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior, RUFBehaviors.ComponentConfigBehavior], Polymer.Element) {
            static get is() { return 'rock-entity-actions' }
            ready() {
                super.ready();
            }
            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function() {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    _toolbarConfig: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    hasWritePermission: {
                        type: Boolean,
                        value: true
                    }
                }
            }
            /**
            *
            */
            connectedCallback() {
                super.connectedCallback();
            }
            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }
            _onContextDataChange() {
                if(!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if(appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }
                    
                    this.requestConfig('rock-entity-actions', context);
                }
            }
            onConfigLoaded(componentConfig) {
                if(componentConfig && componentConfig.config) {

                    var buttonsToHide = ["edit", "upload", "delete"];

                    var toolbarConfig = componentConfig.config.toolbarConfig;
                    var buttonItems = DataHelper.convertObjectToArray(toolbarConfig.buttonItems);
                    for(var i = 0; i < buttonItems.length; i++) {
                        buttonItems[i].buttons = DataHelper.convertObjectToArray(buttonItems[i].buttons);
                        var buttons = buttonItems[i].buttons;
                        if(!this.hasWritePermission) {
                            for (var j = 0; j < buttons.length; j++) {
                                if (buttonsToHide.indexOf(buttons[j].name) != -1) {
                                    buttons[j].visible = false;
                                }
                            }
                        }
                    }
                    this._toolbarConfig = {"buttonItems": buttonItems};
                }
            }
            setAttributeToToolbarButton(btnName, attribute, addAttr) {
                var toolbar = this.shadowRoot.querySelector("#toolbar");
                if(toolbar) {
                    toolbar.setAttributeToToolbarButton(btnName, attribute, addAttr);
                }
            }
            _onToolbarEvent(e, detail) {
                this.fireBedrockEvent("rock-toolbar-button-event", detail);
            }
        }
        customElements.define(RockEntityActions.is, RockEntityActions);
    </script>
</dom-module>