<!doctype html>

<html>
  <head>
    <title>pebble-tree tests</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../../bower_components/web-component-tester/browser.js"></script>    
       
    <link rel="import" href="../pebble-tree.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <pebble-tree></pebble-tree>
      </template>
    </test-fixture>

    <test-fixture id="pebble-treeWithAllFeatures">
      <template is="dom-template">
        <pebble-tree selected-item="{{selectedItem}}" 
                     selected-items="{{selectedItems}}" 
                     multi-select 
                     enable-search></pebble-tree>
      </template>
    </test-fixture>

    <test-fixture id="pebble-treeWithNoSearchAndCheckbox">
      <template is="dom-template">
        <pebble-tree selected-item="{{selectedItem}}" 
                     selected-items="{{selectedItems}}"></pebble-tree>
      </template>
    </test-fixture>

    <script>
      var treeList = [
          {
              text: "All Choices",
              "children": [
                  {
                    "text": "All SKUs",
                    "code": "mdm-001"                    
                  }
                ]
          },

          {
              text: "2283389-OPAL",
              "children": [
                  {
                    "text": "All SKUs of 2283389-OPAL",
                    "code": "mdm-002"                    
                  },
                  {
                    "text": "2283389-OPAL-1.18 oz",
                    "code": "mdm-003"                    
                  },
                  {
                    "text": "2283389-OPAL-3.2 oz",
                    "code": "mdm-004"                    
                  },
                  {
                    "text": "2283389-OPAL-0.68 oz",
                    "code": "mdm-005"                    
                  }
                ]
          },

          {
              text: "2283389-BIRC",
              "children": [
                  {
                    "text": "All SKUs of 2283389-BIRC",
                    "code": "mdm-006"                    
                  },
                  {
                    "text": "2283389-BIRC-1.18 oz",
                    "code": "mdm-007"                    
                  },
                  {
                    "text": "2283389-BIRC-3.2 oz",
                    "code": "mdm-008"                    
                  },
                  {
                    "text": "2283389-BIRC-0.68 oz",
                    "code": "mdm-009"                    
                  }
                ]
          }

      ];
      
      suite('pebble-tree tests', function() {

        test('instantiating the element works', function() {
          var element = fixture('basic');
          assert.equal(element.is, 'pebble-tree');
        });

        test('Should show a tree list', function(done) {
           var element = fixture('pebble-treeWithAllFeatures');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){               
               assert.equal(element.querySelector('iron-list').querySelectorAll("pebble-tree-list").length, 3);
               done();
           })
        });

        test('Should show child list on parent click', function(done) {
           var element = fixture('pebble-treeWithAllFeatures');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){  
               var pebbleTreeList = element.querySelector('iron-list').querySelectorAll("pebble-tree-list");               
               pebbleTreeList[1].querySelector('li').click();  
               Polymer.dom.flush();         
               assert.equal(pebbleTreeList[1].querySelector('iron-collapse').attributes["aria-hidden"].value, "false");
               assert.equal(pebbleTreeList[1].querySelector('iron-collapse').attributes["aria-expanded"].value, "true");
               
               done();
           })
        });

        test('Should show proper child list content', function(done) {
           var element = fixture('pebble-treeWithAllFeatures');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){  
               var pebbleTreeList = element.querySelector('iron-list').querySelectorAll("pebble-tree-list");               
               Polymer.dom.flush();

               //Already item opened in previous test case, so continuing with content check
               var itemList = pebbleTreeList[1].querySelector('iron-collapse').querySelectorAll('pebble-tree-list');
               
               assert.equal(itemList[0].querySelector('a').innerHTML, "All SKUs of 2283389-OPAL");
               assert.equal(itemList[1].querySelector('a').innerHTML, "2283389-OPAL-1.18 oz");
               assert.equal(itemList[2].querySelector('a').innerHTML, "2283389-OPAL-3.2 oz");
               assert.equal(itemList[3].querySelector('a').innerHTML, "2283389-OPAL-0.68 oz");
               done();
           })
        });

        test('Should provide selected item', function(done) {
           var element = fixture('pebble-treeWithAllFeatures');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){  
               var pebbleTreeList = element.querySelector('iron-list').querySelectorAll("pebble-tree-list");               
               Polymer.dom.flush();
               
               //Already item opened in previous test case, so continuing with content check
               var itemList = pebbleTreeList[1].querySelector('iron-collapse').querySelectorAll('pebble-tree-list');
               itemList[0].querySelector('a').click();
               Polymer.dom.flush();               
               assert.equal(JSON.parse(treeEl.selectedItem).text, "All SKUs of 2283389-OPAL");
               
               done();
                })
            });

        test('Should provide checked items list', function(done) {
           var element = fixture('pebble-treeWithAllFeatures');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){  
                    var pebbleTreeList = element.querySelector('iron-list').querySelectorAll("pebble-tree-list");               
                    Polymer.dom.flush();
                    
                    //Already item opened in previous test case, so continuing with content check
                    var itemList = pebbleTreeList[1].querySelector('iron-collapse').querySelectorAll('pebble-tree-list');
                    itemList[0].querySelector('paper-checkbox').checked = true;
                    itemList[1].querySelector('paper-checkbox').checked = true;
                    itemList[2].querySelector('paper-checkbox').checked = true;
                    Polymer.dom.flush();
                    itemList[0].querySelector('paper-checkbox').fire('change');
                    itemList[1].querySelector('paper-checkbox').fire('change');
                    itemList[2].querySelector('paper-checkbox').fire('change');
                    
                    Polymer.dom.flush();
                    
                    assert.equal(treeEl.selectedItems[0].text, "All SKUs of 2283389-OPAL");
                    assert.equal(treeEl.selectedItems[1].text, "2283389-OPAL-1.18 oz");
                    assert.equal(treeEl.selectedItems[2].text, "2283389-OPAL-3.2 oz");
                    
                    done();               
                })
            });

        test('Should show proper item as per search', function(done) {
           var element = fixture('pebble-treeWithAllFeatures');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
           Polymer.dom.flush();
           var searchEl = treeEl.querySelector("rock-search-bar");
           searchEl.query = "OPAL";

           setTimeout(function(){
               flush(function(){
                    var treeList = document.querySelector('iron-list').querySelectorAll('.pebble-tree');               
                    var foundItems = []
                    for(var idx = 0; idx < treeList.length; idx++)
                    { 
                        if(treeList[idx].hidden == false)
                        {
                            foundItems.push(treeList[idx]);
                        }
                    }

                    var itemList = foundItems[1].querySelectorAll('pebble-tree-list');
                   
                    assert.equal(itemList[0].querySelector('a').innerHTML, "All SKUs of 2283389-OPAL");
                    assert.equal(itemList[1].querySelector('a').innerHTML, "2283389-OPAL-1.18 oz");
                    assert.equal(itemList[2].querySelector('a').innerHTML, "2283389-OPAL-3.2 oz");
                    assert.equal(itemList[3].querySelector('a').innerHTML, "2283389-OPAL-0.68 oz");

                    done();
                });
           }, 2000);
        });

        test('Should not show searchbox', function(done) {
           var element = fixture('pebble-treeWithNoSearchAndCheckbox');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){               
               assert.equal(treeEl.querySelector('rock-search-bar'), null);
               done();
           })
        });

        test('Should not show checkbox', function(done) {
           var element = fixture('pebble-treeWithNoSearchAndCheckbox');
           var treeEl = document.querySelector('pebble-tree');           
           treeEl.initialNav = treeList;
                      
           flush(function(){               
               var cbList = treeEl.querySelectorAll('paper-checkbox');
               var checkBoxVisible = false;

               for(var idx = 0; idx < cbList.length; idx++)
               {
                   if(!cbList[idx].hidden)
                   {
                       checkBoxVisible = true;
                       break;
                   }
               }
               
               assert.equal(checkBoxVisible, false);
               done();
           })
        });

        
      });
    </script>
  </body>
</html>
