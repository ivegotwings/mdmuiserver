<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/iron-list/iron-list.html" />
<link rel="import" href="../rock-search-bar/rock-search-bar.html" />
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="pebble-tree-node.html" />

<!--
`pebble-tree` Represents an element that displays a list of nodes in a tree structure.

### Example:

        <pebble-tree initial-nav="[[initialNav]]" 
                     selected-item="{{selectedItem}}" 
                     selected-items="{{selectedItems}}" 
                     multi-select 
                     enable-search>
        </pebble-tree>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
--pebble-tree | Mixin applied to tree | {}
--pebble-tree-parent-list | Mixin applied to parent tree list | {}
--pebble-tree-nodeitem | Mixin applied to tree list item | {}
--pebble-tree-nodeitem-hover | Mixin applied to tree list item hover | {}
--pebble-tree-nodeitem-active | Mixin applied to tree list item active | {}
--pebble-tree-nodeitem-selected | Mixin applied to tree list item active | {}
--pebble-tree-node | Mixin applied to inner tree list | {}
--pebble-tree-node-arrow | Mixin applied to tree list arrow | {}
--pebble-tree-checkbox | Mixin applied to tree list item checkbox | {}
--pebble-tree-icon | Mixin applied to tree list item icon | {}
--pebble-tree-height | The max-height of pebble-tree | 500px
--pebble-tree-checkbox-size | The size of tree list item checkbox | 12px
--pebble-tree-checkbox-color | The color of tree list item checkbox | #0a9ec1
--pebble-tree-checkbox-border-color | The border color of tree list item checkbox | #aaaaaa
--pebble-tree-checkbox-checkmark-color | The checkmark color of tree list item checkbox | ``
--pebble-tree-icon-width | The tree list item icon width | 16px
--pebble-tree-icon-height | The tree list item icon height | 16px
--pebble-tree-icon-fill-color | The tree list item icon fill color | #0a9ec1
--pebble-tree-icon-stroke-color | The tree list item icon stroke color | ``
--pebble-tree-search-text-color | The text color of search box | ``
--pebble-tree-search-font-family | The text font style of search box | ``

@group Pebble Elements
@element pebble-tree
@demo demo/index.html
-->

<dom-module id="pebble-tree">
	<template>
		<style is="custom-style" include="pebble-styles-shared">
			:host {
				display: block;
				background-color: #ffffff;
				color: #000000;
				padding: 12px 2px;
				/*border: 1px solid #eaeaea;*/
				/*border-radius: 2px;*/
				margin: 12px;
				font-weight: normal;
				font-size: 14px;
				cursor: default;
				@apply(--pebble-tree)
			}

			iron-list {
				max-height: var(--pebble-tree-height, 500px);
			}

			ul {
				margin-left: 0;
				padding-left: 10px;
				@apply(--pebble-tree-parent-list)
			}

			pebble-tree-node {
				li {
					@apply(--pebble-tree-nodeitem);
				}
				li:hover,
				li a:hover {
					@apply(--pebble-tree-nodeitem-hover);
				}
				li:active {
					@apply(--pebble-tree-nodeitem-active);
				}
				.selected {
					@apply(--pebble-tree-nodeitem-selected);
				}
				ul {
					@apply(--pebble-tree-node);
				}
				.arrow-down,
				.arrow-right {
					@apply(--pebble-tree-node-arrow);
				}
				--tree-checkbox-size: var(--pebble-tree-checkbox-size);
				--tree-checkbox-color: var(--pebble-tree-checkbox-color);
				--tree-checkbox-border-color: var(--pebble-tree-checkbox-border-color);
				--tree-checkbox-checkmark-color: var(--pebble-tree-checkbox-checkmark-color);
				@apply(--pebble-tree-checkbox);
				--tree-icon-width: var(--pebble-tree-icon-width);
				--tree-icon-height: var(--pebble-tree-icon-height);
				--tree-icon-fill-color: var(--pebble-tree-icon-fill-color);
				--tree-icon-stroke-color: var(--pebble-tree-icon-stroke-color);
				@apply(--pebble-tree-icon);
			}

			rock-search-bar {
				margin-left: 5px;
				display: inline-flex;
				width: calc( 100% - 10px);
				height: 32px;
				border: 1px solid var(--cloudy-blue-color,#c1cad4);
			}
		</style>
		<template is="dom-if" if="{{enableSearch}}">
			<rock-search-bar placeholder="Enter search text" query="{{searchKeyword}}"></rock-search-bar>
		</template>
		<ul>
            <iron-list items="{{_nav}}" as="item" index-as="index">
                <template>
					<pebble-tree-node item-path$="[[index]]" expand-all="{{expandAll}}" nav-item="[[item]]" selected-item="{{selectedItem}}"
									  selected-items="{{selectedItems}}" indeterminate-items="{{indeterminateItems}}"  multi-select="{{multiSelect}}"
									  newly-added-items="{{_computeNewlyAddedItems(item)}}" selected-node="{{selectedNode}}" selected-nodes="{{selectedNodes}}"
									  tree="{{tree}}" check-child-nodes="{{checkChildNodes}}" show-horizental-divider="[[showHorizentalDivider]]"></pebble-tree-node>
				</template>
			</iron-list>
		</ul>
	</template>
</dom-module>
<script>
  Polymer({
    is: 'pebble-tree',

    properties: {

      /**
      * Indicates a currently selected item.
      */
      selectedItem: {
        type: Object,
        notify: true
      },

      /**
       * Indicates a currently selected item list.
       */
      selectedItems: {
        type: Array,
        notify: true,
        value: function() {return [];}
      },
		/**
       * Indicates  list of items for which atleast 1 of the child elements are selected .
       */
        indeterminateItems: {
        type: Array,
        notify: true,
        value: function() {return [];}
      },
	  /**
	   * A reference to the selected element's node.
	   *
	   * @property selectedElem
	   * @type Object
	   */
	  selectedNode: {
	  	type: Object,
		notify: true
	  },
	/**
	 * A reference to the list of  selected elements' node.
	 *
	 * @property selectedElem
	 * @type Object
	 */
	selectedNodes: {
        type: Array,
        notify: true,
        value: function() {return [];}
	},

      /**
      * Indicates a keyword for the search.
      */
      searchKeyword: {
        type: String,
        value: ''
      },

      /**
      * Indicates initial navigation in the array form.
      */
      initialNav: {
        type: Array,
        value: function() {return [];}
      },

      /**
      * Specifies a model of the current navigation with search filters or other mutations
      * applied by this component's methods. This is calculated with changes from the base
      * property `initialNav` which is defined by this component's parent.
      *
      */
      _nav: {
        type: Object,
        notify: true
      },

        newlyAddedItems : {
            type : Array,
            notify : true,
            value: function() {return [];}
        },

      /**
       * Indicates a multi-select on the navigation.
       */
      multiSelect: {
        type: Boolean,
        value: false
      },

      /**
       * Specifies whether or not to show the search box.
       */
      enableSearch: {
        type: Boolean,
        value: false
      },
		expandAll:{
          type: Boolean,
			value:false,
			notify:true
		},
		checkChildNodes:{
          type:Boolean,
		  value:false,
		  notify:true
		},
		/**
		* A reference to the tree
		*/
		tree:{
			type:Object,
			notify:true,
			value: function () {
				return this;
            }
		},
        showHorizentalDivider:{
            type:Boolean,
            value:false,
            notify:true
        }
    },

    /** Observe property changes */
    observers: [
      '_computedNav(initialNav, searchKeyword)'
    ],
    listeners:{
      'item-selected':'itemSelected'
	},

      _computeNewlyAddedItems : function(navItem) {
          if(navItem.children &&  navItem.children.length>0) {
              var newItem = {};
              newItem.text = navItem.text;
              newItem.children = [];
			  this.push('newlyAddedItems',newItem);
			  return newItem.children;
          }
	  },
    /**
    * Fired when the search keyword is changed to call the filter on the `nav`.
    * You need to have debounce in place so that you don't do this on every single key down.
    *
    */
    _computedNav: function(navArr, searchKeyword) {
      //Clear selection before updating the items
      this.clearSelectedItems();
      this.clearSelectedItem();

      if (searchKeyword === '') {
        this.set('_nav', this.initialNav);
        return;
      }

      this.debounce('navBuild', function() {
        this.set('_nav', this._buildNav(navArr, searchKeyword));
      }, 50);
    },

    /**
    * Fired when a search keyword is entered. It builds and returns a new `nav`
    * object that only contains the search query.
    *
    */
    _buildNav: function(navArr, searchKeyword) {
        var foundItems = [],
        lowercaseArray;
        for (var i = 0, len=navArr.length; i < len; i++) {
          //build our initial object and populate it.
          var currentObj = {};
          currentObj.text = navArr[i].text;
          currentObj.icon = navArr[i].icon;
          currentObj.src = navArr[i].src;
          currentObj.opened = true;

          //if the item has children (ie children), recurse and if another array with children is returned, insert that into the object.
          if (navArr[i].children) {
            var tempArr = this._buildNav(navArr[i].children, searchKeyword);
            if (tempArr.length) {
              currentObj['children'] = tempArr;
            }
          }

          //lowercase both the search keyword, and link text, and compare - if there's a match, push it into the array.
          if (navArr[i].text.toLowerCase().indexOf(searchKeyword.toLowerCase()) != -1 && !navArr[i].children || currentObj.children) {
            foundItems.push(currentObj);
          }
          lowercaseArray=[];
        }

        //returns a rebuilt, filtered nav
        return foundItems;
    },

    /**
     * Can be used to clear the selected item list and checkbox selection.
     */
    clearSelectedItems: function(){
        this.selectedItems = [];
        this.selectedNodes = [];
    },

    /**
     * Can be used to clear the selected item and style.
     */
    clearSelectedItem: function(){
        this.selectedItem = '';
        this.selectedNode=null;
        //Clear selected item
        var item = this.querySelector('.selected');
        if(item)
        {
          item.classList.remove('selected');
        }
    },

      _resizeIronList : function() {
          var ironList = Polymer.dom(this.root).node.querySelector("iron-list")
              || Polymer.dom(this).node.querySelector("iron-list");
          ironList.notifyResize();
      },
	  getElementByPath: function (path) {
		  var indices=path.split(".");
		  var elem=this._nav[indices[0]];
		  for(var i=1;i<indices.length;i++){
		      elem=elem.children[indices[i]];
		  }
      },
	  getElementNodeByPath: function (path) {
		  return this.querySelector("pebble-tree-node[item-path='" + path + "']") ;
      },
	  getParentItemForNode: function (node) {
		  return node.getParent();
      },
	  checkIfParentNode: function (parentNode, childNode) {
        var parentItem=childNode.getParent();
         return (parentItem && parentItem==parentNode.navItem);
      },
	  checkIfSiblingNodes: function (node1,node2) {
		  var parent1= node1.getParent();
		  var parent2=node2.getParent();
		  return (parent1 !=null && parent1==parent2);
      },
	  toggleExpandAll: function () {
		  this.expandAll=!this.expandAll;
      }



  });
</script>