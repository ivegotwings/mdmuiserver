
<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/iron-list/iron-list.html" />
<link rel="import" href="../rock-search-bar/rock-search-bar.html" />
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="pebble-tree-list.html" />

<!--
`pebble-tree` displays list of nodes in a tree structure.

Example:

        <pebble-tree initial-nav="[[initialNav]]" 
                     selected-item="{{selectedItem}}" 
                     selected-items="{{selectedItems}}" 
                     multi-select 
                     enable-search>
        </pebble-tree>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
--pebble-tree | Mixin applied to tree | {}
--pebble-tree-parent-list | Mixin applied to parent tree list | {}
--pebble-tree-listitem | Mixin applied to tree list item | {}
--pebble-tree-listitem-hover | Mixin applied to tree list item hover | {}
--pebble-tree-listitem-active | Mixin applied to tree list item active | {}
--pebble-tree-listitem-selected | Mixin applied to tree list item active | {}
--pebble-tree-list | Mixin applied to inner tree list | {}
--pebble-tree-list-arrow | Mixin applied to tree list arrow | {}
--pebble-tree-checkbox | Mixin applied to tree list item checkbox | {}
--pebble-tree-icon | Mixin applied to tree list item icon | {}
--pebble-tree-height | The max-height of pebble-tree | 500px
--pebble-tree-checkbox-size | The size of tree list item checkbox | 12px
--pebble-tree-checkbox-color | The color of tree list item checkbox | #0a9ec1
--pebble-tree-checkbox-border-color | The border color of tree list item checkbox | #aaaaaa
--pebble-tree-checkbox-checkmark-color | The checkmark color of tree list item checkbox | ``
--pebble-tree-icon-width | The tree list item icon width | 16px
--pebble-tree-icon-height | The tree list item icon height | 16px
--pebble-tree-icon-fill-color | The tree list item icon fill color | #0a9ec1
--pebble-tree-icon-stroke-color | The tree list item icon stroke color | ``
--pebble-tree-search-text-color | The text color of search box | ``
--pebble-tree-search-font-family | The text font style of search box | ``

@group Pebble Elements
@element pebble-tree
@demo demo/index.html
-->

<dom-module id="pebble-tree">
    <template>
        <style is="custom-style" include="pebble-styles-shared">

         :host {
              display: block;
              background-color: #ffffff;
              color: #000000;
              max-width: 300px;
              padding: 12px 2px;
              border: 1px solid #eaeaea;
              border-radius: 2px;
              margin: 12px;
              font-size: 14px;
              cursor: default;
              @apply(--pebble-tree)
            }

        iron-list {
              max-height: var(--pebble-tree-height, 500px);
            }

         ul{
              margin-left: 0;
              margin-bottom: 0.2rem;
              margin-top: 0.2rem;
              padding-left: 1rem;
              @apply(--pebble-tree-parent-list)              
           }

         pebble-tree-list {

              li {
                @apply(--pebble-tree-listitem);  
              }

              li:hover, li a:hover {            
                @apply(--pebble-tree-listitem-hover);
              }

              li:active {                  
                @apply(--pebble-tree-listitem-active);
              }
              
              .selected {
                @apply(--pebble-tree-listitem-selected);
              }

              ul{
                @apply(--pebble-tree-list);        
              }

              .arrow-down,
              .arrow-right {
                @apply(--pebble-tree-list-arrow);        
              }
              
              --tree-checkbox-size: var(--pebble-tree-checkbox-size);
              --tree-checkbox-color: var(--pebble-tree-checkbox-color);
              --tree-checkbox-border-color: var(--pebble-tree-checkbox-border-color);
              --tree-checkbox-checkmark-color: var(--pebble-tree-checkbox-checkmark-color);
              @apply(--pebble-tree-checkbox);

              --tree-icon-width: var(--pebble-tree-icon-width);
              --tree-icon-height: var(--pebble-tree-icon-height);
              --tree-icon-fill-color: var(--pebble-tree-icon-fill-color);
              --tree-icon-stroke-color: var(--pebble-tree-icon-stroke-color);
              @apply(--pebble-tree-icon);              
         }

         rock-search-bar {
            --search-text-color: var(--pebble-tree-search-text-color);
            --default-font-family: var(--pebble-tree-search-font-family);
         }

        </style>
        <template is="dom-if" if="{{enableSearch}}">        
          <rock-search-bar  placeholder="Enter search text" query="{{searchKeyword}}" ></rock-search-bar>
        </template>
        <ul>            
            <iron-list items="{{_nav}}" as="item">
              <template>  
                  <pebble-tree-list nav-item="[[item]]" selected-item="{{selectedItem}}" selected-items="{{selectedItems}}" multi-select="{{multiSelect}}"></pebble-tree-list>
              </template>
            </iron-list>
        </ul>
    </template>
</dom-module>
<script>
  Polymer({
    is: 'pebble-tree',

    properties: {

      /**
      * Indicates currently selected item
      */
      selectedItem: {
        type: Object,
        notify: true        
      },
      
      /**
       * Indicates currently selected items list
       */
      selectedItems: {
        type: Array,
        notify: true,
        value: function() {return [];} 
      },

      /**
      * Indicates text for search.    
      */
      searchKeyword: {
        type: String,
        value: ''        
      },

      /**
      * Indicates initial navigation in array form.
      */
      initialNav: {
        type: Array,
        value: function() {return [];}
      },

      /**
      * A model of the current navigation (with search filters or other mutations
      * applied by this component's methods). Calculated with changes from the base
      * property `initialNav` which is defined by this component's parent.
      *
      */
      _nav: {
        type: Object,
        notify: true
      },

      /**
       * Indicates multi-select on navigation 
       */
      multiSelect: {
        type: Boolean,
        value: false
      },

      /**
       * Indicates whether to show search box or not
       */
      enableSearch: {
        type: Boolean,
        value: false
      }
    },

    /** Observe property changes */
    observers: [
      '_computedNav(initialNav, searchKeyword)'
    ],
   
    /**
    * Called when the search Keyword is changed to call the filter on the nav.
    * To ensure we don't do this on every single key down, we have a debounce in place.
    *
    */
    _computedNav: function(navArr, searchKeyword) {
      //Clear selection before updating the items
      this.ClearSelectedItems();
      this.ClearSelectedItem();

      if (searchKeyword === '') {
        this.set('_nav', this.initialNav);
        return;
      }
      
      this.debounce('navBuild', function() {        
        this.set('_nav', this._buildNav(navArr, searchKeyword));
      }, 50);
    },

    /**
    * Called when a search keyword is entered, and builds (and returns) a new nav
    * object that only contains the search query.
    *
    */
    _buildNav: function(navArr, searchKeyword) {        
        var foundItems = [],
        lowercaseArray;
        for (var i = 0, len=navArr.length; i < len; i++) {
          //build our initial object and populate it.
          var currentObj = {};
          currentObj.text = navArr[i].text;
          currentObj.icon = navArr[i].icon;
          currentObj.src = navArr[i].src;
          currentObj.opened = true;

          //if the item has children (ie children), recurse and if another array with children is returned, insert that into the object.
          if (navArr[i].children) {
            var tempArr = this._buildNav(navArr[i].children, searchKeyword);
            if (tempArr.length) {
              currentObj['children'] = tempArr;
            }
          }

          //lowercase both the search keyword, and link text, and compare - if there's a match, push it into the array.
          if (navArr[i].text.toLowerCase().indexOf(searchKeyword.toLowerCase()) != -1 && !navArr[i].children || currentObj.children) {
            foundItems.push(currentObj);
          }
          lowercaseArray=[];
        }

        //returns a rebuilt, filtered nav
        return foundItems;
    },

    /**
     * Clears selected items list and checkbox selection
     */ 
    ClearSelectedItems: function(){
        this.selectedItems = [];
        
        //Clear selected items
        var selectionCheckboxList = document.querySelectorAll('paper-checkbox');
        for(var idx = 0; idx < selectionCheckboxList.length; idx++)
        {
          selectionCheckboxList[idx].checked = false;
        }
    },

    /**
     * Clears selected item and style
     */
    ClearSelectedItem: function(){       
        this.selectedItem = '';        

        //Clear selected item
        var item = document.querySelector('.selected');
        if(item)
        {
          item.classList.remove('selected');
        }
    }
    
  });
</script>
