<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html" />
<link rel="import" href="../../../bower_components/iron-list/iron-list.html" />
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">



<!--
`pebble-tree-list`
Individual tree list which combines to make rock-tree

@group Pebble Elements
@element pebble-tree-list
@demo demo/index.html
-->
<dom-module id="pebble-tree-list">
  <template>    
    <style is="custom-style" include="pebble-styles-shared">

    .flex {
      display: flex;
      align-items:center;
    }

    li {  
        list-style: none;
        margin: 0.5em;
        padding: 3px;      
        @apply(--pebble-tree-listitem);
    }

    li:hover, li a:hover {
        color: #0a9ec1;        
        cursor: pointer;
        @apply(--pebble-tree-listitem-hover);
    }

    li:active {
        color: #086e87;
        @apply(--pebble-tree-listitem-active);
    }

    .selected {
        color: #0a9ec1;      
        background-color: #eaeaea;
        border-left: 5px solid #0a9ec1;
        padding: 5px;
        @apply(--pebble-tree-listitem-selected);      
    }
    
    ul {
        margin-left: 0;
        margin-bottom: 0.2rem;
        margin-top: 0.2rem;
        padding-left: 1rem;
        @apply(--pebble-tree-list);        
    }

    .arrow-down,
    .arrow-right {
        width: 0;
        height: 0;
        border-top: 5px solid transparent;
        border-bottom: 5px solid transparent;
        border-left: 8px solid ;
        padding-right: 2px;
        margin-right:5px;
        color: #0a9ec1;
        @apply(--pebble-tree-list-arrow);        
    }

    .arrow-down {
        -webkit-transform: rotate(90deg);
        transform: rotate(90deg)
    }

    paper-checkbox {
      --paper-checkbox-size: var(--tree-checkbox-size, 12px);      
      --paper-checkbox-unchecked-color: var(--tree-checkbox-border-color, #aaaaaa);
      --paper-checkbox-checked-color: var(--tree-checkbox-color, #0a9ec1);
      --paper-checkbox-checkmark-color: var(--tree-checkbox-checkmark-color);
      @apply(--pebble-tree-checkbox);
    }

    iron-icon {
      --iron-icon-width: var(--tree-icon-width, 16px);
      --iron-icon-height: var(--tree-icon-height, 16px);
      --iron-icon-fill-color: var(--tree-icon-fill-color, #0a9ec1);
      --iron-icon-stroke-color: var(--tree-icon-stroke-color);
      @apply(--pebble-tree-icon);
    }

</style>
    <template is="dom-if" if="{{!_hasKids(navItem)}}">
      <li>
        <paper-checkbox value="{{navItem}}" hidden="{{!multiSelect}}" on-change="_itemSelect"></paper-checkbox>
        <iron-icon  src="[[navItem.src]]" icon="[[navItem.icon]]" hidden="{{_iconPassed(navItem)}}"></iron-icon>        
        <a class$="nav-lnk" data-item$="{{navItem}}" on-tap="_itemClick"  item-path="0">{{navItem.text}}</a>        
      </li>
    </template>
    <template is="dom-if" if="{{_hasKids(navItem)}}">
      <li on-click="_toggle" class="flex">
        <div id="arrow" class$="{{_arrowClass(navItem.opened)}} arrow" data-name$="{{_removeSpaces(navItem)}}"></div>
        <iron-icon   src="[[navItem.src]]" icon="[[navItem.icon]]" hidden="{{_iconPassed(navItem)}}" ></iron-icon>
        <div  data-name$="{{_removeSpaces(navItem)}}">{{navItem.text}}</div>
      </li>
      <iron-collapse id$="collapse_{{_removeSpaces(navItem)}}" opened$="{{navItem.opened}}">
        <ul>
          <iron-list items="{{navItem.children}}" as="item">          
            <template>            
              <pebble-tree-list nav-item="{{item}}" selected-item="{{selectedItem}}" selected-items="{{selectedItems}}" multi-select="{{multiSelect}}"></pebble-tree-list>
            </template>
          </iron-list>
        </ul>
      </iron-collapse>
    </template>
  </template>
  <script>

  Polymer({

    is: 'pebble-tree-list',

    properties: {

      /**
       * Indicates navigation item 
       */
      navItem: {
        type: Object,
        value: function() {return {};},
        notify: true
      },

      /**
       * Indicates currently selected item
       */ 
      selectedItem: {
        type: String,
        notify: true
      },      
     
      /**
       * Indicates currently selected items list
       */
      selectedItems: {
        type: Array,
        notify: true,
        value: function() {return [];}
      }
    },    

    /**
    *  If item.opened is true, return arrow-down, else arrow-right
    *
    **/
    _arrowClass: function(item) {
      return (item) ? 'arrow-down' : 'arrow-right';
    },

    
   /**  
    * Called on item click - sets the selected item and its style.  
    */
    _itemClick: function(evt) {
        var target = evt.target;
                 
        var prevSelectedItem = document.querySelector('.selected')
        if(prevSelectedItem)
        {
          prevSelectedItem.classList.remove('selected');
        }
        target.classList.add('selected');
        
        this.selectedItem = target.getAttribute('data-item');
               
        evt.preventDefault();
    },

    /**
     * Called on item selected or unselected - sets or removes the selected items in the list
     */
    _itemSelect: function(evt){      
      var target = evt.target;
      
      if(target.checked)
      {  
        this.selectedItems.push(target.value);
      }
      else
      {
        for(var idx = 0; idx < this.selectedItems.length; idx++)
        {
          if(this.selectedItems[idx].text == target.value.text)
          {
            this.selectedItems.splice(idx, 1);
          }
        }
      }

      this._notifySelectedItemChanges();
    },

    /**
     * Called when item add or removes from selected items list
     */
    _notifySelectedItemChanges: function(){        
        var temp = this.selectedItems;
        this.selectedItems = [];
        this.selectedItems = temp;
    },

    /*
    *
    * Does what the name implies - remove spaces, and lowercases the string passed to it.
    * Used to create the iron-collapse ids, and click targets.
     */
    _removeSpaces: function(name) {
      return name.text.toLowerCase().replace(/ /g, "_");
    },

   /** 
    * Called when a menu is clicked on - it toggles the menu, and ensures the arrows on the menu are correct.
    */
    _toggle: function(evt) {

          var arrow = this.$$('#arrow'),
          name = arrow.getAttribute('data-name'),
          //find out if the clicked item has arrow right or down
          arrowRight = arrow.classList.contains('arrow-right'),
          arrowDown = arrow.classList.contains('arrow-down'),
          flipArrowRight = !arrowRight,
          flipArrowDown = !arrowDown;

          this.$$('#collapse_' + name).toggle();
          this.set('navItem.opened', !this.navItem.opened);
          //To resize iron-list when navigation menu toggles
          this.querySelector('iron-list').notifyResize();

          // and if they do have one of those, set the existing one to false, and missing one to true.
          this.toggleClass('arrow-right', flipArrowRight, arrow);
          this.toggleClass('arrow-down', flipArrowDown, arrow);
    },
    
   /**
    * Checks whether the item has children
    */
    _hasKids: function(item) {
      return item.children &&  item.children.length>0;
    },

    /**
     * Checks whether icon has passed
     */ 
    _iconPassed:function(item){
      if(item.icon || item.src) {
        return false;
      }
      return true;
    }
  });

</script>
</dom-module>