<link rel="import" href="../../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html"/>
<link rel="import" href="../../../bower_components/iron-list/iron-list.html"/>
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html"/>
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<!--
`pebble-tree-list` Represents an individual tree list that is combined to make rock-tree.

@group Pebble Elements
@element pebble-tree-list
@demo demo/index.html
-->
<dom-module id="pebble-tree-list">
    <template>
        <style is="custom-style" include="pebble-styles-shared">
            .flex {
                display: flex;
                align-items: center;
            }

            li {
                list-style: none;
                margin: 0.5em;
                padding: 3px;
                @apply(--pebble-tree-listitem);
            }

            li:hover,
            li a:hover {
                color: #0a9ec1;
                cursor: pointer;
                @apply(--pebble-tree-listitem-hover);
            }

            li:active {
                color: #086e87;
                @apply(--pebble-tree-listitem-active);
            }

            .selected {
                color: #0a9ec1;
                background-color: #eaeaea;
                border-left: 5px solid #0a9ec1;
                padding: 5px;
                @apply(--pebble-tree-listitem-selected);
            }

            ul {
                margin-left: 0;
                margin-bottom: 0.2rem;
                margin-top: 0.2rem;
                padding-left: 1rem;
                @apply(--pebble-tree-list);
            }

            .arrow-down,
            .arrow-right {
                width: 0;
                height: 0;
                border-top: 5px solid transparent;
                border-bottom: 5px solid transparent;
                border-left: 8px solid;
                padding-right: 2px;
                margin-right: 5px;
                color: #0a9ec1;
                @apply(--pebble-tree-list-arrow);
            }

            .arrow-down {
                -webkit-transform: rotate(90deg);
                transform: rotate(90deg)
            }

            paper-checkbox {
                --paper-checkbox-size: var(--tree-checkbox-size, 12px);
                --paper-checkbox-unchecked-color: var(--tree-checkbox-border-color, #aaaaaa);
                --paper-checkbox-checked-color: var(--tree-checkbox-color, #0a9ec1);
                --paper-checkbox-checkmark-color: var(--tree-checkbox-checkmark-color);
                @apply(--pebble-tree-checkbox);
            }

            iron-icon {
                --iron-icon-width: var(--tree-icon-width, 16px);
                --iron-icon-height: var(--tree-icon-height, 16px);
                --iron-icon-fill-color: var(--tree-icon-fill-color, #0a9ec1);
                --iron-icon-stroke-color: var(--tree-icon-stroke-color);
                @apply(--pebble-tree-icon);
            }

            pebble-button.iconButton {
                --pebble-button: {
                    height: 28px;
                    min-width: 0.5em;
                    padding: 0.2em 0.2em 0.3em 0.2em;
                    color: #0a9ec1;
                    float: right;
                    /*border: 1px solid #036BC3;*/
                }
            }
        </style>
        <!--<template is="dom-if" if="{{!_hasChildren(navItem)}}">-->
            <li>
                <paper-checkbox class = "checkbox" value="{{navItem}}" hidden="{{!multiSelect}}" on-change="_itemSelect"></paper-checkbox>
                <iron-icon src="[[navItem.src]]" icon="[[navItem.icon]]" hidden="{{!_iconPassed(navItem)}}"></iron-icon>
                <a class$="nav-lnk" data-item$="{{navItem}}" on-tap="_itemClick" item-path="0">{{navItem.text}}</a>
            </li>
        <!--</template>-->
        <template is="dom-if" if="{{_hasChildren(navItem)}}">
            <li class="flex">
                <div on-click="_toggle" class="flex">
                    <div id="arrow" class$="{{_arrowClass(navItem.opened)}} arrow"
                         data-name$="{{_removeSpaces(navItem)}}"></div>
                    <iron-icon src="[[navItem.src]]" icon="[[navItem.icon]]"
                               hidden="{{!_iconPassed(navItem)}}"></iron-icon>
                    <div data-name$="{{_removeSpaces(navItem)}}">{{navItem.text}}</div>
                </div>
                <pebble-button class="iconButton" icon="icons:add-circle" on-tap="_addNewElement"></pebble-button>
            </li>
            <iron-collapse id$="collapse_{{_removeSpaces(navItem)}}" opened$="{{navItem.opened}}">
                <ul class="flex" hidden="{{!navItem.addNewItem}}">
                    <paper-checkbox value="{{navItem}}" hidden="{{!multiSelect}}"
                                    on-change="_itemSelect"></paper-checkbox>
                    <iron-icon src="[[navItem.src]]" icon="[[navItem.icon]]"
                               hidden="{{!_iconPassed(navItem)}}"></iron-icon>
                    <!--<a class$="nav-lnk" data-item$="{{navItem}}" on-tap="_itemClick" item-path="0">{{navItem.text}}</a>-->
                    <paper-input id$="collapse_{{_paperInputId(navItem)}}" label="text input" noLabelFloat
                                 on-change="_keyPressed"></paper-input>
                </ul>
                <ul>
                    <iron-list items="{{navItem.children}}" as="item">
                        <template>
                            <pebble-tree-list nav-item="{{item}}" selected-item="{{selectedItem}}"
                                              selected-items="{{selectedItems}}" multi-select="{{multiSelect}}"
                                              newly-added-items="{{_computeNewlyAddedItems(item)}}"></pebble-tree-list>
                        </template>
                    </iron-list>
                </ul>
            </iron-collapse>
        </template>
    </template>
    <script>

        Polymer({

            is: 'pebble-tree-list',

            properties: {

                /**
                 * Indicates a navigation item.
                 */
                navItem: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    notify: true
                },

                newlyAddedItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Indicates the currently selected item.
                 */
                selectedItem: {
                    type: String,
                    notify: true
                },

                /**
                 * Indicates the currently selected item list.
                 */
                selectedItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                }
            },

            /**
             *  Can be used to return `arrow-down`, if `item.opened` is <b>true</b>. Otherwise,
             *  `arrow-right` is returned.
             *
             **/
            _arrowClass: function (item) {
                return (item) ? 'arrow-down' : 'arrow-right';
            },

            _computeNewlyAddedItems: function (navItem) {
                if (navItem.children && navItem.children.length > 0) {
                    var newItem = {};
                    newItem.text = navItem.text;
                    newItem.children = [];
                    this.push('newlyAddedItems', newItem);
                    return newItem.children;
                }
            },


            /**
             * Fired when an item is clicked. It sets the selected item and its style.
             */
            _itemClick: function (evt) {
                var target = evt.target;

                var prevSelectedItem = document.querySelector('.selected')
                if (prevSelectedItem) {
                    prevSelectedItem.classList.remove('selected');
                }
                target.classList.add('selected');

                this.selectedItem = target.getAttribute('data-item');

                evt.preventDefault();
            },

            /**
             * Fired when an item is selected or unselected. It sets or removes the selected item in the list.
             */
            _itemSelect: function (evt) {
                var target = evt.target;

                if (target.checked) {
                    this.selectedItems.push(target.value);
                }
                else {
                    for (var idx = 0; idx < this.selectedItems.length; idx++) {
                        if (this.selectedItems[idx].text == target.value.text) {
                            this.selectedItems.splice(idx, 1);
                        }
                    }
                }

                this._notifySelectedItemChanges();
            },

            /**
             * Fired when an item is added or removed from the selected item list.
             */
            _notifySelectedItemChanges: function () {
                var temp = this.selectedItems;
                this.selectedItems = undefined;
                this.selectedItems = temp;
            },

            /*
             *
             * Can be used to remove spaces, and lowercases the string passed to it.
             * Also used to create the iron-collapse ids, and click targets.
             */
            _removeSpaces: function (name) {
                return name.text.toLowerCase().replace(/ /g, "_");
            },

            _paperInputId: function (name) {
                var s = name.text.toLowerCase() + '_input';
                return s.replace(/ /g, "_");
            },

            /**
             * Fired when a menu is clicked on. It toggles the menu, and ensures the arrows on the menu are correct.
             */
            _toggle: function (evt) {

                var arrow = this.$$('#arrow'),
                    name = arrow.getAttribute('data-name'),
                    //find out if the clicked item has arrow right or down
                    arrowRight = arrow.classList.contains('arrow-right'),
                    arrowDown = arrow.classList.contains('arrow-down'),
                    flipArrowRight = !arrowRight,
                    flipArrowDown = !arrowDown;

                this.$$('#collapse_' + name).toggle();
                this.set('navItem.opened', !this.navItem.opened);
                //To resize iron-list when navigation menu toggles
                this._resizeIronList();

                // and if they do have one of those, set the existing one to false, and missing one to true.
                this.toggleClass('arrow-right', flipArrowRight, arrow);
                this.toggleClass('arrow-down', flipArrowDown, arrow);
                this.set('navItem.addNewItem', false);
            },

            _addNewElement: function (evt) {
                var arrow = this.$$('#arrow'),
                    name = arrow.getAttribute('data-name') + '_input',
                    //find out if the clicked item has arrow right or down
                    arrowRight = arrow.classList.contains('arrow-right'),
                    arrowDown = arrow.classList.contains('arrow-down'),
                    flipArrowRight = !arrowRight,
                    flipArrowDown = !arrowDown;

//          this.$$('#collapse_' + name).toggle();
                this.set('navItem.opened', true);
                //To resize iron-list when navigation menu toggles
                this._resizeIronList();
                this.async(function () {
                    this.$$('#collapse_' + name).inputElement.focus();
                });

                this.set('navItem.addNewItem', true);
            },

            _getAllCheckBoxes : function() {
                var selectionCheckboxList = Polymer.dom(this).querySelectorAll('paper-checkbox');
                if(selectionCheckboxList.length == 0) {
                    selectionCheckboxList = Polymer.dom(this.root).querySelectorAll('paper-checkbox');
                }
                return selectionCheckboxList;
            },

            _keyPressed: function (e) {
                var arrow = this.$$('#arrow');
                var name = arrow.getAttribute('data-name') + '_input';
                var value = this.$$('#collapse_' + name).value;
                var newItem = {};
                newItem.text = value;
                newItem.isNew = true;
                this.unshift('navItem.children', newItem);
                this.set('navItem.addNewItem', false);
                this.$$('#collapse_' + name).value = '';
                this.push('newlyAddedItems', newItem);
                this.fire('new-items-added', {item: newItem});
                this._resizeIronList();
                this.clearSelectedItem();
                var arr = [];
                arr.push(newItem);
                this.selectedItems = arr;
            },

            /**
             * Can be used to clear the selected item list and checkbox selection.
             */
            clearSelectedItems: function () {
                this.selectedItems = [];

                //Clear selected items
                var selectionCheckboxList = this.querySelectorAll('paper-checkbox');
                for (var idx = 0; idx < selectionCheckboxList.length; idx++) {
                    selectionCheckboxList[idx].checked = false;
                }
            },

            /**
             * Can be used to clear the selected item and style.
             */
            clearSelectedItem: function () {
                this.selectedItem = '';

                //Clear selected item
                var item = this.querySelector('.selected');
                if (item) {
                    item.classList.remove('selected');
                }
            },

            /**
             * Can be used to check whether the item has children.
             */
            _hasChildren: function (item) {
                return item.children && item.children.length > 0;
            },

            /**
             * Can be used to check whether icon has passed.
             */
            _iconPassed: function (item) {
                if (item.icon || item.src) {
                    return true;
                }
                return false;
            },

            _resizeIronList : function() {
                var ironList = Polymer.dom(this.root).node.querySelector("iron-list")
                    || Polymer.dom(this).node.querySelector("iron-list");
                ironList.notifyResize();
            }

        });

    </script>
</dom-module>