<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href=". ./../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../pebble-tab-group/pebble-tab-group.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-badge/pebble-badge.html">
<!--
` <rock-tabs>` Represents a tabs with Material Design styling. ` <rock-tabs>` makes it easy to explore and 
switch between different views or functional aspects of an app, or to browse categorized datasets dynamically.

@demo demo/index.html
-->
<dom-module id="rock-tabs">
    <style>
        pebble-horizontal-divider {
            --pebble-horizontal-divider-color: black;
        }
        
        iron-icon {
            margin-right: 0.5em
        }
        
        paper-menu {
            --paper-menu-background-color: white;
        }
        
        .tab-title-content {
            display: flex;
            flex-direction: column;
        }
        
        .tab-title-content>.tab-subtitle-wrapper {
            display: flex;
            flex-direction: row;
            font-weight: 100;
        }
        
        .tab-title-content>.tab-title-wrapper {
            display: flex;
            flex-direction: row;
            padding-top: 5%;
        }
        
        .tab-subtitle-wrapper>pebble-badge {
            --pebble-badge-margin-left: 2%;
            --pebble-badge-margin-bottom: 1%;
        }
        
        .tab-title-wrapper iron-icon {
            width: 30px;
            height: 18px;
        }
        
        .hide-tab-image {
            display: none;
        }
        
        pebble-badge {
            --pebble-badge-margin-left: 40%;
            --pebble-badge-margin-top: 50%
        }
        
        .truncate {
            width: 78px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <template>
        <pebble-tab-group id="pebbletabgroup" selected="{{selectedTabIndex}}" scrollable="[[config.scrollable)]]" fit-container="[[config.fitContainer]]"
            on-iron-select="_onTabItemSelected" noink>
            <template is="dom-repeat" items="[[config.tabItems]]" as="tabItem">
                <pebble-tab id="[[tabItem.name]]" display-menu="[[tabItem.enableDropdownMenu]]" tab-config="[[tabItem]]">
                    <div class="tab-title-content">
                        <div class="tab-subtitle-wrapper">
                            <span class="tab-subtitle truncate">[[tabItem.subtitle]]</span>
                        </div>
                        <div class="tab-title-wrapper">
                            <template is="dom-if" if="[[tabItem.icon]]">
                                <iron-icon icon="[[tabItem.icon]]" class$="[[_showHideTabImage(tabItem.icon)]]"></iron-icon>
                            </template>
                            <span class="truncate">[[tabItem.title]]</span>
                        </div>
                    </div>
                    <paper-menu class="dropdown-content">
                        <template is="dom-repeat" items="[[tabItem.menuItems]]" as="menuItem">
                            <template is="dom-if" if="[[!_isDivider(menuItem)]]">
                                <paper-item tab-config="[[tabItem]]" menu-item-config="[[menuItem]]">
                                    <iron-icon icon="[[menuItem.icon]]"></iron-icon>
                                    [[menuItem.title]]
                                </paper-item>
                            </template>
                            <template is="dom-if" if="[[_isDivider(menuItem)]]">
                                <paper-item menu-item-config="[[menuItem]]">
                                    <pebble-horizontal-divider></pebble-horizontal-divider>
                                </paper-item>
                            </template>
                        </template>
                    </paper-menu>
                </pebble-tab>
            </template>
        </pebble-tab-group>
        <template is="dom-repeat" items="[[config.tabItems]]" as="tabItemContent">
            <div id="content-[[tabItemContent.name]]" hidden></div>
            <template is="dom-if" if="[[tabItemContent]]">
                <template is="dom-repeat" items="[[tabItemContent.menuItems]]" as="menuItemContent">
                    <template is="dom-if" if="[[!_isDivider(menuItemContent)]]">
                        <div id="content-[[tabItemContent.name]]-[[menuItemContent.name]]" hidden></div>
                    </template>
                </template>
            </template>
        </template>
    </template>
    <script>

        (function() {
            'use strict';

            Polymer({
                is: 'rock-tabs',
                properties: {
                   
                   /**
                    * Property denoting the config of an `element`
                    */
                    config: {
                        type: Object,
                        observer: '_getSelectedTab',
                        value: function() { return {}; }
                    },

                   /**
                    * Property denoting the selected index of a tab
                    */
                    selectedTabIndex: {
                        type: Number,
                        reflectToAttribute : true,
                        notify: true
                    },

                   /**
                    * Property denoting whether the tabs are scrollable and the tab width is based on the label width.
                    */
                    scrollable: {
                        type: Boolean,
                        value: false,
                    },

                   /**
                    * Property denoting whether the tabs expand to fit their container. This currently only applies when
                    * scrollable is true.
                    */
                    fitContainer: {
                        type: Boolean,
                        value: false
                    },
                    
                    _currentTabName: {
                        type: String
                    }
                },

                _showHideTabImage: function(icon)  {
                    if (icon) {
                        return "hide-tab-image";
                    }
                },

                _getSelectedTab: function(config) {
                    if(config != null && config != undefined)
                    {
                        if (config && config.tabItems) {
                            var tabItems = config.tabItems;
                            if (tabItems != null && tabItems != undefined && tabItems.length > 0)
                            {
                                for(var tabItemIndex in tabItems)
                                {   
                                    if(tabItems[tabItemIndex].selected)
                                    {
                                        this.selectedTabIndex = tabItemIndex;
                                        return tabItemIndex; 
                                    }
                                }
                            }
                        }
                    }
                },
                
                _onTabItemSelected: function(e) {
                    if (e && e.detail && e.detail.item)
                    {
                        var tabConfig = e.detail.item.tabConfig;
                        var menuItemConfig = e.detail.item.menuItemConfig;
                        var subTitle = tabConfig.subtitle;

                        if (tabConfig && menuItemConfig) {
                            subTitle = menuItemConfig.name;
                            this._loadContent(menuItemConfig, tabConfig.name);
                        } else {
                            this._loadContent(tabConfig);
                        }

                        var tabsubtitle = this.$$("#" + tabConfig.name + " .tab-subtitle");
                        if (tabsubtitle) {
                            tabsubtitle.textContent = subTitle;
                        }

                        if (subTitle) {
                            this.$$("#" + tabConfig.name).applySubTitleStyle = true;
                        } else {
                            this.$$("#" + tabConfig.name).applySubTitleStyle = false;
                        }
                    }
                },

                _isDivider: function(item) {
                    return item.name == "divider";
                },

                _loadContent: function(config, tabConfigName) {
                    if(config) {
                        var viewName = config.name;
                        viewName = tabConfigName ? tabConfigName + '-' + viewName : viewName;
                        var contentElement = this.$$("#content-" + viewName);

                        if(contentElement && contentElement.children.length > 0) {
                            this._showView(viewName);

                            if(this._currentTabName) {
                                this._hideView(this._currentTabName);
                            }
                            this._currentTabName = viewName;
                        } else {
                            if(config.component) {
                                this.importHref(config.component.path, function (e) {
                                    //component file import successful
                                    var dynamicEl = document.createElement(config.component.name);
                                    
                                    for (var property in config.component.properties) {
                                        if (config.component.properties.hasOwnProperty(property)) {
                                            
                                            var val = config.component.properties[property];
                                            
                                            if (typeof val == "object") {
                                                dynamicEl.setAttribute(property, JSON.stringify(val));
                                            } else {
                                                dynamicEl.setAttribute(property, val);
                                            }
                                        }
                                    }
                                    
                                    dynamicEl.setAttribute("id", "component");
                                    dynamicEl.setAttribute("class", dynamicEl.getAttribute("class") + " view-component");

                                    Polymer.dom(contentElement).appendChild(dynamicEl);

                                    this._showView(viewName);

                                    if(this._currentTabName) {
                                        this._hideView(this._currentTabName);
                                    }
                                    this._currentTabName = viewName;

                                },function (e) {
                                    console.log(e);
                                });
                            }
                        }

                    } else {
                        console.log("Tabconfig not available");
                    }
                },

                _showView: function(viewName) {
                    if(viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if(contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },

                _hideView: function(viewName) {
                    if(viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if(contentView) {
                            contentView.setAttribute("hidden", "");
                        }
                    }
                }
            });
        })();

    </script>
</dom-module>