<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html" />
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../pebble-tab/pebble-tab.html">
<link rel="import" href="../pebble-tab-group/pebble-tab-group.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-badge/pebble-badge.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">


<!--
`<rock-tabs>` Represents a wrapper on top of the `<pebble-tab-group>` element. 
It generates the tabs with material design styling based on the given configuration.
It makes it easy to explore and switch between different views or functional aspects of an App. It helps to browse the categorized data sets dynamically.

@demo demo/index.html
-->
<dom-module id="rock-tabs">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            :host {
                 display:block;
                 height:100%;
             }

            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: var(--border-black, #000);
            }

            pebble-tab {
                margin-right: 15px;
                overflow: inherit;
                @apply --tab-error-circle;
            }

            pebble-tab:last-of-type {
                margin-right: 0;
            }

            pebble-icon {
                margin-right: var(--tab-icon-spacing, 0.5em);
            }

            paper-listbox pebble-icon {
                margin-right: 10px;
            }

            pebble-tab .dropdown-content {
                box-sizing: border-box;
                position: fixed;
                max-height: 250px;
                overflow: auto;
                padding: 10px 0px;
                font-size: var(--default-font-size, 14px);
                color: var(--primary-text-color, #212121);
            }

            pebble-tab .dropdown-content paper-item {
                padding: 0px 20px;
                font-size: 14px;
            }

            pebble-tab .dropdown-content paper-item:hover {
                background-color: var(--bgColor-hover, #e8f4f9);
                color: var(--focused-line, #026bc3);
            }

            pebble-tab .dropdown-content paper-item:focus {
                color: var(--primary-button-color, #036bc3);
                background-color: var(--bgColor-hover, #e8f4f9);
            }

            paper-listbox {
                @apply --common-popup;
                margin-top: var(--default-tab-height, 38px);
            }

            .tab-subtitle {
                font-size: var(--font-size-sm, 12px);	
                font-weight: var(--font-bold, bold);
                position: absolute;
                top: var(--subtitle-abs-position, -4px);
                max-width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .iron-selected .tab-subtitle {
                color: var(--palette-cerulean, #036bc3);
            }

            .tab-subtitle-wrapper>pebble-badge {
                --pebble-badge-margin-left: 2%;
                --pebble-badge-margin-bottom: 1%;
            }

            .hide-element {
                display: none;
            }

            paper-item {
                /* this can be moved if paper item is moved inside the pebble tab*/
                --paper-item-min-height: 30px;
                --paper-item-selected-weight: bold;
                --paper-item: {
                    font-size: var(--default-font-size, 14px);
                    color: var(--color-steal-grey, #75808b);
                }
            }

            .tab-content {
                height:100%;
                overflow: auto;
                @apply --rock-tab-content;
            }

            /*IE 11 fix for paper-item alignment on hover of an element*/

            /*paper-item {
                height: 1px;
            }*/

            pebble-tab-group {
                margin-bottom: 20px;
                @apply --pebble-tab-group;
            }

            pebble-tab {
                height: 40px;
                @apply --pebble-tab;
            }

            pebble-tab-group#rockTabs pebble-tab {
                margin-left: 20px;
            }

            pebble-tab-group#rockTabs {
                margin-bottom: 0px;
            }

            #content-relationships {
                padding-top: 0;
                padding-right: 0;
                padding-bottom: 0;
                padding-left: 0;
            }

            #content-entity-family {
                padding-top: 20px;
                padding-right: 20px;
                padding-bottom: 20px;
                padding-left: 20px;
            }

            /* paper-spinner-lite {
                display: block;
                position: absolute;
                left: 50%;
                margin-top: 20px;
                transform: translate3d(50%, 0, 0); */
            
        </style>
		<div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
		        <div id="menuProviders" hidden></div>
		        <pebble-tab-group id$="{{id}}" selected="{{selectedTabIndex}}" on-iron-select="_onIronSelect" on-iron-deselect="_onIronDeselect"
		            noink>
		            <template is="dom-repeat" items="[[_calculatedTabItems]]" as="tabItem">
		                <pebble-tab id="[[tabItem.name]]" display-menu="[[arrayItem(_calculatedTabItems.*, index, 'enableDropdownMenu')]]" tab-config="{{tabItem}}">
		                    <div class="tab-title-content" slot="tab-title-content">
		                        <div class="tab-subtitle" slot="tab-subtitle">
		                            <span class="tab-subtitle-content">[[tabItem.subtitle]]</span>
		                        </div>
		                        <div class="tab-badge" slot="tab-badge">
		                            <pebble-badge hidden></pebble-badge>
		                        </div>
		                        <div class="tab-title" slot="tab-title">
		                            <template is="dom-if" if="[[tabItem.icon]]">
		                                <pebble-icon class="pebble-icon-size-18" icon="[[tabItem.icon]]"></pebble-icon>
		                            </template>
		                            <span>[[_temp(tabItem.title)]]</span>
		                        </div>
		                    </div>

		                    <paper-listbox slot="list" class="dropdown-content">
		                        <template is="dom-repeat" items="[[arrayItem(_calculatedTabItems.*, index, 'menuItems')]]" as="menuItem">
		                            <template is="dom-if" if="[[!_isDivider(menuItem)]]">
		                                <paper-item id="[[tabItem.name]]-[[menuItem.name]]" tab-config="[[tabItem]]" menu-item-config="[[menuItem]]">
		                                    <!--<pebble-icon icon="[[menuItem.icon]]"></pebble-icon>-->
		                                    [[menuItem.title]]
		                                </paper-item>
		                            </template>
		                            <template is="dom-if" if="[[_isDivider(menuItem)]]">
		                                <pebble-horizontal-divider></pebble-horizontal-divider>
		                            </template>
		                        </template>
		                    </paper-listbox>
		                </pebble-tab>
		            </template>
		        </pebble-tab-group>
		        <pebble-spinner active="[[showLoadingSpinner]]"></pebble-spinner>
			</div>
			<div class="base-grid-structure-child-2">
		        <div id="tab-content" hidden class="tab-content"></div>
		        <bedrock-pubsub event-name="selection-changed" handler="_onSelectionChange" target-id=""></bedrock-pubsub>
			</div>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-tabs",
                properties: {

                    /**
                     * Indicates the unique identification string of an `element`.
                     */
                    id: {
                        type: String,
                        notify: true
                    },

                    deferredRender: {
                        type: Boolean,
                        value: false
                    },

                    _isReadyToRender: { //flag that determines if the tabs can be rendered.
                        type: Boolean,
                        value: false
                    },

                    _renderOnTabSelection: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false,
                        observer: '_onReadonly'
                    },
                    /**
                     * Indicates the configuration of an `element`.
                     */
                    config: {
                        type: Object,
                        observer: '_configChanged',
                        value: function () {
                            return {};
                        }
                    },

                    _calculatedTabItems: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    /**
                     * Indicates the selected index of a tab.
                     */
                    selectedTabIndex: {
                        type: Number,
                        notify: true
                    },

                    _currentTabName: {
                        type: String
                    },

                    /**
                     * Indicates the selected tab's configuration.
                     */
                    selectedTab: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },

                    _currentTabErrorLength: {
                        type: Number,
                        value: 0,
                        notify: true,
                        observer: '_errorLengthChanged'
                    },

                    _selectedTabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },

                    viewMode: {
                        type: String,
                        value: ""
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                created() {
                    this.showLoadingSpinner = false;
                },
                /*
                 * Can be used to get the value of a badge for the `tab-name` that the user specified.
                 */
                attached: function () {
                    this._isReadyToRender = !this.deferredRender;
                    this._tabContent = this.shadowRoot.querySelector('#tab-content');
                },

                getTabByName: function (tabName) {
                    var pebbleTabGroup = this.shadowRoot.querySelector("#" + this.id);
                    if (pebbleTabGroup) {
                        return pebbleTabGroup.querySelector("#" + tabName);
                    }
                },

                _tabChange: function (activeTab) {
                    if (activeTab) {
                        ComponentHelper.fireBedrockEvent("tabs-change", activeTab, { ignoreId: true });
                    }
                },
                /*
                 * Can be used to set the value of a badge for the `tab-name` that the user specified.
                 */
                setBadgeValue: function (tabName, value) {
                    var tab = this.shadowRoot.querySelector("#" + this.id).querySelector("#" + tabName);
                    if (tab) {
                        var badge = tab.querySelector("pebble-badge");
                        if (badge && value) {
                            badge.label = value;
                            this.toggleBadge(tab, true);
                        } else {
                            this.toggleBadge(tab, false);
                        }
                    } else {
                        this.logWarning("TabNameError", "tabName", tabName);
                    }
                },

                _getTabGroup: function () {
                    return this.shadowRoot.querySelector("#" + this.id);
                },

                /*
                 * Can be used to return the value of a badge for the `tab-name` that the user specified.
                 */
                getBadgeValue: function (tabName) {
                    var pebbleTabGroup = this._getTabGroup();
                    if (pebbleTabGroup) {
                        var tab = pebbleTabGroup.querySelector("#" + tabName);
                        if (tab) {
                            var badge = tab.querySelector("pebble-badge");
                            if (badge) {
                                return badge.label;
                            }
                        } else {
                            this.logWarning("TabNameError", "tabName", tabName);
                        }
                    }
                },

                /*
                 * Can be used to toggle the display value of the badge element.
                 */
                toggleBadge: function (tab, showHide) {
                    if (tab) {
                        var badge = tab.querySelector("pebble-badge");
                        if (badge) {
                            if (showHide) {
                                badge.removeAttribute("hidden");
                            } else {
                                badge.setAttribute("hidden", "");
                            }
                        } else {
                            this.logWarning("PebbleBadgeError");
                        }
                    } else {
                        this.logWarning("TabNameError", "tabName", tabName);
                    }
                },

                _configChanged: function (config) {
                    if (_.isEmpty(config)) return;

                    if (config.tabItems) {
                        var tabItems = config.tabItems;
                        if (tabItems && tabItems.length) {
                            for (var tabItemIndex in tabItems) {
                                var tabItem = tabItems[tabItemIndex];
                                tabItem.index = tabItemIndex;
                                if (tabItem.selected) {
                                    this.selectedTabIndex = tabItemIndex;
                                }
                            }
                        }

                        this._calculatedTabItems = DataHelper.cloneObject(tabItems);
                        for (var tabItemIndex in this._calculatedTabItems) {
                            var tabItem = this._calculatedTabItems[tabItemIndex];
                            if(tabItem.enableDropdownMenu) {
                                this._fillMenuItems(tabItem);
                            } else {
                                setTimeout(() => {
                                    this.reloadCurrentTab();
                                }, 2000);
                            }
                        }

                        var pebbleTabGroup = this._getTabGroup();
                        if (pebbleTabGroup) {
                            if (config.scrollable) {
                                pebbleTabGroup.scrollable = true;
                            } else {
                                pebbleTabGroup.setAttribute("fitContainer", "");
                            }
                        }
                    }
                },

                _fillMenuItems: function (tabItem) {
                    var menuProviders = this.$.menuProviders;
                    if (tabItem.menuProviderComponent) {
                        Object.keys(tabItem.component.properties).map(function (tabComponentProperty) {
                            tabItem.menuProviderComponent.properties[tabComponentProperty] = tabItem.component.properties[tabComponentProperty];
                        });
                        ComponentHelper.loadContent(menuProviders, tabItem.menuProviderComponent, this, this._menuProviderCreated.bind(this, tabItem));
                    } else {
                        setTimeout(() => {
                            if (tabItem.selected || tabItem.name == this.selectedTab.name) {
                                if (tabItem.menuItems && tabItem.menuItems instanceof Array && tabItem.menuItems.length > 0) {
                                    Polymer.dom.flush();
                                    this._setSelectedMenuItem(tabItem);
                                }
                                this.reloadCurrentTab();
                            }
                        }, 2000);
                    }
                },

                _menuProviderCreated: function (tabItem, menuProviderElement) {
                    if (menuProviderElement) {
                        if (tabItem && menuProviderElement.getMenu) {
                            Polymer.Async.microTask.run(() =>
                                menuProviderElement.getMenu(tabItem, this._menuProviderCallback.bind(this, tabItem))
                            );
                        }
                    }
                },

                _menuProviderCallback: function (tabItem, menuItems) {
                    if (!tabItem) return;

                    this.set('_calculatedTabItems.' + tabItem.index, tabItem);

                    if (tabItem.menuItems) {
                        if (!menuItems) {
                            menuItems = [];
                        }
                        tabItem.menuItems.forEach(function (item) {
                            menuItems.push(item);
                        }, this);
                    }

                    if (!_.isEmpty(menuItems)) {
                        this.set('_calculatedTabItems.' + tabItem.index + ".enableDropdownMenu", true);
                        this.set('_calculatedTabItems.' + tabItem.index + ".menuItems", menuItems);
                        if (tabItem.selected || tabItem.name == this.selectedTab.name) {
                            Polymer.dom.flush();
                            this._setSelectedMenuItem(tabItem);
                            this.reloadCurrentTab();
                        }
                    } else {
                        this.set('_calculatedTabItems.' + tabItem.index + ".enableDropdownMenu", false);
                    }
                },

                _isDivider: function (item) {
                    return item.name == "divider";
                },

                //Clear tab errors on de-select
                _onIronDeselect: function (e) {
                    var tabName = e.detail.item.tabConfig.name;
                    var currentItem = this._getTabGroup().querySelector("#" + tabName);
                    if (currentItem) {
                        var errorCircle = currentItem.shadowRoot.querySelector(".error-circle");
                        errorCircle.hidden = true;
                        errorCircle.textContent = "";
                    }
                },

                _onIronSelect: function (e) {
                    this._currentTabErrorLength = 0; //reset errors

                    if (this.viewMode) {
                        var tab = this.getTabByName(this.viewMode);
                        e.detail.item = tab;
                        this.viewMode = "";
                    }

                    if (!e || !e.detail || !e.detail.item) return;

                    var tabGroup = this._getTabGroup();
                    // Capturing selected tab configuration
                    var tabConfig = this.selectedTab = e.detail.item.tabConfig;
                    var menuItemConfig = e.detail.item.menuItemConfig;
                    var subTitle = tabConfig.subtitle || '';

                    //Capturing for Quick Manage, reload tab with this configuration
                    this._selectedTabConfig = {
                        "tabConfig": tabConfig,
                        "menuItemConfig": menuItemConfig,
                        "subTitle": subTitle
                    };

                    if (tabConfig && menuItemConfig) {
                        subTitle = menuItemConfig.title;
                        if (this._renderOnTabSelection) { //protects multiple render because of ironselect being executed on first render
                            this.readyToRender(true);
                            this._loadContent(menuItemConfig, tabConfig.name);
                        }
                        this._resetSubTitles(tabConfig, subTitle);
                    } else {
                        if (this._renderOnTabSelection) {
                            this.readyToRender(true);
                            this._loadContent(tabConfig);
                        }
                        this._resetSubTitles(tabConfig, subTitle);
                        this.selectedTabIndex = tabConfig.index;
                    }
                    if (subTitle) {
                        this._applyMargin(tabConfig.name, true);
                    } else {
                        this._applyMargin(tabConfig.name, false);
                    }

                    tabGroup.highlightTabWithoutSelection(tabConfig.index);
                },

                _resetSubTitles: function (currentTabConfig, subtitle) {
                    var tabsConfig = this.config.tabItems;
                    var pebbleTabGroup = this._getTabGroup();

                    if (!tabsConfig || !pebbleTabGroup) return;

                    for (var index in tabsConfig) {
                        var tabConfig = tabsConfig[index];
                        var tab = pebbleTabGroup.querySelector("#" + tabConfig.name);

                        if (!tab) continue;

                        var tabSubTtile = tab.querySelector(".tab-subtitle-content");
                        if (tabConfig && tabSubTtile) {
                            if (currentTabConfig.name == tab.id) {
                                tabSubTtile.textContent = subtitle ? subtitle : "";
                            } else {
                                tabSubTtile.textContent = "";
                            }
                        }
                        var menu = tab.querySelector("paper-listbox");
                        if (currentTabConfig.name !== tab.id && menu && menu.selected >= 0) {
                            menu.selected = -1;
                        }
                    }
                },

                _loadContent: function (config, tabName, reload) {
                    if (!this._isReadyToRender) return;

                    if (!config || !config.component) {
                        return this.logWarning("TabConfig");
                    }

                    this.showLoadingSpinner = true;

                    const viewName = config.name;

                    tabName = tabName || viewName;

                    this._updateErrorVis(config.errorLength);

                    this._isReadyToRender = false; //disable the flag again every render call must have readytorender() executed beforehand
                    //enable iron select render only after the first render is complete.
                    this._renderOnTabSelection = true;

                    if (this.viewName === viewName && !reload) {
                        this.showLoadingSpinner = false;
                        return;
                    };

                    const contentElement = this._tabContent;

                    ComponentHelper.displayNode(contentElement, false);

                    this.viewName = viewName;
                    this._currentTabName = tabName;

                    this._tabChange(viewName);

                    if(this.loadContentTimeoutId) clearTimeout(this.loadContentTimeoutId);
                    
                    //Timeout needs to postpone the rendering until tab-animation has finished
                    this.loadContentTimeoutId = setTimeout(() => {
                        ComponentHelper.loadContent(contentElement, config.component, this, (content) => {
                            content.readonly = this.readonly;
                        });

                        ComponentHelper.displayNode(contentElement, true);
                        this.showLoadingSpinner = false;
                    }, 500);
                },

                _applyMargin: function (tabName, apply) {
                    var tab = this.getTabByName(tabName);

                    if (!tab) return;

                    var dropdownWrapper = tab.querySelector("#dropdown-wrapper");

                    if (dropdownWrapper) {
                        dropdownWrapper.style.marginTop = apply ? "2%" : "0%";
                    }
                },

                readyToRender: function (renderReady) {
                    this._isReadyToRender = renderReady;
                },

                refresh: function (options) {
                    if (this._currentTabName) {
                        var content = this._tabContent;
                        if (content && content.firstChild) {
                            content.firstChild.refresh(options);
                        }
                    }
                },
                editCurrentTab: function () {
                    if (!this.shadowRoot) {
                        return;
                    }
                    var currentElement = this._getTabGroup();

                    if (!currentElement) {
                        return;
                    }
                    var currentItem = currentElement.selectedItem;
                    if (currentItem) {
                        var currentTabConfig = currentItem.tabConfig;
                        var menu = currentItem.querySelector('paper-listbox');
                        var currentMenuItem;
                        var currentTabMenuConfig;
                        if (menu) {
                            currentMenuItem = menu.selectedItem;
                        }
                        if (currentMenuItem) {
                            currentTabMenuConfig = currentMenuItem.menuItemConfig;
                        }
                        if (currentTabConfig.name !== this._selectedTabConfig.tabConfig.name) {
                            currentTabConfig = this._selectedTabConfig.tabConfig;
                            currentTabMenuConfig = this._selectedTabConfig.menuItemConfig;
                        }
                    }

                    if (currentTabConfig && currentTabMenuConfig) {
                        this._editContent(currentTabMenuConfig, currentTabConfig.name);
                    } else {
                        this._editContent(currentTabConfig, null);
                    }

                },
                _editContent: function (config, tabName) {
                    if (config) {
                        var viewName = config.name;
                        viewName = tabName ? tabName + '-' + viewName : viewName;
                        var contentElement = this._tabContent;
                        if (contentElement && contentElement.firstChild && typeof (contentElement.firstChild.globalEdit) == "function") {
                            contentElement.firstChild.globalEdit();
                        }
                    }
                },
                /**
                * Can be used to reload the current tab content.
                */
                reloadCurrentTab: function (isReloadByConfig) {
                    //to reload the current selected tab after any changes to tabItemConfig
                    //no inputs to this method. Find out the current selected tab and call _loadContent()
                    if (!this.shadowRoot) {
                        return;
                    }
                    var currentElement = this._getTabGroup();

                    if (!currentElement) {
                        return;
                    }

                    var currentItem = currentElement.selectedItem;

                    if (isReloadByConfig && this._selectedTabConfig.tabConfig) {
                        var currentTabConfig = this._selectedTabConfig.tabConfig;
                        var currentTabMenuConfig = this._selectedTabConfig.menuItemConfig;
                    }
                    else if (currentItem) {
                        var currentTabConfig = currentItem.tabConfig;
                        var menu = currentItem.querySelector('paper-listbox');
                        var currentMenuItem;
                        var currentTabMenuConfig;
                        if (menu) {
                            currentMenuItem = menu.selectedItem;
                        }
                        if (currentMenuItem) {
                            currentTabMenuConfig = currentMenuItem.menuItemConfig;
                        }

                        // Work Around: When user is reloading tab but currentMenuItem is not mataching
                        //              with the one which is displayed to the user
                        if (currentTabConfig.name !== this._selectedTabConfig.tabConfig.name) {
                            currentTabConfig = this._selectedTabConfig.tabConfig;
                            currentTabMenuConfig = this._selectedTabConfig.menuItemConfig;
                        }
                    }

                    if (currentTabConfig && currentTabMenuConfig) {
                        this._loadContent(currentTabMenuConfig, currentTabConfig.name, true);
                    } else {
                        this._loadContent(currentTabConfig, null, true);
                    }
                },
                /**
                * Can be used to reload all tabs of a component.
                */
                reloadTabs: function () {
                    if (this.config && this.config.tabItems && this.config.tabItems.length > 0) {
                        var tabItems = DataHelper.cloneObject(this.config.tabItems);
                        for (var i = 0; i < tabItems.length; i++) {
                            var tabItem = tabItems[i];
                            var tabName = tabItem.name;
                            var contentTab = this.shadowRoot.querySelector('pebble-tab[id=' + tabName + ']');
                            if (contentTab) {
                                contentTab.tabConfig = tabItem;
                            }
                            this._fillMenuItems(tabItem);
                        }
                    }
                    this.reloadCurrentTab();
                },
                reset: function () {
                    this.set("_calculatedTabItems", []);
                    this.selectedTabIndex = null;
                },
                _onSelectionChange: function (e, detail, sender) {
                    var isDirty = this.getIsDirty();
                    if (isDirty) {
                        this._showWarning(e);
                    }
                },
                /**
                * Can be used to get whether the current tab content is dirty or not.
                */
                getIsDirty: function () {
                    if (this._currentTabName) {
                        var content = this._tabContent;
                        if (content && content.firstChild && content.firstChild.getIsDirty) {
                            var isTabDirty = content.firstChild.getIsDirty();
                            return isTabDirty;
                        }
                    }
                },
                /**
                * Can be used to get whether the current tab controls are dirty or not.
                */
                getControlIsDirty: function () {
                    if (this._currentTabName) {
                        var content = this._tabContent;
                        if (content && content.firstChild && content.firstChild.getControlIsDirty) {
                            return content.firstChild.getControlIsDirty();
                        }
                    }
                },

                _onReadonly() {
                    const tabView = this._tabContent && this._tabContent.firstChild;

                    if (tabView)
                        tabView.readonly = this.readonly;
                },
                _showWarning: function (event) {
                    if (!window.confirm(
                        "There are unsaved changes. Do you want to discard the changes?")) {
                        event.preventDefault();
                    }
                },
                _getCurrentSelectedItem: function () {
                    var tabGroup = this._getTabGroup();
                    if (!tabGroup) return;
                    return tabGroup.querySelector("#" + this._currentTabName);
                },
                _errorLengthChanged: function (errorLength) {
                    var currentItem = this._getCurrentSelectedItem();
                    if (!currentItem) return;

                    var currentTabConfig = currentItem.tabConfig;
                    var currentTabMenuConfig = currentItem.menuItemConfig;
                    if (currentTabConfig && currentTabMenuConfig) {
                        currentTabMenuConfig.errorLength = errorLength;
                    } else {
                        currentTabConfig.errorLength = errorLength;
                    }
                    this._updateErrorVis(errorLength);
                },
                _updateErrorVis: function (errorLength = 0) {
                    var currentItem = this._getCurrentSelectedItem();
                    if (!currentItem) return;
                    var errorCircle = currentItem.shadowRoot.querySelector(".error-circle");
                    if (errorLength > 0) {
                        errorCircle.hidden = false;
                        errorCircle.textContent = errorLength;
                    } else {
                        errorCircle.hidden = true;
                        errorCircle.textContent = "";
                    }
                },
                _temp: function (x) {
                    return x;
                },
                arrayItem: function (change, index, path) {
                    return this.get(path, change.base[index]);
                },
                _setSelectedMenuItem: function (tabItem) {
                    var currentTab = this.shadowRoot.querySelector("#" + tabItem.name);
                    if (!currentTab) return;

                    var currentTabMenu = currentTab.querySelector("paper-listbox");
                    if (currentTabMenu) {
                        var selectedMenuIndex = this._getTabSelectedMenuIndex(tabItem);
                        if (selectedMenuIndex >= 0) {
                            currentTabMenu.selected = selectedMenuIndex;
                        } else {
                            //Reset menu, subtitle and load root content
                            currentTabMenu.selected = -1;
                            this._selectedTabConfig.menuItemConfig = undefined;
                            this._resetSubTitles(currentTab.tabConfig, "");
                            this._isReadyToRender = true;
                        }
                    }
                },

                _getTabSelectedMenuIndex: function (tabItem) {
                    if (typeof tabItem.selectedMenuIndex != "undefined" && tabItem.selectedMenuIndex >= 0)
                        return tabItem.selectedMenuIndex;

                    if (!tabItem || !tabItem.menuItems || !tabItem.menuItems.length) return -1;

                    var menuItems = tabItem.menuItems;

                    for (var i = 0; i < menuItems.length; i++) {

                        if (this._selectedTabConfig && this._selectedTabConfig.menuItemConfig) {
                            if (this._selectedTabConfig.menuItemConfig.name == menuItems[i].name) {
                                return i;
                            }
                        } else {
                            if (menuItems[i].selected) {
                                return i;
                            }
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>