<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>

<link rel="import" href="../pebble-spinner/pebble-spinner.html" />
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">


<!--
`rock-wizard` Represents an element that displays the steps in a sequence
based on the given configuration.

@demo demo/index.html
-->
<dom-module id="rock-wizard">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            :host{
                display: block;
                height:100%;
            }
            #step-container {
                border-radius: 5px;                
                height:100%;
                overflow-y:auto;
                overflow-x: hidden;
                @apply --step-container;
            }
            #stepper {
                margin: 10px 0px;
                @apply --stepper;
            }
            .stepper-wrapper{
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .stepper-style {
                --pebble-connected-badge-width: 40px;
                --pebble-connected-badge-height: 40px;
                --pebble-connected-badge-fontSize: 20px;
                --pebble-horizontal-step-connector-line-width: 200px;
                --pebble-horizontal-step-connector-line-height: 3px;
            }
            rock-relationship-manage{
                --relationship-manage:{
                    padding:0;
                }
                --rock-relationship-grid-controls:{
                    padding:0;
                }
            }
        </style>
        <div id="wizard-container" class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <div class="stepper-wrapper">
                    <div id="stepper"  hidden$="[[_computeStepper()]]">
                        <!-- place stepper here -->
                        <pebble-stepper id="pebbleStepper" horizontal horizontal-line-width="[[_stepperConnectorLineWidth]]" stepper-config="[[_stepperConfig]]">
                            <template is="dom-repeat" id="steps-template" items="[[_stepperConfig.items]]" as="item">
                                <pebble-step data="[[item]]" class="stepper-style">
                                    <div class="step-badge-content" slot="step-badge-content">
                                        <span>[[item.index]]</span>
                                    </div>
                                </pebble-step>
                            </template>
                        </pebble-stepper>
                    </div>
                </div>
            </div>
            <div class="base-grid-structure-child-2">
                <div id="step-container">                   
                    <!-- step component should be loaded here -->
                </div>
                <div id="message-container" hidden$="[[!noSteps]]">
                    <div class="default-message">[[noDataMessage]]</div>
                </div>
            </div>
            <pebble-spinner active="[[_loading]]"></pebble-spinner>
        </div>
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating" target-id=""></bedrock-pubsub>
        <bedrock-pubsub id="next-event" handler="_onNext"></bedrock-pubsub>
        <bedrock-pubsub id="back-event" handler="_onBack"></bedrock-pubsub>
        <bedrock-pubsub id="skip-event" handler="_onSkip"></bedrock-pubsub>
        <bedrock-pubsub id="cancel-event" handler="_onCancel"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-wizard',
                properties: {
                    /*
                    * Indicates the configuration information that the user provided.
                    */
                    config: {
                        type: Object,
                        observer: '_configChanged',
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false,
                        observer: '_onReadonly'
                    },
                    _currentStepIndex: {
                        type: Number,
                        value: 0
                    },

                    _loading: {
                            type: Boolean,
                            value: true
                        },
                    /*
                    * Indicates the properties of the object for the wizard.
                    */
                    properties: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /*
                    * Indicates the data that is shared between all the steps of the wizard.
                    */
                    hideStepper:{
                        type:Boolean,
                        value:false
                    },
                    sharedData: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _stepperConfig: {
                        type: Array,
                        value: function() { return []; }
                    },
                    noSteps: {
                        type: Boolean,
                        value: false,
                        observer: '_onNoSteps'
                    },
                    noDataMessage: {
                        type: String,
                        value: ""
                    },
                    _stepperConnectorLineWidth: {
                        type: String,
                        value: "200px"
                    },
                    parentComponent: {
                        type: Element
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                _computeStepper:function(){
                    return this.hideStepper;
                },
                /**
                 * Can be used to move forward to the next step.
                 */
                goToNext: function () {
                    if(this._currentStepIndex < this.config.steps.length-1) {
                        this.goToStep(this._currentStepIndex + 1);
                    } else {
                        this.fire("cancel-event");
                    }
                },
                /**
                 * Can be used to move backward to the previous step.
                 */
                goToPrevious: function () {
                    if(this._currentStepIndex > 0) {
                        this.goToStep(this._currentStepIndex - 1);
                    }
                },
                /**
                 * Can be used to go to a particular step in the wizard.
                 */
                goToStep: function (stepIndex) {
                    //load content based on current step config
                    if(stepIndex >= 0 && stepIndex < this.config.steps.length) {
                        this._currentStepIndex = stepIndex;
                        var stepConfig = this.config.steps[stepIndex];
                        this._renderComponent(stepConfig);
                        this._addEventListeners(stepConfig);
                        this._updateStepperSelectedStep(stepIndex);                    
                    }
                },
                _updateStepperSelectedStep: function(stepIndex){
                    var stepper = this.shadowRoot.querySelector('#pebbleStepper');
                    if(stepper.selectedItem) {
                        var previousItem = stepper.selectedItem;
                        stepper.selectedItem.status = "completed";
                    }
                    stepper.selected = stepIndex;
                    var stepperChildren = Polymer.FlattenedNodesObserver.getFlattenedNodes(stepper).filter(n => n.nodeType === Node.ELEMENT_NODE);
                    var currentStepperChildren = stepperChildren[stepIndex];
                    if(currentStepperChildren && currentStepperChildren != previousItem) {
                        currentStepperChildren.status = "inprogress";
                    };
                    // if(stepper.selectedItem && stepper.selectedItem != previousItem) {
                    //     stepper.selectedItem.status = "inprogress";
                    // }
                },
                _configChanged: function(config) {
                    if(config && config.steps && config.steps.length > 0) {
                        var stepper = this.shadowRoot.querySelector('#pebbleStepper');
                        stepper.selected = null;
                        var stepperConfig = {};
                        stepperConfig.items = []
                        for(var i=0; i<config.steps.length; i++) {
                            var step = {
                                "index": i+1,
                                "label": "",
                                "status": "pending"
                            };
                            stepperConfig.items.push(step);
                        }
                        var lineWidth = 1000 / (config.steps.length*2);
                        if(lineWidth < 200) {
                            this._stepperConnectorLineWidth = lineWidth + "px";
                        }
                        this.set("_stepperConfig", stepperConfig);
                        this.shadowRoot.querySelector("#steps-template").render();
                        this.goToStep(0);
                    } 
                },

                get stepContainer() {
                    this._stepContainer = this._stepContainer || this.shadowRoot.querySelector('#step-container');
                    return this._stepContainer;
                },

                get nextElementPubSub() {
                    this._nextElementPubSub = this._nextElementPubSub || this.shadowRoot.querySelector('#next-event');
                    return this._nextElementPubSub;
                },
                
                get backElementPubSub() {
                    this._backElementPubSub = this._backElementPubSub || this.shadowRoot.querySelector('#back-event');
                    return this._backElementPubSub;
                },
                
                get skipElementPubSub() {
                    this._skipElementPubSub = this._skipElementPubSub ||this.shadowRoot.querySelector('#skip-event');
                    return this._skipElementPubSub;
                },
                get cancelElementPubSub() {
                    this._cancelElementPubSub = this._cancelElementPubSub || this.shadowRoot.querySelector('#cancel-event');
                    return this._cancelElementPubSub;
                },

                _renderComponent: function(config) {
                    var contentElement = this.stepContainer;
                    if(config && config.component && contentElement) {
                        if(this.sharedData){
                            if(!config.component.properties){
                                config.component.properties={};
                            }
                            for(var key in this.sharedData){
                                if(!this.sharedData.hasOwnProperty(key)) continue;
                                config.component.properties[key] = this.sharedData[key];
                            }
                            if(this.readonly){
                                config.component.properties.mode = 'view';
                                config.component.properties.readonly = this.readonly;
                            }
                        }
                        ComponentHelper.loadContent(contentElement, config.component, this);  
                        this._loading = false;                 
                    }
                },

                _onNext: function(e, detail, sender) {
                    var data=detail.data;
                    this._loadSharedData();
                    if(data && data.skipNext) {
                        this._updateStepperSelectedStep(this._currentStepIndex + 1);
                        this._currentStepIndex++;
                    }
                    if(this._currentStepIndex == this.config.steps.length-1) {
                        if(!detail){
                            detail={};
                        }
                        detail.closeBusinessFunction=true;
                        this.dispatchEvent(new CustomEvent('next-step',{detail:detail,bubbles:true,composed:true}));
                    } else{
                        if(detail) {
                            this.dispatchEvent(new CustomEvent('next-step', {detail:detail,bubbles:true,composed:true}));
                        }
                        this.goToNext();
                    }
                },
                _onBack: function(e, detail, sender) {
                    if(this._currentStepIndex && this._currentStepIndex != 0) {
                        this.goToPrevious();
                    } else if(this._currentStepIndex ==0){
                        this.dispatchEvent(new CustomEvent('first-step-cancelled',{bubbles:true,composed:true}));
                    }
                },
                _onSkip: function(e, detail, sender) {
                    this._loadSharedData();
                    this.goToNext();
                },
                _onCancel: function(e, detail, sender) {
                    this.fire("cancel-event");
                },
                _onComponentCreating: function(e, detail, sender) {
                    
                },
                _addEventListeners: function(config) {
                    if(!config) return;

                    this.appId = this.getAppId();
                    var nextEventName = config.nextEvent;
                    var backEventName = config.backEvent;
                    var skipEventName = config.skipEvent;
                    var cancelEventName = config.cancelEvent;
                    var nextElement = this.nextElementPubSub;
                    var backElement = this.backElementPubSub;
                    var skipElement = this.skipElementPubSub;
                    var cancelElement = this.cancelElementPubSub;
                    if(nextElement && nextEventName) {
                        nextElement.eventName = nextEventName;
                        nextElement.registerEvent();
                    }
                    if(backElement && backEventName) {
                        backElement.eventName = backEventName;
                        backElement.registerEvent();
                    }
                    if(skipElement && skipEventName) {
                        skipElement.eventName = skipEventName;
                        skipElement.registerEvent();
                    }
                    if(cancelElement && cancelEventName) {
                        cancelElement.eventName = cancelEventName;
                        cancelElement.registerEvent();
                    }
                },
                _loadSharedData: function() {
                    var contentElement = this.stepContainer;
                    var currentComponent=contentElement.firstElementChild;
                    var currentConfig=this.config.steps[this._currentStepIndex];
                    if(currentConfig.sharedProperties){
                        var sharedProperties=currentConfig.sharedProperties;
                        for(var i in sharedProperties){
                            this.sharedData[i]=currentComponent[sharedProperties[i]];
                        }
                    }
                },
                /**
                * Can be used to get if the current component loaded in the wizard is dirty or not.
                */
                getIsDirty: function() {
                    var content = this.stepContainer;
                    if(content && content.firstElementChild && content.firstElementChild.getIsDirty) {
                        return content.firstElementChild.getIsDirty();
                    }
                    return false;
                },
                
                _onReadonly: function () {
                    var content = this.stepContainer;
                    if(content && content.firstElementChild) {
                        content.firstElementChild.readonly = this.readonly;
                    }
                },

                _onNoSteps: function() {
                    if(this.noSteps) {
                        this._loading = false;
                    }
                }
            });
        })();
    </script>
</dom-module>