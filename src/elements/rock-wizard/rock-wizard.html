<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-stepper/pebble-step-badge-content.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`rock-wizard` Represents an element that displays steps in an order
based on the configuration that user has provided.

@demo demo/index.html
-->
<dom-module id="rock-wizard">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">
            #wizard-container {
                @apply(--layout-vertical);
            }
            #step-container {
                padding: 14px;
                border-radius: 5px;
                margin-top: 20px;
            }
            #stepper {
                align-self: center;
                -webkit-align-self: center; /* Safari 7.0+ */
                padding: 4px;
            }
            .stepper-style {
                --pebble-connected-badge-width: 40px;
                --pebble-connected-badge-height: 40px;
                --pebble-connected-badge-fontSize: 20px;
                --pebble-horizontal-step-connector-line-width: 200px;
                --pebble-horizontal-step-connector-line-height: 3px;
            }
        </style>
        <div id="wizard-container" class="m-20">
            <div id="stepper">
                <!-- place stepper here -->
                <pebble-stepper id="pebbleStepper" horizontal>
                    <template is="dom-repeat" items="{{config.stepperConfig}}" as="item">
                        <pebble-step class="stepper-style" data="{{item}}">
                            <pebble-step-badge-content>
                                <span>[[item.index]]</span>
                            </pebble-step-badge-content>
                        </pebble-step>
                    </template>
                </pebble-stepper>
            </div>
            <div id="step-container">
                <!-- step component should be loaded here -->
            </div>
        </div>
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating" target-id=""></bedrock-pubsub>
        <bedrock-pubsub id="next-event" handler="_onNext"></bedrock-pubsub>
        <bedrock-pubsub id="back-event" handler="_onBack"></bedrock-pubsub>
    </template>
</dom-module>
<script>
    (function () {
        'use strict';

        Polymer({
            is: 'rock-wizard',
            properties: {
                /*
                 * Indicates the configuration information that user has provided.
                 */
                config: {
                    type: Object,
                    observer: '_configChanged',
                    value: function () {
                        return {};
                    }
                },
                _currentStepIndex: {
                    type: Number,
                    value: 0
                },
                /*
                 * Indicates the properties object for the wizard.
                 */
                properties: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /*
                 * Indicates the data that can be shared between all the steps of the wizard.
                 */
                sharedData: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                },
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            /**
             * Can be used to move forward to next step
             */
            goToNext: function () {
                if(this._currentStepIndex < this.config.steps.length) {
                    this.goToStep(this._currentStepIndex + 1);
                }
            },
            /**
             * Can be used to move backward to previous step
             */
            goToPrevious: function () {
                if(this._currentStepIndex > 0) {
                    this.goToStep(this._currentStepIndex - 1);
                }
            },
            /**
             * Can be used to go to a particular step in wizard
             */
            goToStep: function (stepIndex) {
                //load content based on current step config
                if(stepIndex >= 0 && stepIndex < this.config.steps.length) {
                    this._currentStepIndex = stepIndex;
                    var stepConfig = this.config.steps[stepIndex];
                    this._renderComponent(stepConfig);
                    this._addEventListeners(stepConfig);
                    this._updateStepperSelectedStep(stepIndex);
                }
            },
            _updateStepperSelectedStep: function(stepIndex){
                var stepper = this.$$('#pebbleStepper');
                if(stepper.selectedItem) {
                    var previousItem = stepper.selectedItem;
                    stepper.selectedItem.status = "completed";
                }
                stepper.selected = stepIndex;
                if(stepper.selectedItem && stepper.selectedItem != previousItem) {
                    stepper.selectedItem.status = "inprogress";
                }
            },
            _configChanged: function(config) {
                if(config && config.steps && config.steps.length > 0) {
                    this.goToStep(0);
                } 
            },
            _renderComponent: function(config) {
                var contentElement = this.$$('#step-container');
                if(config && config.component && contentElement) {
                    ComponentHelper.loadContent(contentElement, config.component, this);
                }
            },
           
            _onNext: function(e, detail, sender) {
                this.goToNext();
            },
            _onBack: function(e, detail, sender) {
                if(this._currentStepIndex && this._currentStepIndex != 0) {
                    this.goToPrevious();
                }
            },
            _onComponentCreating: function(e, detail, sender) {
                if(detail && detail.data) {
                    // changes to be done to component properties, if required
                }
            },
            _addEventListeners: function(config) {
                if(config) {
                    var nextEventName = config.nextEvent;
                    var backEventName = config.skipEvent;
                    var nextElement = this.$$('#next-event');
                    var backElement = this.$$('#back-event');
                    if(nextElement && nextEventName) {
                        nextElement.eventName = nextEventName;
                        nextElement.registerEvent();
                    }
                    if(backElement && backEventName) {
                        backElement.eventName = backEventName;
                        backElement.registerEvent();
                    }
                }
            },
            /**
            * Can be used to get if the current component loaded in wizard is dirty or not.
            */
            getIsDirty: function() {
                var content = this.$$('#step-container');
                var isDirty;
                if(content && content.firstElementChild && content.firstElementChild.getIsDirty) {
                    isDirty = content.firstElementChild.getIsDirty();
                }
                if(!isDirty) {
                    if(this._currentStepIndex && this._currentStepIndex > 0) {
                        isDirty = true;
                    }
                }
                return isDirty;
            }
        });
    })();
</script>