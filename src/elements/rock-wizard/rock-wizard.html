<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`rock-wizard` Represents an element that displays the steps in an order
based on the configuration that user has provided.

@demo demo/index.html
-->
<dom-module id="rock-wizard">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">
            #wizard-container {
                @apply(--layout-vertical);
            }
            #step-container {
                padding: 14px;
                border-radius: 5px;
                margin-top: 20px;
            }
            #stepper {
                align-self: center;
                -webkit-align-self: center; /* Safari 7.0+ */
                padding: 4px;
            }
            .stepper-style {
                --pebble-connected-badge-width: 40px;
                --pebble-connected-badge-height: 40px;
                --pebble-connected-badge-fontSize: 20px;
                --pebble-horizontal-step-connector-line-width: 200px;
                --pebble-horizontal-step-connector-line-height: 3px;
            }
        </style>
        <div id="wizard-container" class="m-20">
            <div id="stepper">
                <!-- place stepper here -->
                <pebble-stepper id="pebbleStepper" horizontal stepper-config="[[_stepperConfig]]">
                    <template is="dom-repeat" id="steps-template" items="{{_stepperConfig}}" as="item">
                        <pebble-step class="stepper-style" data="{{item}}">
                            <div class="step-badge-content">
                                <span>[[item.index]]</span>
                            </div>
                        </pebble-step>
                    </template>
                </pebble-stepper>
            </div>
            <div id="step-container">
                <!-- step component should be loaded here -->
            </div>
        </div>
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating" target-id=""></bedrock-pubsub>
        <bedrock-pubsub id="next-event" handler="_onNext"></bedrock-pubsub>
        <bedrock-pubsub id="back-event" handler="_onBack"></bedrock-pubsub>
        <bedrock-pubsub id="skip-event" handler="_onSkip"></bedrock-pubsub>
        <bedrock-pubsub id="cancel-event" handler="_onCancel"></bedrock-pubsub>
    </template>
</dom-module>
<script>
    (function () {
        'use strict';

        Polymer({
            is: 'rock-wizard',
            properties: {
                /*
                 * Indicates the configuration information that user has provided.
                 */
                config: {
                    type: Object,
                    observer: '_configChanged',
                    value: function () {
                        return {};
                    }
                },
                _currentStepIndex: {
                    type: Number,
                    value: 0
                },
                /*
                 * Indicates the properties of the object for the wizard.
                 */
                properties: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /*
                 * Indicates the data that can be shared between all the steps of the wizard.
                 */
                sharedData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                _stepperConfig: {
                    type: Array,
                    value: function() { return []; }
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            /**
             * Can be used to move forward to the next step.
             */
            goToNext: function () {
                if(this._currentStepIndex < this.config.steps.length-1) {
                    this.goToStep(this._currentStepIndex + 1);
                } else{
                    this.fire('last-step-completed');
                }
            },
            /**
             * Can be used to move backward to the previous step.
             */
            goToPrevious: function () {
                if(this._currentStepIndex > 0) {
                    this.goToStep(this._currentStepIndex - 1);
                }
            },
            /**
             * Can be used to go to a particular step in the wizard.
             */
            goToStep: function (stepIndex) {
                //load content based on current step config
                if(stepIndex >= 0 && stepIndex < this.config.steps.length) {
                    this._currentStepIndex = stepIndex;
                    var stepConfig = this.config.steps[stepIndex];
                    this._renderComponent(stepConfig);
                    this._addEventListeners(stepConfig);
                    this._updateStepperSelectedStep(stepIndex);
                }
            },
            _updateStepperSelectedStep: function(stepIndex){
                var stepper = this.$$('#pebbleStepper');
                if(stepper.selectedItem) {
                    var previousItem = stepper.selectedItem;
                    stepper.selectedItem.status = "completed";
                }
                stepper.selected = stepIndex;
                if(stepper.selectedItem && stepper.selectedItem != previousItem) {
                    stepper.selectedItem.status = "inprogress";
                }
            },
            _configChanged: function(config) {
                if(config && config.steps && config.steps.length > 0) {
                    var stepperConfig = [];
                    for(var i=0; i<config.steps.length; i++) {
                        var step = {
                            "index": i+1,
                            "label": ""
                        };
                        stepperConfig.push(step);
                    }
                    this.set("_stepperConfig", stepperConfig);
                    this.$$("#steps-template").render();
                    this.goToStep(0);
                } 
            },
            _renderComponent: function(config) {
                var contentElement = this.$$('#step-container');
                if(config && config.component && contentElement) {
                    if(this.sharedData){
                        if(!config.component.properties){
                            config.component.properties={};
                        }
                        for(var i in this.sharedData){
                            config.component.properties[i] = this.sharedData[i];
                        }
                    }
                    ComponentHelper.loadContent(contentElement, config.component, this);
                }
            },
           
            _onNext: function(e, detail, sender) {
                var data=detail.data;
                this._loadSharedData();
                if(data && data.skipNext) {
                    this._currentStepIndex++;
                }
                this.goToNext();
            },
            _onBack: function(e, detail, sender) {
                if(this._currentStepIndex && this._currentStepIndex != 0) {
                    this.goToPrevious();
                } else if(this._currentStepIndex ==0){
                    this.fire('first-step-cancelled');
                }
            },
            _onSkip: function(e, detail, sender) {
                this._loadSharedData();
                this.goToNext();
            },
            _onCancel: function(e, detail, sender) {
                ComponentHelper.closeCurrentApp();
            },
            _onComponentCreating: function(e, detail, sender) {
                
            },
            _addEventListeners: function(config) {
                if(config) {
                    this.appId = this.getAppId();
                    var nextEventName = config.nextEvent;
                    var backEventName = config.backEvent;
                    var skipEventName = config.skipEvent;
                    var cancelEventName = config.cancelEvent;
                    var nextElement = this.$$('#next-event');
                    var backElement = this.$$('#back-event');
                    var skipElement = this.$$('#skip-event');
                    var cancelElement = this.$$('#cancel-event');
                    if(nextElement && nextEventName) {
                        nextElement.eventName = nextEventName;
                        nextElement.registerEvent();
                    }
                    if(backElement && backEventName) {
                        backElement.eventName = backEventName;
                        backElement.registerEvent();
                    }
                    if(skipElement && skipEventName) {
                        skipElement.eventName = skipEventName;
                        skipElement.registerEvent();
                    }
                    if(cancelElement && cancelEventName) {
                        cancelElement.eventName = cancelEventName;
                        cancelElement.registerEvent();
                    }
                }
            },
            _loadSharedData: function() {
                var contentElement = this.$$('#step-container');
                var currentComponent=contentElement.firstElementChild;
                var currentConfig=this.config.steps[this._currentStepIndex];
                if(currentConfig.sharedProperties){
                    var sharedProperties=currentConfig.sharedProperties;
                    for(var i in sharedProperties){
                        this.sharedData[i]=currentComponent[sharedProperties[i]];
                    }
                }
            },
            /**
            * Can be used to get if the current component loaded in the wizard is dirty or not.
            */
            getIsDirty: function() {
                if(this._currentStepIndex && this._currentStepIndex > 0) {
                    return true;
                }
                var content = this.$$('#step-container');
                if(content && content.firstElementChild && content.firstElementChild.getIsDirty) {
                    return content.firstElementChild.getIsDirty();
                }
                return false;
            }
        });
    })();
</script>