<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html" />
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>

<!--
`rock-wizard` Represents an element that displays the steps in a sequence
based on the given configuration.

@demo demo/index.html
-->
<dom-module id="rock-wizard">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar"></style>
        <custom-style>
            <style>
                #wizard-container {
                    height: calc(100% - 100px);
                    @apply --layout-vertical;
                    @apply --wizard-container;
            }
            #step-container {
                height:100%;
                padding: 14px;
                border-radius: 5px;
            }
            #stepper {                
                margin: 20px auto 0 auto;
                padding:4px;
            }
            .stepper-style {
                --pebble-connected-badge-width: 40px;
                --pebble-connected-badge-height: 40px;
                --pebble-connected-badge-fontSize: 20px;
                --pebble-horizontal-step-connector-line-width: 200px;
                --pebble-horizontal-step-connector-line-height: 3px;
            }
            </style>
        </custom-style>
    
        <div id="wizard-container">
            <div id="stepper">
                <!-- place stepper here -->
                <pebble-stepper id="pebbleStepper" horizontal stepper-config="[[_stepperConfig]]">
                    <template is="dom-repeat" id="steps-template" items="[[_stepperConfig.items]]" as="item">
                        <pebble-step class="stepper-style" data="[[item]]">
                            <div class="step-badge-content" slot="step-badge-content">
                                <span>[[item.index]]</span>
                            </div>
                        </pebble-step>
                    </template>
                </pebble-stepper>
            </div>
            <div id="step-container">                   
                <!-- step component should be loaded here -->
            </div>
            <pebble-spinner active="[[_loading]]"></pebble-spinner>
        </div>
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating" target-id=""></bedrock-pubsub>
        <bedrock-pubsub id="next-event" handler="_onNext"></bedrock-pubsub>
        <bedrock-pubsub id="back-event" handler="_onBack"></bedrock-pubsub>
        <bedrock-pubsub id="skip-event" handler="_onSkip"></bedrock-pubsub>
        <bedrock-pubsub id="cancel-event" handler="_onCancel"></bedrock-pubsub>
    </template>
</dom-module>
<script>
    (function () {
        'use strict';

        Polymer({
            is: 'rock-wizard',
            properties: {
                /*
                 * Indicates the configuration information that the user provided.
                 */
                config: {
                    type: Object,
                    observer: '_configChanged',
                    value: function () {
                        return {};
                    }
                },
                /**
                 * If set as true , it indicates the component is in read only mode
                 */
                readonly: {
                    type: Boolean,
                    value: false,
                    observer: '_onReadonly'
                },
                _currentStepIndex: {
                    type: Number,
                    value: 0
                },

                _loading: {
                        type: Boolean,
                        value: true
                    },
                /*
                 * Indicates the properties of the object for the wizard.
                 */
                properties: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /*
                 * Indicates the data that is shared between all the steps of the wizard.
                 */
                sharedData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                _stepperConfig: {
                    type: Array,
                    value: function() { return []; }
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            /**
             * Can be used to move forward to the next step.
             */
            goToNext: function () {
                if(this._currentStepIndex < this.config.steps.length-1) {
                    this.goToStep(this._currentStepIndex + 1);
                } else {
                    this.fire("cancel-event");
                }
            },
            /**
             * Can be used to move backward to the previous step.
             */
            goToPrevious: function () {
                if(this._currentStepIndex > 0) {
                    this.goToStep(this._currentStepIndex - 1);
                }
            },
            /**
             * Can be used to go to a particular step in the wizard.
             */
            goToStep: function (stepIndex) {
                //load content based on current step config
                if(stepIndex >= 0 && stepIndex < this.config.steps.length) {
                    this._currentStepIndex = stepIndex;
                    var stepConfig = this.config.steps[stepIndex];
                    this._renderComponent(stepConfig);
                    this._addEventListeners(stepConfig);
                    this._updateStepperSelectedStep(stepIndex);                    
                }
            },
            _updateStepperSelectedStep: function(stepIndex){
                var stepper = this.shadowRoot.querySelector('#pebbleStepper');
                if(stepper.selectedItem) {
                    var previousItem = stepper.selectedItem;
                    stepper.selectedItem.status = "completed";
                }
                stepper.selected = stepIndex;
                var stepperChildren = Polymer.FlattenedNodesObserver.getFlattenedNodes(stepper).filter(n => n.nodeType === Node.ELEMENT_NODE);
                var currentStepperChildren = stepperChildren[stepIndex];
                if(currentStepperChildren && currentStepperChildren != previousItem) {
                    currentStepperChildren.status = "inprogress";
                };
                // if(stepper.selectedItem && stepper.selectedItem != previousItem) {
                //     stepper.selectedItem.status = "inprogress";
                // }
            },
            _configChanged: function(config) {
                if(config && config.steps && config.steps.length > 0) {
                    var stepper = this.shadowRoot.querySelector('#pebbleStepper');
                    stepper.selected = null;
                    var stepperConfig = {};
                    stepperConfig.items = []
                    for(var i=0; i<config.steps.length; i++) {
                        var step = {
                            "index": i+1,
                            "label": "",
                            "status": "pending"
                        };
                        stepperConfig.items.push(step);
                    }
                    this.set("_stepperConfig", stepperConfig);
                    this.shadowRoot.querySelector("#steps-template").render();
                    this.goToStep(0);                   
                } 
            },
            _renderComponent: function(config) {
                var contentElement = this.shadowRoot.querySelector('#step-container');
                if(config && config.component && contentElement) {
                    if(this.sharedData){
                        if(!config.component.properties){
                            config.component.properties={};
                        }
                        for(var i in this.sharedData){
                            config.component.properties[i] = this.sharedData[i];
                        }
                        if(this.readonly){
                            config.component.properties.mode = 'view';
                            config.component.properties.readonly = this.readonly;
                        }
                    }
                    ComponentHelper.loadContent(contentElement, config.component, this);  
                    this._loading = false;                 
                }
            },
           
            _onNext: function(e, detail, sender) {
                var data=detail.data;
                this._loadSharedData();
                if(data && data.skipNext) {
                    this._updateStepperSelectedStep(this._currentStepIndex + 1);
                    this._currentStepIndex++;
                }
                if(this._currentStepIndex == this.config.steps.length-1) {
                    if(!detail){
                        detail={};
                    }
                    detail.closeBusinessFunction=true;
                    this.dispatchEvent(new CustomEvent('next-step',{detail:detail,bubbles:true,composed:true}));
                } else{
                    if(detail) {
                        this.dispatchEvent(new CustomEvent('next-step', {detail:detail,bubbles:true,composed:true}));
                    }
                    this.goToNext();
                }
            },
            _onBack: function(e, detail, sender) {
                if(this._currentStepIndex && this._currentStepIndex != 0) {
                    this.goToPrevious();
                } else if(this._currentStepIndex ==0){
                    this.dispatchEvent(new CustomEvent('first-step-cancelled',{bubbles:true,composed:true}));
                }
            },
            _onSkip: function(e, detail, sender) {
                this._loadSharedData();
                this.goToNext();
            },
            _onCancel: function(e, detail, sender) {
                this.fire("cancel-event");
            },
            _onComponentCreating: function(e, detail, sender) {
                
            },
            _addEventListeners: function(config) {
                if(config) {
                    this.appId = this.getAppId();
                    var nextEventName = config.nextEvent;
                    var backEventName = config.backEvent;
                    var skipEventName = config.skipEvent;
                    var cancelEventName = config.cancelEvent;
                    var nextElement = this.shadowRoot.querySelector('#next-event');
                    var backElement = this.shadowRoot.querySelector('#back-event');
                    var skipElement = this.shadowRoot.querySelector('#skip-event');
                    var cancelElement = this.shadowRoot.querySelector('#cancel-event');
                    if(nextElement && nextEventName) {
                        nextElement.eventName = nextEventName;
                        nextElement.registerEvent();
                    }
                    if(backElement && backEventName) {
                        backElement.eventName = backEventName;
                        backElement.registerEvent();
                    }
                    if(skipElement && skipEventName) {
                        skipElement.eventName = skipEventName;
                        skipElement.registerEvent();
                    }
                    if(cancelElement && cancelEventName) {
                        cancelElement.eventName = cancelEventName;
                        cancelElement.registerEvent();
                    }
                }
            },
            _loadSharedData: function() {
                var contentElement = this.shadowRoot.querySelector('#step-container');
                var currentComponent=contentElement.firstElementChild;
                var currentConfig=this.config.steps[this._currentStepIndex];
                if(currentConfig.sharedProperties){
                    var sharedProperties=currentConfig.sharedProperties;
                    for(var i in sharedProperties){
                        this.sharedData[i]=currentComponent[sharedProperties[i]];
                    }
                }
            },
            /**
            * Can be used to get if the current component loaded in the wizard is dirty or not.
            */
            getIsDirty: function() {
                var content = this.shadowRoot.querySelector('#step-container');
                if(content && content.firstElementChild && content.firstElementChild.getIsDirty) {
                    return content.firstElementChild.getIsDirty();
                }
                return false;
            },
            
            _onReadonly: function () {
                var content = this.shadowRoot.querySelector('#step-container');
                if(content && content.firstElementChild) {
                    content.firstElementChild.readonly = this.readonly;
                }
            }  
        });
    })();
</script>