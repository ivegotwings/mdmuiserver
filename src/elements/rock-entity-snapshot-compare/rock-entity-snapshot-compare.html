<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">


<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-tree/pebble-tree.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">
<link rel="import" href="../rock-compare-entities/rock-compare-entities.html">
<link rel="import" href="../rock-classification-tree/rock-classification-tree.html">
<!--<link rel="import" href="classification-get-data.html">-->
<!--
`rock-extension-manage` Represents a component that renders all the extensions of an entity.
It manages the current extensions and creates the new extensions.

@element rock-extension-manage
@group rock-elements
@demo demo/index.html
-->
<dom-module id="rock-entity-snapshot-compare">
    <template>
        <style include="bedrock-style-common">
            .extensions-container {
                height: calc(100% - 30px);
                /*margin: inherit;*/
            }

            .tree-heading {
                font-weight: var(--font-bold, bold);
                font-size: var(--default-font-size, 14px);
            }

            #buttonContainer {
                bottom: 0;
                background: rgba(255, 255, 255, 0.80);
                text-align: center;
                z-index: 9999;
            }
        </style>

        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-rest id="entityMatchService" url="/data/pass-through/matchservice/search" method="POST" request-data={{_entityMatchRequest}}
            on-liquid-response="_onMatchSuccess" on-liquid-error="_onMatchFailure">
        </liquid-rest>
        <liquid-rest id="entityGovernService" url="/data/pass-through/entitygovernservice/validate" method="POST" request-data={{_entityGovernRequest}}
            on-liquid-response="_onEntityGovernResponse" on-liquid-error="_onEntityGovernFailed">
        </liquid-rest>


        <!-- <div id="content-entity-create">
            <div class="button-siblings">
                <rock-attribute-list attribute-values="[[_attributeValues]]" attribute-models="[[_attributeModels]]" context-data="[[contextData]]"
                    no-of-columns="3" mode="[[mode]]" attribute-messages="[[_attributeMessages]]"></rock-attribute-list>
            </div>
        </div> -->
        
        
        <div id="content-entity-match" class="full-height">
            <template is="dom-if" if="{{_getContextData(_compareEntitiesContext)}}">
                    <rock-compare-entities id="compareSnapshots" is-snapshot="true" compare-entities-context="{{_compareEntitiesContext}}" attribute-names="{{_attributeNames}}"
                    enable-column-select></rock-compare-entities>

            </template>
        </div>

        <div id="buttonContainer" align="center">
            <pebble-button id="cancel" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
            <pebble-button id="save" class="focus btn btn-success" button-text="Rollback" on-tap="_onNextTap" elevation=1 raised></pebble-button>
        </div>

        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{attributeModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse">
            <liquid-entity-data-save name="entitySaveService" operation="create" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
                on-response="_onSaveResponse" on-error="_onSaveError"></liquid-entity-data-save>
            <!-- <bedrock-pubsub event-name="error-length-changed" handler="_errorLengthChanged"></bedrock-pubsub>
            <bedrock-pubsub event-name="compare-entities-back" handler="_onCompareEntitiesBack" target-id="matchEntities"></bedrock-pubsub>
            <bedrock-pubsub event-name="compare-entities-create" handler="_onCompareEntitiesCreate" target-id="matchEntities"></bedrock-pubsub>
            <bedrock-pubsub event-name="compare-entities-merge" handler="_onCompareEntitiesMerge" target-id="matchEntities"></bedrock-pubsub> -->


        <!-- <div id="content-entity" class="full-height">
            <rock-compare-entities id="compareEnt" compare-entities-context="[[compareEntitiesContext]]" attribute-names="[[attributeNames]]"
                enable-column-select></rock-compare-entities>
        </div> -->


        <!-- <div class="extensions-container base-grid-structure" align="center">
            <div class="tree-heading base-grid-structure-child-1">Classification selection</div>
            <div class="base-grid-structure-child-2">
            <rock-classification-tree id="contextTree" multi-select="[[multiSelect]]" selected-classifications="{{_selectedItems}}" taxonomy="[[taxonomy]]"
                context-data="[[contextData]]" leaf-node-only="[[leafNodeOnly]]">
            </rock-classification-tree>
        </div>
        </div> -->
        <!-- <div id="buttonContainer" align="center">
            <template is="dom-repeat" id="event-template" items="[[componentEvents]]">
                <pebble-button id="[[item.id]]" class$="[[item.class]]" button-text="[[item.text]]" on-tap="_onTriggerEvent" data-args$="[[item.event]]" elevation=1 raised></pebble-button>
            </template>
        </div> -->
        <!-- <liquid-rest id="entityMatchService" url="/data/pass-through/matchservice/search" method="POST" request-data={{_entityMatchRequest}}
            on-liquid-response="_onMatchSuccess" on-liquid-error="_onMatchFailure"> -->
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-entity-snapshot-compare",
                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _selectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },
                    compareEntitiesContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    mode: {
                        type: String,
                        value: "edit",
                        notify: true
                    },
                    /**
                     * Specifies the request object for the attribute model request.
                     */
                    attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the response object for the attribute models.
                     */
                    attributeModelResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    businessFunctionData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeMessages: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _saveRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Specifies the length of the error message.
                     */
                    errorLength: {
                        type: Number,
                        notify: true,
                        value: 0
                    },
                    _entityMatchRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _matchedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _syncValidationErrors: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _contextData: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _compareEntitiesContext: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    messageCodeMapping: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    skipNext: {
                        type: Boolean,
                        value: false
                    },
                    matchConfig: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    enableMatchStep: {
                        type: Boolean,
                        value: false
                    },
                    defaultEntity: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    attributeNames: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _attributeNames: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                //     observers: [
                //     '_contextChanged(attributeNames, contextData)'
                // ],
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    taxonomy: {
                        type: String,
                        value: ""
                    }
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                ready: function () {
                    var snapshotIdArray = this.businessFunctionData.selectedItems.map(function (elm, index) {
                        return elm.snapshotId;
                    });

                    snapshotIdArray.forEach((elm, index)=> {
                        if(elm == undefined) {
                            snapshotIdArray[index] = {"id":this.contextData.ItemContexts[0].id, 
                                                "notSnapshot": true};
                        }
                    });

                    // var firstSnapshotId = snapshotIdArray.splice(0,1);

                    var attributeNames = ["_ALL"]

                    var compareEntitiesContext = 
                    {
                            entityIds: snapshotIdArray,
                            entityTypes: [
                                "sku"
                            ],
                            contextData: this.contextData
                            // matchConfig: {
                            // 	allow-create: true,
                            // 	compare-title: "{noOfEntities} match(es) found, please select a matched entity to merge or create your entity anyway."
                            // }
                        }
                    this._attributeNames = attributeNames;
                    this._compareEntitiesContext = compareEntitiesContext;

                    // this._liquidSaveElement = this.shadowRoot.querySelector("#attributeSaveDataService");
                },

                attached: function () {
                    // if (!this.taxonomy || this.taxonomy == "undefined") {
                    //     this.taxonomy = this.appSetting("dataDefaults").taxonomy;
                    // }
                },
                _contextChanged: function (attributeNames, contextData) {
                    if (attributeNames && attributeNames.length > 0 && !_.isEmpty(contextData)) {
                        var firstItemContext = this.getFirstItemContext();

                        if (typeof (firstItemContext) != "undefined") {
                            firstItemContext.attributeNames = attributeNames;
                        }

                        var t = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                        this.set("attributeModelRequest", t);

                        var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                        if (liquidModelGet) {
                            liquidModelGet.generateRequest();
                        }
                    }
                },

                _onCompositeModelGetResponse: async function (e) {
                    var values = [];
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        this._attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);
                        values = await DataTransformHelper.transformAttributes({}, this._attributeModels, this.contextData, "array", true);
                    }
                    this._attributeValues = values;
                },

                _onSaveTap: function (e) {
                    //raise event with name given for onNextAction in configuration
                    var attributeList = this.shadowRoot.querySelector('rock-attribute-list');
                    var changedAttributeElements = attributeList.getChangedAttributeElements();

                    if (attributeList.hasModelErrors()) {
                        this.showErrorToast("Cannot save. Please resolve the errors.");
                        return;
                    }
                    if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                        this.showErrorToast("No changes to save.");
                        return;
                    }

                    var attributesJSON = [];
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        var attributeJSON = attributeElement.attributeObject;
                        attributesJSON.push(attributeJSON);
                    }

                    var itemCtx = this.getFirstItemContext();
                    var entityType = itemCtx.type;
                    var entityId = "e" + ElementHelper.getRandomString();
                    itemCtx.id = entityId;
                    var newEntity = DataTransformHelper.prepareEntityForCreate(entityId, entityType, attributesJSON, this.contextData, DataHelper.getUserName(), this.defaultEntity);
                    ComponentHelper.getParentElement(this).contextData = this.contextData;

                    this._saveRequest = {
                        "entities": [newEntity]
                    };

                    //Add hotline flag if hotline is enabled
                    if (DataHelper.isHotlineModeEnabled()) {
                        this._saveRequest["hotline"] = true;
                    }

                    //Set match request
                    this.set('_entityMatchRequest', {
                        "entity": newEntity
                    });

                    const entityMatchService = this.shadowRoot.querySelector("#entityMatchService");
                    if (entityMatchService) {
                        entityMatchService.generateRequest();
                    }
                },


                _onCancelTap: function (e) {
                    // var attributeList = this.$$("#attributeList");
                    // if (attributeList.getIsDirty()) {
                    //     this.$$("#cancelDialog").open();
                    // } else {
                        this._revertAll();
                    // }
                },

                _onNextTap: function (e) {
                    var eventName = "onNext";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },

                _revertAll: function () {
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _updateEntity: function () {
                    if (!this.enableMatchStep) {
                        var updateConfirmDialog = this.$.updateConfirmDialog;
                        if (updateConfirmDialog) {
                            updateConfirmDialog.close();
                        }
                    }
                    var clientState = {};
                    clientState.notificationInfo = {};
                    clientState.notificationInfo.showNotificationToUser = false;
                    this._saveRequest["clientState"] = clientState;
                    this._saveRequest.entities[0].id = this._matchedEntity.id;
                    var itemCtx = this.getFirstItemContext();
                    itemCtx.id = this._matchedEntity.id;
                    var governReq = DataHelper.cloneObject(this._entityMatchRequest);

                    this.set("_entityGovernRequest", governReq);
                    var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                    if (liquidSave) {
                        liquidSave.operation = "update";
                    }
                    var liquidGovernGet = this.$.entityGovernService;
                    if (liquidGovernGet) {
                        liquidGovernGet.generateRequest();
                    }
                },

                _triggerGovernRequest: function () {
                    var governReq = DataHelper.cloneObject(this._entityMatchRequest);

                    this.set("_entityGovernRequest", governReq);
                    var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                    if (liquidSave) {
                        liquidSave.operation = "create";
                    }
                    var liquidGovernGet = this.$.entityGovernService;
                    if (liquidGovernGet) {
                        liquidGovernGet.generateRequest();
                    }
                },

                _cancelProcess: function () {
                    var updateConfirmDialog = this.$.updateConfirmDialog;
                    if (updateConfirmDialog) {
                        updateConfirmDialog.close();
                    }
                },
                _onSaveResponse: function (e) {
                    var eventName = "onSave";
                    var operation = e.detail.request.operation;
                    var eventDetail = {
                        name: eventName,
                        data: { "skipNext": operation == "update" ? true : this.skipNext }
                    }
                    this._loading = true;
                    var itemCtx = this.getFirstItemContext();
                    var msg = "";
                    if (operation == "create") {
                        msg = "Entity created successfully.";
                    }
                    if (operation == "update") {
                        msg = "Entity updated successfully.";
                    }
                    var data = {
                        "messages": [
                            {
                                "message": msg
                            }
                        ],
                        "actions": [
                            {
                                "name": "closeFunction",
                                "text": "Take Me back to Where I started"
                            },
                            {
                                "name": "showEntity",
                                "text": "Show me the entity",
                                "dataRoute": "entity-manage",
                                "queryParams": { "id": itemCtx.id, "type": itemCtx.type }
                            },
                            {
                                "name": "createEntity",
                                "text": "Create one more",
                                "dataRoute": "entity-create",
                                "queryParams": { "type": itemCtx.type }
                            }
                        ]
                    };
                    ComponentHelper.fireBedrockEvent("entity-created", { "id": itemCtx.id, "type": itemCtx.type }, { ignoreId: true });
                    ComponentHelper.getParentElement(this).businessFunctionData = data;
                    setTimeout(() => {
                        this._loading = false;
                        if (operation != "update") {
                            this.showSuccessToast(msg);
                        }
                        this.fireBedrockEvent(eventName, eventDetail, {
                            ignoreId: true
                        });
                    }, 100);
                },
                _onSaveError: function (e) {
                    // To Remove
                    var messsage = e.detail.response.content.msg;
                    this.showErrorToast(messsage);
                },
                _onSkipTap: function (e) {
                    //raise event with name given for onbackAction in configuration
                    var data;
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName,
                        data: data
                    }
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _errorLengthChanged: function (e) {
                    this.errorLength = e.detail.data;
                },
                _onEntityGovernResponse: function (e) {
                    var response = e.detail.response;
                    if (response.response && response.response.status && response.response.status.toLowerCase() == "success") {
                        var res = response.response;
                        var itemContext = this.getFirstItemContext();
                        var entityId;
                        if (itemContext) {
                            entityId = itemContext.id;
                        }

                        var entity = DataHelper.findEntityById(res.entities, entityId);
                        var attrMessages = {};
                        if (entity && entity.data && entity.data.attributes) {
                            var attributes = entity.data.attributes;
                            attrMessages = MessageHelper.getAttributeMessages(attributes, this._attributeModels, this.messageCodeMapping, this.localize());
                        }
                        if (!_.isEmpty(attrMessages)) {
                            var errorMessages = MessageHelper.getErrorsFromAttrMessages(attrMessages, this._attributeModels);
                            this.set("_syncValidationErrors", errorMessages);
                            this.shadowRoot.querySelector('#errorsDialog').open();
                            return;
                        } else {
                            var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                            if (liquidSave) {
                                liquidSave.generateRequest();
                            }
                        }
                    } else {
                        this.logWarning("EntityCreateValidationFail", "response", JSON.stringify(e.detail.response));
                        this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                    }
                },
                _onEntityGovernFailed: function (e) {
                    this.logWarning("EntityCreateValidationFail", "response", JSON.stringify(e));
                    this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                },
                _skipServerErrors: function () {
                    var errorDialog = this.$.errorsDialog;
                    if (errorDialog) {
                        errorDialog.close();
                    }
                    var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                    if (liquidSave) {
                        liquidSave.generateRequest();
                    }
                },
                _fixServerErrors: function () {
                    var errorDialog = this.$.errorsDialog;
                    if (errorDialog) {
                        errorDialog.close();
                    }
                    if (this._syncValidationErrors) {
                        var newAttributeMessages = {};
                        for (var i = 0; i < this._syncValidationErrors.length; i++) {
                            var attributeMessages = this._syncValidationErrors[i];
                            var attributeName = attributeMessages.attributeName;
                            var message = attributeMessages.message;
                            if (attributeName && message) {
                                newAttributeMessages[attributeName] = [message];
                            }
                        }
                    }
                    this.set('_attributeMessages', newAttributeMessages);
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                getIsDirty: function () {
                    var attributeList = this.shadowRoot.querySelector('rock-attribute-list');
                    var changedAttributeElements = attributeList.getChangedAttributeElements();
                    return changedAttributeElements && changedAttributeElements.length > 0;
                },

                _showView: function (viewName) {
                    if (viewName) {
                        var contentView = this.shadowRoot.querySelector("#content-" + viewName);
                        if (contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },

                _hideView: function (viewName) {
                    if (viewName) {
                        var contentView = this.shadowRoot.querySelector("#content-" + viewName);
                        if (contentView) {
                            contentView.setAttribute("hidden", "");
                        }
                    }
                },

                _onCompareEntitiesBack: function (e, detail) {
                    this._hideView("entity-match");
                    this._showView("entity-create");
                },

                _onCompareEntitiesCreate: function (e, detail) {
                    this._triggerGovernRequest();
                },

                _onCompareEntitiesMerge: function (e, detail) {
                    this._matchedEntity = detail.matchedEntity;
                    this._updateEntity();
                },

                _getContextData: function (_compareEntitiesContext) {
                    if( !_.isEmpty(_compareEntitiesContext)) {
                        return true;
                    } else return false;

                },

                _onMatchSuccess: function (e, detail) {
                    if (detail.response) {
                        var response = detail.response.response;
                        if ((response.dataObjectOperationResponse && response.dataObjectOperationResponse.status &&
                            response.dataObjectOperationResponse.status.toLowerCase() == "error") ||
                            (response.status && response.status.toLowerCase() == "error")) {
                            this.logWarning("MatchServiceRequestFail", "response", JSON.stringify(detail));
                            this.showErrorToast("There is a problem in match service. Please contact administrator.");
                            return;
                        }

                        if (response.status && response.status.toLowerCase() == "success") {
                            if (response.entities) {
                                if (!this.enableMatchStep) {
                                    if (response.entities.length == 1) {
                                        this._matchedEntity = response.entities[0];
                                        this.shadowRoot.querySelector('#updateConfirmDialog').open();
                                    } else if (response.entities.length > 1) {
                                        this.showErrorToast("We found multiple entities matching in our system. Please check entity details or contact your administrator.");
                                    }
                                    return;
                                }

                                var matchedEntityIds = response.entities.map(entity => entity.id);
                                var entityType = ContextHelper.getFirstItemContext(this.contextData).type;

                                this.compareEntitiesContext = {
                                    "newEntity": DataHelper.cloneObject(this._entityMatchRequest.entity),
                                    "entityIds": matchedEntityIds,
                                    "entityTypes": [entityType],
                                    "contextData": DataHelper.cloneObject(this.contextData),
                                    "matchConfig": this.matchConfig
                                }
                                this._hideView("entity-create");
                                this._showView("entity-match");
                            } else {
                                this._triggerGovernRequest();
                            }
                        }
                    }
                },
                _onMatchFailure: function (e, detail) {
                    this.logWarning("MatchServiceRequestFail", "response", JSON.stringify(detail));
                    this.showErrorToast("There is a problem in match service. Please contact administrator.");
                },

                _onTriggerEvent: function(e, detail) {
                    var event = e.target.getAttribute("id");
                    if(event == "skipEvent" || event == "cancelEvent" || event == "backEvent") {
                        this._skipOrCancelSelection(e);
                    } else if (event == "nextEvent") {
                        this._save(e);
                    }
                }
            });
        })();
    </script>
</dom-module>