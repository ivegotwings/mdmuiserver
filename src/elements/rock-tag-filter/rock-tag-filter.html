<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html"/>
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icons/pebble-icons.html"/>
<link rel="import" href="../pebble-tags/pebble-tags.html">

<!--
`rock-tag-filter` Represents an element that contains the search filter tags. 
 A user can select the required filters from this menu.

@group Rock Elements
@element rock-tag-filter
@demo demo/index.html
-->

<dom-module id="rock-tag-filter">
    <template>
        <style include="bedrock-style-common"></style>
        <style>
          .container {
            @apply --layout-horizontal;
            @apply --layout-center;
            display: inline-flex;
            display: -webkit-inline-flex;
            width: 100%;
          }
          
          .button {
            --pebble-button: {
              height: 40px;
              border: 1px solid var(--default-tag-border,#D2D7DD);
              border-radius: 3px;
              color: var(--primary-text-color,#212121);
              font-weight: normal;
              font-size: var(--font-size-sm, 12px);
              margin-top: 0px;
              margin-right: 0px;
              margin-bottom: 0px;
              margin-left: 0px;     
              padding-top: 0px;
              padding-right: 0px;
              padding-bottom: 0px;
              padding-left: 3px;         
            };
            --pebble-button-dropdown-icon: {
              height: 20px;
              width: 20px;
              color: var(--palette-medium-steel-grey,#7d8690);
            };
          }
          
        </style>   

        <div class="container">          
            <paper-menu-button horizontal-align="right">
                <pebble-button id="filterButton" icon="pebble-icon:filter" class="button dropdown-trigger" 
                    button-text="Refine More" dropdown-icon noink raised elevation="2" on-tap="refreshFilter" slot="dropdown-trigger">
                </pebble-button>
                <paper-menu class="dropdown-content" on-iron-select="_dropdownValueChanged" slot="dropdown-content">
                  <template id="filterList" is="dom-repeat" items="{{filters}}" filter="_alreadyAdded" observe="tags">
                    <paper-item item="[[item]]">[[item.longName]]</paper-item>
                  </template>
                </paper-menu>
            </paper-menu-button>
        </div>  

    </template>

    <script>
          Polymer({
            is: 'rock-tag-filter',
            properties: {
                /**
                * Fired when the user changes or selects any filter.
                *
                * @event search-tag-filter (pub-sub event)
                * @param {Object} detail which gives {"name": attributeName, "value": ""}		
                */

                /**
                 * Indicates the list of properties that are passed as filter tags.
                 */
                filters:{
                    type:Array,
                    notify: true,
                    value:function(){return []}
                },
                /**
                  * Indicates the list of string type that holds the tags. 
                  * Note that values in this array must be identical and duplicates must be avoided due to the definition of tags.
                  */
                  tags:{
                    type:Array,
                    notify: true,
                    value:function(){return []}
                  }
            },
            /**
            * Can be used to add a filter tag on selecting it from the dropdown.
            */
            _dropdownValueChanged: function(e) {
                var tag=e.target.selectedItem.item;
                var eventDetail = {name: 'search-tag-filter', data: tag }
                this.dispatchEvent(new CustomEvent('bedrock-event', {detail:eventDetail,bubbles:true,composed:true}));
            },
            /**
             *  Can be used to check if a property is already added in the filter tags. 
             *  If it is added, then that property is not shown in the dropdown list.
            */
            _alreadyAdded: function(item){
                  if (!item){
                    return false;
                  }
                  var tag  = this.tags.filter(function(i){
                    return i.name == item.name;
                  });
                  return !tag || !tag.length;
            },  
            /**
             *  Can be used to refresh the drop-down elements.
            */
            refreshFilter: function(){
                  var list=this.shadowRoot.querySelector("#filterList");
                  if(list){
                    list.render();
                    this.shadowRoot.querySelector('paper-menu').selected=null;
                  }
            }

          });

    </script>
</dom-module>