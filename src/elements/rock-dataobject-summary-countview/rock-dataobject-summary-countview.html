<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="rock-dataobject-summary-countview-item.html">

<dom-module id="rock-dataobject-summary-countview">
    <template>
       
        <template is="dom-if" if="[[_isExternalNameAvailable]]">
            <template is="dom-repeat" items="[[lists]]">
                <rock-dataobject-summary-countview-item dataobject="[[item]]"></rock-dataobject-summary-countview-item>
            </template>

        </template>
        <liquid-entity-model-get id="workflowDefinitionsGet" operation="getbyids" request-id="[[initWorkflowDefinitionsGet.content.requestId]]"
            on-response="_onWorkflowDefinitionsGetResponse" on-error="_onWorkflowDefinitionsGetError"></liquid-entity-model-get>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-dataobject-summary-countview",

                properties: {
                    dataobjectList: {
                        type: Object,
                        observer: '_dataobjectListChanged'
                    },
                    _workflowDifinitionRequest: {
                        type: Object,
                        value: function(){
                            return {
                                "params": {
                                "query": {
                                "filters": {
                                    "typesCriterion": [
                                    "entityType"
                                    ]
                                },
                                "ids": []
                                },
                                "fields": {
                                    "properties": [
                                        "_ALL"
                                    ],
                                    "attributes": [
                                        "_ALL"
                                    ]
                                }
                            }
                        }
                    }
                    },
                    
                    _isExternalNameAvailable: {
                        type: Boolean,
                        value: false
                    },
                    lists: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true,
                    }
                },
                _dataobjectListChanged: function (dataobjectList) {
                    if(dataobjectList && dataobjectList.length != 0){
                        var workflowDefinitionsGet = this.shadowRoot.querySelector('#workflowDefinitionsGet');
                        if (typeof (workflowDefinitionsGet) === "undefined" ||
                            workflowDefinitionsGet == null) {
                                this.logError("IdNotFound");
                            return;
                        }
                        for(var key in dataobjectList){
                            this._workflowDifinitionRequest.params.query.ids.push(dataobjectList[key]+"_entityType");
                        }
                        workflowDefinitionsGet.requestData = this._workflowDifinitionRequest;
                        workflowDefinitionsGet.generateRequest();
                    }
                },
                _onWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionResponse = e.detail.response;
                    var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                    if (responseContent) {
                        var workflowDefinitions = responseContent.entityModels;

                        for (var i = 0; i < workflowDefinitions.length; i++) {
                            var workflowDefinition = workflowDefinitions[i];

                            this.lists.push({
                                "externalName":workflowDefinition.properties.externalName,
                                "governanceName": workflowDefinition.id.replace(/_entityType/, '')
                            });
                        }

                        if (this.lists.length > 0) {
                            this._isExternalNameAvailable = true;
                        }
                    }
                },
                _onWorkflowDefinitionsGetError: function (e) {
                    this.logError("WorkFlowError",e);
                }
            });
        })();
    </script>
</dom-module>
