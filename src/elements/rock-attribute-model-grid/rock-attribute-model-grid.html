<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../rock-grid/rock-grid.html">

<dom-module id="rock-attribute-model-grid">
    <template>
        <style></style>
        <attribute-model-datasource id="attributeModelDataSource" context-data="[[contextData]]" request="[[requestData]]" data-source="{{dataSource}}"
            data-formatter="{{_dataFormatter}}" keywords-criterion-builder="{{_keywordsCriterionBuilder}}"
            buffer-record-size="{{size}}" current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}"
            total-count="{{totalCount}}" attribute-models="{{attributeModels}}" mode="grid"></attribute-model-datasource>
        <rock-grid id="attributeModelGrid" no-header data-source="{{dataSource}}" data-source-id="attributeModelDataSource" result-record-size="[[resultRecordSize]]"
                    current-record-size="{{currentRecordSize}}" config="[[config]]" grid-data-size="{{size}}" attribute-models="{}"
                    page-size="50" total-count="{{totalCount}}" selected-items="[[selectedItems]]"></rock-grid>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-attribute-model-grid",

                properties: {
                    config: {
                        type: Object,
                        value: function () { 
                            return {}; 
                        }
                    },
                    requestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dataFormatter: {
                        type: Object,
                        value: function () {
                            return this._getAttributeFormattedData.bind(this);
                        }
                    },
                    _keywordsCriterionBuilder: {
                        type: Object,
                        value: function () {
                            return this._prepareKeywordsCriteria.bind(this);
                        }
                    },
                    _attributesCriterionBuilder: {
                        type: Object,
                        value: function () {
                            return this._prepareAttributesCriteria.bind(this);
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedItems: {
                        type: Array,
                        value: function () { return[]; }
                    },
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _getAttributeModelGrid: function () {
                    return ElementHelper.getElement(this, "#attributeModelGrid");
                },
                _prepareKeywordsCriteria: function (searchText) {
                    if (searchText) {
                        var keywordsCriterion = {};

                        keywordsCriterion.keywords = "*" + searchText + "*";
                        keywordsCriterion.operator = "_OR";

                        return keywordsCriterion;
                    }
                },
                _prepareAttributesCriteria: function (searchText) {
                    if (searchText) {
                        var attributesCriterion = [];
                        var searchKey = {};
                        var searchValue = {};
                        searchValue.eq = searchText ? searchText : '';

                        // Todo.. When Pattern comes into picture this one is effected
                        searchKey[this.titlePattern] = searchValue;
                        attributesCriterion.push(searchKey);
                        return attributesCriterion;
                    }
                },
                _getAttributeFormattedData: function (data) {
                    if (data && data.content && !_.isEmpty(data.content.entityModels)) {
                        var items = [];
                        var attributeModels = data.content.entityModels;
                        var gridColumns = this.config.tabular.columns;
                        var valContext = ContextHelper.getFirstValueContext(this.contextData);
                        for (var i = 0; i < attributeModels.length; i++) {
                            var attributeModel = attributeModels[i];
                            for(var key in attributeModel.properties){
                                if(!attributeModel[key]) {
                                    attributeModel[key] = attributeModel.properties[key];
                                }
                            }
                            var attributes = attributeModel.data && attributeModel.data.attributes ? attributeModel.data.attributes : undefined;
                            if(!_.isEmpty(attributes)) {
                                for(var j=0; j < gridColumns.length; j++) {
                                    var column = gridColumns[j];
                                    if(column.readFrom === "attributes") {
                                        var attribute = attributes[column.name];
                                        if(attribute && attribute.values) {
                                            attributeModel[column.name] = AttributeHelper.getAttributeValues(attribute.values, valContext);
                                        }
                                    }
                                }
                            }
                            items.push(attributeModel)
                        }
                        return items;
                    }
                },
                
                getSelectedItems: function () {
                    var grid = this._getAttributeModelGrid();
                    return grid.getSelectedItems();
                },

                reRenderGrid: function() {
                    var grid = this._getAttributeModelGrid();
                    grid.reRenderGrid();
                },
                
                clearSelection: function() {
                    var grid = this._getAttributeModelGrid();
                    grid.clearSelection();
                },
                getData: function() {
                    var grid = this._getAttributeModelGrid();
                    return grid.getData();
                }
            });
        })();
    </script>
</dom-module>