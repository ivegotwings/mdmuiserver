<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">
<link rel="import" href="../rock-grid/rock-grid.html">

<dom-module id="rock-attribute-model-grid">
    <template>
        <style></style>
        <attribute-model-datasource id="attributeModelDataSource" mode="[[mode]]" context-data="[[contextData]]" request="[[requestData]]" data-source="{{dataSource}}"
            data-formatter="{{_dataFormatter}}" buffer-record-size="{{size}}" current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}"
            total-count="{{totalCount}}" schema="grid" filter-criterion-builder="{{_filterCriterionBuilder}}"  sort-criterion-builder="{{_sortCriterionBuilder}}"></attribute-model-datasource>
        <rock-grid id="attributeModelGrid"  no-header data-source="{{dataSource}}" data-source-id="attributeModelDataSource" result-record-size="[[resultRecordSize]]"
                    current-record-size="{{currentRecordSize}}" config="[[config]]" grid-data-size="{{size}}" attribute-models="{}"
                    page-size="50" total-count="{{totalCount}}" ></rock-grid>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-attribute-model-grid",

                properties: {
                    config: {
                        type: Object,
                        value: function () { 
                            return {}; 
                        }
                    },
                    requestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dataFormatter: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _filterCriterionBuilder: {
                        type: Object,
                        value: function () {
                            return this._getFilterCriterion.bind(this);
                        }
                    },
                    _sortCriterionBuilder: {
                        type: Object,
                        value: function () {
                            return this._getSortCriterion.bind(this);
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedItems: {
                        type: Array,
                        value: function () { return[]; }
                    },
                    mode: {
                        type: String,
                        value: "",
                        observer: '_modeChanged'
                    },
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [
                    '_getAttributeModels(contextData)'
                ],
                _modeChanged: function() {
                    if(!_.isEmpty(this.mode)) {
                        if(this.mode === "all") {
                            this._dataFormatter = this._getAttributeFormattedData.bind(this);
                        } else {
                            this._dataFormatter = this._getAttributeFormattedDataForCompositeModel.bind(this);
                        }
                    }
                },
                _getAttributeModelGrid: function () {
                    return ElementHelper.getElement(this, "#attributeModelGrid");
                },
                _getAttributeModels: function (contextData) {
                    if (!_.isEmpty(this.contextData)) {
                        this._loading = true;

                        if(this.mode === "all") {
                            var modelGetRequest = {
                                "params": {
                                    "query": {
                                        "filters": {
                                            "typesCriterion": [
                                                "attributeModel"
                                            ]
                                        }
                                    },
                                    "fields": {
                                        "ctxTypes": [
                                            "properties"
                                        ],
                                        "attributes":[""]
                                    }
                                }
                            };
                            this.requestData = undefined;
                            this.requestData = modelGetRequest;
                        } else {
                            var contextData = DataHelper.cloneObject(this.contextData);
                            if (this.contextData.ItemContexts) {

                                var index = 0;
                                for(var i=0; i < contextData.ItemContexts.length; i++){
                                    if(contextData.ItemContexts[i].type){
                                        index++;
                                    }
                                }
                                this._currentIndex = index;
                                this._currentItems = [];
                                this._notFoundEntityTypes = [];
                            }

                            if(this.mode === "self") {
                                contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
                            }

                            if (contextData && contextData.ItemContexts) {
                                for (var i = 0; i < this.contextData.ItemContexts.length; i++) {

                                    contextData.ItemContexts = [this.contextData.ItemContexts[i]];
                                    var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
                                        contextData);
                                    if (compositeModelGetRequest && compositeModelGetRequest.params) {
                                        compositeModelGetRequest.params.fields.attributes = ["_ALL"];
                                    }
                                    this.set('requestData', compositeModelGetRequest);
                                }
                            }
                        }
                    }
                },
                _getFilterCriterion: function (filters) {
                    var attributesCriterion=[];
                    var propertiesCriterion=[];
                    var gridColumns = this.config.tabular.columns;
                    if (filters && filters.length) {
                        for (var i = 0; i < filters.length; i++) {
                            var path = filters[i].path;
                            var column=gridColumns.find(function (col) {
                                return col.name===path;
                            });
                            if(column) {
                                var filter = filters[i].filter;
                                var cri = {};
                                if (filter) {
                                    filter=filter.split(" ").join("* *");
                                    cri[path] = {eq: "*" + filter + "*"};
                                    if(column.readFrom === "attributes") {
                                        attributesCriterion.push(cri);
                                    } else{
                                        propertiesCriterion.push(cri);
                                    }
                                }
                            }
                        }
                    }
                    var filterCri={};
                    if(attributesCriterion.length) {
                        filterCri.attributesCriterion=attributesCriterion;
                    }
                    if(propertiesCriterion.length) {
                        filterCri.propertiesCriterion=propertiesCriterion;
                    }
                    return filterCri;
                },

                _getAttributeFormattedData: function (data) {
                    var grid=this._getAttributeModelGrid();
                    if (data && data.content && !_.isEmpty(data.content.entityModels)) {
                        var items = [];
                        var attributeModels = data.content.entityModels;
                        var gridColumns = this.config.tabular.columns;
                        var valContext = ContextHelper.getFirstValueContext(this.contextData);
                        for (var i = 0; i < attributeModels.length; i++) {
                            var attributeModel = attributeModels[i];
                            for(var key in attributeModel.properties){
                                if(!attributeModel[key]) {
                                    attributeModel[key] = attributeModel.properties[key];
                                }
                            }
                            var attributes = attributeModel.data && attributeModel.data.attributes ? attributeModel.data.attributes : undefined;
                            if(!_.isEmpty(attributes)) {
                                for(var j=0; j < gridColumns.length; j++) {
                                    var column = gridColumns[j];
                                    if(column.readFrom === "attributes") {
                                        var attribute = attributes[column.name];
                                        if(attribute && attribute.values) {
                                            attributeModel[column.name] = AttributeHelper.getAttributeValues(attribute.values, valContext);
                                        }
                                    }
                                }
                            }
                            if(this.selectedItems && this.selectedItems.length) {
                                for (var ind = 0; ind < this.selectedItems.length; ind++) {
                                    if (this.selectedItems[ind].id == attributeModel.id) {
                                        grid.selectItem(attributeModel);
                                    }
                                }
                            }
                            items.push(attributeModel)
                        }
                        return items;
                    }
                },

                _getAttributeFormattedDataForCompositeModel: function (data, requestData) {
                    if (data && data.content && data.content.entityModels) {
                        var attributeModels = DataTransformHelper.transformAttributeModels(data.content.entityModels[0], this.contextData);
                        if (!_.isEmpty(attributeModels)) {
                            if (this._currentIndex == 1) {
                                this._currentItems = [];
                            }
                            this.push('_currentItems', attributeModels);

                            if ((!attributeModels || _.isEmpty(attributeModels)) && DataHelper.isValidObjectPath(requestData, "params.query.name")) {
                                this._notFoundEntityTypes.push(requestData.params.query.name);
                            }
                        }

                        var responseLength = this._currentItems.length + this._notFoundEntityTypes.length;

                        if (responseLength == this._currentIndex) {
                            var compositeModels = [];
                            for(var i=0; i<this._currentItems.length; i++) {
                                var currentItem = this._currentItems[i];
                                var keys = Object.keys(currentItem);
                                if(keys && keys.length > 0) {
                                    for(var j=0; j<keys.length; j++) {
                                        var key = keys[j];
                                        if(!(compositeModels.find(obj => obj.name === key))) {
                                            compositeModels.push(currentItem[key]);
                                        }
                                    }
                                }
                            }

                            this.set("_gridData", compositeModels);
                            this._loading = false;
                            if (this._notFoundEntityTypes && this._notFoundEntityTypes.length) {
                                var messageContent = this._notFoundEntityTypes.join(", ");
                                this.logError("rock-attribute-model-grid:- Attribute models not found for entity type(s) " + messageContent);
                            }
                        }
                    }
                },
                _getSortCriterion: function (sortOrders) {
                    if (sortOrders && sortOrders.length) {
                        var sortOrder = sortOrders[sortOrders.length - 1];
                        var gridColumns = this.config.tabular.columns;
                        var attributes = [];
                        var property = {};
                        var direction = "_ASC";
                        if (sortOrder.direction ) {
                            if (sortOrder.direction == "asc") {
                                direction = "_ASC";
                            } else if (sortOrder.direction == "desc") {
                                direction = "_DESC";
                            }
                            property[sortOrder.path] = direction;
                            if(this.attributeModels){
                                var attributeModel = this.attributeModels[sortOrder.path];
                                property["sortType"] = ConstantHelper.getDataTypeConstant(attributeModel.dataType);
                            }
                            if(!property["sortType"]){
                                property["sortType"] = ConstantHelper.DATATYPE_STRING;
                            }
                            attributes.push(property);
                            for(var i=0;i<gridColumns.length;i++){
                                var col=gridColumns[i];
                                if(col.name==sortOrder.path){
                                    if(col.readFrom === "attributes") {
                                        return { "attributes": attributes };
                                    } else{
                                        return { "properties": attributes };
                                    }
                                }
                            }
                            return { "properties": attributes };
                        }
                    }
                    return undefined;
                },

                getSelectedItems: function () {
                    var grid = this._getAttributeModelGrid();
                    return grid.getSelectedItems();
                },
                reRenderGrid: function() {
                    var grid = this._getAttributeModelGrid();
                    grid.reRenderGrid();
                },
                clearSelection: function() {
                    var grid = this._getAttributeModelGrid();
                    grid.clearSelection();
                },
                getData: function() {
                    var grid = this._getAttributeModelGrid();
                    return grid.getData();
                },
                deselectItem: function(item) {
                    var grid = this._getAttributeModelGrid();
                    grid.deselectItem(item);
                },
                selectItems: function(items) {
                    if(!_.isEmpty(items)) {
                        for(var i=0; i<items.length; i++) {
                            this.selectItem(items[i]);
                        }
                    }
                },
                selectItem: function(item) {
                    var grid = this._getAttributeModelGrid();
                    grid.selectItem(item);
                }
            });
        })();
    </script>
</dom-module>