<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="relationships-tab-menu-provider">
    <template>
        <liquid-entity-model-get id="liquidModeleGet" operation="getbyids" request-data={{_request}} on-response="_onModelReceived"
            on-error="_onModelGetFailed"></liquid-entity-model-get>
        <liquid-entity-model-get id="getRelDomains" operation="getbyids" on-response="_onRelModelsReceived" on-error="_onModelGetFailed"></liquid-entity-model-get>
    </template>
    <script>
        Polymer({
            is: 'relationships-tab-menu-provider',
            properties: {
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                selectedMenuTitle: {
                    type: String,
                    value: ""
                },
                _callback: {
                    type: Function
                },
                _tabItem: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _request: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 *  Indicates the domain of the relationship types.
                 */
                domain: {
                    type: String,
                    value: "generic"
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],
            /**
              * <b><i>Content development is under progress... </b></i> 
              */
            getMenu: function (tabItem, callback) {
                this._callback = callback;
                this._tabItem = tabItem;
                this._setRequestObject();
                var liquid = this.$.liquidModeleGet;
                if (liquid) {
                    liquid.generateRequest();
                }
            },

            _onModelReceived: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response)
                if (responseContent) {
                    this._relationshipEntityTypeMappings = this._getRelationshipEntityTypeMappings(responseContent.entityModels);
                    var relationshipTypeNames = this._relationshipEntityTypeMappings.map(function (rel) {
                        return rel.relationshipTypeName + "_relationshipModel";
                    });
                    this._generateCheckDomainRequest(relationshipTypeNames);

                }
            },
            _generateCheckDomainRequest: function (relationshipTypeNames) {
                var req = DataHelper.cloneObject(this._request);
                delete req.params.query.id;
                req.params.query.ids = relationshipTypeNames;
                req.params.query.domain = this.domain;
                req.params.query.filters = {
                    "typesCriterion": ["relationshipModel"]
                };
                req.params.fields = {};
                var checkDomainLiquid = this.shadowRoot.querySelector("#getRelDomains");
                if (checkDomainLiquid) {
                    checkDomainLiquid.requestData = req;
                    checkDomainLiquid.generateRequest();
                }
            },
            _onRelModelsReceived: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response)
                if (responseContent) {
                    var models = responseContent.entityModels;
                    var relationshipTypeNames = [];
                    for (var i = 0; i < models.length; i++) {
                        if (models[i].domain == this.domain) {
                            relationshipTypeNames.push(models[i].name);
                        }
                    }
                    this._relationshipEntityTypeMappings = this._relationshipEntityTypeMappings.filter(function (rel) {
                        var ownership = rel.relatedEntityTypes[0].properties.relationshipOwnership;
                        if (ownership != "whereused") {
                            return relationshipTypeNames.indexOf(rel.relationshipTypeName) > -1;
                        }
                    });
                    var menuItems = this._buildMenuItems(this._relationshipEntityTypeMappings);
                    this._callback(menuItems);
                }
            },

            _onModelGetFailed: function (e) {
                this.logError("TabMenuError", e);
            },

            _getRelationshipEntityTypeMappings: function (entityModels) {
                var relationshipEntityTypeMappings = [];
                if (entityModels && entityModels.length > 0) {
                    var data = entityModels[0].data;
                    if (data && data.relationships) {
                        var relationshipModels = data.relationships;
                        this._setRelationshipEntityTypeMappings(relationshipModels, relationshipEntityTypeMappings);
                    }

                    if (data && !_.isEmpty(data.contexts)) {
                        var relationshipModels = data.contexts[0].relationships;
                        this._setRelationshipEntityTypeMappings(relationshipModels, relationshipEntityTypeMappings);
                    }
                }
                return relationshipEntityTypeMappings;
            },

            _setRelationshipEntityTypeMappings: function (relationshipModels, relationshipEntityTypeMappings) {
                if (!_.isEmpty(relationshipModels)) {
                    Object.keys(relationshipModels).map(function (relationshipTypeName) {
                        var relationshipModel = {};
                        relationshipModel.relationshipTypeName = relationshipTypeName;
                        relationshipModel.relatedEntityTypes = relationshipModels[
                            relationshipTypeName];
                        relationshipEntityTypeMappings.push(relationshipModel);
                    });
                }
            },

            _buildMenuItems: function (relationshipEntityTypeMappings) {
                var menuItems = [];

                if (relationshipEntityTypeMappings && relationshipEntityTypeMappings instanceof Array && relationshipEntityTypeMappings.length > 0) {
                    for (var i = 0; i < relationshipEntityTypeMappings.length; i++) {
                        var relationshipTypeName = relationshipEntityTypeMappings[i].relationshipTypeName;
                        var relatedEntityTypes = relationshipEntityTypeMappings[i].relatedEntityTypes;

                        if (relatedEntityTypes && relatedEntityTypes instanceof Array) {
                            for (var j = 0; j < relatedEntityTypes.length; j++) {
                                var relatedEntityTypeProps = relatedEntityTypes[j].properties;
                                if (relatedEntityTypeProps) {
                                    var menuItem = {};
                                    menuItem.name = relationshipTypeName;
                                    menuItem.title = relatedEntityTypeProps.externalName;
                                    menuItem.selected = this.selectedMenuTitle === menuItem.title ? true : false;
                                    menuItem.component = DataHelper.cloneObject(this._tabItem.component);

                                    var configContext = menuItem.component.properties["config-context"];
                                    if (!configContext) {
                                        configContext = {};
                                    }
                                    configContext.relationshipTitle = relatedEntityTypeProps.externalName;
                                    configContext.relationshipTypeName = relationshipTypeName;
                                    if (!menuItem.properties) {
                                        menuItem.properties = {};
                                    }
                                    menuItem.component.properties["config-context"] = configContext;

                                    menuItems.push(menuItem);
                                }
                            }
                        }
                    }
                }
                return this.sortItems(menuItems);
            },
            sortItems: function (menuItems) {
                var titleA, titleB;
                if (menuItems && menuItems.sort) {
                    menuItems = menuItems.sort(function (a, b) {
                        titleA = a.title.toLowerCase();
                        titleB = b.title.toLowerCase();
                        if (titleA > titleB) return 1;
                        if (titleA < titleB) return -1;
                        return 0;
                    });
                }
                return menuItems;
            },
            _setRequestObject: function () {
                var firstDataContext = this.getFirstDataContext();
                var firstItemContext = this.getFirstItemContext();

                if(!firstItemContext) return;

                var entityType = firstItemContext.type;

                var req = {
                    "params": {
                        "query": {
                            "id": entityType + "_entityCompositeModel",
                            "filters": {
                                "typesCriterion": ["entityCompositeModel"]
                            }
                        },
                        "fields": {
                            "properties": ["_ALL"],
                            "relationships": ["_ALL"]
                        }
                    }
                };

                if (this.contextData) {
                    DataRequestHelper.addContextsToModelRequest(req, this.contextData);
                } else if (!_.isEmpty(firstDataContext)) {
                    req.params.query.contexts = [firstDataContext];
                }

                this._request = req;
            }
        });
    </script>
</dom-module>