<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-split-screen-behavior/bedrock-split-screen-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="relationships-tab-menu-provider.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-relationship-split-screen">
	<template>
		<style include="bedrock-style-common">
			:host {
				display: block;
				height: 100%;
				overflow-x: auto;
				overflow-y:hidden;
			}

			.relationship-grid {
				width: 50%;
				height: 100%;
				flex: none;
				-webkit-flex: none;
			}

			.relationship-grid-1 {
				height: 100%;
				width: 100%;
			}

			.dimension {
				width: 100%;
				@apply --layout;
				@apply --layout-horizontal;
				height: 30px;
				line-height: 30px;
				margin-bottom: 5px;
				font-family: var(--default-font-family);
				font-size: var(--default-font-size, 14px);
				color: var(--palette-cerulean, #036bc3);
			}

			.actionButton {
				float: right;
				margin-top: 10px;
				padding-right: 10px;
			}

			#dimensionValueContainer {
				margin-left: 20px;
				margin-top: auto;
			}

			pebble-icon {
				padding-right: 10px;
			}

			.relationshipGrid {
				width: 100%;
				height: 100%;
			}

			.relationshipErrorGrid {
				width: 100%;
				color: var(--palette-pinkish-red, #ee204c);
				padding-right: 5px;
			}

			.relationship-split-screen-title-container .relationship-grid {
				padding-left: 20px;
				padding-top: 10px;
				font-size: var(--default-font-size, 14px);
				color: var(--palette-cerulean, #036bc3);
			}


			pebble-vertical-divider {
				--pebble-vertical-divider-color: #c1cad4;
				height: 100%;
				opacity: 1;
				position: absolute;
				top: 0px;
				left: 0px;
			}

			.relationship-split-screen-title-container {
				display: flex;
				flex-flow: row;
			}

			.split-relationship-content-column-wrapper {
				position: relative;
				height: 100%;
			}

			.split-relationship-content-wrapper {
				width: 100%;
				height: 100%;
				display: flex;
				justify-content: flex-start;
			}

			.relationship-split-screen-container {
				@apply --rock-tab-content-height;
				-webkit-transition: height 0.3s;
				-moz-transition: height 0.3s;
				-o-transition: height 0.3s;
				transition: height 0.3s;
			}

			@supports (-ms-ime-align:auto) {
				.relationship-split-screen-container {
					transition: initial;
				}
			}
		</style>

		<div class="relationship-split-screen-container base-grid-structure">
			<div class="relationship-split-screen-title-container base-grid-structure-child-1">
				<template is="dom-if" if="[[_contexts.length]]">
					<div class$="dimension [[_getColLength()]]" style$="[[_getStyle()]]">
						<template is="dom-repeat" items="[[_contexts]]" as="context">
							<div id="sourceDimensionValueContainer" class$="[[_getListClassName()]]">
								<pebble-icon icon="pebble-icon:language" class="pebble-icon-size-16 m-r-10"></pebble-icon>
								[[_getTitle(context)]]
							</div>
						</template>
					</div>
				</template>
			</div>
			<div class="base-grid-structure-child-2">
				<div class="split-relationship-content-wrapper">
					<template is="dom-if" if="[[_contexts.length]]">
						<template is="dom-repeat" index-as="index" items="[[_contexts]]" as="context" initial-count="1" target-framerate="30">
							<div class$="[[_getListClassName()]]">
								<div class="split-relationship-content-column-wrapper">
									<template is="dom-if" if="[[!_isFirstIndex(index)]]">
										<pebble-vertical-divider></pebble-vertical-divider>
									</template>
									<div class="base-grid-structure">
										<div class="base-grid-structure-child-1">
											<template is="dom-if" if="[[_isValidContext(context)]]"></template>
											<div id="[[context.value]]-error-container" class="relationshipErrorGrid" hidden></div>
										</div>
										<div class="base-grid-structure-child-2 relationship-manage-content-height">
											<div id="[[context.value]]-relationship-container" class="relationshipGrid">
												<rock-relationship-manage mode="[[mode]]" load-govern-data$="[[loadGovernData]]" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]"
												 context-data="[[_getContextData(context)]]" config-context="[[configContext]]" no-of-columns="[[noOfColumns]]"
												 do-sync-validation$="[[doSyncValidation]]"></rock-relationship-manage>
											</div>
										</div>
									</div>
								</div>
							</div>
						</template>
					</template>
				</div>
			</div>
		</div>
	</template>
	<script>

		class RockRelationshipSplitScreen
			extends Polymer.mixinBehaviors([
				RUFBehaviors.SplitScreenBehavior
			], Polymer.Element) {
			static get is() { return 'rock-relationship-split-screen' }

			ready() {
				super.ready();
			}
			static get properties() {
				return {

					readonly: {
						type: Boolean,
						value: false
					},
					verbose: {
						type: Boolean,
						value: false
					},
					dataIndex: {
						type: String,
						value: "entityData"
					},
					dataSubIndex: {
						type: String,
						value: "data"
					},
					loadGovernData: {
						type: Boolean,
						value: true
					},

					listClassName: {
						type: String,
						value: 'relationship-grid'
					}
				}
			}
			disconnectedCallback() {
				super.disconnectedCallback();
			}
			connectedCallback() {
				super.connectedCallback();
				this.logInfo("SplitScreenAttached");
				this.addEventListener('scroll', this._onScrollDebounce);
			}
			constructor() {
				super();
				if (this.verbose) {
					this.logInfo("SplitScreenCreated");
				}
				this._onScrollDebounce = _.debounce(this._onScroll.bind(this), 300);
			}
			_isFirstIndex(_index) {
				if (_index == 0) return true;
				return false;
			}
			_onScroll(e) {
				const { scrollHeight, scrollTop, offsetHeight } = this;

				const scrollDiff = scrollHeight - offsetHeight - scrollTop;

				const PRELOAD_HEIGHT = 200;

				if (scrollDiff <= PRELOAD_HEIGHT) {
					this._fireLoadMoreRelationships();
				}

			}
			_getColLength(){				
				if(this._contexts){
					let contextlength = this._contexts.length;
					this.updateStyles({
						"--grid-tile-col-length": contextlength <= 2?contextlength:2
					});
				}
			}

			_fireLoadMoreRelationships() {
				ComponentHelper.fireBedrockEvent("load-more-relationships", null, { ignoreId: true });
			}			
			/**
			 * Can be used to get the elements if they are dirty.
			 */
			getIsDirty() {
				let relManage = this.shadowRoot.querySelector("rock-relationship-manage");
				return this._getIsDirty(relManage);
			}
			/**
			 * Can be used to get the elements if they are dirty.
			 */
			getControlIsDirty() {
				let relManage = this.$$("rock-relationship-manage");
				return this._getControlIsDirty(relManage);
			}

			refresh(options) {
				let relManageList = this.shadowRoot.querySelectorAll("rock-relationship-manage");
				if (relManageList && relManageList.length) {
					for (let relMngIdx = 0; relMngIdx < relManageList.length; relMngIdx++) {
						relManageList[relMngIdx].refresh(options);
					}
				}
			}

			_isValidContext(context) {
				let self = this;
				let contextData = this._getContextData(context);
				let dataContext = ContextHelper.getFirstDataContext(contextData);
				let valueContext = ContextHelper.getFirstValueContext(contextData);
				let itemContext = ContextHelper.getFirstItemContext(contextData);

				let relContainer, relErrorContainer;

				let valid = function () {
					relContainer = self.$$('#' + context.value + '-relationship-container');
					relErrorContainer = self.$$('#' + context.value + '-error-container');

					relContainer && (relContainer.hidden = false);
					relErrorContainer && (relErrorContainer.hidden = true);
				}

				let invalid = function (statusCode) {
					relContainer = self.$$('#' + context.value + '-relationship-container');
					relErrorContainer = self.$$('#' + context.value + '-error-container');

					relContainer && (relContainer.hidden = true);
					if (relErrorContainer) {
						if (!_.isEmpty(statusCode)) {
							let errorList = "<ul>";
							for (let sc of statusCode) {
								errorList = errorList + "<li>" + sc + "</li>";
							}
							errorList = errorList + "</ul>"
							relErrorContainer.innerHTML = errorList;
						}
						relErrorContainer.hidden = false;
					}
				}

				ContextHelper.isValidContext(itemContext.type, dataContext, valueContext, valid, invalid);
			}
		}
		customElements.define(RockRelationshipSplitScreen.is, RockRelationshipSplitScreen)
	</script>
</dom-module>