<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="relationships-tab-menu-provider.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-relationship-split-screen">
	<template>
		<style include="bedrock-style-common">
			:host {
				display: block;
				height: 100%;
				overflow: auto;
			}

			.relationship-grid {
				/*display: inline-flex;
				display: -webkit-inline-flex;
				/*border: 1px solid black;*/
				display: inline-block;
				float: left;
				width: 50%;
				flex:none;
       			-webkit-flex:none;
			}
			
			.relationship-grid-1 {
				width: 100%;
			}
			
			.dimension {
				width: 100%;
				@apply --layout;
				@apply --layout-horizontal;
				border-bottom: 1px solid var(--palette-cloudy-blue, #c1cad4);
				height: 30px;
    			line-height: 30px;
				margin-bottom:5px;
				font-family:var(--default-font-family);
				font-size:var(--default-font-size,14px);
				color:var(--palette-cerulean, #036bc3);
			}			
			.actionButton{
				float:right;
				margin-top:10px;
				padding-right:10px;
			}
			#dimensionValueContainer {
				margin-left: 20px;
				margin-top: auto;
			}
			
			pebble-icon {
				padding-right:10px;
			}
			
			.relationshipGrid {
				width: 100%;
			}
			.splitscreenContainerTitle .relationship-grid{
				padding-left: 20px;
				padding-top: 10px;
				font-size:var(--default-font-size,14px);
				color:var(--palette-cerulean, #036bc3);
			}
			
			.divider {
				width: 2%;
				height: auto !important;
			}
			
			pebble-vertical-divider {
				--pebble-vertical-divider-color: #1a2028;
				height: 100%;
				border: 0px;
				min-height: 0px;
			}

			.splitscreenContainer, .splitscreenContainerTitle{
				display: flex;
				flex-flow: row;
			}
		</style>

		<div class="splitscreenContainerTitle">		
			<template is="dom-if" if="[[_showSourceTitles]]">
				<template is="dom-repeat" items="[[_sources]]" as="source">
					<div id="sourceDimensionValueContainer" class$="[[_getRelationshipListClass()]]">
						<pebble-icon icon="pebble-icon:Language"></pebble-icon>
						[[source]]
					</div>
				</template>
				<!--<div class="actionButton">
					<pebble-button id="actions" class="btn btn-success" icon="pebble-icon:action-take-task" button-text="Actions" noink elevation="2" dropdown-icon on-tap="_onActionsTap"></pebble-button>
				</div>-->
			</template>
		
			<template is="dom-if" if="[[_showLocales]]">
				<template is="dom-repeat" items="[[_locales]]" as="locale">
					<div id="localeDimensionValueContainer" class$="[[_getRelationshipListClass()]]">
						<pebble-icon icon="pebble-icon:Language"></pebble-icon>
						[[locale]]
					</div>
					<div class="clearfix"></div>
				</template>			
				<!--<div class="actionButton">
					<pebble-button id="actions"  class="btn btn-success" icon="pebble-icon:action-take-task" button-text="Actions" noink elevation="2" dropdown-icon on-tap="_onActionsTap"></pebble-button>
				</div>-->
			</template>
		</div>
		<div class="splitscreenContainer">
			<template is="dom-if" if="[[_showSources]]">
				<template is="dom-repeat" items="[[_sources]]" as="source">
					<div class$="[[_getRelationshipListClass()]]">
						<div class="relationshipGrid">
							<rock-relationship-manage mode="[[mode]]" context-data="[[_getContextData(source, '')]]" config-context="[[configContext]]" no-of-columns="[[noOfColumns]]" do-sync-validation$="[[doSyncValidation]]"></rock-relationship-manage>
						</div>
						<div class="divider" style$="[[_getStyle()]]" align="right">
						</div>
					</div>
				</template>
			</template>
			
			<template is="dom-if" if="[[_showLocales]]">
				<template is="dom-repeat" items="[[_locales]]" as="locale">
					<div class="clearfix"></div>
					<div class$="[[_getRelationshipListClass()]]">
						<div class="relationshipGrid">
								<rock-relationship-manage mode="[[mode]]" context-data="[[_getContextData('', locale)]]" config-context="[[configContext]]" no-of-columns="[[noOfColumns]]" do-sync-validation$="[[doSyncValidation]]"></rock-relationship-manage>
						</div>
						<div class="divider" style$="[[_getStyle()]]" align="right">
						</div>
					</div>
				</template>
			</template>
		</div>
	</template>
	<script>
		Polymer({
			is: "rock-relationship-split-screen",
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
			created: function () {
				if (this.verbose){
					this.logInfo("SplitScreenCreated");
				}
				this._onScrollDebounce = _.debounce(this._onScroll.bind(this), 300);
			},
			/**
             * If set as true , it indicates the component is in read only mode
             */
            readonly: {
                type: Boolean,
                value: false		
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
			attached: function () {
				this.logInfo("SplitScreenAttached");

				this.addEventListener('scroll', this._onScrollDebounce);
			},

			_onScroll(e) {
				const { scrollHeight, scrollTop, offsetHeight } = this;

				const scrollDiff = scrollHeight - offsetHeight - scrollTop;

				const PRELOAD_HEIGHT = 200;

				if (scrollDiff <= PRELOAD_HEIGHT) {
					this._fireLoadMoreRelationships();
				}
			},

			_fireLoadMoreRelationships() {
				ComponentHelper.fireBedrockEvent("load-more-relationships", null, { ignoreId: true });
			},
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
			ready: function () {
				this.logInfo("SplitScreenReady");
			},
			properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
				contextData: {
					type: Object,
					value: function () {
						return {};
					}
				},
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
				configContext: {
					type: Object,
					value: function() {
						return {};
					}
				},
				/**
				 * Indicates whether the relationship is rendered in the edit or view mode. 
				 * The two possible values are <b>view</b> and <b>edit</b>.
				 */
				mode: {
					type: String,
				},
				/**
				 * Indicates the number of screens on which the relationship grid is rendered. The possible values are 
				 * one, two, and three.
				 */
				noOfScreens: {
					type: Number,
					value: 0
				},
				/**
				 * Indicates the number of columns on which the relationship grid is rendered. The possible values are 
				 * one, two, and three.
				 */
				noOfColumns: {
					type: Number,
					value: 3,
					computed: '_computeColumns(noOfScreens)'
				},
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
				doSyncValidation: {
					type: Boolean,
					value: true
				},
				 /**
				 * Indicates the array source values selected from the dimension selector.
				 */
				_sources: {
					type: Array,
					value: function () {
						return [];
					}
				},
				/**
				 * Indicates the array of locale values selected from the dimension selector.
				 */
				_locales: {
					type: Array,
					value: function () {
						return [];
					}
				},

				_showLists: {
					type: Boolean,
					value: false
				},

				_showListTitles: {
					type: Boolean,
					value: false
				},

				_showSources: {		
 					type: Boolean,		
 					value: false		
 				},		

 				_showSourceTitles: {		
 					type: Boolean,		
 					value: false		
 				},		
 		
 				_showLocales: {		
 					type: Boolean,		
 					value: false		
 				},		
				/**
				 * Specifies whether or not to write the logs.
				 */
				verbose: {
					type: Boolean,
					value: false
				}
			},

			behaviors: [
				RUFBehaviors.ComponentContextBehavior,
				RUFBehaviors.UIBehavior
			],

			observers: [
				'_computeScreens(contextData, configContext)'
			],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
			refresh: function() {
				this._computeScreens(this.contextData, this.configContext);
			},
			/**
			 * Can be used to get the elements if they are dirty.
			 */
			getIsDirty: function () {
				var relManage = this.shadowRoot.querySelector("rock-relationship-manage");
				if (relManage && relManage.getIsDirty) {
					return relManage.getIsDirty();
				}
			},
			/**
			 * Can be used to get the elements if they are dirty.
			 */
			getControlIsDirty: function () {
				var relManage = this.$$("rock-relationship-manage");
				if (relManage && relManage.getControlIsDirty) {
					return relManage.getControlIsDirty();
				}
			},
			
			refresh: function (){
				var relManage = this.$$("rock-relationship-manage");
				relManage.refresh();
			},
			_getRelationshipListClass: function () {
				return "relationship-grid relationship-grid-" + this.noOfScreens;
			},
			_computeScreens: function (contextData, configContext) {
				if (_.isEmpty(contextData) || !configContext) return;
				
				var valContexts = this.getValueContexts();

				if(!valContexts || !valContexts.length) return;

				const { sources, locales } = valContexts.reduce((result, ctx)=> {
					const { sources, locales } = result;
					
					if(sources.indexOf(ctx.source) === -1)
						sources.push(ctx.source);

					if(locales.indexOf(ctx.locale) === -1)
						locales.push(ctx.locale);

					return result;
				}, {sources: [], locales: []});

				this._sources = sources;
				this._locales = locales;

				const isEnoughSources = sources.length > 1;

				this.noOfScreens = Math.max(sources.length, locales.length, 1);
				
				this._showLocales = !isEnoughSources && locales.length > 1;
				this._showSources = !this._showLocales;
				this._showSourcesTitle = isEnoughSources;
			},
			_computeColumns: function () {
				return this.noOfScreens > 1 ? 1 : this.noOfColumns;
			},
			_getStyle: function () {
				return this.noOfScreens == 1 ? 'display: none' : '';
			},
			_isHidden: function (item) {
				var index = this.locales.indexOf(item);

				return index == (this.noOfScreens - 1)
			},
			_onActionsTap: function () {
				alert("actions tapped");
			},
			_getContextData(source, locale) {
				var ctxData = {};
				var dataContexts = DataHelper.cloneObject(this.getDataContexts());
				var valContexts = DataHelper.cloneObject(this.getValueContexts());
				var itemContexts = DataHelper.cloneObject(this.getItemContexts());
				var userContexts = DataHelper.cloneObject(this.getUserContexts());

				if (dataContexts && valContexts && itemContexts) {
					ctxData[ContextHelper.CONTEXT_TYPE_DATA] = dataContexts;
					ctxData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
					ctxData[ContextHelper.CONTEXT_TYPE_USER] = userContexts;
					ctxData[ContextHelper.CONTEXT_TYPE_VALUE] = [];

					if (source) {
						if (valContexts && valContexts.length) {
							valContexts.forEach(function (valCtx) {
								if (valCtx.source == source) {
									ctxData[ContextHelper.CONTEXT_TYPE_VALUE].push(valCtx);
								}
							});
						}
					} else if (locale) {
						valContexts.forEach(function (valCtx) {
							if (valCtx.locale == locale) {
								ctxData[ContextHelper.CONTEXT_TYPE_VALUE].push(valCtx);
							}
						});
					} else {
						ctxData[ContextHelper.CONTEXT_TYPE_VALUE] = valContexts;
					}
				}

				return ctxData;
			}
		});
	</script>
</dom-module>