<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../liquid-rest/liquid-rest.html" />

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<dom-module id="rock-version-manage">
  <template>
    <style include="bedrock-style-common">
      .block {
        padding: 20px 0px;
      }

      :host {
        display: block;
        height: 100%;
      }

      .version-manage-wrapper {
        display: flex;
        align-items: center;
        flex: 0 1 auto;
        justify-content: center;
      }

      #attrName {
        font-family: var(--default-font-family);
        font-size: var(--default-font-size, 14px);
        font-weight: normal;
        font-style: normal;
        font-stretch: normal;
        color: var(--palette-steel-grey, #75808b);
        position: relative;
      }

      #attrVal {
        font-size: var(--font-size-lg, 12px);
        font-weight: var(--font-medium, 500);
        color: var(--palette-dark, #1a2028);
        margin-left: 5px;
      }
    </style>
    <div class="block">
      <div id="attribute" class="version-manage-wrapper col-1-row-1">
        <div class="col-1-row-1-child-1">
          <span id="attrName">Current runtime version number:</span>
          <span id="attrVal">[[runtimeVersion]]</span>
          <pebble-button id="statusIcon" class="btn btn-success m-l-10" button-text="Bump up version >>" on-click="_handleSave">
          </pebble-button>
        </div>
      </div>
      <liquid-rest id="liqRuntimeVersionUpdate" url="/data/version/updateRuntimeVersion" method="POST" on-liquid-response="_onResponse"
        on-liquid-error="_onError">
      </liquid-rest>
    </div>
  </template>
  <script>
    class RockVersionManage
      extends Polymer.mixinBehaviors([

      ], Polymer.Element) {
      static get is() {
        return 'rock-version-manage';
      }
      static get properties() {
        return {
          runtimeVersion: {
            type: String,
            value: "0.0.0.0"
          }

        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.runtimeVersion = SharedUtils.RuntimeVersionManager.getVersion();
      }
      get liqRuntimeVersionUpdateLiq() {
        this._liqRuntimeVersionUpdateLiq = this._liqRuntimeVersionUpdateLiq || this.shadowRoot.querySelector('#liqRuntimeVersionUpdate');
        return this._liqRuntimeVersionUpdateLiq;
      }

      _handleSave() {
        this.generateRequest();
      }
      generateRequest() {
        let configSaveService = this.liqRuntimeVersionUpdateLiq;
        if (configSaveService) {
          configSaveService.operation = "get";
          configSaveService.requestData = {};
          configSaveService.generateRequest();
        }
      }
      _onResponse(e) {
        if (e.detail && e.detail.response && e.detail.response.newVersion) {
          this.runtimeVersion = e.detail.response.newVersion;
          LiquidDataObjectUtils.invalidateAllCache();
          SharedUtils.RuntimeVersionManager.setVersion(this.runtimeVersion);
        }
      }


      }
      customElements.define(RockVersionManage.is, RockVersionManage)
  </script>
</dom-module>