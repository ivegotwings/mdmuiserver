<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<!--
@group rock Elements
@element rock-toolbar-default-actions
@demo demo/index.html
-->
<dom-module id="rock-toolbar-default-actions">
    <template>
        <style include="bedrock-style-common"></style>
        <style>
        </style>
        <pebble-toolbar id="toolbar" readonly$="[[readonly]]" config-data="[[_toolbarConfig]]"></pebble-toolbar>
        <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="toolbar"></bedrock-pubsub>
        <bedrock-pubsub event-name="on-toolbar-change" handler="_onToolbarChange" target-id="toolbar"></bedrock-pubsub>
    </template>
    <script>
        class RockToolbarDefaultActions
            extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior, RUFBehaviors.ComponentConfigBehavior], Polymer.Element) {
            static get is() { return 'rock-toolbar-default-actions' }
            ready() {
                super.ready();
            }
            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function() {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    _toolbarConfig: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    domain: {
						type: String
					}
                }
            }
            /**
            *
            */
            connectedCallback() {
                super.connectedCallback();
            }
            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }
            _onContextDataChange() {
                if(!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if(appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }

                    if (this.domain) {
                        context[ContextHelper.CONTEXT_TYPE_DOMAIN] = [{
                            "domain": this.domain
                        }];
                    }

                    this.requestConfig('rock-toolbar-default-actions', context);
                }
            }
            onConfigLoaded(componentConfig) {
                if(componentConfig && componentConfig.config) {
                    var toolbarConfig = componentConfig.config.toolbarConfig;
                    var buttonItems = DataHelper.convertObjectToArray(toolbarConfig.buttonItems);
                    for(var i = 0; i < buttonItems.length; i++) {
                        buttonItems[i].buttons = DataHelper.convertObjectToArray(buttonItems[i].buttons);
                    }
                    this._toolbarConfig = {"buttonItems": buttonItems};
                }
            }
            setPageRange(range) {
                if (this.shadowRoot && this.shadowRoot.querySelector('pebble-toolbar') && this.shadowRoot.querySelector('pebble-toolbar').shadowRoot.querySelector('pebble-button#pageRange')) {
				    this.shadowRoot.querySelector('pebble-toolbar').shadowRoot.querySelector('pebble-button#pageRange').buttonText = range;
				}
            }
            setAttributeToToolbarButton(btnName, attribute, addAttr) {
                if(!this.shadowRoot) {
                    return;
                }

                var toolbar = this.shadowRoot.querySelector("#toolbar");
                if(toolbar) {
                    toolbar.setAttributeToToolbarButton(btnName, attribute, addAttr);
                }
            }
            _onToolbarEvent(e, detail) {
                this.fireBedrockEvent("rock-toolbar-button-event", detail);
            }
            //Event is needed only for pageRange
            _onToolbarChange(e, detail) {
                if(DataHelper.isValidObjectPath(detail, "model.button.name") && detail.model.button.name == "pageRange") {
                    this.fireBedrockEvent("on-page-range-requested", detail);
                }
            }
        }
        customElements.define(RockToolbarDefaultActions.is, RockToolbarDefaultActions);
    </script>
</dom-module>