<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-wizard/rock-wizard.html">

<dom-module id="app-business-function">
  <template>
    <style include="pebble-styles-shared"></style>
    <rock-layout>
      <liquid-config-get auto id="getManageAppConfig" operation="getconfigs" request-id="getManageAppConfig" request-data="{{_configRequest}}"
        last-response="{{applicationConfig}}"></liquid-config-get>
      <rock-titlebar icon="pebble-md-icons:UserIcon" title="[[config.label]]"></rock-titlebar>
      <rock-wizard config="{{config}}" on-first-step-cancelled="_onFirstStepCancelled" on-last-step-completed="_onLastStepCompleted"></rock-wizard>
    </rock-layout>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'app-business-function',
        properties: {
          config: {
            type: Object,
            value: function () { return {}; },
            computed: "getConfig('rock-wizard')"
          },
          _configRequest: {
            type: Object,
            value: function () {
              return {
                "apps": [
                  "app-business-function"
                ],
                "tenantId": this.tenantId,
                "security": {
                  "user": "user1",
                  "role": "role1"
                },
                "ctx": []
              };
            },
            notify: true
          }
        },
        behaviors: [
          RUFBehaviors.UIBehavior,
          RUFBehaviors.BusinessFunctionBehavior
        ],
        _onFirstStepCancelled: function() {
          this._closeBusinessFunction();
        },
        _onLastStepCompleted: function() {
          this._closeBusinessFunction();
        },
        _closeBusinessFunction: function() {
          var mainApp = document.querySelector('main-app');
            if (mainApp) {
                var contentViewMgr = mainApp.$$("rock-content-view-manager");
                if (contentViewMgr) {
                    var activeContentView = contentViewMgr.$.contentViewManager.querySelector(
                        "rock-content-view:not([hidden])");
                    if (activeContentView) {
                        contentViewMgr.closeView(activeContentView.name);
                    }
                }
            }
        }
      });
    })();
  </script>
</dom-module>