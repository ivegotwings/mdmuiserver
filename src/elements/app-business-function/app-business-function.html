<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-wizard/rock-wizard.html">

<dom-module id="app-business-function">
  <template>
    <style include="pebble-styles-shared"></style>
    <rock-layout>
      <liquid-config-aggregate-get id="getAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-business-function" 
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
      <rock-titlebar icon="pebble-md-icons:UserIcon" title="[[config.label]]"></rock-titlebar>
      <rock-wizard config="{{config}}" on-first-step-cancelled="_onFirstStepCancelled" on-last-step-completed="_onLastStepCompleted"></rock-wizard>
    </rock-layout>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'app-business-function',
        attached: function () {
            var userContext = {
                "role": this.roleId,
                "user": this.userId
            };

            this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
        },
        ready: function () {
            var entityType = DataHelper.getParamValue('type');

            if(entityType) {
              var itemContext = {
                  'type': entityType
              };

              this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);
            }
        },
        properties: {
          config: {
            type: Object,
            value: function () { return {}; },
            computed: "getConfig(name)"
          }
        },
        behaviors: [
          RUFBehaviors.UIBehavior,
          RUFBehaviors.BusinessFunctionBehavior,
          RUFBehaviors.AppContextBehavior
        ],
        _onApplicationConfigReceived: function (e) {
            //console.log('Received configs ', JSON.stringify(e, null, 2));
            this.set('applicationConfig', e.detail);
        },
        _onFirstStepCancelled: function() {
          this._closeBusinessFunction();
        },
        _onLastStepCompleted: function() {
          this._closeBusinessFunction();
        },
        _closeBusinessFunction: function() {
          var viewComponent = ComponentHelper.getCurrentActiveApp();
          var contentView = this.getContentView(viewComponent);
          var manager;
          if(contentView) {
            manager = contentView.manager;
          }
          if(manager) {
            manager.closeView(contentView.name);
          }
        }
      });
    })();
  </script>
</dom-module>