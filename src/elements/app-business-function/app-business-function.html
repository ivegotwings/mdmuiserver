<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-wizard/rock-wizard.html">

<dom-module id="app-business-function">
  <template>
    <style include="bedrock-style-common"></style>
    <rock-layout>
      <div id="stepProviders"></div>
      <liquid-config-aggregate-get id="getAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-business-function"
        context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>

      <rock-titlebar slot="rock-titlebar" icon="pebble-md-icons:UserIcon" main-title="[[config.label]]" non-closable="[[config.nonClosable]]" non-minimizable="[[config.nonMinimizable]]"></rock-titlebar>
      <rock-wizard config="{{wizardConfig}}" shared-data="[[sharedData]]" on-first-step-cancelled="_onFirstStepCancelled" on-next-step="_onNextStep"
        on-cancel-event="_onCancel"></rock-wizard>

    </rock-layout>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'app-business-function',
        attached: function () {
          this._searchTimeStamp = new Date().toLocaleString();
        },
        properties: {
          contextData: {
            type: Object,
            value: function() {
              return {};
            }
          },
          getConfig: {
            type: Function
          },
          config: {
            type: Object,
            value: function () { return {}; },
            computed: "getConfig(name)"
          }
        },
        behaviors: [
          RUFBehaviors.AppBehavior,
          RUFBehaviors.BusinessFunctionBehavior
        ],
        created: function () {
          var entityType = DataHelper.getParamValue('type');

          if (entityType) {
            var itemContext = {
              'type': entityType
            };

            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
          }
          
          var userContext = {
            "role": this.roleId,
            "user": this.userId,
            "tenant": this.tenantId
          };

          this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];
        },

         /**
         * Function to display the left nav info
         */ 
          getAppCurrentStatus: function (customArgs) { 
            var titleStr = "";
            if(customArgs.title) {
              titleStr = customArgs.title;
            }   
            var queryParams = "";              
            if(customArgs.queryParams && customArgs.queryParams.type){
              titleStr = titleStr + " : " + customArgs.queryParams.type;
              queryParams = customArgs.queryParams;
            }            
            return {
                title:titleStr,
                subTitle: "Last Opened",
                subTitleValue: this._searchTimeStamp ? this._searchTimeStamp : new Date().toLocaleString(),
                queryParams: queryParams
            };
        },
        
        _onApplicationConfigReceived: function (e) {
          // this.logInfo("ConfigReceived","response",JSON.stringify(e, null, 2));
          this.set('applicationConfig', e.detail);
        },
        _onFirstStepCancelled: function () {
          ComponentHelper.closeCurrentApp();
        },
        _onCancel: function () {
          ComponentHelper.closeCurrentApp();
        },
        _onNextStep: function (e, detail) {
          if (detail) {
            if (detail.dataRoute && detail.dataRoute != "") {
              ComponentHelper.closeCurrentApp();
              var mainApp = document.querySelector("main-app");
              if (!detail.queryParams) {
                detail.queryParams = {};
              }
              ComponentHelper.setQueryParamsWithoutEncode(detail.queryParams);
              mainApp.changePageRoutePath(detail.dataRoute, detail.action);
            } else {
              if (detail.closeBusinessFunction) {
                ComponentHelper.closeCurrentApp(detail.action);
              }
            }
          }
        }

      });
    })();
  </script>
</dom-module>