<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-lov-datasource-behavior/bedrock-lov-datasource-behavior.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<dom-module id="attribute-model-datasource">
    <template>
        
        <liquid-entity-model-get id="liquidModelInitSearch" operation="initiatesearch" request-data="{{request}}" on-error="_onError"
            last-response="{{_initSearchResponse}}"></liquid-entity-model-get>
        <liquid-entity-model-get id="liquidModelGetResult" operation="getsearchresultdetail" request-data="{{request}}" on-error="_onError"
            request-id="[[_initSearchResponse.content.requestId]]" last-response="{{getEntitySearchResultsResponse}}"></liquid-entity-model-get>
    </template>
    <script>
        Polymer({
            is: 'attribute-model-datasource',
            properties: {
                mode: {
                    type: String,
                    value: ""
                },
                _liquidInitSearchElement: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _liquidGetSearchElement: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _isResponseAttached: {
                    type: Boolean,
                    value: false
                },

                _isRequestInitiated: {
                    type: Boolean,
                    value: false
                }
            },

            behaviors: [
                RUFBehaviors.LOVDataSourceBehavior
            ],

            ready: function () {
                this._liquidInitSearchElement = this.$$('#liquidModelInitSearch');
                this._liquidGetSearchElement = this.$$('#liquidModelGetResult');

                this.dataSource = this._dataSource.bind(this);
            },

            _dataSource: function (data, success, error) {

                if (_.isEmpty(this.request)) {
                    return;
                }

                // Bind Reponse
                if (!this._isResponseAttached) {
                    this._liquidInitSearchElement.addEventListener('response', this._onInitSearchResponse.bind(this));
                    this._liquidGetSearchElement.addEventListener('response', this._onGetSearchResponse.bind(this, success, error));

                    this._error = error;
                    this._isResponseAttached = true;
                }

                // Filter
                var keywordsCriterion;
                if (this.keywordsCriterionBuilder && this.keywordsCriterionBuilder instanceof Function) {
                    keywordsCriterion = this.keywordsCriterionBuilder(data.filter);
                }

                if (keywordsCriterion) {
                    this.set("request.params.query.filters.keywordsCriterion", keywordsCriterion);
                } else if (this.request.params.query.filters && typeof (this.request.params.query.filters.keywordsCriterion !== undefined)) {
                    delete this.request.params.query.filters.keywordsCriterion;
                }

                if (this.checkIfRequestChanged()) {
                    this._isRequestInitiated = false;
                    data.page = 1;
                }

                // Set Range
                var from = data.page > 0 ? (data.page - 1) * data.pageSize : 0;
                var to = data.page > 0 ? data.page * data.pageSize - 1 : 0;

                var options = {
                    "from": from,
                    "to": to
                };
                this.set("request.params.options", options);

                if (!this._isRequestInitiated) {
                    this._liquidInitSearchElement.generateRequest();

                } else {
                    this._liquidGetSearchElement.generateRequest();
                }
            },
            reTriggerRequest: function () {
                if (!this._isRequestInitiated) {
                    this._liquidInitSearchElement.generateRequest();
                } else {
                    this._liquidGetSearchElement.generateRequest();
                }
            },
            _onInitSearchResponse: function (e) {
                this._lastRequest = DataHelper.cloneObject(this.request);
                this._liquidGetSearchElement.generateRequest();
                this._isRequestInitiated = true;
            },
            _onGetSearchResponse: function (success, error) {
                if (event && event.detail && event.detail.response) {
                    if (typeof (this.dataFormatter) == 'function') {
                        if (event.detail.response.status === "success") {
                            success(this.dataFormatter(event.detail.response));
                        } else {
                            error();
                        }
                    }
                }
            },
            _onError: function (e) {
                console.log('error occured while loading attribute models ', JSON.stringify(e));
            }
        });
    </script>
</dom-module>