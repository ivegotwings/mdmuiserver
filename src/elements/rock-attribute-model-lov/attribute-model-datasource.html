<link rel="import" href="../../../bower_components/polymer/polymer.html">


<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<dom-module id="attribute-model-datasource">
    <template>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" on-entity-model-composite-get-response="_onGetResponse"
            on-error="_onError" exclude-in-progress>
        </liquid-entity-model-composite-get>
        <liquid-entity-model-get id="liquidModelInitiSearch" operation="initiatesearch" on-response="_onInitiateSearchResponse" on-error="_onError"
            last-response="{{_initSearchResponse}}"></liquid-entity-model-get>
        <liquid-entity-model-get id="liquidModelGetResult" operation="getsearchresultdetail" on-response="_onSearchResultResponse"
            on-error="_onError" request-id="[[_initSearchResponse.content.requestId]]"></liquid-entity-model-get>
    </template>
    <script>
        Polymer({
            is: 'attribute-model-datasource',
            properties: {
                mode: {
                    type: String,
                    value: ""
                },
                request: {
                    type: Object,
                    observer: 'getData',
                    value: function () {
                        return {};
                    }
                }

            },

            observers: [
                'getData(request, mode)'
            ],

            getData: function (request, mode) {
                var liquidGetByIdsElement = Polymer.dom(this).node.$$("liquid-entity-model-composite-get");
                var liquidInitSearchElement = Polymer.dom(this).node.$$("#liquidModelInitiSearch");

                if (_.isEmpty(this.request) || _.isEmpty(this.mode)) {
                    return;
                }

                if (this.mode.toLowerCase() == 'self') {
                    if (liquidGetByIdsElement) {
                        liquidGetByIdsElement.requestData = this.request;
                        liquidGetByIdsElement.generateRequest();
                    }
                } else if (this.mode.toLowerCase() == 'all') {
                    if (liquidInitSearchElement) {
                        liquidInitSearchElement.requestData = this.request;
                        liquidInitSearchElement.generateRequest();
                    }
                }
            },

            reTriggerRequest: function () {
                this.getData();
            },

            _onInitiateSearchResponse: function (e) {
                var liquidGetResultElement = Polymer.dom(this).node.$$("#liquidModelGetResult");
                if (liquidGetResultElement) {
                    liquidGetResultElement.requestData = this.request;
                    liquidGetResultElement.generateRequest();
                }
            },
            _onGetResponse: function (e) {
                var response = e.detail.response;
                if (typeof (this.dataFormatter) == 'function') {
                    if (response && response.status === "success") {
                        this.dataFormatter(response);
                    }
                }
            },
            _onSearchResultResponse: function (e) {
                var response = e.detail.response;
                if (typeof (this.dataFormatter) == 'function') {
                    if (response && response.status === "success") {
                        this.dataFormatter(response);
                    }
                }
            },
            _onError: function (e) {
                console.log('error occured while loading attribute models ', JSON.stringify(e));
            },
            _isSelf: function (mode) {
                return mode == "self";
            }
        });
    </script>
</dom-module>