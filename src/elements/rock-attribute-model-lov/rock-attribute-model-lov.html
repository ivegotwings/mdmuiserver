<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">

<!--
`rock-attribute-model-lov` Represents a component that renders the list of values control for the attribute models.
@demo demo/index.html 
-->

<dom-module id="rock-attribute-model-lov">
    <template>
        <attribute-model-datasource id="attributeModelDataSource" request="[[requestData]]" data-source$="{{dataSource}}"
            data-formatter$="{{_dataFormatter}}" keywords-criterion-builder="{{_keywordsCriterionBuilder}}" mode="lov">
        </attribute-model-datasource>
        <pebble-lov id="attributeModelLov" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]" show-color="[[showColor]]"
            no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" data-source$="{{dataSource}}" items="[[items]]"
            selected-item="{{selectedItem}}" selected-items="{{selectedItems}}">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-attribute-model-lov',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _currentIndex: {
                    type: Number,
                    value: function () {
                        return {};
                    }
                },
                _currentItems: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _lovColumnNameValueCollection: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /*
                 * Indicates an identifier for the item.
                 */
                idField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the title for the item.
                 */
                titlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the sub-title for the item.
                 */
                subTitlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates an image for the item.
                 */
                imageField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the color for the item.
                 */
                colorField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the value for the item.
                 */
                valueField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the "type" for the item.
                 */
                typeField: {
                    type: Array,
                    value: []
                },
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                mode: {
                    type: String,
                    value: ""
                },
                _keywordsCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _attributesCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],

            listeners: {
                'attributeModelLov.selection-changed': '_onLovSelectionChanged'
            },

          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._attributesCriterionBuilder = this._prepareAttributesCriteria.bind(this);
                this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);
                this._dataFormatter = this._getAttributeFormattedData.bind(this);
                this._prepareAttributeMaps();

                this.logInfo("AttributeModelReady","id",this.idField,"requestData",JSON.stringify(this.requestData));

                var modelGetRequest = {
                    "params": {
                        "query": {
                            "filters": {
                                "typesCriterion": [
                                    "attributeModel"
                                ]
                            }
                        },
                        "fields": {
                            "ctxTypes": [
                                "properties"
                            ],
                            "attributes":[""]
                        }
                    }
                };
                this.requestData = undefined;
                this.requestData = modelGetRequest;
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */

            reTriggerRequest: function () {
                this.shadowRoot.querySelector('#attributeModelDataSource').reTriggerRequest();
            },

            _prepareAttributeMaps: function () {
                this._lovColumnNameValueCollection.id = this.idField;
                this._lovColumnNameValueCollection.title = this.titlePattern;
                this._lovColumnNameValueCollection.subtitle = this.subTitlePattern;
                this._lovColumnNameValueCollection.image = this.imageField;
                this._lovColumnNameValueCollection.color = this.colorField;
                this._lovColumnNameValueCollection.value = this.valueField;
            },

            _getAttributeFormattedData: function (data) {
                if (data && data.content && !_.isEmpty(data.content.entityModels)) {
                    var items = [];
                    var attributeModels = data.content.entityModels;
                    for (var i = 0; i < attributeModels.length; i++) {
                        var attributeModel = attributeModels[i];
                        var item = {
                            "id": attributeModel.name,
                            "value": attributeModel.name,
                            "title": attributeModel.properties.externalName
                        };
                        items.push(item);
                    }
                    return items;
                }
            },
            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = "*" + searchText + "*";
                    keywordsCriterion.operator = "_OR";

                    return keywordsCriterion;
                }
            },
            _prepareAttributesCriteria: function (searchText) {
                if (searchText) {
                    var attributesCriterion = [];
                    var searchKey = {};
                    var searchValue = {};
                    searchValue.eq = searchText ? searchText : '';

                    // Todo.. When Pattern comes into picture this one is effected
                    searchKey[this.titlePattern] = searchValue;
                    attributesCriterion.push(searchKey);
                    return attributesCriterion;
                }
            },
            _onLovSelectionChanged: function (event) {
                var eventDetail = {
                    data: event.detail.item
                }

                this.fireBedrockEvent("attribute-model-lov-selection-changed", eventDetail);
            },

        });
    </script>
</dom-module>