<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">

<!--
`rock-attribute-model-lov` Represents a component that renders the list of values control for the attribute models.
@demo demo/index.html 
-->

<dom-module id="rock-attribute-model-lov">
    <template>
        <liquid-entity-model-get id="getReferenceModels" operation="getbyids" request-data=[[_getRefModelsRequest]] on-response="_onRefModelsReceived"
            on-error="_onRefModelsGetFailed"></liquid-entity-model-get>
        <attribute-model-datasource id="attributeModelDataSource" mode="[[mode]]" request="[[requestData]]" r-data-source="{{rDataSource}}"
            r-data-formatter="{{_dataFormatter}}" keywords-criterion-builder="{{_keywordsCriterionBuilder}}" schema="lov">
        </attribute-model-datasource>
        <pebble-lov id="attributeModelLov" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]" show-color="[[showColor]]"
            no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" r-data-source="{{rDataSource}}" items="[[items]]"
            selected-item="{{selectedItem}}" selected-items="{{selectedItems}}" on-selection-changed="_onLovSelectionChanged" deleted-items-count="[[_getDeletedItemsCount(deletedItems)]]">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-attribute-model-lov',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _currentIndex: {
                    type: Number,
                    value: function () {
                        return {};
                    }
                },
                _currentItems: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _lovColumnNameValueCollection: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /*
                 * Indicates an identifier for the item.
                 */
                idField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the title for the item.
                 */
                titlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the sub-title for the item.
                 */
                subTitlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates an image for the item.
                 */
                imageField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the color for the item.
                 */
                colorField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the value for the item.
                 */
                valueField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the "type" for the item.
                 */
                typeField: {
                    type: Array,
                    value: []
                },
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                mode: {
                    type: String,
                    value: ""
                },
                _keywordsCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _attributesCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                rDataSource: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                _getRefModelsRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _selectedItem: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                showNestedChildAttributes:{
                    type: Boolean,
                    value: false,
                },
                showNestedAttributes:{
                    type: Boolean,
                    value: true,
                },
                excludeNestedAttributes: {
                    type: Boolean,
                    value: false
                },
                deletedItems: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],

            observers: [
                '_getAttributeModels(contextData, sortDetails)'
            ],

          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._attributesCriterionBuilder = this._prepareAttributesCriteria.bind(this);
                this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);
                this._prepareAttributeMaps();

                //this.logInfo("AttributeModelReady","id",this.idField,"requestData",JSON.stringify(this.requestData));

                if(!_.isEmpty(this.mode)) {
                    if(this.mode === "all") {
                        this._dataFormatter = this._getAttributeFormattedData.bind(this);
                    } else {
                        this._dataFormatter = this._getAttributeFormattedDataForCompositeModel.bind(this);
                    }
                }

            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */

            reTriggerRequest: function () {
                this.shadowRoot.querySelector('#attributeModelDataSource').reTriggerRequest();
            },

            _prepareAttributeMaps: function () {
                this._lovColumnNameValueCollection.id = this.idField;
                this._lovColumnNameValueCollection.title = this.titlePattern;
                this._lovColumnNameValueCollection.subtitle = this.subTitlePattern;
                this._lovColumnNameValueCollection.image = this.imageField;
                this._lovColumnNameValueCollection.color = this.colorField;
                this._lovColumnNameValueCollection.value = this.valueField;
            },

            _getAttributeModels: function (contextData) {
                if (!_.isEmpty(this.contextData)) {
                    if(this.mode === "all") {
                        var modelGetRequest = {
                            "params": {
                                "query": {
                                    "filters": {
                                        "typesCriterion": [
                                            "attributeModel"
                                        ]
                                    }
                                },
                                "fields": {
                                    "ctxTypes": [
                                        "properties"
                                    ],
                                    "attributes":[""]
                                }
                            }
                        };
                        this.requestData = undefined;
                        this.requestData = modelGetRequest;
                    } else {
                        var contextData = DataHelper.cloneObject(this.contextData);
                        if (this.contextData.ItemContexts) {

                            var index = 0;
                            for(var i=0; i < contextData.ItemContexts.length; i++){
                                if(contextData.ItemContexts[i].type){
                                    index++;
                                }
                            }
                            this._currentIndex = index;
                            this._currentItems = [];
                            this._notFoundEntityTypes = [];
                        }

                        if (contextData && contextData.ItemContexts) {
                            for (var i = 0; i < this.contextData.ItemContexts.length; i++) {

                                contextData.ItemContexts = [this.contextData.ItemContexts[i]];
                                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
                                    contextData);
                                if (compositeModelGetRequest && compositeModelGetRequest.params) {
                                    compositeModelGetRequest.params.fields.attributes = ["_ALL"];
                                }
                                this.set('requestData', compositeModelGetRequest);
                                this.reTriggerRequest();
                            }
                        }
                    }
                }
            },

            _getAttributeFormattedData: function (data) {
                if (data && data.content && !_.isEmpty(data.content.entityModels)) {
                    var items = [];
                    var attributeModels = this.excludeNestedAttributes ? this._excludeNestedAttributeModels(data.content.entityModels) : data.content.entityModels;
                    for (var i = 0; i < attributeModels.length; i++) {
                        var attributeModel = attributeModels[i];
                        var item = {
                            "id": attributeModel.name,
                            "value": attributeModel.name,
                            "title": attributeModel.properties.externalName
                        };
                        items.push(item);
                    }
                    return items;
                }
            },

            _getAttributeFormattedDataForCompositeModel: function (data, requestData) {
                if (data && data.content && data.content.entityModels) {
                    var atributeModels = DataTransformHelper.transformAttributeModels(data.content.entityModels[0], this.contextData);
                    if (atributeModels) {
                        if (this._currentIndex == 1) {
                            this._currentItems = [];
                        }
                        this.push('_currentItems', DataTransformHelper.transformAtributeModelsToLovSchema(atributeModels, this._lovColumnNameValueCollection));

                        if ((!atributeModels || _.isEmpty(atributeModels)) && requestData) {
                            this._notFoundEntityTypes.push(requestData.params.query.name);
                        }
                    }
                
                    if (this._currentItems.length == this._currentIndex) {
                        var currentItems = this._currentItems;
                        currentItems = currentItems.reduce(function (array1, array2) {
                            return array1.concat(array2);
                        });
                        var filteredCurrentItems = [];
                        currentItems = _.unique(currentItems);
                        for (var i = 0; i < currentItems.length; ++i) {
                            var currentItem = currentItems[i];
                            if (currentItem.dataType == "nested" && (this.showNestedChildAttributes || this.showNestedAttributes)) {
                                var nestedAttributeItems = [];
                                nestedAttributeItems = DataHelper.getNestedAttributeItems(currentItem,this.showNestedAttributes,this.showNestedChildAttributes);
                                if(nestedAttributeItems.length > 0){
                                    filteredCurrentItems = filteredCurrentItems.concat(nestedAttributeItems)
                                }
                            }else if(currentItem.dataType != "nested" ||  (currentItem.dataType == "nested" && this.showNestedAttributes)){
                                filteredCurrentItems.push(currentItem);
                            }
                        }
                        var property, dataType, sortType, multiSortProperties;
                        if(!_.isEmpty(this.sortDetails)) {
                            property = this.sortDetails.property;
                            dataType = this.sortDetails.dataType;
                            sortType = this.sortDetails.sortType;
                        }

                        //Default sort
                        if(!property) {
                            property = "displaySequence";
                            dataType = "integer";
                        }

                        //multi sort
                        if(property != "title") {
                            multiSortProperties = [{
                                "name": "title",
                                "dataType": "string"
                            }];
                        }
                        this.items = DataHelper.sort(filteredCurrentItems, property, dataType, sortType, multiSortProperties);

                        if (this._notFoundEntityTypes && this._notFoundEntityTypes.length) {
                            var messageContent = this._notFoundEntityTypes.join(", ");
                            this.showErrorToast("Attribute models not found for entity type(s) " + messageContent + ". Please contact administrator.");
                        }
                    }
                }
            },

            _excludeNestedAttributeModels: function(attributeModels) {
                var models = [];
                attributeModels.forEach(function(attributeModel) {
                    if(!attributeModel.properties || attributeModel.properties.dataType != "nested") {
                        models.push(attributeModel);
                    } else {
                        this.deletedItems.push(attributeModel);
                        //Notify deleted items to LOV
                        var temp = this.deletedItems;
                        this.deletedItems = [];
                        this.deletedItems = temp;
                    }
                }, this);

                return models;
            },

            _getDeletedItemsCount: function() {
                return this.deletedItems ? this.deletedItems.length : 0;
            },

            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = "*" + searchText + "*";
                    keywordsCriterion.operator = "_OR";

                    return keywordsCriterion;
                }
            },
            _prepareAttributesCriteria: function (searchText) {
                if (searchText) {
                    var attributesCriterion = [];
                    var searchKey = {};
                    var searchValue = {};
                    searchValue.eq = searchText ? searchText : '';

                    // Todo.. When Pattern comes into picture this one is effected
                    searchKey[this.titlePattern] = searchValue;
                    attributesCriterion.push(searchKey);
                    return attributesCriterion;
                }
            },
            _onLovSelectionChanged: function (event) {
                let item = event.detail.item;
                this.set("_selectedItem", item);
                
                if(item.isReferenceType) {
                    this._updateRefEntityInfo(item);
                } else {
                    this._fireSelectionChangedEvent(item);
                }
            },

            refresh: function() {
                this._getAttributeModels(this.contextData, this.sortDetails);
            },

            reset: function() {
                var modelLOV = this.shadowRoot.querySelector('#attributeModelLov');
                if(modelLOV) {
                    modelLOV.reset();
                }
            },

            _fireSelectionChangedEvent: function(item) {
                let eventDetail = {
                    data: item
                }

                this.fireBedrockEvent("attribute-model-lov-selection-changed", eventDetail);
            },

            _updateRefEntityInfo: function(model) {
                let refEntityType = DataHelper.getRefEntityType(model);

                if(refEntityType) {
                    let req = DataRequestHelper.createGetManageModelRequest([refEntityType]);

                    this.set("_getRefModelsRequest", req);

                    let refModelsGetLiquid = this.shadowRoot.querySelector("[id=getReferenceModels]");
                    if (refModelsGetLiquid) {
                        refModelsGetLiquid.generateRequest();
                    }
                }
            },

            _onRefModelsReceived: function (e, detail) {
                var referenceModels = {};
                var responseContent = DataHelper.validateAndGetResponseContent(detail.response)
                if (responseContent && !_.isEmpty(responseContent.entityModels)) {
                    var referenceModels = DataTransformHelper.transformEntityModelsToReferenceModels(responseContent.entityModels);

                    if(!_.isEmpty(referenceModels)) {
                        var item = DataHelper.cloneObject(this._selectedItem);
                        DataHelper.updateRefEntityInfo(item, referenceModels);

                        this._fireSelectionChangedEvent(item);
                    }
                }
            },

            _onRefModelsGetFailed: function(e) {
                this.logWarning("ReferenceManageModelGetFail", e);
            },

        });
    </script>
</dom-module>