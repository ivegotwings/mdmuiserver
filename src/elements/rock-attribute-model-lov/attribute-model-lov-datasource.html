<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-datasource-behavior/bedrock-datasource-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<dom-module id="attribute-model-lov-datasource">
    <template>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{request}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse" on-error="_onError" exclude-in-progress>
        </liquid-entity-model-composite-get>
    </template>
    <script>
        Polymer({
            is: 'attribute-model-lov-datasource',
            properties: {
                _liquidElement: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                }
            },

            behaviors: [
                RUFBehaviors.DataSourceBehavior
            ],

            ready: function () {
                this._liquidElement = Polymer.dom(this).node.$$("liquid-entity-model-composite-get[name='compositeAttributeModelGet']");
                this.dataSource = this._dataSource.bind(this);
            },

            _dataSource: function (data, success, error) {

                if (_.isEmpty(this.request)) {
                    return;
                }

                // Bind Reponse
                if (!this._isResponseAttached) {
                    this._error = error;
                    this._liquidElement.addEventListener('entity-model-composite-get-response', this._onGetResponse.bind(
                        this, success, error));
                    this._isResponseAttached = true;
                }

                var keywordsCriterion;
                if (this.keywordsCriterionBuilder && this.keywordsCriterionBuilder instanceof Function) {
                    keywordsCriterion = this.keywordsCriterionBuilder(data.filter);
                }
                if(!this.request.params.query.filters) {
                    this.request.params.query.filters={};
                }
                if (keywordsCriterion) {
                    this.set("request.params.query.filters.keywordsCriterion", keywordsCriterion);
                } else {
                        delete this.request.params.query.filters.keywordsCriterion;
                }


                // Set Range
                var from = data.page > 0 ? (data.page - 1) * data.pageSize : 0;
                var to = data.page > 0 ? data.page * data.pageSize - 1 : 0;

                var options = {
                    "from": from,
                    "to": to
                };
                this.set("request.params.options", options);

                this._liquidElement.generateRequest();

            },

            reTriggerRequest: function(){
                    this._liquidElement.generateRequest();
            },


            _onGetResponse: function (success, error) {
                console.log(event);
                var response=event.detail.response;
                if (typeof (this.dataFormatter) == 'function') {
                    if (response.status === "success") {
                        success(this.dataFormatter(response));
                    } else {
                        error();
                    }
                }
            },

            _onError: function () {
                this._error();
            }
        });
    </script>
</dom-module>