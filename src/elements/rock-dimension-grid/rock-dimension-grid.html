<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">


<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-tree/pebble-tree.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">

<!--
`rock-dimension-grid` Represents a component that is used to view the dimension value of the given attribute.
It is also used to update or add current and future value for that attribute.

It displays dimensions like locale, source, context, and time.
User can select any dimension where locale, source, and context is shown in multiselect LOVs. 
And time is displayed in date time picker control where user can select time range to list the attribute's 
history and future value if added any.

The grid renders the data based on the selected dimensions from left panel.
The user can view the past data but cannot modify it. However the current and future value can be added or updated.

@demo demo/index.html
-->

<dom-module id="rock-dimension-grid">
  <template>
    <style include="pebble-styles-shared">
      #dimensionGridContainer {
        height: 450px;
      }
      
      #dimensionFilters {
        width: 310px;
        float: left;
        height: 100%;
        padding: 10px;
        overflow: auto;
      }
      
      #dimensionGrid {
        width: calc(100% - 320px);
        float: right;
      }
      
      #dimensionGrid rock-grid::shadow #pebbleGridContainer {
        margin: 0;
      }
      
      pebble-lov {
        width: 100%;
        position: static !important;
      }
      
      .action-container {
        text-align: center;
      }
      
      pebble-lov {
        --pebble-lov-height: 125px;
      }
      
      pebble-accordion {
        --accordion-header: {
          height: 30px;
        }
      }
      
      pebble-checkbox {
        margin-top: 3px;
      }
      
      rock-grid {
        --rock-grid-height: 350px;
      }
    </style>
    <div id="dimensionGridContainer">
      <div id="dimensionFilters">
        <template is="dom-repeat" items="[[dimensionConfigs]]" as="configDataItem">
          <pebble-accordion header-text="[[configDataItem.title]]" default-icon="expand-less" open-icon="expand-more">
            <div class="header-content">
              <pebble-checkbox id="[[configDataItem.id]]Chk" on-change="_onSelectAll"></pebble-checkbox>
            </div>
            <!--<pebble-lov id="locale" items="{{locales}}" no-sub-title multi-select show-image on-selection-changed="_onLocaleDimensionChage"></pebble-lov>-->
            <template is="dom-if" if="[[_compareRequestType(configDataItem.dataRequestType, 'entity')]]">
              <rock-entity-lov id="[[configDataItem.id]]" config-data-item-id="[[configDataItem.id]]" id-field="[[configDataItem.dataMappings.id]]"
                title-pattern="[[configDataItem.dataMappings.title]]" type-field="[[configDataItem.dataMappings.type]]" request-data="[[configDataItem.dataRequest]]"
                on-selection-changed="_onDimensionChange" multi-select no-sub-title></rock-entity-lov>
            </template>
            <template is="dom-if" if="[[_compareRequestType(configDataItem.dataRequestType, 'entity-model')]]">
                <rock-entity-model-lov id="[[configDataItem.id]]" config-data-item-id="[[configDataItem.id]]" id-field="[[configDataItem.dataMappings.id]]"
                  title-pattern="[[configDataItem.dataMappings.title]]" type-field="[[configDataItem.dataMappings.type]]" request-data="[[configDataItem.dataRequest]]"
                  on-selection-changed="_onDimensionChange" multi-select no-sub-title></rock-entity-model-lov>
             </template>
          </pebble-accordion>
        </template>
        <!--<pebble-accordion header-text="Context" default-icon="expand-less" open-icon="expand-more">
          <div class="header-content">
            <pebble-checkbox id="contextChk" on-change="_onSelectAll"></pebble-checkbox>
          </div>
          <pebble-lov id="context" items="{{contexts}}" no-sub-title multi-select show-image on-selection-changed="_onContextDimensionChage"></pebble-lov>
        </pebble-accordion>
        <pebble-accordion header-text="Source" default-icon="expand-less" open-icon="expand-more">
          <div class="header-content">
            <pebble-checkbox id="sourceChk" on-change="_onSelectAll"></pebble-checkbox>
          </div>
          <pebble-lov id="source" items="{{sources}}" no-sub-title multi-select show-image on-selection-changed="_onSourceDimensionChage"></pebble-lov>
        </pebble-accordion>
        <pebble-accordion header-text="Time" default-icon="expand-less" open-icon="expand-more">
        </pebble-accordion>-->
      </div>
      <div id="dimensionGrid">
        <pebble-button icon="pebble-md-icons:actions" class="dropdownText dropdownIcon btn dropdown-success pull-right" menu-button
          dropdown-icon button-text="Action" on-click=""></pebble-button>
        <div class="clearfix"></div>
        <rock-grid config="{{getParentAppConfig('rock-dimension-grid', '', 'dimension-gridConfig')}}" page-size="10" attribute-models="{{gridAttributeModel}}"></rock-grid>
      </div>
      <div class="clearfix"></div>
    </div>
    <div class="action-container m-t-10">
      <pebble-button class="btn btn-secondary m-r-10" button-text="Cancel" on-tap="_cancelAction" noink></pebble-button>
      <pebble-button class="btn btn-success" button-text="Save" on-tap="_saveAction" noink></pebble-button>
    </div>
    <liquid-entity-data-get verbose name="attributeGetDataService" operation="getbyids" request-data="{{_request}}" last-response="{{response}}"></liquid-entity-data-get>
    <liquid-entity-data-save name="attributeSaveDataService" operation="update" request-data="{{_saveRequest}}" last-response="{{saveResponse}}"
      on-response="_onSaveResponse"></liquid-entity-data-save>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-dimension-grid',
        properties: {
          /*
           * Indicates an entity identification.
           */
          dataId: {
            type: String,
            notify: true,
            value: ""
          },

          /*
           * Indicates an array of locales for the dimension panel.
           */
          locales: {
            type: Array,
            value: function () {
              return [];
            }
          },

          /*
           * Indicates an array of channels for the dimension panel.
           */
          channels: {
            type: Array,
            value: function () {
              return [];
            }
          },

          /*
           * Indicates an array of sources for the dimension panel.
           */
          sources: {
            type: Array,
            value: function () {
              return [];
            }
          },

          /*
           * Indicates an attribute model object of the given entity identification 
           * for which dimension values are rendered.
           */
          attributeModelObject: {
            type: String,
            value: function () {
              return {};
            }
          },

          /*
           * Indicates current selected locales in dimension grid.
           */
          _selectedLocales: {
            type: Array,
            value: function () {
              return [];
            }
          },

          /*
           * Indicates current selected contexts in dimension grid.
           */
          _selectedChannels: {
            type: Array,
            value: function () {
              return [];
            }
          },

          /*
           * Indicates current selected sources in dimension grid.
           */
          _selectedSources: {
            type: Array,
            value: function () {
              return [];
            }
          },

          /*
           * Indicates request object based on current selected dimension objects.
           */
          _request: {
            type: Object,
            value: function () {
              return {};
            }
          },

          /*
           * Indicates save request object based on current selected dimension objects.
           */
          _saveRequest: {
            type: Object,
            value: function () {
              return {};
            }
          }
        },

        observers: [
          '_onSelectionChange(_selectedLocales, _selectedChannels, _selectedSources)',
          '_entityGet(response)',
          '_initDimensionGrid(dataContext)'
        ],

        behaviors: [
          RUFBehaviors.UIBehavior,
          RUFBehaviors.ComponentContextBehavior
        ],

        _onDimensionChange: function (e) {
          if (e.currentTarget.selectedItems) {
            var selectedItemIds = this._getIdsFromObject(e.currentTarget.selectedItems);

            if (e.currentTarget.id == "locale") {
              var selectedLocales = [];
              this.locales.forEach(function (item) {
                if (selectedItemIds.indexOf(item.id) >= 0) {
                  selectedLocales.push(item);
                }
              }, this);

              this._selectedLocales = undefined;
              this._selectedLocales = selectedLocales;
            } else if (e.currentTarget.id == "channel") {
              var selectedChannels = [];
              this.channels.forEach(function (item) {
                if (selectedItemIds.indexOf(item.id) >= 0) {
                  selectedChannels.push(item);
                }
              }, this);

              this._selectedChannels = undefined;
              this._selectedChannels = selectedChannels;
            } else if (e.currentTarget.id == "source") {
              var selectedSources = [];
              this.sources.forEach(function (item) {
                if (selectedItemIds.indexOf(item.id) >= 0) {
                  selectedSources.push(item);
                }
              }, this);

              this._selectedSources = undefined;
              this._selectedSources = selectedSources;
            }
          }
        },

        _onSelectionChange: function () {
          if (this.dataId) {
            var attributeNames = [];
            var valueContexts = [];
            var contexts = [];

            attributeNames.push(this.attributeModelObject.name);
            if (this._selectedLocales && this._selectedSources) {
              this._selectedSources.forEach(function (sourceItem) {
                this._selectedLocales.forEach(function (localeItem) {
                  valueContexts.push({
                    "source": sourceItem.title,
                    "locale": localeItem.title
                  });
                }, this);
              }, this);
            }

            if (this._selectedChannels) {
              this._selectedChannels.forEach(function (contextItem) {
                contexts.push({
                  "classification": "_ALL",
                  "list": contextItem.title
                });
              }, this);
            }

            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": valueContexts,
                  "filters": {
                    "attributesCriterion": [],
                    "typesCriterion": ["nart"]
                  },
                  "id": this.dataId
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": attributeNames
                }
              }
            };

            this._request = req;

            var liquidGet = Polymer.dom(this).node.$$('liquid-entity-data-get');

            if (liquidGet && valueContexts.length > 0 && contexts.length > 0) {
              liquidGet.generateRequest();
            }
          }
        },

        _onSelectAll: function (e) {
          if (e.currentTarget.id == 'localeChk') {
            var localeLov = Polymer.dom(this).node.$$('rock-entity-model-lov[id="locale"]');
            localeLov.selectedItem = undefined;
            this._selectedLocales = undefined;
            if (e.currentTarget.checked) {
              localeLov.selectedItems = this.locales;
              this._selectedLocales = this.locales;
            } else {
              localeLov.selectedItems = [];
              this._selectedLocales = [];
            }
          } else if (e.currentTarget.id == 'sourceChk') {
            var sourceLov = Polymer.dom(this).node.$$('rock-entity-model-lov[id="source"]');
            sourceLov.selectedItem = undefined;
            this._selectedSources = undefined;
            if (e.currentTarget.checked) {
              sourceLov.selectedItems = this.sources;
              this._selectedSources = this.sources;
            } else {
              sourceLov.selectedItems = [];
              this._selectedSources = [];
            }
          } else if (e.currentTarget.id == 'contextChk') {
            var contextLov = Polymer.dom(this).node.$$('rock-entity-lov[id="channel"]');
            contextLov.selectedItem = undefined;
            this._selectedChannels = undefined;
            if (e.currentTarget.checked) {
              contextLov.selectedItems = this.channels;
              this._selectedChannels = this.channels;
            } else {
              contextLov.selectedItems = [];
              this._selectedChannels = [];
            }
          }
        },

        _saveAction: function (e) {
          var attributesJSON = {};
          var grid = Polymer.dom(this).node.$$('rock-grid');

          if (grid) {
            var data = grid.data;

            var entityData = {};
            if (this.response && this.response.content && this.response.content.entities) {
              entityData = DataHelper.cloneObject(this.response.content.entities);
            }

            if (entityData) {

              data.forEach(function (item) {

                if (attributesJSON[item.Context] == undefined) {
                  attributesJSON[item.Context] = {};
                  attributesJSON[item.Context][this.attributeModelObject.name] = {};
                  attributesJSON[item.Context][this.attributeModelObject.name].values = [];
                }

                if (attributesJSON[item.Context][this.attributeModelObject.name]) {
                  attributesJSON[item.Context][this.attributeModelObject.name].values.push({
                    "value": item.Value,
                    "source": item.Source,
                    "locale": item.Locale
                  })
                }
              }, this);

              if (this.dataId == entityData[0].id) {
                var contextKeys = Object.keys(entityData[0].data.contexts);
                entityData[0].data.contexts.forEach(function (item) {
                  if (attributesJSON[item.context.list]) {
                    item.attributes = attributesJSON[item.context.list];
                  }
                }, this);
              }
              //set requestObject for save liquid
              this._saveRequest = {
                "entities": entityData
              };

              var liquidSave = this.$$("[name=attributeSaveDataService]");
              if (liquidSave) {
                liquidSave.generateRequest();
              }
            }
          }
        },

        _cancelAction: function (e) {
          var dimGrid = Polymer.dom(this).node.$$('rock-grid');
          var pebbleDialog = this._getParentPebbleDialog(Polymer.dom(this).node.parentElement);

          if (dimGrid) {
            dimGrid.changeToReadMode();
          }

          if (pebbleDialog) {
            pebbleDialog._close();
          }
          Polymer.dom(this).node.parentElement.removeChild(this);
        },

        _getParentPebbleDialog: function (element) {
          if (element) {
            if (element.is == "pebble-dialog") {
              return element;
            } else {
              return this._getParentPebbleDialog(element.parentNode);
            }
          }
          return undefined;
        },

        _onSaveResponse: function () {
          var mainApp = document.querySelector('#app');
          mainApp.toastText = this.saveResponse.content.msg;
          var toastElement = mainApp.$$("#pebbleAppToast");
          toastElement.toastType = "success";
          toastElement.heading = "Success";
          toastElement.autoClose = true;

          toastElement.show();
          this._cancelAction();
        },

        _entityGet: function () {
          var dimGrid = Polymer.dom(this).node.$$('rock-grid');
          var data = [];

          if (this.response && this.response.content && this.response.content.entities) {
            //var clonedData = DataHelper.cloneObject(this.response.content.entities);

            var entity = this.response.content.entities[0];
            if (entity && entity.data) {
              var currContexts = entity.data.contexts;
              var selfAttributes = entity.data.attributes;

              if (selfAttributes) {
                var values = attributes[this.attributeModelObject.name].values;
                if (values) {
                  values.forEach(function (valueItem) {
                    var record = {};
                    record.Value = valueItem.value;
                    record.Locale = valueItem.locale;
                    record.Source = valueItem.source;
                    record.Context = "";
                    data.push(record);
                  }, this);
                }
              }

              if (currContexts) {
                currContexts.forEach(function (item) {

                  var attributes = item.attributes;
                  //var clonedAttributes = clonedData[this.dataId].data.contexts[item].attributes;

                  if (attributes) {
                    var values = attributes[this.attributeModelObject.name].values;
                    if (values) {
                      values.forEach(function (valueItem) {
                        var record = {};
                        record.Value = valueItem.value;
                        record.Locale = valueItem.locale;
                        record.Source = valueItem.source;
                        record.Context = item.context.list;
                        data.push(record);
                      }, this);
                    }
                  }
                }, this);
              }

              // this.gridAttributeModel = undefined;
              // this.gridAttributeModel = this._getDummyAttributeModels();
            }

            if (data) {
              var grid = Polymer.dom(this).node.$$('rock-grid');
              grid.data = data;
              if (grid._getIronDataTable()) {
                grid._getIronDataTable()._sizeChanged(data.length, 0);
                grid.reRenderGrid();
              }
            }
          }
        },

        _initDimensionGrid: function () {
          if (!_.isEmpty(this.contextData)) {
            // var selectedLocales = [];
            // var selectedSources = [];
            // var selectedChannels = [];

            // if (this._selectedLocales) {
            //   this.locales.forEach(function (item) {
            //     this.dataContext.selectedLocales.forEach(function (selectedItem) {
            //       if (item.title == selectedItem) {
            //         selectedLocales.push(item);
            //       }
            //     }, this);
            //   }, this);
            // }
            // if (this._selectedChannels) {
            //   this.contexts.forEach(function (item) {
            //     this.dataContext.selectedContexts.forEach(function (selectedItem) {
            //       if (item.title == selectedItem) {
            //         selectedContexts.push(item);
            //       }
            //     }, this);
            //   }, this);
            // }
            // if (this._selectedSources) {
            //   this.sources.forEach(function (item) {
            //     this.dataContext.selectedSources.forEach(function (selectedItem) {
            //       if (item.title == selectedItem) {
            //         selectedSources.push(item);
            //       }
            //     }, this);
            //   }, this);
            // }

            // this._selectedLocales = selectedLocales;
            // this._selectedChannels = selectedChannels;
            // this._selectedSources = selectedSources;

            // var localeLov = Polymer.dom(this).node.$$("rock-entity-lov[id='locale']");
            // var sourceLov = Polymer.dom(this).node.$$("rock-entity-lov[id='source']");
            // var channelLov = Polymer.dom(this).node.$$("rock-entity-lov[id='channel']");

            // localeLov.activate();
            // sourceLov.activate();
            // channelLov.activate();

            // localeLov.selectedItems = this._selectedLocales;
            // sourceLov.selectedItems = this._selectedSources;
            // channelLov.selectedItems = this._selectedChannels;
          }
        },

        _getIdsFromObject: function (arrayObject) {
          var ids = [];
          if (arrayObject) {
            arrayObject.forEach(function (item) {
              ids.push(item.id);
            }, this);
          }
          return ids;
        },

        _compareRequestType: function (dataRequestType, entityTypeInfo) {
            return dataRequestType === entityTypeInfo;
        }
      });
    })();
  </script>
</dom-module>