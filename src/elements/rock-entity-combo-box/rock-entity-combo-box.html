<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../pebble-combo-box/pebble-combo-box.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../rock-entity-lov/entity-lov-datasource.html">

<!--
`rock-entity-combo-box` component is used to render entities in lov, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-combo-box">
    <template>
        <liquid-entity-data-get id="liquidLovSelectedValueGet" operation="getbyids" on-response="_onLovSelectedValueGetResponse"></liquid-entity-data-get>
        <entity-lov-datasource id="entityLovDataSource" request="[[requestData]]" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
            keywords-criterion-builder="{{_keywordsCriterionBuilder}}">
        </entity-lov-datasource>
        <pebble-combo-box id="comboBox" label=[[label]] page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]"
            show-color="[[showColor]]" no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" is-readonly=[[isReadonly]]
            data-source="{{dataSource}}" selected-items="{{selectedItems}}" selected-item="{{selectedItem}}" on-selection-changed="_onSelectionChanged">
        </pebble-combo-box>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-combo-box',
            properties: {
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                contextData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                /**
                 * Specifies whether or not to generate console logs.
                 */
                verbose: {
                    type: Boolean,
                    value: false
                },
                /*
                 * Indicates the attribute of an entity which will be used as id for the item
                 */
                idField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as title for the item
                 */
                titlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as subtitle for the item
                 */
                subTitlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as image for the item
                 */
                imageField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as color for the item
                 */
                colorField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as value for the item
                 */
                valueField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as type for the item
                 */
                typeField: {
                    type: Array,
                    value: []
                },
               /**
                * Indicates is-readonly or not
                */
                isReadonly: {
                    type: Boolean,
                    value: false
                },

                _lovColumnMap: {
                    type: Object,
                    value: function () {
                        return {
                            "id": "",
                            "title": "",
                            "subtitle": "",
                            "image": "",
                            "color": "",
                            "value": "",
                            "type": [],
                        };
                    }
                },

                _attributesCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _keywordsCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _isSelectionChanged: {
                    type: Boolean,
                    value: false
                },
                 /*
                 * Indicates the attribute of an entity which will be used for sorting the items
                 */
                _sortField: {
                    type: String,
                    value: "" 
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],

            observers: [
                '_prepareAttributes(idField, titlePattern, subTitlePattern, imageField, colorField, valueField, typeField, selectedId, selectedIds)',
            ],

            ready: function () {
                this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);
                this._dataFormatter = this._getAttributeFormattedData.bind(this);
            },

            _prepareAttributes: function (idField, titlePattern, subTitlePattern, imageField, colorField, valueField, selectedId, selectedIds) {                
                if(this._isSelectionChanged) {
                    this._isSelectionChanged = false;
                    return;
                }

                if(!this._lovColumnMap) {
                    this._lovColumnMap = {};
                }

                var defaultAttributes = this._attributes;
                this._attributes = [];
                var attributes = []; // Attributes which will be part of Request Object

                if (typeof (this.idField) !== 'undefined' && this.idField !== "") {
                    var idField = DataHelper.readAttributeFromPath(this.idField);
                    attributes.push(idField);
                    this._lovColumnMap.id = this.idField;
                }

                if (typeof (this.titlePattern) !== 'undefined' && this.titlePattern !== "") {
                    if (!attributes.includes(this.titlePattern)) {
                        var titleFields = DataHelper.getAttributesBetweenCurlies(this.titlePattern);
                        if(titleFields && titleFields instanceof Array) {
                            attributes.push(...titleFields);
                            this._lovColumnMap.title = this.titlePattern;
                            this._sortField = titleFields.length > 0 ? titleFields[0] : "";
                        }
                    }
                }

                if (typeof (this.subTitlePattern) !== 'undefined' && this.subTitlePattern !== "") {
                    if (!attributes.includes(this.subTitlePattern)) {
                        var subtitleFields = DataHelper.getAttributesBetweenCurlies(this.subTitlePattern);
                        if(subtitleFields && subtitleFields instanceof Array) {
                            attributes.push(...subtitleFields);
                            this._lovColumnMap.subtitle = this.subTitlePattern;
                        }
                    }
                }

                if (typeof (this.imageField) !== 'undefined' && this.imageField !== "") {
                    if (!attributes.includes(this.imageField)) {
                        var imageField = DataHelper.readAttributeFromPath(this.imageField);
                        attributes.push(imageField);
                        this._lovColumnMap.imageField = this.imageField;
                    }
                }

                if (typeof (this.colorField) !== 'undefined' && this.colorField !== "") {
                    if (!attributes.includes(this.colorField)) {
                        var colorField = DataHelper.readAttributeFromPath(this.colorField);
                        attributes.push(colorField);
                        this._lovColumnMap.colorField = this.colorField;
                    }
                }

                if (typeof (this.valueField) == 'undefined' && this.valueField !== "") {
                    if (!attributes.includes(this.valueField)) {
                        var valueField = DataHelper.readAttributeFromPath(this.valueField);
                        attributes.push(valueField);
                        this._lovColumnMap.valueField = this.valueField;
                    }
                }

                if (attributes.length == 0) {
                    this._attributes = defaultAttributes;
                } else {
                    if(!this.requestData || !this.requestData.params){
                        return;
                    }
                    // Todo.. This will not work in a scenario where request object is not initialized

                    if (typeof (this.requestData.params.fields) === "undefined") {
                        this.set('requestData.params.fields', {});
                    }
                    this.set('requestData.params.fields.attributes', attributes);
                }

                if(this.multiSelect) {
                    var _selectedItems = [];
                    for (var i = 0; i < this.selectedIds.length; i++) {
                        var selId = this.selectedIds[i];
                        _selectedItems.push({'id': selId, 'title': selId}); 
                    }
                    this.set('selectedItems', _selectedItems);
                }
                else {
                    if(this.selectedId) {
                        this.set('selectedItem', {'id': this.selectedId, 'title': this.selectedId});
                    }
                }
                
                this._initiateSelectedIdGetRequest();

                if(!DataHelper.isEmptyObject(this._sortField) && this._sortField !== "name") {
                    var sortAttributes = [];

                    var sortAttribute = {};
                    sortAttribute[this._sortField] = "_ASCE";
                    sortAttribute["sortType"] = "_STRING"; // How to determine this?
                    sortAttributes.push(sortAttribute);
                    
                    if (DataHelper.isEmptyObject(this.requestData.params.sort)) {
                        this.set('requestData.params.sort', {});
                    }
                    this.set('requestData.params.sort.attributes', sortAttributes);
                }
            },

            _onSelectionChanged: function(e) {
                var items = e.detail.items;
                var selectedIds = [];
                if (items) {
                    this._isSelectionChanged = true;

                    for(var i = 0; i < items.length; i++) {
                        selectedIds.push(items[i].id);
                    }

                    if(selectedIds && selectedIds.length) {
                        if(this.multiSelect) {
                            this.set('selectedIds', selectedIds);
                        }
                        else {
                            this.set('selectedId', selectedIds[0]);
                        }
                    } else {
                        this.set('selectedId', '');
                        this.set('selectedIds', []);
                    }
                }
            },
            _initiateSelectedIdGetRequest: function() {
                var selIds = this.selectedIds || [];
                if(this.selectedId) {
                    selIds.push(this.selectedId);
                }

                //console.log('selected ids', selIds);

                if(!_.isEmpty(this.requestData)) {
                    var req = DataHelper.cloneObject(this.requestData);
                    //console.log(req);
                    var refEntityIds = [];
                    var refType = req.params.query.filters.typesCriterion[0];

                    for(var i = 0;i < selIds.length;i++) {
                        var selIdentifierName = selIds[i];
                        refEntityIds.push(selIdentifierName + "_" + refType);
                    }

                    if(refEntityIds && refEntityIds.length) {
                        req.params.query.ids = refEntityIds;
                        var liquidLovSelectedValueGet = this.$$('#liquidLovSelectedValueGet');
                        if(liquidLovSelectedValueGet) {
                            liquidLovSelectedValueGet.requestData = req;
                            liquidLovSelectedValueGet.generateRequest();
                        }
                    }
                }
            },

            _onLovSelectedValueGetResponse: function(e) {
                //console.log('sel value get response ', e.detail.response);
                var res = e.detail.response;
                
                if(res) {
                    var entities = res.content.entities;

                    if(entities && entities.length > 0) {

                        if(this.multiSelect && this.selectedItems && this.selectedItems.length) {
                            var selItems = [];

                            for(var j = 0; j < this.selectedItems.length; j++) {
                                var found = false;
                                for(var i = 0; i < entities.length;i++) {
                                    var entity = entities[i];
                                    if(entity.name == this.selectedItems[j].id) {
                                        var patternedValue = DataTransformHelper.getLovFieldPatternValue(entity, this._lovColumnMap["title"], undefined, this.contextData);
                                        var selItem = {'id': entity.name, 'title': patternedValue};
                                        selItems.push(selItem);
                                        found = true;
                                        break;
                                    }
                                }
                                    
                                if(!found) {
                                    selItems.push(this.selectedItems[j]);
                                }
                            }

                            this.set('selectedItems', selItems);
                        }
                        else {
                            if(this.selectedItem) {
                                var entity = entities[0];
                                if(entity.name == this.selectedItem.id) {
                                    var patternedValue = DataTransformHelper.getLovFieldPatternValue(entity, this._lovColumnMap["title"], undefined, this.contextData);
                                    var selItem = {'id': this.selectedId, 'title': patternedValue};
                                    this.set('selectedItem', selItem);
                                }
                            }  
                        }
                    }
                }
            },

            _getAttributeFormattedData: function (data) {
                var entities = [];
                if (data && data.content) {
                    entities = data.content.entities;
                    if (entities) {
                        entities = DataTransformHelper.transformReferenceEntitySchemaToLovSchema(entities, this._lovColumnMap, this.contextData);
                    }
                }
                return entities;
            },

            _prepareAttributesCriteria: function (searchText) {
                if (searchText) {
                    var attributesCriterion = [];
                    var searchKey = new Object();
                    var searchValue = new Object();
                    searchValue.eq = searchText ? searchText : '';

                    searchKey[this.itemTitle] = searchValue;
                    attributesCriterion.push(searchKey);
                    return attributesCriterion
                }
            },

            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = "*" + searchText + "*";
                    keywordsCriterion.operator = "_OR";

                    return keywordsCriterion;
                }
            },

            refreshData: function () {
                this.$$('pebble-combo-box').refreshData();
            }
        });
    </script>
</dom-module>