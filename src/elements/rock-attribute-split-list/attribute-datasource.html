<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-grid-datasource-behavior/bedrock-grid-datasource-behavior.html">
<link rel="import" href="../bedrock-lov-datasource-behavior/bedrock-lov-datasource-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/bedrock-helpers.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="attribute-datasource">
    <template>
        
        <liquid-entity-model-get id="liquidModelInitSearch" operation="initiatesearch" request-data="{{request}}" on-error="_onError"
            last-response="{{_initSearchResponse}}" exclude-in-progress></liquid-entity-model-get>
        <liquid-entity-model-get id="liquidModelGetResult" operation="getsearchresultdetail" request-data="{{request}}" on-error="_onError"
            request-id="[[_initSearchResponse.content.requestId]]" last-response="{{searchResultResponse}}" exclude-in-progress></liquid-entity-model-get>
    </template>
    <script>
        Polymer({
            is: 'attribute-datasource',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                mode: {
                    type: String,
                    value: ""
                },
                _liquidInitSearchElement: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _liquidGetSearchElement: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _isRequestInitiated: {
                    type: Boolean,
                    value: false
                },

                _options: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                _totalCount: {
                    type: Number,
                    notify: true,
                    value: 0
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.GridDataSourceBehavior,
                RUFBehaviors.LOVDataSourceBehavior
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._liquidInitSearchElement = this.$$('#liquidModelInitSearch');
                this._liquidGetSearchElement = this.$$('#liquidModelGetResult');
                this.dataSource = this._dataSource.bind(this);
            },
            resetDataSource: function () {
                this._isRequestInitiated = false;
                this._resetDataSource();
            },

            _dataSource: function (options, success, error) {

                DataHelper.oneTimeEvent(this._liquidInitSearchElement, 'response', this._onInitSearchResponse.bind(
                    this));

                DataHelper.oneTimeEvent(this._liquidGetSearchElement, 'response', this._onGetSearchResponse.bind(
                    this, success, error));

                this._options = options;
                this._error = error;


                if (this._options.sortOrder && this._options.sortOrder.length) {
                    var sortOrder = this._options.sortOrder[this._options.sortOrder.length - 1];
                    var attributes = [];
                    var property = {};
                    var direction = "_ASC";
                    if (sortOrder.direction ) {
                        if (sortOrder.direction == "asc") {
                            direction = "_ASC";
                        } else if (sortOrder.direction == "desc") {
                            direction = "_DESC";
                        }
                        property[sortOrder.path] = direction;
                        if(this.attributeModels){
                            var attributeModel = this.attributeModels[sortOrder.path];
                            property["sortType"] = ConstantHelper.getDataTypeConstant(attributeModel.dataType);
                        }
                        if(!property["sortType"]){
                            property["sortType"] = ConstantHelper.DATATYPE_STRING;
                        }
                        attributes.push(property);
                        this.request.params["sort"] = { "properties": attributes };
                    }
                } else {
                   if(this.request.params.sort){
                       delete this.request.params.sort;
                   }
                }
                if (this._options.filter && this._options.filter.length) {
                    var atrrcriterion=[];
                    for(var i=0;i<this._options.filter.length;i++){
                        var path=this._options.filter[i].path;
                        var filter=this._options.filter[i].filter;
                        var cri={};
                        if(filter) {
                            cri[path] = {eq: "*"+filter+"*"};
                            atrrcriterion.push(cri);
                        }
                    }
                    if(atrrcriterion.length) {
                        this.request.params.query.filters.attributesCriterion = atrrcriterion;
                    } else {
                        if(this.request.params.query.filters.attributesCriterion){
                            delete this.request.params.query.filters.attributesCriterion;
                        }
                    }
                } else {
                    if(this.request.params.query.filters.attributesCriterion){
                        delete this.request.params.query.filters.attributesCriterion;
                    }
                }
                if (this.checkIfRequestChanged()) {
                    this.resetDataSource();
                }

                var requestOptions = this._prepareRequestOptions(this._options);
                this.set("request.params.options", requestOptions);


                // Initiate Request only for First Time.
                if (!this._isRequestInitiated) {
                    this._liquidInitSearchElement.generateRequest();
                } else {
                    this._liquidGetSearchElement.generateRequest();
                }

            },
            _onInitSearchResponse: function (e) {
                this._lastRequest = DataHelper.cloneObject(this.request);
                this._totalCount = e.detail.response.content.totalRecords;
                this._resultRecordSize = e.detail.response.content.resultRecordSize;
                this._liquidGetSearchElement.generateRequest();
                this._isRequestInitiated = true;
            },
            _onGetSearchResponse: function (success, error) {
                if (this._lastPage < this._options.page) {
                    if (this.searchResultResponse.status == "success") {
                        // Format ResponseData
                        var searchResults = this._formatResponse(this.searchResultResponse);
                        if (typeof (searchResults) == 'undefined') {
                            searchResults = [];
                        }

                        // UpdateCurrent RecordSize
                        this._updateCurrentRecordSize(this._options, searchResults, this._totalCount,this._resultRecordSize);

                        // Invoke Callback
                        success(searchResults);
                    } else {
                        error();
                    }
                } else{
                    error();
                }
            },
            _onError: function (e) {
                var response = e.detail.response; //need to check why this is response.response
                if (response && response.status && response.status.toLowerCase() == "error") {
                    var message = "";
                    if (response.statusDetail && response.statusDetail.message) {
                        message = " with message: " + response.statusDetail.message;
                    }

                    this.showErrorToast("Attribute list load failed" + message + ". Please contact your administrator.");
                }
                this._error();
            }
        });
    </script>
</dom-module>