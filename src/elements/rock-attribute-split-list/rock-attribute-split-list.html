<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../pebble-split-list/pebble-split-list.html">


<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../rock-attribute-model-lov/attribute-model-datasource.html">
<link rel="import" href="./attribute-datasource.html">

<!--
`rock-attribute-split-list`

@demo demo/index.html 
-->

<dom-module id="rock-attribute-split-list">
    <template>
        <attribute-datasource id="attributeModelDataSource" request="[[requestData]]" data-source="{{dataSource}}"  total-count="{{totalCount}}"
                              buffer-record-size="{{size}}" current-record-size="{{currentRecordSize}}"  result-record-size="{{resultRecordSize}}"
                              data-formatter="{{_dataFormatter}}"  >
        </attribute-datasource>
        <pebble-split-list data-source-id="attributeModelDataSource" items="{{items}}" deleted-items="{{deletedItems}}" page-size="[[pageSize]]" size="{{size}}" right-items="{{rightItems}}" retain-selected-items="{{retainSelectedItems}}"
            move-up-down-enabled="{{moveUpDownEnabled}}" config="{{config}}" data-source="{{dataSource}}"
        ></pebble-split-list>


    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-attribute-split-list',
                properties: {
                    items:{
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify:true
                    },
                    rightItems:{
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify:true
                    },
                    retainSelectedItems: {
                        type:Boolean,
                        value:false
                    },
                    moveUpDownEnabled:{
                        type:Boolean,
                        value:false
                    },
                    requestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    pageSize:{
                        type:Number,
                        value:50
                    },
                    deletedItems:{
                        type:Array,
                        value:function () {
                            return [];
                        }
                    }

                },
                behaviors:[
                    RUFBehaviors.UIBehavior
                ],
                ready: function () {
                    this.config={
                        "viewMode": "Tabular",
                        "title": "Simple Data Table",
                        "mode": "read",
                        "header" : {
                            "displayTitle" : false,
                            "defaultValue" :  "Simple Data Table"
                        },
                        "tabular": {
                            "settings": {
                                "isMultiSelect": true,
                                "idField":"name"
                            },
                            "columns": [
                                {
                                    "header": "Name",
                                    "name": "name",
                                    "sortable": false,
                                    "filterable": true
                                },
                                {
                                    "header": "External Name",
                                    "name": "externalName",
                                    "sortable": true,
                                    "filterable": false
                                }
                            ]
                        }
                    };
                    this._dataFormatter = this._getAttributeFormattedData.bind(this);
                    var modelGetRequest = {
                        "params": {
                            "query": {
                                "filters": {
                                    "typesCriterion": [
                                        "attributeModel"
                                    ]
                                }
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "attributes":[""]
                            }
                        }
                    };
                    this.requestData = modelGetRequest;
                },
                _getAttributeFormattedData: function (data) {
                    var idField=this.config.tabular.settings.idField;
                    var formattedData=[];
                    var deletedCount=0;
                    if (data && data.content && !_.isEmpty(data.content.entityModels)) {
                        var attributeModels = data.content.entityModels;

                        for (var i = 0; i < attributeModels.length; i++) {
                            var attributeModel = attributeModels[i];
                            attributeModel["externalName"]= attributeModel.properties.externalName;
                            var _this=this;
                            var match =this.rightItems.find(function (item) {
                                 if(item && item[idField]===attributeModel[idField]){
                                     if(_this.deletedItems.indexOf(item)===-1) {
                                         _this.push("deletedItems", item);
                                     }
                                     deletedCount++;
                                     return true;
                                }
                                return false;
                            });
                            if(!match){
                                formattedData.push(attributeModel);
                            }
                        }
                        formattedData.deletedCount=deletedCount;
                        return formattedData;
                    }
                }
            });
        })();
    </script>

</dom-module>