<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-datachannel/bedrock-datachannel.html">
<link rel="import" href="../liquid-base/liquid-base.html">

<script>
    /*
     * @demo demo/index.html
     * @polymerBehavior RUFBehaviors.LiquidBehavior
     */
    var RUFBehaviors = RUFBehaviors || {};
    var requestCount = 0;
    var responseCount = 0;
    var progressBar;
    var requestsExcludedInProgress = [];

    var liquidFalcorBaseBehavior = {
        attached: function () { },
        ready: function () {
            if (_.isEmpty(progressBar)) {
                progressBar = ComponentHelper.getProgressBar();
            }

            if (!this.includeInProgress) {
                requestCount++;
            } else {
                // expect unique identifier
                var identifier = this.id ? this.id : this.name;
                requestsExcludedInProgress.push(this.id);
            }
        },
        /**
         * Fired when a request is sent.
         *
         * @event request
         * @event liquid-request
         */
        /**
         * Fired when a response is received.
         *
         * @event response
         * @event liquid-response
         */
        /**
         * Fired when an error is received.
         *
         * @event error
         * @event liquid-error
         */
        properties: {
            operation: {
                type: String,
                value: '',
                notify: true
            },
            requestId: {
                type: String,
                value: '',
                notify: true
            },
            _dataChannelName: {
                type: String,
                value: 'Unknown',
                readonly: true
            },
            includeInProgress: {
                type: Boolean,
                value: false
            }
        },
        observers: [
            '_requestOptionsChanged(requestData.*, operation, requestId, timeout, auto)'
        ],
        /**
         * Performs an request to the specified URL.
         *
         */
        generateRequest: function () {
            var request = this._createRequest();
            var self = this;
            if (request.requestData === null || request.operation === '') {
                if (this.verbose) {
                    console.log(
                        'request operation is blank so NO request operation would be generated..terminating gracefully...'
                    );
                }
                return;
            }

            this._holdRequest(request);
            this._setLastRequest(request);
            this._setLoading(true);
            this.fire('request', {
                request: request
            }, {
                bubbles: this.bubbles
            });
            this.fire('liquid-request', {
                request: request
            }, {
                bubbles: this.bubbles
            });
            if (this._executeRequest) {
                var model = RUFBehaviors.DataChannel.getModel(this._dataChannelName);
                var modelResponse = this._executeRequest(model, request);
                //console.log('response: ', JSON.stringify(modelResponse, null, 2));
                if (!this._handleModelResponse(request, modelResponse)) //if mode response is not queued ...no need to create active request..
                    return;
            } else {
                throw "_executeRequest method is not defined";
                return;
            }
            return request;
        },
        _executeRequest: function (model, request) {
            //abstract method....do nothing...all elements implementing this behavior must implement this method
        },
        _formatResponse: function (request, rawResponsePkg) {
            return rawResponsePkg;
            //abstract method....do nothing...all elements implementing this behavior must implement this method
        },
        _validateAutoTriggerChanges: function (requestData, operation, requestId) {
            return true;
            //abstract method....do nothing...all elements implementing this behavior must implement this method
        },
        _createRequest: function () {
            return {
                "operation": this.operation,
                "requestId": this.requestId === undefined ? '' : this.requestId,
                "requestData": this.requestData
            }
        },

        _handleModelResponse: function(request, modelResponse){
            if(this.verbose) {
                console.log('_handleModelResponse called with : ', request, modelResponse);
            }
            var self = this;
            if (modelResponse && modelResponse.then) {
                modelResponse.then(function (resPkg) {
                        return self._handleResponse(request, resPkg);
                    },
                    function (errPkg) {
                        return self._handleError(request, errPkg);
                    });
                return true;
            } else {
                if (modelResponse && modelResponse.status && modelResponse.status === "success") {
                    return self._handleResponse(request, modelResponse);
                } else if (modelResponse && modelResponse.status && modelResponse.status === "error") {
                    self._handleError(request, modelResponse);
                }
                return false;
            }
            return true;
        },
        _handleResponse: function (request, responsePkg) {
            if (this.verbose) {
                console.log('_handleResponse called with :', request, responsePkg);
            }
            var formattedResponse = this._formatResponse(request, responsePkg);
            var response = this._createSuccessResponse(request, formattedResponse);
            if (request === this.lastRequest) {
                this._setLastResponse(response);
                this._setLastError(null);
                this._setLoading(false);
            }
            var eventDetail = {
                'request': request,
                'response': response
            };
            if (this.verbose) {
                //console.log('firing liquid-response event with event detail ', JSON.stringify(eventDetail, null, 4));
                console.log('firing liquid-response event with event detail ', eventDetail);
            }
            this.fire('response', eventDetail, {
                bubbles: this.bubbles
            });
            this.fire('liquid-response', eventDetail, {
                bubbles: this.bubbles
            });
            this._discardRequest(request);

            this._handleProgress();
        },

        _handleError: function (request, errorPkg) {
            var errResponse = this._createErrorResponse(request, errorPkg);
            if (this.verbose) {
                Polymer.Base._error('_handleError called with :', errResponse);
            }
            if (request === this.lastRequest) {
                this._setLastError(errResponse);
                this._setLastResponse(null);
                this._setLoading(false);
            }
            var eventDetail = {
                'request': request,
                'response': errResponse
            };
            if (this.verbose) {
                console.log('firing liquid-error event with event detail ', eventDetail);
            }
            // Tests fail if this goes after the normal this.fire('error', ...)
            this.fire('liquid-error', eventDetail, {
                bubbles: this.bubbles
            });
            this.fire('error', eventDetail, {
                bubbles: this.bubbles
            });
            this._discardRequest(request);

            this._handleProgress();
        },

        _handleProgress: function () {
            if (requestCount > 0) {
                if (!_.contains(requestsExcludedInProgress, this.id)) {
                    responseCount++;
                } else {
                    // if it is available in excluded array then remove 
                    requestsExcludedInProgress = _.without(requestsExcludedInProgress, this.id);
                }

                if (responseCount <= requestCount) {
                    progressBar.value += progressBar.max / requestCount;
                    // console.log("Progress increment by: " + progressBar.value);
                }

                function resetProgressBar() {
                    if (requestCount == responseCount) {
                        // console.log("Progress stopped at: " + requestCount + ", " + responseCount);
                        var leftOver = progressBar.max - progressBar.value;
                        if (leftOver > 0) {
                            progressBar.value += leftOver;
                        }

                        requestCount = 0;
                        responseCount = 0;

                        progressBar.value = responseCount;
                        // console.log("Counts Resetted: " + progressBar.value + ", " + progressBar.max);
                    }
                }

                var debounceProgressBar = _.debounce(function () {
                    resetProgressBar();
                }, 1000);

                debounceProgressBar();
            }
        },

        _createSuccessResponse: function (request, data) {
            var clonedData = this._cloneObject(data);
            return {
                'status': 'success',
                'content': clonedData
            };
        },
        _createErrorResponse: function (request, reason) {
            var result = {
                'status': 'error',
                'reason': reason
            };
            return result;
        },
        _holdRequest: function (request) {
            this.push('activeRequests', request);
          
        },
        _discardRequest: function (request) {
            var requestIndex = this.activeRequests.indexOf(request);
            if (requestIndex > -1) {
                this.splice('activeRequests', requestIndex, 1);
            }
        },
        _requestOptionsChanged: function (reqData, operation, requestId) {
            this.debounce('generate-falcor-request', function () {
                if (reqData == null || operation == '') {
                    return;
                }
                if (this.auto) {
                    if (this._validateAutoTriggerChanges(reqData, operation, requestId)) {
                        this.generateRequest();
                    }
                }
            }, this.debounceDuration);
        },
        _cloneObject: function (obj) {
            var clonedObj = {};

            if (obj) {
                clonedObj = JSON.parse(JSON.stringify(obj));
            }

            return clonedObj;
        }
    };
    
    RUFBehaviors.LiquidFalcorBaseBehavior = [RUFBehaviors.LiquidBaseBehavior, liquidFalcorBaseBehavior];
</script>