<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html" />
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../rock-grid/rock-grid.html">

<link rel="import" href="../pebble-button/pebble-button.html">

<dom-module id="rock-variant-options">
  <template>
    <style include="bedrock-style-common">        
        :host {
            display:block;
            height:100%;
        }      
    </style> 

    <div class="base-grid-structure">
        <div class="base-grid-structure-child-1"> 
            <div id="content-description" align="center">
                <!-- description message here -->
                <div class="title m-0">
                    You can create multiple variants.
                </div>
            </div>
        </div>

        <template is="dom-if" if="[[isExceededMaxThreshold]]">
            <div class="base-grid-structure-child-2 m-20" align="center">
                The total number of variants that can be generated has crossed the configured max threshold value.<br/>
                Please click on create button to create all the variants.
            </div>   
        </template>  

        <template is="dom-if" if="[[isVariantOptionsGridReady]]">
            <div class="base-grid-structure-child-2">
                <rock-grid id="variantOptionsGrid" data="{{variantOptionsGridData}}" hide-view-selector hide-toolbar config="{{gridConfig}}" page-size="5"></rock-grid>
            </div>  
        </template>

        <div class="actionButtons" align="center">
            <pebble-button id="backButton" class="close btn btn-secondary m-r-5" button-text="Back" noink elevation="2" on-tap="_onBack"></pebble-button>
            <pebble-button id="cancelButton" class="close btn btn-secondary m-r-5" button-text="Cancel" noink elevation="2" on-tap="_onCancel"></pebble-button>
            <pebble-button id="confirmButton" class="apply btn btn-success" button-text="Create" noink elevation="2" on-tap="_onCreate"></pebble-button>
        </div>   
              
    </div>

    <liquid-rest id="variantOptions" url="/data/pass-through/entityappservice/generatevariants" method="POST" on-liquid-response="_onVariantOptionsReceivedSuccess" on-liquid-error="_onVariantOptionsReceivedFailure"></liquid-rest>
    <liquid-rest id="bulkEntityCreate" url="/data/pass-through/bulkentityservice/createtask" method="POST" on-liquid-response="_onBulkEntityCreateSuccess" on-liquid-error="_onBulkEntityCreateFailure"></liquid-rest>

  </template>
<script>

(function(){

    class RockVariantOptions
        extends Polymer.mixinBehaviors([
				RUFBehaviors.AppBehavior,
				RUFBehaviors.BusinessFunctionBehavior,
                RUFBehaviors.ComponentConfigBehavior,
                RUFBehaviors.AppContextBehavior,
                RUFBehaviors.UIBehavior
                ], Polymer.Element) {
        static get is() { return 'rock-variant-options' }

        ready() {
            super.ready();
        }
        static get properties() {
            return {
                contextData: {
					type: Object,
					value: function () {
						return {};
                    },
                    observer: '_contextChanged'
                },
                
				config: {
					type: Object,
					value: function () { 
						return {}; 
					}
                },

                gridConfig: {
					type: Object,
					value: function () { 
						return {}; 
					}
                },
                
				variantOptionsGridData: {
					type: Array,
					value: function () {
                        return [];
                    }
                },                
                isVariantOptionsGridReady:{
                    type: Boolean,
                    value: false
                },

                isExceededMaxThreshold:{
                    type: Boolean,
                    value: false
                },
                businessFunctionData: {
                    type: Object,
                    value: function() { return {}; }
                },

                attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }                
            }
        }
               
        /**
         *  Request the required configs
        */
        _contextChanged() {
            if(!_.isEmpty(this.contextData)) {
                var context = DataHelper.cloneObject(this.contextData);               
                this.requestConfig('rock-variant-options', context);               
            }         
        }

        /**
         *  Handle config loaded event
        */
        onConfigLoaded(componentConfig) {
            if(componentConfig && componentConfig.config) {
                this.config = componentConfig.config;                
                if(this.businessFunctionData.totalVariantsCount > componentConfig.config.maxRecordsThreshold){
                    this.isExceededMaxThreshold = true;
                } else {
                    //Get the attributeModels
                    this.gridConfig = componentConfig.config.gridConfig;
                    this._getVariantOptions();     
                }                                                                               
            } else {
                var options = RUFUtilities.Logger.getOptions("Config not found for rock-variant-options",componentConfig, "error");
                RUFUtilities.Logger.logMessage(options);  
            }  
        }

        /**
         *  Request the variant options available
        */
        _getVariantOptions(){
            var requestData = this._getVariantOptionsRequest();
            var liquidObj = this.shadowRoot.querySelector("#variantOptions");                
            if(requestData && liquidObj){
                liquidObj.generateRequest(requestData);
            }
        }

        /**
         *  Create the request obj for getting the variants
        */
        _getVariantOptionsRequest(pFlag){

            if(!pFlag) {
                pFlag = "false";
            }

            if(this.businessFunctionData) {
                var request = {
                    "params": {
                        "createVariants": pFlag
                    },
                    "entity": {
                        "id": this.businessFunctionData.id,
                        "name":this.businessFunctionData.name,
                        "type": this.businessFunctionData.type
                    }
                }
                return request;
            }           
        }

        /**
         *  Handle the get variants options success
        */
        async _onVariantOptionsReceivedSuccess(e){ 

            if (e.detail && e.detail.response && e.detail.response.response) {
                var response = e.detail.response.response;
                var request = e.detail.response ? e.detail.response.request : undefined;
                response.status = "success";
                if (response.status == "success" && !this.isVariantOptionsGridReady) { 
                    //Display the variants grid
                    this.variantOptionsGridData = await DataTransformHelper.transformEntitiesToVariantGridFormat(response.entities,this._getGridColumns());
                    this.isVariantOptionsGridReady = true;
                    //Select all the grid items by default
                    Polymer.Async.timeOut.after(50).run(() => {
                        var rockGridObj = this.shadowRoot.querySelector('#variantOptionsGrid') ;
                        rockGridObj.selectAll();
                    }); 
                } else if (response.status == "success" && this.isVariantOptionsGridReady){ 
                    //Create the variants
                    if (request && request.taskId) {
                        this._taskId = request.taskId;
                        this._triggerFinishStep();
                    }
                }
            }
        }

        /**
         *  Function to get the grid columns
        */
        _getGridColumns() {
            if(this.gridConfig && this.gridConfig.tabular && this.gridConfig.tabular.columns) {
                return this.gridConfig.tabular.columns;
            }
            var columns = [];
            if(DataHelper.isValidObjectPath(this.gridConfig, 'itemConfig.fields')) {
                columns = DataHelper.convertObjectToArray(this.gridConfig.itemConfig.fields);
            }
            return columns;
        }

        /**
         *  Handle the get variants options failure
        */
        _onVariantOptionsReceivedFailure(e){
            this.showErrorToast("Failed to fetch variant options, please contact administrator.");
            var options = RUFUtilities.Logger.getOptions("Failed to fetch variant options.", e.detail.response, "error");
            RUFUtilities.Logger.logMessage(options);
        }
        
        /**
         *  Close variant options 
        */
        _onCancel() {
            var eventName = "onCancel";
            var eventDetail = {
                name: eventName
            }

            this.fireBedrockEvent(eventName, eventDetail, {
                ignoreId: true
            });
        }

        /**
         *  Go Back to variant dimetion attribute screen 
        */
        _onBack() {
            var eventName = "onBack";
            var eventDetail = {
                name: eventName
            }

            this.fireBedrockEvent(eventName, eventDetail, {
                ignoreId: true
            });
        }

        /**
         *  Generate a request to create variants
         *  Use createvariants API if the grid is not displayed
         *  Use the bulkcreate API if the grid is displayed and entities may be excluded
        */
        _onCreate() { 
            //If the grid is displayed, allow exclusions
            var rockGridObj = this.shadowRoot.querySelector('#variantOptionsGrid') ;
            var requestData = {};
            var liquidObj = {};

            if(rockGridObj) {
                var selectedEntities = rockGridObj.getSelectedItems();
                if(selectedEntities.length <= 0){
                    this.showInformationToast("Please select at least one entity from grid to create.");
                    return;
                } else {
                    requestData = this._getBulkCreateRequest(selectedEntities);
                    liquidObj = this.shadowRoot.querySelector("#bulkEntityCreate"); 
                }
            } else {
                //Perform create variants
                requestData = this._getVariantOptionsRequest("true");
                liquidObj = this.shadowRoot.querySelector("#variantOptions");     
            }
            
            if(requestData && liquidObj){
                liquidObj.generateRequest(requestData);
            }

        }

        /**
         *  Generate a request to create bulk entities
        */
        _getBulkCreateRequest(selectedEntities){
            var requestData = {
                "params": {
                    "operationType": "inboundService",
                    "taskType": "process"
                },
                "entities" : selectedEntities
            };

            return requestData; 
        }

        /**
         *  Handle create bulk entities success
        */
        _onBulkEntityCreateSuccess(e) {
            var response = e.detail.response && e.detail.response.response ? e.detail.response.response : e.detail.response;
            var request = e.detail.response ? e.detail.response.request : undefined;

            if ((!response || _.isEmpty(response)) ||
                (DataHelper.isValidObjectPath(response, "dataObjectOperationResponse.status") && response.dataObjectOperationResponse.status.toLowerCase() == "error") ||
                (response.status && response.status.toLowerCase() == "error")) {
                    this.showErrorToast("Bulk create request failed");
                    var options = RUFUtilities.Logger.getOptions("Bulk create request failed", e.detail.response.request, "error");
                    RUFUtilities.Logger.logMessage(options);
                    return;
            } else {
                if (response.status && response.status.toLowerCase() == "success") {
                    if (request && request.taskId) {
                        this._taskId = request.taskId;
                    }
                }
                this._triggerFinishStep();
            }
        }

        /**
         *  Handle create bulk entities failure
        */
        _onBulkEntityCreateFailure(e) {
            this._message = "Failed to perform the Bulk entity create. Please contact administrator.";
            var options = RUFUtilities.Logger.getOptions(this._message, e.detail.request, "error");
            RUFUtilities.Logger.logMessage(options);
        }
    

        /**
         *  Last step for create variants
        */
        _triggerFinishStep() {            
            var message = "Variant creation process is started, you can review the progress of the task " + this._taskId + " in task details.";
            var messages = [
                {
                    "message": message
                }
            ]
            var actions = [
                {
                    "name": "goBack",
                    "text": "Take me back to where I started",
                    "isNotApp": true
                },
                {
                    "name": "gotoJobDetails",
                    "text": "Show me the task details",
                    "isNotApp": true,
                    "dataRoute": "task-detail",
                    "queryParams": {
                        "id": this._taskId
                    }
                }
            ];

            var data = {
                "messages": messages,
                "noGrid": true,
                "actions": actions,
            };

            this.businessFunctionData = data;
            var eventName = "onComplete";
            var eventDetail = {
                name: eventName
            }

            this.fireBedrockEvent(eventName, eventDetail, {
                ignoreId: true
            });
        }
         
    }

    customElements.define(RockVariantOptions.is, RockVariantOptions)


})();
</script>
</dom-module>
