<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="event-list-datasource.html">

<!--
`<rock-import-list>`
<b><i>Content development is under progress... </b></i>

@group rock Elements
@element rock-import-list
@demo demo/index.html
-->

<dom-module id="rock-import-list">
    <template>
        <style is="custom-style" include="pebble-styles-shared">
            #stateButton {
                margin-left: 10px;
            }

            rock-grid::shadow #pebbleGridContainer {
                margin: 0;
            }

            pebble-toggle-button {                
                --pebble-toggle-button-checked-bar-color: var(--success-color, #4caf50);
                --pebble-toggle-button-checked-button-color: var(--success-color, #4caf50);
                --pebble-toggle-button-checked-ink-color: var(--success-color, #4caf50);
            }

            .alignRight {
                margin-left: auto;
            }

            #refreshButton {
                color: var(--icon-color, #757575);
            }
        </style>

        <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
        <bedrock-pubsub event-name="rock-search-clear" handler="_onSearchClear" target-id="searchBar"></bedrock-pubsub>
        <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
        <!--<pebble-dropdown id="sortDropdown" label="Sort By" items="[[sortingAttributes]]" selected-value="{{sortCondition}}"></pebble-dropdown>-->
        <!--<div class="flex">-->
        <!--<pebble-button icon="icons:arrow-downward" class="iconButton btn " hidden="[[descending]]" on-tap="_sortByDesecnding"></pebble-button>-->
        <!--<pebble-button icon="icons:arrow-upward" class="iconButton btn" hidden="[[!descending]]" on-tap="_sortByAsecnding"></pebble-button>-->
        <!--</div>-->
        <div class="row-wrap align-items-center">
            <div class="col-3">
                <pebble-dropdown class="dropdown" label="Status" items="[[stateFilters]]" selected-value="{{selectedState}}"></pebble-dropdown>                    
            </div>
            <div class="col-3">
                <pebble-dropdown class="dropdown" label="Type" items="[[typeFilters]]" selected-value="{{selectedType}}"></pebble-dropdown>                    
            </div>
            <div class="col text-right">
                <pebble-button id="refreshButton" icon="pebble-md-icons:ToolbarRefresh" class="pebble-md-icons iconButton tooltip-bottom m-r-10" data-tooltip="Refresh" on-tap="_refreshList"></pebble-button>
                <template is="dom-if" if="[[userToggleAllowed]]">
                    <pebble-toggle-button checked="{{!getAllUsersEvents}}">Show Only My Jobs</pebble-toggle-button>
                </template>
            </div>
        </div>
        <event-list-datasource id="eventDataSource" request="[[request]]" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}">
        </event-list-datasource>
        <rock-grid id="importlistGrid" no-header config="{{config}}" page-size="10" data-source="{{dataSource}}" data-source-id="eventDataSource"></rock-grid>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-import-list',

                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    stateFilters: {
                        type: String,
                        value: "Completed,Running,Aborted"
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    typeFilters: {
                        type: String,
                        value: "Import data,Export data,Import governance model,Export governance model"
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    descending: {
                        type: Boolean,
                        value: false
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    sortCondition: {
                        type: String,
                        observer: '_sortConditionChanged'
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    sortingAttributes: {
                        type: String,
                        value: "Name,File Type,Status,Last Modified Date,Success Count, Failure Count "
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    getAllUsersEvents: {
                        type: Boolean,
                        value: false,
                        observer: '_userStateChanged'
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    config: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    request: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_contextDataChanged'
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    selectedState: {
                        type: String,
                        value: "Running",
                        //computed:'_setUserDefaultJobStatus(config)',
                        observer: "_onStateFilterChanged"
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    selectedType: {
                        type: String,
                        value: "",
                        observer: "_onTypeFilterChanged"
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    userToggleAllowed: {
                        type: Boolean,
                        computed: '_setUserToggleAllowed(config)'
                    }

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                ready: function () {
                    this._dataFormatter = this._getEventFormattedData.bind(this);
                    this.config = this.getParentAppConfig('rock-import-list')
                },
                observers: ['_contextDataChanged(contextData,config)'],
                _contextDataChanged: function (contextData, config) {
                    if (!_.isEmpty(contextData) && !_.isEmpty(config)) {
                        this._setEventRequest();
                    }
                },
                _setUserToggleAllowed: function (config) {
                    return !!config.userToggleAllowed;
                },

                _setUserDefaultJobStatus(config) {
                    return config.defaultJobStatus;
                },
                _setEventRequest: function () {
                    var contextData = DataHelper.cloneObject(this.contextData);
                    var itemContext = {
                        "type": "externalevent"
                    };
                    contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                    var req = DataRequestHelper.createEntityGetRequest(contextData);
                    req.params.query.valueContexts = [{
                        "source": "internal",
                        "locale": "en-US"
                    }];
                    req.params.query.filters.attributesCriterion = [{
                            "eventSubType": {
                                "eq": "workBatchStarted"
                            }
                        },
                        {
                            "profileType": {
                                "eq": "ENTITY_IMPORT"
                            }
                        }
                    ];
                    if (this.config.dataRequest && this.config.dataRequest.attributes) {
                        req.params.fields.attributes = this.config.dataRequest.attributes;
                    } else {
                        req.params.fields.attributes = ["_ALL"];
                    }
                    if (!this.getAllUsersEvents) {
                        req.params.query.filters.attributesCriterion.push({
                            "userId": {
                                "eq": this.userId
                            }
                        });
                    }
                    req.params.sort = {
                        "attributes": [{
                            "createdOn": "_DESC",
                            "sortType": "_DATETIME"
                        }]
                    };
                    this.set("request", req);
                    this.$$("#importlistGrid").reloadListData();
                },
                _onStateButtonTap: function () {
                    this.$$("#statesPopover").show();
                },
                _sortByDesecnding: function () {
                    this.descending = true;
                },
                _sortByAsecnding: function () {
                    this.descending = false;
                },
                _sortConditionChanged: function (sortCondition) {
                    if (this.request) {

                        if (sortCondition) {
                            var req = this.request;
                            if (this.descending) {
                                alert(sortCondition)
                            } else {
                                alert(sortCondition)
                            }

                            // req.params.sort.attributes = {
                            //    sortConditionval
                            //};
                            //} else {
                            //  var req = this.request;
                            //delete req.params.query.filters.keywordsCriterion;
                        }

                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _getAttributeNamesFromListConfig: function (config) {
                    var listItems = config.list.listItems;
                    var attributeNames = [];
                    attributeNames.push(listItems.image);
                    attributeNames.push(listItems.title);
                    attributeNames.push(listItems.subtitle);
                    attributeNames.push(listItems.id);
                    for (var i in listItems.fields) {
                        var field = listItems.fields[i];
                        attributeNames.push(field.name);
                    }
                    return attributeNames;
                },
                _getImagePathByType: function (type) {
                    switch (type.toLowerCase()) {
                        case "excel":
                            return "/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg";
                        case "rsjson":
                            return "/src/images/json.svg";
                        default:
                            return "/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg";
                    }
                },
                _getEventType: function (type) {
                    switch (type) {
                        case "workBatchComplete":
                            return "Completed";
                        case "workBatchStarted":
                            return "Started";
                        case "workBatchError":
                            return "Aborted";
                        default:
                            return "Queued";
                    }
                },
                _getEventFormattedData: function (data) {
                    var attributeNames = this._getAttributeNamesFromListConfig(this.config);
                    if (data && data.content) {
                        var events = data.content.events;
                        if (events) {
                            events = DataTransformHelper.transformEntitiesToSimpleSchema(events,
                                attributeNames, this.contextData);
                        }
                    }
                    for (var i in events) {
                        events[i].fileTypeImage = this._getImagePathByType(events[i].formatter);
                        events[i].eventSubType = this._getEventType(events[i].eventSubType);
                        events[i].createdOn = this._formatDate(new Date(events[i].createdOn));
                        if (events[i].eventSubType == "Completed") {
                            events[i].recordCount = "Total " + events[i].recordCount + " Records"
                        }
                        if (events[i].eventSubType != "Aborted") {
                            events[i].viewDetails = "View Details"
                        }
                    }

                    return events;
                },
                _formatDate: function (date) {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    var seconds = date.getSeconds();
                    var ampm = hours >= 12 ? 'pm' : 'am';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    minutes = minutes < 10 ? '0' + minutes : minutes;
                    var strTime = hours + ':' + minutes + ':' +seconds+' '+ ampm;
                    return date.getMonth() + 1 + "/" + date.getDate() + "/" + date.getFullYear() + "  " +
                        strTime;
                },
                _onStateFilterChanged: function (selectedState) {
                    if (this.request && !_.isEmpty(this.request) && selectedState) {
                        switch (selectedState) {
                            case "Completed":
                                selectedState = "workBatchComplete";
                                break;
                            case "Aborted":
                                selectedState = "workBatchError";
                                break;
                            default:
                                selectedState = "workBatchStarted";
                        }

                        var req = this.request;
                        var attributesCriteria = req.params.query.filters.attributesCriterion;
                        for (var i in attributesCriteria) {
                            if (attributesCriteria[i].eventSubType) {
                                attributesCriteria.splice(i, 1);
                                break;
                            }
                        }
                        req.params.query.filters.attributesCriterion.push({
                            "eventSubType": {
                                "eq": selectedState
                            }
                        });
                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _onTypeFilterChanged: function (selectedType) {
                    if (this.request && !_.isEmpty(this.request) && selectedType) {
                        switch (selectedType) {
                            case "Export data":
                                selectedType = "ENTITY_EXPORT";
                                break;
                            case "Import governance model":
                                selectedType = "MODEL_IMPORT";
                                break;
                            case "Export governance model":
                                selectedType = "MODEL_EXPORT";
                                break;
                            default:
                                selectedType = "ENTITY_IMPORT";
                        }
                        var req = this.request;
                        var attributesCriteria = req.params.query.filters.attributesCriterion;
                        for (var i in attributesCriteria) {
                            if (attributesCriteria[i].profileType) {
                                attributesCriteria.splice(i, 1);
                                break;
                            }
                        }
                        req.params.query.filters.attributesCriterion.push({
                            "profileType": {
                                "eq": selectedType
                            }
                        });
                        this.$$("#importlistGrid").reloadListData();
                    }
                },

                _onSearch: function (e, detail) {
                    if (this.request && !_.isEmpty(this.request)) {
                        if (detail) {
                            var req = this.request;
                            req.params.query.filters.keywordsCriterion = {
                                "keywords": "*" + detail + "*",
                                "operator": "_OR"
                            };

                        } else {
                            var req = this.request;
                            delete req.params.query.filters.keywordsCriterion;
                        }
                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _onSearchClear: function (e) {
                    if (this.request && !_.isEmpty(this.request)) {
                        var req = this.request;
                        delete req.params.query.filters.keywordsCriterion;
                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _userStateChanged: function (getAllUsersEvents) {
                    if (this.request && !_.isEmpty(this.request)) {
                        if (!getAllUsersEvents) {
                            var req = this.request;
                            req.params.query.filters.attributesCriterion.push({
                                "userId": {
                                    "eq": this.userId
                                }
                            });
                        } else {
                            var req = this.request;
                            var attributesCriteria = req.params.query.filters.attributesCriterion;
                            for (var i in attributesCriteria) {
                                if (attributesCriteria[i].userId) {
                                    attributesCriteria.splice(i, 1);
                                    break;
                                }
                            }
                        }
                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _refreshList: function () {
                    this.$$("#eventDataSource").resetDataSource();
                    this.$$("#importlistGrid").reloadListData();
                }
            });
        })();
    </script>

</dom-module>