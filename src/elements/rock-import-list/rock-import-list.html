<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="event-list-datasource.html">

<!--
`<rock-import-list>`

@group rock Elements
@element rock-import-list
@demo demo/index.html
-->

<dom-module id="rock-import-list">
    <template>
        <style is="custom-style" include="pebble-styles-shared">
            #searchBar{
                width: calc(100% - 114px);                
                display: inline-block;
            }

            #stateButton{
                margin-left: 10px;
            }

            .iconButton{
                margin-top:15px ;
            }

            rock-grid::shadow #pebbleGridContainer{
                margin: 0;
            }
            pebble-toggle-button {
                margin-top:10px ;
                --pebble-toggle-button-checked-bar-color:  var(--success-color,#4caf50);
                --pebble-toggle-button-checked-button-color:  var(--success-color,#4caf50);
                --pebble-toggle-button-checked-ink-color: var(--success-color,#4caf50);
            }
        </style>

        <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
        <bedrock-pubsub event-name="rock-search-clear" handler="_onSearchClear" target-id="searchBar"></bedrock-pubsub>
        <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
        <pebble-button id="stateButton" button-text="Status" icon="pebble-sm-icons:Filter-wt" class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger" noink dropdown-icon on-tap="_onStateButtonTap"></pebble-button>
        <pebble-popover id="statesPopover" for="stateButton" >
           <pebble-lov id="filterLov" multi-select selected-items="{{selectedItems}}"  items="[[stateFilters]]"></pebble-lov>
        </pebble-popover>
        <div class="layout horizontal ">
            <pebble-dropdown id="sortDropdown" label="Sort By" items="[[sortingAttributes]]" selected-value="{{sortCondition}}"></pebble-dropdown>
            <div class="flex">
                <pebble-button icon="icons:arrow-downward" class="iconButton btn " hidden="[[descending]]" on-tap="_sortByDesecnding"></pebble-button>
                <pebble-button icon="icons:arrow-upward" class="iconButton btn" hidden="[[!descending]]" on-tap="_sortByAsecnding"></pebble-button>
            </div>
            <pebble-toggle-button checked="{{getOwnEvents}}"></pebble-toggle-button>

        </div>
        <event-list-datasource id="eventDataSource" request="[[request]]" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
                               keywords-criterion-builder="{{_keywordsCriterionBuilder}}">
        </event-list-datasource>
        <rock-grid no-header  config="{{config}}" page-size="10" data-source="{{dataSource}}" data-source-id="eventDataSource"></rock-grid>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-import-list',

                properties: {
                    stateFilters: {
                        type:Array,
                        value: function () {
                            return [
                                {
                                    "id": "completed",
                                    "title": "Completed"
                                },
                                {
                                        "id": "ongoing",
                                        "title": "Ongoing"
                                },
                                {
                                        "id": "pending",
                                        "title": "Pending"
                                }
                            ];
                        }
                    },
                    descending:{
                        type:Boolean,
                        value:false
                    },
                    sortCondition:{
                        type:String,
                        observer:'_sortCondtionChanged'
                    },
                    sortingAttributes:{
                        type:String,
                        value:"Name,File Type,Status,Last Modified Date,Success Count, Failure Count "
                    },
                    getOwnEvents:{
                        type:Boolean,
                        value:false,
                        observer:'_userStateChanged'
                    },
                    config:{
                        type:Object,
                        value:function () {
                            return {};
                        }
                    },
                    request:{
                        type:Object,
                        value:function () {
                            return {
                                "params": {
                                    "query": {
                                        "valueContexts": [
                                            {
                                                "locale": "en-US",
                                                "source": "internal"
                                            }
                                        ],
                                        "filters": {
                                            "typesCriterion": [
                                                "externalevent"
                                            ],
                                            "attributesCriterion": [
                                                {
                                                    "eventSubType": {
                                                        "eq": "batchCompleted"
                                                    }
                                                }
                                            ]

                                        }
                                    },
                                    "fields": {
                                        "attributes": ["_ALL"]
                                    }
                                }
                            }
                        }
                    }

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                listeners: {
                    'filterLov.selection-changed': '_onLovSelectionChanged',
                    'filterLov.lov-confirm-button-tap': '_onLovConfirmButtonTapped',
                    'filterLov.lov-close-button-tap': '_onLovCloseButtonTapped'
                },
                ready:function () {
                    this._attributesCriterionBuilder = this._prepareAttributesCriteria.bind(this);
                    this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);
                    this._dataFormatter = this._getEventFormattedData.bind(this);
                    this.config=this.getParentAppConfig('rock-import-list')
                },
                _onStateButtonTap:function () {
                    this.$$("#statesPopover").show();
                },
                _sortByDesecnding:function () {
                    this.descending=true;
                },
                _sortByAsecnding:function () {
                    this.descending=false;
                },
                _sortCondtionChanged:function (sortCondition) {
                    if(sortCondition) {
                        if (this.descending) {
                            alert("sort Condition " + sortCondition + " sort order: Descending");
                        } else {
                            alert("sort Condition " + sortCondition + " sort order: Ascending");
                        }
                    }
                },
                _onSearch:function (e,detail) {
                    alert(detail);
                },
                _onSearchClear:function (e) {
                    alert("search cleared");
                },
                _onLovSelectionChanged:function () {
                    alert("filter selection changed");
                },
                _prepareKeywordsCriteria: function (searchText) {
                    if (searchText) {
                        var keywordsCriterion = {};

                        keywordsCriterion.keywords = searchText;
                        keywordsCriterion.operator = "and";

                        return keywordsCriterion;
                    }
                },
                _prepareAttributesCriteria: function () {
                    //TODO will have to prepare it based on request 
                },
                _getAttributeNamesFromListConfig: function (config) {
                   var listItems=config.list.listItems;
                   var attributeNames=[];
                   attributeNames.push(listItems.image);
                   attributeNames.push(listItems.title);
                   attributeNames.push(listItems.subtitle);
                   attributeNames.push(listItems.id);
                   for(var i in listItems.fields){
                       var field=listItems.fields[i];
                       attributeNames.push(field.name);
                   }
                   return attributeNames;

                },
                _getImagePathByType:function (type) {
                    switch(type) {
                        case "Excel":
                            return "/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg";
                        default:
                            return "";
                    }
                },
                _getEventFormattedData:function (data) {
                    var attributeNames=this._getAttributeNamesFromListConfig(this.config);
                    if (data && data.content) {
                        var events = data.content.events;
                        if (events) {
                            events = DataTransformHelper.transformEventSchemaToListSchema(events, attributeNames,this.contextData);
                        }
                    }
                    for(var i in events){
                        events[i].fileTypeImage=this._getImagePathByType(events[i].fileType);
                        if(events[i].successCount) {
                            events[i].successCount += " Passed";
                        }
                        if(events[i].failureCount) {
                            events[i].failureCount+= " Errors";
                        }
                    }

                    return events;
                },
                _userStateChanged:function (getOwnEvents) {
                    //alert(getOwnEvents);
                }
            });
        })();
    </script>

</dom-module>