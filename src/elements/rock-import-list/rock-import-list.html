<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="event-list-datasource.html">

<!--
`<rock-import-list>`
<b><i>Content development is under progress... </b></i>

@group rock Elements
@element rock-import-list
@demo demo/index.html
-->

<dom-module id="rock-import-list">
    <template>
        <style is="custom-style" include="pebble-styles-shared">
            #stateButton {
                margin-left: 10px;
            }

            rock-grid::shadow #pebbleGridContainer {
                margin: 0;
            }

            pebble-toggle-button {
                --pebble-toggle-button-checked-bar-color: var(--success-color, #4caf50);
                --pebble-toggle-button-checked-button-color: var(--success-color, #4caf50);
                --pebble-toggle-button-checked-ink-color: var(--success-color, #4caf50);
            }

            .alignRight {
                margin-left: auto;
            }

            #refreshButton {
                color: var(--icon-color, #757575);
            }
        </style>

        <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
        <bedrock-pubsub event-name="rock-search-clear" handler="_onSearchClear" target-id="searchBar"></bedrock-pubsub>

        <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>

        <div class="row-wrap align-items-center">
            <div class="col-3">
                <pebble-dropdown class="dropdown" label="Status" items="[[eventSubTypes]]" selected-value="{{selectedEventSubType}}"></pebble-dropdown>
            </div>
            <div class="col-3">
                <pebble-dropdown class="dropdown" label="Type" items="[[eventTypes]]" selected-value="{{selectedEventType}}"></pebble-dropdown>
            </div>
            <div class="col text-right">
                <pebble-button id="refreshButton" icon="pebble-md-icons:ToolbarRefresh" class="pebble-md-icons iconButton tooltip-bottom m-r-10"
                    data-tooltip="Refresh" on-tap="_refreshList"></pebble-button>
                <template is="dom-if" if="[[userToggleAllowed]]">
                    <pebble-toggle-button checked="{{!getAllUsersEvents}}">Show Only My Jobs</pebble-toggle-button>
                </template>
            </div>
        </div>
        <event-list-datasource id="eventDataSource" request="[[request]]" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}">
        </event-list-datasource>
        <rock-grid id="importlistGrid" no-header config="{{config}}" page-size="10" data-source="{{dataSource}}" data-source-id="eventDataSource"></rock-grid>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-import-list',

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    eventSubTypes: {
                        type: Array,
                         value: [
                            { "value": "QUEUED", "title": "Queued" },
                            { "value": "PROCESSING", "title": "Processing" },
                            { "value": "ERRORED", "title": "Errored" }
                        ]
                    },
                    eventSubTypeFilterMap: {
                        type: Object,
                        value: {
                            'QUEUED': ['QUEUED'],
                            'PROCESSING': ['SUBMITTED', 'PROCESSING_COMPLETED', 'PROCESSING_STARTED'],
                            'ERRORED': ['PROCESSING_ERROR', 'ABORTED', 'SUBMISSION_ERROR']
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    eventTypes: {
                        type: Array,
                        value: [
                            { "value": "ALL", "title": "All" },
                            { "value": "ASSET_IMPORT_RECORD", "title": "Asset uploads" },
                            { "value": "BATCH_COLLECT_ENTITY_IMPORT", "title": "Entity data imports" },
                            { "value": "BATCH_COLLECT_ENTITY_EXPORT", "title": "Entity data exports" },
                            { "value": "BATCH_COLLECT_ENTITY_MODEL_IMPORT", "title": "Entity model data imports" },
                            { "value": "BATCH_COLLECT_ENTITY_MODEL_EXPORT", "title": "Entity model data exports" }
                        ]
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    descending: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    sortCondition: {
                        type: String,
                        observer: '_sortConditionChanged'
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    sortingAttributes: {
                        type: String,
                        value: "Name,File Type,Status,Last Modified Date,Success Count, Failure Count "
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    getAllUsersEvents: {
                        type: Boolean,
                        value: false,
                        observer: '_userStateChanged'
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    config: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    request: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_contextDataChanged'
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    selectedEventType: {
                        type: String,
                        value: "BATCH_COLLECT_ENTITY_IMPORT",
                        observer: "_onEventTypeFilterChanged"
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    selectedEventSubType: {
                        type: String,
                        value: "PROCESSING",
                        observer: "_onEventSubTypeFilterChanged"
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    userToggleAllowed: {
                        type: Boolean,
                        computed: '_setUserToggleAllowed(config)'
                    }

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                ready: function () {
                    this._dataFormatter = this._getEventFormattedData.bind(this);
                    this.config = this.getParentAppConfig('rock-import-list')
                },

                observers: ['_contextDataChanged(contextData,config)'],

                _contextDataChanged: function (contextData, config) {
                    if (!_.isEmpty(contextData) && !_.isEmpty(config)) {
                        this._setEventRequest();
                    }
                },

                _setUserToggleAllowed: function (config) {
                    return !!config.userToggleAllowed;
                },

                _setUserDefaultJobStatus(config) {
                    return config.defaultJobStatus;
                },
                _setEventRequest: function () {
                    var contextData = DataHelper.cloneObject(this.contextData);
                    var itemContext = {
                        "type": "externalevent"
                    };
                    contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                    var req = DataRequestHelper.createEntityGetRequest(contextData);
                    req.params.query.valueContexts = [{
                        "source": "internal",
                        "locale": "en-US"
                    }];

                    var attributesCriterion = [];

                    if(this.selectedEventType && this.selectedEventType != "ALL") {
                        var eventTypeCriterion = {
                            "eventType": {
                                "eq": this.selectedEventType
                            }
                        }

                        attributesCriterion.push(eventTypeCriterion);
                    }

                    var eventSubTypeCriterion = this._getEventSubTypeCriterion();
                    attributesCriterion.push(eventSubTypeCriterion);
                    
                    req.params.query.filters.attributesCriterion = attributesCriterion;

                    if (this.config.dataRequest && this.config.dataRequest.attributes) {
                         req.params.fields.attributes = this.config.dataRequest.attributes;
                    } else {
                    req.params.fields.attributes = ["_ALL"];
                    }

                    if (!this.getAllUsersEvents) {
                        req.params.query.filters.attributesCriterion.push({
                            "userId": {
                                "eq": this.userId
                            }
                        });
                    }
                    req.params.sort = {
                        "attributes": [{
                            "createdOn": "_DESC",
                            "sortType": "_DATETIME"
                        }]
                    };

                    this.set("request", req);

                    this.$$("#importlistGrid").reloadListData();
                },
                _onStateButtonTap: function () {
                    this.$$("#statesPopover").show();
                },
                _sortByDesecnding: function () {
                    this.descending = true;
                },
                _sortByAsecnding: function () {
                    this.descending = false;
                },
                _sortConditionChanged: function (sortCondition) {
                    if (this.request) {

                        if (sortCondition) {
                            var req = this.request;
                            if (this.descending) {
                                alert(sortCondition)
                            } else {
                                alert(sortCondition)
                            }

                            // req.params.sort.attributes = {
                            //    sortConditionval
                            //};
                            //} else {
                            //  var req = this.request;
                            //delete req.params.query.filters.keywordsCriterion;
                        }

                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _getAttributeNamesFromListConfig: function (config) {
                    var listItems = config.list.listItems;
                    var attributeNames = [];
                    attributeNames.push(listItems.image);
                    attributeNames.push(listItems.title);
                    attributeNames.push(listItems.subtitle);
                    attributeNames.push(listItems.id);
                    for (var i in listItems.fields) {
                        var field = listItems.fields[i];
                        attributeNames.push(field.name);
                    }
                    return attributeNames;
                },
                _getImagePathByType: function (type) {
                    if(!type) {
                        return "/src/images/image.svg";
                    }

                    switch (type.toLowerCase()) {
                        case "excel":
                            return "/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg";
                        case "rsjson":
                            return "/src/images/json.svg";
                        default:
                            return "/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg";
                    }
                },
                _getEventSubTypeCriterion: function() {
                    var criterion = undefined;

                    if(this.selectedEventSubType) {
                        // var eventSubTypeFilters = this.eventSubTypeFilterMap[this.selectedEventSubType];

                        // var criteria = eventSubTypeFilters.join(" ");

                        criterion = 
                        {
                            "eventSubType": {
                                "eq": this.selectedEventSubType
                            }
                        }
                    }

                    return criterion;
                },
                _getEventSubTypeTitle: function (type) {
                    var eventSubFilterMap = this.eventSubTypeFilterMap;

                    for(var key in eventSubFilterMap) {
                        var eventSubTypeFilters = eventSubFilterMap[key];

                        if(eventSubTypeFilters.indexOf(type) > -1) {
                            for(var i = 0; i < this.eventSubTypes.length;i++) {
                                if(key == this.eventSubTypes[i].value) {
                                    return this.eventSubTypes[i].title;
                                }
                            }    
                        }
                    }

                    return "Unknown";
                },
                _getEventFormattedData: function (data) {
                    var attributeNames = this._getAttributeNamesFromListConfig(this.config);
                    if (data && data.content) {
                        var events = data.content.events;
                        if (events) {
                            events = DataTransformHelper.transformEntitiesToSimpleSchema(events,
                                attributeNames, this.contextData);
                        }
                    }

                    for (var i in events) {
                        var eventSubTypeCode = events[i].eventSubType;
                        events[i].fileTypeImage = this._getImagePathByType(events[i].formatter);
                        events[i].eventSubType = this._getEventSubTypeTitle(eventSubTypeCode);
                        events[i].createdOn = this._formatDate(new Date(events[i].createdOn));

                        var eventSubType = events[i].eventSubType;

                        if (eventSubTypeCode != "QUEUED") {
                            events[i].recordCount = "Total " + events[i].recordCount + " Records"
                            events[i].viewDetails = "View Details"
                        }
                    }

                    return events;
                },
                _formatDate: function (date) {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    var seconds = date.getSeconds();
                    var ampm = hours >= 12 ? 'pm' : 'am';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    minutes = minutes < 10 ? '0' + minutes : minutes;
                    var strTime = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
                    return date.getMonth() + 1 + "/" + date.getDate() + "/" + date.getFullYear() + "  " +
                        strTime;
                },
                _onEventTypeFilterChanged: function (selectedEventType) {
                    if (this.request && !_.isEmpty(this.request) && selectedEventType) {
                        var req = this.request;

                        var attributesCriteria = req.params.query.filters.attributesCriterion;

                        for (var i in attributesCriteria) {
                            if (attributesCriteria[i].eventType) {
                                attributesCriteria.splice(i, 1);
                                break;
                            }
                        }
                        if (selectedEventType != "ALL") {
                            req.params.query.filters.attributesCriterion.push({
                                "eventType": {
                                    "eq": selectedEventType
                                }
                            });
                        }

                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _onEventSubTypeFilterChanged: function (selectedEventSubType) {
                    if (this.request && !_.isEmpty(this.request) && selectedEventSubType) {

                        var req = this.request;
                        var attributesCriteria = req.params.query.filters.attributesCriterion;

                        for (var i in attributesCriteria) {
                            if (attributesCriteria[i].eventSubType) {
                                attributesCriteria.splice(i, 1);
                                break;
                            }
                        }

                        var eventSubTypeCriterion = this._getEventSubTypeCriterion();
                        req.params.query.filters.attributesCriterion.push(eventSubTypeCriterion);

                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _onSearch: function (e, detail) {
                    if (this.request && !_.isEmpty(this.request)) {
                        if (detail) {
                            var req = this.request;
                            req.params.query.filters.keywordsCriterion = {
                                "keywords": "*" + detail + "*",
                                "operator": "_OR"
                            };
                        } else {
                            var req = this.request;
                            delete req.params.query.filters.keywordsCriterion;
                        }

                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _onSearchClear: function (e) {
                    if (this.request && !_.isEmpty(this.request)) {
                        var req = this.request;
                        delete req.params.query.filters.keywordsCriterion;
                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _userStateChanged: function (getAllUsersEvents) {
                    if (this.request && !_.isEmpty(this.request)) {
                        if (!getAllUsersEvents) {
                            var req = this.request;
                            req.params.query.filters.attributesCriterion.push({
                                "userId": {
                                    "eq": this.userId
                                }
                            });
                        } else {
                            var req = this.request;
                            var attributesCriteria = req.params.query.filters.attributesCriterion;
                            for (var i in attributesCriteria) {
                                if (attributesCriteria[i].userId) {
                                    attributesCriteria.splice(i, 1);
                                    break;
                                }
                            }
                        }
                        this.$$("#importlistGrid").reloadListData();
                    }
                },
                _refreshList: function () {
                    this.$$("#eventDataSource").resetDataSource();
                    this.$$("#importlistGrid").reloadListData();
                }
            });
        })();
    </script>

</dom-module>