<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">

<!--
`rock-attribute-manage` Represents the component to manage the attribute values.
It renders the rock-attribute-list with the specified context parameters. 
It is responsible to get and save the attributes.

@demo demo/index.html 
-->
<dom-module id="rock-attribute-manage">
    <template>
        <style include="pebble-styles-shared">
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    background: var(--white);
                    border: 1px solid var(--cloudy-blue-color);
                    font-size: 15px;
                }
            }
            
            .focus {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    font-size: 15px;
                    background: var(--button-bg-color);
                    color: var(--white);
                }
            }
            
            #buttonContainer {        
                position: fixed;
                bottom: 0;
                left: 40px;       
                padding: 20px 0;
                background: rgba(255, 255, 255, 0.80);
                display: none;
                text-align: center;
                border-top: 1px solid var(--default-border-color, #c1cad4);
                z-index: 9999;
            }
        </style>
        <rock-attribute-list context-data="[[contextData]]" show-group-name$=[[showGroupName]] group-name="[[groupName]]" attribute-values="[[_attributeValues]]"
            attribute-models="[[_attributeModels]]" no-of-columns="[[noOfColumns]]" mode="{{mode}}" attribute-messages="{{_attributeMessages}}"></rock-attribute-list>
        <liquid-entity-data-get name="attributeGetDataService" operation="getbyids" request-data="{{_attributeRequest}}" last-response="{{_attributeResponse}}"></liquid-entity-data-get>
        <liquid-entity-govern-data-get id="attributeGetMessageService" no-cache operation="getbyids" request-data={{_attributeMessageRequest}}
            on-response="_onAttributesMessageReceived" on-error="_onEntityGetFailed"></liquid-entity-govern-data-get>
        <liquid-entity-data-save name="attributeSaveDataService" operation="update" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
            on-response="_onSaveResponse"></liquid-entity-data-save>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_attributeModelRequest}}" 
            on-entity-model-composite-get-response = "_onCompositeModelGetResponse">
        </liquid-entity-model-composite-get>
        <div id="buttonContainer" align="center">
            <pebble-button id="cancel" class="btn btn-secondary m-r-10" button-text="Cancel" on-tap="_revertAll" elevation=1 raised></pebble-button>
            <pebble-button id="save" class="focus btn btn-success" button-text="Save" on-tap="_save" elevation=1 raised></pebble-button>
        </div>
    </template>
    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-attribute-manage',
                created: function () {
                    if (this.verbose)
                        console.log('attribute manage created');
                },
                attached: function () {
                    if (this.verbose)
                        console.log('attribute manage attached');
                },
                ready: function () {
                    if (this.verbose)
                        console.log('attribute manage ready');
                },
                properties: {
                        /**
                        * Indicates whether the attribute is rendered in the edit mode or view mode. 
                        * The two possible values are <b>view</b> and <b>edit</b>.
                        */
                        mode: {
                            type: String,
                            value: "view",
                            notify: true
                        },
                        contextData: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        configContext: {
                            type: Object,
                            value: function() {
                                return {};
                            }                        
                    },
                    /**
                     * Indicates the number of columns in which the attributes is rendered. Possible values are one, two,
                      and theree.
                     */
                    noOfColumns: {
                        type: Number,
                        value: 1
                    },
                    /**
                    * Indicates the request object that is passed to the data element to retrive the attribute data.
                      Sample: { 
                                action: "getAttributes" 
                              }
                    */
                    _attributeRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the response object that is received from the data element for the attribute `get request`.
                     */
                    _attributeResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                    * Indicates the request object that is passed to the data element to retrive attribute model data.
                      Sample: {
                              }
                    */
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return { };
                        }
                    },
                    /**
                     * Indicates the response object that is received from the data element for the attribute get request.
                     */
                    _attributeModelResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _saveRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _saveResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    showGroupName: {
                        type: Boolean,
                        value: false
                    },
                    groupName: {
                        type: String,
                        value: "My Attributes"
                    },
                    /**
                     * Specifies whether or not to write the logs.
                     */
                    verbose: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Indicates the attribute value objects which renders the attributes.
                     * JSON sample to be added here.
                     */
                    _attributeMessages: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    messageCodeMapping: {
                        type: Object,
                        value: function() {
                            return {
                                "Req001": "Required",
                                "MinLen001": "MIN_LENGTH",
                                "MaxLen001": "MAX_LENGTH",
                                "AlVal001": "ALLOWED_VALUES",
                                "Prec001": "Precision",
                                "Range001": "RANGE_FROM_INCLUSIVE",
                                "Range002": "RANGE_TO_INCLUSIVE",
                                "Range003": "RANGE_FROM_EXCLUSIVE",
                                "Range004": "RANGE_TO_EXCLUSIVE",
                                "Range005": "RANGE_TO_INCLUSIVE_FROM_EXCLUSIVE",
                                "Range006": "RANGE_TO_INCLUSIVE_FROM_INCLUSIVE",
                                "Range007": "RANGE_TO_EXCLUSIVE_FROM_EXCLUSIVE",
                                "Range008": "RANGE_TO_EXCLUSIVE_FROM_INCLUSIVE",
                                "133311": "Length should be greater than Width",
                                "133312": "Width should be less than Length"
                            };
                        }
                    },
                    _manageAttributeconfig: {
                        type: Object
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_attributeResponseChanged(_attributeResponse)',
                    '_contextChanged(contextData.ValContexts)',
                    '_modeChanged(mode)'
                ],
                ready: function() {
                    this._manageAttributeconfig = this.getParentAppConfig('rock-attribute-manage');
                },
                refresh: function() {
				    this._configContextChanged(this.getFirstValueContext());
			    },
                _modeChanged: function (mode) {
                    if (mode == 'edit') {
                        var width = Polymer.dom(this).parentNode.clientWidth;
                        this.$.buttonContainer.style.width = width + "px";
                        this.$.buttonContainer.style.display = "inline-block";
                    } else {
                        this.$.buttonContainer.style.display = "none";
                    }
                },
                _contextChanged: function (valueContexts) {
                    if (this.verbose) {
                        console.log("_configContextChanged context: " + JSON.stringify(contextData, null, 2));
                    }

                    if(_.isEmpty(valueContexts) || _.isEmpty(this.contextData) || _.isEmpty(this.configContext)) {
                        return;
                    }

                    if(this.configContext) {
                        this.groupName = this.configContext.groupName ? this.configContext.groupName : this.groupName;
                    }

                    var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                    this.set("_attributeModelRequest", compositeModelGetRequest);
                    var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                    if (liquidModelGet) {
                        liquidModelGet.generateRequest();
                    }
                },
                _onCompositeModelGetResponse: function (e) {
                    if (this.verbose) {
                        console.log("_attributeModelResponseChanged _attributeModelResponse: " + JSON.stringify(_attributeModelResponse, null, 2), +" entityId: " + entityId);
                    }

                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {

                        this._attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);

                        var attributeNames = Object.keys(this._attributeModels);

                        if (attributeNames.length > 0) {
                            var itemContext = this.getFirstItemContext();

                            //add attribute names in item context
                            itemContext.attributeNames = attributeNames;

                            var req = DataRequestHelper.createEntityGetRequest(this.contextData);

                            this.set("_attributeRequest", req);

                            var messageReq = DataHelper.cloneObject(req);

                            delete messageReq.params.query.valueContexts;

                            this.set("_attributeMessageRequest", messageReq);
                            var liquidGovernGet = this.$.attributeGetMessageService;
                            if (liquidGovernGet) {
                                liquidGovernGet.generateRequest();
                            }
                            var liquidDataGet = this.$$("[name=attributeGetDataService]");
                            if (liquidDataGet) {
                                liquidDataGet.generateRequest();
                            }
                        }
                    }
                },
                _onAttributesMessageReceived: function (e) {
                    //TODO: Needs to check with Vishal.
                    this._attributeMessages = {};
                    var res = e.detail.response;
                    var values = [];
                    var itemContext = this.getFirstItemContext();
                    var entityId;
                    if(itemContext) {
                        entityId = itemContext.id;
                    }
                    
                    var dataContext = {
                        "locale": this.locale,
                        "time": "now",
                        "source": this.source,
                        "list": this.list,
                        "classification": this.classification
                    };
                    var entity = DataHelper.findEntityById(res.content.entities, entityId);
                    if (!entity || !entity.data || !entity.data.attributes) {
                        this._attributeMessages = {};
                        return;
                    }
                 
                    var attributes = entity.data.attributes;
                    // var contexts = DataHelper.prepareCtx(dataContext);
                    // var valueContexts = DataHelper.prepareValCtx(dataContext);
                    // var attributes = SharedUtils.DataObjectFalcorUtil.getAttributesByCtx(entity, contexts);
                        var attrMessages = {};
                    for (var i in attributes) {
                        var messageCodes = this._getMessageCodes(attributes[i]);
                        var messages = this.getMessagesFromCodes(messageCodes);
                        if (messages && messages.length) {
                            attrMessages[i] = messages;
                        }
                    }
                    this.set('_attributeMessages', attrMessages);
                    
                },
                _onEntityGetFailed: function (e) {
                    console.error('Entity get failed with error: ', JSON.stringify(e));
                },
                _getMessageCodes: function (attribute) {
                    var messageCodes = [];
                    var properties = attribute.properties;
                    if (properties) {
                        var messages = properties.messages;
                        if(messages && messages.length > 0) {
                            for (var i=0; i< messages.length; i++) {
                                messageCodes.push(messages[i].messageCode);
                            }
                        }
                    }
                    return messageCodes;
                },

                getMessagesFromCodes:function (messageCodes) {
                    var messages=[];
                    if(messageCodes && messageCodes.length > 0) {
                        for(var i=0; i<messageCodes.length; i++){
                            var mes= this.messageCodeMapping[messageCodes[i]];
                            if(mes){
                                messages.push(mes);
                            } else{
                                messages.push("Error with Code: "+messageCodes[i])
                            }
                        }
                    }
                    return messages;
                },
                _attributeResponseChanged: function (_attributeResponse) {
                    if (this.verbose) {
                        console.log("_attributeResponseChanged _attributeResponse: " + JSON.stringify(
                            _attributeResponse, null, 2));
                    }

                    var attributes = [];
                    
                    if (DataHelper.validateGetEntitiesResponse(_attributeResponse) && this._attributeModels) {
                        var entity = _attributeResponse.content.entities[0];

                        if (entity) {
                            attributes = DataTransformHelper.transformAttributes(entity, this._attributeModels, this.contextData, "array");
                            //ToDo: read following through configuration to set rock title bar
                            //ToDo: this should happen from app-entity-manage
                            if (attributes.length > 1) {
                                this._setTitleBar(attributes);
                            }
                        }
                    }

                    //attributes = this._sortByViewName(attributes, this._attributeModels)

                    this._attributeValues = attributes;
                },
                _sortByViewName: function (values, models) {
                    var sortedValues = [];
                    var sortedModels = _.sortBy(models, function (o) { return o.viewName });

                    for (var i = 0; i < sortedModels.length; i++) {
                        var model = sortedModels[i];
                        for (var j = 0; j < values.length; j++) {
                            var value = values[j];
                            if (value.name === model.name) {
                                sortedValues.push(value);
                            }
                        }
                    }

                    return sortedValues;
                },
                _save: function () {
                    //TODO: Needs to check with Vishal.
                    var mainApp = document.querySelector('#app');

                    mainApp.$$("#pebbleAppToast").fitInto = mainApp.$$("#toastArea");

                    //check if any changes
                    //if none, then return operationResult with warning message else proceed
                    var attributeList = Polymer.dom(this).node.$$('rock-attribute-list');

                    //If have errors return
                    if(!this._manageAttributeconfig.allowSaveOnValidationErrors && this._haveErrors(attributeList))
                    {
                        return;
                    }

                    var changedAttributeElements = attributeList.getChangedAttributeElements();
                    if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                        mainApp.toastText = "No changes to save";
                        var toastElement = mainApp.$$("#pebbleAppToast");
                        toastElement.toastType = "information";
                        toastElement.heading = "Information";
                        toastElement.autoClose = true;
                        toastElement.show();
                        return {
                            "message": "No changes to save"
                        }; //TODO: Prepare OR
                    }

                    //TODO: Temporary, need to send all the attributes for save as API is not supporting delta comparion within entity content and replacing complete entity object...
                    //changedAttributeElements = attributeList.root.querySelectorAll('rock-attribute');

                    //validate - if error then return operationResult, else proceed
                    //prepare attribute JSON from changed attributes
                    var attributesJSON = [];
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        var attributeJSON = attributeElement.attributeObject;
                        attributesJSON.push(attributeJSON);
                    }

                    if (this.verbose) {
                        console.log('_save attributesJSON: ', JSON.stringify(attributesJSON, null, 2));
                    }
                    var newEntity = {};
                    if (this._attributeResponse && this._attributeResponse.content && this._attributeResponse.content.entities && this._attributeResponse.content.entities.length > 0) {
                        var originalEntity = this._attributeResponse.content.entities[0];
                        newEntity = DataTransformHelper.prepareEntityForAttributesSave(originalEntity, attributesJSON, this.contextData);
                    }

                    if (!_.isEmpty(newEntity)) {
                        //set requestObject for save liquid
                        this._saveRequest = {
                            "entities": [newEntity]
                        };
                        var liquidSave = this.$$("[name=attributeSaveDataService]");
                        if (liquidSave) {
                            liquidSave.generateRequest();
                        }
                    }

                    //this return isnt useful for now
                    return newEntity;
                },
                _haveErrors: function(attributeList) {
                    var _attributes = Polymer.dom(attributeList.root).querySelectorAll('rock-attribute');

                    for (var i = 0; i < _attributes.length; i++)
                    {
                        if(_attributes[i].validationErrors.length > 0)
                        {
                            return true;
                        }
                    }

                    return false;
                },
                _onSaveResponse: function (e) {
                    var mainApp = document.querySelector('#app');
                    var liquidGet = this.$$("[name=attributeGetDataService]");
                    if (liquidGet) {
                        this.mode = "view";
                        var attributeList = Polymer.dom(this).node.$$('rock-attribute-list');
                        attributeList.resetChanged();
                        liquidGet.generateRequest();
                    }
                    var liquidGovernGet = this.$.attributeGetMessageService;
                    if (liquidGovernGet) {
                        liquidGovernGet.generateRequest();
                    }
                    mainApp.toastText = "Attribute Data saved successfully!!";
                    var toastElement = mainApp.$$("#pebbleAppToast");
                    toastElement.toastType = "success";
                    toastElement.heading = "Success";
                    toastElement.autoClose = true;

                    toastElement.show();
                    //Raise event on attributes save
                    this.fireBedrockEvent("on-attribute-save", null, { ignoreId: true });
                },
                _revertAll: function () {
                    var attributeList = Polymer.dom(this).node.$$('rock-attribute-list');
                    attributeList.revertAll();
                    this.mode = "view";
                },
                _setTitleBar: function (values) {
                    var mainApp = document.querySelector('main-app');
                    if (mainApp) {
                        var contentViewMgr = mainApp.$$("rock-content-view-manager");
                        if (contentViewMgr) {
                            var activeContentView = contentViewMgr.$.contentViewManager.querySelector(
                                "rock-content-view:not([hidden])");
                            if (activeContentView) {
                                var contentComponent = activeContentView.$$("app-entity-manage");
                                if (contentComponent) {
                                    contentComponent.setTitleBar(values);
                                }
                            }
                        }
                    }
                },
                /**
                 * Can be used to get the elements if they are dirty.
                 */
                getIsDirty: function () {
                    var attributeList = this.$$("rock-attribute-list");
                    if (attributeList && attributeList.getIsDirty) {
                        return attributeList.getIsDirty();
                    }
                }
            });
        })();
    </script>
</dom-module>