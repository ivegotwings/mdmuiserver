<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">

<!--
`rock-relationship-attribute-manage` Represents the component to manage the relationship attribute values.
It renders the `rock-attribute-list` with the specified context parameters.
It is responsible to "get" and "save" the relationship attributes.

@demo demo/index.html
-->
<dom-module id="rock-relationship-attribute-manage">
    <template>
        <style include="bedrock-style-common">
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    background: var(--white);
                    border: 1px solid var(--cloudy-blue-color);
                    font-size: 15px;
                }
            }

            .focus {
                --pebble-button: {
                    height: 30px;
                    min-width:75px;
                    font-size: 15px;
                    background: var(--button-bg-color);
                    color: var(--white);
                }
            }

            .defaultButton {
                position: absolute;
                left: 15%;
                padding: 0;
                text-align: center;
                bottom:40px;
            }

            .dataFunctionButton {
                width: 100%;
                bottom: 0;
                padding: 20px 0;
                text-align: center;
                z-index: 9999;
            }

            pebble-dialog {
                --dialog-component: {
                    width: 400px;
                    top: 20% !important;
                }
            }

            #errorsDialog {
                --popup-header-color: var(--palette-pinkish-red, #ee204c);
            }

            pebble-button#skip {
                --pebble-button-paper-style: {
                    color: var(--secondary-button-text-color, #75808b);
                    background-color: var(--secondary-button-color, #ffffff);
                    border: 1px solid var(--secondary-button-border-color, #c1cad4);
                    font-weight: var(--font-bold, bold);
                    height: 30px;
                }
            }

            pebble-button#ok {
                --pebble-button-paper-style: {
                    color: var(--button-text-color, #ffffff);
                    background-color: var(--success-button-color, #09c021);
                    border-color: var(--success-button-color, #09c021);
                    font-weight: var(--font-bold, bold);
                    height: 30px;
                }
            }
        </style>
        <pebble-dialog id="errorsDialog" modal small vertical-offset=1 50 horizontal-align="auto" vertical-align="auto" no-cancel-on-outside-click
            no-cancel-on-esc-key dialog-title="Errors on page">
            <p>Found below errors in entity details: </p>
            <ul>
                <template is="dom-repeat" items="[[_syncValidationErrors]]">
                    <li>[[item.attributeExternalName]] with error: [[item.message]]</li>
                </template>
            </ul>
            <p>Do you want to fix the errors or continue?</p>
            <div class="buttons">
                <pebble-button id="skip" button-text="Skip & Continue" on-tap="_skipServerErrors"></pebble-button>
                <pebble-button id="ok" button-text="Fix" on-tap="_fixServerErrors"></pebble-button>
            </div>
        </pebble-dialog>
        <pebble-dialog id="cancelDialog" dialog-title="Confirmation" modal show-cancel show-ok no-cancel-on-outside-click no-cancel-on-esc-key
            small>
            <p>Are you sure you want to discard the unsaved changes.</p>
        </pebble-dialog>
        <bedrock-pubsub event-name="on-buttonok-clicked" handler="_revertAll" target-id="cancelDialog"></bedrock-pubsub>
        <rock-attribute-list context-data="[[contextData]]" readonly$="[[readonly]]" show-group-name$=[[showGroupName]] group-name="[[groupName]]" attribute-values="[[_attributeValues]]"
            attribute-models="[[relationshipAttributeModels]]" no-of-columns="[[noOfColumns]]" mode="{{mode}}" attribute-messages="{{_attributeMessages}}"></rock-attribute-list>
        <liquid-entity-data-get name="attributeGetDataService" operation="getbyids" request-data="{{_attributeRequest}}" last-response="{{_attributeResponse}}"></liquid-entity-data-get>
        <liquid-entity-govern-data-get id="attributeGetMessageService" operation="getbyids" request-data={{_attributeMessageRequest}}
            on-response="_onAttributesMessageReceived" on-error="_onEntityGetFailed"></liquid-entity-govern-data-get>
        <liquid-entity-data-save name="attributeSaveDataService" operation="[[_entityDataOperation]]" request-data="{{_saveRequest}}"
            last-response="{{_saveResponse}}" on-response="_onSaveResponse" on-error="_onSaveError"></liquid-entity-data-save>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_attributeModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse">
        </liquid-entity-model-composite-get>
        <liquid-rest id="entityGovernService" url="/data/pass-through/entitygovernservice/validate" method="POST" request-data={{_entityGovernRequest}}
            on-liquid-response="_onEntityGovernResponse" on-liquid-error="_onEntityGovernFailed">
        </liquid-rest>
        <template is="dom-if" if="[[_showNoAttributeMessage]]">
            <div align="center"> No attributes Found</div>
        </template>
        <div id="buttonContainer" hidden align="center" class="defaultButton">
            <pebble-button id="cancel" class="btn btn-secondary m-r-10" button-text="Cancel" on-tap="_openCancelDialog" elevation=1 raised></pebble-button>
            <pebble-button id="save" class="focus btn btn-success" disabled$="[[readonly]]" button-text="Save" on-tap="_save" elevation=1 raised></pebble-button>
        </div>
    </template>
    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-relationship-attribute-manage',
                attached: function () {
                    this.logInfo("RelationshipAttributeManageAttached");
                },
                ready: function () {
                    this.messageCodeMapping = this.getParentAppConfig('rock-relationship-attribute-manage', '', 'messageCodeMapping');
                    this.logInfo("AttributeManageReady");
                },
                properties: {
                    /**
                     * Indicates whether the attribute is rendered in the "edit" mode or "view mode.
                     * The two possible values are <b>view</b> and <b>edit</b>.
                     */
                    mode: {
                        type: String,
                        value: "view",
                        notify: true
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    configContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the number of columns in which the attributes are rendered. Possible values are one, two,
                     and three.
                     */
                    noOfColumns: {
                        type: Number,
                        value: 1
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    allowSaveOnError: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    doSyncValidation: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    successMessage: {
                        type: String,
                        value: ''
                    },
                    /**
                     * Indicates the request object that is passed to the data element to retrive the attribute data.
                     Sample: {
                                action: "getAttributes"
                              }
                     */
                    _attributeRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the response object that is received from the data element for the attribute `get request`.
                     */
                    _attributeResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the request object that is passed to the data element to retrive attribute model data.
                     Sample: {
                              }
                     */
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the response object that is received from the data element for the attribute get request.
                     */
                    _attributeModelResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _saveRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _saveResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    relationshipAttributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    showGroupName: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    groupName: {
                        type: String,
                        value: "Relationship Attributes"
                    },
                    /**
                     * Specifies whether or not to write the logs.
                     */
                    verbose: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Indicates the attribute value objects which renders the attributes.
                     * JSON sample to be added here.
                     */
                    _attributeMessages: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    messageCodeMapping: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _syncValidationErrors: {
                        type: Array,
                        value: function () { return []; }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    functionalMode: {
                        type: "String",
                        value: "default"
                    },
                    _showNoAttributeMessage: {
                        type: Boolean,
                        value: false
                    },
                    _entityDataOperation: {
                        type: String,
                        value: 'update'
                    },
                    _relationshipName: {
                        type: String
                    },
                    _relationshipId: {
                        type: String
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_attributeResponseChanged(_attributeResponse)',
                    '_contextChanged(contextData.ValContexts)',
                    '_modeChanged(mode)'
                ],

                _getButtonsClass: function (functionalMode) {
                    if (functionalMode == "dataFunction") {
                        return "dataFunctionButton";
                    } else {
                        return "defaultButton"
                    }
                },
                _modeChanged: function (mode) {
                    if (mode != undefined) {
                        if (mode == 'edit') {
                            this.$.buttonContainer.hidden = false;
                        } else {
                            this.$.buttonContainer.hidden = true;
                        }
                    }
                },
                _contextChanged: function (valueContexts) {
                    this.logInfo("AttributeManageContextChange", "contextData", JSON.stringify(this.contextData, null, 2));

                    if (_.isEmpty(valueContexts) || _.isEmpty(this.contextData)) {
                        return;
                    }

                    if (this.configContext) {
                        this.groupName = this.configContext.groupName ? this.configContext.groupName : this.groupName;
                    }
                    var itemContext = this.contextData[ContextHelper.CONTEXT_TYPE_ITEM][0];
                    itemContext.attributeNames = [];
                    if (!itemContext || !itemContext.relationships || !itemContext.relationshipAttributes) {
                        return;
                    }
                    this._relationshipName = itemContext.relationships[0];
                    this._relationshipId = itemContext.relationshipId;
                    var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                    this.set("_attributeModelRequest", compositeModelGetRequest);
                    var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                    if (liquidModelGet && compositeModelGetRequest) {
                        liquidModelGet.generateRequest();
                    }
                },
                _onCompositeModelGetResponse: function (e) {
                    var itemContext = this.getFirstItemContext();
                    if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                        var relType = "";
                        if (e.detail.request) {
                            relType = e.detail.request.requestData.params.fields.relationships[0];
                        }
                        var compositeModel = e.detail.response.content.entityModels[0];
                        if (relType && compositeModel && compositeModel.data) {
                            var relationships = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);

                            if (relationships && relationships[relType]) {
                                var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;
                                this._selfContext = relationships[relType].selfContext;
                                if (rel && rel.attributes) {
                                    var relData = {};
                                    relData.data = {};
                                    relData.data.attributes = rel.attributes;
                                    this.relationshipAttributeModels = DataTransformHelper.transformAttributeModels(relData, this.contextData);;
                                    var attributeNames = Object.keys(this.relationshipAttributeModels);
                                    if (attributeNames.length > 0) {
                                        //add attribute names in item context
                                        itemContext.relationshipAttributes = attributeNames;

                                        var req = DataRequestHelper.createEntityGetRequest(this.contextData);

                                        this.set("_attributeRequest", req);

                                        var messageReq = DataHelper.cloneObject(req);

                                        delete messageReq.params.query.valueContexts;

                                        this.set("_attributeMessageRequest", messageReq);
                                        var liquidGovernGet = this.$.attributeGetMessageService;
                                        if (liquidGovernGet) {
                                            liquidGovernGet.generateRequest();
                                        }
                                        var liquidDataGet = this.shadowRoot.querySelector("[name=attributeGetDataService]");
                                        if (liquidDataGet) {
                                            liquidDataGet.generateRequest();
                                        }
                                        this._showNoAttributeMessage = false;
                                    } else {
                                        if (this.functionalMode == "dataFunction") {
                                            this._showNoAttributeMessage = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                _onAttributesMessageReceived: function (e) {
                    this._attributeMessages = {};
                    var res = e.detail.response;
                    var itemContext = this.getFirstItemContext();
                    var entityId;
                    if (itemContext) {
                        entityId = itemContext.id;
                    }
                    var entity = DataHelper.findEntityById(res.content.entities, entityId);
                    if (!entity || !entity.data || !entity.data.attributes) {
                        this._attributeMessages = {};
                        return;
                    }
                    var relationshipId=this._relationshipId;
                    var relationships=entity.data.relationships;
                    var relationshipEntities=relationships[this._relationshipName];
                    var relationship=relationshipEntities.find(function (rel) {
                        return rel.relTo.id==relationshipId;
                    });
                    if (relationship) {
                        var attributes = relationship.attributes;
                        var attrMessages = MessageHelper.getAttributeMessages(attributes, this.relationshipAttributeModels, this.messageCodeMapping, this.localize);
                        this.set('_attributeMessages', attrMessages);
                    } else {
                        this._attributeMessages = {};
                    }
                },
                _onEntityGetFailed: function (e) {
                    this.logError("RelationshipAttributeManageGetFail", e);
                },
                _attributeResponseChanged: function (_attributeResponse) {
                    this.logInfo("RelationshipAttributeManageResponseChange", "response", JSON.stringify(_attributeResponse, null, 2));

                    var attributes = [];

                    if (DataHelper.validateGetEntitiesResponse(_attributeResponse) && this.relationshipAttributeModels) {
                        var entity = _attributeResponse.content.entities[0];
                        var relationships = EntityHelper.getRelationshipsBasedOnContext(entity, this.getFirstDataContext(), this._selfContext);
                        var relationshipId=this._relationshipId;
                        if (relationships && !_.isEmpty(relationships)) {
                            var relationshipEntities=relationships[this._relationshipName];
                            var relationship=relationshipEntities.find(function (rel) {
                                return rel.relTo.id==relationshipId;
                            });
                            var relData={"data":{}};
                            if(relationship) {
                                relData.data.attributes = relationship.attributes;
                            }
                            attributes = DataTransformHelper.transformAttributes(relData, this.relationshipAttributeModels, this.contextData, "array", true);
                            //Removed the code for rock-title bar
                        }
                    }
                    this._attributeValues = attributes;
                },
                _save: function (e) {
                    //TODO: Needs to check with Vishal.
                    if(e.currentTarget.disabled == true){
                        return;
                    }
                    var mainApp = document.querySelector('#app');

                    mainApp.shadowRoot.querySelector("#pebbleAppToast").fitInto = mainApp.shadowRoot.querySelector("#toastArea");

                    //check if any changes
                    //if none, then return operationResult with warning message else proceed
                    var attributeList = this.shadowRoot.querySelector('rock-attribute-list');

                    //If have errors return
                    if (!this.allowSaveOnError && attributeList.hasModelErrors()) {
                        this.showErrorToast("Cannot save the entity, please resolve the errors.");
                        return;
                    }

                    var changedAttributeElements = attributeList.getChangedAttributeElements();
                    if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                        mainApp.toastText = "No changes to save";
                        var toastElement = mainApp.shadowRoot.querySelector("#pebbleAppToast");
                        toastElement.toastType = "information";
                        toastElement.heading = "Information";
                        toastElement.autoClose = true;
                        toastElement.show();
                        return {
                            "message": "No changes to save"
                        };
                    }

                    var attributesJSON = [];
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        var attributeJSON = attributeElement.attributeObject;
                        attributesJSON.push(attributeJSON);
                    }

                    var firstItemContext = this.getFirstItemContext();
                    var relationshipName = firstItemContext.relationships[0];
                    var relationshipId = firstItemContext.relationshipId;
                    this.logInfo("AttributeManageSave", "attributes", JSON.stringify(attributesJSON, null, 2));
                    var firstValueContext = this.getFirstValueContext();
                    var newEntity = {};
                    if (this._attributeResponse && this._attributeResponse.content && this._attributeResponse.content.entities && this._attributeResponse.content.entities.length > 0) {
                        var originalEntity = this._attributeResponse.content.entities[0];
                        newEntity = DataHelper.cloneObject(originalEntity);
                        var relationships = EntityHelper.getRelationshipByType(newEntity, this.getFirstDataContext(), relationshipName, this._selfContext);
                        var relationship=relationships.find(function (rel) {
                            return rel.relTo.id==relationshipId;
                        });
                        if (relationship) {
                            var attributes = {};
                            for (var i = 0; i < attributesJSON.length; i++) {
                                var attributeJSON = attributesJSON[i];
                                var attr = DataTransformHelper.createAttributeInstance(attributeJSON, firstValueContext);
                                attributes[attributeJSON.name] = attr;
                            }
                            relationship.attributes = attributes;
                        }
                        this._entityDataOperation = "update";

                        if (!_.isEmpty(newEntity)) {
                            //set requestObject for save liquid
                            this._saveRequest = {
                                "entities": [newEntity]
                            };
                            if (this.functionalMode == "quickManage") {
                                var clientState = {};
                                clientState.notificationInfo = {};
                                clientState.notificationInfo.showNotificationToUser = false;
                                this._saveRequest["clientState"] = clientState;
                            }
                            if (this.doSyncValidation) {
                                var req = DataRequestHelper.createSyncValidationRequest(newEntity.id, newEntity.type, newEntity.data);

                                this.set("_entityGovernRequest", req);
                                var liquidGovernGet = this.$.entityGovernService;
                                if (liquidGovernGet) {
                                    liquidGovernGet.generateRequest();
                                }
                            } else {
                                this._saveEntity();
                            }
                        }

                    }

                    //this return isnt useful for now
                    return newEntity;
                },
                _saveEntity: function () {
                    var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");
                    if (liquidSave) {
                        liquidSave.generateRequest();
                    }
                },
                _onSaveResponse: function (e) {
                    var mainApp = document.querySelector('#app');
                    var liquidGet = this.shadowRoot.querySelector("[name=attributeGetDataService]");
                    var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");

                    if (liquidGet) {
                        this.mode = "view";
                        var attributeList = this.shadowRoot.querySelector('rock-attribute-list');
                        attributeList.resetChanged();
                        liquidGet.generateRequest();
                    }

                    if (!(liquidSave && liquidSave.operation == 'create')) {
                        var liquidGovernGet = this.$.attributeGetMessageService;
                        if (liquidGovernGet) {
                            liquidGovernGet.generateRequest();
                        }
                    }

                    var message = this.successMessage ? this.successMessage : "Attribute save request is submitted successfully!!";
                    this.showSuccessToast(message, 10000);

                    //Raise event on attributes save
                    this.fireBedrockEvent("on-attribute-save", null, { ignoreId: true });
                    if (this.functionalMode == "dataFunction") {
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName
                        };
                        this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                    }
                },
                _onSaveError: function (e) {
                    var reason = e.detail.response.reason;
                    this.showErrorToast(reason, 10000);
                },
                _openCancelDialog: function () {
                    if (this.getIsDirty()) {
                        this.shadowRoot.querySelector("#cancelDialog").open();
                    } else {
                        this._revertAll();
                    }
                },
                _revertAll: function () {
                    if (this.functionalMode == "dataFunction") {
                        var eventName = "onSkip";
                        var eventDetail = {
                            name: eventName
                        };
                        this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                    } else {
                        var attributeList = this.shadowRoot.querySelector('rock-attribute-list');
                        attributeList.revertAll();
                        this.mode = "view";
                        this._resetErrors();
                    }
                },
                _resetErrors: function () {
                    if (this.shadowRoot.querySelector('rock-attribute-list')) {
                        this.shadowRoot.querySelector('rock-attribute-list').updateDependentAttributesAndResetErrors();
                    }
                },
                _onEntityGovernResponse: function (e) {
                    if (e && e.detail && e.detail.response && e.detail.response.response && e.detail.response.response.status == "success") {
                        var res = e.detail.response.response;
                        var itemContext = this.getFirstItemContext();
                        var entityId;
                        if (itemContext) {
                            entityId = itemContext.id;
                        }
                        var entity = DataHelper.findEntityById(res.entities, entityId);
                        var attrMessages = {};
                        if (entity && entity.data && entity.data.relationships) {
                            var relationships = entity.data.relationships;
                            var relationshipEntities = relationships[this._relationshipName];
                            if (relationshipEntities && relationshipEntities.length) {
                                var relationship = relationshipEntities.find(function (rel) {
                                    return rel.id == this._relationshipId;
                                });
                                if (relationship) {
                                    var attributes = relationship.attributes;
                                    attrMessages = MessageHelper.getAttributeMessages(attributes, this.relationshipAttributeModels, this.messageCodeMapping, this.localize);
                                }
                            }
                        }
                        if (!_.isEmpty(attrMessages)) {
                            var errorMessages = MessageHelper.getErrorsFromAttrMessages(attrMessages, this.relationshipAttributeModels);
                            this.set("_syncValidationErrors", errorMessages);
                            this.shadowRoot.querySelector('#errorsDialog').open();
                            return;
                        } else {
                            this._saveEntity();
                        }
                    } else {
                        this.logWarning("AttributeManageValidationFail", "response", JSON.stringify(e.detail));
                        this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                    }
                },
                _onEntityGovernFailed: function (e) {
                    this.logWarning("RelationshipAttributeManageGovernFail", e);
                    this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                },
                _skipServerErrors: function () {
                    var errorDialog = this.$.errorsDialog;
                    if(errorDialog) {
                        errorDialog.close();
                    }
                    this._saveEntity();
                },
                _fixServerErrors: function () {
                    var errorDialog = this.$.errorsDialog;
                    if(errorDialog) {
                        errorDialog.close();
                    }
                    if (this._syncValidationErrors) {
                        var newAttributeMessages = {};
                        for (var i = 0; i < this._syncValidationErrors.length; i++) {
                            var attributeMessages = this._syncValidationErrors[i];
                            var attributeName = attributeMessages.attributeName;
                            var message = attributeMessages.message;
                            if (attributeName && message) {
                                var newMessages = [];
                                newAttributeMessages[attributeName] = newMessages;
                                if (newMessages.indexOf(message) < 0) {
                                    newMessages.unshift(message);
                                }
                            }
                        }
                    }
                    this.set('_attributeMessages', newAttributeMessages);
                    this._resetErrors();
                },
                /**
                 * Can be used to get the elements if they are dirty.
                 */
                getIsDirty: function () {
                    var attributeList = this.shadowRoot.querySelector("rock-attribute-list");
                    if (attributeList && attributeList.getIsDirty) {
                        return attributeList.getIsDirty();
                    }
                }              
            });
        })();
    </script>
</dom-module>