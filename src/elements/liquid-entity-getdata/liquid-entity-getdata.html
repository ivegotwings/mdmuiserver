<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-behavior/liquid-behavior.html">
<!--
`liquid-entity-getdata`
Boolean control

@demo demo/index.html 
-->
<dom-module id="liquid-entity-getdata">
    <template>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-entity-getdata',
                behaviors: [RUFBehaviors.LiquidBehavior],
                attached: function () {
                },
                ready: function () {
                },
                properties: {
                    _dataChannelName: {
                        type: String,
                        value: "entityDataChannel",
                        readonly: true
                    }
                },
                _executeRequest: function (model, request) {
                    var op = request.operation,
                        reqId = request.requestId === undefined ? '' : request.requestId,
                        reqData = request.requestData;

                    if (op === 'initiatesearch') {
                        return this._callInitiateSearch(model, reqData);
                    } else if (op === 'getsearchresultdetail') {
                        return this._callSearchResultDetail(model, request);
                    } else if (op === 'getentities') {
                        return this._callGetEntities(model, reqData);
                    }
                    else {
                        throw 'exception: operation ' + op + ' is not supported in ' + this.is + ' element.';
                    }
                },
                _formatResponse: function(request, rawResponsePkg){
                    var op = request.operation;

                    if (op === 'initiatesearch') {
                        var resSearchResultId = Object.keys(rawResponsePkg.json.searchResults)[0];
                        return rawResponsePkg.json.searchResults[resSearchResultId];
                    } else if (op === 'getentities' || op === 'getsearchresultdetail') {
                        var pathRootKey = "entitiesById";
                        var entities = rawResponsePkg.json[pathRootKey];
                        this._formatEntityData(entities);
                        return {'entities': entities};
                    }
                },
                _callGetEntities: function (model, reqData, entityIds) {
                    if (reqData === undefined || reqData.data === undefined) {
                        return;
                    }

                    if (this.verbose) {
                        console.log('Request for get entities call...request: ', reqData, ' entityIds: ', entityIds);
                    }

                    if ((!entityIds || entityIds.length == 0) && reqData.data && reqData.data.query && reqData.data.query.id) {
                        entityIds = [];
                        entityIds.push(reqData.data.query.id);
                    }

                    if (!entityIds || entityIds.length == 0) {
                        throw "Cannot find entityIds for get request";
                        return;
                    }

                    var contextKeys = this._createContextKeys(reqData);

                    var attrs = reqData.data.fields.attributes;

                    var pathRootKey = "entitiesById";

                    var path1 = [pathRootKey, entityIds, ['id', 'dataObjectInfo', 'systemInfo', 'properties']];
                    var path2 = [pathRootKey, entityIds, "data", "ctxInfo", contextKeys, "attributes", attrs, "values"];

                    return model.get(path1, path2);
                },
                _callInitiateSearch: function (model, reqData) {
                   return model.call(["searchResults", "create"], [reqData], [], []);
                },
                _callSearchResultDetail: function (model, request) {
                    var self = this,
                        reqId = request.requestId === undefined ? '' : request.requestId,
                        reqData = request.requestData,
                        totalRecords = 0;

                    if(reqId === ''){
                        return {}; // this means do nothing..
                    }

                    if (this.verbose) {
                        console.log('Request Id for get search result detail: ', reqId);
                    }

                    var totalRecordsResponse = this._callSearchResultTotalRecordsGet(model, reqId);
                    totalRecordsResponse.then(function (totalRecordsPkg) {
                        totalRecords = totalRecordsPkg.json.searchResults[reqId].totalRecords;

                        var from = 0;
                        var to = 1000;
                        var to1 = (to + 1) < totalRecords ? to : totalRecords - 1; // make sure to range is < total records

                        var entityIdsGetModelResponse = self._callSearchResultEntityIdsGet(model, reqId, from, to1);
                        entityIdsGetModelResponse.then(function (responsePkg) {
                            if (responsePkg !== undefined) {
                                var entities = responsePkg.json.searchResults[reqId].entities;
                                var entityIds = [];
                                for (var e in entities) {
                                    entityIds.push(entities[e].id);
                                }

                                if (entityIds.length > 0) {
                                    var getEntitiesModelResponse = self._callGetEntities(model, reqData, entityIds);
                                    return self._handleModelResponse(request, getEntitiesModelResponse);
                                }
                            }
                        });
                    });
                },
                _callSearchResultTotalRecordsGet: function(model, reqId, reqData){
                    return model.get(["searchResults", reqId, "totalRecords"]);
                },
                _callSearchResultEntityIdsGet: function(model, reqId, from, to){
                    return model.get(["searchResults", reqId, "entities", [{ 'from': from, 'to': to }]]);
                },
                _createContextKeys: function (reqData) {
                    var contextKeys = []
                    var self = this;
                    reqData.data.query.ctx.forEach(function (ctxGroup) {
                        reqData.data.query.valCtx.forEach(function (valCtxGroup) {
                            var ctxGroupUI = {  'list': ctxGroup.list, 
                                                'classification': ctxGroup.classification, 
                                                'source': valCtxGroup.source, 
                                                'locale': valCtxGroup.locale};
                            var ctxKey = self.createContextKey(ctxGroupUI);
                            contextKeys.push(ctxKey);
                        });
                    });

                    return contextKeys;
                },
                getEntityCtxDataByGroupObj: function(entity, ctxGroup){
                    var ctxInfoItem = {};
                    if(ctxGroup && ctxGroup.list){
                        var ctxKey = this.createContextKey(ctxGroup);
                        ctxInfoItem = this.getEntityContextInfoByKey(entity, ctxKey);
                    }

                    return ctxInfoItem;
                },
                getEntityCtxDataByKey: function(entity, ctxKey){
                    var ctxInfoItem = {};
                 
                    if(entity && entity.data && entity.data.ctxInfo && entity.data.ctxInfo[ctxKey]){
                        ctxInfoItem = entity.data.ctxInfo[ctxKey];
                    }

                    return ctxInfoItem;
                },
                createContextKey: function (ctxGroup) {
                    return "".concat(ctxGroup.list, '#@#', ctxGroup.classification, '#@#', ctxGroup.source, '#@#', ctxGroup.locale);                    
                },
                _populateContextGroups: function (entity) {
                    if (entity.data && entity.data.ctxInfo) {
                        var ctxKeys = Object.keys(entity.data.ctxInfo);
                        for (var i in ctxKeys) {
                            var ctxKey = ctxKeys[i];
                            var ctxInfoItem = entity.data.ctxInfo[ctxKey];
                            
                            var ctxKeySegments = ctxKey.split('#@#');

                            var ctxGroupUI = {
                                list: ctxKeySegments[0],
                                classification: ctxKeySegments[1],
                                source: ctxKeySegments[2],
                                locale: ctxKeySegments[3]
                            };

                            ctxInfoItem["ctxGroup"] = ctxGroupUI;
                        }
                    }
                },
                _formatEntityData: function(entities){
                    for(var entityId in entities){
                        var entity = entities[entityId];
                        this._populateContextGroups(entity);
                    }
                }
            });
        })();
    </script>
</dom-module>