<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-behavior/liquid-behavior.html">
<!--
`liquid-entity-getdata`
Boolean control

@demo demo/index.html 
-->
<dom-module id="liquid-entity-getdata">
    <template>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-entity-getdata',
                behaviors: [RUFBehaviors.LiquidBehavior],
                attached: function () { 
                },
                ready: function () { 
                },
                properties: {
                },
                _executeRequest: function (model, request) {
                    var op = request.operation,
                        reqId = request.requestId === undefined ? '' : request.requestId,
                        reqData = request.requestData;

                    if (op === 'initiatesearch') {
                        return this._callInitiateSearch(model, reqData);
                    } else if (op === 'getsearchresultdetail') {
                        return this._callSearchResultDetail(model, request);
                    } else if (op === 'getentities') {
                        return this._callGetEntities(model, reqData);
                    }
                    else {
                        throw 'exception: operation ' + op + ' is not supported in ' + this.is + ' element.';
                    }
                },
                _formatResponse: function(request, rawResponsePkg){
                    var op = request.operation;

                    if (op === 'initiatesearch') {
                        var resSearchResultId = Object.keys(rawResponsePkg.json.searchResults)[0];
                        return rawResponsePkg.json.searchResults[resSearchResultId];
                    } else if (op === 'getentities' || op === 'getsearchresultdetail') {
                        var pathRootKey = "entitiesById";
                        return { 'entities': rawResponsePkg.json[pathRootKey] };
                    }
                },
                _callGetEntities: function (model, reqData, entityIds) {
                    if (reqData === undefined || reqData.data === undefined) {
                        return;
                    }

                    if (this.verbose) {
                        console.log('Request for get entities call...request: ', reqData, ' entityIds: ', entityIds);
                    }

                    if ((!entityIds || entityIds.length == 0) && reqData.data && reqData.data.query && reqData.data.query.id) {
                        entityIds = [];
                        entityIds.push(reqData.data.query.id);
                    }

                    if (!entityIds || entityIds.length == 0) {
                        throw "Cannot find entityIds for get request";
                        return;
                    }
                    
                    var contextKeys = this._createContextKeys(reqData);
                    
                    var attrs = reqData.data.fields.attributes;

                    var pathRootKey = "entitiesById";

                    var path1 = [pathRootKey, entityIds, ['id', 'dataObjectInfo', 'systemInfo', 'properties']];
                    var path2 = [pathRootKey, entityIds, "data", "ctxInfo", contextKeys, "attributes", attrs, "values"];

                    return model.get(path1, path2);
                },
                _callInitiateSearch: function (model, reqData) {
                   return model.call(["searchResults", "create"], [reqData], [], []);
                },
                _callSearchResultDetail: function (model, request) {
                    var self = this,
                        reqId = request.requestId === undefined ? '' : request.requestId,
                        reqData = request.requestData,
                        totalRecords = 0;                    

                    if(reqId === ''){
                        return {}; // this means do nothing..
                    }
                    
                    if (this.verbose) {
                        console.log('Request Id for get search result detail: ', reqId);
                    }

                    var totalRecordsResponse = this._callSearchResultTotalRecordsGet(model, reqId);
                    totalRecordsResponse.then(function (totalRecordsPkg) {
                        totalRecords = totalRecordsPkg.json.searchResults[reqId].totalRecords;
                        
                        var from = 0;
                        var to = 1000;
                        var to1 = (to + 1) < totalRecords ? to : totalRecords - 1; // make sure to range is < total records
                        
                        var entityIdsGetModelResponse = self._callSearchResultEntityIdsGet(model, reqId, from, to1);
                        entityIdsGetModelResponse.then(function (responsePkg) {  
                            if (responsePkg !== undefined) {
                                var entities = responsePkg.json.searchResults[reqId].entities;
                                var entityIds = [];
                                for (var e in entities) {
                                    entityIds.push(entities[e].id);
                                }

                                if (entityIds.length > 0) {
                                    var getEntitiesModelResponse = self._callGetEntities(model, reqData, entityIds);
                                    return self._handleModelResponse(request, getEntitiesModelResponse);
                                }
                            }
                        });
                    });
                },
                _callSearchResultTotalRecordsGet: function(model, reqId, reqData){
                    return model.get(["searchResults", reqId, "totalRecords"]);
                },
                _callSearchResultEntityIdsGet: function(model, reqId, from, to){
                    return model.get(["searchResults", reqId, "entities", [{ 'from': from, 'to': to }]]);
                },
                _createContextKeys: function (reqData) {
                    var contextKeys = []
                    reqData.data.query.ctx.forEach(function (ctxGroup) {
                        reqData.data.query.valCtx.forEach(function (valCtxGroup) {
                            var contextKey = "".concat(ctxGroup.list, '#@#', ctxGroup.classification,
                                '#@#', valCtxGroup.source, '#@#', valCtxGroup.locale
                            );
                            contextKeys.push(contextKey);
                        });
                    });

                    return contextKeys;
                }
            });
        })();
    </script>
</dom-module>