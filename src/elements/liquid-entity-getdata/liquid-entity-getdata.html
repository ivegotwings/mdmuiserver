<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!--
`liquid-entity-getdata`
Boolean control

@demo demo/index.html 
-->

<dom-module id="liquid-entity-getdata">
  <template>
    <label>Request: [[request]]</label>
    <br>
    <label>Result: [[resultData]]</label>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'liquid-entity-getdata',
        attached: function() {
          console.log("service attached");
          this.response = this._makeServiceCall(this.request);
        },
        properties: {
          request: {
            type: Object,
            value: function() {
              return {
                requestData:{
                  "query":
                  {
                      "ctx":
                      [
                          {
                              "list": "fall2016",
                              "categorization": "shoes"
                          },
              
                          {
                              "list": "master",
                              "categorization": "shoes"
                          }
                      ],
              
                      "valCtx":
                      [
                          {
                              "source": "indix",
                              "timeslice": "current",
                              "governed": "true",
                              "locale": "en-US"
                          },
              
                          {
                              "source": "cnet",
                              "timeslice": "current",
                              "governed": "true",
                              "locale": "en-US"
                          }
                      ],
              
                      "id": "guid",
                      "filters":
                      {
                          "attributesCriterion":
                          [
                              {
                                  "upc":
                                  {
                                      "eq": "123456789"
                                  }
                              },
              
                              {
                                  "msrp":
                                  {
                                      "gte": 10,
                                      "lte": 20
                                  }
                              }
                          ],
              
                          "relationshipsCriterion":
                          [
                              
                          ],
              
                          "typesCriterion":
                          [
                              "ALL",
                              "sku",
                              "product"
                          ]
                      }
                  },
              
                  "fields":
                  {
                      "ctxTypes":
                      [
                          "properties"
                      ],
              
                      "attributes":
                      [
                          "msrp",
                          "launchDate"
                      ],
              
                      "relationships":
                      [
                          "ALL"
                      ]
                  },
              
                  "options":
                  {
                      "totalRecords": 100,
                      "includeRequest": false
                  },

                  "requestId": "requestUID_00001"
                }
              };
            }
          },
          resultData: {
            type: Object,
            value: function() {
              return {};
            },
            notify: true
          }
        },
        _makeServiceCall: function(request) {
          //make service call and return the response
          //console.log(request);
          if(request)
          {
            var falcorDataSource = new falcor.HttpDataSource('http://localhost:5005/entityData.json', { crossDomain: true, withCredentials: false } );
            var model = new falcor.Model({source: falcorDataSource});
            var _this = this;
            var entityData;
            var requestAsString = JSON.stringify(request);
            var requestId = request.requestData.requestId;

            //  model.get(["entitiesById", "e1"]).then(function(response) {
            //         console.log(response.json);
            //         //console.log(model.deref(response.json.searchResult[requestId].entities[0]));
            //         //entityData = JSON.parse(response.json.searchResult[requestId]);
            //         //console.log(entityData);
            //         //return entityData;
            //       });

            model.get(["searchResult", [requestId, requestAsString], "entities", [{from:0, to:1}]]).then(function(response) {
                    
                    console.log(response);
                    
                    var entities = response.json.searchResult[requestId].entities;
                    
                    console.log(entities);

                    var entityListToGet = [];

                    for(var e in entities){
                        var entity = entities[e];
                        console.log(entity);
                        entityListToGet.push(entity[1]);
                    }

                    console.log(entityListToGet);
                    
                    model.get(["entitiesById", entityListToGet]).then(function(response) {
                      console.log(response.json);
                      //console.log(model.deref(response.json.searchResult[requestId].entities[0]));
                      //entityData = JSON.parse(response.json.searchResult[requestId]);
                      //console.log(entityData);
                      //return entityData;
                    });

                    //console.log(model.deref(response.json.searchResult[requestId].entities[0]));
                    //entityData = JSON.parse(response.json.searchResult[requestId]);
                    //console.log(entityData);
                    //return entityData;
                  });

           
            
            return entityData;
          }
        }
      });
    })();
  </script>
</dom-module>