<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<!--
`rock-entity-search-grid` component is used to render entities in grid, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-search-grid">
    <template>
        <style>
        </style>
        <liquid-entity-get auto name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
        <liquid-entity-getdata auto operation="initiatesearch" request-data="{{request}}" last-response="{{searchResponse}}"></liquid-entity-getdata>
        <liquid-entity-getdata auto operation="getsearchresultdetail" request-data="{{request}}" request-id="[[searchResponse.content.requestId]]"
            last-response="{{searchResultResponse}}"></liquid-entity-getdata>
        <pebble-grid id="entityGrid" config="{{gridConfig}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}"
            page-size="10" current-page="{{_currentPage}}" record-size="{{searchResponse.content.totalRecords}}" data="{{searchResultResponse.content.entities}}"></pebble-grid>
        <bedrock-pubsub event-name="grid-selecting-item" handler="onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
</template>

<script> 
    (function () {
        'use strict';

        Polymer({
            is: 'rock-entity-search-grid',
            properties: {
                /**
                * Indicates the request object that is passed to the data element to retrive attribute model data.
                Sample: { 
                            action: "getAttributeModels" 
                        }
                */
                attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {
                            action: "getAttributeModels"
                        };
                    }
                },

                request: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {
                                    "ctx": [{
                                        "list": "productMaster",
                                        "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                                    }],
                                    "valCtx": [{
                                        "source": "SAP",
                                        "locale": "en-US"
                                    }],
                                    "filters": {
                                        "attributesCriterion": [],
                                        "typesCriterion": ["nart"]
                                    }
                                },
                                "fields": {
                                    "ctxTypes": [
                                        "properties"
                                    ],
                                    "attributes": [
                                        "cpimProductName",
                                        "csapDescriptionOfNart",
                                        "csapMaterialStatusGlobal",
                                        "cpimSkinType"
                                    ],
                                    "relationships": ["ALL"]
                                },
                                "options": {
                                    "from": 0,
                                    "to": 9
                                }
                            }
                        };
                    }
                },

                /**
                 * Indicates the response object that is received from liquid element.
                 */
                searchResponse: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true,
                    observer: '_searchResponseChanged'
                },

                searchResultFilters: {
                    type: Object,
                    notify: true,
                    value: function(){
                        return {
                                    "attributesCriterion": [],
                                    "typesCriterion": ["nart"]
                               };
                    },
                    observer: '_searchResultFiltersChanged'
                },

                searchResultResponse: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true
                },

                 _currentPage: {
                    type: Number,
                    value: 0,
                    observer: "_currentPageChanged"
                }

            },

            observers: [

            ],

            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            _searchResponseChanged: function (searchResponse) {
                if (!searchResponse || !searchResponse.content || searchResponse.content.totalRecords ==
                    0) {
                    this.searchResultResponse = {
                        "content": {
                            "entities": {}
                        }
                    };
                }
            },

            _currentPageChanged: function (currentPage) {
                if (currentPage > 0) {
                    var from = (currentPage * 9) + currentPage;
                    var to = currentPage + (currentPage * 9 + 9);
                    var options = { "from": from, "to": to };
                    this.set("request.params.options", options);
                }
            },

            _searchResultFiltersChanged: function(currentFilters){
                this.set("request.params.query.filters", currentFilters);
            }
        });
    })();
</script>
</dom-module>