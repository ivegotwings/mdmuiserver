<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid/remote-data.html">

<!--
`rock-entity-search-grid` component is used to render entities in grid, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-search-grid">
    <template>
        <liquid-entity-get auto name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
        <remote-data id="searchGrid" request="{{request}}" operation="entitySearch" data-formatter="{{dataFormatter}}" 
            current-record-size="{{size}}" total-records="{{totalRecords}}" data-source="{{dataSource}}"></remote-data>
        <rock-grid id="entityGrid" data-source="{{dataSource}}" data-source-id="searchGrid" record-size="{{totalRecords}}" config="{{gridConfig}}"
            grid-data-size="{{size}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}" page-size="[[pageSize]]"
            selected-item="{{selectedItem}}" selected-items="{{selectedItems}}"></rock-grid>        
</template>

<script> 
    (function () {
        'use strict';

        Polymer({
            is: 'rock-entity-search-grid',
            properties: {
                /**
                * Indicates the request object that is passed to the data element to retrive attribute model data.
                Sample: { 
                            action: "getAttributeModels" 
                        }
                */
                attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {
                            action: "getAttributeModels"
                        };
                    }
                },
                /**
                * Specifies the configuration object that to be passed to grid.
                */                
                gridConfig: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                /**
                * Specifies the request Object to initiate the search.
                */
                request: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {
                                    "ctx": [{
                                        "list": "productMaster",
                                        "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                                    }],
                                    "valCtx": [{
                                        "source": "SAP",
                                        "locale": "en-US"
                                    }],
                                    "filters": {
                                        "attributesCriterion": [],
                                        "typesCriterion": ["nart"]
                                    }
                                },
                                "fields": {
                                    "ctxTypes": [
                                        "properties"
                                    ],
                                    "attributes": [
                                        "cpimProductName",
                                        "csapDescriptionOfNart",
                                        "csapMaterialStatusGlobal",
                                        "cpimSkinType"
                                    ]
                                },
                                "options": {
                                    "from": 0,
                                    "to": 0
                                }
                            }
                        };
                    }
                },
                /**
                * Specifies all dimensions that are selected in dimension selector.
                */
                dimensions: {
                    type: Object,
                    notify: true,
                    observer: '_loadSearchResultsByDimension'
                },
                /**
                * Specifies the filters that can be used to filter the search.
                */
                searchFilters: {
                    type: Array,
                    notify: true,
                    value: function(){
                        return [];
                    },
                    observer: '_loadSearchResultsByFilters'
                },
                /**
                * Specifies the query object that can be used to initiate the search.
                */
                searchQuery: {
                    type: String,
                    notify: true,
                    value: "",
                    observer: '_loadSearchResultsByQuery'
                },
                /**
                * Specifies the format of the data that to be passed to remote-data
                */
                dataFormatter: {
                    notify: true,
                    value: function() {
                        return this._getAttributeFormattedData.bind(this);
                    }
                },

                _attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {
                            action: "getAttributeModels"
                        }
                    }
                },

                /**
				 * Indicates the number of items fetched at a time from the data-source.
				 */
				pageSize: {
					type: Number,
					notify: true,
					value: 4
				},

                /**
				 * Indicates the total record size of the current grid.				 
				 */
				totalRecords: {
					notify: true,
					type: Number,
					value: 0
				},

                /**
                 * Indicates selected item
                 */
                selectedItem: {
                    type: Object,
                    value: function(){ return{}; },
                    notify: true
                },

                /**
                 * Indicates selected items
                 */
                selectedItems: {
                    type: Array,
                    value: [],
                    notify: true
                }

            },

            observers: [

            ],

            behaviors: [
                RUFBehaviors.UIBehavior
            ],

            _searchResultFiltersChanged: function(currentFilters){
                this.set("request.params.query.filters", currentFilters);
            },
            

            _getAttributeFormattedData: function (data) {
                var dataArray = [];
                if(data && data.content) {
                    var entities = data.content.entities;
                    if(entities) {
                        dataArray = Object.keys(entities).map(function (key) {
                            if (entities.hasOwnProperty(key)) {
                                return entities[key];
                            }
                        });

                        DataHelper.transformEntitySchemaForGrid(dataArray, this.attributeModelResponse.returnValue.attributeModels);
                    }
                }
                return dataArray;
			},

            _loadSearchResultsByDimension: function () {
                var grid = Polymer.dom(this).node.$$('rock-grid');

                if(grid && this.dimensions) {
                    this.request.params.query.ctx = this._prepareContextGroups(this.dimensions.lists)
                    this.request.params.query.valCtx = this._prepareValueContextGroups(this.dimensions.sources, this.dimensions.locales);

                    grid.reRenderGrid();
                }
            },

            _loadSearchResultsByFilters: function() {
                var grid = Polymer.dom(this).node.$$('rock-grid');
                if(grid && this.searchFilters) {
                    this.request.params.query.filters.attributesCriterion = this.searchFilters;

                    grid.reRenderGrid();
                }
            },

            _loadSearchResultsByQuery: function() {
                var grid = Polymer.dom(this).node.$$('rock-grid');
                if (grid && this.searchQuery) {
                    if (!this.request.params.fields.all) {
                        this.request.params.fields.all = {};
                    }
                    this.request.params.fields.all.exists = this.searchQuery;

                    grid.reRenderGrid();
                }
            },

            _prepareContextGroups: function (lists) {
                if (lists && lists instanceof Array) {
                    var ctxGroup = [];

                    for (var i = 0; i < lists.length; i++) {
                        var ctxInfoObject = new Object();
                        ctxInfoObject.list = lists[i].value;
                        ctxInfoObject.classification =
                            "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry";
                        ctxGroup.push(ctxInfoObject);
                    }

                    return ctxGroup;
                }
            },

            _prepareValueContextGroups: function (sources, locales) {
                var valueCtxGroup = [];

                if (sources && locales && sources instanceof Array && locales instanceof Array) {
                    for (var i = 0; i < sources.length; i++) {
                        for (var j = 0; j < locales.length; j++) {

                            var valueCtxInfoObject = new Object();
                            valueCtxInfoObject.source = sources[i].value;
                            valueCtxInfoObject.locale = locales[j].value;
                            valueCtxGroup.push(valueCtxInfoObject);
                        }
                    }

                    return valueCtxGroup;
                }
            },

            _getEntityGrid: function () {
					return Polymer.dom(this.root).node.querySelector("#entityGrid") ||
						Polymer.dom(this).node.querySelector("#entityGrid");
			},

            /**
             * Reload grid
             */
            reloadGrid: function(){                
                this._getEntityGrid().reRenderGrid();               
            },

            /**
             * Get grid data
             */
            getData: function(){
                return this._getEntityGrid().getData();
            },

            /**
             * Set multi selection for grid
             */
            setMultiSelection: function(flag){
                if(flag != undefined)
                {
                    this._getEntityGrid().setMultiSelection(flag);
                }
            },

            /**
             * Can be used to clear the current selection state.
             */
            clearSelection: function(){
                this._getEntityGrid().clearSelection();
            },

            /**
             *  To select an item
             */
            selectItem: function(item){
                this._getEntityGrid().selectItem(item);
            },

            /**
			 * Get total size
			 */
			getTotalSize: function(){
			    return this._getEntityGrid().getTotalSize();
			},

            /**
			 * To set scroll position dynamically
			 */
			scrollToIndex: function(index){				
				this._getEntityGrid().scrollToIndex(index);
			},

            /**
             * Reset the grid size
             */
            notifyResize: function(){
                this._getEntityGrid().notifyResize();
            },

            /**
			 * To get selected grid row
			 */
			getSelectedGridRow: function(){
				return this._getEntityGrid().getSelectedGridRow();
			}
        });
    })();
</script>
</dom-module>