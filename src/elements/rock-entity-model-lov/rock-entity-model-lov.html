<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="entity-model-lov-datasource.html">

<!--
`rock-entity-model-lov` component is used to render entity model in lov, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-model-lov">
    <template>
        <entity-model-lov-datasource id="entityModelLovDataSource" request="{{request}}" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
            keywords-criterion-builder={{_keywordsCriterionBuilder}}>
        </entity-model-lov-datasource>
        <pebble-lov id="entityModelLov" data-source="{{dataSource}}" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]"
            show-color="[[showColor]]" no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" selected-item="{{selectedItem}}"
            selected-items="{{selectedItems}}">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-model-lov',
            properties: {

            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],

            listeners: {
                'entityModelLov.selection-changed': '_onLovSelectionChanged',
                'entityModelLov.lov-confirm-button-tap': '_onLovConfirmButtonTapped',
                'entityModelLov.lov-close-button-tap': '_onLovCloseButtonTapped',
            },

            ready: function () {
                this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);

                this._dataFormatter = this._getAttributeFormattedData.bind(this);

                this._currentLovElement = this.$$("#entityModelLov");
            },

            _getAttributeFormattedData: function (data) {
                if (data && data.content.entityModels) {
                    var entityModels = data.content.entityModels;
                    if (entityModels) {
                        return DataHelper.transformEntityModelForLov(entityModels, this._lovAttributeMap);
                    }
                }
            },

            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};
                    
                    keywordsCriterion.keywords = searchText;
                    keywordsCriterion.operator = "and";

                    return keywordsCriterion;
                }
            },

            _onLovSelectionChanged: function (event) {
                var eventDetail = {
                    data: event.detail.item,
                    name: "entity-model-lov-confirm-button-tap"
                }

                this.fireBedrockEvent("entity-model-lov-selection-changed", eventDetail);
            },

            _onLovConfirmButtonTapped: function (event) {
                var eventDetail = {
                    data: event.detail,
                    name: "entity-model-lov-confirm-button-tap"
                }

                this.fireBedrockEvent("entity-model-lov-confirm-button-tap", eventDetail);
            },

            _onLovCloseButtonTapped: function (event) {
                var eventDetail = {
                    data: event.detail,
                    name: "entity-model-lov-close-button-tap"
                }

                this.fireBedrockEvent("entity-model-lov-close-button-tap", eventDetail);
            }
        });
    </script>
</dom-module>