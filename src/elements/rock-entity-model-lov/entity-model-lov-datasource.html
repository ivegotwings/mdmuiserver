<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-lov-datasource-behavior/bedrock-lov-datasource-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="entity-model-lov-datasource">
    <template>
        <liquid-entity-model-get id="initEntityModelSearch" operation="initiatesearch" request-data="{{request}}" last-response="{{_initEntityModelSearchResponse}}" on-error="_onError" exclude-in-progress></liquid-entity-model-get>
        <liquid-entity-model-get id="getEntityModelSearchResult" operation="getsearchresultdetail" request-data="{{request}}" request-id="[[_initEntityModelSearchResponse.content.requestId]]" last-response="{{getEntityModelSearchResponse}}" on-error="_onError" exclude-in-progress></liquid-entity-model-get>
    </template>
    <script>
        class EntityModelLovDatasource
            extends Polymer.mixinBehaviors([
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LOVDataSourceBehavior
            ], Polymer.Element) {
            static get is() { return 'entity-model-lov-datasource' }
            static get properties() {
                return {
                    _liquidInitSearchElement: {
                        type: Object,
                        value: function () {
                            return {}
                        }
                    },

                    _liquidGetSearchElement: {
                        type: Object,
                        value: function () {
                            return {}
                        }
                    },
                    rDataSource: {
                        type: Object,
                        notify: true
                    },
                    rDataFormatter: {
                        type: Function,
                        notify: true
                    }
                }
            }
            /**
              * <b><i>Content development is under progress... </b></i> 
              */
            ready() {
                super.ready()
                this._liquidInitSearchElement = Polymer.dom(this).node.shadowRoot.querySelector(
                    "liquid-entity-model-get[id='initEntityModelSearch']");
                this._liquidGetSearchElement = Polymer.dom(this).node.shadowRoot.querySelector(
                    "liquid-entity-model-get[id='getEntityModelSearchResult']");

                this.rDataSource = this._dataSource.bind(this);
            }

            _dataSource(data, success, error) {
                // Bind Reponse
                if (!this.isResponseAttached) {
                    this._liquidInitSearchElement.addEventListener('response', this._onInitSearchResponse.bind(
                        this));
                    this._liquidGetSearchElement.addEventListener('response', this._onGetSearchResponse.bind(
                        this, success, error));
                    this.isResponseAttached = true;
                }

                // Filter
                let keywordsCriterion;
                if (this.keywordsCriterionBuilder && this.keywordsCriterionBuilder instanceof Function) {
                    keywordsCriterion = this.keywordsCriterionBuilder(data.filter);
                }

                if (keywordsCriterion) {
                    this.set("request.params.query.filters.keywordsCriterion", keywordsCriterion);
                } else {
                    delete this.request.params.query.filters.keywordsCriterion;
                }

                if (this.checkIfRequestChanged()) {
                    this.isRequestInitiated = false;
                    data.page = 1;
                }

                // Set Range
                let from = data.page > 0 ? (data.page - 1) * data.pageSize : 0;
                let to = data.page > 0 ? data.page * data.pageSize - 1 : 0;

                let options = {
                    "from": from,
                    "to": to
                };
                this.set("request.params.options", options);

                if (keywordsCriterion) {
                    this.set("request.params.query.filters.keywordsCriterion", keywordsCriterion);
                } else {
                    delete this.request.params.query.filters.keywordsCriterion;
                }

                // Initiate Request only for First Time.
                if (!this.isRequestInitiated) {
                    this._liquidInitSearchElement.generateRequest();
                } else {
                    this._liquidGetSearchElement.generateRequest();
                }
            }

            _onInitSearchResponse() {
                this._lastRequest = DataHelper.cloneObject(this.request);
                this._liquidGetSearchElement.generateRequest();
                this.isRequestInitiated = true;
            }

            _onGetSearchResponse(success, error) {
                if (typeof (this.rDataFormatter) == 'function') {
                    if (this.getEntityModelSearchResponse.status === "success") {
                        success(this.rDataFormatter(this.getEntityModelSearchResponse));
                    } else {
                        error();
                    }
                }
            }

            _onError(e) {
                let response = e.detail.response; //need to check why this is response.response
                if (response && response.status && response.status.toLowerCase() == "error") {
                    let message = "";
                    if (response.statusDetail && response.statusDetail.message) {
                        message = " with message: " + response.statusDetail.message;
                    }

                    this.logError("Entity model load failed" + message, e.detail);
                }
            }
        }
        customElements.define(EntityModelLovDatasource.is, EntityModelLovDatasource);
    </script>
</dom-module>