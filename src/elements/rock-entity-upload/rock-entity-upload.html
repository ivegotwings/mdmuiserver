<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-save/liquid-config-save.html">

<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../rock-classification-tree/rock-classification-tree.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-entity-upload">
    <template>
        <style include="pebble-styles-shared">
            .placeHolder {
                width: 880px;
                height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }

            #content-actions {
                padding-top: 30px;
                position: fixed;
                bottom: 0;
                background: rgba(255, 255, 255, 0.80);
                text-align: center;
                width: 100%;
                z-index: 9999;
            }

            #content-label {
                box-shadow: 0 1px 7px 0 #c1cad4;
                padding: 15px;
                margin: 10px;
            }

            #image-container {
                width: 30px;
                height: 35px;
                vertical-align: middle;
            }

            import-log {
                vertical-align: middle;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
                color: var(--palette-steel-grey, #75808b);
            }

            pebble-button[disabled] {
                pointer-events: none;
                color: #c1cad4;
                background-color: #c1cad4;
                border-color: #c1cad4;
            }

            .checkbox-container {
                margin-right: 15%;
            }

            .checkbox-label-color {
                --pebble-checkbox-label-color: #75808b;
            }

            .confirmSave {
                font-size: 12px;
            }

            #categoryTreeContainer {
                height: 550px;
                overflow: auto;
            }
            pebble-button#cancel {
            --pebble-button-paper-style:{
                color: var(--secondary-button-text-color, #75808b);
                background-color: var(--secondary-button-color, #ffffff);
                border: 1px solid var(--secondary-button-border-color, #c1cad4);
				font-weight:var(--font-bold, bold);
                height: 30px;
                width: 100px;
            }
			}
            pebble-button#download {
            --pebble-button-paper-style:{
                color: var(--button-text-color, #ffffff);
                background-color: var(--success-button-color, #09c021);
                border-color: var(--success-button-color, #09c021);
				font-weight:var(--font-bold, bold);
				height: 30px;
                width: 100px;
            }
			}
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-config-get id="getUserProfile" operation="getbyids" request-id="req2" request-data="[[_profileRequest]]" on-response="_onProfileGetResponse"></liquid-config-get>
        <liquid-config-save id="profileSaveService" operation="create" request-data="[[_profileSaveRequest]]" on-response="_onProfileSaveResponse"></liquid-config-save>
        <liquid-rest id="entityMatchService" url="/pass-through-bulk/matchservice/search" method="POST" request-data={{_entityMatchRequest}}
            on-liquid-response="_onMatchSuccess" on-liquid-error="_onMatchFailure">
        </liquid-rest>
        <liquid-rest id="copService" url="" method="POST" request-data={{_copRequest}} on-liquid-response="_onCOPSuccess" on-liquid-error="_onCOPFailure"></liquid-rest>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="[[attributeModelRequest]]" on-response="_onCompositeModelResponse"></liquid-entity-model-composite-get>
        <liquid-entity-data-save name="entitiesSaveDataService" operation="" request-data="{{_saveRequest}}" on-response="_onSaveResponse"></liquid-entity-data-save>
        <div id="content-entity-import" hidden>
            <p class="title"><strong>Profile Name:</strong> [[_profileName]]</p>
            <div align="right" class="checkbox-container">
                <pebble-checkbox hidden$="[[!enableMappings]]" id="customizeMappingsChk" class="checkbox-label-color m-r-10" on-change="_onMappingsChange">Customize Mappings</pebble-checkbox>
                <pebble-checkbox hidden$="[[!enableDataPreview]]" id="showReviewChk" class="checkbox-label-color" on-change="_onPreviewChange">Show Data Preview</pebble-checkbox>
            </div>
            <div class="placeHolder p-10">
                <p class="title">
                    <a href="#" class="btn-link" on-tap="_exportDialogOpen">Download</a> a system template or just upload
                    an existing data file
                </p>
                <!-- TODO -->
                <!-- Currently pebble dialog is coming out of app and sitting on body so css has been added inline needs to resolve it with some proper way. -->
                <pebble-dialog id="exportDialog" modal show-close-icon>
                    <pebble-spinner active="[[_downloadInProgress]]"></pebble-spinner>
                    <div id="exportSmartExcelContent" style="height:500px">
                        <div>
                            Select one or more classifications to download the smart excel template. You can select the classification at any level and
                            the data required for all child classifications will be shown in the template.
                        </div>
                        <div id="categoryTreeContainer" style="height:450px; overflow:auto;">
                            <rock-classification-tree id="contextTree" multi-select="true" taxonomy="productsetuptaxonomy" context-data="[[contextData]]"
                                selected-items="{{_selectedCategories}}"></rock-classification-tree>
                        </div>
                        <div id="exportActions" class="p-b-10" align="center">
                            <pebble-button id="cancel" button-text="Cancel" raised on-tap="_onCancelDownloadSelection"></pebble-button>
                            <pebble-button id="download" button-text="Download" raised on-tap="_exportSelectedCategory"></pebble-button>
                        </div>
                    </div>
                </pebble-dialog>
                <!-- screen for import -->
                <pebble-file-upload accept="application/vnd.ms-excel.sheet.macroEnabled.12, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" target="/file-upload"></pebble-file-upload>
                <bedrock-pubsub on-bedrock-event-pebble-file-upload-success="_onFileUploadSuccess"></bedrock-pubsub>
            </div>
        </div>
        <div id="content-label" hidden>
            <pebble-image-viewer alt="Product image." id="image-container" sizing="contain" src="/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg"></pebble-image-viewer>
            <span class="import-log"><strong>[[_fileName]]</strong> uploaded <strong>[[_entities.length]]</strong> items with <strong>[[attributeNames.length]]</strong> attributes.</span>
        </div>
        <div id="content-mappings" hidden>

        </div>
        <div id="content-entities-grid" hidden>
            <rock-grid id="entitiesGrid" data="{{_gridData}}" page-size="10" no-header></rock-grid>
            <span class="confirmSave">Please review the data above. Save process cannot be cancelled once started.</span>
        </div>
        <div id="content-actions" class="p-b-10" align="center" hidden>
            <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onSkipTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>
       
        <bedrock-pubsub event-name="field-map-save" handler="_onFieldMappingsSave" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="field-map-cancel" handler="_onFieldMappingsCancel" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="field-map-skip" handler="_onFieldMappingsSkip" target-id=""></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-entity-upload",

                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the names of the attributes that are retrieved from "Excel".
                     */
                    attributeNames: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Indicates the contexts which are retrieved from "Excel".
                     */
                    contexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Specifies the request object for the attribute model request.
                     */
                    attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the response object for the attribute models.
                     */
                    attributeModelResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () {
                            return {
                                "viewMode": "Tabular",
                                "readOnly": true,
                                "tabular": {
                                    "settings": {
                                        "isMultiSelect": false,
                                        "maxNoOfRows": 200
                                    },
                                    "columns": []
                                }
                            };
                        }
                    },
                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _copRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                  
                    _entitiesData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _entities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _saveRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _attributeModels: {
                        type: Object
                    },
                    _fileName: {
                        type: String
                    },
                    _currentBatchNumber: {
                        type: Number,
                        value: 0
                    },
                    _batchSize: {
                        type: Number,
                        value: 10
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _downloadInProgress: {
                        type: Boolean,
                        value: false
                    },
                    _entityMatchRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _matchedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _newEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _faultedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _currentEntityIndex: {
                        type: Number
                    },
                    _currentAction: {
                        type: String,
                        value: "create"
                    },
                    _showPreview: {
                        type: Boolean,
                        value: false
                    },
                    _isDirty: {
                        type: Boolean,
                        value: false
                    },
                    _profileName: {
                        type: String,
                    },
                    _customizeMappings: {
                        type: Boolean,
                        value: false
                    },
                    _mappingsData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _profileRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _profileSaveRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _selectedCategories: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    enableDataPreview: {
                        type: Boolean,
                        value: false
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    enableMappings: {
                        type: Boolean,
                        value: false
                    },
                    _currentCOPService: {
                        type: String,
                        value: "process"
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    skipNext: {
                        type: Boolean,
                        value: false
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    businessFunctionData: {
                        type: Object,
                        value: function () { return {}; }
                    }
                },
                observers: [
                    '_attributeNamesChanged(attributeNames, contexts)',
                    '_contextChanged(contextData)'
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                ready: function () {
                    //this._showView("entity-import");
                },
                _contextChanged: function (contextData) {
                    if (!_.isEmpty(contextData)) {
                        //this contexts is coming from COP returned entities
                        var itemContext = this.getFirstItemContext();
                        var entityType = itemContext.type;
                        this.baseProfileId = "sku_Folder_Excel_Import_Transform_Dynamic";
                        this.transformProfileId = entityType + "_Folder_Excel_Import_Transform_" + this.userId;
                        this.processProfileId = entityType + "_Folder_Excel_Import_Process_" + this.userId;
                        var profileIds = [this.transformProfileId, this.processProfileId, this.baseProfileId];
                        var req = DataRequestHelper.createProfileGetRequest(profileIds);
                        if (req) {
                            this.set("_profileRequest", req);
                            this.$$("#getUserProfile").generateRequest();
                        }
                    }
                },
                _onProfileGetResponse: function (e) {
                    var response = e.detail.response;
                    var configObjects = DataHelper.validateAndGetConfigObjects(response);
                    if (configObjects) {
                        if (configObjects.length > 0) {
                            var req = { "configObjects": [] };
                            var baseProfile = configObjects.find(obj => obj.id == this.baseProfileId);
                            var transformProfile = configObjects.find(obj => obj.id == this.transformProfileId);
                            var processProfile = configObjects.find(obj => obj.id == this.processProfileId);
                            if (baseProfile) {
                                this.baseProfile = DataHelper.cloneObject(baseProfile);
                                if (!transformProfile) {
                                    var transformProfileCreateReq = DataRequestHelper.createProfileCreationRequest(this.transformProfileId, this.baseProfile, "transform")
                                    req.configObjects.push(transformProfileCreateReq);
                                }
                                if (!processProfile) {
                                    var processProfileCreateReq = DataRequestHelper.createProfileCreationRequest(this.processProfileId, this.baseProfile, "process")
                                    req.configObjects.push(processProfileCreateReq);
                                }
                                if (!_.isEmpty(req.configObjects)) {
                                    this.set("_profileSaveRequest", req);
                                    this.$$("#profileSaveService").generateRequest();
                                } else {
                                    this._profileName = this.processProfileId;
                                    this._showView("entity-import");
                                }
                            } else {
                                this.showErrorToast("Base profile for mapping generation is missing. Please contact Your administrator");
                            }
                        } else {
                            this.showErrorToast("Base profile for mapping generation is missing. Please contact Your administrator");
                        }
                    } else {
                        this.showErrorToast("There is some problem in configuration get service. Please contact Your administrator");
                    }
                },
                _onProfileSaveResponse: function (e) {
                    var response = e.detail.response;
                    if (response && response.status && response.status.toLowerCase() == "success") {
                        this._profileName = this.processProfileId;
                        this._showView("entity-import");
                    }
                },
                _showView: function (viewName) {
                    if (viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if (contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },

                _hideView: function (viewName) {
                    if (viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if (contentView) {
                            contentView.setAttribute("hidden", "");
                        }
                    }
                },

                _onFileUploadSuccess: function (e, detail, sender) {
                    this._isDirty = true;
                    this._loading = true;
                    var fileName = detail.fileName;
                    this.set("_fileName", detail.originalFileName);
                    var copRequest = {
                        "fileName": fileName,
                        "originalFileName": detail.originalFileName,
                        "profileName": this._profileName
                    };
                    this.set("_copRequest", copRequest);
                    var liqCOP = this.$$("#copService");
                    if (liqCOP) {
                        if (this._customizeMappings) {
                            this._currentCOPService = "generateFieldMap";
                            liqCOP.url = "/cop/generateFieldMap";
                        } else if (this._showPreview) {
                            this._currentCOPService = "transform";
                            liqCOP.url = "/cop/transform";
                        } else {
                            this._currentCOPService = "process";
                            liqCOP.url = "/cop/process";
                        }
                        liqCOP.generateRequest();
                    }
                    this.async(function () {
                        //Clear file upload
                        this.$$('pebble-file-upload').reset();
                    });
                },
                _onCOPSuccess: function (e) {
                    var response = e.detail.response;
                    var statusMessage = DataHelper.validateAndGetMessage(response);
                    if (statusMessage == "") {
                        var res = response.response;
                        if (this._currentCOPService == "generateFieldMap") {
                            var mappingsData = res.binaryObjects[0].data.profile.transform.mapping;
                            this._hideView("entity-import");
                            this._hideButtons();
                            this.set("_mappingsData", mappingsData);
                            this._importMappingComponent();
                            this._loading = false;
                            this._isDirty = false;
                            return;
                        } else if (this._currentCOPService == "transform" && res.entities && res.entities.length > 0) {
                            this._entities = res.entities;
                            var maxNoOfRows = this._gridConfig.tabular.settings.maxNoOfRows;
                            if (maxNoOfRows && this._entities.length > maxNoOfRows) {
                                this.showErrorToast("Imported more entities than specified maximum number of entities. Please review the file imported or contact your administrator.", 3000);
                                this._loading = false;
                                this._isDirty = false;
                                return;
                            }
                            var attributeNames = EntityHelper.getAttributeNamesFromEntities(this._entities);
                            if (attributeNames && attributeNames.length > 0) {
                                var contexts = EntityHelper.getContextsFromEntities(this._entities);
                                if (contexts && contexts.length > 0) {
                                    this.set("contexts", contexts);
                                }
                                //setting contexts first and then attributeNames, because there is an observer on both
                                //setting attributeNames first would send unnecessary request for model
                                this.set("attributeNames", attributeNames);
                            } else {
                                this.showErrorToast("Unable to fetch attributes from excel. Please check excel file imported or contact your administrator.");
                                this._loading = false;
                                this._isDirty = false;
                            }
                            this._hideView("entity-import");
                            this._hideButtons();
                            this._showView("label");
                            this._showView("entities-grid");
                            this._entities = response.response.entities;

                            var maxNoOfRows = this._gridConfig.tabular.settings.maxNoOfRows;
                            if (maxNoOfRows && this._entities.length > maxNoOfRows) {
                                this.showErrorToast("Imported more entities than specified maximum number of entities. Please review the file imported or contact your administrator.", 3000);
                                this._loading = false;
                                this._isDirty = false;
                                return;
                            }
                            var attributeNames = EntityHelper.getAttributeNamesFromEntities(this._entities);
                            if (attributeNames && attributeNames.length > 0) {
                                var contexts = EntityHelper.getContextsFromEntities(this._entities);
                                if (contexts && contexts.length > 0) {
                                    this.set("contexts", contexts);
                                }
                                //setting contexts first and then attributeNames, because there is an observer on both
                                //setting attributeNames first would send unnecessary request for model
                                this.set("attributeNames", attributeNames);
                            } else {
                                this.showErrorToast("Unable to fetch attributes from excel. Please check excel file imported or contact your administrator.");
                                this._loading = false;
                                this._isDirty = false;
                            }
                        } else if (this._currentCOPService == "process") {
                            var data = {
                                "messages": [
                                    {
                                        "message": "Entities will be created/updated using the uploaded file."
                                    },
                                    {
                                        "message": "You can view the status of the processing in the File Upload Status Dashboard"
                                    }
                                ],
                                "actions": [
                                    {
                                        "name": "closeFunction",
                                        "text": "Take Me back to Where I started",
                                        "action":{"name":"refresh-data"}
                                    },
                                    {
                                        "name": "nextAction",
                                        "text": "Take me to File Upload Status",
                                        "dataRoute": "dashboard",
                                        "action":{"name":"refresh-data"}
                                    }
                                ]
                            };
                            this.businessFunctionData = data;
                            ComponentHelper.getParentElement(this).businessFunctionData = data;
                            var eventName = "onSave";
                            var eventDetail = {
                                name: eventName,
                                data: { "skipNext": this.skipNext }
                            };
                            this._loading = false;
                            this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                        }
                    } else {
                        this.logWarning("UnexpectedCOP","response",e.detail.response);
                        this.showErrorToast(statusMessage + ". Please check the service or contact your administrator.");
                        this._isDirty = false;
                        this._loading = false;
                    }
                },
                _onCOPFailure: function (e) {
                    this.logWarning("COPTransformationFail","response",e.detail);
                    this.showErrorToast("Unable to transform excel to json. Please check the service or contact your administrator.");
                    this._loading = false;
                    this._isDirty = false;
                },
                _attributeNamesChanged: function (attributeNames, contexts) {
                    if (!_.isEmpty(attributeNames)) {
                        this.contextData[ContextHelper.CONTEXT_TYPE_DATA] = contexts;
                        var itemContext = this.getFirstItemContext();

                        itemContext.attributeNames = attributeNames;

                        var t = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                        this.set("attributeModelRequest", t);

                        var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                        if (liquidModelGet) {
                            liquidModelGet.generateRequest();
                        }
                    }
                },
                _onCompositeModelResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        if (!this._attributeModels) {
                            var attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);
                            if (!_.isEmpty(attributeModels)) {
                                this.set("_attributeModels", attributeModels);
                                this._populateEntityGrid();
                            } else {
                                this.showErrorToast("Unable to fetch attribute models. Please check the service or contact your administrator.");
                                this._loading = false;
                            }
                        }
                    } else {
                        this.showErrorToast("Unable to fetch attribute models. Please check the service or contact your administrator.");
                        this._loading = false;
                    }
                },
                _populateEntityGrid: function () {
                    var entitiesGrid = this.$$('#entitiesGrid');
                    if (entitiesGrid) {
                        entitiesGrid.config = {};
                        entitiesGrid.data = [];
                        entitiesGrid.attributeModels = {};
                        this._prepareEntityGridConfig();
                        entitiesGrid.config = this._gridConfig;
                        this._prepareEntityGridData();
                        entitiesGrid.data = this._gridData;
                        this._loading = false;
                        this._showView("actions");
                    }
                },
                _prepareEntityGridConfig: function () {
                    if (this._attributeModels) {
                        var keys = Object.keys(this._attributeModels);
                        if (keys && keys.length > 0) {
                            for (var i = 0; i < keys.length; i++) {
                                var model = this._attributeModels[keys[i]];
                                this._gridConfig.tabular.columns.push({
                                    "header": model.externalName,
                                    "name": model.name,
                                    "sortable": true
                                });
                            }
                        }
                        if (!_.isEmpty(this.contexts)) {
                            this._gridConfig.tabular.columns.push({
                                "header": "classification",
                                "name": "classification"
                            });
                            this._gridConfig.tabular.columns.push({
                                "header": "taxonomy",
                                "name": "taxonomy"
                            });
                        }
                    }
                },
                _prepareEntityGridData: function () {
                    for (var i = 0; i < this._entities.length; i++) {
                        var entity = this._entities[i];
                        var entityId = DataHelper.getRandomString();
                        var attributes = EntityHelper.getAllAttributes(entity);
                        var keys = Object.keys(attributes);
                        if (keys && keys.length > 0) {
                            var rowData = {
                                "rowId": entityId
                            };
                            for (var j = 0; j < keys.length; j++) {
                                var key = keys[j];
                                if (this._attributeModels[key]) {
                                    rowData[key] = AttributeHelper.getAtributeValueForGrid(attributes[key], this._attributeModels[key]);
                                }
                            }
                            var entityContexts = EntityHelper.getContextsFromEntities([entity]);
                            if (!_.isEmpty(entityContexts)) {
                                var ctx = entityContexts[0];
                                rowData["classification"] = ctx.classification;
                                rowData["taxonomy"] = ctx.taxonomy;
                            }
                            this._gridData.push(rowData);
                        }
                    }
                },
                _onSaveTap: function (e) {
                    this._disableActions();
                    this._loading = true;
                    //get all entities from grid and process save
                    var gridData = this.$$("#entitiesGrid").data;
                    var contextData = DataHelper.cloneObject(this.contextData);
                    this._entities = DataTransformHelper.prepareEntitiesForCreate(gridData, contextData, this._attributeModels);
                    this._currentBatchNumber = 0;
                    this._generateMatchServiceRequest();
                },
                _generateMatchServiceRequest: function () {
                     var batchEntities = this._getNextBatch(this._entities, this._currentBatchNumber, this._batchSize);
                    if (batchEntities && batchEntities.length > 0) {
                        this.set('_entityMatchRequest', {
                            "entities": batchEntities
                        });
                        if (this.$$("#entityMatchService")) {
                            this.$$("#entityMatchService").generateRequest();
                        }
                    } else {
                        this._currentBatchNumber = 0;
                        this._currentAction = "create";
                        this._createEntities();
                    }
                },
                _onMatchSuccess: function (e, detail) {
                    if (detail.response) {
                        var responseList = detail.response;
                        if(responseList.length > 0) {
                            for(var i=0; i<responseList.length; i++) {
                                var entity = this._entities.find(entity => entity.id == responseList[i].id);
                                var response = DataHelper.isValidObjectPath(responseList[i], "operationResponse.response") ? responseList[i].operationResponse.response : {};
                                if(response && response.status && response.status.toLowerCase() == "success") {
                                    if(response.entities) {
                                        if(response.entities.length == 1) {
                                            var matchedEntity = response.entities[0];
                                            entity.id = matchedEntity.id;
                                            this._matchedEntities.push(entity);
                                        } else if(response.entities.length > 1) {
                                            this._faultedEntities.push(entity);
                                        }
                                    } else {
                                        this._newEntities.push(entity);
                                    }
                                } else {
                                    this._faultedEntities.push(entity);
                                }
                            }
                            this._currentBatchNumber++;
                            this._generateMatchServiceRequest();
                        } else {
                            this.logWarning("EntityMatchServiceFail","response",detail);
                            this.showErrorToast("There is a problem in match service. Please contact administrator.");
                            this._isDirty = false;
                            return;
                        }
                    }
                },
                _onMatchFailure: function (e, detail) {
                    this.logWarning("EntityMatchServiceFail","response",detail);
                    this.showErrorToast("There is a problem in match service. Please contact administrator.");
                    this._isDirty = false;
                },
                _createEntities: function () {
                    var batchEntities = this._getNextBatch(this._newEntities, this._currentBatchNumber, this._batchSize);
                    if (batchEntities && batchEntities.length > 0) {
                        var clientState = {};
                        clientState.notificationInfo = {};
                        clientState.notificationInfo.showNotificationToUser = false;

                        this._saveRequest = {
                            "clientState": clientState,
                            "entities": batchEntities
                        };
                        var liquidSave = this.$$("[name=entitiesSaveDataService]");
                        if (liquidSave) {
                            liquidSave.operation = this._currentAction;
                            liquidSave.generateRequest();
                        }
                    } else {
                        this._currentBatchNumber = 0;
                        this._currentAction = "update";
                        this._updateEntities();
                    }
                },
                _updateEntities: function () {
                    var batchEntities = this._getNextBatch(this._matchedEntities, this._currentBatchNumber, this._batchSize);
                    if (batchEntities && batchEntities.length > 0) {
                        var clientState = {};
                        clientState.notificationInfo = {};
                        clientState.notificationInfo.showNotificationToUser = false;

                        this._saveRequest = {
                            "clientState": clientState,
                            "entities": batchEntities
                        };
                        var liquidSave = this.$$("[name=entitiesSaveDataService]");
                        if (liquidSave) {
                            liquidSave.operation = this._currentAction;
                            liquidSave.generateRequest();
                        }
                    } else {
                        var msg = "Created " + this._newEntities.length + " entities and updated " + this._matchedEntities.length + " entities.";
                        if (this._faultedEntities.length > 0) {
                            msg = msg + " Found " + this._faultedEntities.length + " entities faulted.";
                        }
                        this.showSuccessToast(msg, 3000);

                        var data = {
                            "messages": [
                                {
                                    "message": msg
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Take Me back to Where I started"
                                },
                                {
                                    "name": "nextAction",
                                    "text": "Take me to User Dashboard",
                                    "dataRoute": "dashboard"
                                }
                            ]
                        };
                        this.businessFunctionData = data;
                        ComponentHelper.getParentElement(this).businessFunctionData = data;
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName,
                            data: { "skipNext": this.skipNext }
                        };
                        this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                    }
                },
                _onSaveResponse: function (e) {
                    this._currentBatchNumber++;
                    if (this._currentAction == "create") {
                        this._createEntities();
                    } else if (this._currentAction == "update") {
                        this._updateEntities();
                    }
                },
                _onSkipTap: function (e) {
                    //raise event with name given for onbackAction in configuration
                    var data;
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName,
                        data: data
                    }
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _hideButtons: function () {
                    var parentEl = ComponentHelper.getParentElement(this);
                    if (parentEl && parentEl.hideCreateButtons) {
                        parentEl.hideCreateButtons();
                    }
                },
                _getNextBatch: function (entities, currentBatchNumber, batchSize) {
                    var start = currentBatchNumber * batchSize;
                    var end = ((currentBatchNumber + 1) * batchSize) - 1;
                    if (start > entities.length) {
                        return;
                    }
                    if (end > entities.length) {
                        end = entities.length - 1;
                    }
                    return entities.slice(start, end + 1);
                },
                _disableActions: function () {
                    var saveButton = this.$$("#next");
                    var cancelButton = this.$$("#skip")
                    saveButton.setAttribute("disabled", true);
                    cancelButton.setAttribute("disabled", true);
                },
                _onPreviewChange: function (e) {
                    var chkbox = e.currentTarget;
                    if (chkbox.checked) {
                        this._showPreview = true;
                        this._profileName = this.transformProfileId;

                    } else {
                        this._showPreview = false;
                        this._profileName = this.processProfileId;
                    }
                },
                _onMappingsChange: function (e) {
                    var chkbox = e.currentTarget;
                    if (chkbox.checked) {
                        this._customizeMappings = true;
                    } else {
                        this._customizeMappings = false;
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                getIsDirty: function () {
                    return this._isDirty;
                },
                _exportDialogOpen: function () {
                    var exportDialog = this.$$("#exportDialog");

                    if (exportDialog) {
                        exportDialog.dialogTitle = "Download Smart Excel Template";
                        this._selectedCategories = [];
                        exportDialog.open();
                    }
                },
                _onCancelDownloadSelection: function () {
                    var exportDialog = document.querySelector("#exportDialog");

                    if (exportDialog) {
                        exportDialog.close();
                    }
                },
                _exportSelectedCategory: function (e) {
                    this._downloadInProgress = true;
                    if (this._selectedCategories && this._selectedCategories.length) {
                        var contexts = [];
                        var firstItemContext = this.getFirstItemContext();
                        var fileName = "CategoryTemplate";

                        this._selectedCategories.forEach(function (category) {
                            var formattedClassification = category.valuePath.replace(/#@#/g, "\/");
                            contexts.push({
                                "taxonomy": "productsetuptaxonomy",
                                "classification": formattedClassification
                            });
                        }, this);

                        if (this._selectedCategories.length == 1) {
                            fileName = this._selectedCategories[0].value.replace(/\W/g, '_');
                        }

                        if (firstItemContext && firstItemContext.type && contexts.length) {
                            var req = {
                                "params": {
                                    "query": {
                                        "contexts": contexts,
                                        "filters": {
                                            "typesCriterion": [
                                                "entityManageModel"
                                            ]
                                        },
                                        "id": firstItemContext.type + "_entityManageModel"
                                    },
                                    "fields": {
                                        "attributes": ["_ALL"],
                                        "relationships": ["_ALL"]
                                    }
                                },
                                "fileName": fileName
                            };

                            var _this = this;
                            RUFUtilities.fileDownload("/cop/downloadModelExcel", {
                                httpMethod: 'POST',
                                data: { data: JSON.stringify(req) },
                                successCallback: function (url) {
                                    this._downloadInProgress = false;
                                }.bind(_this),
                                failCallback: function (responseHtml, url, error) {
                                    this._onCOPDownloadFailure(error);
                                }.bind(_this)
                            });

                        }
                    }
                },
                _onCOPDownloadFailure: function (e) {
                    this.showErrorToast("Failed to download category model template. Please contact administrator.");
                    this._downloadInProgress = false;
                },
                _importMappingComponent: function () {
                    this._showView("mappings");
                    var component = {
                        "name": "rock-attribute-mapping",
                        "path": "/../../src/elements/rock-attribute-mapping/rock-attribute-mapping.html",
                        "properties": {
                            "mappings-data": this._mappingsData,
                            "context-data": this.contextData,
                            "transform-profile-name": this.transformProfileId,
                            "process-profile-name": this.processProfileId
                        }
                    };
                    var contentEl = this.$$("#content-mappings");
                    ComponentHelper.loadContent(contentEl, component, this);
                },
                _onFieldMappingsSave: function (e, detail) {
                    this._hideView("mappings");
                    this._hideView("entity-import");
                    this._loading = true;
                    this._customizeMappings = false;
                    var liqCOP = this.$$("#copService");
                    if (liqCOP) {
                        if (this._showPreview) {
                            this._currentCOPService = "transform";
                            liqCOP.url = "/cop/transform";
                        } else {
                            this._currentCOPService = "process";
                            liqCOP.url = "/cop/process";
                        }
                        liqCOP.generateRequest();
                    }
                },
                _onFieldMappingsCancel: function (e, detail) {
                    this._hideView("mappings");
                    this._showView("entity-import");
                },
                _onFieldMappingsSkip: function (e, detail) {
                    this._customizeMappings = false;
                    this._hideView("mappings");
                    this._hideView("entity-import");
                    this._loading = true;
                    var liqCOP = this.$$("#copService");
                    if (liqCOP) {
                        if (this._showPreview) {
                            this._currentCOPService = "transform";
                            liqCOP.url = "/cop/transform";
                        } else {
                            this._currentCOPService = "process";
                            liqCOP.url = "/cop/process";
                        }
                        liqCOP.generateRequest();
                    }
                }
            });
        })();
    </script>
</dom-module>