<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-save/liquid-config-save.html">

<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<dom-module id="rock-entity-upload">
    <template>
        <style include="pebble-styles-shared">
            .placeHolder {
                width: 880px;
                height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }
            .title {
                font-size: var(--default-font-size, 14px);		                  
                text-align: center;
                color:var(--palette-steel-grey, #75808b);
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-config-get id="getUserProfile" operation="getbyids" request-id="req2" request-data="[[_profileRequest]]" on-response="_onProfileGetResponse"></liquid-config-get>
        <liquid-config-save id="profileSaveService" operation="create" request-data="[[_profileSaveRequest]]"on-response="_onProfileSaveResponse"></liquid-config-save>
        <p class="title"><strong>Profile Name:</strong> [[uploadProfileName]]</p>
        <div class="placeHolder p-10">
            <p class="title"><a href="#" class="btn-link" on-tap="_selectFile">Download</a> a system template or just upload an existing data file</p>
            <!-- screen for import -->
            <pebble-file-upload accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" target="/file-upload"></pebble-file-upload>
            <bedrock-pubsub on-bedrock-event-pebble-file-upload-success="_onFileUploadSuccess"></bedrock-pubsub>
        </div>
        <liquid-rest id="copProcessUpload" url="/cop/process" 
            method="POST" request-data={{_copProcessUploadRequest}} on-liquid-response="_onProcessUploadSuccess" on-liquid-error="_onProcessUploadFailure"></liquid-rest>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-entity-upload",

                properties: {
                    uploadProfileName: {
                        type: "String",
                        value: ""
                    },
                    _copProcessUploadRequest: {
                        type: Object,
                        value: function() { return {}; }
                    },
                    _fileName: {
                        type: String
                    },
                    businessFunctionData: {
                        type: Object,
                        value: function() { return {}; }
                    },
                     _profileRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _profileSaveRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_contextDataChanged(contextData)'
                ],
                _contextDataChanged: function(contextData) {
                    if(!_.isEmpty(contextData)) {
                        this._loading = true;
                        var itemContext = this.getFirstItemContext();
                        var entityType = itemContext.type;
                        this.processProfileId = entityType + "_Folder_Excel_Import_Process_" + this.userId;
                        this.baseProfileId = "sku_Folder_Excel_Import_Process_Dynamic";
                        var req = {
                            "params": {
                                "query": {
                                    "ids": [this.processProfileId, this.baseProfileId],
                                    "filters": {
                                        "typesCriterion": [
                                            "COPProfile"
                                        ]
                                    },
                                    "contexts": [
                                            {
                                                "app": "RSConnect",
                                                "service": "excelImportProcessService",
                                                "list": "self"
                                            }
                                        ]
                                    },
                                    "fields": {
                                        "jsonData": true
                                    }
                                }
                            };
                        this.set("_profileRequest", req);
                        this.$$("#getUserProfile").generateRequest();
                    }
                },
                _onProfileGetResponse: function(e) {
                    var response = e.detail.response;
                    if(response && response.status && response.status.toLowerCase() == "success" && response.content && response.content.configObjects) {
                        if(response.content.configObjects.length > 0) {
                            var req = { "configObjects": [] };
                            var configObjects = response.content.configObjects;
                            var baseProfile = configObjects.find(obj => obj.id == this.baseProfileId);
                            var processProfile = configObjects.find(obj => obj.id == this.processProfileId);
                            if(baseProfile) {
                                this.baseProfile = DataHelper.cloneObject(baseProfile);
                                if(!processProfile) {
                                    var processProfileCreateReq = this._getProfileCreationRequest(this.processProfileId, this.baseProfile, "process")
                                    req.configObjects.push(processProfileCreateReq);
                                }
                                if(!_.isEmpty(req.configObjects)) {
                                    this.set("_profileSaveRequest", req);
                                    this.$$("#profileSaveService").generateRequest();
                                } else {
                                    this.uploadProfileName = this.processProfileId;
                                }
                            } else {
                                this.showErrorToast("Base profile for mapping generation is missing. Please contact Your administrator");
                            }
                        } else{
                            this.showErrorToast("Base profile for mapping generation is missing. Please contact Your administrator");
                        }
                    } else {
                        this.showErrorToast("There is some problem in configuration get service. Please contact Your administrator");
                    }
                    this._loading = false;
                },
                _getProfileCreationRequest: function(profileId, baseProfile, service) {
                    var ctxService = "";
                    if(service == "transform") {
                        ctxService = "excelImportTransformService";
                    } else if(service == "process") {
                        ctxService = "excelImportProcessService";
                    }
                    var profile = DataHelper.cloneObject(baseProfile);
                    profile.id = profileId;
                    profile.name = profileId;
                    profile.data.contexts[0].context.service = ctxService;
                    profile.data.contexts[0].jsonData.id = profileId;
                    profile.data.contexts[0].jsonData.name = profileId;
                    return profile;
                },
                _onProfileSaveResponse: function(e) {
                     var response = e.detail.response;
                    if(response && response.status && response.status.toLowerCase() == "success") {
                        this.uploadProfileName = this.processProfileId;
                        this._loading = false;
                    }
                },
                 _onFileUploadSuccess: function(e, detail, sender) {
                    if(this.uploadProfileName == undefined || this.uploadProfileName.length == 0) {
                        this.showErrorToast("Upload profile name not found. Please check the config.");
                        return;
                    }
                    this._loading = true;
                    var fileName = detail.fileName;
                    var copRequest = {
                        "fileName": fileName,
                        "originalFileName": detail.originalFileName,
                        "profileName": this.uploadProfileName
                    };
                    this.set("_copProcessUploadRequest", copRequest);
                    var liqProcess = this.$$("#copProcessUpload");
                    if(liqProcess) {
                        liqProcess.generateRequest();
                    }
                },
                _onProcessUploadSuccess: function(e) {
                    var response = e.detail.response;
                    if(response && response.dataObjectOperationResponse &&response.dataObjectOperationResponse.status.toLowerCase() == "success") {
                        // go to next step in wizard
                        var data = {
                            "messages": [
                                {
                                    "message": "The excel file has been uploaded and will be processed by the system"
                                },
                                {
                                    "message": "You can view the status of the processing in the Data Model Dashboard"
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Close Excel Uploader",
                                    "isNotApp": true
                                },
                                {
                                    "name": "nextAction",
                                    "text": "Take me to File Upload Status",
                                    "dataRoute": "dashboard",
                                    "isNotApp": true
                                }
                            ]
                        };
                        this.businessFunctionData = data;
                        var eventName = "onNext";
                        var eventDetail = {
                            name: eventName
                        };
                        this.async(function() {
                            this._loading = false;
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 5000);
                    } else {
                        this._loading = false;
                        console.warn("Unexpected COP response:" + e.detail.response);
                        this.showErrorToast("Unable to process the excel. Please check the service or contact your administrator.");
                    }
                },
                _onProcessUploadFailure: function(e) {
                    console.warn("Unexpected COP response:" + e.detail.response);
                    this.showErrorToast("Unable to process the excel. Please check the service or contact your administrator.");
                }
            });
        })();
    </script>
</dom-module>