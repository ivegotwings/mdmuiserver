<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../liquid-base-behavior/liquid-base-behavior.html">

<!--
`liquid-config-get`

@demo demo/index.html 
-->
<dom-module id="liquid-config-aggregate-get">
    <template>
         <liquid-config-get auto$="[[auto]]" id="getConfig" operation="getbyids" request-id="req1" request-data={{request}} on-response="_onConfigsGetResponse"></liquid-config-get>
    </template>
    <script>
        (function () {
            'use strict';
        
            Polymer({
                is: 'liquid-config-aggregate-get',
                behaviors: [RUFBehaviors.LiquidBaseBehavior],
                properties: {
                    request: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    appName: {
                        type: String,
                        value: "app-entity-discovery"
                    },
                    configs: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _components: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                    auto: {
                        type: Boolean,
                        value: false
                    },
                },
                attached: function () {
                    this.refresh();
                },
                refresh: function () {
                    var currentApp = ComponentHelper.getCurrentActiveApp();
                    if(currentApp) {
                        var contextData = currentApp.contextData;
                        var dataContext =  ContextHelper.getFirstDataContext(contextData);
                        var valueContext = ContextHelper.getFirstValueContext(contextData);
                        var itemContext = ContextHelper.getFirstItemContext(contextData);
                        var userContext = ContextHelper.getFirstUserContext(contextData);
                        var context = this._mergeContexts(dataContext, valueContext, itemContext, userContext);
                        this.request = DataRequestHelper.createConfigGetRequest(this.appName, context);
                        this.generateRequest();
                    }
                },
                _mergeContexts: function(dataCtx, valCtx, itemCtx, userCtx) {
                    var context = {
                        "app": this.appName,
                        "service": "_ALL",
                        "component": "components-list",
                        "subComponent": "_ALL",
                        "entityType": "",
                        //"relationshipType": "_ALL",
                        //"channel": dataCtx.channel,
                        //"locale": valCtx.locale,
                        //"source": valCtx.source,
                        "role": "",
                        //"user": userCtx.user
                    };
                    
                    if(itemCtx && itemCtx.type) {
                        context.entityType = itemCtx.type;
                    }
                    else {
                        delete context.entityType;
                    }

                    if(userCtx && userCtx.role) {
                        context.role = userCtx.role;
                    }
                    else {
                        delete context.role;
                    }

                    return context;
                },
                generateRequest: function() {
                    this.$$('#getConfig').generateRequest();
                },
                _onConfigsGetResponse: function (e) {
                    var configs = e.detail.response.content;
                    var ctx = this.request.params.query.contexts[0];
                    var configJson = SharedUtils.DataObjectFalcorUtil.getConfigByCtx(configs, ctx);
                    if(configJson) {
                        if(configJson && configJson.config && configJson.config.components && configJson.config.components.length > 0) {
                            this.set("_components", configJson.config.components);
                            this.request = DataRequestHelper.createConfigGetRequest(ctx.app, ctx,this._components[0]);
                            this.generateRequest();
                        } else {
                            this.configs[ctx.component] = configJson;
                            var i = this._components.indexOf(ctx.component);
                            if(i != -1 && i < this._components.length - 1) {
                                this.request = DataRequestHelper.createConfigGetRequest(ctx.app, ctx, this._components[i+1]);
                                this.generateRequest();
                            } else {
                                var eventName = "config-get-response";
                                var eventDetail = {
                                    components: this.configs
                                };

                                this._setLastResponse(eventDetail);
                                this.fire(eventName, eventDetail, { bubbles: this.bubbles });
                            }
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>