<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../liquid-base-behavior/liquid-base-behavior.html">

<!--
<b><i>Content development is under progress... </b></i>
@demo demo/index.html 
-->
<dom-module id="liquid-config-aggregate-get">
    <template>
        <liquid-config-get auto$="[[auto]]" id="getConfig" operation="getbyids" request-id="req1" request-data="[[request]]" on-response="_onAppConfigsGetResponse"></liquid-config-get>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-config-aggregate-get',
                behaviors: [RUFBehaviors.LiquidBaseBehavior],
                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    request: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    appName: {
                        type: String,
                        value: "Unknown"
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    configs: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    auto: {
                        type: Boolean,
                        value: false
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _liquidTracker: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                attached: function () {
                    this.refresh();
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                refresh: function () {
                    var contextData = undefined;

                    if (this.appName === "Unknown") {
                        return;
                    }

                    if (this.contextData) {
                        contextData = this.contextData;
                    }
                    else {
                        var currentApp = ComponentHelper.getCurrentActiveApp();
                        if (currentApp) {
                            contextData = currentApp.contextData;
                        }
                    }

                    if (contextData) {
                        var dataContext = ContextHelper.getFirstDataContext(contextData);
                        var valueContext = ContextHelper.getFirstValueContext(contextData);
                        var itemContext = ContextHelper.getFirstItemContext(contextData);
                        var userContext = ContextHelper.getFirstUserContext(contextData);
                        var context = this._mergeContexts(dataContext, valueContext, itemContext, userContext);
                        this.request = DataRequestHelper.createConfigGetRequest(this.appName, context);
                        this.generateRequest();
                    }
                },
                _mergeContexts: function (dataCtx, valCtx, itemCtx, userCtx) {
                    var context = {
                        "app": this.appName,
                        "service": "_ALL",
                        "component": "components-list",
                        "subComponent": "_ALL",
                        "entityType": "",
                        //"relationshipType": "_ALL",
                        //"channel": dataCtx.channel,
                        //"locale": valCtx.locale,
                        //"source": valCtx.source,
                        "role": "",
                        //"user": userCtx.user
                    };

                    if (itemCtx && itemCtx.type) {
                        context.entityType = itemCtx.type;
                    }
                    else {
                        delete context.entityType;
                    }

                    if (userCtx && userCtx.role) {
                        context.role = userCtx.role;
                    }
                    else {
                        delete context.role;
                    }

                    return context;
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                generateRequest: function () {
                    this.shadowRoot.querySelector('#getConfig').generateRequest();
                },

                _onAppConfigsGetResponse: function (e) {
                    if(e.detail){
                        var configs = e.detail.response.content;
                        var ctx = DataHelper.cloneObject(this.request.params.query.contexts[0]);
                        var configJson = SharedUtils.DataObjectFalcorUtil.getConfigByCtx(configs, ctx);

                        if (configJson && configJson.config && configJson.config.components && configJson.config.components.length > 0) {
                            var components = configJson.config.components;
                            components.forEach(function (component) {
                                this._initiateComponentConfigGetRequest(this.appName, ctx, component)
                            }, this);
                        } else {
                            this._sendResponse();
                        }
                    }
                },

                _initiateComponentConfigGetRequest: function (appName, context, componentName) {

                    var liquidElement = document.createElement("liquid-config-get");
                    var clonedContext = DataHelper.cloneObject(context);
                    var req = DataRequestHelper.createConfigGetRequest(appName, clonedContext, componentName);

                    liquidElement.id = componentName;
                    liquidElement.name = componentName;
                    liquidElement.requestData = req;
                    liquidElement.operation = "getbyids";
                    liquidElement.addEventListener("response", this._onComponentConfigGetResponse.bind(this));
                    this.appendChild(liquidElement);

                    this._liquidTracker.push(componentName);
                    liquidElement.generateRequest();
                },

                _onComponentConfigGetResponse: function (e) {
                    if (e.detail) {
                        var configs = e.detail.response.content;
                        var requestedComponent = e.currentTarget.name;
                        var requestCtx = e.detail.request.requestData.params.query.contexts[0];

                        var configJson = SharedUtils.DataObjectFalcorUtil.getConfigByCtx(configs, requestCtx);

                        if (!_.isEmpty(configJson)) {
                            this.configs[requestedComponent] = configJson;
                        }

                        DataHelper.arrayRemove(this._liquidTracker, requestedComponent);
                    }

                    if (this._liquidTracker.length == 0) {
                        this._sendResponse();
                    }
                },

                _sendResponse: function () {
                    var eventName = "config-get-response";
                    var eventDetail = {
                        detail:{
                            components: this.configs
                        },
                        bubbles: this.bubbles,
                        composed: true
                    };

                    this._setLastResponse(eventDetail);
                    this.dispatchEvent(new CustomEvent(eventName, eventDetail));
                }
            });
        })();
    </script>
</dom-module>