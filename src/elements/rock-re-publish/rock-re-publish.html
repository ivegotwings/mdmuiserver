<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<!--<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">-->

<!--<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">-->
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-re-publish">
    <template>
        <style include="bedrock-style-common">
            .message {
                text-align: center;
            }

            .job-nav-screen {
                text-align: center;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>
        <liquid-rest id="rePublish" url="/data/cop/publish" method="POST" request-data={{_rePublishRequest}} on-liquid-response="_onRePublishSuccess"
            on-liquid-error="_onRePublishFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-re-publish',

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    
                    syncThreshold: {
                        type: Number,
                        value: 0
                    },

                    selectionQuery: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    profiles: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },

                    _rePublishRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _rePublishResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _isPublished: {
                        type: Boolean,
                        value: false
                    },
                    selectionMode: {
                        type: String,
                        value: "count"
                    },
                    _workAutomationId: {
                        type: String
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_executeRePublishProcess(selectedEntities)'
                ],
                _executeRePublishProcess: function () {

                    if (this.selectedEntities && this.selectedEntities.length > 0 &&
                        this.profiles && this.profiles.length > 0) {
                        var validatePublishResult = this._validateRePublish();
                        if (validatePublishResult.valid) {

                            this._loading = true;
                            this._message = "Publish process started";
                            this._generateRePublishRequest();
                        }
                        else {
                            this._showToastMessage(validatePublishResult);
                        }
                    }

                },
                _showToastMessage: function (msgObject) {
                    if (msgObject) {
                        if (msgObject.type == "error") {
                            this.showWarningToast(msgObject.message, 10000);
                        } else if (msgObject.type == "success") {
                            this.showSuccessToast(msgObject.message, 10000);
                        }
                    }
                },
                _validateRePublish: function () {
                    var resultObj = {
                        valid: false,
                        type: 'error',
                        message: "welcome"
                    };

                    var selectedEntities = this.selectedEntities;

                    if(this.selectionMode == "query" || (this.selectionMode == "count" && this.selectedEntities.length > this.syncThreshold)) {
                        resultObj.message = "Config Not Found."
                        var rock_republish_config = this.parentElement.__dataHost.config;
                        if (rock_republish_config) {
                            var rePublishConfig = rock_republish_config.steps;
                            if (rePublishConfig && rePublishConfig.length > 0) {
                                var profiles = rePublishConfig[0].component.properties.profiles;
                                if (profiles && profiles.length > 0) {
                                    var typesInConfig = [];

                                    _.each(profiles, function (element) {
                                        typesInConfig = _.union(typesInConfig, element[
                                            "types-criterion"]);
                                    });
                                    var isValid = true;

                                    if(typesInConfig.length > 0) {
                                        for (var index = 0; index < selectedEntities.length; index++) {
                                            var element = selectedEntities[index];
                                            if (typesInConfig[0] != "_ALL" && typesInConfig.indexOf(element.type) == -1) {
                                                isValid = false;
                                                resultObj.message =
                                                    "You can publish only following entity types: " +
                                                    typesInConfig.toString();
                                                break;
                                            }
                                        }
                                    }
                                    resultObj.valid = isValid;
                                }
                            }
                        }
                    } 
                    return resultObj;
                },
                _generateRePublishRequest: function () {
                    //Prepare request without entity
                    var req = DataRequestHelper.createRePublishRequest(this.profiles);
                    if (DataHelper.isValidObjectPath(req, 'params.query.filters.typesCriterion') && req.params.query.filters.typesCriterion.length == 0) {
                        if (DataHelper.isValidObjectPath(this.selectionQuery, 'filters.typesCriterion')) {
                            req.params.query.filters.typesCriterion = this.selectionQuery.filters.typesCriterion;
                        } else if (DataHelper.isValidObjectPath(this.selectionQuery, 'params.query.filters.typesCriterion')) {
                            req.params.query.filters.typesCriterion = this.selectionQuery.params.query.filters.typesCriterion;
                        }
                    }
                    var profileContexts = [];
                    if (this.profiles && this.profiles.length) {
                        var copContext = this.profiles[0].copContext;
                        profileContexts.push(copContext);
                    }
                    if (this.selectionMode == "query" && !_.isEmpty(this.selectionQuery)) {
                        req = {
                            "clientState": {
                                "notificationInfo": {
                                    "userId": DataHelper.getUserId()
                                }
                            },
                            "params": {
                                "fields": {
                                    "relationships": [
                                        "_ALL"
                                    ],
                                    "attributes": [
                                        "_ALL"
                                    ]
                                },
                                "rsconnect": {
                                    "includeValidationData": true,
                                    "profilecontexts": profileContexts
                                }
                            }
                        };
                        if (this.selectionQuery.params && this.selectionQuery.params.isCombinedQuerySearch) {
                            req.params.isCombinedQuerySearch = true;
                            req.params.query = {};
                            req.params.query.entity = this.selectionQuery.entity;
                        } else {
                            req.params.query = this.selectionQuery.params ? this.selectionQuery.params.query : this.selectionQuery;
                        }
                        req.fileName = "EntityData";
                    } else if (this.selectionMode == "count" && this.selectedEntities.length) {
                        var entities = [];
                        for (var i = 0; i < this.selectedEntities.length; i++) {
                            entities.push(this.selectedEntities[i].id);
                        }
                        req["params"]["query"]["ids"] = entities;
                    }
                    if (DataHelper.isHotlineModeEnabled()) {
                        req.hotline = true;
                    }
                    this.set("_rePublishRequest", req);
                    var liquidRePublish = this.shadowRoot.querySelector("#rePublish");
                    if (liquidRePublish) {
                        this.set("_workAutomationId", "");
                        liquidRePublish.generateRequest();
                    }
                },
                _onRePublishSuccess: function (e) {
                    var response = e.detail.response;
                    if (response && response["dataObjectOperationResponse"]) {
                        this.set("_rePublishResponse", response['dataObjectOperationResponse']);
                        if (this._rePublishResponse && this._rePublishResponse["status"]
                            && (this._rePublishResponse["status"] == "success")) {
                            this._isPublished = true;
                            if (this._rePublishResponse["statusDetail"] && this._rePublishResponse["statusDetail"]['childTaskIds']) {
                                var childTaskIds = this._rePublishResponse["statusDetail"]['childTaskIds'];
                                if (childTaskIds.length > 0) {
                                    this._workAutomationId = childTaskIds[0];
                                }
                            }
                        }
                    }
                    this._triggerFinishStep();
                },
                _onRePublishFailure: function (e) {
                    console.warn("Failed to perform publish with error: ", e.detail);
                    this._triggerFinishStep();
                },
                _triggerFinishStep: function () {

                    var data = {
                        "messages": [
                            {
                                "message": "Failed to perform publish. Please contact administrator."
                            }
                        ],
                        "actions": [
                            {
                                "name": "goBack",
                                "text": "Take Me back to Where I started"
                            }
                        ]
                    };

                    if (this._isPublished) {
                        data["messages"][0]["message"] = "Publish successful.";
                        var _resultMessage = "You can view the task details";
                        if (this._workAutomationId) {
                            _resultMessage = "You can view the status of the task " + this._workAutomationId + " in the Task Details";
                        }
                        data["messages"].push({
                            "message": _resultMessage
                        });
                        data["actions"].push({
                            "name": "gotoTaskDetails",
                            "text": "Show me the task details",
                            "dataRoute": "task-detail",
                            "queryParams": {
                                "id": this._workAutomationId
                            }
                        })
                    }
                    this._message = "";
                    this._loading = false;

                    this.businessFunctionData = data;
                    var eventName = "onComplete";
                    var eventDetail = {
                        name: eventName
                    }
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });

                    //Reset
                    this.selectedEntities = [];
                    this.profiles = [];
                },
                _onTapAction: function () {

                }
            });
        })();
    </script>
</dom-module>