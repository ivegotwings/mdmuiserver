<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-datasource-behavior/bedrock-datasource-behavior.html">

<script>
    /***
     * `RUFBehaviors.GridDataSourceBehavior` provides common properties and methods that need to be implemented across all
     *  grid dataSource components. It is a mandatory behavior for all datasource components to implement.
     *
     *  ### Example
     *
     *     <dom-module id="x-grid-datasource">
     *        <template>
     *        </template>
     *        <script>
     *           Polymer({
     *             is: ""x-grid-datasource",
     *
     *             behaviors: [
     *               RUFBehaviors.GridDataSourceBehavior
     *             ],
     *
     *             properties: {
     *              
     *             }
     *           });
     *        &lt;/script>
     *     </dom-module>
     *
     * @polymerBehavior RUFBehaviors.GridDataSourceBehavior
     */

    RUFBehaviors = RUFBehaviors || {};
    RUFBehaviors.GridDataSourceBehaviorImpl = {

        properties: {
            /**
             * Indicates an incremental data size for each page in the grid while use of "dataSource" for virtualization.
             * This is auto calculated.
             **/
            currentRecordSize: {
                type: Number,
                notify: true,
                value: 0
            },

            /**
             * Indicates the total record size of the grid.
             * This is auto calculated.
             */
            totalRecords: {
                type: Number,
                notify: true,
                value: 0
            },

            _lastPage: {
                type: Number,
                value: -1
            }
        },

        /*
         * Indicates a utility method which the user can use to attach listener to an event raised by an element
         * This listener will be invoked only for one time
         */
        _oneTimeEvent: function (element, type, callback) {
            element.addEventListener(type, function (e) {
                e.target.removeEventListener(e.type, arguments.callee);
                return callback(e);
            });
        },

        _prepareRequestOptions: function (data) {
            return {
                "from": data.page * data.pageSize,
                "to": ((data.page * data.pageSize) + data.pageSize) - 1
            };
        },

        _formatResponse: function (data) {
            if (typeof (this.dataFormatter) == 'function') {
                return this.dataFormatter(data);
            }
        },

        _updateCurrentRecordSize: function (options, records) {
            if (options.pageSize <= records.length) {
                if (this.currentRecordSize / options.pageSize >= options.page) {
                    this.currentRecordSize += this.currentRecordSize == 0 ? options.pageSize *
                        2 : options.pageSize;
                }
            } else {
                if (this.currentRecordSize == 0) {
                    this.currentRecordSize = records.length;
                } else {
                    this.currentRecordSize -= options.pageSize;
                }
            }

            this._lastPage = options.page;
            this.totalRecords += records.length;
        },

        _resetDataSource: function () {
            this.currentRecordSize = 0;
            this.totalRecords = 0;
            this._lastPage = -1;
        },
    };

    RUFBehaviors.GridDataSourceBehavior = [RUFBehaviors.DataSourceBehavior, RUFBehaviors.GridDataSourceBehaviorImpl];
</script>