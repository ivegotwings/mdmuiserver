<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">


<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-info-icon/pebble-info-icon.html">

<link rel="import" href="../rock-entity-tofix/rock-entity-tofix.html">
<link rel="import" href="../rock-entity-thumbnail/rock-entity-thumbnail.html">

<link rel="import" href="progress-icons.html">
<!--
`rock-entity-header` Represents an entity header in the entity manage App. It contains the following items:

      1. The attributes of the entity that needs display in the header section.                             

      2. The percentage completion of the entity with the notifications that also indicates warnings.

      3. An Invalid and missed fields of an entity.

      4. A button toolbar with different actions performed on the entity.

An element accepts the attribute list of the respective entity, entity's profile completion, and actions to be
performed.

@group rock Elements
@element rock-entity-header
@demo demo/index.html
-->
<dom-module id="rock-entity-header">
    <template>
        <style include="bedrock-style-common"></style>
        <style>
            :host {
                width: 100%;
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                padding-top: 10px;
                padding-right: 0;
                padding-bottom: 10px;
                padding-left: 0;
                box-sizing: border-box;
                --pebble-toolbar-button-icon: {
                    padding-top: 4.5px;
                    padding-right: 4.5px;
                    padding-bottom: 4.5px;
                    padding-left: 4.5px;
                    border: 0px;
                    min-width: 2.14em;
                    margin-top: 0;
                    margin-right: 0;
                    margin-bottom: 0;
                    margin-left: 0;
                    top: 3px;
                };
                --pebble-popover: {
                    margin-top: 5px;
                };
                --paper-menu-background-color: #ffffff;
                --pebble-horizontal-divider-color: #616161;
            }

            pebble-toolbar {
                --pebble-icon: {
                    width: 16px!important;
                    height: 16px!important;
                    min-width: 16px;
                    margin-top: 0px!important;
                    margin-right: 0px!important;
                    margin-bottom: 0px!important;
                    margin-left: 0px!important;
                };

                --pebble-button: {
                    padding-top: 0;
                    padding-right: 0;
                    padding-bottom: 0;
                    padding-left: 0;
                    margin-top: 0;
                    margin-right: 0;
                    margin-bottom: 0;
                    margin-left: 0;
                };

                --pebble-toolbar-button-icon: {
                    padding-top: 0;
                    padding-right: 0;
                    padding-bottom: 0;
                    padding-left: 0;
                    border: 0px;
                    min-width: 16px;
                    margin-top: 0;
                    margin-right: 0;
                    margin-bottom: 0;
                    margin-left: 0;
                    top: 3px;
                };
            }

            #headerSection {
                width: 100%;
                display: block;
                position:relative;          
                transition: 0.3s ease all;                
                padding:10px 20px;
                height:auto;
                max-height: 200px;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
            }

            #attributePanel {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                flex-wrap: wrap;
                -webkit-flex-wrap: wrap;
                width: calc(70% - 90px);
                float: left;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
                overflow: hidden;
                height: 100%;    
                @apply --layout-horizontal;
            }

            .attribute {
                width: 33%;
                height: 20px;
                line-height: 20px;
                padding-right: 30px;
                -webkit-transition: all 0.4s;
                -moz-transition: all 0.4s;
                -o-transition: all 0.4s;
                transition: all 0.4s;    
            }

            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            #attrName {
                width: 282px;
                height: 20px;
                font-family: var(--default-font-family);
                font-size: var(--default-font-size, 14px);
                font-weight: normal;
                font-style: normal;
                font-stretch: normal;
                color: var(--label-text-color, #1a2028);
                opacity: 0.7;
            }

            #attrVal {
                font-size: var(--font-size-sm, 12px);
                font-weight: var(--font-medium, 500);
                color: var(--buttontext-color, #616161);
            }

            #buttonPanel {
                display: flex;
                display: -webkit-flex;
                align-items: center;
                position: relative;
                top: 50%;
                transform: translateY(-50%);
                z-index:1;
            }

            #buttonPanel pebble-button {
                display: inline-block;
                vertical-align: middle;
            }

            #buttonPanel {
                --paper-toolbar: {
                    display: inline-block;
                    vertical-align: middle;
                }
            }

            #buttonPanel pebble-button {
                margin-right: 5px;
            }

            #buttonPanel pebble-actions,
            #buttonPanel pebble-button {
                height: 20px;
                float: left;
            }

            #buttonPanel pebble-toolbar {
                --paper-toolbar: {
                    height: 20px;
                    float: left;
                }
                --paper-toolbar-content: {
                    height: 20px;
                    float: left;
                    padding-top: 0px;
                    padding-right: 0px;
                    padding-bottom: 0px;
                    padding-left: 0px;
                }
            }

            pebble-actions {
                height: 30px !important;
                vertical-align: super !important;
            }

            rock-entity-thumbnail {
                width: 90px;
                height: 60px;
                float: left;
                padding-right: 20px;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
            }
            #headerSection.header-collapse{
                max-height: 40px;
                padding: 0 10px;
            }
            .header-collapse #attributePanel {
                padding-top: 10px;
            }
            .header-collapse #attribute{
                height: 25px
            }
            .header-collapse rock-entity-thumbnail{
                width: 40px;
                height: 40px;
                padding-right: 15px;
            }
            .toggle-area-outside{
                background: transparent;
                position: absolute;
                z-index: 99;
                height: 1px;
                bottom: 1px;    
                width: 100%;
            }
            .toggle-area{
                position: absolute;
                left: 50%;
                height: 20px;                
                width: 40px;
                bottom: -1px;
                background: var(--palette-pale-grey,#e6ebf0);
                border-top-left-radius: 100px;
                border-top-right-radius: 100px;
                transition: transform 0.4s linear;
                transform-origin: bottom center;
                transform-style: preserve-3D;
            }
            .icon-wrapper{               
                line-height: 20px;
                cursor: pointer;
            }
            .header-collapse .toggle-area{
                transform: rotate(180deg);
                -webkit-transform: rotate(180deg);
                -moz-transform: rotate(180deg);
                -ms-transform: rotate(180deg);
                -o-transform: rotate(180deg);
            }
            .icon-wrapper pebble-icon{
                display:block;
                text-align:center;
            }           
        </style>
        <div id="headerSection" class$="[[_getCollapseClass()]]">
                <template is="dom-if" if="[[collapsable]]">
                    <div class="toggle-area-outside">
                        <div class="toggle-area">
                            <div class="icon-wrapper" on-tap="_toggleCollapse">
                                    <pebble-icon icon="icons:expand-less"></pebble-icon>                               
                            </div>
                        </div>
                    </div>
                </template>
               
                    <rock-entity-thumbnail config="[[thumbnailConfig]]" default-thumbnail-id="[[_defaultThumbnailId]]"></rock-entity-thumbnail>
                    <div id="attributePanel">
                        <template id="headerAttributes" is="dom-repeat" items="[[_headerAttributeValues]]">
                            <div id="attribute" class$="[[_computeAttributeClass(item)]]">
                                <span id="attrName">[[_getAttributeLabel(item)]]</span>
                                <template is="dom-if" if="[[_getDescriptionInfo(item)]]">
                                    <pebble-info-icon description-object="[[_getDescriptionInfo(item)]]"></pebble-info-icon>
                                </template>
                                <span id="attrVal" title="[[item.value]]">[[item.value]]</span>
                            </div>
                        </template>
                    </div>
               
            <div id="buttonPanel" class="pull-right">
                <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onAssignActionTap" target-id=""></bedrock-pubsub>
                <template is="dom-if" if="[[assignmentActionsConfig]]">
                    <pebble-actions id="assignmentActions" readonly$="[[readonly]]" button-icon="pebble-md-icons:assignedactions" class="dropdownText dropdownIcon btn-actions dropdown-success m-r-5"
                        button-text="Assignment Actions" actions-data="[[assignmentActionsConfig]]"></pebble-actions>
                </template>
                <pebble-popover id="tofixPopover" for="pebbleButton" horizontal-align="right" auto-fit-on-attach no-overlap>
                    <rock-entity-tofix data="[[toFixData]]"></rock-entity-tofix>
                </pebble-popover>
                <pebble-toolbar id="entityHeaderToolbar" readonly$="[[readonly]]" config-data="[[buttons]]"></pebble-toolbar>
                <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="entityHeaderToolbar"></bedrock-pubsub>
                <bedrock-pubsub event-name="tabs-change" handler="_onTabsChange"></bedrock-pubsub>
            </div>
        </div>
        <liquid-entity-data-get name="attributeGetDataService" operation="getbyids" request-data="{{headerAttributeRequest}}" 
            on-response="_onHeaderAttributesGetResponse"></liquid-entity-data-get>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{headerAttributeModelRequest}}" 
            on-entity-model-composite-get-response="_onCompositeModelGetResponse"></liquid-entity-model-composite-get>
        <liquid-entity-model-get id="getWorkflowMappingDefinition" operation="getbyids" request-id="req1" request-data={{workflowMappingDefinitionRequest}}
            on-response="_onWfMappingsReceived" on-error="_onMappingsGetFailed"></liquid-entity-model-get>
        <liquid-entity-govern-data-get id="entityGetRunningInstance" operation="getbyids" request-id="req2" request-data={{runningInstanceRequest}}
            on-response="_onRunningInstanceReceived" on-error="_onRunningInstanceGetFailed"></liquid-entity-govern-data-get>
        <liquid-entity-model-get id="entityGetWorkflowDefinition" operation="getbyids" request-id="req1" request-data={{workflowDefinitionRequest}}
            on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <liquid-rest id="entityWfAssignment" url="/data/pass-through/entitygovernservice/workflowChangeAssignment" method="POST"
            request-data={{_wfAssignmentRequest}} on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
    </template>
    <script>
        Polymer({
            is: "rock-entity-header",
            ready: function () {
                this.logInfo("EntityHeaderReady");
            },
            _getDescriptionInfo: function (item) {
                return this._headerAttributeModels[item.name] && this._headerAttributeModels[item.name].properties || {};
            },
            behaviors: [
                RUFBehaviors.ComponentContextBehavior,
                RUFBehaviors.UIBehavior
            ],
            properties: {
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * If set as true , it indicates the component is in read only mode
                 */
                readonly: {
                    type: Boolean,
                    value: false
                },
                /**
                 * Indicates the attributes that gets displayed in the header section.
                 */
                headerConfig: {
                    type: Array,
                    value: []
                },
                /**
                 * Indicates the buttons that gets displayed in the header section toolbar.
                 */
                buttons: {
                    type: Object,
                    value: {}
                },
                /**
                 * Indicates the data of all missing or invalid fields, errors, and warnings of the loaded entity.
                 */
                toFixData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * Indicates the request object that is passed to the data element to retrieve the attribute data.
                 Sample: {
                            action: "getAttributes"
                            }
                 */
                headerAttributeRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * Indicates the request object that is passed to the data element to retrieve the attribute model data.
                 Sample: {
                            action: "getAttributeModels"
                            }
                 */
                headerAttributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {
                        };
                    }
                },
                _headerAttributeValues: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _headerAttributeModels: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * Specifies whether or not to write the logs.
                 */
                verbose: {
                    type: Boolean,
                    value: false
                },
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                assignmentActionsConfig: {
                    type: Object,
                    value: function () { return []; }
                },
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                workflowMappingDefinitionRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                workflowDefinitionRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                runningInstanceRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                _runningInstances: {
                    type: Array,
                    value: function () { return []; }
                },
                _foundWorkflowNames: {
                    type: Array,
                    value: function () { return []; }
                },
                _currentWorkflowAction: {
                    type: String
                },
                _wfAssignmentRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                _failedWorkflows: {
                    type: Array,
                    value: function () { return []; }
                },
                _doneWorkflows: {
                    type: Array,
                    value: function () { return []; }
                },
                _entityAttributes: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _referenceAttributeModels: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _messageAttribute: {
                    type: String,
                    value: null
                },
                _messageAttributeValue: {
                    type: String,
                    value: null
                },
                _runtimeInstanceEntity: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                collapse:{
                    type:Boolean,
                    value:false,
                    reflectToAttribute: true
                },
                collapsable:{
                    type:Boolean,
                    value:false,
                    reflectToAttribute: true
                }
            },
            observers: [
                '_setHeaderValuesAsPerConfig(_headerAttributeValues)'
            ],
            /**
             * <b><i>Content development is under progress... </b></i>
             */
            refresh: function (invalidateEntityCache = true) {
                if (invalidateEntityCache) {
                    //Invalidate entity cache
                    var entity = this._getEntityObject();
                    LiquidDataObjectUtils.invalidateDataObjectCache(entity);
                }

                this._startDataLoad();
                this._setWorkflowActions();
                this._refreshEntityThumbnail();
            },
            _setHeaderValuesAsPerConfig: function () {
                if (this._headerAttributeValues && this._headerAttributeValues.length > 0 && this._messageAttribute) {
                    for (var i = 0; i < this._headerAttributeValues.length; i++) {
                        if (this._headerAttributeValues[i].name == this._messageAttribute) {
                            var configItem = this._getConfigItem(this.headerConfig, this._headerAttributeValues[i].name);
                            this._messageAttributeValue = this._headerAttributeValues[i].value;

                            //Remove if attribute not for header
                            if (!configItem) {
                                this._headerAttributeValues.splice(i, 1);
                            }

                            break;
                        }
                    }
                }
            },
            _getCollapseClass:function(){
                if(this.collapsable && this.collapse){
                    return "header-collapse";
                }else{
                    return "";
                }
            },
            _toggleCollapse:function(){
              var headerSection =  this.shadowRoot.querySelector('#headerSection');
              if(headerSection.classList.contains('header-collapse')){
                headerSection.classList.remove('header-collapse')
              }else{
                headerSection.classList.add('header-collapse')
              }
            },
            /**
             * <b><i>Content development is under progress... </b></i>
             */
            refresh: function (invalidateEntityCache = true) {

                if(invalidateEntityCache) {
                    //Invalidate entity cache
                    var entity = this._getEntityObject();
                    LiquidDataObjectUtils.invalidateDataObjectCache(entity);
                }

                this._startDataLoad();
                this._setWorkflowActions();
                this._refreshEntityThumbnail();
            },
            _refreshEntityThumbnail: function () {
                var entityThumbnailComp = this.shadowRoot.querySelector("rock-entity-thumbnail");
                if (entityThumbnailComp) {
                    entityThumbnailComp.contextData = this.contextData;
                }
            },
            _onToolbarEvent: function (e, detail) {
                this.fireBedrockEvent("toolbar-button-event", detail);
            },
            _startDataLoad: function () {
                var headerConfig = this.headerConfig;
                this.logInfo("EntityHeadDataLoad", "config", JSON.stringify(headerConfig, null, 2));

                if (headerConfig && headerConfig.length > 0 && this.contextData) {
                    var attributeNames = [];

                    for (var i = 0; i < headerConfig.length; i++) {
                        if (headerConfig[i].attributeName) {
                            attributeNames.push(headerConfig[i].attributeName);
                        }
                    }

                    //Add messageAttribute if not available in the request attributes list
                    if (this.assignmentActionsConfig && this.assignmentActionsConfig.length > 0 && this.assignmentActionsConfig[0].messageAttribute) {
                        this._messageAttribute = this.assignmentActionsConfig[0].messageAttribute;
                        if (attributeNames.indexOf(this._messageAttribute) == -1) {
                            attributeNames.push(this._messageAttribute);
                        }
                    }

                    var itemContext = this.getFirstItemContext();
                    //add attribute names in item context
                    itemContext.attributeNames = attributeNames;

                    var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                    this.set("headerAttributeModelRequest", compositeModelGetRequest);
                    var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                    if (liquidModelGet) {
                        liquidModelGet.generateRequest();
                    }
                }
            },
            _onCompositeModelGetResponse: function (e) {
                // this.logInfo("EntityHeaderModelResponse", "response", JSON.stringify(e, null, 2));

                if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                    var entityModel = e.detail.response.content.entityModels[0];
                    var properties = entityModel.properties;
                    if (properties.hasOwnProperty("defaultThumbnailId")) {
                        this._defaultThumbnailId = properties.defaultThumbnailId;
                    }
                    this._headerAttributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);

                    var clonedContextData = DataHelper.cloneObject(this.contextData);
                    var attributeNames = Object.keys(this._headerAttributeModels);

                    if (clonedContextData && attributeNames.length > 0) {
                        //add attribute names in item context
                        var itemContext = this.getFirstItemContext();
                        itemContext.attributeNames = attributeNames;
                        clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                        this.set("headerAttributeRequest", DataRequestHelper.createEntityGetRequest(clonedContextData, true, true));
                        this.shadowRoot.querySelector("liquid-entity-data-get").generateRequest();
                    }
                }
            },
            _onHeaderAttributesGetResponse: function (e) {
                var headerAttributeResponse = e.detail.response;

                this.logInfo("EntityHeaderAttributeResponse", "response", JSON.stringify(headerAttributeResponse, null, 2));

                var attributesData = [];
                if (DataHelper.validateGetEntitiesResponse(headerAttributeResponse) && this._headerAttributeModels) {
                    var entity = headerAttributeResponse.content.entities[0];

                    if (entity) {
                        var attributesData = DataTransformHelper.transformAttributes(entity, this._headerAttributeModels, this.contextData, "array", false);
                        this._entityAttributes = attributesData;

                        var self = this;
                        //Find the date attributes and change the values from ISO
                        Object.keys(this._headerAttributeModels).map(function (attributeModel) {
                            if (self._headerAttributeModels[attributeModel].dataType == "datetime" ||
                                self._headerAttributeModels[attributeModel].dataType == "date") {
                                var datatype = self._headerAttributeModels[attributeModel].dataType;
                                for (var i = 0; i < attributesData.length; i++) {
                                    if (self._headerAttributeModels[attributeModel].name == attributesData[i].name) {
                                        attributesData[i].value = FormatHelper.convertFromISODateTime(attributesData[i].value, datatype);
                                        break;
                                    }
                                }
                            }
                        });

                        this.set("_headerAttributeValues", this._entityAttributes);
                        this.$.headerAttributes.render();
                    }
                }
            },
            _getAttributeLabel: function (attributeItem) {
                var configItem = this._getConfigItem(this.headerConfig, attributeItem.name);

                if (configItem && configItem.label) {
                    return configItem.label;
                }

                var attributeModel = this._headerAttributeModels[attributeItem.name];

                if (attributeModel && attributeModel.properties && attributeModel.properties.externalName) {
                    return attributeModel.properties.externalName;
                }
            },
            _getAttributeValue: function (values, configItem) {
                var attrValue = "";
                for (var i = 0; i < values.length; i++) {
                    var attributes = values[i].attributes;
                    for (var j = 0; j < attributes.length; j++) {
                        if (attributes[j].name == configItem.attributeName) {
                            attrValue = attributes[j].value;
                        }
                    }
                }
            },
            _computeIcon: function (percentage) {
                var per = Math.round(percentage / 10) * 10;
                return "pebble-md-icons:Percentage";
            },
            _openPopover: function () {
                this.$.tofixPopover.show();
            },
            _computeAttributeClass: function (attributeValue) {
                var configItem = this._getConfigItem(this.headerConfig, attributeValue.name);
                if (configItem) {
                    if (configItem.noTrim) {
                        return "attribute";
                    } else {
                        return "attribute trim";
                    }
                }
            },
            _getConfigItem: function (headerConfig, attributeName) {
                for (var i = 0; i < headerConfig.length; i++) {
                    if (headerConfig[i].attributeName == attributeName) {
                        return headerConfig[i];
                    }
                }
            },
            _setWorkflowActions: function () {
                if (!_.isEmpty(this.contextData)) {
                    this.workflowMappingDefinitionRequest = DataRequestHelper.createWorkflowMappingGetRequest(this.contextData);
                    this.shadowRoot.querySelector('#getWorkflowMappingDefinition').generateRequest();
                }
            },
            _toggleActionItems: function (runtimeInstanceEntity) {
                var assignmentActions = this.shadowRoot.querySelector("#assignmentActions");
                if (assignmentActions) {
                    var items = assignmentActions.getActionItems();
                    var userContext = ContextHelper.getFirstUserContext(this.contextData);
                    var assignedUser;

                    if (DataHelper.isValidObjectPath(runtimeInstanceEntity, "data.contexts.0.attributes.activities.group.0.assignedUser")) {
                        assignedUser = AttributeHelper.getFirstAttributeValue(runtimeInstanceEntity.data.contexts[0].attributes.activities.group[0].assignedUser);
                    }

                    //Default enable both
                    if (!_.isEmpty(items)) {
                        for (var i = 0; i < items.length; i++) {
                            items[i].removeAttribute("disabled");
                        }
                    }



                    if (assignedUser && !_.isEmpty(userContext) && !_.isEmpty(items)) {
                        var disableActionName;
                        var user = userContext.user;
                        if (user.lastIndexOf("_user") > 0) {
                            user = user.replace('_user', '');
                        }
                        if (assignedUser.lastIndexOf("_user") > 0) {
                            assignedUser = assignedUser.replace('_user', '');
                        }
                        if (user == assignedUser) {
                            disableActionName = "takeTask";
                        }
                        else {
                            disableActionName = "releaseTask";
                        }

                        for (var i = 0; i < items.length; i++) {
                            if (items[i].data.name == disableActionName) {
                                items[i].setAttribute("disabled", "");
                                break;
                            }
                        }
                    }
                }
            },
            _onAssignActionTap: function (e, detail, sender) {
                this._failedWorkflows = [];
                this._doneWorkflows = [];
                if (detail) {
                    if (detail.data.eventName == "action-takeTask") {
                        this._currentWorkflowAction = "take";
                    }
                    if (detail.data.eventName == "action-releaseTask") {
                        this._currentWorkflowAction = "release";
                    }

                    if (this._runtimeInstanceEntity && this._runtimeInstanceEntity.data) {
                        var foundWorkflowNames = [];
                        var runningInstances = [];

                        //Note: Here, workflow runtime data would be always in the context of workflow so no need to check for data.attributes
                        var contexts = this._runtimeInstanceEntity.data && this._runtimeInstanceEntity.data.contexts ? this._runtimeInstanceEntity.data.contexts : [];

                        for (var i = 0; i < contexts.length; i++) {
                            var currContextItem = contexts[i];
                            var currContext = currContextItem.context;
                            var currWorkflowName = currContext.workflow;
                            var contextAttrs = currContextItem.attributes;

                            if (currWorkflowName) {
                                var runtimeInstance = {
                                    "name": currWorkflowName,
                                    "activityName": AttributeHelper.getFirstAttributeValue(contexts[i].attributes.activities.group[0].activityName)
                                };

                                runningInstances[currWorkflowName] = {};
                                runningInstances[currWorkflowName] = runtimeInstance;
                                foundWorkflowNames.push(currWorkflowName);
                            }
                        }
                        if (foundWorkflowNames.length > 0) {
                            this.set("_runningInstances", runningInstances);
                            this.set("_foundWorkflowNames", foundWorkflowNames);
                            var itemContext = this.getFirstItemContext();
                            itemContext.workflowNames = foundWorkflowNames;

                            this.workflowDefinitionRequest = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                            this.shadowRoot.querySelector("#entityGetWorkflowDefinition").generateRequest();
                        } else {
                            this.showErrorToast("Entity is not available in any workflow.");
                        }
                    }
                }
            },
            _onWfMappingsReceived: function (e) {
                var response = e.detail.response;
                if (response) {
                    var mappingModels = response.content && response.content.entityModels ? response.content.entityModels : [];
                    if (mappingModels.length > 0) {
                        var wfDefinitionMappingModel = mappingModels.find(obj => obj.type == "workflowDefinitionMapping");
                        var wfRelationships = DataMergeHelper.mergeWorkflowMappings(wfDefinitionMappingModel, this.contextData);
                        var mappedWorkflowNames = DataHelper.getRelToNames(wfRelationships.hasWorkflowsDefined);
                        this.set("_mappedWorkflowNames", mappedWorkflowNames);
                        var itemContext = this.getFirstItemContext();
                        itemContext.workflowNames = this._mappedWorkflowNames;

                        this.runningInstanceRequest = DataRequestHelper.createWorkflowRuntimeInstanceGetRequest(this.contextData);
                        this.shadowRoot.querySelector('#entityGetRunningInstance').generateRequest();
                    }
                }
            },
            _onMappingsGetFailed: function (e) {
                this.logWarning("WorkFlowMappingError", "response", JSON.stringify(e.detail));
                this.showErrorToast("Failed to get workflow mappings. Please contact administrator.");
            },
            _onRunningInstanceReceived: function (e) {

                if (e.detail.response) {
                    var runtimeInstanceEntities = e.detail.response && e.detail.response.content && e.detail.response.content.entities
                        ? e.detail.response.content.entities : [];

                    if (runtimeInstanceEntities.length > 0) {
                        //console.log('runtime instance entities ', JSON.stringify(runtimeInstanceEntities, null, 2));

                        this._runtimeInstanceEntity = runtimeInstanceEntities[0];
                        this._toggleActionItems(this._runtimeInstanceEntity);
                    }
                }
            },
            _onRunningInstanceGetFailed: function (e) {
                this.logWarning("WorkFlowStatusError", "response", JSON.stringify(e.detail));
                this.showErrorToast("Failed to get workflow status. Please contact administrator.");
            },
            _onDefinitionReceived: function (e) {
                var workflowDefinitionResponse = e.detail.response;
                if (workflowDefinitionResponse && workflowDefinitionResponse.content && workflowDefinitionResponse.content.entityModels && workflowDefinitionResponse.content.entityModels.length > 0) {
                    var workflowData = [];

                    for (var i = 0; i < workflowDefinitionResponse.content.entityModels.length; i++) {
                        var entityModel = workflowDefinitionResponse.content.entityModels[i];
                        var workflowName = entityModel.name;

                        if (entityModel.data && entityModel.data.attributes) {
                            var wfAttributes = entityModel.data.attributes;
                            this._runningInstances[workflowName]["wfLongName"] = AttributeHelper.getFirstAttributeValue(wfAttributes.workflowName);

                            var workflowActivites = wfAttributes.activities;
                            if (workflowActivites) {
                                var workflowActivitiesGroup = workflowActivites.group;
                                if (workflowActivitiesGroup && workflowActivitiesGroup instanceof Array) {
                                    for (var i = 0; i < workflowActivitiesGroup.length; i++) {
                                        var activityName = AttributeHelper.getFirstAttributeValue(workflowActivitiesGroup[i].activityName);
                                        if (activityName === this._runningInstances[workflowName]["activityName"]) {
                                            this._runningInstances[workflowName]["activityExternalName"] = AttributeHelper.getFirstAttributeValue(workflowActivitiesGroup[i].externalName);
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    this._currentWfIndex = 0;
                    this._generateAssignmentRequest();
                }
            },
            _onDefinitionGetFailed: function (e) {
                Polymer.Base._error('workflow definition get failed with error ', e.detail);
            },
            _getWfCriterion: function (runtimeInstance) {
                var wfCriterion;
                if (runtimeInstance && runtimeInstance.name && runtimeInstance.activityName) {
                    wfCriterion = {
                        "workflowShortName": runtimeInstance.name,
                        "workflowActivityName": runtimeInstance.activityName
                    };
                }
                return wfCriterion;
            },
            _getEntityObject: function () {
                var itemCtx = ContextHelper.getFirstItemContext(this.contextData);
                var entity = {
                    "id": itemCtx.id,
                    "type": itemCtx.type
                };
                return entity;
            },
            _generateAssignmentRequest: function () {
                var entity = this._getEntityObject();
                var runtimeInstance = this._runningInstances[this._foundWorkflowNames[this._currentWfIndex]];
                var wfCriterion = this._getWfCriterion(runtimeInstance);
                if (!_.isEmpty(wfCriterion)) {
                    var req = DataRequestHelper.createWfChangeAssignmentRequest(entity, wfCriterion, this.contextData, this._currentWorkflowAction);

                    //Add hotline flag if hotline is enabled
                    if (DataHelper.isHotlineModeEnabled()) {
                        req.hotline = true;
                    }

                    this.set("_wfAssignmentRequest", req);
                    var liquidWfAssign = this.shadowRoot.querySelector("#entityWfAssignment");
                    if (liquidWfAssign) {
                        liquidWfAssign.generateRequest();
                    }
                }
            },
            _onAssignmentSuccess: function (e) {
                var response = e.detail.response;
                var entity = this._getEntityObject();
                if (response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                    var statusDetail = response.response.statusDetail;
                    var workflowJson = this._runningInstances[this._foundWorkflowNames[this._currentWfIndex]];
                    if (statusDetail.messages && statusDetail.messages.length > 0) {
                        this._failedWorkflows.push(workflowJson);
                    } else if (statusDetail.message) {
                        this._doneWorkflows.push(workflowJson);
                    }
                }
                this._currentWfIndex++;
                if (this._currentWfIndex < this._foundWorkflowNames.length) {
                    this._generateAssignmentRequest();
                } else if (response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                    var messageObject = this._getMessageObject();
                    this._showToastMessage(messageObject);
                    setTimeout(() => {
                        //this._refreshView();
                        var eventName = "workflow-assignment-complete";
                        var eventDetail = {
                            name: eventName
                        }
                        this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                    }, 5000)
                }
                else {
                    this.showErrorToast("There is a problem with the server.Please try after some time")
                }
            },
            _onAssignmentFailure: function (e) {
                this.logWarning("WorkFlowAssignmentFailure", "response", JSON.stringify(e.detail));
                this.showErrorToast("Failed to perform the workflow assignment. Please contact administrator.");
            },
            _refreshView: function () {
                var contentView = undefined;
                var app = ComponentHelper.getCurrentActiveApp();
                if (app) {
                    contentView = ComponentHelper.getComponentContainer(app);
                }
                if (contentView) {
                    contentView.render();
                }
            },
            _buildMessage: function (workflows, message) {
                for (var i = 0; i < workflows.length; i++) {
                    message = message + "{0} as part of {1} business process, ".format(workflows[i].activityExternalName, workflows[i].wfLongName)
                }
                return message;
            },
            _getMessageObject: function () {
                var entity = this._getEntityObject();
                var entityName;

                entityName = this._messageAttributeValue ? this._messageAttributeValue + " (" + entity.id + ")" : entity.id;
                var messageObject = {
                    "message": "",
                    "type": ""
                };
                var actionDone;
                if (this._currentWorkflowAction == "take") {
                    actionDone = "assigned to";
                }
                if (this._currentWorkflowAction == "release") {
                    actionDone = "released from";
                }
                if (this._foundWorkflowNames.length == this._doneWorkflows.length && this._foundWorkflowNames.length == 1) {
                    var workflowJson = this._doneWorkflows[0];
                    messageObject.message = "The {0} of type {1} selected is in {2} as part of {3} business process has been {4} you.".format(entityName, entity.type, workflowJson.activityExternalName, workflowJson.wfLongName, actionDone);
                    messageObject.type = "success";
                } else if (this._foundWorkflowNames.length == this._failedWorkflows.length && this._foundWorkflowNames.length == 1) {
                    var workflowJson = this._failedWorkflows[0];
                    messageObject.message = "You do not have permission to take an action on this {0}. Workflow name: {1}; Step: {2}. \nPlease contact your administrator.".format(entity.type, workflowJson.activityExternalName, workflowJson.wfLongName);
                    messageObject.type = "error";
                } else if (this._foundWorkflowNames.length == this._doneWorkflows.length) {
                    var message = "The {0} of type {1} selected is in ".format(entityName, entity.type);
                    message = this._buildMessage(this._doneWorkflows, message);
                    message = message + "have been {0} you".format(actionDone);
                    messageObject.message = message;
                    messageObject.type = "success";
                }
                else if (this._foundWorkflowNames.length == this._failedWorkflows.length) {
                    var message = "You do not have permission to take an action on this {1} as part of ".format(entityName, entity.type);
                    message = this._buildMessage(this._failedWorkflows, message);
                    message = message + "as you do not belong to role mapped to the workflow steps in the system. \nPlease contact your administrator.";
                    messageObject.message = message;
                    messageObject.type = "error";
                }
                else {
                    var message1 = "The {0} of type {1} selected is in ".format(entityName, entity.type);
                    message1 = this._buildMessage(this._doneWorkflows, message1);
                    message1 = message1 + "have been {0} you.".format(actionDone) + '<br>';

                    var message2 = "You do not have permission to take an action on this {1} as part of ".format(entityName, entity.type);
                    message2 = this._buildMessage(this._failedWorkflows, message2);
                    message2 = message2 + "as you do not belong to role mapped to the workflow steps in the system. \nPlease contact your administrator.";

                    messageObject.message = message1 + message2;
                    messageObject.type = "success";
                }
                return messageObject;
            },
            _showToastMessage: function (msgObject) {
                if (msgObject) {
                    if (msgObject.type == "error") {
                        this.showErrorToast(msgObject.message, 10000);
                    } else if (msgObject.type == "success") {
                        this.showSuccessToast(msgObject.message, 10000);
                    }
                }
            },
            _onTabsChange: function (event) {
                if (event && event.detail) {
                    if (event.detail == 'summary'|| event.detail == 'entity-graph') {
                        this.shadowRoot.querySelector('pebble-toolbar').toggleHideShowEdit(true);
                    }else{
                        this.shadowRoot.querySelector('pebble-toolbar').toggleHideShowEdit(false);
                    }
                }
            }

        });
    </script>
</dom-module>