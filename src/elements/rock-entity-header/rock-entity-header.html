<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="progress-icons.html">
<!--
    `rock-entity-header` represents entity header element in the entity manage app. Contains of attributes
    of the entity that are to be shown in header section, percentage completion of the entity with notifications
    indicating warnings, invalid and missed fields of the entity and a button toolbar with different actions
    performed on the entity.

    Element accepts attribute list of the respective entity, entity's profile completion and actions to be
    performed.
-->
<dom-module id="rock-entity-header">
    <template>
        <style>
            :host {
                width: 100%;
                display: flex;
                --pebble-toolbar-button-icon: {
                            padding: 4.5px;
                            border: 0px;
                            min-width: 2.14em;
                            margin: 0px;
                            top: 3px;
                            color: #616161;
                        }
                --pebble-toolbar-menubutton: {
                    border: 0px;
                }
                --pebble-button: {
                    color: green;
                    font-weight:500;
                }
                --pebble-button-iron-icon: {
                    height: 18px;
                    width: 18px;
                    margin-right: 5px;
                }
                --pebble-toolbar-pebble-button-menu-item-icon: {
                    width: 20px;
                    height: 20px;
                }
                --paper-menu-background-color: #ffffff;
                --pebble-horizontal-divider-color: #616161;
            }
            #headerSection {
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            #attributePanel {
                display: flex;
                flex-wrap: wrap;
                @apply(--layout-horizontal);
                width:75%;
            }
            .attribute {
                width: 33%;
                flex: 1 1 auto;
            }
            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }
            #attrName {
                font-size: 17px;
                font-weight:600;
                color: #bbb;
                padding-left: 10px;
            }
            #attrVal {
                font-size: 17px;
                font-weight:600;
                color: #616161;
            }
            #buttonPanel {
                @apply(--layout-horizontal);
                @apply(--layout-flex);
                display: inline-block;
                margin-top: 20px;
            }
            .container {
                height: 40px;
                margin-left: 10px;
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            .badge {
                @apply(--layout);
                @apply(--layout-center-center);
                @apply(--paper-font-common-base);

                font-weight: normal;
                font-size: 11px;
                border-radius: 50%;
                margin-right:10px;
                width: 30px;
                height: 30px;
                background-color: #ff4081;
                opacity: 1.0;
                color: white;
            }
            iron-icon {
                --iron-icon-width: 20px;
                --iron-icon-height: 20px;
            }
        </style>
           <div id="headerSection">
                <div id="attributePanel">
                    <template is="dom-repeat" items="[[headerAttributes]]">
                            <div id="attribute" class$="[[_computeAttributeClass(item)]]">
                                <span id="attrName">[[_getAttributeLabel(headerAttributeModelResponse, item)]] :</span>
                                <span id="attrVal">[[_getAttributeValue(headerAttributeResponse, item)]]</span>
                            </div>
                    </template>
                </div>
                <div id="buttonPanel" align="right">
                    <pebble-button id="pebbleButton" class="iconTextButton" on-click="_openPopover" icon="[[_computeIcon(profile.completionPercentage)]]" button-text="[[profile.completionPercentage]]%"></pebble-button>
                    <pebble-popover id="warningsPopover" for="pebbleButton" horizontal-align="right" auto-fit-on-attach no-overlap>
                        <template is="dom-repeat" items="[[profile.warnings]]">
                            <div class="container">
                                    <div class="badge">
                                        <iron-icon icon="warning"></iron-icon>
                                    </div>
                                <div id="message">
                                    [[item.message]]
                                </div>
                            </div>
                        </template>
                        <pebble-horizontal-divider></pebble-horizontal-divider>
                        <template is="dom-repeat" items="[[profile.errors]]">
                            <div class="container">
                                <div class="badge">
                                    <iron-icon icon="close"></iron-icon>
                                </div>
                                <div id="message">
                                    [[item.message]]
                                </div>
                            </div>
                        </template>
                        <pebble-horizontal-divider></pebble-horizontal-divider>
                        <template is="dom-repeat" items="[[profile.information]]">
                            <div class="container">
                                <div class="badge">
                                    <iron-icon icon="error"></iron-icon>
                                </div>
                                <div id="message">
                                    [[item.message]]
                                </div>
                            </div>
                        </template> 
                    </pebble-popover>
                    <pebble-toolbar config-data="[[buttons]]"></pebble-toolbar>
                </div>
            </div>
            <liquid-entity-get name="headerAttributeGetService" request="[[headerAttributeRequest]]" response="{{headerAttributeResponse}}"></liquid-entity-get>
            <liquid-entity-get name="headerAttributeModelGetService" request="[[headerAttributeModelRequest]]" response="{{headerAttributeModelResponse}}"></liquid-entity-get>
    </template>
    <script>
        Polymer({
            is: "rock-entity-header",

            properties: {
                /**
                * Indicates attributes data that are to be displayed in header section.
                */
                headerAttributes: {
                    type: Array,
                    value: []
                },
                /**
                * Indicates buttons data that are to be displayed in header section toolbar.
                */
                buttons: {
                    type: Object,
                    value: {}
                },
                /**
                * Indicates data of all missing or invalid fields, errors and warnings of the loaded entity
                */
                profile: {
                    type: Object,
                    value: {}
                },
                /**
                * Indicates the request object that is passed to the data element to retrive attribute data.
                    Sample: { 
                            action: "getAttributes" 
                            }
                */
                headerAttributeRequest: {
                    type: Object,
                    value: function(){
                    return { action: "getHeaderAttribute" };
                    }
                },
                /**
                * Indicates the response object that is received from the data element for the attribute get request.
                */
                headerAttributeResponse: {
                    type: Object,
                    value: function(){
                    return {};
                    }
                },
                /**
                * Indicates the request object that is passed to the data element to retrive attribute model data.
                    Sample: { 
                            action: "getAttributeModels" 
                            }
                */
                headerAttributeModelRequest: {
                    type: Object,
                    value: function(){
                    return { action: "getHeaderAttributeModels" };
                    }
                },
                /**
                * Indicates the response object that is received from the data element for the attribute model get request.
                */
                headerAttributeModelResponse: {
                    type: Object,
                    value: function(){
                    return {};
                    }
                },
            },

            _getAttributeLabel: function(attributeModelResponse, attribute) {
                var attributeModel = this._getAttributeModel(attributeModelResponse, attribute)
                if(attributeModel && attributeModel.longName) {
                    return attributeModel.longName;
                }
                else {
                    return attribute.label;
                }
            },

            _getAttributeValue: function(attributeResponse, attribute) {
                var locale = 'en-US', time = 'now', source = 'golden';
                var attrValue;
                if(attributeResponse && attributeResponse.returnValue && attributeResponse.returnValue.attributes) {
                    var attributes = attributeResponse.returnValue.attributes;
                    var attr = attributes[attribute.attributeName];
                    if(attr && attr.values) {
                        attrValue = this._getCurrentValue(attr.values, locale, time, source);
                    }
                    if(attrValue == undefined) {
                        attrValue = this._getEmptyValue(locale, time, source);
                    }
                    return attrValue.value;
                }
            },
            _getCurrentValue: function(values, locale, time, source) {
                var value;
                if(values) {
                    for(var i=0;i<values.length;i++) {
                        var currentValue = values[i];
                        if(currentValue.locale && currentValue.locale != locale) {
                            continue;
                        }
                        if(currentValue.source && currentValue.source != source) {
                            continue;
                        }
                        value = currentValue;
                        }
                    }
                return value;
            },
            _getEmptyValue: function(locale, time, source) {
                return {
                    "value": "",
                    "locale": locale,
                    "time": time,
                    "source": source
                };
            },
            _getAttributeModel: function(attributeModelResponse, attribute) {
                if(attribute && attributeModelResponse && attributeModelResponse.returnValue 
                    && attributeModelResponse.returnValue.attributeModels){
                    for(var attributeGroupName in attributeModelResponse.returnValue.attributeModels) {
                        if(attribute.attributeName in attributeModelResponse.returnValue.attributeModels[attributeGroupName]) {
                            return attributeModelResponse.returnValue.attributeModels[attributeGroupName][attribute.attributeName];
                        }
                    }
                }
            },

            _computeIcon: function(percentage) {
                var per = Math.round(percentage/10)*10;
                return "progress:progress-" + per;
            },
            _openPopover: function() {
                    this.$.warningsPopover.show();
            },
            _computeAttributeClass: function(attribute) {
                if(attribute.noTrim) {
                    return "attribute";
                }
                else {
                    return "attribute trim";
                }
            }
        })
    </script>
</dom-module>