<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-entity-tofix/rock-entity-tofix.html">

<link rel="import" href="progress-icons.html">
<!--
`rock-entity-header` Represents an entity header in the entity manage App. It contains the following items:
      `*` Attributes of the entity that needs display in the header section.
      `*` Percentage completion of the entity with notifications that also indicates warnings.
      `*` Invalid and missed fields of an entity.
      `*` A button toolbar with different actions performed on the entity.
An element accepts attribute list of the respective entity, entity's profile completion, and actions to be
performed.

@group rock Elements
@element rock-entity-header
@demo demo/index.html
-->
<dom-module id="rock-entity-header">
    <template>
        <style include="pebble-styles-shared"></style>
        <style>
             :host {
                width: 100%;
                display: flex;
                display: -webkit-flex;
                /* Safari */
                padding: 10px 0;
                box-sizing: border-box;
                --pebble-toolbar-button-icon: {
                    padding: 4.5px;
                    border: 0px;
                    min-width: 2.14em;
                    margin: 0px;
                    top: 3px;
                }
                --paper-menu-background-color: #ffffff;
                --pebble-horizontal-divider-color: #616161;
            }

            pebble-toolbar::shadow paper-button-group pebble-button::shadow iron-icon,
            pebble-button::shadow iron-icon,
            pebble-toolbar::shadow paper-button-group pebble-button::shadow paper-button {
                width: 16px!important;
                height: 16px!important;
                min-width: 16px;
                margin: 0 10px !important;
                --pebble-toolbar-button-icon: {
                    padding: 4.5px;
                    border: 0px;
                    min-width: 2.14em;
                    margin: 0px;
                    top: 3px;
                    color: var(--buttontext-color, #616161);
                }
            }

            :host::shadow pebble-popover{
                margin-top: 5px;
            }

            #headerSection {
                width: 100%;
                display: block;
                z-index:1;
            }

            #attributePanel {
                display: flex;
                display: -webkit-flex;
                /* Safari */
                flex-wrap: wrap;
                -webkit-flex-wrap: wrap;
                /* Safari 6.1+ */
                @apply(--layout-horizontal);
                width: 70%;
                float: left;
              
            }

            .attribute {
                width: 33%;
                height: 20px;
                line-height: 20px;
                padding-right: 30px;
            }

            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            #attrName {
                width: 282px;
                height: 20px;
                font-family: var(--default-font-family);
                font-size: var(--default-font-size, 14px);
                font-weight: normal;
                font-style: normal;
                font-stretch: normal;
                color: var(--attrpanel-color-text, #1a2028);
                opacity: 0.7;
            }

            #attrVal {
                font-size: var(--font-size-sm, 12px);
                font-weight: var(--font-medium, 500);
                color: var(--buttontext-color, #616161);
            }

            #buttonPanel {
                display: inline-block;
                position: relative;
                top: 50%;
                transform: translateY(-50%);
            }

            #buttonPanel pebble-button,
            #buttonPanel pebble-toolbar::shadow paper-toolbar {
                display: inline-block;
                vertical-align: middle;
            }

            #buttonPanel pebble-button {
                margin-right: 5px;
            }
            
            #buttonPanel pebble-actions,
            #buttonPanel pebble-button,
            #buttonPanel pebble-toolbar::shadow paper-toolbar::shadow .toolbar-tools,
            #buttonPanel pebble-toolbar::shadow paper-toolbar {
                height: 20px;
                float: left;
            }

            #buttonPanel pebble-toolbar::shadow paper-toolbar::shadow .toolbar-tools {
                padding: 0;
            }
            
            rock-entity-tofix::shadow .container{
                padding-left: 10px;
            }
            #tofixPopover{
                padding:5px 0px;
            }
            #tofixPopover rock-entity-tofix::shadow .container{
                padding:5px 10px;
            }
            #tofixPopover rock-entity-tofix::shadow .container:hover::before{ 
                position: absolute;
                content: ''; 
                top: 0;
                width:10px;
                bottom: 0;
                left: -10px;  
                background-color:var(--bgColor-hover,#e8f4f9);
              
            }
            #tofixPopover rock-entity-tofix::shadow .container:hover::after{ 
                position: absolute;
                content: ''; 
                top: 0;
                width: 0px;
                bottom: 0;
                right: 0px ; 
                background-color:var(--bgColor-hover,#e8f4f9);
            }

            pebble-actions {
                height: 30px !important;
                vertical-align: super !important;
            }

            pebble-actions::shadow pebble-popover paper-item {
                /*display: block;*/
                padding: 5px 10px;
                text-align: left;
            }
            
            pebble-actions::shadow pebble-popover {
                color: var(--palette-white, #fff);
            }
            
            pebble-actions::shadow pebble-popover paper-item #actionItem {
                /*display: inline-block;*/
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-steel-grey);
            }
            
            pebble-actions::shadow pebble-popover paper-item #actionItem:hover {
                color: var(--focused-line, #026bc3);
                background-color: var(--bgColor-hover, #e8f4f9);
            }
            
            pebble-actions::shadow pebble-popover paper-item #actionItem:focus {
                color: var(--primary-button-color, #036bc3);
            }
            
            pebble-actions::shadow #actionsPopover {
                margin-top: 3px;
            }
        </style>
        <div id="headerSection">
            <div id="attributePanel">
                <template is="dom-repeat" items="[[_headerAttributeValues]]">
                    <div id="attribute" class$="[[_computeAttributeClass(item)]]">
                        <span id="attrName">[[_getAttributeLabel(item)]] :</span>
                        <span id="attrVal">[[item.value]]</span>
                    </div>
                </template>
            </div>
            <div id="buttonPanel" class="pull-right">
                <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onAssignActionTap" target-id=""></bedrock-pubsub>
                <pebble-actions id="assignmentActions" button-icon="pebble-md-icons:assignedactions" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
                                button-text="Assignment Actions" actions-data="[[assignmentActionsConfig]]"></pebble-actions>
                <pebble-popover id="tofixPopover" for="pebbleButton" horizontal-align="right" auto-fit-on-attach no-overlap>
                    <rock-entity-tofix data="[[toFixData]]"></rock-entity-tofix>
                </pebble-popover>
                <pebble-toolbar id="entityHeaderToolbar" config-data="[[buttons]]"></pebble-toolbar>
                <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="entityHeaderToolbar"></bedrock-pubsub>
            </div>
        </div>
        <liquid-entity-data-get name="attributeGetDataService" operation="getbyids" request-data="{{headerAttributeRequest}}" 
                on-response="_onHeaderAttributesGetResponse"></liquid-entity-data-get>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{headerAttributeModelRequest}}"
                on-entity-model-composite-get-response = "_onCompositeModelGetResponse" >
        <liquid-entity-model-get id="getWorkflowMappingDefinition" operation="getbyids" request-id="req1" request-data={{workflowMappingDefinitionRequest}}
            on-response="_onWfMappingsReceived" on-error="_onMappingsGetFailed"></liquid-entity-model-get>
        <liquid-entity-govern-data-get id="entityGetRunningInstance" operation="getbyids" request-id="req2" request-data={{runningInstanceRequest}}
            on-response="_onRunningInstanceReceived" on-error="_onRunningInstanceGetFailed"></liquid-entity-govern-data-get>
        <liquid-entity-model-get id="entityGetWorkflowDefinition" operation="getbyids" request-id="req1" request-data={{workflowDefinitionRequest}}
            on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <liquid-rest id="entityWfAssignment" url="/pass-through/entitygovernservice/workflowChangeAssignment" method="POST" request-data={{_wfAssignmentRequest}}
            on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
    </template>
    <script>
        Polymer({
            is: "rock-entity-header",
            ready: function () {
                if (this.verbose) {
                    console.log('entity header ready');
                }
            },
            behaviors: [
                RUFBehaviors.ComponentContextBehavior,
                RUFBehaviors.UIBehavior
            ],
            properties: {
                contextData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                /**
                 * Indicates the attributes that gets displayed in the header section.
                 */
                headerConfig: {
                    type: Array,
                    value: []
                },
                /**
                 * Indicates the buttons that gets displayed in header section toolbar.
                 */
                buttons: {
                    type: Object,
                    value: {}
                },
                /**
                 * Indicates the data of all missing or invalid fields, errors, and warnings of the loaded entity.
                 */
                toFixData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                * Indicates the request object that is passed to the data element to retrive the attribute data.
                    Sample: { 
                            action: "getAttributes" 
                            }
                */
                headerAttributeRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                * Indicates the request object that is passed to the data element to retrive the attribute model data.
                    Sample: { 
                            action: "getAttributeModels" 
                            }
                */
                headerAttributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {
                        };
                    }
                },
                _headerAttributeValues: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _headerAttributeModels: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * Specifies whether or not to write the logs.
                 */
                verbose: {
                    type: Boolean,
                    value: false
                },
                assignmentActionsConfig: {
                    type: Object,
                    value: function() { return {}; }
                },
                workflowMappingDefinitionRequest: {
                    type: Object,
                    value: function() { return {}; }
                },
                workflowDefinitionRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                runningInstanceRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                _runningInstances: {
                    type: Array,
                    value: function () { return []; }
                },
                _foundWorkflowNames: {
                    type: Array,
                    value: function () { return []; }
                },
                _currentWorkflowAction: {
                    type: String
                },
                _wfAssignmentRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                _failedWorkflows: {
                    type: Array,
                    value: function() { return []; }
                },
                _doneWorkflows: {
                    type: Array,
                    value: function() { return []; }
                }
            },
            observers: [

            ],
            refresh: function() {
                this._startDataLoad();
            },
            _onToolbarEvent: function(e, detail) {
                this.fireBedrockEvent("toolbar-button-event", detail);
            },
            _startDataLoad: function () {
                if (this.verbose) {
                    console.log('_renderElement ', JSON.stringify(headerConfig, null, 2));
                }

                var headerConfig = this.headerConfig;

                if (headerConfig && headerConfig.length > 0 && this.contextData) {
                    var attributeNames = [];

                    for (var i = 0; i < headerConfig.length; i++) {
                        if (headerConfig[i].attributeName) {
                            attributeNames.push(headerConfig[i].attributeName);
                        }
                    }

                    var itemContext = this.getFirstItemContext();
                    //add attribute names in item context
                    itemContext.attributeNames = attributeNames;

                    var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                    
                    this.set("headerAttributeModelRequest", compositeModelGetRequest);
                    var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                    if(liquidModelGet) {
                        liquidModelGet.generateRequest();
                    }
                }
            },
            _onCompositeModelGetResponse: function (e) {
                if (this.verbose) {
                    console.log('entity header _onCompositeModelGetResponse ', JSON.stringify(e, null, 2));
                }

                if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                
                    this._headerAttributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);

                    var attributeNames = Object.keys(this._headerAttributeModels);

                    if (attributeNames.length > 0) {
                        var itemContext = this.getFirstItemContext();

                        //add attribute names in item context
                        itemContext.attributeNames = attributeNames;

                        var req = DataRequestHelper.createEntityGetRequest(this.contextData);

                        this.set("headerAttributeRequest", req);
                        this.$$("liquid-entity-data-get").generateRequest();
                    }
                }
            },
            _onHeaderAttributesGetResponse: function (e) {

                var headerAttributeResponse = e.detail.response;

                if (this.verbose) {
                    console.log('on entity header response event ', JSON.stringify(headerAttributeResponse, null, 2));
                }

                var attributesData = [];
             
                if (DataHelper.validateGetEntitiesResponse(headerAttributeResponse) && this._headerAttributeModels) {

                    var entity = headerAttributeResponse.content.entities[0];

                    if (entity) {
                        var attributesData = DataTransformHelper.transformAttributes(entity, this._headerAttributeModels, this.contextData, "array");

                        //Find the date attributes and change the values from ISO                        
                        for(var j = 0; j < this.headerConfig.length; j++)
                        {
                            if(this.headerConfig[j].dataType == "datetime")
                            {
                                for(var i = 0; i < attributesData.length; i++)
                                {
                                    if(this.headerConfig[j].attributeName == attributesData[i].name)
                                    {
                                         attributesData[i].value = FormatHelper.convertFromISODateTime(attributesData[i].value, "datetime");
                                    }
                                }                                
                            }
                        }

                        this.set("_headerAttributeValues", attributesData);
                   }
                }
            },
            _getAttributeLabel: function (attributeItem) {
                var configItem = this._getConfigItem(this.headerConfig, attributeItem.name);

                if (configItem && configItem.label) {
                    return configItem.label;
                }

                var attributeModel = this._headerAttributeModels[attributeItem.name];

                if (attributeModel && attributeModel.properties && attributeModel.properties.externalName) {
                    return attributeModel.properties.externalName;
                }
            },
            _getAttributeValue: function (values, configItem) {
                var attrValue = "";
                for (var i = 0; i < values.length; i++) {
                    var attributes = values[i].attributes;
                    for (var j = 0; j < attributes.length; j++) {
                        if (attributes[j].name == configItem.attributeName) {
                            attrValue = attributes[j].value;
                        }
                    }
                }
            },
            _computeIcon: function (percentage) {
                var per = Math.round(percentage / 10) * 10;
                return "pebble-md-icons:Percentage";
            },
            _openPopover: function () {
                this.$.tofixPopover.show();
            },
            _computeAttributeClass: function (attributeValue) {
                var configItem = this._getConfigItem(this.headerConfig, attributeValue.name);
                if (configItem) {
                    if (configItem.noTrim) {
                        return "attribute";
                    } else {
                        return "attribute trim";
                    }
                }
            },
            _getConfigItem: function (headerConfig, attributeName) {
                for (var i = 0; i < headerConfig.length; i++) {
                    if (headerConfig[i].attributeName == attributeName) {
                        return headerConfig[i];
                    }
                }
            },
            _onAssignActionTap: function (e, detail, sender) {
                this._failedWorkflows = [];
                this._doneWorkflows = [];
                if(detail) {
                    if(detail.data.eventName == "action-takeTask") {
                        this._currentWorkflowAction = "take"; 
                    }
                    if(detail.data.eventName == "action-releaseTask") {
                        this._currentWorkflowAction = "release";
                    }
                    this.workflowMappingDefinitionRequest = DataRequestHelper.createWorkflowMappingGetRequest(this.contextData);
                    this.$$('#getWorkflowMappingDefinition').generateRequest();
                }                    
            },
            _onWfMappingsReceived: function(e) {
                var response = e.detail.response;
                if(response) {
                    var mappingModels = response.content && response.content.entityModels ? response.content.entityModels: [];
                    if(mappingModels.length > 0) {
                        var wfDefinitionMappingModel = mappingModels.find(obj => obj.type == "workflowDefinitionMapping");
                        var wfRelationships = DataMergeHelper.mergeWorkflowMappings(wfDefinitionMappingModel, this.contextData);
                        var mappedWorkflowNames = DataHelper.getRelToNames(wfRelationships.hasWorkflowsDefined);
                        this.set("_mappedWorkflowNames", mappedWorkflowNames);
                        var itemContext = this.getFirstItemContext();
                        itemContext.workflowNames = this._mappedWorkflowNames;
                        
                        this.runningInstanceRequest = DataRequestHelper.createWorkflowRuntimeInstanceGetRequest(this.contextData);
                        this.$$('#entityGetRunningInstance').generateRequest();
                    }
                }
            },
            _onMappingsGetFailed: function(e) {
                console.warn("Failed to get workflow mappings with error: ", e.detail);
                this.showErrorToast("Failed to get workflow mappings. Please contact administrator.");
            },
            _onRunningInstanceReceived: function (e) {

                if (e.detail.response) {
                    var runtimeInstanceEntities = e.detail.response && e.detail.response.content && e.detail.response.content.entities 
                                                    ? e.detail.response.content.entities: [];

                    if (runtimeInstanceEntities.length > 0) {
                        //console.log('runtime instance entities ', JSON.stringify(runtimeInstanceEntities, null, 2));

                        var runtimeInstanceEntity = runtimeInstanceEntities[0];

                        if(runtimeInstanceEntity && runtimeInstanceEntity.data) {
                            var foundWorkflowNames = [];
                            var runningInstances = [];

                            //Note: Here, workflow runtime data would be always in the context of workflow so no need to check for data.attributes
                            var contexts = runtimeInstanceEntity.data && runtimeInstanceEntity.data.contexts ? runtimeInstanceEntity.data.contexts : [];

                            for (var i = 0; i < contexts.length; i++) {
                                var currContextItem = contexts[i];
                                var currContext = currContextItem.context;
                                var currWorkflowName = currContext.workflow;
                                var contextAttrs = currContextItem.attributes;

                                if(currWorkflowName) {
                                    var runtimeInstance = {
                                        "name": currWorkflowName,
                                        "activityName": AttributeHelper.getFirstAttributeValue(contexts[i].attributes.activities.group[0].activityName)
                                    };

                                    runningInstances[currWorkflowName] = {};
                                    runningInstances[currWorkflowName] = runtimeInstance;
                                    foundWorkflowNames.push(currWorkflowName);
                                }
                            }
                            if(foundWorkflowNames.length > 0) {
                                this.set("_runningInstances", runningInstances);
                                this.set("_foundWorkflowNames", foundWorkflowNames);
                                var itemContext = this.getFirstItemContext();
                                itemContext.workflowNames = foundWorkflowNames;

                                this.workflowDefinitionRequest = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                                this.$$("#entityGetWorkflowDefinition").generateRequest();
                            } else {
                                this.showErrorToast("Entity is not available in any workflow.");
                            }
                        }
                    }
                } 
            },
            _onRunningInstanceGetFailed: function (e) {
                console.warn("Failed to get workflow status with error: ", e.detail);
                this.showErrorToast("Failed to get workflow status. Please contact administrator.");
            },
            _onDefinitionReceived: function (e) {
                var workflowDefinitionResponse = e.detail.response;
                if (workflowDefinitionResponse && workflowDefinitionResponse.content && workflowDefinitionResponse.content.entityModels && workflowDefinitionResponse.content.entityModels.length > 0) {
                    var workflowData = [];
                    
                    for (var i = 0; i < workflowDefinitionResponse.content.entityModels.length; i++) {
                        var entityModel = workflowDefinitionResponse.content.entityModels[i];
                        var workflowName = entityModel.name;

                        if (entityModel.data && entityModel.data.attributes) {
                            var wfAttributes = entityModel.data.attributes;
                            this._runningInstances[workflowName]["wfLongName"] = AttributeHelper.getFirstAttributeValue(wfAttributes.workflowName);
                        }
                    }
                    this._currentWfIndex = 0;
                    this._generateAssignmentRequest();
                }
            },
            _onDefinitionGetFailed: function (e) {
                Polymer.Base._error('workflow definition get failed with error ', e.detail);
            },
            _getWfCriterion: function(runtimeInstance) {
                var wfCriterion;
                if(runtimeInstance && runtimeInstance.name && runtimeInstance.activityName) {
                    wfCriterion = {
                        "workflowShortName": runtimeInstance.name,
                        "workflowActivityName": runtimeInstance.activityName
                    };
                }
                return wfCriterion;
            },
            _getEntityObject: function() {
                var itemCtx = ContextHelper.getFirstItemContext(this.contextData);
                var entity = {
                    "id": itemCtx.id,
                    "type": itemCtx.type
                };
                return entity;
            },
            _generateAssignmentRequest: function() {
                var entity = this._getEntityObject();
                var runtimeInstance = this._runningInstances[this._foundWorkflowNames[this._currentWfIndex]];
                var wfCriterion = this._getWfCriterion(runtimeInstance);
                if(!_.isEmpty(wfCriterion)) {
                    var req = DataRequestHelper.createWfChangeAssignmentRequest(entity, wfCriterion, this.contextData, this._currentWorkflowAction);
                    this.set("_wfAssignmentRequest", req);
                    var liquidWfAssign = this.$$("#entityWfAssignment");
                    if(liquidWfAssign) {
                        liquidWfAssign.generateRequest();
                    }
                }
            },
            _onAssignmentSuccess: function(e) {
                var response = e.detail.response;
                var entity = this._getEntityObject();
                if(response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                    var statusDetail = response.response.statusDetail;
                    var workflowJson = this._runningInstances[this._foundWorkflowNames[this._currentWfIndex]];
                    if(statusDetail.messages && statusDetail.messages.length > 0) {
                        this._failedWorkflows.push(workflowJson);
                    } else if(statusDetail.message) {
                        this._doneWorkflows.push(workflowJson);
                    }
                }
                this._currentWfIndex++;
                if(this._currentWfIndex < this._foundWorkflowNames.length) {
                    this._generateAssignmentRequest();
                } else if(response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail){
                    if(this._foundWorkflowNames.length == this._doneWorkflows.length) {
                        var workflowJson = this._doneWorkflows[0];
                        this.showSuccessToast("{0} action for the step {1} as part of {2} is completed successfully.".format(this._currentWorkflowAction, workflowJson.activityName, workflowJson.wfLongName),5000);
                    } else if(this._foundWorkflowNames.length == this._failedWorkflows.length) {
                        var workflowJson = this._failedWorkflows[0];
                        this.showErrorToast("{0} action for the step {1} as part of {2} is failed. Please contact your administrator.".format(this._currentWorkflowAction, workflowJson.activityName, workflowJson.wfLongName),5000);
                    } else {
                        var failedWorkflows = this._failedWorkflows;
                        var failedWorkflowActivities = [];
                        var failedWorkflowNames = [];
                        if(failedWorkflows.length > 0){
                            for(var i in failedWorkflows){
                                failedWorkflowActivities.push(failedWorkflows[i].activityName);
                                failedWorkflowNames.push(failedWorkflows[i].wfLongName);
                            }
                        }
                        var successWorkflows = this._doneWorkflows;
                        var successWorkflowActivities = [];
                        var successWorkflowNames = [];
                        if(successWorkflows.length>0){
                            for(var i in successWorkflows){
                                successWorkflowActivities.push(successWorkflows[i].activityName);
                                successWorkflowNames.push(successWorkflows[i].wfLongName);
                            }
                        }   
                        this.showSuccessToast("The {0} of type {1} selected is in {2} as part of the {3} business process has been assigned to you.\nYou do not have permission to take an action on this {4} as part of the {5} as part of the {6} respectively as you do not have permissions. Please contact your business administrator if you need to be assigned.".format(entity.id,entity.type,successWorkflowActivities,successWorkflowNames,entity.type,failedWorkflowActivities,failedWorkflowNames),10000);
                    }
                    this.async(function() {
                        //this._refreshView();
                        var eventName = "workflow-assignment-complete";
                        var eventDetail = {
                            name: eventName
                        }
                        this.fireBedrockEvent(eventName, eventDetail,{ ignoreId: true });
                    }, 5000)
                }
                else{
                    this.showErrorToast("There is a problem with the server.Please try after some time")
                }
            },
            _onAssignmentFailure: function (e) {
                console.warn("Failed to perform the workflow assignment with error: ", e.detail);
                this.showErrorToast("Failed to perform the workflow assignment. Please contact administrator.");
            },
            _refreshView: function () {
                var contentView = undefined;
                var app =  ComponentHelper.getCurrentActiveApp();
                if(app) {
                    contentView = ComponentHelper.getComponentContainer(app);
                }
                if (contentView) {
                    contentView.render();
                }
            },
        });
    </script>
</dom-module>