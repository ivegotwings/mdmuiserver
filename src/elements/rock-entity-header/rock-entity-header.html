<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">


<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-info-icon/pebble-info-icon.html">

<link rel="import" href="../rock-entity-tofix/rock-entity-tofix.html">
<link rel="import" href="../rock-entity-thumbnail/rock-entity-thumbnail.html">
<link rel="import" href="../rock-business-actions/rock-business-actions.html" />
<link rel="import" href="../rock-entity-actions/rock-entity-actions.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<link rel="import" href="progress-icons.html">
<!--
`rock-entity-header` Represents an entity header in the entity manage App. It contains the following items:

      1. The attributes of the entity that needs display in the header section.

      2. The percentage completion of the entity with the notifications that also indicates warnings.

      3. An Invalid and missed fields of an entity.

      4. A button toolbar with different actions performed on the entity.

An element accepts the attribute list of the respective entity, entity's profile completion, and actions to be
performed.

@group rock Elements
@element rock-entity-header
@demo demo/index.html
-->
<dom-module id="rock-entity-header">
    <template>
        <style include="bedrock-style-common">
            :host {
                width: 100%;
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                padding-top: 10px;
                padding-right: 0;
                padding-bottom: 10px;
                padding-left: 0;
                box-sizing: border-box;
                --pebble-popover: {
                    margin-top: 5px;
                }
                --paper-menu-background-color: #ffffff;
                --pebble-horizontal-divider-color: #616161;
            }

            pebble-toolbar {
                --pebble-button: {
                    padding-top: 0;
                    padding-right: 0;
                    padding-bottom: 0;
                    padding-left: 0;
                    margin-top: 0;
                    margin-right: 0;
                    margin-bottom: 0;
                    margin-left: 0;
                }
            }

            #headerSection {
                width: 100%;
                display: block;
                position: relative;
                transition: 0.3s ease all;
                padding: 13px 20px;
                height: 100px;
                max-height: 200px;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
            }

            #attributePanel,
            #attributeErrorPanel {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                flex-wrap: wrap;
                -webkit-flex-wrap: wrap;
                width: calc(70% - 90px);
                float: left;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
                overflow: hidden;
                height: 100%;
                @apply --layout-horizontal;
            }

            .attribute {
                width: 25%;
                line-height: 16px;
                padding-right: 20px;
                -webkit-transition: all 0.4s;
                -moz-transition: all 0.4s;
                -o-transition: all 0.4s;
                transition: all 0.4s;
                padding-bottom: 10px;
            }
            .attribute:hover{
                cursor: pointer;
            }
            .attribute pebble-icon{
                display: none;
            }
            .attribute:hover pebble-icon:hover{
                --pebble-icon-color: {
                    fill: var(--primary-icon-color, #75808b);
                }
            }
            .attribute:hover pebble-icon{
                display: block;
                transition: all 0.3s;
                -webkit-transition: all 0.3s;
                -ms-transition:all 0.3s;
                --pebble-icon-color: {
                    fill: var(--secondary-icon-color, #c1cad4);
                }
            }

            #attrName {
                font-family: var(--default-font-family);
                font-size:13px;
                font-weight: normal;
                font-style: normal;
                font-stretch: normal;
                color: var(--attribute-name-color, #839cb1);
            }

            pebble-info-icon {
                float: left;
            }

            #attrVal {
                font-size: var(--default-font-size, 14px);
                font-weight: normal;
                color: var(--text-primary-color, #364653);
                display: flex;
            }

            #buttonPanel {
                display: flex;
                display: -webkit-flex;
                align-items: center;
                position: relative;
                top: 50%;
                transform: translateY(-50%);
                z-index: 1;
            }

            #buttonPanel pebble-button {
                display: inline-block;
                vertical-align: middle;
            }

            #buttonPanel {
                --paper-toolbar: {
                    display: inline-block;
                    vertical-align: middle;
                }
            }

            #buttonPanel pebble-button {
                margin-right: 5px;
            }

            #buttonPanel pebble-actions,
            #buttonPanel pebble-button {
                height: 20px;
                float: left;
            }

            #buttonPanel pebble-toolbar {
                --paper-toolbar: {
                    height: 20px;
                    float: left;
                }
                --paper-toolbar-content: {
                    height: 20px;
                    float: left;
                    padding-top: 0px;
                    padding-right: 0px;
                    padding-bottom: 0px;
                    padding-left: 0px;
                }
            }

            pebble-actions {
                height: 30px !important;
                vertical-align: super !important;
            }

            rock-entity-thumbnail {
                width: 90px;
                height: 60px;
                float: left;
                padding-right: 20px;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
            }

            #headerSection.header-collapse {
                height: 50px;
                padding: 0 20px;
            }

            .header-collapse #attributePanel {
                padding-top: 12px;
            }

          
            .header-collapse rock-entity-thumbnail {
                width: 40px;
                height: 50px;
                padding-right: 15px;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                -o-transition: all 0.3s;
                transition: all 0.3s;
            }

            .toggle-area-outside {
                background: transparent;
                position: absolute;
                height: 1px;
                bottom: 1px;
                width: 100%;
            }

            .toggle-area {
                position: absolute;
                left: 50%;
                height: 20px;
                width: 40px;
                bottom: -1px;
                background: var(--palette-pale-grey, #e6ebf0);
                border-top-left-radius: 100px;
                border-top-right-radius: 100px;
                transition: transform 0.4s linear;
                transform-origin: bottom center;
                transform-style: preserve-3D;
                z-index: 1;
            }

            .icon-wrapper {
                line-height: 20px;
                cursor: pointer;
                width: 12px;
                margin: 1px auto;
            }
            .attr-item--value{
                max-width: calc(100% - 20px);
            }

            .header-collapse .toggle-area {
                transform: rotatex(180deg);
                -webkit-transform: rotatex(180deg);
                -moz-transform: rotatex(180deg);
                -ms-transform: rotatex(180deg);
                -o-transform: rotatex(180deg);
            }

            .icon-wrapper pebble-icon {
                text-align: center;
            }
            @supports (-ms-ime-align:auto) {
                #headerSection,.attribute,rock-entity-thumbnail,#attributePanel,#attributeErrorPanel{
                    transition: initial;
                }
            }
           

        </style>
        <div id="headerSection" class$="[[_getCollapseClass()]]">
            <template is="dom-if" if="[[collapsable]]">
                <div class="toggle-area-outside">
                    <div class="toggle-area">
                        <div class="icon-wrapper" on-tap="_toggleCollapse">
                            <pebble-icon icon="pebble-icon:action-less" class="pebble-icon-size-12"></pebble-icon>
                        </div>
                    </div>
                </div>
            </template>

            <rock-entity-thumbnail id="entityThumbnail" config="[[thumbnailConfig]]" default-thumbnail-id="[[_defaultThumbnailId]]"></rock-entity-thumbnail>
            <div id="attributePanel">
                <template id="headerAttributes" is="dom-repeat" items="[[_headerAttributeValues]]">
                    <div id="attribute" class="attribute">
                        <div id="attrName" class="text-ellipsis">[[_getAttributeLabel(item)]]</div>
                         <template is="dom-if" if="[[_getDescriptionInfo(item)]]"> 
                            <pebble-info-icon description-object="[[_getDescriptionInfo(item)]]"></pebble-info-icon>
                         </template> 
                        <div id="attrVal" title="[[item.value]]">
                            <div class="attr-item--value text-ellipsis">[[item.value]]</div>
                            <pebble-icon icon="pebble-icon:Edit" class="pebble-icon-size-14 m-l-5"></pebble-icon>
                        </div>
                    </div>
                </template>
            </div>
            <div id="attributeErrorPanel" hidden></div>
            <div id="buttonPanel" class="pull-right">
                <template is="dom-if" if="[[writePermission]]">
                    <template is="dom-if" if="[[businessActionsConfig.showActions]]">
                        <rock-business-actions id="businessActions" context-data="[[contextData]]" workflow-info="[[workflowInfo]]" show-workflow-actions
                            is-single-entity-process></rock-business-actions>
                    </template>
                </template>
                <pebble-popover id="tofixPopover" for="pebbleButton" horizontal-align="right" no-overlap>
                    <rock-entity-tofix data="[[toFixData]]"></rock-entity-tofix>
                </pebble-popover>
                <rock-entity-actions id="entityActions" context-data="[[contextData]]"></rock-entity-actions>
                <bedrock-pubsub event-name="rock-toolbar-button-event" handler="_onToolbarEvent" target-id="entityActions"></bedrock-pubsub>
                <bedrock-pubsub event-name="rock-toolbar-reset" handler="_resetToolbarButtons" target-id="entityActions"></bedrock-pubsub>
                <bedrock-pubsub event-name="tabs-change" handler="_onTabsChange"></bedrock-pubsub>
            </div>
        </div>

        <liquid-entity-data-get name="attributeGetDataService" operation="getbyids" data-index="[[dataIndex]]"
            request-data="{{headerAttributeRequest}}" on-response="_onHeaderAttributesGetResponse" include-type-external-name></liquid-entity-data-get>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{headerAttributeModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse"></liquid-entity-model-composite-get>
    </template>
    <script>
        class RockEntityHeader
                extends Polymer.mixinBehaviors([
                    RUFBehaviors.ComponentContextBehavior,
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ], Polymer.Element) {
                static get is() { return 'rock-entity-header' }

                static get properties() {
                    return {
                        contextData: {
                            type: Object,
                            value: function () {
                                return {};
                            },
                            observer: '_onContextDataChange'
                        },
                        /**
                         * If set as true , it indicates the component is in read only mode
                         */
                        readonly: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * Indicates the attributes that gets displayed in the header section.
                         */
                        headerConfig: {
                            type: Array,
                            value: []
                        },

                        /**
                         * Indicates the data of all missing or invalid fields, errors, and warnings of the loaded entity.
                         */
                        toFixData: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        /**
                         * Indicates the request object that is passed to the data element to retrieve the attribute data.
                         Sample: {
                                    action: "getAttributes"
                                    }
                         */
                        headerAttributeRequest: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        /**
                         * Indicates the request object that is passed to the data element to retrieve the attribute model data.
                         Sample: {
                                    action: "getAttributeModels"
                                    }
                         */
                        headerAttributeModelRequest: {
                            type: Object,
                            value: function () {
                                return {
                                };
                            }
                        },
                        _headerAttributeValues: {
                            type: Array,
                            value: function () {
                                return [];
                            }
                        },
                        _headerAttributeModels: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        /**
                         * Specifies whether or not to write the logs.
                         */
                        verbose: {
                            type: Boolean,
                            value: false
                        },
                        _entityAttributes: {
                            type: Array,
                            value: function () {
                                return [];
                            }
                        },
                        _referenceAttributeModels: {
                            type: Array,
                            value: function () {
                                return [];
                            }
                        },
                        _messageAttribute: {
                            type: String,
                            value: null
                        },
                        _messageAttributeValue: {
                            type: String,
                            value: null
                        },
                        collapse: {
                            type: Boolean,
                            value: false
                        },
                        collapsable: {
                            type: Boolean,
                            value: false
                        },
                        workflowInfo: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        dataIndex: {
                            type: String,
                            value: "entityData"
                        },
                        writePermission: {
                            type: Boolean,
                            value: false
                        },
                        _currentTab: {
                            type: String,
                            value: ""
                        }
                    }
                }
                static get observers() {
                    return [
                        '_setHeaderValuesAsPerConfig(_headerAttributeValues)'
                    ]
                }
                ready() {
                    super.ready();
                    this.logInfo("EntityHeaderReady");
                }
                _getDescriptionInfo(item) {
                    return this._headerAttributeModels[item.name] && this._headerAttributeModels[item.name].properties || {};
                }

                _onContextDataChange() {
                    if (!_.isEmpty(this.contextData)) {
                        let context = DataHelper.cloneObject(this.contextData);
                        this._setWritePermission();
                        //App specific
                        let appName = ComponentHelper.getCurrentActiveAppName();
                        if (appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }
                        
                        //Updating the navigation state
                        let navContextObj = this.contextData[ContextHelper.CONTEXT_TYPE_NAVIGATION];
                        if(!_.isEmpty(navContextObj)){
                            let navCtxObj = navContextObj[0][RockEntityHeader.is];
                            if(navCtxObj && navCtxObj.headerCollapse){
                                let headerCollapse = navCtxObj.headerCollapse;
                                if(headerCollapse) {
                                    let headerSection = this.shadowRoot.querySelector('#headerSection');
                                    if(headerSection) {
                                        headerSection.classList.remove('header-collapse');
                                        this._toggleCollapse();
                                    }
                                }
                            }
                        }

                        this.requestConfig('rock-entity-header', context);
                    }
                }

                onConfigLoaded(componentConfig) {
                    if (componentConfig && componentConfig.config) {
                        this.headerConfig = DataHelper.convertObjectToArray(componentConfig.config.headerConfig);
                        this.thumbnailConfig = componentConfig.config.thumbnailConfig;
                        this.businessActionsConfig = componentConfig.config.businessActionsConfig;
                        //Set the data-index and data-sub-index for liquid-entity-model-get call using liquid-entity-data-get
                        if (componentConfig.config["dataIndex"]) {
                            this.dataIndex = componentConfig.config["dataIndex"];
                        }

                        this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(100), () => {
                            this.refresh(false);
                        });
                    }
                }

                _setHeaderValuesAsPerConfig() {
                    if (this._headerAttributeValues && this._headerAttributeValues.length > 0 && this._messageAttribute) {
                        for (let i = 0; i < this._headerAttributeValues.length; i++) {
                            if (this._headerAttributeValues[i].name == this._messageAttribute) {
                                let configItem = this._getConfigItem(this.headerConfig, this._headerAttributeValues[i].name);
                                this._messageAttributeValue = this._headerAttributeValues[i].value;

                                //Remove if attribute not for header
                                if (!configItem) {
                                    this._headerAttributeValues.splice(i, 1);
                                }

                                break;
                            }
                        }
                    }
                }
                _getCollapseClass() {
                    if (this.collapsable && this.collapse) {
                        return "header-collapse";
                    } else {
                        return "";
                    }
                }
                _toggleCollapse() {
                    let headerSection = this.shadowRoot.querySelector('#headerSection');
                    let mainApp = RUFUtilities.mainApp;
                    let windowInnerHeight;
                    let headerCollapse = false;
                    if (headerSection.classList.contains('header-collapse')) {
                        headerSection.classList.remove('header-collapse');
                        if (!(window.navigator.userAgent.indexOf("Edge") > -1)) {
                            windowInnerHeight = window.innerHeight;
                            mainApp.updateStyles({
                                '--window-inner-height': windowInnerHeight + 'px'
                            });
                        }
                    } else {
                        headerSection.classList.add('header-collapse');
                        headerCollapse = true;
                        if (!(window.navigator.userAgent.indexOf("Edge") > -1)) {
                            windowInnerHeight = window.innerHeight + 61;
                            mainApp.updateStyles({
                                '--window-inner-height': windowInnerHeight + 'px'
                            });
                        }
                    }

                    //Set navigationContext                
                    let eventDetail = {
                        "parentElement" : RockEntityHeader.is,
                        "properties" : {"headerCollapse": headerCollapse}
                    } 
                    this.fireBedrockEvent("navigation-change", eventDetail , { ignoreId: true });
                }
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                refresh(invalidateEntityCache = true) {

                    if (invalidateEntityCache) {
                        //Invalidate entity cache
                        let entity = this._getEntityObject();
                        LiquidDataObjectUtils.invalidateDataObjectCache(entity, this.dataIndex);
                    }
                    //refreshing rock-business-actions
                    let rockBusinessActions = this.shadowRoot.querySelector('#businessActions');

                    if(rockBusinessActions) {
                        rockBusinessActions.reloadComponent();
                    }
                    this._startDataLoad();
                    this._refreshEntityThumbnail();
                }
                _refreshEntityThumbnail() {
                    let entityThumbnailComp = this.shadowRoot.querySelector("rock-entity-thumbnail");
                    if (entityThumbnailComp) {
                        entityThumbnailComp.contextData = this.contextData;
                    }
                }
                _onToolbarEvent(e, detail) {
                    this.fireBedrockEvent("toolbar-button-event", detail);
                }
                _startDataLoad() {
                    let headerConfig = this.headerConfig;
                    this.logInfo("EntityHeadDataLoad", "config", headerConfig);

                    if (headerConfig && headerConfig.length > 0 && this.contextData) {
                        let attributeNames = [];

                        for (let i = 0; i < headerConfig.length; i++) {
                            if (headerConfig[i].attributeName) {
                                attributeNames.push(headerConfig[i].attributeName);
                            }
                        }

                        //Add messageAttribute if not available in the request attributes list
                        if (this.businessActionsConfig && this.businessActionsConfig.messageAttribute) {
                            this._messageAttribute = this.businessActionsConfig.messageAttribute;
                            if (attributeNames.indexOf(this._messageAttribute) == -1) {
                                attributeNames.push(this._messageAttribute);
                            }
                        }

                        let itemContext = this.getFirstItemContext();
                        //add attribute names in item context
                        itemContext.attributeNames = attributeNames;

                        let compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                        this.set("headerAttributeModelRequest", compositeModelGetRequest);
                        let liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                        if (liquidModelGet) {
                            liquidModelGet.generateRequest();
                        }
                    }
                }
                _onCompositeModelGetResponse(e) {
                    // this.logInfo("EntityHeaderModelResponse", "response", JSON.stringify(e, null, 2));

                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        let entityModel = e.detail.response.content.entityModels[0];
                        let properties = entityModel.properties;
                        if (properties.hasOwnProperty("defaultThumbnailId")) {
                            this._defaultThumbnailId = properties.defaultThumbnailId;
                        }
                        this._headerAttributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);

                        let clonedContextData = DataHelper.cloneObject(this.contextData);
                        let attributeNames = Object.keys(this._headerAttributeModels);

                        if (clonedContextData) {
                            //add attribute names in item context
                            let itemContext = this.getFirstItemContext();
                            itemContext.attributeNames = attributeNames;
                            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                            this.set("headerAttributeRequest", DataRequestHelper.createEntityGetRequest(clonedContextData, true));
                            this.shadowRoot.querySelector("liquid-entity-data-get").generateRequest();
                        }
                    } else {
                        let attrContainer = this.$$('#attributePanel');
                        let attrErrorContainer = this.$$('#attributeErrorPanel');
                        attrContainer.hidden = true;
                        attrErrorContainer.hidden = false;
                        this.logError("rock-entity-header - Header attribute models get response error", e.detail, true, "", attrErrorContainer);
                    }
                }
                async _onHeaderAttributesGetResponse(e) {
                    let headerAttributeResponse = e.detail.response;

                    this.logInfo("EntityHeaderAttributeResponse", "response", headerAttributeResponse);

                    let attributesData = [];
                    if (DataHelper.validateGetEntitiesResponse(headerAttributeResponse) && this._headerAttributeModels) {
                        let entity = headerAttributeResponse.content.entities[0];

                        if (entity) {
                            attributesData = await DataTransformHelper.transformAttributes(entity, this._headerAttributeModels, this.contextData, "array", false);
                            this._entityAttributes = attributesData;

                            let self = this;
                            //Find the date attributes and change the values from ISO
                            Object.keys(this._headerAttributeModels).map(function (attributeModel) {
                                if (self._headerAttributeModels[attributeModel].dataType == "datetime" ||
                                    self._headerAttributeModels[attributeModel].dataType == "date") {
                                    let datatype = self._headerAttributeModels[attributeModel].dataType;
                                    for (let i = 0; i < attributesData.length; i++) {
                                        if (self._headerAttributeModels[attributeModel].name == attributesData[i].name) {
                                            attributesData[i].value = FormatHelper.convertFromISODateTime(attributesData[i].value, datatype);
                                            break;
                                        }
                                    }
                                }
                            });

                            this._setMetadataAttributes(entity);
                            this.set("_headerAttributeValues", this._entityAttributes);
                            this.$.headerAttributes.render();
                        }
                    } else {
                        let attrContainer = this.$$('#attributePanel');
                        let attrErrorContainer = this.$$('#attributeErrorPanel');
                        attrContainer.hidden = true;
                        attrErrorContainer.hidden = false;
                        this.logError("rock-entity-header - Header attributes get response error", e.detail, true, "", attrErrorContainer);
                    }
                }

                _setMetadataAttributes(entity) {
                    if (this.headerConfig && this.headerConfig.length > 0) {
                        for (let i = 0; i < this.headerConfig.length; i++) {
                            if (this.headerConfig[i].isMetadataAttribute) {
                                let attrObj = {
                                    "name": this.headerConfig[i].attributeName,
                                    "value": entity[this.headerConfig[i].attributeName]
                                };
                                this._entityAttributes.push(attrObj);
                            }
                        }
                    }
                }

                _getAttributeLabel(attributeItem) {
                    let configItem = this._getConfigItem(this.headerConfig, attributeItem.name);

                    if (configItem && configItem.label) {
                        return configItem.label;
                    }

                    let attributeModel = this._headerAttributeModels[attributeItem.name];

                    if (attributeModel && attributeModel.properties && attributeModel.properties.externalName) {
                        return attributeModel.properties.externalName;
                    }
                }
                _getAttributeValue(values, configItem) {
                    let attrValue = "";
                    for (let i = 0; i < values.length; i++) {
                        let attributes = values[i].attributes;
                        for (let j = 0; j < attributes.length; j++) {
                            if (attributes[j].name == configItem.attributeName) {
                                attrValue = attributes[j].value;
                            }
                        }
                    }
                }
                _computeIcon(percentage) {
                    let per = Math.round(percentage / 10) * 10;
                    return "pebble-icon:percentage-circle";
                }
                _openPopover() {
                    this.$.tofixPopover.show();
                }
                _getConfigItem(headerConfig, attributeName) {
                    if (!headerConfig) {
                        return;
                    }

                    for (let i = 0; i < headerConfig.length; i++) {
                        if (headerConfig[i].attributeName == attributeName) {
                            return headerConfig[i];
                        }
                    }
                }

                _getEntityObject() {
                    let itemCtx = ContextHelper.getFirstItemContext(this.contextData);
                    let entity = {
                        "id": itemCtx.id,
                        "type": itemCtx.type
                    };
                    return entity;
                }

                _refreshView() {
                    let contentView = undefined;
                    let app = ComponentHelper.getCurrentActiveApp();
                    if (app) {
                        contentView = ComponentHelper.getParentElement(app);
                    }
                    if (contentView) {
                        contentView.render();
                    }
                }

                _onTabsChange(event) {
                    if (event && event.detail) {
                        let ignoreList = ["workflow", "recentActivity"];
                        if (ignoreList.indexOf(event.detail) != -1) {
                            return;
                        }
                        this._currentTab = event.detail;
                        this._resetToolbarButtons();
                    }
                }

                _resetToolbarButtons(event) {
                    let hideButton = false;
                    if (this._currentTab == 'summary' || this._currentTab == 'entity-graph') {
                        hideButton = true;
                    }

                    let toolbar = this.shadowRoot.querySelector('#entityActions');
                    if (toolbar) {
                        toolbar.setAttributeToToolbarButton("edit", "hidden", hideButton);
                    }
                }

                refreshThumbnail() {
                    let entityThumbnail = this.shadowRoot.querySelector('#entityThumbnail');
                    if (entityThumbnail) {
                        entityThumbnail.refreshThumbnail();
                    }
                }

                _setWritePermission() {
                    let writePermission = true;
                    let itemContext = this.getFirstItemContext();
                    if (DataHelper.isValidObjectPath(itemContext, "permissionContext.writePermission")) {
                        writePermission = itemContext.permissionContext.writePermission;
                    }

                    this.set("writePermission", writePermission);
                }
        }
                customElements.define(RockEntityHeader.is, RockEntityHeader)
    </script>
</dom-module>