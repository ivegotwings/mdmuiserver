<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="progress-icons.html">
<!--
    `rock-entity-header` Represents entity header in the entity manage app. It contains following items:

      `*` Attributes of the entity that needs display in the header section.

      `*` Percentage completion of the entity with notifications that also indicates warnings.

      `*` Invalid and missed fields of an entity.

      `*` A button toolbar with different actions performed on the entity.

    An element accepts attribute list of the respective entity, entity's profile completion and actions to be
    performed.

@group rock Elements
@element rock-entity-header
@demo demo/index.html
-->
<dom-module id="rock-entity-header">
    <template>
        <style include="pebble-styles-shared"></style>
        <style>
            :host {
                width: 100%;
                display: flex;
                --pebble-toolbar-button-icon: {
                            padding: 4.5px;
                            border: 0px;
                            min-width: 2.14em;
                            margin: 0px;
                            top: 3px;
                            color: #616161;
                        }
                --pebble-toolbar-menubutton: {
                    border: 0px;
                }
                --pebble-button: {
                    color: green;
                    font-weight:500;
                }
                --pebble-button-iron-icon: {
                    height: 24px;
                    width: 24px;
                    margin-right: 5px;
                }
                --pebble-toolbar-pebble-button-menu-item-icon: {
                    width: 20px;
                    height: 20px;
                }
                --paper-menu-background-color: #ffffff;
                --pebble-horizontal-divider-color: #616161;
            }
            #headerSection {
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            #attributePanel {
                display: flex;
                flex-wrap: wrap;
                @apply(--layout-horizontal);
                width:75%;
            }
            .attribute {
                width: 33%;
                flex: 1 1 auto;
            }
            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }
            #attrName {
                padding-left: 10px;
                width: 282px;
                height: 32px;
                font-family: var(--default-font-family);
                font-size: 14px;
                font-weight: normal;
                font-style: normal;
                font-stretch: normal;
                color:var(--attrpanel-color-text);
                opacity: 0.7;
            }
            #attrVal {
               font-size: 13px;
               font-weight: 500;
               color: #616161;
            }
            #buttonPanel {
                @apply(--layout-horizontal);
                @apply(--layout-flex);
                display: inline-block;
                /*margin-top: 20px;*/
            }
            .container {
                height: 40px;
                margin-left: 10px;
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            .badge {
                @apply(--layout);
                @apply(--layout-center-center);
                @apply(--paper-font-common-base);

                font-weight: normal;
                font-size: 11px;
                border-radius: 50%;
                margin-right:10px;
                width: 30px;
                height: 30px;
                background-color: #ff4081;
                opacity: 1.0;
                color: white;
            }
            .iconTextButton::shadow paper-button{
                margin-top:var(--progress-m-top,6px);
            }
            .iconTextButton::shadow paper-button iron-icon{
                margin-right: 5px !important;
            }
            iron-icon {
                --iron-icon-width: 20px;
                --iron-icon-height: 20px;
            }
        </style>
<div id="headerSection">
    <div id="attributePanel">
        <template is="dom-repeat" items="[[_headerAttributeValues]]">
            <div id="attribute" class$="[[_computeAttributeClass(item)]]">
                <span id="attrName">[[_getAttributeLabel(headerAttributeModelResponse, item)]] :</span>
                <span id="attrVal">[[item.value]]</span>
            </div>
        </template>
    </div>
    <div id="buttonPanel" align="right">
        <pebble-button id="pebbleButton" class="iconTextButton" on-click="_openPopover" icon="[[_computeIcon(profile.completionPercentage)]]"
            button-text="[[profile.completionPercentage]]%"></pebble-button>
        <pebble-popover id="warningsPopover" for="pebbleButton" horizontal-align="right" auto-fit-on-attach no-overlap>
            <template is="dom-repeat" items="[[profile.warnings]]">
                <div class="container">
                    <div class="badge">
                        <iron-icon icon="warning"></iron-icon>
                    </div>
                    <div id="message">
                        [[item.message]]
                    </div>
                </div>
            </template>
            <pebble-horizontal-divider></pebble-horizontal-divider>
            <template is="dom-repeat" items="[[profile.errors]]">
                <div class="container">
                    <div class="badge">
                        <iron-icon icon="close"></iron-icon>
                    </div>
                    <div id="message">
                        [[item.message]]
                    </div>
                </div>
            </template>
            <pebble-horizontal-divider></pebble-horizontal-divider>
            <template is="dom-repeat" items="[[profile.information]]">
                <div class="container">
                    <div class="badge">
                        <iron-icon icon="error"></iron-icon>
                    </div>
                    <div id="message">
                        [[item.message]]
                    </div>
                </div>
            </template>
        </pebble-popover>
        <pebble-toolbar config-data="[[buttons]]"></pebble-toolbar>
    </div>
</div>
<liquid-entity-getdata log-internal-detail name="attributeGetDataService" operation="getentities" request="{{headerAttributeRequest}}"
    response="{{headerAttributeResponse}}"></liquid-entity-getdata>
<!--<liquid-entity-get name="headerAttributeGetService" request="[[headerAttributeRequest]]" response="{{headerAttributeResponse}}"></liquid-entity-get>-->
<liquid-entity-get name="headerAttributeModelGetService" request="[[headerAttributeModelRequest]]" response="{{headerAttributeModelResponse}}"></liquid-entity-get>
</template>
<script>
    Polymer({
        is: "rock-entity-header",
        ready: function () {
            this.entityId = this._getEntityId();
        },
        properties: {
            /**
            * Indicates the attributes that gets displayed in the header section.
            */
            headerConfig: {
                type: Array,
                value: []
            },
            /**
            * Indicates the buttons that gets displayed in header section toolbar.
            */
            buttons: {
                type: Object,
                value: {}
            },
            /**
            * Indicates the data of all missing or invalid fields, errors, and warnings of the loaded entity.
            */
            profile: {
                type: Object,
                value: {}
            },
            /**
            * Indicates the request object that is passed to the data element to retrive attribute data.
                Sample: { 
                        action: "getAttributes" 
                        }
            */
            headerAttributeRequest: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            /**
            * Indicates the response object that is received from the data element for the attribute get request.
            */
            headerAttributeResponse: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            /**
            * Indicates the request object that is passed to the data element to retrive attribute model data.
                Sample: { 
                        action: "getAttributeModels" 
                        }
            */
            headerAttributeModelRequest: {
                type: Object,
                value: function () {
                    return { action: "getHeaderAttributeModels" };
                }
            },
            /**
            * Indicates the response object that is received from the data element for the attribute model get request.
            */
            headerAttributeModelResponse: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            _headerAttributeValues: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            entityId: {
                type: String
            }
        },
        observers: [
            '_headerAttributeResponseChanged(headerAttributeResponse)',
            '_headerAttributeModelResponseChanged(headerAttributeModelResponse)',
            '_headerConfigChanged(headerConfig)'
        ],

        _headerConfigChanged: function (headerConfig) {
            if (headerConfig) {
                var attributeNames = [];
                for (var i = 0; i < headerConfig.length; i++) {
                    if (headerConfig[i].attributeName) {
                        attributeNames.push(headerConfig[i].attributeName);
                    }
                }
                var t = { action: "getHeaderAttributeModels", "attributeNames": attributeNames };
                this.set("headerAttributeModelRequest", t);
            }
        },

        _headerAttributeModelResponseChanged: function (headerAttributeModelResponse) {
            if (headerAttributeModelResponse && headerAttributeModelResponse.returnValue && headerAttributeModelResponse.returnValue.attributeModels) {
                var attributeNames = [];
                for (var attributeGroupName in headerAttributeModelResponse.returnValue.attributeModels) {
                    for (var attributeName in headerAttributeModelResponse.returnValue.attributeModels[attributeGroupName]) {
                        attributeNames.push(attributeName);
                    }
                }

                var req = {
                    "data": {
                        "query": {
                            "ctx": [
                                {
                                    "list": "productMaster",
                                    "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                                }
                            ],
                            "valCtx": [
                                {
                                    "source": "SAP",
                                    "locale": "en-US"
                                }
                            ],
                            "id": this.entityId,
                            "filters": {
                                "attributesCriterion": [],
                                "relationshipsCriterion": [],
                                "typesCriterion": ["nart"]
                            }
                        },
                        "fields": {
                            "ctxTypes": [
                                "properties"
                            ],
                            "attributes": attributeNames,
                            "relationships": [
                                "ALL"
                            ]
                        },
                        "options": {
                            "totalRecords": 1,
                            "includeRequest": false
                        }
                    }
                };

                this.set("headerAttributeRequest", req);
                //this.set("attributeRequest.attributeNames", attributeNames);
            }
        },

        _headerAttributeResponseChanged: function (headerAttributeResponse) {
            var attributesData = [];
            var locale = 'en-US', time = 'now', source = 'SAP';
            if (headerAttributeResponse && headerAttributeResponse.data && headerAttributeResponse.data.entities && this.entityId in headerAttributeResponse.data.entities
                && this.headerAttributeModelResponse && this.headerAttributeModelResponse.returnValue && this.headerAttributeModelResponse.returnValue.attributeModels) {
                var attributes = headerAttributeResponse.data.entities[this.entityId].data.ctxInfo[0].attributes;
                //values = DataHelper.transformAttributeToUIFormat(attributes, this.headerAttributeModelResponse.returnValue.attributeModels, locale, time, source);
                var attributeModels = this.headerAttributeModelResponse.returnValue.attributeModels;
                for (var attributeGroupName in attributeModels) {
                    for (var attributeModelName in attributeModels[attributeGroupName]) {
                        var attributeJSON = undefined;
                        var attributeModel = attributeModels[attributeGroupName][attributeModelName];
                        if (attributeModel.name) {
                            var attribute = attributes[attributeModel.name];
                            if (attribute && attribute.values) {
                                attributeJSON = DataHelper._getCurrentValue(attribute.values, locale, time, source);
                            }
                            if (attributeJSON == undefined) {
                                attributeJSON = DataHelper._getEmptyValue(locale, time, source);
                            }
                            attributeJSON.name = attributeModel.name;
                            attributesData.push(attributeJSON);
                        }
                    }
                }
            }
            this.set("_headerAttributeValues", attributesData);
        },

        _getAttributeLabel: function (attributeModelResponse, attributeValue) {
            var configItem = this._getConfigItem(this.headerConfig, attributeValue.name);
            if (configItem && configItem.label) {
                return configItem.label;
            }
            var attributeModel = this._getAttributeModel(attributeModelResponse, attributeValue.name)
            if (attributeModel && attributeModel.longName) {
                return attributeModel.longName;
            }
        },

        _getAttributeValue: function (values, configItem) {
            var attrValue = "";
            for (var i = 0; i < values.length; i++) {
                var attributes = values[i].attributes;
                for (var j = 0; j < attributes.length; j++) {
                    if (attributes[j].name == configItem.attributeName) {
                        attrValue = attributes[j].value;
                    }
                }
            }
        },
        _getAttributeModel: function (attributeModelResponse, attributeName) {
            if (attributeName && attributeModelResponse && attributeModelResponse.returnValue
                && attributeModelResponse.returnValue.attributeModels) {
                for (var attributeGroupName in attributeModelResponse.returnValue.attributeModels) {
                    if (attributeName in attributeModelResponse.returnValue.attributeModels[attributeGroupName]) {
                        return attributeModelResponse.returnValue.attributeModels[attributeGroupName][attributeName];
                    }
                }
            }
        },

        _computeIcon: function (percentage) {
            var per = Math.round(percentage / 10) * 10;
            return "pebble-icons:Percentage";
        },
        _openPopover: function () {
            this.$.warningsPopover.show();
        },
        _computeAttributeClass: function (attributeValue) {
            var configItem = this._getConfigItem(this.headerConfig, attributeValue.name);
            if (configItem) {
                if (configItem.noTrim) {
                    return "attribute";
                }
                else {
                    return "attribute trim";
                }
            }
        },
        _getConfigItem: function (headerConfig, attributeName) {
            for (var i = 0; i < headerConfig.length; i++) {
                if (headerConfig[i].attributeName == attributeName) {
                    return headerConfig[i];
                }
            }
        },
        _getEntityId: function () {
            var mainApp = document.querySelector('main-app');
            if (mainApp && mainApp.route && mainApp.route.__queryParams && "id" in mainApp.route.__queryParams) {
                return mainApp.route.__queryParams['id'];
            }
        }
    })
</script>
</dom-module>