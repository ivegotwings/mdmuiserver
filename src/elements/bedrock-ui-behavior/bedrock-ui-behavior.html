<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-externalref-underscore/bedrock-externalref-underscore.html">
<script>
    /***
    * `RUFBehaviors.UIBehavior` provides common properties and methods that need to be implemented across all
    * elements and components. It is a mandatory behavior for all elements and components to implement.
    *
    * `RUFBehaviors.UIBehavior` has multiple properties that can be used in the context flow, authentication, and configuration.
    *
    *  ### Example
    *
    *     <dom-module id="x-app">
    *        <template>
    *        </template>
    *        <script>
    *           Polymer({
    *             is: "x-app",
    *
    *             behaviors: [
    *               RUFBehaviors.UIBehavior
    *             ],
    *
    *             properties: {
    *              
    *             }
    *           });
    *        &lt;/script>
    *     </dom-module>
    *
    * @polymerBehavior RUFBehaviors.UIBehavior
    */

    window.RUFBehaviors = window.RUFBehaviors || {};
    RUFBehaviors.UIBehavior = {

        properties: {
            /**
            * Indicates html identification of the element. If it is not given, then unique identification 
            * gets created.
            */
            id: {
                type: String,
                value: ""
            },
            /**
            * Indicates the tenant identification. It reads the tenant identification from the main App.
            */
            tenantId: {
                type: String,
                notify: true,
                value: function () {
                    var mainApp = document.querySelector("main-app");
                    if (mainApp) {
                        return mainApp.tenantId;
                    }
                    return "";
                }
            },

            /**
            * Indicates the role identification of the currently logged-in user. It reads the role identification 
            * from the main App.
            */
            roleId: {
                type: String,
                notify: true,
                value: function () {
                    var mainApp = document.querySelector("main-app");
                    if (mainApp) {
                        return mainApp.roleId;
                    }
                    return "";
                }
            },

            /**
            * Indicates the user identification of the currently logged-in user. It reads the user identification 
            * from the main App.
            */
            userId: {
                type: String,
                notify: true,
                value: function () {
                    var mainApp = document.querySelector("main-app");
                    if (mainApp) {
                        return mainApp.userId;
                    }
                    return "";
                }
            },

            /**
            * Indicates an App identification. There is no need to pass this value when you use it.
            */
            appId: {
                type: String,
                value: function () {
                    return this.getAppId();
                }
            },
            /**
            * Specifies whether or not the component is Riversand UI Framework's element or component.
            */
            isRufComponent: {
                type: Boolean,
                value: true,
                reflectToAttribute: true
            },

            /*
            * Indicates data context
            */
            dataContext: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            getConfig: {
                type: Function,
                computed: '_getConfig(applicationConfig)'
            },
            applicationConfig: {
                type: Object,
                notify: true,
                value: function () {
                    return {};
                }
            },
            messageCodeMapping: {
                type: Object,
                value: function() {
                    return {
                        "Req001": "Required",
                        "MinLen001": "MIN_LENGTH",
                        "MaxLen001": "MAX_LENGTH",
                        "AlVal001": "ALLOWED_VALUES",
                        "Prec001": "Precision",
                        "Range001": "RANGE_FROM_INCLUSIVE",
                        "Range002": "RANGE_TO_INCLUSIVE",
                        "Range003": "RANGE_FROM_EXCLUSIVE",
                        "Range004": "RANGE_TO_EXCLUSIVE",
                        "Range005": "RANGE_TO_INCLUSIVE_FROM_EXCLUSIVE",
                        "Range006": "RANGE_TO_INCLUSIVE_FROM_INCLUSIVE",
                        "Range007": "RANGE_TO_EXCLUSIVE_FROM_EXCLUSIVE",
                        "Range008": "RANGE_TO_EXCLUSIVE_FROM_INCLUSIVE",
                        "133311": "Length should be greater than Width",
                        "133312": "Width should be less than Length"
                    };
                }
            }

        },

        attached: function () {
            if (this && (!this.id || this.id == "")) {
                this.id = ElementHelper.getRandomId();
            }
            if (this && (!this.appId || this.appId == "")) {
                this.appId = this.getAppId();
            }
        },

        /**
        * Fires the bedrock event.
        *
        * @method fireBedrockEvent
        * @param {(String)} name The name of the event
        * @param {(Object)} data The detail object for the event
        */
        fireBedrockEvent: function (name, data, settings) {
            return ComponentHelper.fireBedrockEvent(name, data, settings, this);
        },

        getParentAppConfig: function (component, componentName, configName) {
            var parentApp = ComponentHelper.getCurrentActiveApp();
            if (parentApp) {
                return ComponentHelper.getCurrentActiveApp().getConfig(component, componentName, configName);
            }
            return undefined;
        },
        refresh: function () {
            //This is abstract method and can be implemented further by consuming UI component
        },
        _getConfig: function (config) {
            return function () {
                //component tag name
                var component = arguments[0];
                //Component name attribute if configuration is done for multiple same element
                var componentName = arguments[1];
                //If specific config property is required then pass third parameter
                var configName = arguments[2];
                var appName = arguments[3];
                var appConfig = DataHelper.getValue(config, appName && appName != "" ? appName : this.localName);

                if (_.isEmpty(appConfig)) {
                    appConfig = config;
                }

                if (component && appConfig && appConfig.components) {
                    var configValue = appConfig.components[component];
                    if (configValue) {
                        if (componentName && componentName != '') {
                            var configResult = DataHelper.getValue(configValue, componentName);
                            if (configResult) {
                                if (configName) {
                                    return configResult.config[configName];
                                }
                                return configResult.config;
                            }
                        }
                        else {

                            var configResult = DataHelper.getValue(configValue, "config");
                            if (configResult && configName && configName != "") {
                                return configResult[configName];
                            }
                            return configResult;
                        }
                    }
                    return undefined;
                }
                return undefined;
            };

        },

        getAppId: function () {
            var appId = "";
            var componentContainer = ComponentHelper.getComponentContainer(Polymer.dom(this));

            if (componentContainer && componentContainer.localName == "main-app") {
                if (componentContainer.id) {
                    appId = componentContainer.id;
                }
            } else {
                var viewComponent = ComponentHelper.getCurrentActiveApp();
                if (viewComponent) {
                    appId = viewComponent.id;
                }
            }

            return appId;
        },

        _isNullOrEmpty: function (val, fallbackVal) {
            return _.isNullOrEmpty(val, fallbackVal);
        },
        getContentView: function (component) {
            if (component) {
                var parentNode = component.parentNode;
                if (parentNode) {
                    if (parentNode.isRufComponent && parentNode.is == "rock-content-view") {
                        return parentNode;
                    }
                    else if (parentNode.host && parentNode.host.isRufComponent && parentNode.host.is == "rock-content-view") {
                        return parentNode.host;
                    }
                    else {
                        return this.getContentView(Polymer.dom(parentNode));
                    }
                }
            }
        },

        showSuccessToast: function (message, toastDuration) {
            var mainApp = this.getMainApp();
            mainApp.toastText = message;

            var toastElement = mainApp.$$("#pebbleAppToast");
            toastElement.toastType = "success";
            toastElement.heading = "Success";
            toastElement.autoClose = true;

            if (typeof (toastDuration) !== "undefined") {
                toastElement.toastDuration = toastDuration;
            }

            toastElement.show();
        },

        showErrorToast: function (message, toastDuration) {
            var mainApp = this.getMainApp();
            mainApp.toastText = message;

            var toastElement = mainApp.$$("#pebbleAppToast");
            toastElement.toastType = "error";
            toastElement.heading = "Error";
            toastElement.autoClose = true;

            if (typeof (toastDuration) !== "undefined") {
                toastElement.toastDuration = toastDuration;
            }

            toastElement.show();
        },

        getMainApp: function () {
            return document.querySelector('#app');
        },

        getAttributeMessages: function(attributes, attributeModels) {
            var attrMessages = {};
            for (var i in attributes) {
                if(attributeModels[i]) {
                    var messageCodes = this.getMessageCodes(attributes[i]);
                    var messages = this.getMessagesFromCodes(messageCodes);
                    if (messages && messages.length) {
                        attrMessages[i] = messages;
                    }
                }
            }
            return attrMessages; 
        },
        
        getRelationshipMessages: function(relationship) {
            var messageCodes = this.getMessageCodes(relationship[0]);
            var messages = this.getMessagesFromCodes(messageCodes);
            return messages;
        },

        getMessageCodes: function (attribute) {
            var messageCodes = [];
            var properties = attribute.properties;
            if (properties) {
                var messages = properties.messages;
                if(messages && messages.length > 0) {
                    for (var i=0; i< messages.length; i++) {
                        messageCodes.push(messages[i].messageCode);
                    }
                }
            }
            return messageCodes;
        },

        getMessagesFromCodes: function (messageCodes) {
            var messages=[];
            if(messageCodes && messageCodes.length > 0) {
                for(var i=0; i<messageCodes.length; i++){
                    var mes= this.messageCodeMapping[messageCodes[i]];
                    if(mes){
                        messages.push(mes);
                    } else{
                        messages.push("Error with Code: "+messageCodes[i])
                    }
                }
            }
            return messages;
        },

        getErrorsFromAttrMessages: function(attrMessages, attributeModels) {
            var errorMessages = [];
            for(var i in attrMessages) {
                var attrLongName = attributeModels[i].externalName;
                var errorMessage = attrMessages[i][0];
                var errorMessage = {
                    "attributeName": attrLongName,
                    "message": errorMessage
                };
                errorMessages.push(errorMessage);
            }
            return errorMessages;
        },

        getErrorsFromRelMessages: function(relMessages) {
            var errorMessages = [];
            for(var i in relMessages) {
               var relObj = relMessages[i];
               var attrMessages = this.getAttributeMessages(relObj.relAttributes, relObj.attrModels);
               var attributeErrors = this.getErrorsFromAttrMessages(attrMessages, relObj.attrModels);
               var errorMessage = {
                   "attributeName": relObj.relTitle,
                   "message": relObj.relMessage
               };
               attributeErrors.push(errorMessage);
               errorMessages.push.apply(errorMessages, attributeErrors);
            }
            return errorMessages;
        }
    };

</script>