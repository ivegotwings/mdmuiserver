<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-roll-up">
    <template>
        <style include="bedrock-style-common">
            rock-entity-lov {
                --pebble-lov: {
                    width: 250px;
                    border: 1px solid rgba(27, 31, 35, 0.15);
                    padding-top: 10px;
                    padding-right: 0px;
                    padding-bottom: 10px;
                    padding-left: 0px;
                }
            }

            rock-entity-lov {
                margin: 0 auto;
                display: inline-block;
                padding: 20px;
            }

            .lovContainer {
                text-align: center;
            }

            .message {
                text-align: center;
            }

            .buttons {
                text-align: center;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_validationMessage]]</div>
        <template is="dom-if" if="[[_isValidForProcess(selectedEntities, sourceEntityType, _initiated)]]">
            <div class="buttons">
                <pebble-button class="btn btn-success m-r-5" on-tap="_onTapProcess" data-args="new" button-text$="Group to New [[entityTypeExternalName]]"></pebble-button>
                <pebble-button class="btn btn-success" on-tap="_onTapProcess" data-args="existing" button-text$="Group to Existing [[entityTypeExternalName]]"></pebble-button>
            </div>
        </template>
        <template is="dom-if" if="[[_isInitiated(_initiated)]]">
            <div class="message p-t-10">[[_message]]</div>
            <template is="dom-if" if="[[!_isNewRollup(_newRollup)]]">
                <template is="dom-if" if="[[!_doNotallowUserActions]]">
                    <div class="lovContainer p-t-10">
                        <div>Select the entity to add relationship</div>
                        <rock-entity-lov id="rockEntityLovForDropdown" request-data="[[_lovRequestData]]" selected-items="{{selectedItems}}" id-field="[[_lovValueField]]"
                            title-pattern="[[titlePattern]]" value-field="[[_lovValueField]]" multi-select>
                        </rock-entity-lov>
                        <div class="buttons">
                            <pebble-button class="btn btn-secondary" on-tap="_onCancel" button-text="Cancel"></pebble-button>
                            <pebble-button class="btn btn-success" on-tap="_onAddRelationships" button-text="Save"></pebble-button>
                        </div>
                    </div>
                </template>
            </template>
        </template>
        <liquid-entity-data-save name="entitySaveService" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}" on-response="_onSaveResponse"
            on-error="_onSaveError">
        </liquid-entity-data-save>
        <liquid-rest id="entityGovernService" url="/pass-through-bulk/entitygovernservice/validate" method="POST" request-data={{_entityGovernRequest}}
            on-liquid-response="_onEntityGovernResponse" on-liquid-error="_onEntityGovernFailed">
        </liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-roll-up',

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _newRollup: {
                        type: Boolean
                    },

                    _initiated: {
                        type: Boolean,
                        value: false
                    },

                    _lovRequestData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    businessFunctionData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    entityType: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    entityTypeExternalName: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    relationshipType: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    relationshipName: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    sourceEntityType: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    direction: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    titlePattern: {
                        type: String
                    },

                    syncValidations: {
                        type: Array
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },

                    _doNotallowUserActions: {
                        type: Boolean,
                        value: false
                    },

                    _lovValueField: {
                        type: String,
                        value: "id"
                    },

                    _redirectEntity: {
                        type: Object,
                        value: function () { return {}; }
                    },

                    _responseMessages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                _onTapProcess: function (e) {
                    var _processType = e.currentTarget.getAttribute('data-args');

                    if (_processType == "new") {
                        this._newRollup = true;
                    }
                    else {
                        this._newRollup = false;
                    }

                    this._initiated = true;
                    this._executeRollupProcess();
                },

                _isInitiated: function () {
                    return this._initiated;
                },

                _isNewRollup: function () {
                    return this._newRollup;
                },

                _executeRollupProcess: function () {
                    // Start process when all the details are available
                    if (this.contextData && !_.isEmpty(this.contextData) &&
                        this.selectedEntities && this.selectedEntities.length > 0 &&
                        this.entityType && this.relationshipType && this.relationshipName &&
                        this.sourceEntityType && this._newRollup != undefined &&
                        this.direction) {

                        this._loading = true;

                        if (this._newRollup) // No LOV
                        {
                            this._createEntity();
                        }
                        else // LOV
                        {
                            this._loadEntitiesPerType();
                        }
                    }
                },

                _isValidForProcess: function () {

                    if (this._initiated) //Already initiated, then validation process not needed
                    {
                        return false;
                    }

                    if (!this.selectedEntities || this.selectedEntities.length <= 0 || !this.sourceEntityType) {
                        return false;
                    }

                    for (var i = 0; i < this.selectedEntities.length; i++) {
                        if (this.selectedEntities[i].type != this.sourceEntityType) {
                            this._validationMessage = "All selected entities should be " + this.sourceEntityType + " type for the process, please select valid entities."
                            return false;
                        }
                    }

                    return true;
                },

                _loadEntitiesPerType: function () {
                    var _clonedContextData = DataHelper.cloneObject(this.contextData);
                    var _entityRequest = DataRequestHelper.createEntityGetRequest(_clonedContextData);
                    if (_entityRequest && DataHelper.isValidObjectPath(_entityRequest, "params.query.filters.typesCriterion")) {
                        //Prepare request to get all entities of the type
                        _entityRequest.params.query.filters.typesCriterion = [];
                        _entityRequest.params.query.filters.typesCriterion.push(this.entityType);
                        delete _entityRequest.params.query.contexts;
                        delete _entityRequest.params.fields;

                        this._lovRequestData = _entityRequest;
                    }

                    this._loading = false;
                },

                // Entity can be created for lot, pp and ensemble
                _createEntity: function () {
                    this._message = this.direction == "up" ? "Creating the new entity" : "Creating the new entity with relationships";

                    var _clonedContextData = DataHelper.cloneObject(this.contextData);
                    var userContext = ContextHelper.getFirstUserContext(_clonedContextData);

                    var entityId = "e" + ElementHelper.getRandomString();
                    var itemCtx = ContextHelper.getFirstItemContext(_clonedContextData);
                    itemCtx.id = entityId;
                    itemCtx.type = this.entityType;

                    var tenantSettings = this.appSetting("tenantSettings");
                    var defaultLocale = "en-US";
                    var defaultSource = "internal";
                    if(tenantSettings  && tenantSettings.defaultValueLocale){ 
                        defaultLocale = tenantSettings.defaultValueLocale;
                    }
                    if(tenantSettings  && tenantSettings.defaultValueSource){ 
                        defaultSource = tenantSettings.defaultValueSource;
                    }  
                    // Todo - should be removed, once able to create entity without attributes
                    var tempAttributes = [
                        {
                            "value": entityId,
                            "source": defaultSource,
                            "locale": defaultLocale,
                            "selfContext": 1,
                            "name": "id"
                        }
                    ];

                    var newEntity = DataTransformHelper.prepareEntityForCreate(entityId, this.entityType, tempAttributes, _clonedContextData, userContext.user);

                    // If direction is down, then add relationships while entity create
                    if (this.direction == "down") {
                        var relationships = this._prepareRelationships();
                        newEntity.data["relationships"] = {};
                        newEntity.data["relationships"][this.relationshipName] = relationships;
                    }

                    this._saveRequest = {
                        "entities": [newEntity]
                    };

                    this._triggerEntitySave("create");
                },

                _addClientStatus: function () {
                    var clientState = {};
                    clientState.notificationInfo = {};
                    clientState.notificationInfo.showNotificationToUser = false;
                    this._saveRequest["clientState"] = clientState;

                },
                
                _onSaveResponse: function (e, detail) {
                    if (detail.request.operation != "update") // Once entity is created, then create relationships
                    {
                        if (DataHelper.isValidObjectPath(detail, "request.requestData.entities.0")) {
                            var _entity = detail.request.requestData.entities[0];
                            this._redirectEntity = { "id": _entity.id, "type": _entity.type };

                            if (this.direction == "up") {
                                var _targetList = [];
                                _targetList.push({ "id": _entity.id, "type": _entity.type });
                                this._createRelationshipsUp(_targetList);
                            }
                            else {
                                this._triggerFinishStep();
                            }
                        }
                    }
                    else {
                        this._triggerFinishStep();
                    }
                },

                _onSaveError: function (e, detail) {
                    this.showErrorToast("Unable to procecss the rollups now, please contact administrator.");
                    this.logError("Constants", "value", "", e);
                    this._loading = false;
                },

                // lot-sku (isChildOf)
                _createRelationshipsUp: function (_targetList) {
                    var _clonedContextData = DataHelper.cloneObject(this.contextData);
                    var utils = SharedUtils.DataObjectFalcorUtil;

                    if (this.selectedEntities && this.selectedEntities.length > 0 && _targetList && _targetList.length > 0) {
                        var _relationshipList = [];
                        for (var i = 0; i < _targetList.length; i++) {
                            var rel = {
                                "direction": "both",
                                "relationshipType": this.relationshipType,
                                "relTo": {
                                    "id": _targetList[i].id,
                                    "type": _targetList[i].type
                                }
                            };
                            _relationshipList.push(rel);
                        }

                        var upRelationshipRequests = [];
                        for (var i = 0; i < this.selectedEntities.length; i++) {
                            var upRelationshipRequest = {
                                "id": this.selectedEntities[i].id,
                                "type": this.selectedEntities[i].type,
                                "data": {
                                    "relationships": {}
                                }
                            };

                            upRelationshipRequest.data.relationships[this.relationshipName] = _relationshipList;
                            upRelationshipRequests.push(upRelationshipRequest);
                        }

                        this._saveRequest = {
                            "entities": upRelationshipRequests
                        };
                        this._addClientStatus();

                        if (this.syncValidations && this.syncValidations.length > 0) {
                            this._message = "Validating grouping entity";
                            this.set("_entityGovernRequest", this._saveRequest);
                            this._triggerValidationRequest();
                        } else {
                            this._message = "Creating relationships";
                            this._triggerEntitySave("update");
                        }
                    }
                },

                // ensembletopp
                // productpresentationtolot
                _createRelationshipsDown: function (_targetList) {
                    this._message = "Creating relationships";
                    var _clonedContextData = DataHelper.cloneObject(this.contextData);
                    var utils = SharedUtils.DataObjectFalcorUtil;

                    if (this.selectedEntities && this.selectedEntities.length > 0 && _targetList && _targetList.length > 0) {
                        var relationshipRequests = [];
                        var relationships = this._prepareRelationships();

                        for (var i = 0; i < _targetList.length; i++) {
                            var relReq = {
                                "id": _targetList[i].id,
                                "type": _targetList[i].type,
                                "data": {
                                    "relationships": {}
                                }
                            };
                            relReq.data.relationships[this.relationshipName] = relationships;
                            relationshipRequests.push(relReq);
                        }

                        this._saveRequest = {
                            "entities": relationshipRequests
                        };
                        this._addClientStatus();
                        this._triggerEntitySave("update");
                    }
                },

                _onEntityGovernResponse: function (e) {
                    if (e && DataHelper.isValidObjectPath(e, "detail.response")) {
                        var validationResponse = e.detail.response;
                        if (validationResponse.length > 0) {
                            for (var i = 0; i < validationResponse.length; i++) {
                                if (this.syncValidations && this.syncValidations.length > 0) {
                                    for (var j = 0; j < this.syncValidations.length; j++) {
                                        if (DataHelper.isValidObjectPath(validationResponse[i], "operationResponse.response.entities.0.data.attributes." + this.syncValidations[j].attribute + ".properties.messages")) {
                                            var attrMessages = validationResponse[i].operationResponse.response.entities[0].data.attributes[this.syncValidations[j].attribute].properties.messages;

                                            if (attrMessages.length > 0 && attrMessages.find(obj => obj.messageCode == this.syncValidations[j].code)) {

                                                var entityId = validationResponse[i].operationResponse.response.entities[0].id;
                                                var entity = this._responseMessages.find(obj => obj["Entity Id"] == entityId);

                                                if (entity) {
                                                    entity.Message = entity.Message + ", " + this.syncValidations[j].message;
                                                } else {
                                                    this._responseMessages.push({
                                                        "Entity Id": entityId,
                                                        "Message": this.syncValidations[j].message
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // No response messages means no errors, so do the save process
                        if (_.isEmpty(this._responseMessages)) {
                            this._message = "Creating relationships";
                            this._triggerEntitySave("update");
                        } else {
                            this._triggerFinishStep(true); //true - has validation errors, so stop the process
                        }
                    }
                },

                _triggerEntitySave: function (operation) {
                    var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                    if (liquidSave) {
                        liquidSave.operation = operation;
                        liquidSave.generateRequest();
                    }
                },

                _triggerValidationRequest: function () {
                    var liquidGovernGet = this.$.entityGovernService;
                    if (liquidGovernGet) {
                        liquidGovernGet.generateRequest();
                    }
                },

                _onEntityGovernFailed: function (e) {
                    this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                    this.logWarning("AttributeManageGovernFail", e);
                    this._loading = false;
                },

                _prepareRelationships: function (_targetList) {
                    var relationships = [];

                    for (var i = 0; i < this.selectedEntities.length; i++) {
                        var rel = {
                            "direction": "both",
                            "relationshipType": this.relationshipType,
                            "relTo": {
                                "id": this.selectedEntities[i].id,
                                "type": this.selectedEntities[i].type
                            }
                        };
                        relationships.push(rel);
                    }

                    return relationships;
                },

                _onAddRelationships: function () {
                    if (!this.selectedItems || this.selectedItems.length == 0) {
                        return;
                    }

                    if (this.selectedItems.length == 1) {
                        this._redirectEntity = { "id": this.selectedItems[0].id, "type": this.entityType };
                    }

                    var _targetList = [];
                    this._loading = true;

                    for (var i = 0; i < this.selectedItems.length; i++) {
                        _targetList.push({ "id": this.selectedItems[i].id, "type": this.entityType });
                    }

                    if (this.direction == "up") {
                        this._createRelationshipsUp(_targetList);
                    }
                    else {
                        this._createRelationshipsDown(_targetList);
                    }
                },

                _onCancel: function () {
                    //Reset
                    this._message = "";
                    this._doNotallowUserActions = false;

                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },

                _triggerFinishStep: function (hasValidationErrors) {
                    var noGrid = false;
                    var message = "";
                    var actions = [{
                        "name": "goBack",
                        "text": "Take me back to where I started",
                        "isNotApp": true
                    }];

                    if (!hasValidationErrors) {
                        noGrid = true;
                        if (this._newRollup) {
                            message = "Completed the " + this.entityType + " creation with relationships. What do you want to do now?";
                        }
                        else {
                            message = "Completed the relationship creation with selected entities. What do you want to do now?";
                        }

                        if (this._redirectEntity && !_.isEmpty(this._redirectEntity)) {
                            actions.push({
                                "name": "showEntity",
                                "text": "Show me the entity",
                                "isNotApp": true,
                                "dataRoute": "entity-manage",
                                "queryParams": { "id": encodeURIComponent(this._redirectEntity.id), "type": encodeURIComponent(this._redirectEntity.type) }
                            });
                        }
                    }

                    var data = {
                        "messages": this._responseMessages,
                        "message": message,
                        "noGrid": noGrid,
                        "actions": actions,
                        "contextData": this.contextData,
                        "processedEntities": this.selectedEntities,
                        "messageKey": "Entity Id"
                    };

                    this.businessFunctionData = data;
                    var eventName = "onComplete";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });

                    this._message = "About to complete, please wait...";
                    this._loading = true;

                    //Reset contextData, selectedEntities, currentWorkflow
                    this.contextData = {};
                    this.selectedEntities = [];
                    this.currentWorkflow = {};
                }
            });
        })();
    </script>
</dom-module>