<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">


<!--
`pebble-position-tracker` Represents an element that displays an image.


@group pebble Elements
@element pebble-position-tracker
@demo demo/index.html
-->

<dom-module id="pebble-position-tracker">
    <script>
        class PebblePositionTracker extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior], Polymer.Element) {
            static get is() {
                return "pebble-position-tracker";
            }

            static get properties() {
                return {
                    target: {
                        type: String,
                        observer: "_targetChanged"
                    },
                    
                    callback: {
                        type: Object
                    }
                };
            }

            _targetChanged() {
                if (this.target) {
                    this._initLazyLoad();
                }
            }

            _initLazyLoad() {
                let _this = this;
                if (!('IntersectionObserver' in window)) {
                    let script = document.getElementById('polyfill-IntersectionObserver');
                    if (!script) {
                        script = document.createElement('script');
                        script.id = 'polyfill-IntersectionObserver';
                        script.async = true;
                        script.src = '/src/scripts/intersection-observer.js';
                        script.onload = onload;
                        document.head.appendChild(script);
                    }
                    script.addEventListener("load", function () {
                        _this._initLazyLoad(true);
                    });
                } else {
                    if (!this.targetIntersectionObserver) {
                        this.targetIntersectionObserver = new IntersectionObserver(function (entries, observer) {
                            for (let i = 0; i < entries.length; i++) {
                                _this._lazyLoadCallback(entries[i]);
                            }
                        }, {});
                    }
                    // observe target element
                    this.async(function () {
                        let elem = this.parentElement;
                        let targetElement = Polymer.dom(elem).querySelector("#" + this.target);
                        if (targetElement) {
                            this.targetIntersectionObserver.observe(targetElement);
                        }
                    });
                }
            }

            _lazyLoadCallback(e) {
                if (e.isIntersecting || e.intersectionRatio > 0) {
                    let detail = { "target": e.target };
                    this.targetIntersectionObserver.unobserve(e.target);
                    if (this.callback) {
                        this.callback(detail);
                    } else {
                        this.fireBedrockEvent("element-in-view", { target: e.target }, { "ignoreId": true });
                    }
                }
            }
        }
        customElements.define(PebblePositionTracker.is, PebblePositionTracker);
    </script>
</dom-module>