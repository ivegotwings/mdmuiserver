<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-sidebar/rock-sidebar.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../rock-entity-header/rock-entity-header.html">
<link rel="import" href="../rock-dimension-grid/rock-dimension-grid.html">
<link rel="import" href="../rock-workflow-panel/rock-workflow-panel.html">
<dom-module id="app-entity-manage">
    <template>
        <style include="pebble-styles-shared">
            rock-entity-header {
                border-bottom: 1px solid var(--default-border-color,#c1cad4);
                height: 70px;
                padding: 10px;
            }
            
            rock-titlebar::shadow #mainTitle {
                color: var(--pagetitle-text-color,#034c89);
                font-weight: var(--font-bold, bold);
            }
            
            .stepper-style {
                --connected-badge-width: 50px;
                --connected-badge-height: 50px;
                --connected-badge-background: var(--cloudy-blue-color,#c1cad4);
                --connected-childBadge-width: 18px;
                --connected-childBadge-height: 18px;
                --connected-childBadge-background:var(--connected-childBadge-background, #0abf21);
                --connectorLine-width: 3px;
                --divider-color: #212121;
            }
            
            .sidebar-title {
                font-weight: var(--font-medium, 500);
                font-family: var(--default-font-family);
                clear: both;
                padding: 10px;
                margin: 10px;
                font-size: var(--default-font-size);
                font-weight: var(--font-bold, bold);
                font-style: normal;
                font-stretch: normal;
                color: var(--title-text-color,#191e22);
                width: 161px;
                height: 19px;
            }
            
            rock-dimension-selector {
                --dimesion-selector-container-popover: {
                    width: 70px;
                }
                ;
                --dimesion-selector-source-popover: {
                    width: 55px;
                }
                ;
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                }
                ;
                --dimesion-selector-locale-popover: {
                    width: 65px;
                }
                ;
            }
            
            #dimensionContainer {
                align-self: center;
                -webkit-align-self: center; /* Safari 7.0+ */
                width: 100%;
            }
            
            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color,#212121);
                min-width: 1px;
                margin: 10px 5px;
                min-height: 18px;
            }     
            
            .content {
                height: 100%;
            }
        </style>
        <rock-layout>
            <rock-titlebar icon="dashboard" title="" sub-title="" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <iron-ajax auto url="../../data/EntityManageApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
                    <rock-dimension-selector id="dimensionSelector" config-data="{{dimensionData}}"></rock-dimension-selector>
                    <bedrock-pubsub on-bedrock-event-dimension-selector-list="_onListChangeEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-dimension-selector-source="_onSourceChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-dimension-selector-locale="_onLocaleChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                </div>
            </rock-titlebar>
            <rock-header frozen>
                <div class="fixed-content">
                    <bedrock-pubsub on-bedrock-event-search="_searchEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-refresh="_refreshEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-copy="_copyEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-paste="_pasteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-clone="_cloneEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-add="_addEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-delete="_deleteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-cut="_cutEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-route-chamged="onRouteChange"></bedrock-pubsub>
                    <iron-ajax url="../../data/EntityManageApp/header-config.json" last-response="{{headerConfig}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/toolbar-config.json" last-response="{{toolbarConfig}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/entity-summary-tofix-data.json" last-response="{{fixes}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/entity-summary-widgets-config.json" last-response="{{summaryConfig}}" auto></iron-ajax>
                    <rock-entity-header entity-id="[[entityId]]" header-config="[[headerConfig]]" buttons="[[toolbarConfig]]" to-fix-data="[[fixes]]" locale="{{_locale}}"
                        list="{{_list}}" source="{{_source}}"></rock-entity-header>
                </div>
            </rock-header>
            <rock-sidebar id="rockSideBar" position="right">
                <div class="p-10">
                    <rock-workflow-panel context="[[_getWorkflowContext()]]"></rock-workflow-panel>
                </div>
            </rock-sidebar>
            <div class="content">
                <template is="dom-if" if="true" id="tabsTemplate">
                    <rock-tabs id="rockTabs" config="{{_tabConfig}}">
                    </rock-tabs>
                    <iron-ajax auto url="../../data/EntityManageApp/app-entity-manage-tab-config.json" handle-as="json" on-response="_handleResponse"></iron-ajax>
                    <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-todotap="summaryTodoTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-tofixtap="summaryTofixTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-error-length-changed="errorLengthChanged"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-grid-open" handler="onDimensionGridOpen"></bedrock-pubsub>
                </template>
            </div>
            <iron-ajax auto url="../../data/EntityManageApp/dimension-data.json" handle-as="json" last-response="{{dimensions}}"></iron-ajax>
            <pebble-dialog id="dimensionGridDialog" show-close-icon>
            </pebble-dialog>
        </rock-layout>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-manage',
                created: function () {
				    if (this.verbose)
					    console.log('app entity manage created');
                },
                attached: function () {
                    if (this.verbose)
                        console.log('app entity manage attached');
                },
                ready: function () {
                    if (this.verbose)
                        console.log('app entity manage ready');
                    this.entityId = DataHelper._getEntityId();
                },
                properties: {
                    /**
                     * Indictaes Id of the entity for which the attributes have to be managed.
                     */
                    entityId: {
                        type: String
                    },
                   /*
                    * Indicates the config object for the summary element
                    */
                    summaryConfig: {
                        type: Object
                    },
                    _list: {
                        type: String,
                        notify: true
                    },
                   /*
                    * Indicates the lists selected by the user
                    */
                    _lists: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _source: {
                        type: String,
                        notify: true
                    },
                   /*
                    * Indicates the sources selected by the user
                    */
                    _sources: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _locale: {
                        type: String,
                        notify: true
                    },
                   /*
                    * Indicates the locales selected by the user
                    */
                    _locales: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                   /*
                    * Indicates the config for tab element
                    */
                    _tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                   /*
                    * Indicates the items for stepper element
                    */
                    _stepItems: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                listeners: {
                    'dimension-selector-initialized': '_onDimensionSelectorInitialized'
                },
                _onDimensionSelectorInitialized: function () {
                    var dimensionSelector = this.$.dimensionSelector;
                    this._list = this._convertSelectedItemsForSplitScreen(dimensionSelector.listSelector
                        .selectedItem);
                    this._lists = this._convertSelectedItemsForSplitScreen(dimensionSelector.listSelector
                        .selectedItems);

                    this._source = this._convertSelectedItemsForSplitScreen(dimensionSelector.sourceSelector
                        .selectedItem);
                    this._sources = this._convertSelectedItemsForSplitScreen(dimensionSelector.sourceSelector
                        .selectedItems);

                    this._locale = this._convertSelectedItemsForSplitScreen(dimensionSelector.localeSelector
                        .selectedItem);
                    this._locales = this._convertSelectedItemsForSplitScreen(dimensionSelector.localeSelector
                        .selectedItems);
                },
                _onListChangeEvent: function (event) {
                    this._list = this._convertSelectedItemsForSplitScreen(event.detail.selectedItem);
                    this._lists = this._convertSelectedItemsForSplitScreen(event.detail.selectedItems);

                    if (event.detail.multiSelect) {
                        this._toggleStepper(this._lists);
                    }

                    this.$$('rock-tabs').reloadCurrentTab();
                },
                _onSourceChangeEvent: function (event) {
                    this._source = this._convertSelectedItemsForSplitScreen(event.detail.selectedItem);
                    this._sources = this._convertSelectedItemsForSplitScreen(event.detail.selectedItems);

                    if (event.detail.multiSelect) {
                        this._toggleStepper(this._sources);
                    }

                    this.$$('rock-tabs').reloadCurrentTab();
                },
                _onLocaleChangeEvent: function (event) {
                    this._locale = this._convertSelectedItemsForSplitScreen(event.detail.selectedItem);
                    this._locales = this._convertSelectedItemsForSplitScreen(event.detail.selectedItems);

                    if (event.detail.multiSelect) {
                        this._toggleStepper(this._locales);
                    }

                    this.$$('rock-tabs').reloadCurrentTab();
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;
                    if ((component.name.indexOf("attribute") != -1 ||  component.name.indexOf("relationship") != -1)&& component.properties) {
                        if (this._list || (this._lists && this._lists.length > 0)) {
                            // Here it is assumed user will always provide selected items by default
                            component.properties.list = this._list;
                            component.properties.lists = this._lists;
                        }

                        if (this._source || (this._sources && this._sources.length > 0)) {
                            component.properties.source = this._source;
                            component.properties.sources = this._sources;
                        }

                        if (this._locale || (this._locales && this._locales.length > 0)) {
                            component.properties.locale = this._locale;
                            component.properties.locales = this._locales;
                        }
                    } else if (component.name == 'rock-entity-summary') {
                        component.properties.config = this.summaryConfig;
                    }
                    component.properties['entity-id'] = this.entityId;
                },
                _convertSelectedItemsForSplitScreen: function (data) {
                    if (data instanceof Array) {
                        var lists = [];

                        for (var i = 0; i < data.length; i++) {
                            var objList = new Object();
                            objList.title = data[i].title;
                            objList.value = data[i].value

                            lists.push(objList);
                        }

                        return lists;
                    } else {
                        return data.value;
                    }
                },
                _searchEvent: function (e, detail, sender) {

                },
                _refreshEvent: function (e, detail, sender) {
                    var isDirty = false;
                    if (this.getIsDirty) {
                        isDirty = this.getIsDirty();
                    }
                    if (isDirty) {
                        if (window.confirm(
                                "There are unsaved changes. Do you want to discard the changes?")) {
                            this._refreshView();
                        }
                    } else {
                        this._refreshView();
                    }
                },
                _copyEvent: function (e, detail, sender) {
                    document.querySelector('#app').$.pebbleAppToast.fitInto = document.querySelector(
                        '#app').$.toastArea;
                    document.querySelector('#app').toastText = "Attribute Data Copied successfully!!";
                    document.querySelector('#app').$.pebbleAppToast.show();
                },
                _pasteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cloneEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _deleteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _toggleStepper: function (locales) {
                    if (locales && locales.length > 1) {
                        this.$.rockSideBar.style.display = "none";
                    } else {
                        this.$.rockSideBar.style.display = "block";
                    }
                },
                _handleResponse: function (e) {
                    this._setTabConfigData(e.currentTarget.lastResponse);
                },
                _setTabConfigData: function (data) {
                    //can alter the data before setting it to tabConfig for rock-tabs
                    this.set("_tabConfig", data);
                },
                summaryTodoTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName + ' >> ' + detail.label);
                },
                summaryTofixTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.type + ' >> ' + detail.eventName + ' >> ' +
                        detail.label);
                },
                refreshDataContext: function () {
                    this.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]')._getSelectedDimensions();
                },
                onDimensionGridOpen: function (e, detail, sender) {
                    this.$.dimensionGridDialog.dialogTitle = "Detailed Dimensional Edit for : " +
                        detail.data.longName;

                    var dimensons = this.dimensions;
                    var dimensionGridElement = document.createElement("rock-dimension-grid");

                    Polymer.dom(this).node.$.dimensionGridDialog.appendChild(dimensionGridElement);

                    dimensionGridElement.attributeModelObject = detail.data;
                    dimensionGridElement.locales = dimensons["locales"];
                    dimensionGridElement.sources = dimensons["sources"];
                    dimensionGridElement.contexts = dimensons["contexts"];
                    dimensionGridElement.dataId = DataHelper._getEntityId();
                    dimensionGridElement.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]').getSelectedDimensions();

                    this.$.dimensionGridDialog.open();
                },
                buttonOkClicked: function (event) {
                    alert("Hello");
                },
                buttonCancelclicked: function (event) {
                    alert("Cancel");
                },
                errorLengthChanged: function (e, detail) {
                    this.$$('rock-tabs')._currentTabErrorLength = detail;
                },
                _refreshView: function () {
                    var contentView = document.querySelector("main-app").$$("rock-content-view-manager")
                        .$$("rock-content-view:not([hidden])");
                    contentView.render();
                },
                getIsDirty: function () {
                    var tabs = this.$$("rock-tabs");
                    if (tabs && tabs.getIsDirty) {
                        return tabs.getIsDirty();
                    }
                },
                _getWorkflowContext: function() {
                    var context = {
                        "entityId": DataHelper._getEntityId(),
                        "locale": this._locale,
                        "source": this._source
                    };
                    return context;
                }
            });
        })();
    </script>
</dom-module>