<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-sidebar/rock-sidebar.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../rock-entity-header/rock-entity-header.html">
<link rel="import" href="../rock-dimension-grid/rock-dimension-grid.html">
<link rel="import" href="../rock-workflow-panel/rock-workflow-panel.html">
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">

<dom-module id="app-entity-manage">
    <template>
        <style include="bedrock-style-common">
            rock-entity-header {
                border-bottom: 1px solid var(--default-border-color, #c1cad4);
                padding: 0px;
            }

            rock-titlebar {
                color: var(--pagetitle-text-color, #034c89);
                font-weight: var(--font-bold, bold);
            }

            .stepper-style {
                --connected-badge-width: 50px;
                --connected-badge-height: 50px;
                --connected-badge-background: var(--cloudy-blue-color, #c1cad4);
                --connected-childBadge-width: 18px;
                --connected-childBadge-height: 18px;
                --connected-childBadge-background: var(--connected-childBadge-background, #0abf21);
                --connectorLine-width: 3px;
                --divider-color: #212121;
            }

            .sidebar-title {
                font-weight: var(--font-medium, 500);
                font-family: var(--default-font-family);
                clear: both;
                padding: 10px;
                margin: 10px;
                font-size: var(--default-font-size);
                font-weight: var(--font-bold, bold);
                font-style: normal;
                font-stretch: normal;
                color: var(--title-text-color, #191e22);
                width: 161px;
                height: 19px;
            }

            rock-dimension-selector {
                margin-right: 10px;
                --dimesion-selector-container-popover: {
                    width: 70px;
                };
                
                --dimesion-selector-source-popover: {
                    width: 55px;
                };
                
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                };
                
                --dimesion-selector-locale-popover: {
                    width: 65px;
                };
                
            }

            #dimensionContainer {
                align-self: center;
                -webkit-align-self: center;
                width: 100%;
            }

            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color, #212121);
                min-width: 1px;
                margin-top: 10px;
                margin-right: 5px;
                margin-bottom: 10px;
                margin-left: 5px;
                min-height: 18px;
            }

            .content {
                height: calc(100% - 6px);
            }

            /* Firefox specific fix for vertical scroll */

            @media all and (min--moz-device-pixel-ratio:0) and (min-resolution: 3e1dpcm) {
                .content {
                    height: calc(100vh - 200px);
                }
            }

            /* IE edge specific fix for vertical scroll */

            _:-ms-lang(x),
            _:-webkit-full-screen,
            .content {
                height: calc(100vh - 205px);
            }

            .tab-wrap {
                position: relative;
                height: calc(100% - 6px);
            }

            #dimensionGridContent {
                height: 80%;
            }

            rock-tabs {
                --rock-tab-content: {
                    overflow-y: auto;
                    font-size: var(--default-font-size, 14px);
                }
                --tab-error-circle: {
                    margin-bottom: 8px;
                }
            }

            rock-layout {
                --scroller: {
                    overflow: hidden;
                }
            }
        </style>

        <rock-layout hide-footer>
            <pebble-spinner active="[[_loading]]"></pebble-spinner>
            <liquid-config-aggregate-get id="getManageAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-manage"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <rock-titlebar icon="dashboard" main-title="" slot="rock-titlebar" sub-title="" config="{{getConfig('rock-titlebar')}}" non-minimizable="[[appConfig.nonMinimizable]]"
                non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right" hidden$="[[hideDimensionSelection(dimensionSelectorConfig)]]">
                    <rock-dimension-selector id="dimensionSelector" config-data="{{getConfig('rock-dimension-selector','','details')}}" entity-id="[[_entityId]]"
                        entity-type="[[_entityType]]"></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <rock-header frozen slot="rock-header">
                <div slot="fixed-content" class="fixed-content">
                    <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="entityManageHeader"></bedrock-pubsub>
                    <!--<bedrock-pubsub on-bedrock-event-route-changed="onRouteChange"></bedrock-pubsub>-->
                    <rock-entity-header id="entityManageHeader" context-data="[[contextData]]" header-config="{{getConfig('rock-entity-header','','headerConfig')}}"
                        buttons="{{getConfig('rock-entity-header','','toolbarConfig')}}" to-fix-data="{{getConfig('rock-entity-header','','summaryToFix')}}"
                        assignment-actions-config="{{getConfig('rock-entity-header','','assignmentActionsConfig')}}" thumbnail-config="{{getConfig('rock-entity-header','','thumbnailConfig')}}"
                        collapsable></rock-entity-header>
                </div>
            </rock-header>
            <bedrock-pubsub event-name="refresh-entity-thumbnail" handler="_refreshEntityThumbnail"></bedrock-pubsub>
            <rock-sidebar id="rockSideBar" position="right" slot="rock-sidebar" collapsable>
                <div class="p-10">
                    <rock-workflow-panel context-data="[[contextData]]" readonly$="[[readonly]]"></rock-workflow-panel>
                </div>
            </rock-sidebar>
            <div class="content">
                <template is="dom-if" if="true" id="tabsTemplate">
                    <div class="tab-wrap">
                        <rock-tabs id="rockTabs" config="{{getConfig('rock-tabs')}}" readonly$="[[readonly]]"></rock-tabs>
                    </div>
                    <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-trigger-todo-action="summaryTodoTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-tofixtap="summaryTofixTap"></bedrock-pubsub>
                    <bedrock-pubsub event-name="error-length-changed" handler="errorLengthChanged"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-grid-open" handler="onDimensionGridOpen"></bedrock-pubsub>
                </template>
            </div>
            <pebble-dialog id="dimensionGridDialog" modal show-close-icon>
            </pebble-dialog>
            <pebble-dialog id="confirmationDialog" dialog-title="Confirmation" modal show-cancel show-ok no-cancel-on-outside-click no-cancel-on-esc-key
                small>
                Are you sure you want to delete?
            </pebble-dialog>
        </rock-layout>
        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="dimensionSelector"></bedrock-pubsub>        
        <bedrock-pubsub event-name="workflow-transition-complete" handler="_onWorkflowTransitionComplete"></bedrock-pubsub>
        <bedrock-pubsub event-name="workflow-assignment-complete" handler="_onWorkflowAssignmentComplete"></bedrock-pubsub>
        <bedrock-pubsub event-name="on-attribute-save" handler="_refreshHeaderAndNavBars"></bedrock-pubsub>
        <bedrock-pubsub event-name="on-buttonok-clicked" handler="_onDeleteConfirm" target-id="confirmationDialog"></bedrock-pubsub>
        <rock-business-function-dialog id="contextDialog"></rock-business-function-dialog>
        <rock-business-function-dialog id="entityUploadDialog"></rock-business-function-dialog>
        <rock-business-function-dialog id="entityDownloadDialog"></rock-business-function-dialog>
        <rock-business-function-dialog id="rePublishDialog"></rock-business-function-dialog>
        <rock-business-function-dialog id="addRelDialog" name="rock-relationship-add"></rock-business-function-dialog>
        <rock-business-function-dialog id="manageAttributesDialog" name="bf-attributes-manage"></rock-business-function-dialog>
        <rock-business-function-dialog id="manageRelationshipsDialog" name="bf-relationships-manage"></rock-business-function-dialog>
        <bedrock-pubsub event-name="refresh-classification" handler="_refreshDimensionSelector" target-id="contextDialog"></bedrock-pubsub>
        <bedrock-pubsub event-name="govern-complete" handler="_onGovernComplete"></bedrock-pubsub>
        <liquid-entity-data-get name="attributeGetDataServiceForTitleBar" operation="getbyids" request-data="{{titleAttributeRequest}}"
            on-response="_onTitleAttributesGetResponse"></liquid-entity-data-get>
        <liquid-rest id="entityDeleteLiquidRest" url="/data/pass-through/entityappservice/delete" method="POST" request-data={{deleteRequest}}
            on-liquid-response="_deleteSuccess" on-liquid-error="_deleteFailure"></liquid-rest>
            <liquid-entity-model-composite-get id="compositeRelModelGet" request-data="{{_relModelRequest}}" on-entity-model-composite-get-response="_onRelationshipCompositeModelGetResponse" on-error="_onCompositeModelGetError">
            </liquid-entity-model-composite-get>
            <liquid-entity-model-composite-get id="compositeAttrModelGet" request-data="{{_attrModelRequest}}" on-entity-model-composite-get-response="_onAttributeCompositeModelGetResponse" on-error="_onCompositeModelGetError">
            </liquid-entity-model-composite-get>
            <liquid-entity-model-get id="getRelDomains" operation="getbyids"  on-response="_onRelModelsReceived"
                                     on-error="_onModelGetFailed"></liquid-entity-model-get>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-manage',
                properties: {
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    /*
                     * Indicates the config object for the summary element
                     */
                    summaryConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        computed: "getConfig('rock-entity-summary')"
                    },
                    /*
                     * Indicates the config for tab element
                     */
                    _tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /*
                     * Indicates the items for stepper element
                     */
                    _stepItems: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _entityType: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _entityId: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _lastSavedTime: {
                        value: ""
                    },

                    titleAttributeRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    deleteRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    dimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        computed: 'getConfig("rock-dimension-grid")'
                    },
                    dimensionSelectorConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        computed: 'getConfig("rock-dimension-selector")'
                    },
                    verbose: {
                        type: Boolean,
                        value: false
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _invalidateEntityCache: {
                        type: Boolean,
                        value: true
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _showNotificationToast: {
                        type: Boolean,
                        value: false
                    },
                    queryParams:{
                        type:String,
                        value:""
                    }
                },
                behaviors: [
                    RUFBehaviors.AppBehavior
                ],
                attached: function () {                                      
                    this._searchTimeStamp = new Date().toLocaleString();
                },
                created: function () {
                    this.contentHeightVariable = "--rock-tab-content-height";
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };

                    this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];


                    this._entityId = DataHelper.getParamValue('id');
                    this._entityType = DataHelper.getParamValue('type');

                    var itemContext = {
                        'id': this._entityId,
                        'type': this._entityType
                    };

                    this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                },
                
                refresh: function () {
                    var isDirty = false;
                    if (this.getIsDirty) {
                        isDirty = this.getIsDirty();
                    }
                    if (isDirty) {
                        if (window.confirm(
                            "There are unsaved changes. Do you want to discard the changes?")) {
                            this.shadowRoot.querySelector('rock-dimension-selector').refresh();
                            this._reRenderOnDimensionChange();
                        }
                    } else {
                        this.shadowRoot.querySelector('rock-dimension-selector').refresh();
                        this._reRenderOnDimensionChange();
                    }
                },


                /**
                 * Function to display the left nav info
                 */
                getAppCurrentStatus: function (customArgs) {

                    var title = "";
                    var param;
                    var titlebar = this.shadowRoot.querySelector('rock-titlebar');
                    if (titlebar && titlebar.mainTitle != "") {
                        param = titlebar.mainTitle;
                    }
                    title = this.getNavbarTitle(param);

                    if(customArgs && customArgs.queryParams){
                        this.queryParams = customArgs.queryParams;
                    }
                    return {
                        title: title,
                        subTitle: this.getIsDirty() ? "Draft" : this._lastSavedTime && this._lastSavedTime != "" ? "Last Saved" : "Last Opened",
                        subTitleValue: this._lastSavedTime && this._lastSavedTime != "" ? this._lastSavedTime : new Date().toLocaleString(),
                        queryParams: this.queryParams
                    };
                },

                /**
                 * Function to get the left nav title
                 */
                getNavbarTitle: function(pTitle){
                    var title = this._entityType + ": ";
                    if(pTitle){
                        title += pTitle;
                    } else {
                        title += this._entityId;
                    }
                    return title;
                },

                /**
                 *  After the page has loaded, update the title to display on the left nav
                 */
                 updateAppCurrentStatus: function(title) {
                    var appStatus = this.getAppCurrentStatus();
                    appStatus.title = this.getNavbarTitle(title);
                    this.fireBedrockEvent('app-status-updated', appStatus, { appId: "main-app", ignoreId: true });
                },

                _onApplicationConfigReceived: function (e) {
                    // this.logInfo("ConfigReceived","response",JSON.stringify(e, null, 2));
                    this.set('applicationConfig', e.detail);
                    var temp = this.applicationConfig;
                    this.applicationConfig = {}
                    this.applicationConfig = temp;
                },
                _openContextManagement: function (taxonomy) {
                    this.shadowRoot.querySelector("#contextDialog").name = "extension-manage-" + taxonomy;
                    this.shadowRoot.querySelector("#contextDialog").sharedData = { "context-data": this.contextData };
                    this.shadowRoot.querySelector("#contextDialog").open();
                },
                _onToolbarEvent: function (e, detail) {
                    var event = detail.name;
                    if (event.toLowerCase().indexOf("taxonomy") > -1) {
                        this._openContextManagement(event);
                    }
                    switch (event.toLowerCase()) {
                        case "search":
                            this._searchEvent(e, detail);
                            break;
                        case "refresh":
                            this._refreshEvent(e, detail);
                            break;
                        case "copy":
                            this._copyEvent(e, detail);
                            break;
                        case "paste":
                            this._pasteEvent(e, detail);
                            break;
                        case "clone":
                            this._cloneEvent(e, detail);
                            break;
                        case "add":
                            this._addEvent(e, detail);
                            break;
                        case "delete":
                            this._deleteEvent(e, detail);
                            break;
                        case "cut":
                            this._cutEvent(e, detail);
                            break;
                        case "upload":
                            this._openEntityUploadBF(e, detail);
                            break;
                        case "download":
                            this._downloadEvent(e, detail);
                            break;
                        case "republish":
                            this._rePublishEvent(e, detail);
                            break;
                        default:
                            this.fireBedrockEvent("grid-custom-toolbar-event", detail);
                            break;
                    }
                },
                hideDimensionSelection: function () {
                    if (_.isEmpty(this.dimensionSelectorConfig) || this.dimensionSelectorConfig["hide-selector"]) {
                        return true;
                    }
                    return false;
                },
                _onContextChanged: function () {
                    this._reRenderOnDimensionChange();
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.properties) {
                        //set context-data for all components no matter what
                        if (!component.properties['context-data'] || _.isEmpty(component.properties['context-data'])) {
                            component.properties['context-data'] = this.contextData;
                        }
                        //TODO: summary should load its config by itself
                        if (component.name == 'rock-entity-summary') {
                            component.properties.config = this.summaryConfig;
                        }
                    }
                },
                _searchEvent: function (e, detail, sender) {
                },
                _refreshEvent: function (e, detail, sender) {
                    var isDirty = false;
                    if (this.getIsDirty) {
                        isDirty = this.getIsDirty();
                    }
                    if (isDirty) {
                        if (window.confirm(
                            "There are unsaved changes. Do you want to discard the changes?")) {
                            this._refreshView();
                        }
                    } else {
                        this._refreshView();
                    }
                },
                _copyEvent: function (e, detail, sender) {
                    document.querySelector('#app').$.pebbleAppToast.fitInto = document.querySelector(
                        '#app').$.toastArea;
                    document.querySelector('#app').toastText = "Attribute Data Copied successfully!!";
                    document.querySelector('#app').$.pebbleAppToast.show();
                },
                _pasteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _cloneEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _deleteEvent: function (e, detail, sender) {
                    this.shadowRoot.querySelector("#confirmationDialog").open();
                },
                _onDeleteConfirm: function () {
                    var itemContexts = DataHelper.cloneObject(this.getItemContexts());

                    //Prepare request
                    var req = {
                        "params": {
                            "softDelete": true
                        },
                        entity: {}
                    };

                    req.entity.id = itemContexts[0].id;
                    req.entity.type = itemContexts[0].type;
                    this.set("deleteRequest", req);

                    //Send request to delete the entity
                    var liquidDelete = this.shadowRoot.querySelector("#entityDeleteLiquidRest");
                    if (liquidDelete) {
                        liquidDelete.generateRequest();
                    }

                },
                _deleteSuccess: function (e) {
                    if (e.detail && e.detail.response && e.detail.response.response) {
                        var response = e.detail.response.response
                        if (response.status == "success") {
                            this.readonly = true;
                            this.showSuccessToast("Entity delete request submitted successfully");
                        } else if (response.status == "error") {
                            var messageCode;
                            if (response.statusDetail && response.statusDetail.messages && response.statusDetail.messages.length > 0) {
                                var message = response.statusDetail.messages[0];
                                if (message) {
                                    messageCode = message.messageCode;
                                }
                            }

                            if (messageCode == "PD001") {
                                this.showErrorToast("You do not have permission to delete an entity!");
                            } else {
                                this.showErrorToast("Failed to perform delete on the entity");
                            }
                        } else {
                            this.showErrorToast("Failed to perform delete on the entity");
                        }
                    }
                },
                _deleteFailure: function (e) {
                    //console.warn("Failed to perform delete with error: ", e.detail);
                    this.showErrorToast("Failed to perform delete on the entity");
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _downloadEvent: function (e, detail) {
                    var clonedDataContext = DataHelper.cloneObject(this.contextData);
                    var itemContexts = DataHelper.cloneObject(this.getItemContexts());

                    if (itemContexts && itemContexts.length) {
                        var selectedEntities = [];
                        var selctedEntity = {
                            "id": itemContexts[0].id,
                            "type": itemContexts[0].type
                        };
                        selectedEntities.push(selctedEntity);

                        var entityDownloadDialog = this.shadowRoot.querySelector("#entityDownloadDialog");
                        entityDownloadDialog.name = "rock-entity-download";
                        entityDownloadDialog.sharedData = {
                            "context-data": clonedDataContext,
                            "selected-entities": selectedEntities
                        };
                        entityDownloadDialog.open();
                    } else {
                        this.showErrorToast("item context not found.");
                    }
                },
                _rePublishEvent: function (e, detail) {
                    var itemContexts = DataHelper.cloneObject(this.getItemContexts());
                    var rePublishDialog = this.shadowRoot.querySelector("#rePublishDialog");
                    rePublishDialog.name = detail.componentName;
                    rePublishDialog.sharedData = { "context-data": this.contextData, "selected-entities": itemContexts };
                    rePublishDialog.open();
                },
                _onCOPDownloadFailure: function (e) {
                    this.showErrorToast("Failed to download entity data. Please contact administrator.");
                    this._loading = false;
                },
                _toggleStepper: function (contexts) {
                    if (contexts && contexts.length > 1) {
                        this.$.rockSideBar.style.display = "none";
                    } else {
                        this.$.rockSideBar.style.display = "block";
                    }
                },
                summaryTodoTap: function (e, detail, sender) {
                    if (!detail || !detail.type) {
                        this.showErrorToast("Configuration missing. Please contact administrator.");
                        return;
                    }
                    this.todoActionDialogTitle = detail.label;
                    if (detail.type == "linkAssets") {
                        if (detail && detail.config && detail.config.relationshipTypeName) {
                            this._triggerLinkAssets(detail.config.relationshipTypeName);
                        } else {
                            this.showErrorToast("Relationships are not configured for this action. Please contact administrator.");
                            return;
                        }
                    } else if (detail.type == "manageAttributes") {
                        this.manageAttrLabel = detail.label || "Manage Attributes";
                        this.manageAttrNames = detail.config.attributeNames || [];
                        this.manageAttrGroups = detail.config.attributeGroupNames || [];

                        if (this.manageAttrGroups.length > 0) {
                            this._triggerManageAttributes();
                        } else {
                            if (this.manageAttrNames.length > 0) {
                                this._openManageAttributesDialog(this.manageAttrLabel, this.manageAttrNames);
                            } else {
                                this.showErrorToast("Attributes are not configured for this action. Please contact administrator.");
                            }
                        }
                    } else if (detail.type == "manageRelationships") {
                        if (detail && detail.config && detail.config.relationshipTypeName) {
                            this._triggerManageRelationships(detail.config.relationshipTypeName);
                        } else {
                            this.showErrorToast("Relationships are not configured for this action. Please contact administrator.");
                            return;
                        }
                    }
                },

                _triggerLinkAssets: function (relationshipTypeName) {
                    var liqRelModelGet = this.shadowRoot.querySelector("#compositeRelModelGet");
                    var request = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                    delete request.params.fields.attributes;
                    request.params.fields.relationships = [relationshipTypeName];
                    this._relModelRequest = request;

                    if (liqRelModelGet) {
                        liqRelModelGet.generateRequest();
                    }
                },

                _onRelationshipCompositeModelGetResponse: function (e, detail) {
                    var relationshipDetails = {};
                    if (detail && DataHelper.validateGetModelsResponse(detail.response)) {
                        var relType = "";
                        if (detail.request) {
                            relType = detail.request.requestData.params.fields.relationships[0];
                            relationshipDetails.relType = relType; // Set relationshipType
                        }
                        var compositeModel = detail.response.content.entityModels[0];
                        if (relType && compositeModel && compositeModel.data) {
                            var relationships = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);
                            if (relationships && relationships[relType]) {
                                relationshipDetails.selfContext = relationships[relType].selfContext; // Set selfContext
                                var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;
                                if (rel) {
                                    var relatedEntityInfo = [];

                                    if (rel.properties && Object.keys(rel.properties).length) {
                                        relatedEntityInfo = rel.properties.relatedEntityInfo;
                                        if (relatedEntityInfo && relatedEntityInfo.length) {
                                            var relEntityTypes = relatedEntityInfo.map(function (relContext) {
                                                if (relContext.relEntityType) {
                                                    return relContext.relEntityType;
                                                }
                                            });
                                            relationshipDetails.relatedEntityTypes = relEntityTypes; // Set relatedEntityTypes
                                        }

                                        relationshipDetails.mode = "asset"; // Set mode
                                    }
                                }
                            }
                        }
                    }

                    if (!_.isEmpty(relationshipDetails)) {
                        this._openLinkAssetsDialog(relationshipDetails);
                    } else {
                        this.showErrorToast("Relationship model missing. Please contact administrator.");
                    }
                },

                _triggerManageAttributes: function () {
                    var liqAttrModelGet = this.shadowRoot.querySelector("#compositeAttrModelGet");
                    var request = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                    delete request.params.fields.relationships;
                    delete request.params.fields.relationshipAttributes;
                    request.params.fields.attributes = ["_ALL"];
                    this._attrModelRequest = request;

                    if (liqAttrModelGet) {
                        liqAttrModelGet.generateRequest();
                    }
                },

                _onAttributeCompositeModelGetResponse: function (e, detail) {
                    if (detail && DataHelper.validateGetModelsResponse(detail.response)) {
                        var groupAttributes = [];
                        if (DataHelper.isValidObjectPath(detail, 'response.content.entityModels.0')) {
                            var attributes = DataTransformHelper.transformAttributeModels(detail.response.content.entityModels[0], this.contextData);
                            for (var key in attributes) {
                                if (this.manageAttrGroups.indexOf(attributes[key].properties.groupName) != -1) {
                                    groupAttributes.push(key);
                                }
                            }
                        }
                    }

                    // Merge config attributes and group attributes
                    var allAttrNames = this.manageAttrNames.concat(groupAttributes);

                    if (allAttrNames.length > 0) {
                        this._openManageAttributesDialog(this.manageAttrLabel, allAttrNames);
                    } else {
                        this.showErrorToast("Attributes not available. Please contact administrator.");
                    }
                },

                _triggerManageRelationships: function (relationshipTypeName) {
                    var req = {
                        "params": {
                            "query": {
                                "id": relationshipTypeName + "_relationshipModel",
                                "filters": {
                                    "typesCriterion": ["relationshipModel"]
                                }
                            },
                            "fields": {}
                        }
                    };

                    var relModelLiquid = this.shadowRoot.querySelector("#getRelDomains");
                    if (relModelLiquid) {
                        relModelLiquid.requestData = req;
                        relModelLiquid.generateRequest();
                    }
                },

                _onRelModelsReceived: function (e, detail) {
                    var responseContent = DataHelper.validateAndGetResponseContent(detail.response)
                    if (responseContent) {
                        var models = responseContent.entityModels;
                        if (models && models.length > 0) {
                            this._openManageRelationshipsDialog(models[0]);
                        }
                    }
                },

                _onCompositeModelGetError: function (e, detail) {
                    this.showErrorToast("Unable to perform the action now. Please contact administrator.");
                },

                _openLinkAssetsDialog: function (relationshipDetails) {
                    var rel = relationshipDetails.relType;
                    var typesCriterion = relationshipDetails.relatedEntityTypes;
                    var dialog = this.shadowRoot.querySelector("#addRelDialog");
                    var itemContext = ContextHelper.getFirstItemContext(this.contextData);
                    var entity = { "id": itemContext.id, "type": itemContext.type };
                    var mode = relationshipDetails.mode;
                    var selfContext = relationshipDetails.selfContext;

                    dialog.sharedData = {
                        "mode": mode,
                        "context-data": this.contextData,
                        "types-criterion": typesCriterion,
                        "relationship-type": rel,
                        "selected-entities": [entity],
                        "self-context": selfContext
                    };
                    dialog.open();
                    this._setDialogTitle(dialog);
                },

                _openManageAttributesDialog: function (label, attributeNames) {
                    var clonedContextData = DataHelper.cloneObject(this.contextData);
                    var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                    var configContext = { "groupName": label };
                    itemContext.attributeNames = attributeNames;
                    var dialog = this.shadowRoot.querySelector("#manageAttributesDialog");
                    dialog.sharedData = {
                        "context-data": clonedContextData,
                        "config-context": configContext
                    };
                    dialog.open();
                    this._setDialogTitle(dialog);
                },

                _openManageRelationshipsDialog: function (model) {
                    var clonedContextData = DataHelper.cloneObject(this.contextData);
                    var configContext = {
                        "addRelationshipMode": model.domain == "digitalAsset" ? "businessFunction" : "lov",
                        "relationshipTypeName": model.name
                    };
                    var dialog = this.shadowRoot.querySelector("#manageRelationshipsDialog");
                    dialog.sharedData = {
                        "context-data": clonedContextData,
                        "config-context": configContext
                    };
                    dialog.open();
                    this._setDialogTitle(dialog);
                },

                _setDialogTitle: function (dialog) {
                    if (this.todoActionDialogTitle) {
                        dialog.setTitle(this.todoActionDialogTitle);
                    }
                },
                
                summaryTofixTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.type + ' >> ' + detail.eventName + ' >> ' +
                        detail.label);
                },
                refreshDataContext: function () {
                    this.dataContext = Polymer.dom(this).node.shadowRoot.querySelector(
                        'rock-dimension-selector[id="dimensionSelector"]')._getSelectedDimensions();
                },
                onDimensionGridOpen: function (e, detail, sender) {
                    var dialog = Polymer.dom(this).node.$.dimensionGridDialog;

                    if (dialog) {
                        this._clearDimensionGridDialog();
                        this.$.dimensionGridDialog.dialogTitle = "Detailed Dimensional Edit for : " +
                            detail.data.externalName;

                        var dimensionGridContainer = document.createElement('div');
                        dimensionGridContainer.setAttribute('id', 'dimensionGridContent');

                        var component = {
                            "name": "rock-dimension-grid",
                            "path": "/../../src/elements/rock-dimension-grid/rock-dimension-grid.html",
                            "properties": {
                                "dimension-configs": this.dimensionSelectorConfig["details"],
                                "attribute-model-object": detail.data,
                                "locales": this.dimensions["locales"],
                                "sources": this.dimensions["sources"],
                                "contexts": this.dimensions["contexts"],
                                "data-id": DataHelper.getParamValue('id'),
                                "data-context": Polymer.dom(this).node.shadowRoot.querySelector('rock-dimension-selector[id="dimensionSelector"]').getSelectedDimensions(),
                                "context-data": this.contextData
                            }
                        };
                        ComponentHelper.loadContent(dimensionGridContainer, component, this);

                        dialog.appendChild(dimensionGridContainer);
                        dialog.open();
                    }
                },
                buttonOkClicked: function (event) {
                    alert("Hello");
                },
                buttonCancelclicked: function (event) {
                    alert("Cancel");
                },
                errorLengthChanged: function (e, detail) {
                    this.shadowRoot.querySelector('rock-tabs')._currentTabErrorLength = detail;
                },
                _refreshView: function () {
                    this._refreshRockEntityHeader();
                    this._refreshWorkflowPanel();
                    this.shadowRoot.querySelector('rock-tabs').reloadCurrentTab();
                },
                _refreshHeaderAndNavBars: function () {
                    this._invalidateEntityCache = false;
                    this._refreshRockEntityHeader();
                    this._refreshActiveMenuItems();
                    this._invalidateEntityCache = true;
                },
                getIsDirty: function () {
                    var tabs = this.shadowRoot.querySelector("rock-tabs");
                    if (tabs && tabs.getIsDirty) {
                        return tabs.getIsDirty();
                    }
                },
                getControlIsDirty: function () {
                    var tabs = this.$$("rock-tabs");
                    if (tabs && tabs.getControlIsDirty) {
                        return tabs.getControlIsDirty();
                    }
                },
                _onTitleAttributesGetResponse: function (e) {

                    var titleAttributeResponse = e.detail.response;
                    this.logInfo("EntityTitleAttributeResponse", "response", JSON.stringify(titleAttributeResponse, null, 2));

                    var attributesData = [];
                    if (DataHelper.validateGetEntitiesResponse(titleAttributeResponse)) {

                        var entity = titleAttributeResponse.content.entities[0];

                        if (entity) {
                            var attributesWithoutModel = DataTransformHelper.transformAttributes(entity, undefined, this.contextData, "array", false);
                            this.setTitleBar(entity, attributesWithoutModel);
                        }
                    }
                },
                setTitleBar: function (entity, values) {
                    var titlebar = this.shadowRoot.querySelector('rock-titlebar');
                    titlebar.mainTitle = "";
                    titlebar.subTitle = "";
                    var config = titlebar.config;

                    titlebar.mainTitle = entity.Id;
                    titlebar.subTitle = entity.type;

                    for (var i = 0; i < values.length; i++) {
                        var value = values[i];
                        if (value.name == config.titleAttribute) {
                            titlebar.mainTitle = value.value !== "" ? value.value : titlebar.mainTitle;
                        }
                        if (value.name == config.subtitleAttribute) {
                            titlebar.subTitle = value.value !== "" ? value.value : titlebar.subTitle;
                        }
                        if (titlebar.mainTitle != "" && titlebar.subTitle != "") {
                            break;
                        }
                    }

                    if (!titlebar.mainTitle || titlebar.mainTitle == "") {
                        titlebar.mainTitle = "No Title";
                    }
                    if (!titlebar.subTitle || titlebar.subTitle == "") {
                        titlebar.subTitle = "No Sub-Title";
                    }

                    this.updateAppCurrentStatus(titlebar.mainTitle);
                },
                _refreshTitleBar: function () {
                    var titlebar = this.shadowRoot.querySelector('rock-titlebar');
                    var config = titlebar.config;
                    if (config) {
                        var attributeNames = new Array();
                        if (config.titleAttribute != "") {
                            attributeNames.push(config.titleAttribute);
                        }
                        if (config.subtitleAttribute != "") {
                            attributeNames.push(config.subtitleAttribute);
                        }
                        if (attributeNames.length > 0) {
                            if (this.contextData && this.contextData.ItemContexts && this.contextData.ItemContexts.length > 0) {
                                var itemContext = this.contextData.ItemContexts[0];
                                //add attribute names in item context
                                itemContext.attributeNames = attributeNames;
                                var req = DataRequestHelper.createEntityGetRequest(this.contextData);
                                this.set("titleAttributeRequest", req);
                                var liquidDataGet = this.shadowRoot.querySelector("[name=attributeGetDataServiceForTitleBar]");
                                if (liquidDataGet) {
                                    liquidDataGet.generateRequest();
                                }
                            }
                        }
                    }
                },
                _reRenderOnDimensionChange: function () {
                    this._refreshRockEntityHeader();
                    this._refreshWorkflowPanel();
                    this._refreshTitleBar();

                    var valContexts = ContextHelper.getValueContexts(this.contextData);
                    var dataContexts = ContextHelper.getDataContexts(this.contextData);

                    if (valContexts && valContexts.length) {
                        this._toggleStepper(valContexts);
                    }

                    if (dataContexts && dataContexts.length) {
                        this._toggleStepper(dataContexts);
                    }

                    this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(30), () => {
                        this.shadowRoot.querySelector('rock-tabs').reloadTabs();
                    });
                },
                _onWorkflowTransitionComplete: function (e) {
                    this._refreshRockEntityHeader();
                    this._refreshWorkflowPanel();

                },
                _onWorkflowAssignmentComplete: function (e) {
                    this._refreshWorkflowPanel();
                },
                _refreshRockEntityHeader: function (e) {
                    this._refreshTitleBar();
                    var entityHeaderEle = Polymer.dom(this).node.shadowRoot.querySelector('rock-entity-header');
                    if (entityHeaderEle && entityHeaderEle.refresh) {
                        entityHeaderEle.refresh(this._invalidateEntityCache);
                    }
                    if (e) {
                        this._lastSavedTime = new Date().toLocaleString();
                    }
                    this._refreshEntityThumbnail();
                },
                _refreshWorkflowPanel: function () {
                    var entityWorklflowPanelEl = Polymer.dom(this).node.shadowRoot.querySelector('rock-workflow-panel');
                    if (entityWorklflowPanelEl && entityWorklflowPanelEl.refresh) {
                        entityWorklflowPanelEl.refresh();
                    }
                },
                _clearDimensionGridDialog: function () {
                    var dialog = Polymer.dom(this).node.$.dimensionGridDialog;
                    if (dialog) {
                        var childContent = dialog.firstElementChild;
                        if (childContent) {
                            dialog.removeChild(childContent);
                        }
                    }
                },
                _openEntityUploadBF: function (e, detail) {
                    this.shadowRoot.querySelector("#entityUploadDialog").name = "rock-entity-upload";
                    this.shadowRoot.querySelector("#entityUploadDialog").sharedData = { "context-data": this.contextData };
                    this.shadowRoot.querySelector("#entityUploadDialog").open();
                },
                _refreshEntityThumbnail: function () {
                    var header = this.shadowRoot.querySelector("#entityManageHeader");
                    if (header) {
                        var thumbnailConfig = this.getConfig('rock-entity-header', '', 'thumbnailConfig');
                        header.thumbnailConfig = undefined;
                        header.thumbnailConfig = thumbnailConfig;
                    }
                },
                _refreshActiveMenuItems: function () {
                    this._lastSavedTime = new Date().toLocaleString();
                    var contentView = document.querySelector("main-app").shadowRoot.querySelector("rock-content-view-manager").shadowRoot.querySelector("rock-content-view:not([hidden])");
                    this.fireBedrockEvent('app-status-changed', { "viewName": contentView.name, "contentView": contentView, "config": undefined }, { appId: "main-app", ignoreId: true });
                },
                _refreshDimensionSelector: function () {
                    Polymer.Async.microTask.run(() => {
                        this.shadowRoot.querySelector('rock-dimension-selector').refreshDimensionData();
                    })
                },
                /*
                * Handling notification on govern complete
                */
                _onGovernComplete: function (e, data) {
                    var dataIsDirty = false;
                    var controlIsDirty = false;

                    //Check if data is dirty
                    if (this.getIsDirty) {
                        dataIsDirty = this.getIsDirty();
                    }
                    
                    //Check if controls are dirty
                    if (this.getControlIsDirty) {
                        controlIsDirty = this.getControlIsDirty();
                    }
                    
                    var notificationObj = Polymer.dom(document).querySelector('main-app').$$('bedrock-dataobject-notification-handler');
                     
                    //Showing the toast message when _showNotificationToast property is set to true or if the tab is dirty, else refresh the current tab
                    if (this._showNotificationToast) {                     
                        notificationObj.showToast(data);                        
                    } else if (dataIsDirty || controlIsDirty) {
                         notificationObj.showToast(data);                        
                    } else { 
                        //Refresh the current tab                                                     
                        var rockAttributeManageObj = this.$$("rock-tabs");                    
                        rockAttributeManageObj.refresh();
                        //Refresh the workflowpanel
                        var rockWorkflowPanelObj = this.$$("rock-workflow-panel");                    
                        rockWorkflowPanelObj.refresh();                         
                    }
                },

                _onDimensionsChanged: function (e) {
                    var newDimensions = e.detail.dimensions;
                    ContextHelper.updateContextData(this.contextData, newDimensions);
                    this._onContextChanged();
                }
            });
        })();
    </script>
</dom-module>