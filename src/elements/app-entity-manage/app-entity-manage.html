<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-sidebar/rock-sidebar.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../rock-entity-header/rock-entity-header.html">
<link rel="import" href="../rock-dimension-grid/rock-dimension-grid.html">

<dom-module id="app-entity-manage">
    <template>
        <style include="pebble-styles-shared">
            .content {
                padding: 5px;
            }
            
            rock-entity-header {
                border-bottom: 1px solid var(--cloudy-blue-color);
                border-top: 1px solid var(--cloudy-blue-color);
                height: 70px;
                padding: 10px;
            }
            
            rock-titlebar::shadow #mainTitle{
                color: var(--palette-deep-sea-blue);
                font-weight: bold;
            }   

            .stepper-style {
                --connected-badge-width: 50px;
                --connected-badge-height: 50px;
                --connected-badge-background: var(--cloudy-blue-color);
                --connected-childBadge-width: 18px;
                --connected-childBadge-height: 18px;
                --connected-childBadge-background: #0abf21;
                --connectorLine-width: 3px;
                --divider-color: #212121;
            }
            
            .sidebar-title {
                font-weight: 500;
                font-family: var(--default-font-family);
                clear: both;
                padding: 10px;
                margin: 10px;
                font-size: var(--default-font-size);
                font-weight: bold;
                font-style: normal;
                font-stretch: normal;
                color: var(--sidebar-text-color);
                width: 161px;
                height: 19px;
            }
            
            rock-dimension-selector {
                --dimesion-selector-catalog-popover: {
                    width: 70px;
                };
                --dimesion-selector-source-popover: {
                    width: 55px;
                };
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                };
                --dimesion-selector-locale-popover: {
                    width: 65px;
                };
            }
            
            #dimensionContainer {
                align-self: center;
                width: 100%;
            }
            
            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color);
                min-width: 0px;
                margin: 10px 5px;
                min-height: 18px;
            }
            
            .divmargin {
                margin: 19px 0 0 0;
            }
            
            ::shadow #dimensionGridDialog ::shadow paper-dialog {
                width: 1200px !important;
            }
           pebble-dialog::shadow  .dialogTitle{
               background-color:var(--azure-two);
               top:-24px;
               color:var(--white);
               font-weight: 500;
               font-style: normal;
               font-stretch: normal;
               line-height: 28px;
               height:28px;
               letter-spacing: normal;
               padding-left: 12px;
           }
            pebble-dialog::shadow #dialog{
                border:1px solid var(--cloudy-blue-color);
            }
            pebble-dialog::shadow paper-dialog #closeIcon {
                color:var(--white);
                top: -78px !important;
            }
        </style>
        <rock-layout>
            <rock-titlebar icon="dashboard" title="" sub-title="" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <iron-ajax auto url="../../data/EntityManageApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
                    <rock-dimension-selector id="dimensionSelector" config-data="{{dimensionData}}"></rock-dimension-selector>
                    <bedrock-pubsub event-name="dimension-selector-catalog" handler="onCatalogChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-selector-source" handler="onSourceChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-selector-locale" handler="onLocaleChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                </div>
                <pebble-vertical-divider></pebble-vertical-divider>
            </rock-titlebar>
            <rock-header frozen>
                <div class="fixed-content">
                    <bedrock-pubsub on-bedrock-event-search="_searchEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-refresh="_refreshEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-copy="_copyEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-paste="_pasteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-clone="_cloneEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-add="_addEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-delete="_deleteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-cut="_cutEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-route-chamged="onRouteChange"></bedrock-pubsub>
                    <iron-ajax url="../../data/EntityManageApp/header-config.json" last-response="{{headerConfig}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/toolbar-config.json" last-response="{{toolbarConfig}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/entity-summary-tofix-data.json" last-response="{{fixes}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/entity-summary-widgets-config.json" last-response="{{summaryConfig}}" auto></iron-ajax>
                    <rock-entity-header header-config="[[headerConfig]]" buttons="[[toolbarConfig]]" to-fix-data="[[fixes]]" locale="{{locale}}"
                        list="{{list}}" source="{{source}}"></rock-entity-header>
                </div>
            </rock-header>
            <rock-sidebar id="rockSideBar" position="right">
                <div class="divmargin">
                    <span class="sidebar-title">Create & Manage Variants</span>
                    <iron-ajax auto url="../../data/EntityManageApp/app-entity-manage-stepper-data.json" handle-as="json" last-response="{{_stepItems}}"></iron-ajax>
                    <pebble-stepper vertical selected-step="1" child-selected-step="0">
                        <template is="dom-repeat" items="{{_stepItems.items}}" as="item">
                            <pebble-step class="stepper-style" data="{{item}}"></pebble-step>
                        </template>
                    </pebble-stepper>
                </div>
            </rock-sidebar>
            <div class="content">
                <template is="dom-if" if="true" id="tabsTemplate">
                    <rock-tabs id="rockTabs" config="{{_tabConfig}}">
                    </rock-tabs>
                    <iron-ajax auto url="../../data/EntityManageApp/app-entity-manage-tab-config.json" handle-as="json" on-response="_handleResponse"></iron-ajax>
                    <bedrock-pubsub event-name="component-creating" handler="onComponentCreating"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-todotap="summaryTodoTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-tofixtap="summaryTofixTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-error-length-changed="errorLengthChanged"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-grid-open" handler="onDimensionGridOpen"></bedrock-pubsub>
                </template>
            </div>
            <iron-ajax auto url="../../data/EntityManageApp/dimension-data.json" handle-as="json" last-response="{{dimensions}}"></iron-ajax>
            <pebble-dialog id="dimensionGridDialog"  show-close-icon>
            </pebble-dialog>
        </rock-layout>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-manage',

                properties: {
                    list: {
                        type: String,
                        notify: true
                    },

                    lists: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    source: {
                        type: String,
                        notify: true    
                    },

                    sources: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    locale: {
                        type: String,
                        notify: true
                    },

                    locales: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    summaryConfig: {
                        type: Object
                    },

                    _tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _stepItems: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                onCatalogChangeEvent: function (event) {
                    if (!event.detail.multiSelect) {
                        this.list = event.detail.selectedItem;
                    } else {
                        this.lists = event.detail.selectedItems;
                    }
                    this.$$('rock-tabs').reloadCurrentTab();
                },

                onSourceChangeEvent: function (event) {
                    if (!event.detail.multiSelect) {
                        this.source = event.detail.selectedItem;
                    } else {
                        this.sources = event.detail.selectedItems;
                    }
                    this.$$('rock-tabs').reloadCurrentTab();
                },

                onLocaleChangeEvent: function (event) {
                    if (!event.detail.multiSelect) {
                        this.locale = this._convertLocalesForSplitScreen(event.detail.selectedItem);
                    } else {
                        this.locales = this._convertLocalesForSplitScreen(event.detail.selectedItems);
                    }

                    this._toggleStepper(this.locales);
                    this.$$('rock-tabs').reloadCurrentTab();
                },

                _convertLocalesForSplitScreen: function (data) {
                    if (data instanceof Array) {
                        var locales = [];

                        for (var i = 0; i < data.length; i++) {
                            var objLocale = new Object();
                            objLocale.locale = data[i].title;
                            objLocale.language = data[i].language;

                            locales.push(objLocale);
                        }

                        return locales;
                    } else {
                        var objLocale = new Object();
                        objLocale.locale = data.title;
                        objLocale.language = data.language;

                        return objLocale;
                    }
                },

                onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.name.indexOf("attribute") != -1 && component.properties) {
                        if (this.list || (this.lists && this.lists.length > 0)) {
                            component.properties.list = this.list;
                            component.properties.lists = this.lists;
                        }

                        if (this.source || (this.sources && this.sources.length > 0)) {
                            component.properties.source = this.source;
                            component.properties.sources = this.sources;
                        }

                        if (this.locale || (this.locales && this.locales.length > 0)) {
                            component.properties.locale = this.locale;
                            component.properties.locales = this.locales;
                        }
                    } else if (component.name == 'rock-entity-summary') {
                        component.properties.config = this.summaryConfig;
                    }
                },

                _searchEvent: function (e, detail, sender) {

                },
                _refreshEvent: function (e, detail, sender) {
                    var isDirty = false;
                    if(this.getIsDirty) {
                        isDirty = this.getIsDirty();
                    } 
                    if(isDirty) {
                        if(window.confirm("There are unsaved changes. Do you want to discard the changes?")) {
                            this._refreshView();
                        }
                    }
                    else{
                        this._refreshView();
                    }
                },
                _copyEvent: function (e, detail, sender) {
                    document.querySelector('#app').$.pebbleAppToast.fitInto = document.querySelector(
                        '#app').$.toastArea;
                    document.querySelector('#app').toastText = "Attribute Data Copied successfully!!";
                    document.querySelector('#app').$.pebbleAppToast.show();
                },
                _pasteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cloneEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _deleteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _toggleStepper: function (locales) {
                    if (locales && locales.length > 1) {
                        this.$.rockSideBar.style.display = "none";
                    } else {
                        this.$.rockSideBar.style.display = "block";
                    }
                },
                _handleResponse: function (e) {
                    this._setTabConfigData(e.currentTarget.lastResponse);
                },
                _setTabConfigData: function (data) {
                    //can alter the data before setting it to tabConfig for rock-tabs
                    this.set("_tabConfig", data);
                },
                
                summaryTodoTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName + ' >> ' + detail.label);
                },
                
                summaryTofixTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.type + ' >> ' + detail.eventName + ' >> ' +
                        detail.label);
                },

                refreshDataContext: function () {
                    this.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]')._getSelectedDimensions();
                },

                onDimensionGridOpen: function (e, detail, sender) {
                    this.$.dimensionGridDialog.dialogTitle = "Detailed Dimensional Edit for : " +
                        detail.data.longName;

                    var dimensons = this.dimensions;
                    var dimensionGridElement = document.createElement("rock-dimension-grid");

                    Polymer.dom(this).node.$.dimensionGridDialog.appendChild(dimensionGridElement);

                    dimensionGridElement.attributeModelObject = detail.data;
                    dimensionGridElement.locales = dimensons["locales"];
                    dimensionGridElement.sources = dimensons["sources"];
                    dimensionGridElement.contexts = dimensons["contexts"];
                    dimensionGridElement.dataId = this._getEntityId();
                    dimensionGridElement.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]').getSelectedDimensions();

                    this.$.dimensionGridDialog.open();
                },

                _getEntityId: function () {
                    var mainApp = document.querySelector('main-app');
                    if (mainApp && mainApp.route && mainApp.route.__queryParams && "id" in mainApp.route
                        .__queryParams) {
                        return mainApp.route.__queryParams['id'];
                    }
                },
                buttonOkClicked: function (event) {
                    alert("Hello");
                },
                buttonCancelclicked: function (event) {
                    alert("Cancel");
                },
                errorLengthChanged: function (e, detail) {
                    this.$$('rock-tabs')._currentTabErrorLength = detail;
                },
                _refreshView: function() {
                    var contentView = document.querySelector("main-app").$$("rock-content-view-manager").$$("rock-content-view:not([hidden])");
                    contentView.render();
                },
                getIsDirty: function() {
                    var tabs = this.$$("rock-tabs");
                    if(tabs && tabs.getIsDirty) {
                        return tabs.getIsDirty();
                    }
                }
            });
        })();
    </script>
</dom-module>