<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-sidebar/rock-sidebar.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../rock-entity-header/rock-entity-header.html">
<link rel="import" href="../rock-dimension-grid/rock-dimension-grid.html">
<link rel="import" href="../rock-workflow-panel/rock-workflow-panel.html">

<dom-module id="app-entity-manage">
    <template>
        <style include="pebble-styles-shared">
            rock-entity-header {
                border-bottom: 1px solid var(--default-border-color, #c1cad4);
                height: 70px;
                padding: 10px;
            }

            rock-titlebar::shadow #mainTitle {
                color: var(--pagetitle-text-color, #034c89);
                font-weight: var(--font-bold, bold);
            }

            .stepper-style {
                --connected-badge-width: 50px;
                --connected-badge-height: 50px;
                --connected-badge-background: var(--cloudy-blue-color, #c1cad4);
                --connected-childBadge-width: 18px;
                --connected-childBadge-height: 18px;
                --connected-childBadge-background: var(--connected-childBadge-background, #0abf21);
                --connectorLine-width: 3px;
                --divider-color: #212121;
            }

            .sidebar-title {
                font-weight: var(--font-medium, 500);
                font-family: var(--default-font-family);
                clear: both;
                padding: 10px;
                margin: 10px;
                font-size: var(--default-font-size);
                font-weight: var(--font-bold, bold);
                font-style: normal;
                font-stretch: normal;
                color: var(--title-text-color, #191e22);
                width: 161px;
                height: 19px;
            }

            rock-dimension-selector {
                --dimesion-selector-container-popover: {
                    width: 70px;
                }
                ;
                --dimesion-selector-source-popover: {
                    width: 55px;
                }
                ;
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                }
                ;
                --dimesion-selector-locale-popover: {
                    width: 65px;
                }
                ;
            }

            #dimensionContainer {
                align-self: center;
                -webkit-align-self: center;
            }

            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color, #212121);
                min-width: 1px;
                margin: 10px 5px;
                min-height: 18px;
            }

            .content {
                height: 100%;
            }

            #dimensionGridContent {
                height: 80%;
            }
        </style>
        <rock-layout>
            <liquid-config-get auto id="getManageAppConfig" operation="getconfigs" request-id="getManageAppConfig" request-data="{{_configRequest}}"
                last-response="{{applicationConfig}}"></liquid-config-get>
            <rock-titlebar icon="dashboard" title="" sub-title="" config="{{getConfig('rock-titlebar')}}" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="{{getConfig('rock-dimension-selector')}}"></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <rock-header frozen>
                <div class="fixed-content">
                    <bedrock-pubsub on-bedrock-event-search="_searchEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-refresh="_refreshEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-copy="_copyEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-paste="_pasteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-clone="_cloneEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-add="_addEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-delete="_deleteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-cut="_cutEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-route-chamged="onRouteChange"></bedrock-pubsub>
                    <rock-entity-header context-data="[[contextData]]" header-config="{{getConfig('rock-entity-header','','headerConfig')}}"
                        buttons="{{getConfig('rock-entity-header','','toolbarConfig')}}" to-fix-data="{{getConfig('rock-entity-header','','summaryToFix')}}"></rock-entity-header>
                </div>
            </rock-header>
            <rock-sidebar id="rockSideBar" position="right">
                <div class="p-10">
                    <rock-workflow-panel context="[[_getWorkflowContext()]]"></rock-workflow-panel>
                </div>
            </rock-sidebar>
            <div class="content">
                <template is="dom-if" if="true" id="tabsTemplate">
                    <rock-tabs id="rockTabs" config="{{getConfig('rock-tabs')}}">
                    </rock-tabs>
                    <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-todotap="summaryTodoTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-tofixtap="summaryTofixTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-error-length-changed="errorLengthChanged"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-grid-open" handler="onDimensionGridOpen"></bedrock-pubsub>
                </template>
            </div>
            <pebble-dialog id="dimensionGridDialog" show-close-icon>
                <div id="dimensionGridContent">

                </div>
            </pebble-dialog>
        </rock-layout>
        <bedrock-pubsub event-name="app-context-changed" handler="_onAppContextChanged"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-manage',
                created: function () {
                    if (this.verbose)
                        console.log('app entity manage created');
                },
                attached: function () {
                    if (this.verbose)
                        console.log('app entity manage attached');
                },
                ready: function () {
                    if (this.verbose)
                        console.log('app entity manage ready');

                    var entityId = DataHelper.getParamValue('id');
                    var entityType = DataHelper.getParamValue('type');

                    var itemContext = {
                        'id': entityId,
                        'type': entityType
                    };

                    this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);
                },
                properties: {
                    /*
                     * Indicates the config object for the summary element
                     */
                    summaryConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        computed: "getConfig('rock-entity-summary')"
                    },
                    _configRequest: {
                        type: Object,
                        value: function () {
                            return {
                                "apps": [
                                    "app-entity-manage"
                                ],
                                "tenantId": this.tenantId,
                                "security": {
                                    "user": "user1",
                                    "role": "role1"
                                },
                                "contexts": []
                            };
                        },
                        notify: true
                    },
                    /*
                     * Indicates the config for tab element
                     */
                    _tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /*
                     * Indicates the items for stepper element
                     */
                    _stepItems: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    dimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        computed: 'getConfig("rock-dimension-grid")'
                    },

                    verbose: {
                        type: Boolean,
                        value: false
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.AppContextBehavior
                ],
                _onAppContextChanged: function (e) {
                    if (this.verbose) {
                        console.log("AppContext:- " + JSON.stringify(e.detail.contextData));
                    }
                    this._reRenderOnDimensionChange(e.detail.contextData);
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;
                    
                    if ((component.name.indexOf("attribute") != -1 ||
                            component.name.indexOf("relationship") != -1 ||
                            component.name.indexOf("variant") != -1) && component.properties) {

                        component.properties['context-data'] = this.contextData;

                    } else if (component.name == 'rock-entity-summary') {
                        component.properties.config = this.summaryConfig;
                    }
                },
                _searchEvent: function (e, detail, sender) {},
                _refreshEvent: function (e, detail, sender) {
                    var isDirty = false;
                    if (this.getIsDirty) {
                        isDirty = this.getIsDirty();
                    }
                    if (isDirty) {
                        if (window.confirm(
                                "There are unsaved changes. Do you want to discard the changes?")) {
                            this._refreshView();
                        }
                    } else {
                        this._refreshView();
                    }
                },
                _copyEvent: function (e, detail, sender) {
                    document.querySelector('#app').$.pebbleAppToast.fitInto = document.querySelector(
                        '#app').$.toastArea;
                    document.querySelector('#app').toastText = "Attribute Data Copied successfully!!";
                    document.querySelector('#app').$.pebbleAppToast.show();
                },
                _pasteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cloneEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _deleteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _toggleStepper: function (locales) {
                    if (locales && locales.length > 1) {
                        this.$.rockSideBar.style.display = "none";
                    } else {
                        this.$.rockSideBar.style.display = "block";
                    }
                },
                summaryTodoTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName + ' >> ' + detail.label);
                },
                summaryTofixTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.type + ' >> ' + detail.eventName + ' >> ' +
                        detail.label);
                },
                refreshDataContext: function () {
                    this.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]')._getSelectedDimensions();
                },
                onDimensionGridOpen: function (e, detail, sender) {
                    this.$.dimensionGridDialog.dialogTitle = "Detailed Dimensional Edit for : " +
                        detail.data.longName;

                    var dimension = this.dimensions;
                    var dimensionGridElement = document.createElement("rock-dimension-grid");

                    dimensionGridElement.attributeModelObject = detail.data;
                    dimensionGridElement.locales = dimension["locales"];
                    dimensionGridElement.sources = dimension["sources"];
                    dimensionGridElement.contexts = dimension["contexts"];
                    dimensionGridElement.dataId = DataHelper.getParamValue('id');
                    dimensionGridElement.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]').getSelectedDimensions();

                    var dimensionGridContent = Polymer.dom(this).node.$.dimensionGridDialog.querySelector(
                        '#dimensionGridContent');

                    if (dimensionGridContent) {
                        dimensionGridContent.appendChild(dimensionGridElement);
                    }

                    this.$.dimensionGridDialog.open();
                },
                buttonOkClicked: function (event) {
                    alert("Hello");
                },
                buttonCancelclicked: function (event) {
                    alert("Cancel");
                },
                errorLengthChanged: function (e, detail) {
                    this.$$('rock-tabs')._currentTabErrorLength = detail;
                },
                _refreshView: function () {
                    var contentView = document.querySelector("main-app").$$("rock-content-view-manager")
                        .$$("rock-content-view:not([hidden])");
                    contentView.render();
                },
                getIsDirty: function () {
                    var tabs = this.$$("rock-tabs");
                    if (tabs && tabs.getIsDirty) {
                        return tabs.getIsDirty();
                    }
                },
                _getWorkflowContext: function () {
                    var context = {
                        "entityId": this.entityId,
                        "list": this._list,
                        "locale": this._locale,
                        "source": this._source
                    };
                    return context;
                },
                setTitleBar: function (values) {
                    var titlebar = this.$$('rock-titlebar');
                    var config = titlebar.config;
                    for (var i = 0; i < values.length; i++) {
                        var value = values[i];
                        if (value.name == config.titleAttribute) {
                            titlebar.title = value.value !== "" ? value.value : "No Title";
                        }
                        if (value.name == config.subtitleAttribute) {
                            titlebar.subTitle = value.value !== "" ? value.value : "No Sub Title";
                        }
                        if (titlebar.title != "" && titlebar.subTitle != "") {
                            break;
                        }
                    }
                },
                _reRenderOnDimensionChange: function(contextData) {
                    if(contextData) {
                        var entityHeaderComponent = Polymer.dom(this).node.$$('rock-entity-header');
                        if(entityHeaderComponent) {
                            entityHeaderComponent.refresh();
                        }

                        var tabConfig = Polymer.dom(this).node.$$('rock-tabs').config;
                        var tabComponent = Polymer.dom(this).node.$$('rock-tabs');
                        if(tabConfig && tabComponent && tabConfig.tabItems && tabConfig.tabItems.length) {
                            tabConfig.tabItems.forEach(function(item){
                                if(item && item.component && item.component.name) {
                                    var component = tabComponent.root.querySelector(item.component.name);
                                    if(component && component.refresh) {
                                        component.contextData = {};
                                        component.contextData = contextData;
                                        //component.refresh();
                                    }
                                }
                            }, this);
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>