<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-sidebar/rock-sidebar.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../rock-entity-header/rock-entity-header.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../rock-dimension-grid/rock-dimension-grid.html">
<dom-module id="app-entity-manage">
    <template>
        <style include="pebble-styles-shared">

        </style>
        <style>
            .content {
                padding: 5px;
            }
            
            rock-entity-header {
                border-bottom: 1px #BABABA solid;
            }
            
            .stepper-style {
                --connected-badge-width: 50px;
                --connected-badge-height: 50px;
                --connected-badge-background: #c1cad4;
                --connected-childBadge-width: 18px;
                --connected-childBadge-height: 18px;
                --connected-childBadge-background: #0abf21;
                --connectorLine-width: 3px;
                --divider-color: #212121;
            }
            
            .sidebar-title {
                font-weight: 500;
                font-family: var(--default-font-family);
                clear: both;
                padding: 10px;
                margin: 10px;
                font-size: var(--default-font-size);
                font-weight: bold;
                font-style: normal;
                font-stretch: normal;
                color: var(--sidebar-text-color);
                width: 161px;
                height: 19px;
            }
            
            rock-dimension-selector {
                --dimesion-selector-catalog-popover: {
                    width: 70px;
                }
                ;
                --dimesion-selector-source-popover: {
                    width: 55px;
                }
                ;
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                }
                ;
                --dimesion-selector-locale-popover: {
                    width: 65px;
                }
                ;
            }
            
            #dimensionContainer {
                align-self: center;
                width: 100%;
            }
            
            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color);
                min-width: 0px;
                margin: 10px 5px;
                min-height: 18px;
            }
            
            .divmargin {
                margin: 19px 0 0 0;
            }
            
             ::shadow #dimensionGridDialog ::shadow paper-dialog {
                width: 1200px !important;
            }
        </style>
        <rock-layout>
            <rock-titlebar icon="dashboard" title="" sub-title="" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <iron-ajax auto url="../../data/EntityManageApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
                    <rock-dimension-selector id="dimensionSelector" config-data="{{dimensionData}}"></rock-dimension-selector>
                    <bedrock-pubsub event-name="dimension-selector-list" handler="_onListChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-selector-source" handler="_onSourceChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-selector-locale" handler="_onLocaleChangeEvent" target-id="dimensionSelector"></bedrock-pubsub>
                </div>
                <pebble-vertical-divider></pebble-vertical-divider>
            </rock-titlebar>
            <rock-header frozen>
                <div class="fixed-content">
                    <bedrock-pubsub on-bedrock-event-search="_searchEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-refresh="_refreshEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-copy="_copyEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-paste="_pasteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-clone="_cloneEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-add="_addEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-delete="_deleteEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-cut="_cutEvent"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-route-chamged="onRouteChange"></bedrock-pubsub>
                    <iron-ajax url="../../data/EntityManageApp/header-config.json" last-response="{{headerConfig}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/toolbar-config.json" last-response="{{toolbarConfig}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/entity-summary-tofix-data.json" last-response="{{fixes}}" auto></iron-ajax>
                    <iron-ajax url="../../data/EntityManageApp/entity-summary-widgets-config.json" last-response="{{summaryConfig}}" auto></iron-ajax>
                    <rock-entity-header header-config="[[headerConfig]]" buttons="[[toolbarConfig]]" to-fix-data="[[fixes]]" locale="{{_locale}}"
                        list="{{_list}}" source="{{_source}}"></rock-entity-header>
                </div>
            </rock-header>
            <rock-sidebar id="rockSideBar" position="right">
                <div class="divmargin">
                    <span class="sidebar-title">Create & Manage Variants</span>
                    <iron-ajax auto url="../../data/EntityManageApp/app-entity-manage-stepper-data.json" handle-as="json" last-response="{{_stepItems}}"></iron-ajax>
                    <pebble-stepper vertical selected-step="1" child-selected-step="0">
                        <template is="dom-repeat" items="{{_stepItems.items}}" as="item">
                            <pebble-step class="stepper-style" data="{{item}}"></pebble-step>
                        </template>
                    </pebble-stepper>
                </div>
            </rock-sidebar>
            <div class="content">
                <template is="dom-if" if="true" id="tabsTemplate">
                    <rock-tabs id="rockTabs" config="{{_tabConfig}}">
                    </rock-tabs>
                    <iron-ajax auto url="../../data/EntityManageApp/app-entity-manage-tab-config.json" handle-as="json" on-response="_handleResponse"></iron-ajax>
                    <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-todotap="summaryTodoTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-tofixtap="summaryTofixTap"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-error-length-changed="errorLengthChanged"></bedrock-pubsub>
                    <bedrock-pubsub event-name="dimension-grid-open" handler="onDimensionGridOpen"></bedrock-pubsub>
                </template>
            </div>
            <iron-ajax auto url="../../data/EntityManageApp/dimension-data.json" handle-as="json" last-response="{{dimensions}}"></iron-ajax>
            <pebble-dialog id="dimensionGridDialog">
            </pebble-dialog>
            <pebble-dialog id="pebbleDialog" dialog-title="Dirty Check" show-ok show-cancel show-close-icon>
                <p>There are unsaved changes. You want to discard those changes and continue?</p>
            </pebble-dialog>
            <bedrock-pubsub event-name="on-buttonok-clicked" handler="buttonOkClicked" target-id="pebbleDialog"></bedrock-pubsub>
            <bedrock-pubsub event-name="on-buttoncancel-clicked" handler="buttonCancelclicked" target-id="pebbleDialog"></bedrock-pubsub>
        </rock-layout>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-manage',

                properties: {
                    summaryConfig: {
                        type: Object
                    },
                    _list: {
                        type: String,
                        notify: true
                    },
                    _lists: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _source: {
                        type: String,
                        notify: true
                    },
                    _sources: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _locale: {
                        type: String,
                        notify: true
                    },
                    _locales: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _stepItems: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                listeners: {
                    'dimension-selector-initialized': '_onDimensionSelectorInitialized'
                },
                _onDimensionSelectorInitialized: function () {
                    this._list = this._convertListsForSplitScreen(this.$.dimensionSelector.listSelector
                        .selectedItem);
                    this._lists = this._convertListsForSplitScreen(this.$.dimensionSelector.listSelector
                        .selectedItems);

                    this._source = this._convertSourcesForSplitScreen(this.$.dimensionSelector.sourceSelector
                        .selectedItem);
                    this._sources = this._convertSourcesForSplitScreen(this.$.dimensionSelector.sourceSelector
                        .selectedItems);

                    this._locale = this._convertLocalesForSplitScreen(this.$.dimensionSelector.localeSelector
                        .selectedItem);
                    this._locales = this._convertLocalesForSplitScreen(this.$.dimensionSelector.localeSelector
                        .selectedItems);
                },
                _onListChangeEvent: function (event) {
                    if (!event.detail.multiSelect) {
                        this._list = this._convertListsForSplitScreen(event.detail.selectedItem);
                    } else {
                        this._lists = this._convertListsForSplitScreen(event.detail.selectedItems);
                    }

                    this._toggleStepper(this._lists);
                    this.$$('rock-tabs').reloadCurrentTab();
                },
                _onSourceChangeEvent: function (event) {
                    if (!event.detail.multiSelect) {
                        this._source = this._convertSourcesForSplitScreen(event.detail.selectedItem);
                    } else {
                        this._sources = this._convertSourcesForSplitScreen(event.detail.selectedItems);
                    }

                    this._toggleStepper(this._sources);
                    this.$$('rock-tabs').reloadCurrentTab();
                },
                _onLocaleChangeEvent: function (event) {
                    if (!event.detail.multiSelect) {
                        this._locale = this._convertLocalesForSplitScreen(event.detail.selectedItem);
                    } else {
                        this._locales = this._convertLocalesForSplitScreen(event.detail.selectedItems);
                    }

                    this._toggleStepper(this._locales);
                    this.$$('rock-tabs').reloadCurrentTab();
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.name.indexOf("attribute") != -1 && component.properties) {
                        if (this._list || (this._lists && this._lists.length > 0)) {
                            // Here it is assumed user will always provide selected items by default
                            component.properties.list = this._list;
                            component.properties.lists = this._lists;
                        }

                        if (this._source || (this._sources && this._sources.length > 0)) {
                            component.properties.source = this._source;
                            component.properties.sources = this._sources;
                        }

                        if (this._locale || (this._locales && this._locales.length > 0)) {
                            component.properties.locale = this._locale;
                            component.properties.locales = this._locales;
                        }
                    } else if (component.name == 'rock-entity-summary') {
                        component.properties.config = this.summaryConfig;
                    }
                },
                _convertListsForSplitScreen: function (data) {
                    if (data instanceof Array) {
                        var lists = [];

                        for (var i = 0; i < data.length; i++) {
                            var objList = new Object();
                            objList.title = data[i].title;
                            objList.value = data[i].value

                            lists.push(objList);
                        }

                        return lists;
                    } else {
                        return data.value;
                    }
                },
                _convertSourcesForSplitScreen: function (data) {
                    if (data instanceof Array) {
                        var sources = [];

                        for (var i = 0; i < data.length; i++) {
                            var objSource = new Object();
                            objSource.title = data[i].title;
                            objSource.value = data[i].value

                            sources.push(objSource);
                        }

                        return sources;
                    } else {
                        return data.value;
                    }
                },
                _convertLocalesForSplitScreen: function (data) {
                    if (data instanceof Array) {
                        var locales = [];

                        for (var i = 0; i < data.length; i++) {
                            var objLocale = new Object();
                            objLocale.title = data[i].title;
                            objLocale.value = data[i].value;

                            locales.push(objLocale);
                        }

                        return locales;
                    } else {
                        return data.value;
                    }
                },
                _confirm: function () {
                    var contentView = document.querySelector("main-app").$$(
                            "rock-content-view-manager")
                        .$$("rock-content-view:not([hidden])");
                    this.$.pebbleDialog.close();
                    contentView.render();
                },
                _searchEvent: function (e, detail, sender) {

                },
                _refreshEvent: function (e, detail, sender) {
                    console.log(this.$.pebbleDialog);
                    this.$.pebbleDialog.open();
                },
                _copyEvent: function (e, detail, sender) {
                    document.querySelector('#app').$.pebbleAppToast.fitInto = document.querySelector(
                        '#app').$.toastArea;
                    document.querySelector('#app').toastText = "Attribute Data Copied successfully!!";
                    document.querySelector('#app').$.pebbleAppToast.show();
                },
                _pasteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cloneEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _deleteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName);
                },
                _toggleStepper: function (locales) {
                    if (locales && locales.length > 1) {
                        this.$.rockSideBar.style.display = "none";
                    } else {
                        this.$.rockSideBar.style.display = "block";
                    }
                },
                _handleResponse: function (e) {
                    this._setTabConfigData(e.currentTarget.lastResponse);
                },
                _setTabConfigData: function (data) {
                    //can alter the data before setting it to tabConfig for rock-tabs
                    this.set("_tabConfig", data);
                },
                summaryTodoTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.eventName + ' >> ' + detail.label);
                },
                summaryTofixTap: function (e, detail, sender) {
                    alert("event triggered: " + detail.type + ' >> ' + detail.eventName + ' >> ' +
                        detail.label);
                },
                refreshDataContext: function () {
                    this.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]')._getSelectedDimensions();
                },
                onDimensionGridOpen: function (e, detail, sender) {
                    this.$.dimensionGridDialog.dialogTitle = "Detailed Dimensional Edit for : " +
                        detail.data.longName;

                    var dimensons = this.dimensions;
                    var dimensionGridElement = document.createElement("rock-dimension-grid");

                    Polymer.dom(this).node.$.dimensionGridDialog.appendChild(dimensionGridElement);

                    dimensionGridElement.attributeModelObject = detail.data;
                    dimensionGridElement.locales = dimensons["locales"];
                    dimensionGridElement.sources = dimensons["sources"];
                    dimensionGridElement.contexts = dimensons["contexts"];
                    dimensionGridElement.dataId = this._getEntityId();
                    dimensionGridElement.dataContext = Polymer.dom(this).node.$$(
                        'rock-dimension-selector[id="dimensionSelector"]').getSelectedDimensions();

                    this.$.dimensionGridDialog.open();
                },
                _getEntityId: function () {
                    var mainApp = document.querySelector('main-app');
                    if (mainApp && mainApp.route && mainApp.route.__queryParams && "id" in mainApp.route
                        .__queryParams) {
                        return mainApp.route.__queryParams['id'];
                    }
                },
                buttonOkClicked: function (event) {
                    alert("Hello");
                },
                buttonCancelclicked: function (event) {
                    alert("Cancel");
                },
                errorLengthChanged: function (e, detail) {
                    this.$$('rock-tabs')._currentTabErrorLength = detail;
                }
            });
        })();
    </script>
</dom-module>