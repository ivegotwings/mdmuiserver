<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html">
<link rel="import" href="../rock-assets-search-grid/assets-search-grid-datasource.html">
<link rel="import" href="../rock-assets-search-grid/rock-assets-search-grid.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<!--
 `rock-relationship-add` Select assets from list of assets and link to entity
-->
<dom-module id="rock-relationship-add">
    <template>
        <style  include="pebble-styles-shared">
            #actionButtons{
                margin-top: 40px;
            }
        </style>
        <div class="layout horizontal">
            <div class="flex">
                <!-- search bar-->
                <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                <div class="search-container">
                    <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                    <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                        <pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex searchFilterTag">
            <!-- Search Filter Tags -->
            <rock-entity-search-filter id="searchFilter" _selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                       types-criterion="[[typesCriterion]]"  tags="{{tags}}"></rock-entity-search-filter>
            <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
            <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
        </div>
        <template is="dom-if" if="[[_isAssetMode(mode)]]">
            <rock-assets-search-grid id="assetsSearchGrid"  context-data="[[contextData]]"  types-criterion="[[typesCriterion]]"  grid-config="[[_gridConfig]]"
                                     search-filters="[[_selectedSearchFilters]]" search-query="[[_searchQuery]]"
            ></rock-assets-search-grid>
        </template>
        <template is="dom-if" if="[[!_isAssetMode(mode)]]">
            <rock-entity-search-grid id="entitySearchGrid"  context-data="[[contextData]]"  types-criterion="[[typesCriterion]]"  grid-config="[[_gridConfig]]"
                                     search-filters="[[_selectedSearchFilters]]" search-query="[[_searchQuery]]"
            ></rock-entity-search-grid>
        </template>

        <div id="actionButtons" align="center">
            <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success " id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>

    </template>
    <script>
        Polymer({
            is: 'rock-relationship-add',
            properties: {
                /*
                 *  Indicates context data
                 */
                contextData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                typesCriterion: {
                    type: Array,
                    value: function () { return []; }
                },
                _gridConfig: {
                    type: Object,
                    value: function () { return {}; }
                },
                _searchQuery: {
                    type: String,
                    notify: true,
                    value: ''
                },
                _selectedSearchFilters: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _resetSearchEnabled: {
                    type: Boolean,
                    value: false
                },
                mode:{
                    type:String,
                    value:""
                }
            },
            observers: [
                '_contextDataChanged(contextData,typesCriterion)'
            ],
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],
            ready:function () {
                this._gridConfig=this.getParentAppConfig("rock-relationship-add-grid",this.mode);
            },
            _contextDataChanged:function () {
                if(!_.isEmpty(this.contextData) && this.typesCriterion && this.typesCriterion.length) {
                    var assetGrid=this.$$("#assetsSearchGrid");
                    if(assetGrid){
                        assetGrid.refresh();
                    }
                }
            },
            _formatValue: function(models,item, value) {
                if(!models){
                    return value;
                }
                var model=models[item];
                if(model &&
                    model.dataType &&
                    (model.dataType.toLowerCase()  == "date" ||
                    model.dataType.toLowerCase()  == "datetime"))
                {
                    return FormatHelper.convertFromISODateTime(object.value, model.dataType, model.dateFormat);
                }

                return value;
            },
            _onSearch: function (e, detail, sender) {
                this._searchQuery = detail;
                this._searchTimeStamp = new Date().toLocaleString();
            },

            //Rock search clear
            _resetSearch: function () {
                var rockSearchBar = this.$$('#searchBar');
                if (rockSearchBar) {
                    rockSearchBar.query = "";
                }
                this._searchQuery = '';
//                this._selectedSearchFilters = [];
                this.$.searchFilter.clearSearchFilters();
                this._resetSearchEnabled = false;
            },
            _showResetSearch: function (e) {
                var rockSearchBar = this.$$('#searchBar');
                var rockSearchFilter = this._getElement('rockSearchFilter');
                var query = '';
                var tags = [];

                if (rockSearchBar) {
                    query = rockSearchBar.query;
                }

                if (rockSearchFilter) {
                    tags = rockSearchFilter.tags;
                }

                if (!_.isEmpty(query) || tags.length > 0) {
                    this._resetSearchEnabled = true;
                } else {
                    this._resetSearchEnabled = false;
                }
            },
            _getElement: function (element) {
                if (element == "rockEntitySearchFilter") {
                    if (!this._rockEntitySearchFilter) {
                        this._rockEntitySearchFilter = this.$$("#searchFilter");
                    }

                    return this._rockEntitySearchFilter
                }
                else if (element == "rockSearchFilter") {
                    if (!this._rockSearchFilter) {
                        this._rockSearchFilter = this._getElement("rockEntitySearchFilter").$$("rock-search-filter");
                    }

                    return this._rockSearchFilter
                }
            },
            _isAssetMode:function (mode) {
                return mode=="asset";
            }


        });
    </script>
</dom-module>