<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html">
<link rel="import" href="../rock-entity-search-result/rock-entity-search-result.html">
<link rel="import" href="../rock-assets-search-grid/rock-assets-search-grid.html">

<!--
 `rock-relationship-add` Represents an element that selects the assets or entities from the list of assets or entities and provides a link to the selected entity.
 @demo demo/index.html
-->
<dom-module id="rock-relationship-add">
    <template>
        <style  include="bedrock-style-common">
            :host{
                --rock-grid-height:300px;
            }

            /* Search */
            .search-container .resetsearch {
                position: absolute;
                right: 0;
                bottom: -14px;
                font-size: var(--font-size-xs, 10px);
                color: var(--link-text-color);
            }
            .search-container .resetsearch pebble-button {
                height: auto;
                --pebble-button: {
                    font-size: var(--font-size-xs, 10px)!important;
                    height: auto;
                    padding-bottom:0;
                };
                --pebble-button-left-icon: {
                    width: 14px !important;
                    height: 14px!important;
                    margin-right: 2px;
                    margin-top: 3px;
                    bottom: -1px;
                };
            }

            .search-container {
                position: relative;
                display: inline-block;
                width: 100%;
            }
        </style>
        <h3 class="heading" align="center" hidden$=[[!_isheading()]]>[[heading]] </h3> 
        <div class="layout horizontal">
            <div class="flex">
                <!-- search bar-->
                <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                <div class="search-container">
                    <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                    <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                        <pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex searchFilterTag">
            <!-- Search Filter Tags -->
            <rock-entity-search-filter id="searchFilter" _selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                       types-criterion="[[typesCriterion]]"  tags="{{tags}}"></rock-entity-search-filter>
            <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
            <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
            <bedrock-pubsub event-name="build-query" handler="_searchFiltersChanged"></bedrock-pubsub>
        </div>
        <template is="dom-if" if="{{_isAssetMode(mode)}}">
            <rock-assets-search-grid id="assetsSearchGrid"  context-data="[[contextData]]"  types-criterion="[[typesCriterion]]"  grid-config="[[config.assetGridConfig]]"
                                     search-filters="[[_selectedSearchFilters]]" search-query="[[_searchQuery]]"
            ></rock-assets-search-grid>
        </template>
        <template is="dom-if" if="{{!_isAssetMode(mode)}}">
            <rock-entity-search-result id="entitySearchGrid"  context-data="[[contextData]]"  types-criterion="[[typesCriterion]]"  grid-config="[[config.entityGridConfig]]"
                                     search-filters="[[_selectedSearchFilters]]" search-query="[[_searchQuery]]"
            ></rock-entity-search-result>
        </template>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <template is="dom-if" if="[[showActionButtons]]">
            <div id="actionButtons" align="center">
                <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
                <pebble-button class="action-button-focus dropdownText btn btn-success " id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
            </div>
        </template>
        <liquid-entity-data-save name="entitySaveService" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}" on-response="_onSaveResponse"
                                 on-error="_onSaveError">
        </liquid-entity-data-save>

    </template>
    <script>
        Polymer({
            is: 'rock-relationship-add',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                mode:{
                    type:String,
                    value:""
                },
                /*
                 *  Indicates the context data.
                 */
                contextData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                typesCriterion: {
                    type: Array,
                    value: function () { return []; }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                config: {
                    type: Object,
                    value: function () { return {}; }
                },
                _searchQuery: {
                    type: String,
                    notify: true,
                    value: ''
                },
                _selectedSearchFilters: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _resetSearchEnabled: {
                    type: Boolean,
                    value: false
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                direction: {
                    type: String,
                    value:"up"
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                title:{
                    type:String
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                relationshipType:{
                    type:String
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                selectedEntities:{
                    type:Array,
                    value:function () {
                        return []
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                selfContext:{
                    type:Boolean,
                    value:false
                } ,
                _loading:{
                    type:Boolean,
                    value:false
                },
                showActionButtons: {
                    type: Boolean,
                    value: true
                }
            },
            observers: [
                '_contextDataChanged(contextData,typesCriterion,mode)'
            ],
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],
            listeners:{
                'view-mode-changed': 'onViewModeChanged'
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready:function () {
                if(this.parentElement){
                    //Grid config need to add for rock-relationship-add 
                    this.config=this.parentElement.__dataHost.config;
                }
                
            },
            _isheading:function(){
                 if(this.heading){
                     return true;
                 }else{
                     return false;
                 }
            },
            _contextDataChanged:function () {
                if(!_.isEmpty(this.contextData) && this.typesCriterion && this.typesCriterion.length) {
                    var itemContexts = [];
                    for (var i in this.typesCriterion) {
                        var itemContext = {
                            'type': this.typesCriterion[i]
                        };
                        itemContexts.push(itemContext);
                    }
                    this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
                    this._refreshGrid();
                }
            },
            _onSearch: function (e, detail, sender) {
                if(!_.isEmpty(detail)) {
                    this._searchQuery = detail.query;
                }
                this._searchTimeStamp = new Date().toLocaleString();
                this._refreshGrid();
            },

            //Rock search clear
            _resetSearch: function () {
                var rockSearchBar = this.shadowRoot.querySelector('#searchBar');
                if (rockSearchBar) {
                    rockSearchBar.query = "";
                    rockSearchBar.searchText = "";
                }
                this._searchQuery = '';
                this._selectedSearchFilters = [];
                this.$.searchFilter.clearSearchFilters();
                this._resetSearchEnabled = false;
                this._refreshGrid();
            },
            _showResetSearch: function (e) {
                var rockSearchBar = this.shadowRoot.querySelector('#searchBar');
                var rockSearchFilter = this._getElement('rockSearchFilter');
                var query = '';
                var tags = [];

                if (rockSearchBar) {
                    query = rockSearchBar.query;
                }

                if (rockSearchFilter) {
                    tags = rockSearchFilter.tags;
                }

                if (!_.isEmpty(query) || tags.length > 0) {
                    this._resetSearchEnabled = true;
                }
            },
            _getElement: function (element) {
                if (element == "rockEntitySearchFilter") {
                    if (!this._rockEntitySearchFilter) {
                        this._rockEntitySearchFilter = this.shadowRoot.querySelector("#searchFilter");
                    }

                    return this._rockEntitySearchFilter
                }
                else if (element == "rockSearchFilter") {
                    if (!this._rockSearchFilter) {
                        var entitySearchFilter=this._getElement("rockEntitySearchFilter");
                        if(entitySearchFilter && entitySearchFilter.shadowRoot) {
                            this._rockSearchFilter = entitySearchFilter.shadowRoot.querySelector("rock-search-filter");
                        }
                    }

                    return this._rockSearchFilter
                }
            },
            _isAssetMode:function (mode) {
                return mode=="asset";
            },
            _onSaveResponse: function (e, detail) {
                this._loading=false;
                var eventName = "onSave";
                var eventDetail = {
                    name: eventName,
                    "action":{
                        "name":"refresh-relationship-grid",
                         "relationshipType":this.relationshipType
                    }
                };
                this.fireBedrockEvent(eventName, eventDetail, {
                    ignoreId: true
                });
            },
            _onCancelTap:function () {
               var eventName = "onSkip";
               this.fireBedrockEvent(eventName, {}, {
                    ignoreId: true
                });
            },
            _onSaveError: function (e, detail) {
                this._loading=false;
                this.showErrorToast("Unable to add relationship now, please contact administrator.");
                console.warn(e);
            },
            _getGrid:function () {
                if(this.mode=="asset"){
                    return this.shadowRoot.querySelector("#assetsSearchGrid");
                } else{
                    return this.shadowRoot.querySelector("#entitySearchGrid")
                }
            },
            // lot-sku (isChildOf)
            _createRelationshipsUp: function (_targetList) {
                var firstContextData = ContextHelper.getFirstDataContext(this.contextData);
                var utils = SharedUtils.DataObjectFalcorUtil;
                if (this.selectedEntities && this.selectedEntities.length > 0 && _targetList && _targetList.length > 0) {
                    var _relationshipList = [];
                    for (var i = 0; i < _targetList.length; i++) {
                        var rel = {
                            "direction": "both",
                            "relationshipType": this.relationshipType,
                            "relTo": {
                                "id": _targetList[i].id,
                                "type": _targetList[i].type
                            }
                        };
                        
                        _relationshipList.push(rel);
                    }
                    var upRelationshipRequests = [];
                    for (var i = 0; i < this.selectedEntities.length; i++) {
                        var entity = this.selectedEntities[i];
                        var relationships = EntityHelper.getRelationshipByType(entity, firstContextData, this.relationshipType, this.selfContext);
                        relationships= _relationshipList.reduce( function(coll,item){
                            coll.push( item );
                            return coll;
                        }, relationships );
                        upRelationshipRequests.push(entity);
                    }

                    this._saveRequest = {
                        "entities": upRelationshipRequests
                    };

                    var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                    if (liquidSave) {
                        liquidSave.operation = "update";
                        liquidSave.generateRequest();
                    }
                }
            },

            // ensembletopp
            // productpresentationtolot
            _createRelationshipsDown: function (_targetList) {
                var firstContextData = ContextHelper.getFirstDataContext(this.contextData);
                var utils = SharedUtils.DataObjectFalcorUtil;
                if (this.selectedEntities && this.selectedEntities.length > 0 && _targetList && _targetList.length > 0) {
                    var relationshipRequests = [];
                    var _relationshipList = [];
                    for (var i = 0; i < this.selectedEntities.length; i++) {
                        var rel = {
                            "direction": "both",
                            "relationshipType": this.relationshipType,
                            "relTo": {
                                "id": this.selectedEntities[i].id,
                                "type": this.selectedEntities[i].type
                            }
                        };
                        
                        _relationshipList.push(rel);
                    }

                    for (var i = 0; i < _targetList.length; i++) {
                        var entity = _targetList[i];
                        var relationships = EntityHelper.getRelationshipByType(entity, firstContextData, this.relationshipType, this.selfContext);
                        relationships= _relationshipList.reduce( function(coll,item){
                            coll.push( item );
                            return coll;
                        }, relationships );
                        relationshipRequests.push(entity);
                    }

                    this._saveRequest = {
                        "entities": relationshipRequests
                    };

                    var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                    if (liquidSave) {
                        liquidSave.operation = "update";
                        liquidSave.generateRequest();
                    }
                }
            },
            _onSaveTap: function () {
                var grid=this._getGrid();
                if(grid){
                    var selectedItems=grid.getSelectedItems();
                    if(!selectedItems.length){
                        this.showInformationToast("Please select atleast 1 entity to link.");
                    }
                }
                if (this.direction == "up") {
                    this._createRelationshipsUp(selectedItems);
                } else {
                    this._createRelationshipsDown(selectedItems);
                }
                this._loading=true;
            },

            _searchFiltersChanged: function (e, detail) {
                var tags = detail;
                var _selectedSearchFilters = [];
                if (tags && tags.length > 0) {
                    for (let i = 0; i < tags.length; i++) {
                        var tag = tags[i];
                        var attrCond = {};
                        attrCond[tag.name] = tag.value;
                        _selectedSearchFilters.push(attrCond);
                    }
                }
                this.set('_selectedSearchFilters', _selectedSearchFilters);
                this._refreshGrid();
            },

            _refreshGrid: function() {
                 Polymer.Async.microTask.run(() => {
                    var grid=this._getGrid();
                    if(grid){
                        grid.refresh();
                    }
                });
            },
            onViewModeChanged: function (event) {
                if(event && event.detail && event.detail.data){
                    var mode = event.detail.data.toLowerCase();
                    if(this.config.assetGridConfig[mode] === undefined){
                        this.showActionButtons = false;
                    }
                    else{
                        this.showActionButtons = true;
                    }
                }
                
			}
        });
    </script>
</dom-module>