<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html"/>
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`<rock-guideme>` Represents an element which contains the dimension selection.

### Example

    <rock-guideme id="guideme" selected-items="{{selectedItems}}"></rock-guideme>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|---------
`--guideme-container` | Mixin applied to guideme component | {}
`--guideme-header` | Mixin applied to guideme component header | {}
`--guideme-addvariant-icon` | Mixin applied to add variant icon | {}
`--guideme-addvariant` | Mixin applied to variant component | {}
`--guideme-search-icon` | Mixin applied to search icon | {}
`--guideme-horizontal-divider` | Mixin applied to horizontal divider | {}
`--guideme-cancel-button` | Mixin applied to cancel button | {}
`--guideme-save-button` | Mixin applied to save button | {}
`--guideme-buttons` | Mixin applied to buttons | {}
`--guideme-inner-popover` | Mixin applied to inner popover | {}
`--inner-popover-margin-left` | The popover left margin | 0px
`--inner-popover-margin-right` | The popover right margin | 0px
`--guideme-addvariant-icon-color` | The color of add variant icon | green
`--guideme-divider-color` | The divider color | #eaeaea

@group rock Elements
@element rock-guideme
@demo demo/index.html
-->

<dom-module id="rock-guideme">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">
            .container {
				@apply(--layout-vertical);
				@apply(--layout-justified);				                
                max-width: 300px;
                @apply(--guideme-container);
			}
			
			.layout-horizontal {
				@apply(--layout-horizontal);
                @apply(--layout-justified);
			}
			
			.header {
				margin: 5px;
                font-weight: var(--font-bold, bold);
                @apply(--guideme-header);
			}

            .addvariant {                
                --pebble-icon-fill-color: var(--guideme-addvariant-icon-color, green);
                @apply(--guideme-addvariant-icon);
            }		
			
			.header-right {
				align-self: flex-start;
                -webkit-align-self: flex-start;
                cursor: pointer;                
			}

            .header-right > .inner {
                padding: 2px;
            }			

            pebble-lov 
            {  
                --lov-searchbox-icon: {
                    position: relative;                    
                    margin-right: -19px;
                    padding-top: 0px;
                    padding-left: 8px;
                    @apply(--guideme-search-icon);
                }
            }
            
            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: var(--guideme-divider-color, #eaeaea);
                --pebble-horizontal-divider: {
                    margin-bottom: 10px;
                    margin-top: 10px;
                    @apply(--guideme-horizontal-divider);
                }                                
            }             

            .cancel {               
                        --pebble-button: {
                                height: 40px;
                                color: #7D8690;
                                border: 1px solid #C1CAD4;
                                font-size: var(--default-font-size, 14px);
                                @apply(--guideme-cancel-button);
                        }                           
                    }
            .save {               
                        --pebble-button: {
                                height: 40px;
                                background: #0ABF21;
                                color: #FFFFFF;
                                border: 1px solid #0ABF21;
                                font-size: var(--default-font-size, 14px);
                                @apply(--guideme-save-button);
                        }
                  }            
            .buttons {
                        max-width: 300px;
                        margin-top: 5px;
                        text-align:center;
                        margin-top: 15px;
                        @apply(--guideme-buttons);
                    }

            .variant-ctrl {
                margin: 10px;
                @apply(--guideme-addvariant);
            }

            pebble-popover {
                margin-left: var(--inner-popover-margin-left, 0px);
                margin-right: var(--inner-popover-margin-right, 0px);
                @apply(--guideme-inner-popover);
            }
    </style>

    <iron-ajax id="guideme-ajax" auto url="[[_url]]" handle-as="json" last-response="{{data}}"></iron-ajax>
    <template is="dom-repeat" items="[[data]]">
        <div class="container">
            <div style="width: 100%;"><pebble-horizontal-divider></pebble-horizontal-divider></div>
            <div class="header layout-horizontal">
                <div><pebble-checkbox id="cb_[[item.name]]" on-change="_onTapCheckAll"></pebble-checkbox>Dimensions [[_getIndex(index)]]: [[_getName(item.name)]]</div>
                <div class="header-right layout-horizontal">                
                        <div class="inner"><pebble-icon class="addvariant" id="addVariant_[[item.name]]" icon="add-circle" on-tap="_showAddVariant"></pebble-icon></div>
                        <div class="inner"><pebble-icon icon="pebble-icons:ExpandLess" on-tap="_toggleCollapse"></pebble-icon></div>                  
                </div>
                <pebble-popover id="popover_[[item.name]]" 
                                for="addVariant_[[item.name]]"
                                auto-fit-on-attach 
                                no-overlap                                
                                horizontal-align="[[variantHorizontalAlign]]">
                    <div class="variant-ctrl">                        
                        <template is="dom-repeat" items="[[item.attributes.keys]]" as="variant">
                           <paper-input id="[[variant]]" label="[[_getAttribteLabel(item.attributes.values, index)]]" required auto-validate always-float-label error-message="required"></paper-input> 
                        </template>                        
                        <div class="buttons">
                            <pebble-button data="[[item]]" class="cancel" button-text="Cancel" noink raised elevation="2" on-tap="_onVariantCancelTap"></pebble-button>
                            <pebble-button data="[[item]]" class="save" button-text="Save" noink raised elevation="2" on-tap="_onVariantSaveTap"></pebble-button>
                        </div>
                    </div>                    
                </pebble-popover>
            </div>
            <div style="width: 100%;"><pebble-horizontal-divider></pebble-horizontal-divider></div>
            <div class="content">
                <iron-collapse id="ic_[[item.name]]" opened>
                    <div>
                        <pebble-lov items="[[item.variants]]" 
                                    multi-select                                    
                                    selected-items="{{selectedItems}}"></pebble-lov>
                    </div>
                </iron-collapse>
            </div>            
        </div>
        [[_populateLOV(item)]] 
    </template>
    <div class="buttons">
       <pebble-button class="cancel" button-text="Cancel" noink raised elevation="2" on-tap="_onCancelTap"></pebble-button>
       <pebble-button data="[[selectedItems]]" class="save" button-text="Save" noink raised elevation="2" on-tap="_onSaveTap"></pebble-button>
    </div>
</template>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'rock-guideme',

            properties: {

                    /**
                    *  Indicates the list of items in the JSON format.
                    */
                    data: {
                        type: Array,
                        notify: true,
                        value: function() { return []; }
                    },

                    /**
                    * Indicates an url to fetch an ajax request.
                    */
                    _url: {
                        type: String,
                        value: "/src/data/guideme-data.json"
                    },

                    /**
                     * Indicates the selected items as an array.
                     */
                    selectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },
                    
                    /**
                     * Indicates the horizontal alignment of the inner popover.
                     */
                    variantHorizontalAlign: {
                        type: String,
                        value: "left"
                    }                
                },
                listeners: {
                    'selection-changed': '_onSelectionChanged'                
                },

                // Populate lov with image and color
                _populateLOV: function(variant){                    
                    this.async(function(){   
                        if(variant.showcolor)
                        {
                            this.shadowRoot.querySelector('#ic_' + variant.name).querySelector('pebble-lov').showColor = true;
                        }
                        if(variant.showimage)
                        {
                            this.shadowRoot.querySelector('#ic_' + variant.name).querySelector('pebble-lov').showImage = true;
                        }
                    });                    
                },           

                // Expand or Collapse the dimension container with arrow change
                _toggleCollapse: function(e)
                {
                    var collapsableEl = this.shadowRoot.querySelector('#ic_' + e.model.item.name);
                    var arrowEl = e.target;

                    arrowEl.icon = collapsableEl.opened ? 'expand-more' : 'pebble-icons:ExpandLess';                                      
                    collapsableEl.toggle();                    
                },

                // Show add variant popover
                _showAddVariant: function(e)
                {
                    var popoverEl = this.shadowRoot.querySelector('#popover_' + e.model.item.name);
                    popoverEl.show();
                },

                // Get add variant input control label 
                _getAttribteLabel: function(values, index)
                {
                    return values[index];
                },

                // Get the index for dimension container
                _getIndex: function(index){
                    return index + 1;
                },

                // On tap event for dimension select all checkbox
                _onTapCheckAll: function(e)
                {                    
                    var cbList = this.shadowRoot.querySelector('#ic_' + e.model.item.name).querySelectorAll('pebble-checkbox');
                    
                    var flag = false;

                    if(e.target.checked)
                    {
                        flag = true;
                    }

                    for(var i = 0; i < cbList.length; i++)
                    {      
                        if(cbList[i].checked != flag)
                        {                                          
                            cbList[i].click(); //Raise on-tap event to capture selected items
                        }
                    }
                },

                // Raised when dimension selection changed
                _onSelectionChanged: function(event)
                {
                    this._updateCheckAllFlag(event);
                },

                _updateCheckAllFlag: function(event)
                {
                    var guidemeEl = event.currentTarget;
                    var cbList = guidemeEl.shadowRoot.querySelector('#ic_' + event.detail.item.type).querySelectorAll('pebble-checkbox');
                    var targetEl = guidemeEl.shadowRoot.querySelector('#cb_' + event.detail.item.type);
                    var targetFlag = true;

                    for(var i = 0; i < cbList.length; i++)
                    {
                        if(!cbList[i].checked)
                        {
                            targetFlag = false;
                            break;
                        }
                    }
                    
                    targetEl.checked = targetFlag;
                },

                // Capitalize first letter for dimension label
                _getName: function(text)
                {
                    return text.charAt(0).toUpperCase() + text.slice(1);
                },

                // When guide me cancel tapped
                _onCancelTap: function(e)
                {
                    this.selectedItems = [];                    
                    for(var i = 0; i < this.data.length; i++)
                    {
                        this.shadowRoot.querySelector('#cb_' + this.data[i].name).checked = false;
                    }
                    
                    var eventDetail = {
                    name: "guideme-cancel",
                    data: ""
                    }

                    this.selectedItems = [];
                    this.fire('bedrock-event', eventDetail);
                },

                // When guide me save tapped
                _onSaveTap: function(e)
                {
                    var eventDetail = {
                        name: "guideme-save",
                        data: e.currentTarget.data
                    }

                    this.fire('bedrock-event', eventDetail);
                },

                // When add variant cancel tapped
                _onVariantCancelTap: function(e)
                {
                    var variantPopover = this.shadowRoot.querySelector("#popover_" + e.currentTarget.data.name);
                    var attributes = e.currentTarget.data.attributes.keys;
                    this._clearVariantDetails(variantPopover, attributes);                   
                    variantPopover.hide();
                },

                // When add variant cancel tapped
                _onVariantSaveTap: function(e)
                {
                    var variantPopover = this.shadowRoot.querySelector("#popover_" + e.currentTarget.data.name);

                    if(!this._isValidVariant(variantPopover))
                    {
                        return;
                    }

                    var attributes = e.currentTarget.data.attributes.keys;
                    var variant = {"type": e.currentTarget.data.name};

                    for(var i = 0; i < attributes.length; i++)
                    {
                        var key = attributes[i];
                        variant[key] = variantPopover.querySelector("#" + key).value;
                    }
                    
                    var eventDetail = {
                        name: "guideme-variant-save",
                        data: variant
                    }

                    this.fire('bedrock-event', eventDetail);
                    this._clearVariantDetails(variantPopover, attributes);
                },

                _isValidVariant: function(element){
                    var inputElements = element.querySelectorAll('paper-input');
                    var valid = true;
                    
                    for(var i = 0; i < inputElements.length; i++)
                    {
                        var flag = inputElements[i].validate();

                        if (!flag && valid) {
                            valid = false;                            
                        }
                    }

                   return valid;
                },

                // Clear variant details
                _clearVariantDetails: function(element, attributes){
                    for(var i = 0; i < attributes.length; i++)
                    {
                        var key = attributes[i];
                        this._resetElement(element.querySelector("#" + key));
                    }
                },

                // reset elements
                _resetElement: function(element){
                    element.value = "";
                    element.removeAttribute("required");
                    element.validate();
                    element.setAttribute("required", true);
                }
        });
    })();
</script>

</dom-module>