<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-entity-download">
    <template>
        <style include="bedrock-style-common">
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        [[_message]]
        <liquid-rest id="copDownloadService" url="" method="POST" request-data={{_copDownloadRequest}} on-liquid-response="_onCOPDownloadSuccess"
            on-liquid-error="_onCOPDownloadFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-entity-download",

                properties: {
                    /**
                     * <b><i>Content development is under progress... </b></i> 
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i> 
                     */
                    skipNext: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i> 
                     */
                    businessFunctionData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    selectionMode: {
                        type: String,
                        value: "count"
                    },
                    selectionQuery: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedItemsCount: {
                        type: Number,
                        value: 0
                    },
                    syncThreshold: {
                        type: Number,
                        value: 0
                    },
                    _copDownloadRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedAttributes: {
                        type: Array
                    },
                    _message: {
                        type: String
                    },
                    copContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },
                observers: [
                    '_onDownload(selectionMode, selectedEntities,selectedAttributes, copContext)'
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _onDownload: function (selectionMode, selectedEntities, selectedAttributes, copContext) {
                    if (!_.isEmpty(selectionMode) && !_.isEmpty(selectedEntities) && !_.isEmpty(
                            copContext)) {
                        var profileContexts = [];
                        profileContexts.push(copContext);
                        var attributes = ["_ALL"];
                        if (selectedAttributes && selectedAttributes.length) {
                            attributes = selectedAttributes.map(function (item) {
                                return item.name;
                            });
                        }
                        var attrLength = "all";
                        if (attributes && attributes.length) {
                            if (attributes[0] != "_ALL") {
                                attrLength = attributes.length;
                            }
                        }
                        var count = this.selectedItemsCount || selectedEntities.length;
                        this._message = "Downloading " + count + " entities with " + attrLength +
                            " attributes";
                        if (this.selectionMode == "query" || (this.selectionMode == "count" && this.selectedEntities
                                .length > this.syncThreshold)) {
                            var req;
                            if (this.selectionMode == "query" && !_.isEmpty(this.selectionQuery)) {
                                req = {
                                    "clientState": {
                                        "notificationInfo": {
                                            "userId": DataHelper.getUserId()
                                        }
                                    },
                                    "params": {
                                        "fields": {
                                            "attributes": attributes,
                                            "relationships": [
                                                "_ALL"
                                            ]
                                        },
                                        "rsconnect": {
                                            "includeValidationData": true,
                                            "profilecontexts": profileContexts
                                        }
                                    }
                                };

                                req.params.rsconnect.profilecontexts[0].channel = "JOB";

                                if (this.selectionQuery.params && this.selectionQuery.params.isCombinedQuerySearch) {
                                    req.params.isCombinedQuerySearch = true;
                                    req.params.query = {};
                                    req.params.query.entity = this.selectionQuery.entity;
                                } else {
                                    req.params.query = this.selectionQuery.params ? this.selectionQuery
                                        .params.query : this.selectionQuery;
                                }
                            } else if (this.selectionMode == "count" && this.selectedEntities.length) {
                                if (this.selectedEntities && this.selectedEntities.length && this.contextData) {
                                    this._loading = true;
                                    req = this._prepareRequestObjectForSelectedEntities(this.selectedEntities,
                                        attributes, profileContexts);
                                } else {
                                    var data = {
                                        "messages": [{
                                            "message": "Please select at least one entity from grid to download."
                                        }],
                                        "actions": [{
                                            "name": "closeFunction",
                                            "text": "Take Me back to Where I started",
                                            "action": {
                                                "name": "refresh-data"
                                            }
                                        }]
                                    };

                                    this._gotToNextStep(data);
                                }
                            }

                            if (req) {
                                req.params.rsconnect.profilecontexts[0].channel = "JOB";
                                req.fileName = "EntityData";
                                this._setHotlineRequest(req);
                                this._copDownloadRequest = req;

                                //console.log('cop download job req', JSON.stringify(req, null, 2));
                                var copDownloadLiquid = this.shadowRoot.querySelector(
                                    "#copDownloadService");
                                if (copDownloadLiquid) {
                                    copDownloadLiquid.url = "/data/cop/downloadDataJob";
                                    copDownloadLiquid.timeout = 600000;
                                    copDownloadLiquid.generateRequest();
                                }
                            }
                        } else {
                            if (this.selectedEntities && this.selectedEntities.length && this.contextData) {
                                this._loading = true;
                                var req = this._prepareRequestObjectForSelectedEntities(this.selectedEntities,
                                    attributes, profileContexts);
                                if (req) {
                                    req.fileName = "EntityData";
                                    this._setHotlineRequest(req);
                                    var _this = this;
                                    RUFUtilities.fileDownload("/data/cop/downloadDataExcel", {
                                        httpMethod: 'POST',
                                        fileName: "EntityData",
                                        data: {
                                            data: JSON.stringify(req)
                                        },
                                        successCallback: function (url) {
                                            this._onDownloadSuccess();
                                        }.bind(_this),
                                        failCallback: function (responseHtml, url, error) {
                                            this._onDownloadFailure(responseHtml);
                                        }.bind(_this)
                                    });
                                }
                            }
                        }
                    }
                },
                _setHotlineRequest: function (request) {
                    //Add hotline flag if hotline is enabled
                    if (DataHelper.isHotlineModeEnabled()) {
                        request.hotline = true;
                    }
                },
                _onDownloadSuccess: function () {
                    var data = {
                        "messages": [{
                            "message": "Data got downloaded successfully."
                        }],
                        "actions": [{
                            "name": "closeFunction",
                            "text": "Take Me back to Where I started",
                            "action": {
                                "name": "refresh-data"
                            }
                        }]
                    };
                    this._gotToNextStep(data);
                },
                _onDownloadFailure: function (error) {
                    var data = {
                        "messages": [{
                            "message": "Failed to download entity data. Please contact administrator: " +
                                error
                        }],
                        "actions": [{
                            "name": "closeFunction",
                            "text": "Take Me back to Where I started",
                            "action": {
                                "name": "refresh-data"
                            }
                        }]
                    };

                    this._gotToNextStep(data);
                },
                _onCOPDownloadSuccess: function (e) {
                    if (e.detail && e.detail.response && e.detail.response.dataObjectOperationResponse) {
                        var response = e.detail.response.dataObjectOperationResponse;
                        var data = {};

                        if (response.status.toLowerCase() == "success") {

                            var taskId = response.dataObjects[0].properties.workAutomationId;
                            data = {
                                "messages": [{
                                    "message": "File download job started."
                                }],
                                "actions": [{
                                        "name": "closeFunction",
                                        "text": "Take Me back to Where I started",
                                        "action": {
                                            "name": "refresh-data"
                                        }
                                    },
                                    {
                                        "name": "nextAction",
                                        "text": "Take Me To Task Detail View",
                                        "dataRoute": "task-detail",
                                        "queryParams": {
                                            "id": taskId
                                        },
                                        "action": {
                                            "name": "refresh-data"
                                        }
                                    }
                                ]
                            };
                        } else if (response.status.toLowerCase() == "error") {
                            var error = response.statusDetail && response.statusDetail.message ?
                                response.statusDetail.message : "";
                            data = {
                                "messages": [{
                                    "message": "Failed to start download entity data job. Please contact administrator: " +
                                        error
                                }],
                                "actions": [{
                                    "name": "closeFunction",
                                    "text": "Take Me back to Where I started",
                                    "action": {
                                        "name": "refresh-data"
                                    }
                                }]
                            };
                        }

                        this._gotToNextStep(data);
                    }
                },
                _onCOPDownloadFailure: function (e) {
                    if (e && e.detail && e.detail.response) {
                        var error = DataHelper.validateAndGetMessage(e.detail.response);
                        var data = {
                            "messages": [{
                                "message": "Failed to start download entity data job. Please contact administrator: " +
                                    error
                            }],
                            "actions": [{
                                "name": "closeFunction",
                                "text": "Take Me back to Where I started",
                                "action": {
                                    "name": "refresh-data"
                                }
                            }]
                        };

                        this._gotToNextStep(data);
                    }
                },
                _prepareRequestObjectForSelectedEntities: function (selectedEntities, attributes,
                    profileContexts) {
                    var req;

                    if (selectedEntities && selectedEntities.length) {
                        var clonedDataContext = DataHelper.cloneObject(this.contextData);
                        var itemContext = {};
                        itemContext.id = [];
                        itemContext.type = [];

                        this.selectedEntities.forEach(function (item) {
                            if (item) {
                                itemContext.id.push(item.id);

                                if (itemContext.type.indexOf(item.type) == -1) {
                                    itemContext.type.push(item.type);
                                }
                            }
                        }, this);

                        itemContext.attributeNames = attributes;
                        itemContext.relationships = ["_ALL"];
                        itemContext.relationshipAttributes = ["_ALL"];
                        clonedDataContext[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                        req = DataRequestHelper.createEntityGetRequestForDownload(clonedDataContext,
                            profileContexts);
                    }

                    return req;
                },

                _gotToNextStep: function (data) {
                    this.businessFunctionData = data;
                    ComponentHelper.getParentElement(this).businessFunctionData = data;
                    var eventName = "onDownload";
                    var eventDetail = {
                        name: eventName,
                        data: {
                            "skipNext": this.skipNext
                        }
                    };
                    this._loading = false;
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                }
            });
        })();
    </script>
</dom-module>