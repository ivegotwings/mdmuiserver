<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-validator/bedrock-validator.html">

<link rel="import" href="../pebble-info-icon/pebble-info-icon.html">
<!--
`pebble-dropdown` Represents a dropdown form field that contains a list of items in a form.
It is similar to a native browser select element. It works with selectable content. 
Currently, the selected item is displayed in the control. The label is displayed, if no item is selected.

@demo demo/index.html 
-->

<dom-module id="pebble-dropdown">
  <template>
    <style include="bedrock-style-common bedrock-styles-scroll-bar">
      paper-dropdown-menu {
        width: 100%;
        padding-top: var(--paper-listbox-t-p, 10px);
        padding-bottom: var(--paper-listbox-b-p, 10px);
        --paper-input-container: {
          padding-top:0px;
          padding-right:0px;
          padding-bottom:0px;
          padding-left:0px;
        };
        --paper-input-container-underline: {
          border-bottom: 1px solid var(--textbox-border, #d2d8de);
        };
        --paper-input-container-underline-focus: {
          border-bottom: 1px solid var(--primary-border-button-color, #026bc3);
        };
        --paper-input-container-label: {
          font-size: var(--default-font-size, 14px)!important;
        };
        --paper-input-container-input: {
          height:24px;
          font-size: var(--default-font-size, 14px)!important;
        };
        --paper-menu-button-dropdown: {
          margin-top: 40px;
        };
        --paper-menu-button-content:{
          box-shadow: 0 0 var(--popup-box-shadow-size, 8px) 0 var(--popup-box-shadow, #8A98A3) !important;
        };
        --paper-input-container-label-focus:{
          color: var(--focused-line, #026bc3);
        };
      }
      paper-listbox {
        max-height: 268px;
        overflow-y: auto;
        box-shadow: 0 0 var(--popup-box-shadow-size, 8px) 0 var(--popup-box-shadow, #8A98A3) !important;
      }
      paper-listbox paper-item{
        white-space: nowrap;
        min-height:0;
      }
      pebble-dropdown .dropdown-content paper-item:hover {
        background-color: var(--bgColor-hover, #e8f4f9);
        color: var(--focused-line, #026bc3);
      }
      pebble-dropdown .dropdown-content paper-item:focus{
        color: var(--primary-button-color, #036bc3);
        background-color: var(--bgColor-hover, #e8f4f9);
      }
      .list{
            @apply --layout-vertical;
      }    
      /* IE edge specific fix for task list vertical scrollbar */
      _:-ms-lang(x), _:-webkit-full-screen,paper-listbox { 
          overflow-y:hidden;
      }
    </style>

    <template is="dom-if" if="[[noLabelFloat]]">
      <div class="attribute-view-label">
        [[label]]
        <template is="dom-if" if="[[descriptionObject]]">
          <pebble-info-icon description-object="[[descriptionObject]]"></pebble-info-icon>
        </template>
      </div>
    </template>

    <paper-dropdown-menu id="dropdown"
                         error-message="[[errorMessage]]"
                         invalid="{{invalid}}"
                         label="[[getLabelValue()]]"
                         no-label-float="[[noLabelFloat]]">

      <paper-listbox id="listbox" slot="dropdown-content" class="dropdown-content" selected="{{selectedIndex}}">
        <template is="dom-repeat" items="{{_keyValuePairs}}">
          <div class="list">
            <paper-item>{{item.title}}</paper-item>
          </div>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <bedrock-validator show-error="[[showError]]" validation-errors="[[validationErrors]]" input="[[selectedValue]]" pattern="[[pattern]]"
      min-length="[[minlength]]" max-length="[[maxlength]]" precision="[[precision]]" required="[[required]]" invalid="{{invalid}}"
      error-message="{{errorMessage}}" min="[[min]]" max="[[max]]" type="[[validationType]]" type-array="[[validationTypeArray]]"></bedrock-validator>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'pebble-dropdown',
        ready: function () {
          if (this._keyValuePairs && this._keyValuePairs.length) {
            for (var i = 0; i < this._keyValuePairs.length; i++) {
              var keyValue = this._keyValuePairs[i];
              if (keyValue.value == this.selectedValue) {
                this.selectedIndex = i;
                break;
              }
            }
          }
        },
        properties: {
          /**
            * Indicates the title of the dropdown control, which gets displayed in UI.
            */
          label: {
            type: String,
            value: ""
          },
          /**
            * Indicates the list of comma seperated values to represent the values in the String.
            */
          items: {
            type: Object,
            value: function () {
              return {};
            },
            observer: '_itemsChanged'
          },

          itemsSeperator: {
            type: String,
            value: ","
          },

          _keyValuePairs: {
            type: Array,
            value:function () {
              return [];
            }
          },
          /**
            * Indicates the index number of the item. It starts with -1.
            */
          selectedIndex: {
            type: Number,
            value: -1,
            observer: "_selectedIndexChanged"
          },
          /**
            * Indicates the selected value from the list.
            */
          selectedValue: {
            type: String,
            value: "",
            notify: true,
            observer: "_selectedValueChanged"
          },
          /**
            * Specifies whether or not to show the error.
            */
          showError: {
            type: Boolean,
            value: false
          },
          /**
           * Indicates whether to disable the floating label or not.
           * Set the value as <b>true</b> to disable the floating label.
           */
          noLabelFloat: {
            type: Boolean,
            value: false
          },
          /**
           * Description object should contain non-empty
           * description field (type type: Array or String)
           */
          descriptionObject: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          }
        },
        _itemsChanged: function () {
          var items = this.items;
          var keyValuePairs = [];
          if (!items) {
            return keyValuePairs;
          }

          if (typeof (items) == "string") {
            if (items && items != "") {
              var itemsArray = items.split(this.itemsSeperator);
              for (var i = 0; i < itemsArray.length; i++) {
                var item = itemsArray[i];
                keyValuePairs.push({ 'value': item, 'title': item });
              }
            }
          }

          if (typeof (items) == "object") {
            keyValuePairs.push.apply(keyValuePairs, items);
          }

          this._keyValuePairs = keyValuePairs;

          if(this._keyValuePairs.length && this.selectedValue) {
            this._setNewIndex(this._keyValuePairs, this.selectedValue);
          }
        },
        _selectedIndexChanged: function (newIndex, oldIndex) {
          if (newIndex !== undefined && this._keyValuePairs) {
            if (this.selectedValue != this._keyValuePairs[newIndex]) {
              var oldValue = undefined;
              
              if(oldIndex > -1) {
                oldValue = this._keyValuePairs[oldIndex].value;
              }
              
              if(newIndex > -1) {
                this.selectedValue = this._keyValuePairs[newIndex].value;
                var eventParams = { 'newValue': this.selectedValue, 'oldValue': oldValue };
                this.dispatchEvent(new CustomEvent('change', {detail:eventParams,bubbles:true,composed:true}));
              }
            }
          }
        },
        _selectedValueChanged: function (newValue, oldValue) {
          this._setNewIndex(this.keyValuePairs, newValue);
        },
        _setNewIndex: function (keyValuePairs, newSelectedValue) {
          var newIndex = -1;
          if (keyValuePairs !== undefined && newSelectedValue !== undefined) {
            for (var i = 0; i < keyValuePairs.length; i++) {
              var keyValue = keyValuePairs[i];
              if (keyValue.value == newSelectedValue) {
                newIndex = i;
                break;
              }
            }

            if (this.selectedIndex !== newIndex) {
              this.selectedIndex = newIndex;
            }
          }
        },
        /**
        * Can be used to focus the input element of dropdown.
        */
        focus: function () {
          this.$.dropdown.shadowRoot.querySelector('paper-input').inputElement.focus();
        },

        getLabelValue: function () {
          return this.noLabelFloat ? "" : this.label;
        }
      });
    })();
  </script>

</dom-module>