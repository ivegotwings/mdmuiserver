<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bedrock-validator/bedrock-validator.html">
<!--
`pebble-dropdown` Represents a dropdown form field that contains a list of items in a form.
It is similar to a native browser select element. It works with selectable content. 
Currently, the selected item is displayed in the control. The label is displayed, if no item is selected.

@demo demo/index.html 
-->

<dom-module id="pebble-dropdown">
  <template>
    <style include="pebble-styles-shared">
      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container {
        padding: 0;
      }

      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container input {
        font-size: var(--default-font-size, 14px)!important;
      }

      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container label {
        font-size: var(--default-font-size, 14px)!important;
        line-height: 28px !important;
      }

      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container::shadow .unfocused-line {
        border-bottom: 1px solid var(--textbox-border, #d2d8de);
      }

      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container::shadow .focused-line {
        border-bottom: 1px solid var(--primary-border-button-color, #026bc3);
      }

      paper-dropdown-menu {
        width: 100%;
      }

      paper-dropdown-menu::shadow paper-menu-button::shadow iron-dropdown>.dropdown-content,
      paper-dropdown-menu::shadow paper-menu-button::shadow iron-dropdown::shadow #contentWrapper>.dropdown-content {
        margin-top: 30px !important;
        box-shadow: 0 0 var(--popup-box-shadow-size, 8px) 0 var(--popup-box-shadow, #8A98A3);
      }

      paper-listbox paper-item {
        cursor: pointer;
        font-size: var(--font-size-sm, 12px);
        color: var(--palette-steel-grey, #75808b);
        text-align: left;
        min-height: 30px;
        line-height: 16px;
      }

      paper-listbox,
      paper-dropdown-menu {
        padding-top: var(--paper-listbox-t-p, 10px);
        padding-bottom: var(--paper-listbox-b-p, 10px);
      }

      .list {
        @apply(--layout-vertical);
      }
    </style>

    <paper-dropdown-menu id="dropdown" label="{{label}}" error-message="[[errorMessage]]" invalid="{{invalid}}">
      <paper-listbox id="listbox" class="dropdown-content" selected="{{selectedIndex}}">
        <template is="dom-repeat" items="{{_keyValuePairs}}">
          <div class="list">
            <paper-item>{{item.title}}</paper-item>
          </div>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <bedrock-validator show-error="[[showError]]" validation-errors="[[validationErrors]]" input="[[selectedValue]]" pattern="[[pattern]]"
      min-length="[[minlength]]" max-length="[[maxlength]]" precision="[[precision]]" required="[[required]]" invalid="{{invalid}}"
      error-message="{{errorMessage}}" min="[[min]]" max="[[max]]" type="[[validationType]]" type-array="[[validationTypeArray]]"></bedrock-validator>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'pebble-dropdown',
        ready: function () {
          if (this._keyValuePairs && this._keyValuePairs.length) {
            for (var i = 0; i < this._keyValuePairs.length; i++) {
              var keyValue = this._keyValuePairs[i];
              if (keyValue.value == this.selectedValue) {
                this.selectedIndex = i;
                break;
              }
            }
          }
        },
        properties: {
          /**
            * Indicates the title of the dropdown control, which gets displayed in UI.
            */
          label: {
            type: String,
            value: ""
          },
          /**
            * Indicates the list of comma seperated values to represent the values in the String.
            */
          items: {
            type: Object,
            value: function () {
              return {};
            },
            observer: '_itemsChanged'
          },
          _keyValuePairs: {
            type: Array,
            value:function () {
              return [];
            }
          },
          /**
            * Indicates the index number of the item. It starts with -1.
            */
          selectedIndex: {
            type: Number,
            value: -1,
            observer: "_selectedIndexChanged"
          },
          /**
            * Indicates the selected value from the list.
            */
          selectedValue: {
            type: String,
            value: "",
            notify: true,
            observer: "_selectedValueChanged"
          },
          /**
            * Specifies whether or not to show the error.
            */
          showError: {
            type: Boolean,
            value: false
          }
        },
        _itemsChanged: function () {
          var items = this.items;
          var keyValuePairs = [];
          if (!items) {
            return keyValuePairs;
          }

          if (typeof (items) == "string") {
            if (items && items != "") {
              var itemsArray = items.split(",");
              for (var i = 0; i < itemsArray.length; i++) {
                var item = itemsArray[i];
                keyValuePairs.push({ 'value': item, 'title': item });
              }
            }
          }

          if (typeof (items) == "object") {
            keyValuePairs.push.apply(keyValuePairs, items);
          }

          this._keyValuePairs = keyValuePairs;

          if(this._keyValuePairs.length && this.selectedValue) {
            this._setNewIndex(this._keyValuePairs, this.selectedValue);
          }
        },
        _selectedIndexChanged: function (newIndex, oldIndex) {
          if (newIndex !== undefined && this._keyValuePairs) {
            if (this.selectedValue != this._keyValuePairs[newIndex]) {
              var oldValue = undefined;
              
              if(oldIndex > -1) {
                oldValue = this._keyValuePairs[oldIndex].value;
              }
              
              if(newIndex > -1) {
                this.selectedValue = this._keyValuePairs[newIndex].value;
                var eventParams = { 'newValue': this.selectedValue, 'oldValue': oldValue };
                this.fire('change', eventParams);
              }
            }
          }
        },
        _selectedValueChanged: function (newValue, oldValue) {
          this._setNewIndex(this.keyValuePairs, newValue);
        },
        _setNewIndex: function (keyValuePairs, newSelectedValue) {
          var newIndex = -1;
          if (keyValuePairs !== undefined && newSelectedValue !== undefined) {
            for (var i = 0; i < keyValuePairs.length; i++) {
              var keyValue = keyValuePairs[i];
              if (keyValue.value == newSelectedValue) {
                newIndex = i;
                break;
              }
            }

            if (this.selectedIndex !== newIndex) {
              this.selectedIndex = newIndex;
            }
          }
        },
        /**
        * Can be used to focus the input element of dropdown.
        */
        focus: function () {
          this.$.dropdown.$$('paper-input').inputElement.focus();
        }
      });
    })();
  </script>

</dom-module>