<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bedrock-validator/bedrock-validator.html">
<!--
`pebble-dropdown` Represents a dropdown form field that contains a list of items in a form.
It is similar to a native browser select element. It works with selectable content. 
Currently, the selected item is displayed in the control. The label is displayed, if no item is selected.

@demo demo/index.html 
-->

<dom-module id="pebble-dropdown">
  <template>
    <style include="pebble-styles-shared">
      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container{
          padding: 0;
      }
      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container input{
          font-size: var(--default-font-size, 14px)!important;        
      }
      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container label{
            font-size: var(--default-font-size, 14px)!important;
            line-height: 28px !important;
      }
      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container::shadow .unfocused-line{
        border-bottom: 1px solid var(--textbox-border, #d2d8de);
      }
      paper-dropdown-menu::shadow paper-menu-button .dropdown-trigger paper-input::shadow paper-input-container::shadow .focused-line{
        border-bottom: 1px solid var(--primary-border-button-color, #026bc3);
      }
      paper-dropdown-menu{
        width: 100%;
      }
      paper-dropdown-menu::shadow paper-menu-button::shadow iron-dropdown .dropdown-content{
        margin-top: 30px;
      }
      paper-listbox paper-item{
          min-height: 30px;
          font-size: var(--font-size-sm, 12px);
          cursor: pointer;
          font-weight: 500;
      }
      paper-listbox paper-item:hover, paper-listbox paper-item.iron-selected{
        background: var(--dropdown-selection-bg, #eaf3fc);
        color: var(--dropdown-selected-font, #036bc3);
        font-weight: 500!important;
      }
      paper-listbox paper-item:focus{
        display: none;
      }
      paper-listbox,paper-dropdown-menu{
        padding-top:var(--paper-listbox-t-p, 10px);
        padding-bottom:var(--paper-listbox-b-p, 10px);
      }
      
    </style>

    <paper-dropdown-menu id="dropdown" label="{{label}}"    error-message="[[errorMessage]]"  invalid="{{invalid}}" >
      <paper-listbox id="listbox" class="dropdown-content" selected="{{selectedIndex}}">
        <template is="dom-repeat" items="{{itemsArray}}">
          <paper-item>{{item}}</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <bedrock-validator show-error="[[showError]]" validation-errors="[[validationErrors]]" input="[[selectedValue]]" pattern="[[pattern]]" min-length="[[minlength]]" max-length="[[maxlength]]"  precision="[[precision]]" required="[[required]]"
                        invalid="{{invalid}}" error-message="{{errorMessage}}" min="[[min]]" max="[[max]]"  type="[[validationType]]" type-array="[[validationTypeArray]]"></bedrock-validator>

  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'pebble-dropdown',
        ready: function () {
          if (this.itemsArray && this.itemsArray.length) {
              for (var i = 0; i < this.itemsArray.length; i++) {
                  if (this.itemsArray[i] == this.selectedValue) { 
                    this.selectedIndex = i; 
                    break; 
                  }
              } 
          }
        },
        properties: {
          /**
            * Indicates the title of the dropdown control, which gets displayed in UI.
            */
          label: {
            type: String,
            value: ""
          },
          /**
            * Indicates the list of comma seperated values to represent the values in the String.
            */
          items: {
            type: String,
            value: ""
          },
          /**
            * Indicates the list of comma seperated values to the values in an Array.
            */
          itemsArray: {
            type: Array,
            computed: "_splitItems(items)",
            observer: "_itemsChanged"
           },
          /**
            * Indicates the index number of the item. It starts with -1.
            */
          selectedIndex: {
            type: Number,
            value: -1,
            observer: "_selectedIndexChanged"
          },
          /**
            * Indicates the selected value from the list.
            */
          selectedValue: {
            type: String,
            value: "",
            notify: true,
            observer: "_selectedValueChanged"
          },
        /**
          * Specifies whether or not to show the error.
          */
          showError:{
              type:Boolean,
              value:false
          }
        },
        _splitItems: function (i) {
          return i.split(",");
        },
        _selectedIndexChanged: function (newValue, oldValue) {
          if (newValue !== undefined && this.itemsArray) {
            if (this.selectedValue != this.itemsArray[newValue]) {
              this.selectedValue = this.itemsArray[newValue];
              var eventParams = { 'newValue': newValue, 'oldValue': oldValue };
              this.fire('change', eventParams);              
            }
          }
        },
        _selectedValueChanged: function (newValue, oldValue) {
          this._setNewIndex(this.itemsArray, newValue);
        },
        _itemsChanged: function (newValue, oldValue) {
          this._setNewIndex(newValue, this.selectedValue);
        },
        _setNewIndex: function (newItemsArray, newSelectedValue) {
          var newIndex = -1;
          if (newItemsArray !== undefined && newSelectedValue !== undefined) {
            for (var i = 0; i < newItemsArray.length; i++) {
              if (newItemsArray[i] == newSelectedValue) {
                newIndex = i;
                break;
              }
            }
            if (this.selectedIndex !== newIndex) {
              this.selectedIndex = newIndex;
            }
          }
        },
        /**
        * Can be used to focus the input element of dropdown.
        */
        focus: function () {
            this.$.dropdown.$$('paper-input').inputElement.focus();
        }
      });
    })();
  </script>

</dom-module>