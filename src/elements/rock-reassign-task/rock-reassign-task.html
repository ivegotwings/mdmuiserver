<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../rock-entity-model-lov/rock-entity-model-lov.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<dom-module id="rock-reassign-task">
    <template>
        <style>
            #buttonContainer{
                margin-top:20px;
                text-align: center;
            }
            .lov-wrapper{
                width: 100%;
                text-align: center;
            }
            .lov-container{
                width:460px;
                display:inline-block;
                padding: 20px;
                margin: 10px 0 0 10px;
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);
                border: var(--box-style_-_border,solid 1px var(--default-border-color, #c1cad4));
                border-radius: var(--box-style_-_border-radius);
            }
        </style>   
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-entity-model-get id="getWorkflowDefinition" operation="getbyids" request-id="req1"
        on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <liquid-rest id="entityWfAssignment" url="/data/pass-through/entitygovernservice/workflowChangeAssignment" method="POST"
            request-data={{_wfAssignmentRequest}} on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
        <div class="lov-wrapper">
            <div class="lov-container">
                <template is="dom-if" if="[[_isUserModelRequestPrepared(_userModelRequestData)]]">
                    <rock-entity-model-lov id="userModelLOV" readonly=[[readonly]] id-field="id"
                        title-pattern="{entity.properties.firstName}" sub-title-pattern="{entity.properties.email}" request-data="[[_userModelRequestData]]"
                        selected-item="{{_selectedUserItem}}" external-data-formatter="[[_entityExternalDataFormatter]]"></rock-entity-model-lov>
                </template>
            </div>
        </div>
        <div id="buttonContainer" >
            <pebble-button id="cancelButton" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
            <pebble-button id="assign" class="focus btn btn-success" button-text="Confirm" on-tap="_confirm" elevation=1 raised></pebble-button>
        </div>
    </template>

  <script>
      
    class RockReassignTask extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior], Polymer.Element) {

        static get is() { return 'rock-reassign-task' }

        static get properties() {
            return {
                _loading: {
                    type: Boolean,
                    value: false
                },
                _userModelRequestData:{
                    type:Object,
                    value:function(){
                        return {}
                    }
                },
                _WorkflowData:{
                    type:Boolean,
                    value:false
                },
                _selectedUserItem:{
                    type:Object,
                    value:function(){
                        return {}
                    },
                    notify:true
                },
                workflowRunningInstance:{
                    type:Object,
                    value:function(){
                        return {};
                    }
                },
                foundWorkflowNames:{
                    type:Array,
                    value:function(){
                        return [];
                    }
                },
                
                _failedWorkflows: {
                    type: Array,
                    value: function () { return []; }
                },
                _doneWorkflows: {
                    type: Array,
                    value: function () { return []; }
                },
                _wfAssignmentRequest: {
                    type: Object,
                    value: function () { return {}; }
                },
                _responseMessages: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                }
            }
        }      
         
        connectedCallback() {
            super.connectedCallback();
           
            this._currentWfIndex = 0;
            //Prepare users request
            this._prepareUserModelRequest();
        }

        _entityExternalDataFormatter(formattedData, data){
            //Filter current assigned user
            var domHost = this.domHost;
            var assingedUser = domHost.workflowRunningInstance[domHost.foundWorkflowNames[domHost._currentWfIndex]].activityAssignedUser;
            var loggedUser = ContextHelper.getFirstUserContext(domHost.contextData);
            var loggedUserId = "";
            if(loggedUser && loggedUser.user){
                loggedUserId = loggedUser.user;
            }
            if(assingedUser && formattedData && formattedData.length > 0){
                formattedData = formattedData.filter( (user) => {
                    //Get firstname & lastname
                    var userData = data.filter((eModel) => { return eModel.id == user.id; });
                    if(userData && userData.length > 0 && userData[0].properties){
                        var userProperties = userData[0].properties
                        if(userProperties.firstName){
                            user.title = userProperties.firstName
                        }else{
                            user.title = "";
                        }
                        if(userProperties.lastName){
                            user.title += " " + userProperties.lastName
                        }
                    }
                    var userId = user.id.replace("_user", "");
                    return (userId != assingedUser) && loggedUserId && (loggedUserId != user.id);
                });
            }
            return formattedData;
        }
        _generateAssignmentRequest() {
            var entity = this._getEntityObject();
            var wfCriterion = this._getWfCriterion(this.workflowRunningInstance[this.foundWorkflowNames[this._currentWfIndex]]);
            if (!_.isEmpty(wfCriterion)) {
                var req = DataRequestHelper.createWfChangeAssignmentRequest(entity, wfCriterion, this.contextData, "reassign", this._selectedUserItem);

                //Add hotline flag if hotline is enabled
                if (DataHelper.isHotlineModeEnabled()) {
                    req.hotline = true;
                }

                this.set("_wfAssignmentRequest", req);
                var liquidWfAssign = this.shadowRoot.querySelector("#entityWfAssignment");
                if (liquidWfAssign) {
                    liquidWfAssign.generateRequest();
                }
            }
        }
        _onAssignmentSuccess(e) {
            this._responseMessages = [];
            var response = e.detail.response;
            var entity = this._getEntityObject();
            if (response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                var statusDetail = response.response.statusDetail;
                var workflowJson = this.workflowRunningInstance[this.foundWorkflowNames[this._currentWfIndex]];
                if (statusDetail.messages && statusDetail.messages.length > 0) {
                    this._failedWorkflows.push(workflowJson);
                } else if (statusDetail.message) {
                    this._doneWorkflows.push(workflowJson);
                }
            }
            this._currentWfIndex++;
            if (this._currentWfIndex < this.foundWorkflowNames.length) {
                this._generateAssignmentRequest();
            } else if (response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                if(response.response.statusDetail.message){
                    this._responseMessages.push({message:response.response.statusDetail.message});
                }
                this._triggerFinishStep();
            }
            else {
                this.showErrorToast("There is a problem with the server.Please try after some time")
            }
        }
        _triggerFinishStep() {
            this._loading = false;
            var actions = [{
                        "name": "goBack",
                        "text": "Take me back to where I started",
                        "isNotApp": true
                    }];
            var data = {
                "messages":this._responseMessages,
                "actions": actions,
                "contextData": this.contextData
            };

            this.businessFunctionData = data;
            var eventName = "onNext";
            var eventDetail = {
                name: eventName
            }

            this.fireBedrockEvent(eventName, eventDetail, {
                    ignoreId: true
            });

            setTimeout(() => {
                var data = {
                    "contextData": this.contextData
                }
                ComponentHelper.fireBedrockEvent("workflow-refresh", data, { ignoreId: true });
                this.refresh();
            }, 5000)
        }
        refresh(invalidateEntityCache = true) {
            if (invalidateEntityCache) {
                //Invalidate entity cache
                var entity = this._getEntityObject();
                LiquidDataObjectUtils.invalidateDataObjectCache(entity);
            }
        }
        _onAssignmentFailure(e) {
            this.logWarning("WorkFlowAssignmentFailure", "response", JSON.stringify(e.detail));
            this.showErrorToast("Failed to perform the workflow assignment. Please contact administrator.");
        }
        _getEntityObject() {
            var itemCtx = ContextHelper.getFirstItemContext(this.contextData);
            var entity = {
                "id": itemCtx.id,
                "type": itemCtx.type
            };
            return entity;
        }
        _getWfCriterion(runtimeInstance) {
            var wfCriterion;
            if (runtimeInstance && runtimeInstance.name && runtimeInstance.activityName) {
                wfCriterion = {
                    "workflowShortName": runtimeInstance.name,
                    "workflowActivityName": runtimeInstance.activityName
                };
            }
            return wfCriterion;
        }
        _prepareUserModelRequest(){
            var req = DataRequestHelper.createGetModelRequest([], "user");
            var allowedRoles = this.workflowRunningInstance[this.foundWorkflowNames[this._currentWfIndex]].activityAllowedRoles;
            if(allowedRoles && allowedRoles.length > 0){
                req.params.query.filters["propertiesCriterion"] = [{
                                                            "roles":{
                                                                "exacts":allowedRoles
                                                            }
                                                        }]
            };
            delete req.params.fields.attributes;
            delete req.params.fields.relationships;
            delete  req.params.query.ids;
            req.params.fields.properties = ["_ALL"];
            this.set("_userModelRequestData", req);
        }
        _isUserModelRequestPrepared(){
            if(this._userModelRequestData && !_.isEmpty(this._userModelRequestData)){
                return true;
            }
            return false;
        }
        _confirm(){
            if(this._selectedUserItem && !_.isEmpty(this._selectedUserItem)){
                this._currentWfIndex = 0;
                this._failedWorkflows = [];
                this._doneWorkflows = [];
                this._loading = true;
                this._generateAssignmentRequest();
            }else{
                this.showWarningToast("Please select a user for changing assignment.");
            }
        }

        _onCancelTap(){
            var eventName = "onCancel";
            this.fireBedrockEvent(eventName, {}, {
                ignoreId: true
            });
        }
    }

    customElements.define(RockReassignTask.is, RockReassignTask);  
  </script> 
</dom-module>