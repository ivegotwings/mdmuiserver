<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../rock-entity-model-lov/rock-entity-model-lov.html">

<dom-module id="rock-reassign-task">
    <template>
        <style>
            #buttonContainer{
                margin-top:20px;
                text-align: center;
            }
        </style>   
        <liquid-entity-model-get id="getWorkflowDefinition" operation="getbyids" request-id="req1"
        on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <!-- <liquid-entity-model-get id="userModelGet" operation="get" on-response="_onUserModelGetResponse"></liquid-entity-model-get> -->
        <liquid-rest id="entityWfAssignment" url="/data/pass-through/entitygovernservice/workflowChangeAssignment" method="POST"
            request-data={{_wfAssignmentRequest}} on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
        <div>
            <template is="dom-if" if="[[_isWorkflowDataReceived(_WorkflowData)]]">
                <rock-entity-model-lov id="userModelLOV" readonly=[[readonly]] id-field="id"
                    title-pattern="name" sub-title-pattern="{role}" request-data="[[_requestData]]"
                    selected-item="{{_selectedUserItem}}"></rock-entity-model-lov>
            </template>
        </div>
        <div id="buttonContainer" >
            <pebble-button id="cancelButton" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
            <pebble-button id="assign" class="focus btn btn-success" button-text="Confirm" on-tap="_confirm" elevation=1 raised></pebble-button>
        </div>
    </template>

  <script>
      
    class RockReassignTask extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior], Polymer.Element) {

        static get is() { return 'rock-reassign-task' }

        static get properties() {
            return {
                _requestData:{
                    type:Object,
                    value:function(){
                        return {}
                    }
                },
                _WorkflowData:{
                    type:Boolean,
                    value:false
                },
                _selectedUserItem:{
                    type:Object,
                    value:function(){
                        return {}
                    },
                    notify:true
                },
                workflowRunningInstance:{
                    type:Object,
                    value:function(){
                        return {};
                    }
                },
                foundWorkflowNames:{
                    type:Array,
                    value:function(){
                        return [];
                    }
                },
                
                failedWorkflows: {
                    type: Array,
                    value: function () { return []; }
                },
                doneWorkflows: {
                    type: Array,
                    value: function () { return []; }
                },
                _wfAssignmentRequest: {
                    type: Object,
                    value: function () { return {}; }
                }
            }
        }      
         
        connectedCallback() {
            super.connectedCallback();
            var workflowDefLiq = this.shadowRoot.querySelector("#getWorkflowDefinition");
            if(workflowDefLiq){
                workflowDefLiq.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                workflowDefLiq.generateRequest();
            }
        }

        _onDefinitionReceived(e){
            var workflowDefinitionResponse = e.detail.response;
            if (workflowDefinitionResponse && workflowDefinitionResponse.content && workflowDefinitionResponse.content.entityModels && workflowDefinitionResponse.content.entityModels.length > 0) {
                var workflowData = [];
                var allowedRoles = [];
                var allowedUsers = [];
                for (var i = 0; i < workflowDefinitionResponse.content.entityModels.length; i++) {
                    var entityModel = workflowDefinitionResponse.content.entityModels[i];
                    var workflowName = entityModel.name;

                    if (entityModel.data && entityModel.data.attributes && entityModel.data.attributes.activities && entityModel.data.attributes.activities.group) {
                        
                        var group = entityModel.data.attributes.activities.group;
                        if(group && group.length > 0){
                            group.forEach(function(groupItem){
                                if(groupItem && groupItem.activityName && groupItem.activityName.values){
                                    for (var valueCount = 0; valueCount < groupItem.activityName.values.length; valueCount++) {
                                        var _value = groupItem.activityName.values[valueCount];
                                        if(_value && _value.value && (this.workflowRunningInstance[workflowName].activityName == _value.value)){
                                            if(groupItem["allowedRoles"] && groupItem["allowedRoles"]["values"]){
                                                allowedRoles = groupItem["allowedRoles"]["values"];
                                            }
                                            if(groupItem["allowedUsers"] && groupItem["allowedUsers"]["values"]){
                                                allowedUsers = groupItem["allowedUsers"]["values"];
                                            }
                                            break;
                                        }
                                    }
                                }
                            }.bind(this));
                        }
                        
                    }
                }
                var req = DataRequestHelper.createGetModelRequest([], "user");
                var roles = [];
                if(allowedRoles && allowedRoles.length > 0){
                    allowedRoles.forEach(function(role){
                        if(role && role.value && (roles.indexOf(role.value) == -1)){
                            roles.push(role.value);
                        }
                    }.bind(this));
                    req.params.query.filters["propertiesCriterion"] = [{
                                                                "roles":{
                                                                    "exacts":roles
                                                                }
                                                            }]
                };

                delete  req.params.query.ids;
                // if(allowedUsers && allowedUsers.length > 0){
                //     req.params.query.ids = allowedUsers;
                // }
                this._requestData = req;
                this.set("_WorkflowData", workflowDefinitionResponse);
            }
        }
        _onDefinitionGetFailed(e) {
            Polymer.Base._error('workflow definition get failed with error ', e.detail);
        }
        _generateAssignmentRequest() {
            var entity = this._getEntityObject();
            var wfCriterion = this._getWfCriterion(this.workflowRunningInstance[this.foundWorkflowNames[this._currentWfIndex]]);
            if (!_.isEmpty(wfCriterion)) {
                var req = DataRequestHelper.createWfChangeAssignmentRequest(entity, wfCriterion, this.contextData, "reassign", this._selectedUserItem);

                //Add hotline flag if hotline is enabled
                if (DataHelper.isHotlineModeEnabled()) {
                    req.hotline = true;
                }

                this.set("_wfAssignmentRequest", req);
                var liquidWfAssign = this.shadowRoot.querySelector("#entityWfAssignment");
                if (liquidWfAssign) {
                    liquidWfAssign.generateRequest();
                }
            }
        }
        _onAssignmentSuccess(e) {
            var response = e.detail.response;
            var entity = this._getEntityObject();
            if (response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                var statusDetail = response.response.statusDetail;
                var workflowJson = this.workflowRunningInstance[this.foundWorkflowNames[this._currentWfIndex]];
                if (statusDetail.messages && statusDetail.messages.length > 0) {
                    this.failedWorkflows.push(workflowJson);
                } else if (statusDetail.message) {
                    this.doneWorkflows.push(workflowJson);
                }
            }
            this._currentWfIndex++;
            if (this._currentWfIndex < this.foundWorkflowNames.length) {
                this._generateAssignmentRequest();
            } else if (response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                var messageObject = this._getMessageObject();
                this._showToastMessage(messageObject);
                this._onCancelTap()
                // setTimeout(() => {
                    this.refresh();
                // }, 5000)
            }
            else {
                this.showErrorToast("There is a problem with the server.Please try after some time")
            }
        }
        refresh(invalidateEntityCache = true) {
            if (invalidateEntityCache) {
                //Invalidate entity cache
                var entity = this._getEntityObject();
                LiquidDataObjectUtils.invalidateDataObjectCache(entity);
            }
        }
        _onAssignmentFailure(e) {
            this.logWarning("WorkFlowAssignmentFailure", "response", JSON.stringify(e.detail));
            this.showErrorToast("Failed to perform the workflow assignment. Please contact administrator.");
        }
        _getEntityObject() {
            var itemCtx = ContextHelper.getFirstItemContext(this.contextData);
            var entity = {
                "id": itemCtx.id,
                "type": itemCtx.type
            };
            return entity;
        }
        _getWfCriterion(runtimeInstance) {
            var wfCriterion;
            if (runtimeInstance && runtimeInstance.name && runtimeInstance.activityName) {
                wfCriterion = {
                    "workflowShortName": runtimeInstance.name,
                    "workflowActivityName": runtimeInstance.activityName
                };
            }
            return wfCriterion;
        }
        _getMessageObject() {
            var entity = this._getEntityObject();
            var entityName;

            entityName = this._messageAttributeValue ? this._messageAttributeValue + " (" + entity.id + ")" : entity.id;
            var messageObject = {
                "message": "",
                "type": ""
            };
            var actionDone = "assigned to";
            
            if (this.foundWorkflowNames.length == this.doneWorkflows.length && this.foundWorkflowNames.length == 1) {
                var workflowJson = this.doneWorkflows[0];
                messageObject.message = "The {0} of type {1} selected is in {2} as part of {3} business process has been {4} you.".format(entityName, entity.type, workflowJson.activityExternalName, workflowJson.wfLongName, actionDone);
                messageObject.type = "success";
            } else if (this.foundWorkflowNames.length == this.failedWorkflows.length && this.foundWorkflowNames.length == 1) {
                var workflowJson = this.failedWorkflows[0];
                messageObject.message = "You do not have permission to take an action on this {0}. Workflow name: {1}; Step: {2}. \nPlease contact your administrator.".format(entity.type, workflowJson.activityExternalName, workflowJson.wfLongName);
                messageObject.type = "error";
            } else if (this.foundWorkflowNames.length == this.doneWorkflows.length) {
                var message = "The {0} of type {1} selected is in ".format(entityName, entity.type);
                message = this._buildMessage(this.doneWorkflows, message);
                message = message + "have been {0} you".format(actionDone);
                messageObject.message = message;
                messageObject.type = "success";
            }
            else if (this.foundWorkflowNames.length == this.failedWorkflows.length) {
                var message = "You do not have permission to take an action on this {1} as part of ".format(entityName, entity.type);
                message = this._buildMessage(this.failedWorkflows, message);
                message = message + "as you do not belong to role mapped to the workflow steps in the system. \nPlease contact your administrator.";
                messageObject.message = message;
                messageObject.type = "error";
            }
            else {
                var message1 = "The {0} of type {1} selected is in ".format(entityName, entity.type);
                message1 = this._buildMessage(this.doneWorkflows, message1);
                message1 = message1 + "have been {0} you.".format(actionDone) + '<br>';

                var message2 = "You do not have permission to take an action on this {1} as part of ".format(entityName, entity.type);
                message2 = this._buildMessage(this.failedWorkflows, message2);
                message2 = message2 + "as you do not belong to role mapped to the workflow steps in the system. \nPlease contact your administrator.";

                messageObject.message = message1 + message2;
                messageObject.type = "success";
            }
            return messageObject;
        }
        _showToastMessage(msgObject) {
            if (msgObject) {
                if (msgObject.type == "error") {
                    this.showErrorToast(msgObject.message, 10000);
                } else if (msgObject.type == "success") {
                    this.showSuccessToast(msgObject.message, 10000);
                }
            }
        }
        _isWorkflowDataReceived(){
            if(this._WorkflowData && !_.isEmpty(this._WorkflowData)){
                return true;
            }
            return false;
        }
        _confirm(){
            if(this._selectedUserItem && !_.isEmpty(this._selectedUserItem)){
                var eventName = "onNext";
                var eventDetail = {
                    userInfo:this._selectedUserItem
                }
                this.fireBedrockEvent(eventName, eventDetail, {
                    ignoreId: true
                });
                this._currentWfIndex = 0;
                this.failedWorkflows = [];
                this.doneWorkflows = [];
                this._generateAssignmentRequest();
            }else{
                this.showWarningToast("Please select a user for changing assignment.");
            }
        }

        _onCancelTap(){
            var eventName = "onCancel";
            this.fireBedrockEvent(eventName, {}, {
                ignoreId: true
            });
        }
    }

    customElements.define(RockReassignTask.is, RockReassignTask);  
  </script> 
</dom-module>