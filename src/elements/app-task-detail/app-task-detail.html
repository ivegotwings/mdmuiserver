<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html" />
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html" />

<link rel="import" href="../pebble-spinner/pebble-spinner.html" />
<link rel="import" href="../pebble-accordion/pebble-accordion.html" />
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html" />

<link rel="import" href="../rock-layout/rock-layout.html" />
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html" />
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html" />
<link rel="import" href="../rock-layout/rock-header/rock-header.html" />
<link rel="import" href="../rock-task-summary/rock-task-summary.html" />
<link rel="import" href="../rock-task-error-grid/rock-task-error-grid.html" />
<link rel="import" href="../rock-entity-search-discovery/rock-entity-search-discovery.html" />


<dom-module id="app-task-detail">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem"></style>
        <style include="iron-flex"></style>
            <style>
                .summary-container {
                    padding: 20px;
                }

                pebble-horizontal-divider {
                    background-color: var(--palette-pale-grey-three, #e7ebf0);
                }

                .message-box {
                    font-family: 'Roboto', Helvetica, Arial, sans-serif;
                    font-size: var(--default-font-size,14px);
                    font-weight: normal;
                    font-style: normal;
                    font-stretch: normal;
                    color: var(--palette-dark,#1a2028);
                    opacity: 0.7;
                }
                rock-layout{
                    --rock-layout-height:{
                        height :100vh;
                    }
                }
            </style>
        <rock-layout>
            <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" operation="getbyids" request-id="req1" app-name="app-task-detail"
                                         context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <liquid-rest id="taskDetailsGet" url="/data/eventservice/getTaskDetails" method="POST" request-data={{_taskDetailsGetRequest}}
                on-liquid-response="_onTaskDetailsGetResponse" on-liquid-error="_onTaskDetailsGetError"></liquid-rest>
            <pebble-spinner active="[[_loading]]"></pebble-spinner>
            <rock-titlebar icon="pebble-lg-icons:InegrationDb" main-title="App Task Details" non-minimizable="[[appConfig.nonMinimizable]]" non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" context-data="[[contextData]]" app-name="app-task-detail" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <div class="flex">
                <div class="summary-container">
                    <template is="dom-if" if="[[_isTaskDetailsLoading]]">
                        <pebble-accordion header-text="Summary & Filters" default-icon="chevron-right" open-icon="expand-more">
                            <rock-task-summary id="rockTaskSummary" task-details="[[_taskDetails]]"></rock-task-summary>
                        </pebble-accordion>
                    </template>
                    <pebble-horizontal-divider></pebble-horizontal-divider>
                </div>
                <template is="dom-if" if="[[_showInProgressTasks]]">
                    <!--<div class="p-l-20 p-r-20">Content Development in Progress</div>-->
                </template>
                <template is="dom-if" if="[[_loadCompletedTasks(_showCompletedTasks, applicationConfig)]]">
                    <div class="flex">
                        <rock-entity-search-discovery id="entitySearchDiscoveryGrid" context-data="[[contextData]]" entity-id-list="[[entityIdList]]" 
                            requested-entity-types="[[entityTypeList]]" allowed-entity-types=[[entityTypeList]]></rock-entity-search-discovery>
                    </div>
                </template>
                <template is="dom-if" if="[[_loadErrorTasks(_showErroredTasks, applicationConfig)]]">
                    <div class="flex">
                        <rock-task-error-grid id="jobEntityDetailGrid" task-id="[[taskId]]" context-data="[[contextData]]">
                        </rock-task-error-grid>
                    </div>
                </template>
                <template is="dom-if" if="[[_showMessage]]">
                    <div class="flex">
                        <div class="col-12 text-center">
                            <div id="messagePanel" class="message-box">[[_message]]</div>
                        </div>
                    </div>
                </template>
            </div>
        </rock-layout>
        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="dimensionSelector"></bedrock-pubsub>        
        <bedrock-pubsub event-name="show-inprogress" handler="_onInProgressClick" target-id="rockTaskSummary"></bedrock-pubsub>
        <bedrock-pubsub event-name="show-completed" handler="_onCompletedClick" target-id="rockTaskSummary"></bedrock-pubsub>
        <bedrock-pubsub event-name="show-errors" handler="_onErrorsClick" target-id="rockTaskSummary"></bedrock-pubsub>
        <bedrock-pubsub event-name="refresh-task-details" handler="_onRefreshClick" target-id="rockTaskSummary"></bedrock-pubsub>
       
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "app-task-detail",

                properties: {
                    contextData:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    },
                    _taskDetailsGetRequest:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    },
                    _showMessage:{
                        type: Boolean
                    },
                    taskId: {
                        type: String,
                        value: ""
                    },

                    _taskDetails: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _showInProgressTasks: {
                        type: Boolean,
                        value: false
                    },

                    _showCompletedTasks: {
                        type: Boolean,
                        value: false
                    },

                    _showErroredTasks: {
                        type: Boolean,
                        value: false
                    },

                    _loading: {
                        type: Boolean,
                        value: true
                    },

                    _isTaskDetailsLoading: {
                        type: Boolean,
                        computed: "_computeStatus(_loading)"
                    },

                    _message: {
                        type: String,
                        value: ""
                    },

                    _defaultMessage: {
                        type: String,
                        value: "No details available currently"
                    },
                    entityIdList:{
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },entityTypeList:{
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    queryParams:{
                        type:String,
                        value:""
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior
                ],

                ready: function () {
                    this.taskId = DataHelper.getParamValue("id");
                    this._taskDetailsGetRequest = {
                        "taskId": this.taskId
                    };

                    this._message = this._defaultMessage;
                },
                created: function(){
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "ownershipData": this.ownershipData,
                        "tenant": this.tenantId
                    };
                    this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];

                },

                attached: function () {
                    this._searchTimeStamp = new Date().toLocaleString();
                    this._initiateTaskDetailsGetRequest();
                },

                /**
                 * Function to display the left nav info
                 */ 
                getAppCurrentStatus: function (customArgs) { 
                    if(customArgs && customArgs.queryParams){
                        this.queryParams = customArgs.queryParams;
                    }
                    return {
                        title:"Task Details",
                        subTitle: "Last Searched",
                        subTitleValue: this._searchTimeStamp ? this._searchTimeStamp : new Date().toLocaleString(),
                        queryParams: this.queryParams
                    };
                },

                /**
                 *  After the page has loaded, update the title to display on the left nav
                 */ 
                updateAppCurrentStatus: function(pTitle) {
                    if(pTitle) {
                        var appStatus = this.getAppCurrentStatus();
                        appStatus.title = pTitle;
                        this.fireBedrockEvent('app-status-updated', appStatus, { appId: "main-app", ignoreId: true });
                    }                   
                },

                refresh: function () {
                    this._onRefreshClick();
                },

                _loadCompletedTasks: function () {
                    if (!DataHelper.isEmptyObject(this.applicationConfig) && this._showCompletedTasks) {
                        return true;
                    }
                    return false;
                },

                _loadErrorTasks: function () {
                    if (!DataHelper.isEmptyObject(this.applicationConfig) && this._showErroredTasks) {
                        return true;
                    }
                },

                _computeStatus: function () {
                    return !this._loading;
                },

                _initiateTaskDetailsGetRequest: function () {
                    var taskDetailsGet = this.shadowRoot.querySelector("#taskDetailsGet");
                    if (taskDetailsGet) {
                        taskDetailsGet.generateRequest();
                    }
                },

                _onTaskDetailsGetResponse: function (e, detail) {
                    this._loading = false;
                    var taskDetails = detail.response;

                    if (taskDetails && !_.isEmpty(taskDetails)) {

                        //Convert task startTime and endTime
                        taskDetails.startTime = FormatHelper.convertFromISODateTimeToClientFormat(
                            taskDetails.startTime, 'datetime');
                        taskDetails.endTime = FormatHelper.convertFromISODateTimeToClientFormat(
                            taskDetails.endTime, 'datetime');

                        if (taskDetails.successEntities && taskDetails.successEntities.ids &&
                            taskDetails.successEntities.ids.length > 0) {
                            this.entityIdList = taskDetails.successEntities.ids;
                            this.entityTypeList = taskDetails.successEntities.types;

                            if (!this._showCompletedTasks) {
                                this._showCompletedTasks = true;
                            } else {
                                this._reloadRockDiscovery();
                            }
                        } else if (taskDetails.taskStatus.toLowerCase() == "errored") {
                            if (taskDetails.preProcessFailure) {
                                this._message = taskDetails.message;
                                this._showMessage = true;
                            } else {
                                this._showErroredTasks = true;
                            }
                        } else {
                            this._showMessage = true;
                        }
                    } else {
                        //Task details are not available... 
                        //It could be still task is waiting to be queued... set default values
                        taskDetails.taskId = detail.request.requestData.taskId;
                        taskDetails.taskStatus = "Waiting To Be Queued";
                        taskDetails.fileName = "N/A";
                        taskDetails.fileId = "N/A";
                        taskDetails.taskType = "N/A";
                        taskDetails.startTime = "N/A";
                        taskDetails.endTime = "N/A";
                        taskDetails.submittedBy = "N/A";
                        taskDetails.totalRecords = "N/A";
                        taskDetails.taskStats = {"error":"0%","processing":"100%","success":"0%","createRecords":"0%",
                            "updateRecords":"0%","deleteRecords":"0%","noChangeRecords":"100%"};
                        
                        this._message = this._defaultMessage;
                        this._showMessage = true;
                    }

                    this._taskDetails = taskDetails;
                    //update the nav menu contents
                    var navBarTitle = "";
                    if (taskDetails.taskType != "N/A") {
                        navBarTitle = taskDetails.taskType; 
                    }      
                    if(taskDetails.fileName != "N/A"){
                        navBarTitle = navBarTitle +": " +taskDetails.fileName;
                    } else if(taskDetails.taskName != "N/A"){
                        navBarTitle = navBarTitle +": " +taskDetails.taskName;
                    }             
                    this.updateAppCurrentStatus(navBarTitle);
                },

                _onTaskDetailsGetError: function (e, detail) {
                    // Show Error Toast
                },

                _onInProgressClick: function (e) {
                    // this.showChart = true;
                },

                _onCompletedClick: function (e) {
                    var successEntities = this._taskDetails.successEntities;

                    if (!DataHelper.isEmptyObject(successEntities)) {
                        this.entityIdList = successEntities.ids;
                        this.entityTypeList = successEntities.types;
                        this._showCompletedTasks = true;
                        this._showMessage = !this._showCompletedTasks;
                        this._showInProgressTasks = !this._showCompletedTasks;
                        this._showErroredTasks = !this._showCompletedTasks;
                    } else {
                        this._message = this._defaultMessage;
                        this._showMessage = true;
                    }

                    //this.showChart = false;
                },

                _onErrorsClick: function (e) {
                    if (!DataHelper.isEmptyObject(this._taskDetails)) {
                        this.taskId = this._taskDetails.taskId;
                        this._showErroredTasks = true;
                        this._showMessage = !this._showErroredTasks;
                        this._showInProgressTasks = !this._showErroredTasks;
                        this._showCompletedTasks = !this._showErroredTasks;
                    } else {
                        this._message = this._defaultMessage;
                        this._showMessage = true;
                    }

                    // this.showChart = true;
                },

                _onApplicationConfigReceived: function (e) {
                    this.set('applicationConfig', e.detail);
                },

                _onContextChanged: function () {
                    var contextData = this.contextData;
                    this.contextData = {}; // To notify
                    this.contextData = contextData;
                },

                _onRefreshClick: function () {
                    this._loading = true;
                    this._initiateTaskDetailsGetRequest();
                },

                _reloadRockDiscovery: function () {
                    if (this.shadowRoot.querySelector("#entitySearchDiscoveryGrid")) {
                        this.shadowRoot.querySelector("#entitySearchDiscoveryGrid").refresh();
                    }
                },

                _onDimensionsChanged: function (e) {
                    var newDimensions = e.detail.dimensions;
                    ContextHelper.updateContextData(this.contextData, newDimensions);
                    this._onContextChanged();
                }
            });
        })();
    </script>
</dom-module>