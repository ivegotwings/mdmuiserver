<link rel="import" href="../../../bower_components/polymer/polymer.html" />

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html" />

<link rel="import" href="../rock-layout/rock-layout.html" />
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html" />
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html" />
<link rel="import" href="../rock-layout/rock-header/rock-header.html" />
<link rel="import" href="../rock-job-entity-detail-grid/rock-job-entity-detail-grid.html" />
<link rel="import" href="../rock-entity-search-discovery/rock-entity-search-discovery.html" />

<dom-module id="app-task-detail">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
             :host {
                --pebble-popover-max-width: 100%;
            }

            rock-header {
                padding: 10px 20px 10px 20px;
            }

            pebble-horizontal-divider {
                background-color: var(--palette-pale-grey-three, #e7ebf0);
            }

            .attributes-container {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                flex-wrap: wrap;
                -webkit-flex-wrap: wrap;
                /* Safari 6.1+ */
                @apply(--layout-horizontal);
                width: calc(70% - 90px);
                float: left;
            }

            .attribute {
                width: 33%;
                height: 20px;
                line-height: 20px;
            }

            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            #attrName {
                width: 282px;
                height: 20px;
                font-family: var(--default-font-family);
                font-size: var(--default-font-size, 14px);
                font-weight: normal;
                font-style: normal;
                font-stretch: normal;
                color: var(--attrpanel-color-text, #1a2028);
                opacity: 0.7;
            }

            #attrVal {
                font-size: var(--font-size-sm, 12px);
                font-weight: var(--font-medium, 500);
                color: var(--buttontext-color, #616161);
            }
        </style>
        <rock-layout>
            <!-- Todo: What is this used for -->
            <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" operation="getbyids" request-id="req1" app-name="app-task-detail"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <rock-titlebar icon="pebble-md-icons:Advancesearch" main-title="App Task Details" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="[[getConfig('rock-dimension-selector')]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <rock-header>
                <div class="fixed-content">
                    <div class="layout horizontal">
                        <div class="flex summary-container">
                            <pebble-accordion header-text="Summary & Filters" default-icon="chevron-right" open-icon="expand-more">
                                <div class="attributes-container">
                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">Brand :</span>
                                        <span id="attrVal"></span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">Product Title :</span>
                                        <span id="attrVal" title="newskuentity001">newskuentity001</span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">Color Desc :</span>
                                        <span id="attrVal"></span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">VPN :</span>
                                        <span id="attrVal"></span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">UPC :</span>
                                        <span id="attrVal" title="1234567891">1234567891</span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">Product Type :</span>
                                        <span id="attrVal" title="SPORTING GOODS + EQUIPMENT">SPORTING GOODS + EQUIPMENT</span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">Sub-Product Type :</span>
                                        <span id="attrVal" title="SOFTBALL">SOFTBALL</span>
                                    </div>

                                    <div id="attribute" class="attribute trim">
                                        <span id="attrName">Item Type :</span>
                                        <span id="attrVal" title="SOFTBALL HELMETS">SOFTBALL HELMETS</span>
                                    </div>
                                    <template id="headerAttributes" is="dom-repeat"></template>
                                </div>
                                <div class="charts-container">
                                    <pebble-button class="btn btn-primary m-r-5" button-text="In Progress" on-tap="_onInProgressClick"></pebble-button>
                                    <pebble-button class="btn btn-primary m-r-5" button-text="Completed" on-tap="_onCompletedClick"></pebble-button>
                                    <pebble-button class="btn btn-primary m-r-5" button-text="Errors" on-tap="_onErrorsClick"></pebble-button>
                                </div>
                            </pebble-accordion>
                        </div>
                    </div>
                </div>
                <div class="shrunk-content"></div>
            </rock-header>
            <div class="p-l-20 p-r-20">
                <pebble-horizontal-divider></pebble-horizontal-divider>
            </div>
            <!-- Main Container -->
            <div class="layout horizontal">
                <template is="dom-if" if="[[_showInProgressTasks]]">
                    <div class="p-l-20 p-r-20">In Progress Tasks</div>
                </template>
                <template is="dom-if" if="[[_showCompletedTasks]]">
                    <!--<div>Completed Tasks</div>-->
                    <div class="flex">
                        <rock-entity-search-discovery id="entitySearchDiscoveryGrid" context-data="[[contextData]]"></rock-entity-search-discovery>
                    </div>
                </template>
                <template is="dom-if" if="[[_showErroredTasks]]">
                    <!--<div>Errored Tasks</div>-->
                    <div class="flex">
                        <rock-job-entity-detail-grid id="job-entity-grid" task-id="[[taskId]]" context-data="[[contextData]]" grid-config="[[getConfig('rock-job-entity-detail-grid')]]">
                        </rock-job-entity-detail-grid>
                    </div>
                </template>
            </div>
        </rock-layout>
        <bedrock-pubsub event-name="app-context-changed" handler="_onAppContextChanged"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "app-task-detail",

                properties: {
                    _showInProgressTasks: {
                        type: Boolean,
                        value: true
                    },

                    _showCompletedTasks: {
                        type: Boolean,
                        value: false
                    },

                    _showErroredTasks: {
                        type: Boolean,
                        value: false
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior
                ],

                attached: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "ownershipData": this.ownershipData
                    };

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];

                    if (DataHelper.getParamValue('searchtext')) {
                        this.$$('#searchBar').query = this._searchQuery;
                    }
                    this._searchTimeStamp = new Date().toLocaleString();
                },

                getAppCurrentStatus: function () {
                    return {
                        title: "Search & Refine",
                        subTitle: "Last Searched",
                        subTitleValue: this._searchTimeStamp ? this._searchTimeStamp : new Date().toLocaleString(),
                        tooltipParams: ""
                    };
                },

                _onInProgressClick: function (e, detail) {
                    this._showInProgressTasks = true;
                    this._showCompletedTasks = false;
                    this._showErroredTasks = false;
                },

                _onCompletedClick: function (e, detail) {
                    this._showCompletedTasks = true;
                    this._showInProgressTasks = false;
                    this._showErroredTasks = false;
                },

                _onErrorsClick: function (e, detail) {
                    this._showErroredTasks = true;
                    this._showInProgressTasks = false;
                    this._showCompletedTasks = false;

                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };
                    this.taskId = "19e1ae03-df16-4e7e-ab48-3900572f6ca0"; // DataHelper.getParamValue('id')
                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
                    this.contextData[this.CONTEXT_TYPE_VALUE] = [{
                        "source": "internal",
                        "locale": "en-US"
                    }];
                },

                _onApplicationConfigReceived: function (e) {
                    this.set('applicationConfig', e.detail);
                },

                _onAppContextChanged: function (e) {
                    this.logInfo("AppContextChanged", "contextData", JSON.stringify(e.detail.contextData));

                    this.contextData = {}; // To notify
                    this.contextData = e.detail.contextData;

                    // this.$$("#entitySearchDiscoveryGrid").refresh();
                }
            });
        })();
    </script>
</dom-module>