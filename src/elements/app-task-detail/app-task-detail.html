<link rel="import" href="../../../bower_components/polymer/polymer.html" />

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html" />
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html" />

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html" />
<link rel="import" href="../pebble-accordion/pebble-accordion.html" />
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html" />

<link rel="import" href="../rock-layout/rock-layout.html" />
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html" />
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html" />
<link rel="import" href="../rock-layout/rock-header/rock-header.html" />
<link rel="import" href="../rock-task-summary/rock-task-summary.html" />
<link rel="import" href="../rock-task-error-grid/rock-task-error-grid.html" />
<link rel="import" href="../rock-entity-search-discovery/rock-entity-search-discovery.html" />

<dom-module id="app-task-detail">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
            .summary-container {
                padding: 10px 20px 10px 20px;
            }

            pebble-horizontal-divider {
                background-color: var(--palette-pale-grey-three, #e7ebf0);
            }
        </style>
        <rock-layout>
            <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" operation="getbyids" request-id="req1" app-name="app-task-detail"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <liquid-rest id="taskDetailsGet" url="/data/eventservice/getTaskDetails" method="POST" request-data={{_taskDetailSummaryGetRequest}}
                on-liquid-response="_onTaskDetailSummaryGetResponse" on-liquid-error="_onTaskDetailSummaryGetError"></liquid-rest>
            <rock-titlebar icon="pebble-md-icons:Advancesearch" main-title="App Task Details" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="[[getConfig('rock-dimension-selector')]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <div class="flex">
                <div class="summary-container">
                    <pebble-accordion header-text="Summary & Filters" default-icon="chevron-right" open-icon="expand-more">
                        <rock-task-summary id="rockTaskSummary" task-details="[[_taskDetails]]" show-chart="[[showChart]]"></rock-task-summary>
                    </pebble-accordion>
                </div>
                <div class="p-l-20 p-r-20">
                    <pebble-horizontal-divider></pebble-horizontal-divider>
                </div>
                <template is="dom-if" if="[[_showInProgressTasks]]">
                    <!--<div class="p-l-20 p-r-20">Content Development in Progress</div>-->
                </template>
                <template is="dom-if" if="[[_isConfigLoaded(_showCompletedTasks, applicationConfig)]]">
                    <div class="flex">
                        <rock-entity-search-discovery id="entitySearchDiscoveryGrid" context-data="[[contextData]]" entity-id-list="[[entityIdList]]"
                            entity-type-list="[[entityTypeList]]"></rock-entity-search-discovery>
                    </div>
                </template>
                <template is="dom-if" if="[[_isConfigLoaded(_showErroredTasks, applicationConfig)]]">
                    <div class="flex">
                        <rock-task-error-grid id="jobEntityDetailGrid" task-id="[[taskId]]" context-data="[[contextData]]" grid-config="[[getConfig('rock-task-error-grid')]]">
                        </rock-task-error-grid>
                    </div>
                </template>
                <template is="dom-if" if="[[_showDefaultMessage]]">
                    <div class="flex">
                        <div class="col-7 text-right">No details available for the current task</div>
                    </div>
                </template>
            </div>
        </rock-layout>
        <bedrock-pubsub event-name="app-context-changed" handler="_onAppContextChanged"></bedrock-pubsub>
        <bedrock-pubsub event-name="show-inprogress" handler="_onInProgressClick" target-id="rockTaskSummary"></bedrock-pubsub>
        <bedrock-pubsub event-name="show-completed" handler="_onCompletedClick" target-id="rockTaskSummary"></bedrock-pubsub>
        <bedrock-pubsub event-name="show-errors" handler="_onErrorsClick" target-id="rockTaskSummary"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "app-task-detail",

                properties: {
                    taskId: {
                        type: String,
                        value: ""
                    },
                    _taskDetails: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _showInProgressTasks: {
                        type: Boolean,
                        value: false
                    },

                    _showCompletedTasks: {
                        type: Boolean,
                        value: false
                    },

                    _showErroredTasks: {
                        type: Boolean,
                        value: false
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior
                ],

                ready: function () {
                    this.taskId = DataHelper.getParamValue("id");
                    this._taskDetailSummaryGetRequest = {
                        "taskId": this.taskId
                    }
                },

                attached: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "ownershipData": this.ownershipData
                    };

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];

                    var taskDetailsGet = this.$$("#taskDetailsGet");
                    if (taskDetailsGet) {
                        taskDetailsGet.generateRequest();
                    }
                },

                _isConfigLoaded: function() {
                    if(!DataHelper.isEmptyObject(this.applicationConfig)) {
                        if(this._showCompletedTasks || this._showErroredTasks) {
                            return true;
                        }
                    }
                },

                _onTaskDetailSummaryGetResponse: function (e, detail) {
                    this._taskDetails = detail.response;

                    //var taskStatus = this._taskDetails.taskStatus.toLowerCase();
                    //if(taskStatus == "processing" || taskStatus == "completed with errors") {
                        this.showChart = true;
                    //}

                    if (this._taskDetails) {
                        if (this._taskDetails.successEntities && this._taskDetails.successEntities.ids &&
                            this._taskDetails.successEntities.ids.length > 0) {
                            this.entityIdList = this._taskDetails.successEntities.ids;
                            this.entityTypeList = this._taskDetails.successEntities.types;
                            this._showCompletedTasks = true;
                        }
                        else if (this._taskDetails.taskStatus.toLowerCase() == "errored") {
                            this._showErroredTasks = true;
                        }
                        else {
                            this._showDefaultMessage = true;
                        }
                    }
                },

                _onTaskDetailSummaryGetError: function (e, detail) {
                    // Show Error Toast
                },

                _onInProgressClick: function (e) {
                    this.showChart = true;
                },

                _onCompletedClick: function (e) {
                    var successEntities = this._taskDetails.successEntities;

                    if (!DataHelper.isEmptyObject(successEntities)) {
                        this.entityIdList = successEntities.ids;
                        this.entityTypeList = successEntities.types;
                        this._showCompletedTasks = true;
                        this._showDefaultMessage = !this._showCompletedTasks;
                        this._showInProgressTasks = !this._showCompletedTasks;
                        this._showErroredTasks = !this._showCompletedTasks;
                    } else {
                        this._showDefaultMessage = true;
                    }

                    //this.showChart = false;
                },

                _onErrorsClick: function (e) {
                    if (!DataHelper.isEmptyObject(this._taskDetails)) {
                        this.taskId = this._taskDetails.taskId;
                        this._showErroredTasks = true;
                        this._showDefaultMessage = !this._showErroredTasks;
                        this._showInProgressTasks = !this._showErroredTasks;
                        this._showCompletedTasks = !this._showErroredTasks;
                    } else {
                        this._showDefaultMessage = true;
                    }

                    this.showChart = true;
                },

                _onApplicationConfigReceived: function (e) {
                    this.set('applicationConfig', e.detail);
                },

                _onAppContextChanged: function (e) {
                    this.logInfo("AppContextChanged", "contextData", JSON.stringify(e.detail.contextData));

                    this.contextData = {}; // To notify
                    this.contextData = e.detail.contextData;

                    if (this.$$("#entitySearchDiscoveryGrid")) {
                        this.$$("#entitySearchDiscoveryGrid").refresh();
                    }
                }
            });
        })();
    </script>
</dom-module>
