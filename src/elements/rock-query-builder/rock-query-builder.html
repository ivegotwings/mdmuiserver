<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-query-builder-behavior/bedrock-query-builder-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-textbox-collection/pebble-textbox-collection.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../rock-entity-type-model-lov/rock-entity-type-model-lov.html">
<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">

<dom-module id="rock-query-builder">
  <template>
    <style include="bedrock-style-common">
        .queryHeading {
            border-bottom: 1px solid var(--default-border-color, #c1cad4);
            padding: 10px 0;
            line-height: 0;            
            position: relative;
        }
        .queryHeadingButton {
            height: 18px;
            line-height: 15px;
            font-weight: 500;
            --pebble-button: {
                min-width: auto;
                padding-top: 0;
                padding-right: 0;
                padding-bottom: 0;
                padding-left: 0;
            }
        }
        .relationshipGridContainer {
            border-radius: 3px;
            width: 95%;
            margin: 10px auto 0 auto;
            box-shadow: 0 0 var(--popup-box-shadow-size,8px) 0 var(--popup-box-shadow,#8A98A3);
        }
        .actionButtons {
            text-align: center;
            padding-top : 15px;
        }
        #attributesSearchGrid {
            --rock-grid-height: 60px;
        }
        .dropdown-icon {
            --pebble-icon-height: 10px !important;
            --pebble-icon-width: 10px !important;
        }
        pebble-data-table data-table-row[header] {
           display: none;
        } 
        pebble-data-table data-table-row:not([header]) {
            color: var(--palette-dark, #1a2028);
            font-size: var(--default-font-size, 12px);
            height: 100%;
            background-color: var(--palette-white, #ffffff);
        }        
        pebble-data-table data-table-row:not([header]):hover,
        pebble-data-table data-table-row[selected] {
            background-color: var(--table-row-selected-color, #c1cad4) !important;
        }        
        pebble-data-table data-table-row:not([header]):hover data-table-checkbox,
        pebble-data-table data-table-row[selected] data-table-checkbox {
            background-color: var(--palette-white, #ffffff) !important;
        }
        pebble-data-table {
            max-height: 100px;
            --pebble-data-table-header : {
                 display: none;
            }           
        }

        #workflow-grid {
            max-height: 35px;
        }     
        data-table-cell {
            height: 35px;
            padding-left: 20px;
            padding-right: 0;
            position: relative;
            flex-basis: auto!important;
        }
        data-table-cell #iconDiv {
            position: absolute;
            right: 6px;
            bottom: 5px;
        }
        data-table-cell #inputDiv {
            width: 100%;
        }
        pebble-textbox {
            --paper-input-container: {
                padding-top: 0px;
                padding-right: 0px;
                padding-bottom: 0px;
                padding-left: 0px;
                position: relative;
            }
        }        
        #inputDiv  pebble-textbox {
            --pebble-textbox-paper-input-style : {  
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;                  
                width: 90%;
            }
        }               
        pebble-textarea {
            --autogrowtextarea:{
                min-height: 30px !important;
            }
            --pebble-textarea:{
                width: 260px;               
            }
        }
        .dialogOptions paper-radio-button {
            display: block;
        }
        paper-radio-group paper-radio-button{
            --paper-radio-button-unchecked-color: var(--radio-button-border, #026bc3);
            --paper-radio-button-checked-color: var(--radio-button-selected, #026bc3);
        }
        .input-content::slotted(input), .input-content::slotted(textarea), .input-content::slotted(iron-autogrow-textarea),
        .input-content::slotted(.paper-input-input) {
            font-size: var(--default-font-size, 14px);
        }
        
        pebble-textbox-collection {
            --tags-container: {
                min-height: 0px;
                margin-right: 0px;
            }
            --text-collection-container: {
                min-height: 0px;
                margin-top: 0px;
            }
        }

        #entityTypeFilterButton {
            --paper-button-text: {
                max-width: 74px;
            }  
        }
        #filterPopover{
            padding-right:10px;
            padding-left:10px;
        }
        .queryHeadingReset {
            position: absolute;
            right: 0px;
            bottom: 11px;
        }
        .queryHeadingReset pebble-button {
            height: 18px;
            --pebble-button: {
                padding-top: 0;
                padding-right: 0;
                padding-bottom: 0;
                padding-left: 0;
                height: 18px;
            }
        }
    </style>   
    
    <!-- Entity Type search -->       
    <div>
        <pebble-button id="entityTypeFilterButton" icon="pebble-sm-icons:Filter-wt" button-text="{{selectedEntityTypeNames}}" title="{{selectedEntityTypeNames}}" dropdown-icon="" noink="" class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger" is-ruf-component="" target-id="productSearchPopover" on-tap="_openLov"></pebble-button>
        <pebble-popover id="productSearchPopover" for="entityTypeFilterButton" vertical-align="auto" horizontal-align="auto">
            <rock-entity-type-model-lov id="entityTypeLov" domain="[[domain]]" select-all="true" allowed-entity-types="{{allowedEntityTypes}}" selected-items="{{selectedEntityTypes}}"></rock-entity-type-model-lov>    
            <div class="PebbleButtonPadding text-center m-t-10">
              <pebble-button class="btn btn-secondary m-r-5" target-id="productSearchPopover" on-tap="_closeLov" raised elevation="1" button-text="Close"></pebble-button>
              <pebble-button class="btn btn-success" button-text="Apply" raised elevation="1" on-tap="_onSelectedEntityTypesChange" target-id="entityTypeLov"></pebble-button>
            </div>
        </pebble-popover>
    </div>

    <template is="dom-if" if="{{_enableAttributeList}}">
            <!-- Attributes search - supports multiple attributes -->
            <div class="queryHeading">
                <pebble-button icon="pebble-md-icons:addcircle" class="queryHeadingButton" target-id="attribute-grid" on-tap="_onAddRowClick" button-text="WITH"></pebble-button>                   
            </div>            
            <div class="attributeGridContainer">
                <pebble-data-table id="attribute-grid" items="{{attributeGridData}}">
                        <data-table-column slot="column-slot" flex="0" class="first">
                            <template>
                                <pebble-icon slot="cell-slot-content" icon="pebble-md-icons:Delete" target-id="attribute-grid" class="pebble-md-icons" on-tap="_onDeleteRowClick"></pebble-icon>                        
                            </template>
                        </data-table-column>
                        <data-table-column slot="column-slot">
                            <template>
                                <div id="inputDiv" slot="cell-slot-content" on-tap="" index="[[index]]">
                                    <pebble-textbox readonly id="attributes-text_[[index]]" row-id="[[index]]" value="{{item.name}}" no-label-float="true"></pebble-textbox>
                                </div>
                                <div id="iconDiv" slot="cell-slot-content">
                                    <pebble-icon class="dropdown-icon" id="txtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-xs-icons:ExpandMore" on-tap="_openAttributeModelLov"></pebble-icon>
                                </div>                         
                            </template>                        
                        </data-table-column>
                        <data-table-column slot="column-slot">
                            <template>
                                <div id="inputDiv" slot="cell-slot-content" on-tap="" index="[[index]]">
                                    <pebble-textbox readonly id="attributes-value_[[index]]" row-id="[[index]]" value="{{item.value}}" no-label-float="true"></pebble-textbox>
                                </div>
                                <div id="iconDiv" slot="cell-slot-content">
                                    <pebble-icon class="dropdown-icon" id="txtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-xs-icons:ExpandMore" on-tap="_onOpenFilterPopover"></pebble-icon>
                                </div>                         
                            </template>  
                        </data-table-column>
                </pebble-data-table>
                <bedrock-pubsub event-name="attribute-model-lov-selection-changed" handler="_onAttributeSelection" target-id="attributeModelLov"></bedrock-pubsub>
                <pebble-popover id="attributesPopover" for="" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
                    <rock-attribute-model-lov id="attributeModelLov" mode="mapped" context-data="{{_contextData}}" no-sub-title id-field="name" title-pattern="externalName"
                    type-field="[]" sort-details="[[filtersConfig]]"></rock-attribute-model-lov>
                </pebble-popover>
        </template>

                <!-- Filter popover starts here -->         
                <pebble-popover id="filterPopover" for="" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
                    <template is="dom-if" if="{{_showTagModifier('textbox',currentFilterObj.displayType)}}">
                        <pebble-textbox-collection id="textCollection" values="{{txtBoxCollection}}" no-popover textbox-label="Enter more values here to search" show-seperator seperator="or"></pebble-textbox-collection>
                        <div class="PebbleButtonPadding text-center m-t-15">
                        <pebble-button class="btn btn-secondary m-r-5" target-id="filterPopover" on-tap="_closeLov" raised elevation="1" button-text="Close"></pebble-button>
                        <pebble-button class="btn btn-success" button-text="Apply" raised elevation="1" on-tap="_onUpdateValue"></pebble-button> 
                        <div class="clearfix"></div>
                        </div>
                    </template>
                    <template is="dom-if" if="{{_showTagModifier('textarea',currentFilterObj.displayType)}}">
                        <pebble-textarea class="input" label="Enter text here" value="{{txtAreaInput}}"></pebble-textarea>
                        <div class="PebbleButtonPadding text-center m-t-15">
                        <pebble-button class="btn btn-secondary m-r-5" target-id="filterPopover" on-tap="_closeLov" raised elevation="1" button-text="Close"></pebble-button>
                        <pebble-button class="btn btn-success" button-text="Apply" raised elevation="1" on-tap="_onUpdateValue"></pebble-button> 
                        <div class="clearfix"></div>
                        </div> 
                    </template>
                    <template is="dom-if" if="{{_showTagModifier('richtexteditor',currentFilterObj.displayType)}}">
                        <pebble-textarea class="input" label="Enter text here" value="{{txtAreaInput}}"></pebble-textarea>
                        <div class="PebbleButtonPadding text-center m-t-15">
                        <pebble-button class="btn btn-secondary m-r-5" target-id="filterPopover" on-tap="_closeLov" raised elevation="1" button-text="Close"></pebble-button>
                        <pebble-button class="btn btn-success" button-text="Apply" raised elevation="1" on-tap="_onUpdateValue"></pebble-button> 
                        <div class="clearfix"></div>
                        </div>
                    </template>
                    <template is="dom-if" if="{{_showTagModifier('referencelist',currentFilterObj.displayType)}}">
                        <rock-entity-lov id="rockEntityLov" multi-select show-action-buttons selected-items="{{_selectedItems}}"></rock-entity-lov>
                    </template>
                    <template is="dom-if" if="{{_showTagModifier('boolean',currentFilterObj.displayType)}}">
                        <pebble-boolean class="text-center" id="booleanDisplay" value="{{booleanvalue}}" required></pebble-boolean>
                        <div class="PebbleButtonPadding text-center m-t-15">
                        <pebble-button class="btn btn-secondary m-r-5" target-id="filterPopover" on-tap="_closeLov" raised elevation="1" button-text="Close"></pebble-button>
                        <pebble-button class="btn btn-success" button-text="Apply" raised elevation="1" on-tap="_onUpdateValue"></pebble-button>
                        </div> 
                    </template>
                    <template is="dom-if" if="{{_showTagModifier('numeric',currentFilterObj.displayType)}}">
                    <paper-radio-group aria-labelledby="{{longName}}" class="dialogOptions" on-paper-radio-group-changed="_onRadioGroupChange">
                    <paper-radio-button name="range">
                        <div class="colspan-2 pull-left">
                        <pebble-textbox label="Min" prevent-invalid-input allowed-pattern="[0-9.]" invalid="{{numericMinInvalid}}" show-error input-data-type="[[currentFilterObj.dataType]]"
                            value="{{gte}}">
                        </pebble-textbox>
                        </div>
                        <div class="colspan-2 pull-left">
                        <pebble-textbox label="Max" prevent-invalid-input allowed-pattern="[0-9.]" invalid="{{numericMaxInvalid}}" show-error input-data-type="[[currentFilterObj.dataType]]"
                            value="{{lte}}">
                        </pebble-textbox>
                        </div>
                        <div class="clearfix"></div>
                    </paper-radio-button>
                    <paper-radio-button name="equalToData">
                        <div class="col-90 pull-left">
                        <pebble-textbox-collection id="textNumericCollection" values="{{_tagsNumericCollection}}" no-popover textbox-label="Enter more values here to search" show-seperator seperator="or" allowed-pattern="[0-9.]"></pebble-textbox-collection>
                        </div>
                        <div class="clearfix"></div>
                    </paper-radio-button>
                    </paper-radio-group>
                    <div class="PebbleButtonPadding text-center">
                    <pebble-button class="btn btn-secondary m-r-5" target-id="filterPopover" on-tap="_closeLov" raised elevation="1" button-text="Close"></pebble-button>
                    <pebble-button class="btn btn-success" button-text="Apply" raised elevation="1" on-tap="_onUpdateValue" disabled="{{_updateDisable}}"></pebble-button>
                    </div>
                </template>
                </pebble-popover>
                <bedrock-pubsub event-name="on-popover-close" handler="_onFilterPopoverClose" target-id="filterPopover"></bedrock-pubsub>
                <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLOVConfirmTap" target-id="rockEntityLov"></bedrock-pubsub>
                <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLOVCloseTap" target-id="rockEntityLov"></bedrock-pubsub>
            
                <!-- Already overlay, so out of popover -->
                <pebble-datetime-picker-overlay id="rangepicker" for="" picker-type="daterange" show-ranges heading-format="ddd, MMM DD YYYY"
                start-date-text="{{displaygte}}" end-date-text="{{displaylte}}" start-date-value="{{gte}}" end-date-value="{{lte}}"
                on-date-range-selected="_onUpdateValue">
                </pebble-datetime-picker-overlay>
                <!-- Filter popover ends here -->        
            </div>

    <!-- Relationship search
        - Relationship attributes
        - Relationships (nested)
        - WF search within relationships -->
    <div class="queryHeading">
        <pebble-button class="queryHeadingButton m-b-5" on-tap="" button-text="HAVING"></pebble-button> <br/>
        <pebble-button id="relationshipButton" button-text="{{selectedRelationshipName}}" title="{{selectedRelationshipName}}" dropdown-icon="" noink="" class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger" is-ruf-component="" target-id="relationshipPopover" on-tap="_openRelationshipModelLov"></pebble-button>
        
        <liquid-entity-model-composite-get id="liquidModelGet" request-data={{relationshipRequest}} on-entity-model-composite-get-response="_onModelReceived"
            on-error="_onModelGetFailed" exclude-in-progress>
        </liquid-entity-model-composite-get>        
        <pebble-popover id="relationshipPopover" for="relationshipButton" vertical-align="auto" horizontal-align="auto">
            <pebble-lov id="relationshipModelLov" on-selection-changed="_onRelationshipLovSelectionChanged" selected-item="{{selectedRelationship}}"></pebble-lov>    
        </pebble-popover>
        <div class="queryHeadingReset">
            <pebble-button class="btn-link" on-tap="_onResetRelationship" button-text="Reset"></pebble-button>                   
        </div>    
    </div>

    <div class="relationshipGridContainer">
        <div class="queryHeading">
            <pebble-button icon="pebble-md-icons:addcircle" class="queryHeadingButton m-l-10" target-id="relationship-grid" on-tap="_onAddRowClick" button-text="WITH"></pebble-button> 
            <div class="queryHeadingReset m-r-10">
                <pebble-button class="btn-link" on-tap="_onResetRelationshipGrid" button-text="Reset"></pebble-button>                   
            </div>                   
        </div>
        <div class="p-10">
        <pebble-data-table id="relationship-grid" items="{{relationshipGridData}}">
                <data-table-column slot="column-slot" flex="0">
                    <template>
                        <pebble-icon slot="cell-slot-content" icon="pebble-md-icons:Delete" target-id="relationship-grid" class="pebble-md-icons" on-tap="_onDeleteRowClick"></pebble-icon>                        
                    </template>
                </data-table-column>
                <data-table-column slot="column-slot">
                    <template>
                        <div id="inputDiv" slot="cell-slot-content" on-tap="" index="[[index]]">
                            <pebble-textbox readonly id="relationship-text_[[index]]" row-id="[[index]]" value="{{item.name}}" no-label-float="true"></pebble-textbox>
                        </div>
                        <div id="iconDiv" slot="cell-slot-content">
                            <pebble-icon class="dropdown-icon" id="rtxtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-xs-icons:ExpandMore" on-tap="_openRelationshipAttributeModelLov"></pebble-icon>
                        </div>                         
                    </template>                        
                </data-table-column>
                 <data-table-column slot="column-slot">
                    <template>
                       <div id="inputDiv" slot="cell-slot-content" on-tap="" index="[[index]]">
                            <pebble-textbox readonly id="relationship-value_[[index]]" row-id="[[index]]" value="{{item.value}}" no-label-float="true"></pebble-textbox>
                        </div>
                        <div id="iconDiv" slot="cell-slot-content">
                            <pebble-icon class="dropdown-icon" id="rtxtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-xs-icons:ExpandMore" on-tap="_onOpenFilterPopover"></pebble-icon>
                        </div>                                                
                    </template>  
                </data-table-column>
        </pebble-data-table>
        </div>
        <pebble-popover id="relAttributesPopover" for="" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
            <pebble-lov id="relAttributeModelLov" on-selection-changed="_onRelAttributeLovSelectionChanged"></pebble-lov>
        </pebble-popover>       
    </div>


        <!--div class="queryHeading">
            <pebble-button icon="pebble-md-icons:addcircle" class="queryHeadingButton" on-tap="_addSearchAttributes" button-text="HAVING"></pebble-button>                   
        </div>

        <div class="queryHeading">
            <pebble-button icon="pebble-md-icons:addcircle" class="queryHeadingButton" on-tap="_addSearchAttributes" button-text="IN"></pebble-button>                   
        </div>

        <div class="queryHeading">
            <pebble-button icon="pebble-md-icons:addcircle" class="queryHeadingButton" on-tap="_addSearchAttributes" button-text="PENDING"></pebble-button>                   
        </div>
    

    <!-- WF search -->
    <!--<template is="dom-if" if="[[_isWorkflowSearchEnabled(workflowName)]]">-->
        <div class="workflowGridContainer">
            <div class="queryHeading">
                <pebble-button class="queryHeadingButton" target-id="workflow-grid" button-text="PENDING"></pebble-button>
                <div class="queryHeadingReset">
                    <pebble-button class="btn-link" on-tap="_onResetWorkflowGrid" button-text="Reset"></pebble-button>                   
                </div>
            </div>
            <div class="p-10">
                <pebble-data-table id="workflow-grid" items="{{workflowGridData}}">                   
                    <data-table-column slot="column-slot">
                        <template>
                            <div id="inputDiv" slot="cell-slot-content" on-tap="" index="[[index]]">
                                <pebble-textbox readonly id="workflow-text_[[index]]" row-id="[[index]]" value="{{item.name}}" no-label-float="true"></pebble-textbox>
                            </div>
                            <div id="iconDiv" slot="cell-slot-content">
                                <pebble-icon class="dropdown-icon" id="wtxtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-xs-icons:ExpandMore" on-tap="_openWorkflowModelLov"></pebble-icon>
                            </div>
                        </template>
                    </data-table-column>
                    <data-table-column slot="column-slot">
                        <template>
                            <div id="inputDiv" slot="cell-slot-content" on-tap="" index="[[index]]">
                                <pebble-textbox readonly id="workflow-value_[[index]]" row-id="[[index]]" value="{{item.value}}" no-label-float="true"></pebble-textbox>
                            </div>
                            <div id="iconDiv" slot="cell-slot-content">
                                <pebble-icon class="dropdown-icon" id="wtxtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-xs-icons:ExpandMore" on-tap="_openWorkflowActivityLov"></pebble-icon>
                            </div>
                        </template>
                    </data-table-column>
                </pebble-data-table>
            </div>
            <pebble-popover id="workflowPopover" for="" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
                <pebble-lov id="workflowModelLov" on-selection-changed="_onWorkflowLovSelectionChanged"></pebble-lov>
            </pebble-popover>
            <pebble-popover id="workflowActivityPopover" for="" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
                <pebble-lov id="workflowActivityLov" on-selection-changed="_onWorkflowActivityLovSelectionChanged"></pebble-lov>
            </pebble-popover>
        </div>
    <!--</template>-->
    <liquid-entity-model-get id="getWorkflowMappingDefinition" operation="getbyids" request-id="req1" request-data={{workflowMappingDefinitionRequest}}
                on-response="_onWfMappingsReceived" on-error="_onMappingsGetFailed"></liquid-entity-model-get>
    <liquid-entity-model-get id="entityGetWorkflowDefinition" operation="getbyids" request-id="req1" request-data={{workflowDefinitionRequest}}
                on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
    
    <div class="actionButtons">
        <pebble-button id="cancelButton" class="close btn btn-secondary m-r-5" button-text="Cancel" noink elevation="2" on-tap="_onClose"></pebble-button>
        <pebble-button id="confirmButton" class="apply btn btn-success" button-text="Apply" noink elevation="2" on-tap="_onApply"></pebble-button>
    </div>
           
    
  </template>
  <script>
      
    class RockQueryBuilder extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior,RUFBehaviors.AppContextBehavior,RUFBehaviors.QueryBuilderBehavior, RUFBehaviors.ComponentContextBehavior], Polymer.Element) {

        static get is() { return 'rock-query-builder' }

        ready() {
            super.ready();  
            
            this._close = this._close.bind(this);
        }
    
        static get properties() {
            return {
            inputQueryString:{
                type: String,
                value: ""
                //observer: "_onQueryStringChange"
            },
            allowedEntityTypes: {
                type: Array,
                value: function () {
                    return [];
                }
            },                   
            selectedEntityTypes: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            selectedRelationship:{
                type: String,
                value: ""
            },
            selectedRelationshipName:{
                type: String,
                computed: "getSelectedRelationship(selectedRelationship)"
            },
            _showAttributeSearchGrid: {
                type: Boolean,
                value: false
            },
			domains: {
				type: Array,
				value: function () { return []; }
			},
            _contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
			contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },          
            attributeGridData: {
                type: Array,
                value: function () {
                    return [
                        {
                            "name": "",
                            "value": ""    
                        }
                                               
                    ];
                }
            },     
            relationshipGridData: {
                type: Array,
                value: function () {
                    return [
                        {
                            "name": "",
                            "value": ""    
                        }                           
                    ];
                }
            },
            workflowGridData:{
                type: Array,
                value: function () {
                    return [
                        {
                            "name": "",
                            "value": ""    
                        }    
                    ];
                } 
            },
            workflowEntityTypes:{
                 type: Array,
                 value: {}
            },
            currentFilterObj: {
                type: Object,
                notify: true                
            },

            txtBoxCollection: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            txtAreaInput:{
                type: String,
                value: ""
            },
            booleanvalue:{
                type: Boolean                
            },
            gte: {
                type: String,
                value: function () {
                    return "";
                },
                observer: '_isMaxGreaterThanMin'
            },
            /**
             * <b><i>Content development is under progress... </b></i> 
             */
            lte: {
                type: String,
                value: function () {
                    return "";
                },
                observer: '_isMaxGreaterThanMin'
            },
            /**
             * <b><i>Content development is under progress... </b></i> 
             */
            equalNum: {
                type: String,
                value: function () {
                    return "";
                }
            },
            /**
             * <b><i>Content development is under progress... </b></i> 
             */
            numericMinInvalid: {
                type: Boolean,
                value: false
            },
            /**
             * <b><i>Content development is under progress... </b></i> 
             */
            numericMaxInvalid: {
                type: Boolean,
                value: false
            },
            /**
             * <b><i>Content development is under progress... </b></i> 
             */
            numericEqualInvalid: {
                type: Boolean,
                value: false
            },

            _updateDisable: {
                type: Boolean,
                computed: '_disableUpdate(numericMinInvalid, numericMaxInvalid, _tagsNumericCollection, _tagNumericInput, gte, lte)'
            },
            _tagsNumericCollection: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            _selectedItems: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            relationshipRequest: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            domain:{
                type:String
            }, 
            _enableAttributeList:{
                type: Boolean,
                value: false
            },
            workflowMappingDefinitionRequest: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            workflowDefinitionRequest: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            _mappedWorkflowNames: {
                type: Array,
                value: function () { return []; }
            },
            workflowName: {
                type: String,
                value: ""
            },
            selectedEntityTypeNames:{
               type: String,
               computed: "getSelectedEntityTypeNames(selectedEntityTypes)"             
            },
            searchQuery: {
                type: String,
                value: ""
            },
            _workflowData: {
                type: Object,
                value: function() { return {}; }
            },
            relationshipsData: {
                type: Object,
                value: function() { return {}; }
            },
            workflowCriterion: {
                type: Object,
                value: function () { return {}; }
            }
            }
        }      
         
        /**
         *  Add Listener to close the query builder when clicked elsewhere
        */
        connectedCallback() {
            super.connectedCallback();
            document.addEventListener('down', this._close, true);
            //add methods to get workflow mappings, relationships, rulecontext mappings when selected entity types available
            if(!_.isEmpty(this.selectedEntityTypes) && !_.isEmpty(this.contextData)) {
                //get relationshipmodels for selected entity types
                this._getRelationshipModels();
                //get mapped workflows data for the selected entity types
                this._getWorkflowMappings();
            }
        }

        /**
         *  Remove Listener to close the query builder
        */
        disconnectedCallback() {
            super.disconnectedCallback();
            document.removeEventListener('down',this._close, true);
        }

        /**
         *  Open lov whose target-id is defined
        */
        _openLov(e) {
            var targetId = e.target.getAttribute("target-id");
            this.shadowRoot.querySelector("#"+targetId).open();
        }
        
        /**
         *  Close lov whose target-id is defined
        */
        _closeLov(e) {
            var targetId = e.target.getAttribute("target-id");
            this.shadowRoot.querySelector("#"+targetId).hide();
        }
        
        /**
         *  Close query builder
        */
        _onClose() {
            this.fireBedrockEvent('hide-query-builder');
        }
        
        /**
         *  Close query builder if the user is not using on the query builder
        */
        _close() {
            var queryBuilderFound = false;
            for(var key=0; key<event.path.length; key++){
                if(event.path[key].tagName){
                    if(event.path[key].tagName.toUpperCase() == "ROCK-QUERY-BUILDER"){
                    queryBuilderFound = true;
                    break;
                    }
                }
            }
            if(!queryBuilderFound){
                this._onClose();  
            }
        }

         /**
         * Re-initialise the query builder components when the query builder is opened
        */ 
        onOpenQueryBuilder() {
            if(this.reset == true) {
                this._onResetRelationship();
                this._onResetWorkflowGrid();  
                this.reset = false;
            }             
        }

        /**
        * Function to reset the query builder
        */ 
        resetQueryBuilder(){
            this.reset = true;
            this.attributeGridData = [];
            this._onResetRelationship();
            this._onResetWorkflowGrid(); 
        }       

        /**
         * Function to reset the relationship drop-down
         */ 
        _onResetRelationship(){
            this.selectedRelationship = [];
            this._onResetRelationshipGrid();
        }

        /**
         * Function to reset the relationship attributes
         */ 
        _onResetRelationshipGrid(){
            this.relationshipGridData = [];
            this._selectedItems = [];
            this.currentFilterObj = "";
            this.relationshipGridData = [{"name": "","value": ""}];             
        }

        /**
         * Function to reset the workflow attributes
         */ 
        _onResetWorkflowGrid(){
            this.workflowGridData = [];
            this.workflowEntityTypes = [];
            this.workflowGridData = [{"name": "","value": ""}]; 
        }

        /**
         * Function to get the query builder data to form the query
         */
        getQueryBuilderData(){            
            var queryBuilderData = {};

            var relModelLov = this.shadowRoot.querySelector('#relationshipModelLov');
            if(relModelLov.selectedItem) {
                queryBuilderData.relationship = relModelLov.selectedItem.title;
                queryBuilderData.relationshipShortName = relModelLov.selectedItem.id;
            }
            if(this.relationshipGridData) {
                queryBuilderData.relationshipGridData = this.relationshipGridData;
            }
            if(this.workflowGridData) {
                queryBuilderData.workflowGridData = this.workflowGridData;
            } 
            
            return queryBuilderData;
        }

        _getRelationshipModels() {
            var clonedContextData = DataHelper.cloneObject(this.contextData);
            var entityTypes =  this.getSelectedEntityTypes(this.selectedEntityTypes);  
            this._currentIndex = entityTypes.length;
            this._currentItems = [];
            for(let i=0; i<entityTypes.length; i++) {
                var type = entityTypes[i];
                var itemContexts = [];
                var itemContext = {};
                itemContext.type = type;
                itemContext.relationships = ["_ALL"];
                itemContext.relationshipAttributes = ["status", "isprimary", "order", "swatchimage", "hascolorized", "issiblingswatch", "imagetype", "linkdescription", "enabled", "componentskuquantity"];

                itemContexts.push(itemContext);
                clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;

                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(clonedContextData);

                this.set("relationshipRequest", compositeModelGetRequest);

                var liquidGet = this.shadowRoot.querySelector("#liquidModelGet");
                if (liquidGet) {
                    liquidGet.generateRequest();
                }
            }
        }

        /**
         *  On liquidModelGet success
         */
        _onModelReceived(e){
            var response = e.detail.response;
            var relationshipModels = DataTransformHelper.transformRelationshipModels(response.content.entityModels[0], this.contextData);
            var entityType = response.content.entityModels[0].name;

            if (this._currentIndex == 1) {
                this._currentItems = {};
            }
            this._currentItems[entityType] = relationshipModels;
            var keys = Object.keys(this._currentItems);
            if (keys && keys.length == this._currentIndex) {
                var relationships = {};
                for (let i = 0; i < keys.length; i++) {
                    var currentItem = this._currentItems[keys[i]];
                    var relTypes = Object.keys(currentItem);
                    if (relTypes && relTypes.length > 0) {
                        var rels = [];
                        for (let j = 0; j < relTypes.length; j++) {
                            var relType = relTypes[j];
                            var rel = currentItem[relType] && currentItem[relType].length > 0 ? currentItem[relType][0] : undefined;
                            if (rel && rel.attributes) {
                                var newItem = {
                                    id: rel.id,
                                    title: rel.properties && rel.properties.externalName ? rel.properties.externalName : "",
                                    attributes: rel.attributes
                                };
                                rels.push(newItem);
                            }
                        }
                        relationships[keys[i]] = rels;
                    }
                }
                this.set("_relationshipsData", relationships);
                if(!_.isEmpty(this.relationshipsData)) {
                    this._populateRelationshipsGridData(this.relationshipsData);
                }
            }
        }

        /**
         *  On liquidModelGet failure
         */
        _onModelGetFailed(e) {
            this.logError("Rock query builder error",e);
        }

        /**
        * Function to generate a request to get the workflow mappings
        */
        _getWorkflowMappings(){           
            if (!_.isEmpty(this.contextData)) { 
                
                var selectedEntities =  this.getSelectedEntityTypes(this.selectedEntityTypes);
                var contextData = DataHelper.cloneObject(this.contextData);
                var itemContexts = [];
                var itemContext = {};
                itemContext.type = selectedEntities;
                itemContexts.push(itemContext);
                contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
                this.workflowEntityTypes = itemContext.type;
                this.workflowMappingDefinitionRequest = DataRequestHelper.createWorkflowMappingGetRequest(contextData);
                this.shadowRoot.querySelector('#getWorkflowMappingDefinition').generateRequest();
            }
        }

        /**
        * Function to get the workflow mappings
        */
        _onWfMappingsReceived(e) {
            var response = e.detail.response;
            if(response) {
                var mappedWorkflowNames = [];
                var mappingModels = response.content && response.content.entityModels ? response.content.entityModels: undefined;
                if(mappingModels && mappingModels.length > 0) {
                    for(var i=0; i<mappingModels.length;i++){
                        var wfDefinitionMappingModel = mappingModels[i];
                        var type = wfDefinitionMappingModel.name;
                        var wfRelationships = DataMergeHelper.mergeWorkflowMappings(wfDefinitionMappingModel, this.contextData);
                        var workflowNames = DataHelper.getRelToNames(wfRelationships.hasWorkflowsDefined);
                        mappedWorkflowNames = mappedWorkflowNames.concat(workflowNames);
                        this._mappedWorkflowNames[type] = workflowNames;
                    }
                    
                    var itemContext = this.getFirstItemContext();
                    itemContext.workflowNames = mappedWorkflowNames;
                    if(!_.isEmpty(mappedWorkflowNames)) {                   
                        var itemContext = this.getFirstItemContext();
                        itemContext.workflowNames = mappedWorkflowNames;
                        this.workflowDefinitionRequest = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                        this.shadowRoot.querySelector("#entityGetWorkflowDefinition").generateRequest();
                    }                            
                }
            }
        }

        /**
        * Workflow mappings failed
        */
        _onMappingsGetFailed(e) {
            this.logWarning("Failed to get workflow mappings","response",JSON.stringify(e.detail));       
        }

        /**
        * Function to get the workflow definitions
        */
        _onDefinitionReceived(e) {
            var workflowDefinitionResponse = e.detail.response.content.entityModels;
            if(workflowDefinitionResponse.length>=1){
                var workflows = {};
                for(let i=0;i<workflowDefinitionResponse.length;i++) {
                    var name = workflowDefinitionResponse[i].name;
                    var mappedEntityType;
                    for(var type in this._mappedWorkflowNames) {
                        if(this._mappedWorkflowNames[type].indexOf(name) !== -1) {
                            mappedEntityType = type;
                            break;
                        }
                    }
                    workflows[type] = workflows[type] ? workflows[type] : [];
                    var wfObj = workflowDefinitionResponse[i].data.attributes;
                    var newItem = {
                            name : workflowDefinitionResponse[i].name,
                            title : AttributeHelper.getFirstAttributeValue(wfObj.workflowName),
                            attributes : wfObj.activities.group
                    }
                    workflows[type].push(newItem);
                }

                this.set("_workflowData", workflows);

                if(!_.isEmpty(this.workflowCriterion)) {
                    this._populateWorkflowGridData(this.workflowCriterion);
                }
            }
        }   
        
        /**
        * Workflow definitions failed
        */
        _onDefinitionGetFailed(e) {
            this.logWarning("workflow definition get failed with error",JSON.stringify(e.detail)); 
        }

        _populateRelationshipsGridData(relationshipsData) {
            var selectedRelationship = {
                "id": relationshipsData.relationshipName,
                "title": relationshipsData.relationshipLongName,
            };

            this.set("selectedRelationship", selectedRelationship);

            if(!_.isEmpty(relationshipsData.selectedAttributes)) {
                var relationshipGridData = [];
                for(let i=0;i<relationshipsData.selectedAttributes.length; i++) {
                    var attribute = relationshipsData.selectedAttributes[i];
                    var rowData = {
                        "name": attribute.longName,
                        "value": attribute.displayValue,
                        "attributeModel": attribute.options
                    };
                    relationshipGridData.push(rowData);
                }

                this.set("relationshipGridData", relationshipGridData);
            }
        }

        _populateWorkflowGridData(workflowCriterion) {
            var wfName = workflowCriterion.workflowShortName;
            var wfActivityName = workflowCriterion.workflowActivityName;

            var wfLongName;
            var wfActivityLongName;
            for(var type in this._workflowData) {
                var wf = this._workflowData[type].find(obj => obj.name === wfName);
                if(wf) {
                    wfLongName = wf.title;
                    var wfActivity = wf.attributes.find(obj => AttributeHelper.getFirstAttributeValue(obj.activityName) === wfActivityName);
                    if(wfActivity) {
                        wfActivityLongName = AttributeHelper.getFirstAttributeValue(wfActivity.externalName);
                    }
                    break;
                } else {
                    continue;
                }
            }
            var rowData = {
                "name": wfLongName,
                "value": wfActivityLongName,
                "workflowExternalName": wfLongName,
                "workflowShortName": wfName,
                "workflowActivityExternalName": wfActivityLongName,
                "workflowActivityShortName": wfActivityName
            };

            this.set("workflowGridData", [rowData]);
        }

        /**
        * Function to read the input query string
        * //TODO - For enabling copy paste of the query into the searchbar
        **/
        _onQueryStringChange(){
            if(this.inputQueryString == this.outputQueryString){
                return;               
            } else {
                if(this.inputQueryString == ""){
                    return;
                } else {
                    
                    var tempStr = this.inputQueryString;
                    tempStr = tempStr.toLowerCase();
                    
                    var start_pos = tempStr.indexOf('show') + 4;
                    var end_pos1 = tempStr.indexOf('with');
                    var end_pos2 = tempStr.indexOf('having');
                    var end_pos = end_pos1;
                    if(end_pos2 > -1) {  //case where having is not defined
                        end_pos = Math.min(end_pos1, end_pos2);
                    }
                        
                    if(start_pos < end_pos) {
                       var entityTypesStr = tempStr.substring(start_pos,end_pos);
                       var entityTypes = entityTypesStr.split(",");                      
                    }

                    tempStr = tempStr.substring(end_pos,tempStr.length);
                    start_pos = tempStr.indexOf('with') + 4;
                    end_pos = tempStr.indexOf('having');
                    if(start_pos < end_pos) {
                        var attributesStr = tempStr.substring(start_pos,end_pos); 
                        var attributesPair = attributesStr.split("and");                           
                    }

                    tempStr = tempStr.substring(end_pos,tempStr.length); 
                    start_pos = tempStr.indexOf('having') + 6;  
                    end_pos = tempStr.indexOf('with');
                    if(start_pos < end_pos) {
                        var relationshipStr = tempStr.substring(start_pos,end_pos);                         
                    }

                    tempStr = tempStr.substring(end_pos,tempStr.length);
                    start_pos = tempStr.indexOf('with') + 4;
                    end_pos = tempStr.length;
                    if(start_pos < end_pos) {
                        var relationshipAttributesStr = tempStr.substring(start_pos,end_pos);
                        var relationshipAttributesPair = relationshipAttributesStr.split("and");                  
                        
                    } 

                }
            }
            
        }

        /**
         *  Build the query, Hide the querybuilder
        */
        _onApply(){  
            var entityTypes = this.getSelectedEntityTypes(this.selectedEntityTypes); 
            var queryBuilderData = {};
            queryBuilderData = this.getQueryBuilderData();
                      
            this.outputQueryString =  this.buildQuery(entityTypes,this.attributeGridData,queryBuilderData,false,this.searchQuery);
            var parserQueryString =  this.buildQuery(entityTypes,this.attributeGridData,queryBuilderData,true,this.searchQuery);
            
            var eventDetail = {
                "displayQuery": this.outputQueryString,
                "parsableQuery": parserQueryString
            };
            this.fireBedrockEvent('on-query-build',eventDetail);            
            this._onClose();                  
        }
        
        /**
        * Function to close the entity type popover
        */
        _onEntityTypePopoverClose(e, detail) {
            this.shadowRoot.querySelector("#productSearchPopover").close();
        }
        
        /**
         *  Handles the selected entitity change
        */
        _onSelectedEntityTypesChange(e){

            if(this.selectedEntityTypes.length <= 0){
                this.showErrorToast("Please select atleast one Entity Type");
                return;
            }

            //get relationshipmodels for selected entity types
            this._getRelationshipModels();
            //get mapped workflows data for the selected entity types
            this._getWorkflowMappings();
            
            this._onEntityTypePopoverClose();            
        }

        /**
         * Function to display the selected entity names on the entityTypeFilterButton
         */
        getSelectedEntityTypeNames(selectedEntityTypes){
            var selectedEntityStr = this.getSelectedEntityTypes(selectedEntityTypes).join();
            if(selectedEntityStr.length <= 0){
               return "Entity Type";             
            } else {
                return selectedEntityStr;             
            }
        }
        
        /**
         *  Opens the attribute Model lov
        */
        _openAttributeModelLov(e){
            var rowId = e.currentTarget.rowId;
            if(rowId >= 0) {
                var lov = this.shadowRoot.querySelector("#attributeModelLov");
                var popover = this.shadowRoot.querySelector("#attributesPopover");
                if(lov && popover) {
                    lov.currentRowId = rowId;
                    popover.for = "attributes-text_" + rowId;
                    popover.show();
                }
            } 
        }

        /**
         *  Handles the attribute selection
        */
        _onAttributeSelection(e, detail) {
            var lov = this.shadowRoot.querySelector("#attributeModelLov");
            if(lov) {
                var rowId = lov.currentRowId;
                if(rowId >= 0) {
                    var attributeTxtbox = this.root.querySelector("#attributes-text_" + rowId);
                    if(!attributeTxtbox) {
                        attributeTxtbox = this.shadowRoot.querySelector("#attributes-text_" + rowId);
                    }                
                    var row = this._getParentRow(attributeTxtbox)
                    if(row) {
                        row.item.attributeModel = detail.data;
                        row.item["rowModified"] = true;
                        row.item.name = detail.data.title;
                        attributeTxtbox.value = row.item.name;
                        attributeTxtbox.title = row.item.name;
                    }                               
                }
            }
            var popover = this.shadowRoot.querySelector("#attributesPopover");
            popover.for = "";
            popover.hide();
          
        }

        /**
         *  Get the parent row
        */
        _getParentRow(element) {
            if (element) {
                if (element.is == "data-table-row") {
                    return element;
                } else {
                    return this._getParentRow(element.parentNode);
                }
            }
            return undefined;
        }

        /**
         *  Handles the add row click
        */
        _onAddRowClick(e) {    
            var gridId = e.target.getAttribute("target-id");
            var grid = this.shadowRoot.querySelector("#"+gridId);
            var newRowItem = 
            {
                "name": "",
                "value": ""    
            }  
            newRowItem.id = grid.items.length;            
            grid.items.push(newRowItem);
            grid.clearCache();
        }

        /**
         *  Handles delete row click
        */
        _onDeleteRowClick(e){
            var gridId = e.target.getAttribute("target-id");
            var grid = this.shadowRoot.querySelector("#"+gridId);
            var row = this._getParentRow(e.currentTarget);
            var index = row.index;
            grid.items.splice(index, 1);
            grid.clearCache();
        }

        /**
         *   When attribute is selected, which popover component need to show
        */        
        _showTagModifier(displayType) {
            if(!this.currentFilterObj){
                return;
            } else if (this.currentFilterObj.dataType.toLowerCase() == "integer" || this.currentFilterObj.dataType.toLowerCase() == "decimal"){
                this.currentFilterObj.displayType = "numeric";
            } 
            
            if (this.currentFilterObj.displayType.toLowerCase() == displayType.toLowerCase()) {
                return true;
            }
            return false;
        }

        /**
         *   Handles the opening of filter popover
        */ 
        _onOpenFilterPopover(e) {  

            var rowId = e.currentTarget.rowId;
            var filterInputValue = "";
            //var attributeValTxtbox = this.root.querySelector("#attributes-value_" + rowId);
            var attributeValTxtbox = this.root.querySelector("#relationship-value_" + rowId);
            if(attributeValTxtbox.value){
                filterInputValue = attributeValTxtbox.value;
            }

            var row = this._getParentRow(attributeValTxtbox)
            if(row) {
                this.currentFilterObj = row.item.attributeModel;
            }
            
            //DateTime Control
            if (this.currentFilterObj.displayType.toLowerCase() == "datetime" || this.currentFilterObj.displayType.toLowerCase() == "date"){
                var rangePicker = this.shadowRoot.querySelector('#rangepicker');
                if(filterInputValue == ""){
                    rangePicker.startDateValue = "";
                    rangePicker.endDateValue = "";
                    rangePicker.setDate(new Date());
                    rangePicker.setRangeType(null);                                                     
                } else {
                    if(filterInputValue.indexOf('-')> -1){
                        filterInputValues = filterInputValue.split('-');
                        rangePicker.startDateValue = filterInputValues[0];
                        rangePicker.endDateValue = filterInputValues[1];
                    } else {
                        rangePicker.startDateValue = filterInputValue;
                        rangePicker.endDateValue = "";
                    }
                    var _date = new Date(rangePicker.startDateValue);
                    rangePicker.setDate(_date);
                }

                rangePicker.positionTarget = e.currentTarget;
                rangePicker.noOverlap = true;
                rangePicker.rowId = rowId; 
                rangePicker.show(true);
                return; 
            }
            
            var filterPopover = this.shadowRoot.querySelector('#filterPopover');
            filterPopover.for = "";            
            if(rowId >= 0) {
                //filterPopover.for = "attributes-value_" + rowId;
                filterPopover.for = "relationship-value_" + rowId;
                filterPopover.show();
            }
                                            
            if (this.currentFilterObj.displayType.toLowerCase() == "textbox") {
                Polymer.Async.microTask.run(() => {
                    var collectionInput = filterPopover.querySelector('#textCollection').shadowRoot.querySelector("#txtInputTag"); 
                    this.txtBoxCollection = new Array();
                    if(filterInputValue) {
                        var filterInputValues = filterInputValue.split(' '+ 'or' +' ');
                        //If the value has already been added, show it in the textbox for updating
                        this.txtBoxCollection = filterInputValues;
                    }
                    collectionInput.value = "";                    
                    collectionInput.focus();
                });
            } else if (this.currentFilterObj.displayType.toLowerCase() == "textarea"){
                var filterInput = filterPopover.querySelector('.input');
                this.txtAreaInput = "";
                if (filterInput) {
                    filterInput.value = filterInputValue;
                    this.txtAreaInput = filterInputValue;
                    filterInput.focus();  
                }  
            } else if (this.currentFilterObj.displayType.toLowerCase() == "richtexteditor"){
                var filterInput = filterPopover.querySelector('.input');
                this.txtAreaInput = "";
                if (filterInput) {
                    filterInput.value = filterInputValue;
                    this.txtAreaInput = filterInputValue;
                    filterInput.focus();  
                }  
            } else if (this.currentFilterObj.displayType.toLowerCase() == "boolean") {
                var filterInput = filterPopover.querySelector('#booleanDisplay');
                this.booleanvalue = "";
                if (filterInput) {
                    filterInput.value = filterInputValue;
                    this.booleanvalue = filterInputValue;
                }
            } else if (this.currentFilterObj.displayType.toLowerCase() == "referencelist") {               

                var lovComponent = filterPopover.querySelector('#rockEntityLov');  
                if(lovComponent) {
                    var titlePattern = "";
                    var subTitlePattern = "";
                    if(this.currentFilterObj.referenceEntityInfo && this.currentFilterObj.referenceEntityInfo.length) {
                        titlePattern = this.currentFilterObj.referenceEntityInfo[0].listTitle;
                        subTitlePattern = this.currentFilterObj.referenceEntityInfo[0].listSubTitle;
                    }
                    lovComponent.idField = "id";
                    lovComponent.titlePattern = titlePattern;
                    lovComponent.subTitlePattern = subTitlePattern;
                    lovComponent.valueField = "name";
                    this._selectedItems = [];
                    if(filterInputValue) {
                        lovComponent.selectedItems = row.item.selectedItems;
                        this._selectedItems = row.item.selectedItems;
                    }  
                    var refEntityTypes = [this.currentFilterObj.referenceEntityInfo[0].refEntityType];
                    var itemContexts = [];
                    for (var i in refEntityTypes) {
                        itemContexts.push({
                            "type": refEntityTypes[i]
                        });
                    }
                    var contextData = DataHelper.cloneObject(this.contextData);
                    contextData[this.CONTEXT_TYPE_ITEM] = itemContexts;
                    lovComponent.requestData = DataRequestHelper.createEntityGetRequest(contextData);
                    lovComponent.requestData.params.additionalIds = this.currentFilterObj.selectedIds;
                    lovComponent.reset();
                } 
            } else if (this.currentFilterObj.displayType.toLowerCase() == "numeric"){

                this._tagsNumericCollection = [];
                this._tagNumericInput = ""; 
                this.lte = "";
                this.gte = "";

                if(filterInputValue) {
                    var filterInputValues= [];
                    if(filterInputValue.indexOf('-') > -1) {
                        filterInputValues = filterInputValue.split('-');
                        this.gte = filterInputValues[0];
                        this.lte = filterInputValues[1];
                    } else if (filterInputValue.indexOf('<=') > -1) {
                        filterInputValues = filterInputValue.split('<=');
                        this.lte = filterInputValues[1];
                        this.gte = "";
                    } else if (filterInputValue.indexOf('>=') > -1) {
                        filterInputValues = filterInputValue.split('>=');
                        this.gte = filterInputValues[1];
                        this.lte = "";
                    } else {
                        this._tagsNumericCollection = filterInputValue;
                    }
                }           
                 
            } 

        }

        /**
        * validate the input for numeric display type and disables the update button
        */
        _disableUpdate(numericMinInvalid, numericMaxInvalid, _tagsNumericCollection, _tagNumericInput, gte, lte) {
            if (!_.isEmpty(this.gte + "") || !_.isEmpty(this.lte + "") || !_.isEmpty(_tagsNumericCollection) || _tagNumericInput) {
            if (this.shadowRoot.querySelector('paper-radio-group') && this.shadowRoot.querySelector('paper-radio-group').selected == "range") {
                return (numericMaxInvalid || numericMinInvalid);
            } else {
                return _.isEmpty(_tagsNumericCollection) && !_tagNumericInput;
            }
            } else {
                return true;
            }
        }
        
        /**
         * checks if the min value is less than maximum value in numeric display type popover
        */
        _isMaxGreaterThanMin() {
            if (!_.isEmpty(this.gte + "") && !_.isEmpty(this.lte + "")) {
            if (parseFloat(this.gte) > parseFloat(this.lte)) {
                this.set('numericMaxInvalid', true);
            } else {
                this.set('numericMaxInvalid', false);
            }
            } else {
            this.set('numericMaxInvalid', false);
            }
        }

        /**
         *  Handles updating of the filter popover content 
        */ 
        _onUpdateValue(e){

            //Updating Date and Datetime inputs
            if(this.currentFilterObj.displayType.toLowerCase() == "datetime" || this.currentFilterObj.displayType.toLowerCase() == "date"){
                if (this.gte == this.lte) { 
                    filterInputValue = this.displaygte;
                } else {                    
                    if (this.displaygte == this.displaylte) {
                        filterInputValue = this.displaygte;
                    } else {
                        filterInputValue = this.displaygte + " - " + this.displaylte;
                    }
                } 
                
                //var attributeValTxtbox = this.root.querySelector("#attributes-value_" + e.currentTarget.rowId);
                var attributeValTxtbox = this.root.querySelector("#relationship-value_" + e.currentTarget.rowId);
                var row = this._getParentRow(attributeValTxtbox);              
                if(row) {
                    row.item.value = filterInputValue;
                    attributeValTxtbox.value = filterInputValue;
                    attributeValTxtbox.title = filterInputValue;
                }
                return;
            }
           
            //Updating other inputs
            var filterPopover = this.shadowRoot.querySelector('#filterPopover');
            var attributeValTxtbox = this.root.querySelector("#"+ filterPopover.for);
            var row = this._getParentRow(attributeValTxtbox);

            var filterInput;
            var filterInputValue;
            if (this.currentFilterObj.displayType.toLowerCase() == "textbox") {
                var collectionInput = filterPopover.querySelector('#textCollection').shadowRoot.querySelector("#txtInputTag"); 
                filterInputValue = collectionInput.value;               
                if(this.txtBoxCollection.length > 0) {
                    filterInputValue = this.txtBoxCollection.join(' '+ 'or' +' ');
                }
            } else if (this.currentFilterObj.displayType.toLowerCase() == "textarea") {
                filterInput = filterPopover.querySelector('.input');
                filterInputValue = filterInput.value;
            } else if (this.currentFilterObj.displayType.toLowerCase() == "richtexteditor") {
                filterInput = filterPopover.querySelector('.input');
                filterInputValue = filterInput.value;
            } else if (this.currentFilterObj.displayType.toLowerCase() == "boolean") {
                filterInput = filterPopover.querySelector('#booleanDisplay');
                filterInputValue = filterInput.value;
            } else if(this.currentFilterObj.displayType.toLowerCase() == "numeric"){
                if (this.shadowRoot.querySelector('paper-radio-group').selected == "range") {
                    if (this.gte == "") {
                        this.gte = undefined;
                    }
                    if (this.lte == "") {
                        this.lte = undefined;
                    }
                    if (!(this.gte || this.lte)) {
                        this.logWarning("FilterValuesEmpty");
                        return;
                    } else {
                        var gteAsString = (parseFloat(this.gte)).toString();
                        var lteAsString = (parseFloat(this.lte)).toString();
                        if (!this.gte) {                   
                            filterInputValue = "<= " + lteAsString;
                        } else if (!this.lte) {                  
                            filterInputValue = ">= " + gteAsString;
                        } else {                   
                            filterInputValue = gteAsString + " - " + lteAsString;
                        }
                    }
                } else if (this._tagsNumericCollection.length > 0){
                    filterInputValue = this._tagsNumericCollection;
                } 
            }

            //Update the grid row
            if(row) {
                row.item.value = filterInputValue;
                attributeValTxtbox.value = filterInputValue;
                attributeValTxtbox.title = filterInputValue;
            }     
            
            //close the filter popover
            filterPopover.close();

        }

        /**
         *  Handles referencelist confirm tap 
        */ 
        _onLOVConfirmTap(){

            var filterPopover = this.shadowRoot.querySelector('#filterPopover');
            var attributeValTxtbox = this.root.querySelector("#"+ filterPopover.for);
            var row = this._getParentRow(attributeValTxtbox);   

            var filterInputValue = [];
            var selectedItemsObj = this._selectedItems;
            
            for (let i = 0; i < selectedItemsObj.length; i++) {
                if (selectedItemsObj[i].title) {
                    filterInputValue.push(selectedItemsObj[i].title);
                }            
            }
           
            //Update the grid row
            if(row) {
                row.item.value = filterInputValue;
                row.item.selectedItems = this._selectedItems;
                attributeValTxtbox.value = filterInputValue;
                attributeValTxtbox.title = filterInputValue;
            }  
            
            //close the filter popover
            filterPopover.close();

        }

        /**
         *  Handles referencelist close tap 
        */ 
        _onLOVCloseTap(e,detail){
            var filterPopover = this.shadowRoot.querySelector('#filterPopover');
            filterPopover.close();
        }

        /**
         *  Open relationship lov 
        */ 
        _openRelationshipModelLov() {
            //Get the intersection if the selected entities are more than 1
            var entityTypes = this.getSelectedEntityTypes(this.selectedEntityTypes);
            if(!_.isEmpty(entityTypes) && !_.isEmpty(this._relationshipsData)) {
                var relationships = [];
                for(let i=0; i<entityTypes.length; i++) {
                    var type = entityTypes[i];
                    if(this._relationshipsData[type]) {
                        relationships = relationships.concat(this._relationshipsData[type]);
                    }
                }

                if(!_.isEmpty(relationships)) {
                    relationships = this.findDuplicate(relationships, 'title');
                }
                var relationshipPopover = this.shadowRoot.querySelector('#relationshipPopover');
                var relationshipModelLov = this.shadowRoot.querySelector('#relationshipModelLov');
                relationshipModelLov.items = new Array();
                relationshipModelLov.items = relationships;
                relationshipPopover.show();
            }
        }

        /**
         *  Function to find the duplicate items in an object array
         */
        findDuplicate (arrayOfObj, key) {
            return arrayOfObj.filter((item, index, array) => {
                return array.map((mapItem) => mapItem[key]).indexOf(item[key]) === index
            })
        }

        /**
         *  Function to populate relationship attributes
         */
        _onRelationshipLovSelectionChanged(e){
            var attributesList = e.detail.item.attributes;            
            var attributes = new Array();        
            for(var obj in attributesList){
                var newItem = {
                    name : obj,
                    title : attributesList[obj].properties.externalName,
                    dataType : attributesList[obj].properties.dataType,
                    displayType : attributesList[obj].properties.displayType,
                    groupName : attributesList[obj].properties.groupName,
                    referenceEntityInfo : attributesList[obj].properties.referenceEntityInfo                           
                }                        
                attributes.push(newItem);
            }

           //Populate the relAttributeModelLov
           var relAttributeModelLov = this.shadowRoot.querySelector('#relAttributeModelLov');
           relAttributeModelLov.items = new Array();
           relAttributeModelLov.items = attributes;
            
           //Close the relationshipModelLov
           var relationshipPopover = this.shadowRoot.querySelector('#relationshipPopover');
           relationshipPopover.close(); 
        }
        
        /**
        * Function to display the selected relationship on the button
        */
        getSelectedRelationship(selectedRelationship){
            if(selectedRelationship && selectedRelationship.title){
                return selectedRelationship.title;
            } else {
                return "Relationships";
            }
        }
                
        /**
         *  Function to open relationship attributes lov
         */
        _openRelationshipAttributeModelLov(e){
            var rowId = e.currentTarget.rowId;
            if(rowId >= 0) {
                var lov = this.shadowRoot.querySelector("#relAttributeModelLov");
                var popover = this.shadowRoot.querySelector("#relAttributesPopover");
                if(lov && popover) {
                    lov.currentRowId = rowId;
                    popover.for = "relationship-text_" + rowId;
                    popover.show();
                }
            } 
        }

         /**
         *  Function to select relationship attribute from the lov
         */
        _onRelAttributeLovSelectionChanged(e){
            var lov = this.shadowRoot.querySelector("#relAttributeModelLov");
            if(lov) {
                var rowId = lov.currentRowId;
                if(rowId >= 0) {
                    var relattributeTxtbox = this.root.querySelector("#relationship-text_" + rowId);
                    if(!relattributeTxtbox) {
                        relattributeTxtbox = this.shadowRoot.querySelector("#relationship-text_" + rowId);
                    }                
                    var row = this._getParentRow(relattributeTxtbox)
                    if(row) {
                        row.item.attributeModel = e.detail.item;
                        row.item["rowModified"] = true;
                        row.item.name = e.detail.item.title;
                        relattributeTxtbox.value = row.item.name;
                        relattributeTxtbox.title = row.item.name;
                    }                               
                }
            }
            var popover = this.shadowRoot.querySelector("#relAttributesPopover");
            popover.for = "";
            popover.hide();
        }

        /**
        * Open the Workflow Lov
        */
        _openWorkflowModelLov(e) {

            //If entity types are not changed, return without making a rdf call
            var selectedEntities =  this.getSelectedEntityTypes(this.selectedEntityTypes);
            
            if(!_.isEmpty(selectedEntities) && !_.isEmpty(this._workflowData)) {
                var workflows = [];
                for(let i=0; i<selectedEntities.length; i++) {
                    var type = selectedEntities[i];
                    if(this._workflowData[type]) {
                        workflows = workflows.concat(this._workflowData[type]);
                    }
                }

                var rowId = e.currentTarget.rowId;
                if(rowId >= 0) {
                    var lov = this.shadowRoot.querySelector("#workflowModelLov");
                    lov.items = workflows;
                    var popover = this.shadowRoot.querySelector("#workflowPopover");
                    if(lov && popover) {
                        lov.currentRowId = rowId;
                        popover.for = "workflow-text_" + rowId;
                        popover.show();
                    }
                }
            }
        }
        
        /**
        *  Function to select workflow attribute from the lov
        */
        _onWorkflowLovSelectionChanged(e){
            var lov = this.shadowRoot.querySelector("#workflowModelLov");
                if(lov) {
                    var rowId = lov.currentRowId;
                    if(rowId >= 0) {
                        var wfattributeTxtbox = this.root.querySelector("#workflow-text_" + rowId);
                        if(!wfattributeTxtbox) {
                            wfattributeTxtbox = this.shadowRoot.querySelector("#workflow-text_" + rowId);
                        }                
                        var row = this._getParentRow(wfattributeTxtbox)
                        if(row) {
                            row.item.workflowExternalName = e.detail.item.title;
                            row.item.workflowShortName = e.detail.item.name;
                            row.item.attributeModel = e.detail.item;
                            row.item["rowModified"] = true;
                            row.item.name = e.detail.item.title;
                            wfattributeTxtbox.value = row.item.name;
                            wfattributeTxtbox.title = row.item.name;
                        }                               
                    }
                }
                var popover = this.shadowRoot.querySelector("#workflowPopover");
                popover.for = "";
                popover.hide();
        }

        /**
        * Open the Workflow Activity Lov
        */
        _openWorkflowActivityLov(e) {        
            var rowId = e.currentTarget.rowId;
        
            if(rowId >= 0) {
                var wfattributeTxtbox = this.root.querySelector("#workflow-text_" + rowId);
                if(!wfattributeTxtbox) {
                    wfattributeTxtbox = this.shadowRoot.querySelector("#workflow-text_" + rowId);
                }
                var row = this._getParentRow(wfattributeTxtbox);
                var wfName = row && row.item && row.item.workflowShortName ? row.item.workflowShortName : "";
                var wfAttributes = [];

                for(var type in this._workflowData) {
                    var workflow = this._workflowData[type].find(obj => obj.name === wfName);
                    if(workflow) {
                        wfAttributes = workflow.attributes;
                        break;
                    } else {
                        continue;
                    }
                }

                //Populate the Workflow Activity Lov
                var workflowActivities = new Array();   
                for(var i=0;i<wfAttributes.length;i++){
                    var newItem = {
                        name : AttributeHelper.getFirstAttributeValue(wfAttributes[i].activityName),
                        title : AttributeHelper.getFirstAttributeValue(wfAttributes[i].externalName)
                    }                        
                    workflowActivities.push(newItem);
                }
                var lov = this.shadowRoot.querySelector("#workflowActivityLov");
                lov.items = new Array();
                lov.items = workflowActivities;
                var popover = this.shadowRoot.querySelector("#workflowActivityPopover");
                if(lov && popover) {
                    lov.currentRowId = rowId;
                    popover.for = "relationship-value_" + rowId;
                    popover.show();
                }
            } 
        }

        /**
        *  Function to select workflow activity attribute from the lov
        */
        _onWorkflowActivityLovSelectionChanged(e){
            var lov = this.shadowRoot.querySelector("#workflowActivityLov");
            if(lov) {
                var rowId = lov.currentRowId;
                if(rowId >= 0) {
                    var wfattributeTxtbox = this.root.querySelector("#workflow-value_" + rowId);
                    if(!wfattributeTxtbox) {
                        wfattributeTxtbox = this.shadowRoot.querySelector("#workflow-value_" + rowId);
                    }                
                    var row = this._getParentRow(wfattributeTxtbox)
                    if(row) {
                        row.item.workflowActivityExternalName = e.detail.item.title;
                        row.item.workflowActivityShortName = e.detail.item.name;
                        row.item["rowModified"] = true;
                        row.item.value = e.detail.item.title;
                        wfattributeTxtbox.value = row.item.value;
                        wfattributeTxtbox.title = row.item.value;
                    }                               
                }
            }
            var popover = this.shadowRoot.querySelector("#workflowActivityPopover");
            popover.for = "";
            popover.hide();
        }

        _isWorkflowSearchEnabled(workflowName) {
            if(workflowName && workflowName !== "") {
                return false;
            }
            return true;
        }
    }

    customElements.define(RockQueryBuilder.is, RockQueryBuilder);  
  </script> 
</dom-module>