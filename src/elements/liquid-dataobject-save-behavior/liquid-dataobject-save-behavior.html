<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-base-falcor-behavior/liquid-base-falcor-behavior.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<!--
`liquid-dataobject-save-behavior`
Boolean control

@demo demo/index.html
-->

<script>
    var RUFBehaviors = RUFBehaviors || {};
    var liquidDataObjectSaveBehavior = {
        attached: function() {
        },
        ready: function(){
        },
        properties: {
             _dataChannelName: {
                type: String,
                value: "dataObjectChannel",
                readonly: true
            },
            objectType: {
                type: String,
                value: 'entityData'
            },
            _pathKeys: {
                type: Object,
                value: function(){
                    return this._getDataObjectPathKeys();
                }
            }
        },
        _executeRequest: function (model, request) {
            var op = request.operation;

            if (op === 'create') {
                return this._callCreate(model, request);
            }
            else if (op === 'update') {
                return this._callUpdate(model, request);
            }
            else {
                throw 'exception: operation ' + op + ' is not supported in ' + this.is + ' element.';
            }
        },
        _formatResponse: function(request, rawResponsePkg) {
            var op = request.operation;

            if(!rawResponsePkg) {
                return rawResponsePkg;
            }
                
            if (op === 'update') {
                var statusResponse = rawResponsePkg;

                if(!rawResponsePkg.status) {
                    statusResponse = {'msg': "entity submitted for save successfully", 'reqTrackingId':100};
                }

                if(this.verbose) {
                    console.log('save entity call raw response ', rawResponsePkg);
                    var model = RUFBehaviors.DataChannel.getModel(this._dataChannelName);
                    console.log('model cache after save call', model.getCache());
                }

                return statusResponse;
            }
            else if (op === "create") {
                var statusResponse = rawResponsePkg;
                
                if(!rawResponsePkg.status) {
                    statusResponse = {'msg': "entities submitted for save successfully", 'reqTrackingId':100};
                }

                if(this.verbose) {
                    console.log('save entity call raw response ', rawResponsePkg);
                    var model = RUFBehaviors.DataChannel.getModel(this._dataChannelName);
                    console.log('model cache after save call', model.getCache());
                }

                return statusResponse;
            }
            else {
                return rawResponsePkg;
            }
        },
        _callCreate: function(model, request) {
            var jsonEnvelope = this._createJsonEnvelope(request);

            if(jsonEnvelope === {}) {
                return;
            }

            var pathKeys = this._pathKeys;
            var objectType = this.objectType;
            var objectTypeInfo = pathKeys.objectTypesInfo[objectType];

            
            if(this.verbose) {
                console.log('dataobject json envelope', jsonEnvelope);
                console.log('model cache before save call', model.getCache());
            }

            return model.call([pathKeys.root, this.objectType, "create"], [jsonEnvelope], [], []);
        },
        _callUpdate: function(model, request) {
            var jsonEnvelope = this._createJsonEnvelope(request);

            if(jsonEnvelope === {}) {
                return;
            }

            var pathKeys = this._pathKeys;
            var objectType = this.objectType;
            var objectTypeInfo = pathKeys.objectTypesInfo[objectType];
            
            var dataObjectIds = Object.keys(jsonEnvelope.json[pathKeys.root][objectType][pathKeys.masterListById]);
            
            if(this.verbose) {
                console.log('dataobject json envelope', jsonEnvelope);
                console.log('model cache before save call', model.getCache());
            }

            return model.call([pathKeys.root, this.objectType, pathKeys.masterListById, dataObjectIds, "update"], [jsonEnvelope], [], []);
        },
        _createJsonEnvelope: function(request) {
            var reqData = request.requestData;
            var pathKeys = this._pathKeys;
            var objectType = this.objectType;
            var objectTypeInfo = pathKeys.objectTypesInfo[objectType];

            if(reqData === undefined || !Object.keys(reqData[objectTypeInfo.collectionName]).length) {
                return {};
            }

            var dataObjects = reqData[objectTypeInfo.collectionName];

            if(this.verbose) {
                console.log('Request for save data objects call...data objects: ', dataObjects);
            }

            var jsonEnvelope = {"json": {}};
            jsonEnvelope.json[pathKeys.root] = {};
            jsonEnvelope.json[pathKeys.root][objectType] = {};

            var dataObjectsMasterListJson = jsonEnvelope.json[pathKeys.root][objectType][pathKeys.masterListById] = {};
            
            var dataObjectIds = Object.keys(dataObjects);
            
            if(dataObjectIds.length == 0) {
                var reason = {'status':'error', 'msg': 'No data objects found for save'};
                return reason;
            }

            for(var i in dataObjectIds) {
                var dataObjectId = dataObjectIds[i];
                var dataObject = dataObjects[dataObjectId];    
                dataObjectsMasterListJson[dataObjectId] = SharedUtils.DataObjectFalcorUtil.boxDataObject(dataObject, SharedUtils.DataObjectFalcorUtil.boxJsonObject);
            }

            return jsonEnvelope;
        },
        _getDataObjectPathKeys: function() {
            return SharedUtils.DataObjectFalcorUtil.getPathKeys();
        }
     };

    RUFBehaviors.LiquidDataObjectSaveBehavior = [RUFBehaviors.LiquidBaseFalcorBehavior, liquidDataObjectSaveBehavior];
</script>