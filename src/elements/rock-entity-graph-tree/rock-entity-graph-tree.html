<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../pebble-tree/pebble-tree.html">

<link rel="import" href="entity-graph-tree-datasource.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<dom-module id="rock-entity-graph-tree">
    <template>
         <style>
             :host{
                --pebble-tree-node:{
                    margin-top: 10px;
                    margin-bottom: 10px;
                }
                --pebble-tree-node-nodetext:{
                    font-size: var(--font-size-sm, 12px);
                    font-weight: var(--font-medium, 500);
                    color: var(--buttontext-color, #616161);
                    text-align:left;
                    display: -webkit-box;
                    display: -webkit-flex;
                    display: -ms-flexbox;
                    display: flex;
                    align-items: flex-start;
                    -webkit-align-items: flex-start;
                }
             }
         </style>
         <liquid-entity-model-get id="liquidModeleGet" operation="getbyids" request-data={{_modelRequest}} on-response="_onModelReceived" on-error="_onModelGetFailed"></liquid-entity-model-get>

        <entity-graph-tree-datasource where-used-request="{{_whereUsedRequest}}" where-used-data-source="{{_whereUsedDataSource}}" 
                owned-relationships-request="{{_ownedRelationshipsRequest}}" owned-data-source="{{_ownedDataSource}}"></entity-graph-tree-datasource>

        <pebble-tree id="tree" leaf-node-only="[[leafNodeOnly]]" data="{{_graphs}}" default-child-depth="10" multi-select="[[multiSelect]]">

        </pebble-tree>
    </template>
<script>
(function(){

    Polymer({
        is: "rock-entity-graph-tree",
        properties:{
            contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            _treeConfig: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            leafNodeOnly:{
                type:Boolean,
                value:true
            },
            _graphs: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            _graphData:{
                type:Object,
                value: function(){
                    return {};
                }
            },
            _selectedItems: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            _selectedItem: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            multiSelect:{
                type:Boolean,
                value:false
            },
            _currentNode:{
                type:Object,
                value: function(){
                    return {};
                }
            },
            _whereUsedRequest:{
                type:Object,
                value:function(){
                    return {}
                }
            },
            _whereUsedDataSource:{
                type:Object,
                notify:true
            },  
            _ownedDataSource:{
                type:Function,
                notify:true
            },
            _ownedRelationshipsRequest:{
                type:Object,
                notify:true
            },
            _parentNode:{
                type:Object
            },
            _currentNodeData:{
                type:Object
            },
            itemData:{
                type:Object,
                value: function() {
                    return {};
                },
                notify:true
            },
            _modelRequest:{
                type:Object
            },
            _entityModelElement:{
                type:Object
            }
        },
        behaviors: [
            RUFBehaviors.UIBehavior
        ],
        listeners: {
            'tree-node-expanded': '_treeNodeExpanded',
            'tree-node-clicked': '_treeNodeClicked'
        },
        ready: function(){
            this._treeConfig = this.getParentAppConfig('rock-entity-graph', '', 'entityGraphTreeConfig');
            if(!_.isEmpty(this._treeConfig)){
                this._graphData = DataHelper.cloneObject(this._treeConfig); //this._formatTree(graphConfig);
                this._graphData.viewType = "";
                this._graphData.id = DataHelper.getParamValue('id');
                this._graphData.type = DataHelper.getParamValue('type');
                this._currentNodeData = this._graphData;
                this._graphs = [this._graphData];
            }
            
        },
        attached:function(){
            this._entityModelElement = this.shadowRoot.querySelector("#liquidModeleGet")
            var _self = this;
            setTimeout(() =>{
                
                _self._initiateModelRequest();
                        }, 10);
        },
        _treeNodeExpanded: function (e) {
            this._currentNode = e.detail;
            if (!this._currentNode.nodeData.children) {
                this._currentNodeData = this._currentNode.nodeData;
                this._initiateModelRequest();
                this._currentNode.startLoading();
            }
        },
        _treeNodeClicked: function (e){
            if(e && e.detail && e.detail.data){
                var node = e.detail.data;
                if(node.nodeData){
                    this.itemData = node.nodeData;
                }else{
                    this.itemData = {}
                }
            }
            
        },
        _getModelRequest: function(){
            if(_.isEmpty(this._currentNodeData))
            {
                return;
            }
            var params = {
                            "query": {
                                
                                "filters": {
                                    "typesCriterion": [
                                        "entityGraphModel"
                                    ]
                                }
                            },
                            "fields": {
                                "relationships": []
                            },
                            "options": {
                                "maxRecords": 200
                            }
                        }
            
            var relationships = []
            if(this._currentNodeData.relationships && this._currentNodeData.relationships.length > 0){
                for (let i = 0; i < this._currentNodeData.relationships.length; i++) {
                    const element = this._currentNodeData.relationships[i];
                    if(element && element.relationshipName){
                        relationships.push(element.relationshipName);
                    }
                }
            }
            params.fields.relationships = relationships;
            var graphModelType = this._currentNodeData.type + "_entityGraphModel";
            params.query.id = graphModelType;
            this._currentNodeData.modelId = graphModelType;
            var req = {params:params};
            return req;
        },
        _initiateModelRequest: function(){
            this._modelRequest = this._getModelRequest()
            this._entityModelElement.generateRequest();
        },
        _onModelReceived: function(ev){
            if(ev && ev.detail && ev.detail.response){
                if(ev.detail.response.content && (ev.detail.response.status == "success")){
                    const res = ev.detail.response;
                    var entity = DataHelper.findEntityById(res.content.entityModels, this._currentNodeData.modelId);
                    if(entity){
                        if(this._currentNodeData.relationships){
                            for (var i = 0; i < this._currentNodeData.relationships.length; i++) {
                                var relationship = this._currentNodeData.relationships[i];
                                
                                if(relationship && relationship.relationshipName){
                                    var _relationshipDataArray = EntityHelper.getRelationshipByType(entity, null, relationship.relationshipName, true);
                                    if(_relationshipDataArray && _relationshipDataArray.length > 0){
                                        var _relProperties = _relationshipDataArray[0].properties;
                                        if(_relProperties.externalName){
                                            relationship.displayName = "All "+_relProperties.externalName+" of ";
                                        }
                                        if(_relProperties.relationshipOwnership){
                                            relationship.relationshipOwnership = _relProperties.relationshipOwnership;
                                        }
                                        if(_relProperties.relatedEntityInfo && _relProperties.relatedEntityInfo.length > 0){
                                            relationship.relEntityType = _relProperties.relatedEntityInfo[0].relEntityType;
                                        }
                                    }
                                }
                            
                            }   
                        }
                    }
                }
            }
            this._executeRequest();
        },
        _onModelGetFailed:function(e){
            //Need to log error
        },
        _executeRequest: function(){
            if(this._currentNodeData){
                var dataObj = {
                    id:this._currentNodeData.id,
                    type:this._currentNodeData.type,
                    attribute:"",
                    ownedRelationshipNames:[],
                    ownedRelationshipAttributes:[],
                    whereUsedRelationshipNames:[],
                    whereUsedRelationshipAttributes:[],
                    whereUsedTypesCriterion:[]
                };
                
                dataObj.attribute = this._parseNodeTitle(this._currentNodeData.treeNodeTitle);
                    
                if(this._currentNodeData.relationships && this._currentNodeData.relationships.length > 0){
                    var relObj, relAttr;
                    for (var i = 0; i < this._currentNodeData.relationships.length; i++) {
                        relObj = this._currentNodeData.relationships[i];
                        relAttr = this._parseNodeTitle(relObj.treeNodeTitle)
                        
                        if(relObj.relationshipOwnership == 'whereused'){
                            dataObj.whereUsedRelationshipNames.push(relObj.relationshipName);
                            if(relObj.relEntityType){
                                dataObj.whereUsedTypesCriterion.push(relObj.relEntityType);
                            }
                            if(relAttr){
                                dataObj.whereUsedRelationshipAttributes.push(relAttr);
                            }
                        }else{
                            dataObj.ownedRelationshipNames.push(relObj.relationshipName);
                            if(relAttr){
                                dataObj.ownedRelationshipAttributes.push(relAttr);
                            }
                        }
                    }
                }

                if(dataObj.whereUsedRelationshipNames && dataObj.whereUsedRelationshipNames.length > 0){
                    //For whereUsed 
                    this._whereUsedRequest = this._getWhereUsedRequest(dataObj);
                    this._whereUsedDataSource({}, this._onWhereUsedDataSourceResponse.bind(this), this._onWhereUsedDataSourceError.bind(this));
                }
                if(dataObj.ownedRelationshipNames && dataObj.ownedRelationshipNames.length > 0){
                    //For owned
                    this._ownedRelationshipsRequest = this._getOwnedRelationshipsRequest(dataObj);
                    this._ownedDataSource({}, this._onOwnedDataSourceResponse.bind(this), this._onOwnedDataSourceError.bind(this))
                }
                
            }
        },
        _onOwnedDataSourceResponse: function(res){
            if(!_.isEmpty(res)){
                var entityValidation = DataHelper.validateGetEntitiesResponse(res);
                var currentNodeData;

                if(entityValidation){
                    var entity = DataHelper.findEntityById(res.content.entities, this._currentNodeData.id);
                    if(entity){
                        var _nodeTitle = this._getNodeTitle(entity, this._currentNodeData.treeNodeTitle);
                        if(!_nodeTitle){
                            _nodeTitle = this._currentNodeData.id;
                        }
                        if(!this._parentNode){
                            if(_nodeTitle){
                                this._updateNodeTitle(_nodeTitle);
                            }
                            this._parentNode = entity;
                        }
                    
                        if(this._currentNodeData.relationships){
                            var relationship, childNodeObj, tempArray;
                            var nodeChildren = [];
                            for (var i = 0; i < this._currentNodeData.relationships.length; i++) {
                                relationship = this._currentNodeData.relationships[i];
                                childNodeObj = {};

                                if(relationship && relationship.relationshipName){
                                    relationship.expanded = true;
                                    tempArray = [];
                                    var _relationshipDataArray = EntityHelper.getRelationshipByType(entity, null, relationship.relationshipName, true);
                                    if(_relationshipDataArray && _relationshipDataArray.length > 0){
                                        _relationshipDataArray.forEach(function(_relTo) {
                                            if(_relTo && _relTo.relTo){
                                                var _relToObj = _relTo.relTo;
                                                _relToObj.text = this._getNodeTitle(_relToObj, relationship.treeNodeTitle);
                                                _relToObj.treeNodeTitle = relationship.treeNodeTitle;
                                                _relToObj.displayName = relationship.displayName;
                                                _relToObj.relationshipName = relationship.relationshipName;
                                                _relToObj.viewMode = "QUICK_MANAGE";
                                                if(relationship.relationships){
                                                    _relToObj.relationships = relationship.relationships;
                                                }
                                                tempArray.push(_relToObj);
                                            }
                                        }, this);
                                        
                                    }
                                    
                                    childNodeObj.id = this._currentNodeData.id;
                                    childNodeObj.type = this._currentNodeData.type;
                                    childNodeObj.relationshipName = relationship.relationshipName;
                                    childNodeObj.expanded = true;
                                    childNodeObj.text = relationship.displayName + _nodeTitle;
                                    childNodeObj.viewMode = "GRID";
                                    childNodeObj.children = tempArray;
                                    nodeChildren.push(childNodeObj);
                                }
                            }
                            this._currentNodeData.expanded = true;
                            this._updateNodeData(nodeChildren);
                        }
                    }
                }   
            }
        },
        _onOwnedDataSourceError: function(ev){

        },
        _onWhereUsedDataSourceResponse: function(ev){
            if(ev && ev.content && ev.content.entities){
                if(this._currentNodeData.relationships && this._currentNodeData.relationships.length > 0){
                    var nodeChildren = [];
                    var tempArray = [];
                    var childNodeObj = {};
                    var relationship;
                    for (var i = 0; i < this._currentNodeData.relationships.length; i++) {
                        relationship = this._currentNodeData.relationships[i];
                        childNodeObj = {};
                        
                        if(relationship && relationship.relationshipName){
                            relationship.expanded = true;
                            tempArray = [];
                            var entities = ev.content.entities;
                            entities.forEach(function(entity) {
                                if(entity.data && entity.data.relationships){
                                    if(entity.data.relationships[relationship.relationshipName]){
                                        entity.text = this._getNodeTitle(entity, relationship.treeNodeTitle);
                                        entity.treeNodeTitle = relationship.treeNodeTitle;
                                        entity.displayName = relationship.displayName;
                                        entity.relationshipName = relationship.relationshipName;
                                        entity.viewMode = "QUICK_MANAGE";
                                        if(relationship.relationships){
                                            entity.relationships = relationship.relationships;
                                        }
                                        tempArray.push(entity);
                                    }
                                }

                            }, this);

                            
                            childNodeObj.id = this._currentNodeData.id;
                            childNodeObj.type = this._currentNodeData.type;
                            childNodeObj.relationshipName = relationship.relationshipName;
                            childNodeObj.expanded = true;
                            childNodeObj.text = relationship.displayName;
                            childNodeObj.viewMode = "GRID";
                            childNodeObj.children = tempArray;
                            nodeChildren.push(childNodeObj);
                        }
                        
                    }
                    this._currentNodeData.expanded = true;
                    this._updateNodeData(nodeChildren);
                }
            }
        },
        _updateNodeData: function(_nodeChildren){
            if(this._currentNodeData.children && this._currentNodeData.children.length > 0){
                for (var j = 0; j < this._currentNodeData.children.length; j++) {
                    var currentChild = this._currentNodeData.children[j];

                    if(currentChild.children && (currentChild.children.length == 0)){
                        for (var k = 0; k < _nodeChildren.length; k++) {
                            var child = _nodeChildren[k];
                            
                            if(child.relationshipName == currentChild.relationshipName){
                                this._currentNodeData.children[j] = child; 
                            }
                        }
                    }
                }
            }else{
                this._currentNodeData.children = _nodeChildren;
            }

            this._refreshGraphTree();
        },
        _onWhereUsedDataSourceError: function(ev){

        },
        _getWhereUsedRequest: function(reqData){
            //var typeConfig = this.treeConfig; //this.getParentAppConfig('rock-entity-family', '', this.entityType);
            var reqParams = {  
                        "query":{  
                            "filters":{  
                            },
                            "contexts":[  
                                {  
                                "taxonomy":"Product Setup Taxonomy"
                                }
                            ],
                            "valueContexts":[  
                                {  
                                "source":"internal",
                                "locale":"en-US"
                                }
                            ]
                        },
                        "fields":{  
                        },
                        "options":{  
                            "maxRecords":1
                        }
                }
            //assign entity ID
            var req = {params:reqParams};
            
            req.params.fields.attributes = [reqData.attribute];
            req.params.fields.relationships = reqData.whereUsedRelationshipNames;
            req.params.fields.relationshipAttributes = reqData.whereUsedRelationshipAttributes;

            var relationshipsCriterion = [];
            var relCriterion = {};
            var relTo = {
                "relTo":{
                    id:reqData.id,
                    type:reqData.type
                }
            }
            for (var i = 0; i < reqData.whereUsedRelationshipNames.length; i++) {
                var relationship = reqData.whereUsedRelationshipNames[i]; 
                relCriterion[relationship] = relTo;
                relationshipsCriterion.push(relCriterion);
            }
            
            req.params.query.filters.typesCriterion = reqData.whereUsedTypesCriterion;

            req.params.query.filters.relationshipsCriterion = relationshipsCriterion;
            
            return req;
            
        },
        _getOwnedRelationshipsRequest:function(reqData){
            var req = DataRequestHelper.createEntityGetRequest(this.contextData);
            if(req && req.params){
                //assign entity ID
                req.params.query.ids = [reqData.id];
                //assign entity type
                req.params.query.filters.typesCriterion = [reqData.type];

                req.params.fields.attributes = [reqData.attribute];
                req.params.fields.relationships = reqData.ownedRelationshipNames;
                req.params.fields.relationshipAttributes = reqData.ownedRelationshipAttributes;
                req.params.fields.relatedEntityAttributes = reqData.ownedRelationshipAttributes;
                
            }
            return req;
        },
        _parseNodeTitle: function(_title){
            if(_title && (_title.indexOf("attribute:") > -1)){
                return _title.substr(10, _title.length);
            }
            return "";
        },
        _getNodeTitle: function(entity, attribute){
            var _title = "";
            if(entity){
                if(attribute.indexOf("attribute:") > -1){
                    var _keyName = attribute.substr(10, attribute.length);
                    var _attribute;
                    if(entity.data){
                        _attribute = EntityHelper.getAttribute(entity, _keyName);
                    }else{
                        if(entity.attributes && entity.attributes[_keyName]){
                            _attribute = entity.attributes[_keyName];
                        }
                    }
                    _title = AttributeHelper.getFirstAttributeValue(_attribute);
                }else{
                    _title = attribute;
                }
            }
            return _title;
        },
        _updateNodeTitle: function(_title){
            this._graphData.text = _title;
            this._graphData.expanded = true;
        },
        _refreshGraphTree: function(){
            this._graphs = [];
            this._graphs = [this._graphData];
        }
    })
})();

</script>
</dom-module>