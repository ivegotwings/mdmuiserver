<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<link rel="import" href="../pebble-tree/pebble-tree.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="entity-graph-tree-datasource.html">



<dom-module id="rock-entity-graph-tree">
    <template>
         <style>
             :host{           
                --pebble-tree: {
                    padding-right: 20px;
                    padding-left: 20px;
                };
                --pebble-tree-node:{
                    padding-top: 0px;
                    padding-bottom: 0px;
                    margin-top: 0;
                    margin-bottom: 0;
                };
                --pebble-tree-node-list: {
                    padding-top: 5px;
                    padding-bottom: 5px;
                };
                --pebble-tree-node-nodetext:{
                    font-size: var(--font-size-sm, 12px);
                    font-weight: var(--font-medium, 500);
                    color: var(--buttontext-color, #616161);
                    text-align:left;
                    display: -webkit-box;
                    display: -webkit-flex;
                    display: -ms-flexbox;
                    display: flex;
                    align-items: flex-start;
                    -webkit-align-items: flex-start;
                    margin-left:5px;
                }
                --pebble-tree-node-pagination-button:{
                    font-size: var(--font-size-sm, 12px);
                    font-weight: var(--font-medium, 500);
                    text-align:left;
                    display: -webkit-box;
                    display: -webkit-flex;
                    display: -ms-flexbox;
                    display: flex;
                    align-items: flex-start;
                    -webkit-align-items: flex-start;
                }
                --pebble-tree-node-holder: {
                    position: relative;
                }
             }
         </style>
        <liquid-entity-model-get id="liquidModeleGet" operation="searchandget" request-data="[[_modelRequest]]" on-response="_onModelReceived" on-error="_onModelGetFailed"></liquid-entity-model-get>
        <liquid-entity-data-get id="titleAttributeGet" operation="getbyids" request-data="[[_titleRequest]]" on-response="_onTitleAttributesGetResponse"></liquid-entity-data-get>

        <entity-graph-tree-datasource where-used-request="{{_whereUsedRequest}}" where-used-data-source="{{_whereUsedDataSource}}" 
                owned-relationships-request="{{_ownedRelationshipsRequest}}" owned-data-source="{{_ownedDataSource}}"></entity-graph-tree-datasource>
        
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <pebble-tree id="tree" leaf-node-only="[[leafNodeOnly]]" data="{{_graphs}}" default-child-depth="10" multi-select="[[multiSelect]]" expand-collapse-icon-object="[[_expandCollapseIconObject]]"></pebble-tree>
    </template>
<script>
(function(){
    Polymer({
        is: "rock-entity-graph-tree",
        properties:{
            contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            treeConfig: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            leafNodeOnly:{
                type:Boolean,
                value:true
            },
            _graphs: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            _graphData:{
                type:Object,
                value: function(){
                    return {};
                }
            },
            _selectedItems: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            _selectedItem: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            multiSelect:{
                type:Boolean,
                value:false
            },
            _currentNode:{
                type:Object,
                value: function(){
                    return {};
                }
            },
            _whereUsedRequest:{
                type:Object,
                value:function(){
                    return {}
                }
            },
            _whereUsedDataSource:{
                type:Object,
                notify:true
            },  
            _ownedDataSource:{
                type:Function,
                notify:true
            },
            _ownedRelationshipsRequest:{
                type:Object,
                notify:true
            },
            _currentNodeData:{
                type:Object
            },
            itemData:{
                type:Object,
                value: function() {
                    return {};
                },
                notify:true
            },
            _modelRequest:{
                type:Object
            },
            _titleRequest:{
                type:Object,
                value:function(){
                    return {}
                }
            },
            _entityModels:{
                type:Array,
                value:function(){
                    return []
                }
            },
            _pageSize:{
                type:Number,
                value:10
            },
            _selectedNode:{
                type:Object
            },
            _pebbleTree:{
                type:Element
            },
            _loading: {
                type: Boolean,
                value: false
            },
            _expandCollapseIconObject:{
                type:Object,
                value:function(){
                    return {
                        expand:"pebble-icon:action-expand",
                        collapse:"pebble-icon:action-scope-take-selection"
                    }
                }
            }
        },
        behaviors: [
            RUFBehaviors.UIBehavior
        ],
        listeners: {
            'tree-node-expanded': '_treeNodeExpanded',
            'tree-node-clicked': '_treeNodeClicked',
            'node-search-updated': '_nodeSearchUpdated',
            'node-pagination-handler':'_nodePaginationHandler'
        },
        ready: function(){
            this._loading = true;
            this._pebbleTree = this.shadowRoot.querySelector("#tree");
            if(!_.isEmpty(this.treeConfig)){
                this.treeConfig.id = DataHelper.getParamValue('id');
                this.treeConfig.type = DataHelper.getParamValue('type');

                if(this.treeConfig.pageSize){
                    this._pageSize = this.treeConfig.pageSize;
                }

                var entityModelElement = this.shadowRoot.querySelector("#liquidModeleGet");
                if(entityModelElement){
                    this._modelRequest = this._getModelRequest();
                    entityModelElement.generateRequest();
                }
            }
            
        },
        _initiateGraphTree: function(_title){
            var graphData = DataHelper.cloneObject(this.treeConfig); 
            graphData.text = _title; 
            this._updateConfigWithGraphModel(graphData);
            graphData.expanded = true;
            graphData.viewMode = "";
            graphData.value = _title;
            graphData.highlightNode = true;
            graphData.children = graphData.relationships;
            graphData.dataLoaded = true;
            this._graphData = {};
            this._graphData = graphData;
            // this._currentNodeData = this._graphData;
            this._graphs = [this._graphData];
            this._loading = false;
        },
        _initiateTitleGet: function(){
            var titleAttributeGet = this.shadowRoot.querySelector("#titleAttributeGet");
            if(titleAttributeGet){
                if (this.contextData && this.contextData.ItemContexts && this.contextData.ItemContexts.length > 0) {
                    var itemContext = this.contextData.ItemContexts[0];
                    //add attribute names in item context
                    var attribute = this._parseNodeTitle(this.treeConfig.treeNodeTitle);
                    if(attribute){
                        itemContext.attributeNames = [attribute];
                    }
                    this._titleRequest = DataRequestHelper.createEntityGetRequest(this.contextData);
                    titleAttributeGet.generateRequest();
                }
            }
        },
        _onTitleAttributesGetResponse:function(ev){
            if(ev && ev.detail && ev.detail.response){
                const res = ev.detail.response;
                if(!_.isEmpty(res)){
                    var entityValidation = DataHelper.validateGetEntitiesResponse(res);
                    if(entityValidation){
                        var ent_id = DataHelper.getParamValue('id');
                        var entity = DataHelper.findEntityById(res.content.entities, this.treeConfig.id);
                        if(entity){
                            var nodeTitle = this.treeConfig.treeNodeTitle;
                            var attribute = this._parseNodeTitle(this.treeConfig.treeNodeTitle);
                            if(attribute){
                                nodeTitle = this._getNodeTitle(entity, this.treeConfig.treeNodeTitle);
                            }
                            this.treeConfig.title = nodeTitle;
                            this._initiateGraphTree(nodeTitle);
                        }
                    }
                }
            }
           
        },
        _treeNodeExpanded: function (e) {
            this._currentNode = e.detail;
            if (this._currentNode.nodeData && !this._currentNode.nodeData.dataLoaded) {
                this._currentNodeData = this._currentNode.nodeData;
                this._executeRequest();
                this._currentNode.startLoading();
            }
        },
        _treeNodeClicked: function (e){
            if(e && e.detail && e.detail.data){
                var node = e.detail.data;
                if(node.nodeData){
                    if(this._selectedNode){
                        this._selectedNode.highlightNode = false;
                    }
                    this._selectedNode = e.detail.data;
                    this._selectedNode.highlightNode = true;

                    this.itemData = {};
                    this.itemData = node.nodeData;
                }else{
                    this.itemData = {}
                }
            }
            
        },
        _nodeSearchUpdated: function(ev){

            if(ev.detail && ev.detail.query){
                var _searchQuery = ev.detail.query;
                //console.log(ev.detail)
            }
        },
        _nodePaginationHandler: function(ev){
            if(ev && ev.detail && ev.detail.data && ev.detail.data.nodeData){
                var nodeData = ev.detail.data.nodeData;
                this._currentNodeData = nodeData;
                if(ev.detail.mode){
                    var mode = ev.detail.mode;
                    if(mode == "NEXT"){
                        this._currentNodeData.page++;
                    }else if(mode == "PREV"){
                        this._currentNodeData.page--;
                    }
                    this._executeRequest();
                    this._currentNode = ev.detail.data;
                    this._currentNode.startLoading();
                }
            }
        },
        _getModelRequest: function(){
            if(_.isEmpty(this.treeConfig))
            {
                return;
            }
            var params = {
                            "query": {
                                
                                "filters": {
                                    "typesCriterion": [
                                        "entityGraphModel"
                                    ]
                                }
                            },
                            "fields": {
                                "relationships": []
                            },
                            "options": {
                                "maxRecords": 200
                            }
                        }
            var relationships = [];
            function getRelationshipName(_obj){
                if(_obj && !_.isEmpty(_obj)){
                    if(_obj.relationshipName){
                        relationships.push(_obj.relationshipName);
                    }
                    if(_obj.relationships && _obj.relationships.length > 0){
                        for (let i = 0; i < _obj.relationships.length; i++) {
                            const rel = _obj.relationships[i];
                            getRelationshipName(rel);
                        }
                    }
                }
            }
            getRelationshipName(this.treeConfig);
            params.fields.relationships = relationships;
            var req = {params:params};
            return req;
        },
        _onModelReceived: function(ev){
            if(ev && ev.detail && ev.detail.response){
                const res = ev.detail.response;
                if(res.content && (res.status == "success")){
                    if(res.content.entityModels){
                        this._entityModels = [];
                        this._entityModels = res.content.entityModels;
                        this._initiateTitleGet();
                    }
                   
                }
            }
        },
        _updateConfigWithGraphModel: function(relObj){
            if(relObj && !_.isEmpty(relObj) && relObj.type){
                var modelId = relObj.type+"_entityGraphModel";
                var entity = DataHelper.findEntityById(this._entityModels, modelId);
                if(entity){
                    if(relObj.relationships){
                        for (var i = 0; i < relObj.relationships.length; i++) {
                            var relationship = relObj.relationships[i];
                            
                            if(relationship && relationship.relationshipName){
                                var _relationshipDataArray = EntityHelper.getRelationshipByType(entity, null, relationship.relationshipName, true);
                                if(_relationshipDataArray && _relationshipDataArray.length > 0){
                                    var _relProperties = _relationshipDataArray[0].properties;
                                    if(_relProperties.externalName){
                                        relationship.displayName = "All "+_relProperties.externalName+" of ";
                                    }
                                    if(relObj.title){
                                        relationship.text = relationship.displayName + relObj.title;
                                    }
                                    // relationship.searchNode = true;
                                    if(_relProperties.relationshipOwnership){
                                        relationship.relationshipOwnership = _relProperties.relationshipOwnership;
                                    }
                                    if(_relProperties.relatedEntityInfo && _relProperties.relatedEntityInfo.length > 0){
                                        relationship.type = _relProperties.relatedEntityInfo[0].relEntityType;
                                    }
                                    if(relObj.id){
                                        relationship.id = relObj.id;
                                    }
                                    if(relObj.id){
                                        relationship.parentType = relObj.type;
                                    }
                                    if(relationship.treeNodeTitle){
                                        relationship.attribute = this._parseNodeTitle(relationship.treeNodeTitle);
                                    }
                                    relationship.page = 0;
                                    relationship.dataLoaded = false;
                                }
                                this._updateConfigWithGraphModel(relationship);
                            }
                        
                        }   
                        // relObj.children = relObj.relationships;
                        relObj.attribute = this._parseNodeTitle(relObj.treeNodeTitle);
                        relObj.page = 0;
                        relObj.dataLoaded = false;
                    }
                    relObj.viewMode = "GRID";
                }
            }
        },
        _onModelGetFailed:function(e){
            //Need to log error
        },
        _updatePaginationNode:function(){
            if(this._currentNode && !_.isEmpty(this._currentNodeData)){
                if(this._currentNodeData.totalCount > this._pageSize){
                    // this._currentNode.searchNode = true;
                    var nextTitle = "";
                    var prevTitle = "";
                    var startIndex = ((this._currentNodeData.page+1)*this._pageSize) + 1; 
                    var endIndex = (startIndex + this._pageSize - 1);
                    if(startIndex <= this._currentNodeData.totalCount){
                        if(endIndex > this._currentNodeData.totalCount){
                            endIndex = this._currentNodeData.totalCount;
                        }
                        if(endIndex <= this._currentNodeData.totalCount){
                            nextTitle = "Next ( "+startIndex+" - "+endIndex+" / "+ this._currentNodeData.totalCount+" )";
                        }
                    }
                    
                    if(startIndex > (this._pageSize+1)){
                        startIndex = ((this._currentNodeData.page-1)*this._pageSize)+1;
                        prevTitle = "Previous ( "+(startIndex)+" - "+(startIndex+this._pageSize-1)+" / "+ this._currentNodeData.totalCount+" )";
                    }
                    if(this._currentNodeData.maxRecords){
                        if((((this._currentNodeData.page+1) * this._pageSize) % this._currentNodeData.maxRecords) == 0){
                            nextTitle = "";
                        }
                    }
                    this._currentNode.paginationObj = {nextTitle:nextTitle, prevTitle:prevTitle};
                }else{
                    this._currentNode.paginationObj = {};
                }
            }
        },
        _executeRequest: function(){
            if(this._currentNodeData){     
                if(this._currentNodeData.relationshipOwnership && (this._currentNodeData.relationshipOwnership == "owned")){
                    //For owned
                    this._ownedRelationshipsRequest = this._getRelationshipsRequest();
                    this._ownedDataSource({page:this._currentNodeData.page, pageSize:this._pageSize}, this._onOwnedRelationshipsResponse.bind(this), this._onOwnedDataSourceError.bind(this))
                }else{
                    //For whereUsed 
                    this._whereUsedRequest = this._getRelationshipsRequest();
                    var whereUsedOptions = {
                        page:this._currentNodeData.page, 
                        pageSize:this._pageSize,
                        initResponse:this._currentNodeData.initResponse
                    }
                    this._whereUsedDataSource(whereUsedOptions, this._onWhereUsedRelationshipsResponse.bind(this), this._onWhereUsedDataSourceError.bind(this));
                }
            }
        },
        _getRelationshipsRequest: function(){
            var req = DataRequestHelper.createEntityGetRequest(this.contextData);
            if(req && req.params){
                 
                req.params.fields.attributes = [this._currentNodeData.attribute];
                req.params.fields.relationships = [this._currentNodeData.relationshipName];
                req.params.fields.relationshipAttributes = [this._currentNodeData.attribute];
                req.params.fields.relatedEntityAttributes = [this._currentNodeData.attribute];

                if(this._currentNodeData.relationshipOwnership == "whereused"){                
                    //Where used criterion
                    var relationshipsCriterion = [];
                    var relCriterion = {};
                    var relTo = {
                        "relTo":{
                            id:this._currentNodeData.id,
                            type:this._currentNodeData.parentType
                        }
                    }
                    relCriterion[this._currentNodeData.relationshipName] = relTo;
                    relationshipsCriterion.push(relCriterion);
                    req.params.query.filters.relationshipsCriterion = relationshipsCriterion;
                    req.params.query.filters.typesCriterion = [this._currentNodeData.type];
                    delete req.params.query.ids;
                }else{
                    //assign entity ID
                    req.params.query.ids = [this._currentNodeData.id];
                    //assign entity type
                    req.params.query.filters.typesCriterion = [this._currentNodeData.parentType];
                }
                delete req.params.query.id;
            }
            return req;
        },
        _onOwnedRelationshipsResponse: function(res){
            if(!_.isEmpty(res)){
                var entityValidation = DataHelper.validateGetEntitiesResponse(res);
                if(entityValidation){
                    var entity = DataHelper.findEntityById(res.content.entities, this._currentNodeData.id);
                    if(entity){
                        
                        var tempArray = [];
                        var _relationshipDataArray = EntityHelper.getRelationshipByType(entity, null, this._currentNodeData.relationshipName, true);
                        if(_relationshipDataArray && _relationshipDataArray.length > 0){
                            _relationshipDataArray.forEach(function(_relTo) {
                                if(_relTo && _relTo.relTo){
                                    var _relToObj = _relTo.relTo;
                                    _relToObj.text = this._getNodeTitle(_relToObj, this._currentNodeData.treeNodeTitle);
                                    _relToObj.value = _relToObj.text;
                                    _relToObj.viewMode = "QUICK_MANAGE";
                                    _relToObj.parentType = this._currentNodeData.type;
                                    _relToObj.dataLoaded = true;

                                    var configRelationships = [];
                                    if(this._currentNodeData.relationships && this._currentNodeData.relationships.length > 0){
                                        for (let i = 0; i < this._currentNodeData.relationships.length; i++) {
                                            const rel = DataHelper.cloneObject(this._currentNodeData.relationships[i]);
                                            rel.id = _relToObj.id;
                                            rel.text = rel.displayName + _relToObj.text;
                                            configRelationships.push(rel);
                                        }
                                        _relToObj.relationships = configRelationships;
                                        _relToObj.children = configRelationships;
                                    }
                                    tempArray.push(_relToObj);
                                }
                            }, this);
                            this._currentNodeData.children = [];
                            this._currentNodeData.children = tempArray;
                        }

                        if(entity.relationshipsTotalCount){
                            if(entity.relationshipsTotalCount[this._currentNodeData.relationshipName]){
                                this._currentNodeData.totalCount = entity.relationshipsTotalCount[this._currentNodeData.relationshipName];
                            }
                            this._updatePaginationNode();
                        }

                    }
                }
            }
            this._currentNodeData.dataLoaded = true;
            if(this._currentNode && this._currentNode.refreshChildList){
                this._currentNode.refreshChildList();
            }
            if(this._selectedNode){
                this._selectedNode.refreshChildList();
            }
        },
        
        _onWhereUsedRelationshipsResponse: function(res){
            if(res && !_.isEmpty(res) && res.result){
                var entityValidation = DataHelper.validateGetEntitiesResponse(res.result);
                if(entityValidation && res.result.content && res.result.content.entities){
                    var entities = res.result.content.entities;
                    var tempArray = [];
                    entities.forEach(function(entity) {
                        if(entity){
                            entity.text = this._getNodeTitle(entity, this._currentNodeData.treeNodeTitle);
                            entity.value = entity.text;
                            entity.viewMode = "QUICK_MANAGE";
                            entity.parentType = this._currentNodeData.type;
                            entity.dataLoaded = true;

                            var configRelationships = [];
                            if(this._currentNodeData.relationships && this._currentNodeData.relationships.length > 0){
                                for (let i = 0; i < this._currentNodeData.relationships.length; i++) {
                                    const rel = DataHelper.cloneObject(this._currentNodeData.relationships[i]);
                                    rel.id = entity.id;
                                    rel.text = rel.displayName + entity.text;
                                    configRelationships.push(rel);
                                }
                                entity.relationships = configRelationships;
                                entity.children = configRelationships;
                            }
                            tempArray.push(entity);
                        }
                    }, this);
                    this._currentNodeData.children = [];
                    this._currentNodeData.children = tempArray;   
                }
                if(res.totalCount){
                    this._currentNodeData.totalCount = res.totalCount;
                    this._updatePaginationNode();
                }
                if(res.initResponse){
                    this._currentNodeData.initResponse = res.initResponse;
                }
                if(res.maxRecords){
                    this._currentNodeData.maxRecords = res.maxRecords;
                }
            }
            this._currentNodeData.dataLoaded = true;
            this._currentNode.refreshChildList();
            if(this._selectedNode){
                this._selectedNode.refreshChildList();
            }
        },
        _onOwnedDataSourceError: function(ev){
        },
        _onWhereUsedDataSourceError: function(ev){
        },
        _parseNodeTitle: function(_title){
            if(_title && (_title.indexOf("attribute:") > -1)){
                return _title.substr(10, _title.length);
            }
            return "";
        },
        _getNodeTitle: function(entity, attribute){
            var _title = "";
            if(entity){
                if(attribute.indexOf("attribute:") > -1){
                    var _keyName = attribute.substr(10, attribute.length);
                    var _attribute;
                    if(entity.data){
                        _attribute = EntityHelper.getAttribute(entity, _keyName);
                    }else{
                        if(entity.attributes && entity.attributes[_keyName]){
                            _attribute = entity.attributes[_keyName];
                        }
                    }
                    _title = AttributeHelper.getFirstAttributeValue(_attribute);
                }else{
                    _title = attribute;
                }
            }
            if(!_title && entity.id){
                _title = entity.id;
            }
            return _title;
        },
        reRenderTreeChildList: function(){
            if(this._selectedNode){
                this._currentNodeData = this._selectedNode.nodeData;
                this._currentNodeData.children = [];
                this._executeRequest();
                this._selectedNode.startLoading();
            }
        },
        // _refreshGraphTree: function(){
        //     this._graphs = [];
        //     this._graphs = [this._graphData];

        //     if(this._pebbleTree && this._selectedNode && this._selectedNode.valuePath){
        //         this._selectedNode = this._pebbleTree.getElementNodeByPath(this._selectedNode.valuePath);
        //         this._selectedNode.highlightNode = true;
        //     }
        // }
    })
})();
</script>
</dom-module>