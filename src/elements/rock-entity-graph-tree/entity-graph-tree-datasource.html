<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-grid-datasource-behavior/bedrock-grid-datasource-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="entity-graph-tree-datasource">
    <template>
        <liquid-entity-data-get id="ownedRelationships" operation="getbyids" request-data="{{ownedRelationshipsRequest}}" exclude-in-progress></liquid-entity-data-get>

        <liquid-entity-data-get id="initiateSearch" operation="initiatesearch" request-data="{{whereUsedRequest}}" last-response="{{initiateSearchResponse}}"
                on-error="_onSearchError" exclude-in-progress></liquid-entity-data-get>
        <liquid-entity-data-get id="getSearchResultDetail" operation="getsearchresultdetail" request-data="{{whereUsedRequest}}" request-id="[[initiateSearchResponse.content.requestId]]"
                last-response="{{searchResultResponse}}" on-error="_onSearchError" exclude-in-progress></liquid-entity-data-get>
    </template>
    <script>
        Polymer({
            is: 'entity-graph-tree-datasource',
            properties: {
                
                _ownedOptions: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                _whereUsedOptions: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                response:{
                    type:Object,
                    value: function () {
                        return {}
                    }
                },
                whereUsedRequest:{
                    type:Object,
                    value: function () {
                        return {}
                    }
                },
                whereUsedDataSource:{
                    type: Object,
                    notify: true
                },
                _ownedRelationshipsElement:{
                    type:Object
                },
                ownedDataSource:{
                    type: Object,
                    notify: true
                },
                ownedRelationshipsRequest:{
                    type:Object,
                    notify: true
                },
                _liquidInitSearchElement:{
                    type:Object
                },
                _liquidGetSearchElement:{
                    type:Object
                }
            },

            behaviors: [
                RUFBehaviors.GridDataSourceBehavior
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._ownedRelationshipsElement = this.shadowRoot.querySelector("#ownedRelationships");

                this._liquidInitSearchElement = this.shadowRoot.querySelector("#initiateSearch");
                this._liquidGetSearchElement = this.shadowRoot.querySelector('#getSearchResultDetail');

                this.ownedDataSource = this._ownedDataSource.bind(this);
                
                this.whereUsedDataSource = this._whereUsedDataSource.bind(this);
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            resetDataSource: function() {
                this._resetDataSource();
            },

            _ownedDataSource: function(options, success, error){
                if (_.isEmpty(this.ownedRelationshipsRequest)) {
                    return;
                }
                DataHelper.oneTimeEvent(this._ownedRelationshipsElement, 'response', this._onOwnedRelationshipsReponse
                        .bind(this, success, error));

                // Set Options
                this._ownedOptions = options;

                var requestOptions = this._prepareRequestOptions(options);
                this.set("ownedRelationshipsRequest.params.options", requestOptions);

                this._ownedRelationshipsElement.generateRequest();
            },
            _onOwnedRelationshipsReponse: function(success, error, ev){
                if(ev && ev.detail && ev.detail.response){
                    if(ev.detail.response.status == "success"){
                        success(ev.detail.response)
                    }
                }
            },
            _whereUsedDataSource: function (options, success, error) {
                if (_.isEmpty(this.whereUsedRequest)) {
                    return;
                }
                DataHelper.oneTimeEvent(this._liquidInitSearchElement, 'response', this._onInitSearchResponse.bind(
                    this));

                DataHelper.oneTimeEvent(this._liquidGetSearchElement, 'response', this._onGetSearchResponse.bind(
                    this, success, error));

                this._error=error;
                // Set Options
                this._whereUsedOptions = options;

                // Set Range
                var requestOptions = this._prepareRequestOptions(this._whereUsedOptions);
                this.set("whereUsedRequest.params.options", requestOptions);

                if(options.initResponse){
                    this.set("initiateSearchResponse", options.initResponse);
                    this._liquidGetSearchElement.generateRequest();
                }else{
                    // Make Request
                    this._liquidInitSearchElement.generateRequest();
                }
            },
            _onInitSearchResponse: function(e){
                var liqGetSearchResultDetail = this.shadowRoot.querySelector('#getSearchResultDetail');
                if(liqGetSearchResultDetail){
                    liqGetSearchResultDetail.generateRequest();
                }
            },
            _onGetSearchResponse: function (success, error) {
                if (this.searchResultResponse.status == "success") {
                    var searchResults = this._formatResponse(this.searchResultResponse);
                    if (typeof (searchResults) == 'undefined') {
                        searchResults = [];
                    }

                    // UpdateCurrent RecordSize
                    this._updateCurrentRecordSize(this._whereUsedOptions, searchResults, this._totalCount,this._resultRecordSize);

                    var totalRecords = 0;
                    var maxRecords = 0;
                    if(this.initiateSearchResponse && this.initiateSearchResponse.content){
                        totalRecords = this.initiateSearchResponse.content.totalRecords;
                        maxRecords = this.initiateSearchResponse.content.maxRecords;
                    }
                    var resObj = {totalCount:totalRecords, result:searchResults, initResponse:this.initiateSearchResponse, maxRecords:maxRecords}
                    // Invoke Callback
                    success(resObj);
                    
                } else {
                    error();
                }
            
            },
            _onSearchError:function () {
                this._error();
            }
        });
    </script>
</dom-module>