<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../pebble-templatizer/pebble-templatizer.html">

<dom-module id="rock-cms-viewer">
    <template>
        <liquid-entity-model-composite-get id="compositeAllModelGet" on-entity-model-composite-get-response="_onCompositeAllModelGetResponse"
            on-error="_onCompositeAllModelGetError"></liquid-entity-model-composite-get>
        <liquid-entity-data-get id="entityGetDataService" operation="getbyids" apply-locale-coalesce="true" on-response="_onEntityDataGetReceived"
            on-error="_onEntityDataGetFailed" data-index="entityData" data-sub-index="data"></liquid-entity-data-get>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'rock-cms-viewer',

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _entityType: {
                        type: String,
                        value: ''
                    },
                    _entityId: {
                        type: String,
                        value: ''
                    },
                    _renderCms: {
                        type: Boolean,
                        value: false,
                        observer: "_isReadyToRender"
                    }
                },

                behaviors: [],

                ready() {},

                _isReadyToRender: function (readyToRender) {
                    if (readyToRender) {
                        this.compositeModelGet();
                    }
                },

                compositeModelGet: function () {
                    let clonedContextData = DataHelper.cloneObject(this.contextData);
                    clonedContextData.ItemContexts = []
                    clonedContextData.ItemContexts.push({
                        attributeNames: ["_ALL"],
                        relationships: ["_ALL"],
                        type: this._entityType,
                    });
                    let compositeModelAllGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
                        clonedContextData);
                    if (compositeModelAllGetRequest && this.compositeAllModelGetLiq) {
                        this.compositeAllModelGetLiq.requestData = compositeModelAllGetRequest;
                        this.compositeAllModelGetLiq.generateRequest();
                    }
                },

                _onCompositeAllModelGetResponse: function (e, detail) {
                    console.log(detail.response);
                    this.entityModel = detail.response;
                    let clonedContextData = DataHelper.cloneObject(this.contextData);
                    clonedContextData.ItemContexts = []
                    clonedContextData.ItemContexts.push({
                        attributeNames: ["_ALL"],
                        relationships: ["_ALL"],
                        relationshipAttributes: ["enabled"],
                        type: this._entityType,
                        id: this._entityId
                    });

                    let req = DataRequestHelper.createEntityGetRequest(clonedContextData, true);
                    let liquidDataGet = this.entityDataGetServiceLiq;
                    liquidDataGet.requestData = req;
                    liquidDataGet.generateRequest();
                },

                _onCompositeAllModelGetError: function (e, detail) {
                    console.log(e, detail);
                },

                _onEntityDataGetReceived: function (e, detail) {
                    console.log(detail.response);
                    this._prepareModel(detail.response.content.entities[0].data, detail.response.content
                        .entities[0].properties);
                },

                _prepareModel: function (entityData, properties) {
                    let model = {};
                    let attributes = entityData.attributes;
                    let attributemodel = this.entityModel.content.entityModels[0].data.attributes;
                    if (attributemodel) {
                        /**
                         *Process Attributes
                         **/
                        Object.keys(attributes).forEach(key => {
                            model[key] = attributes[key].values.map(val => {
                                if (attributemodel[key] && attributemodel[key].properties &&
                                    attributemodel[key].properties
                                    .dataType) {
                                    const dataType = attributemodel[key].properties.dataType;
                                    if (dataType === "date" || dataType === 'datetime') {
                                        return FormatHelper.convertFromISODateTime(val.value,
                                            attributemodel[key].properties.dataType
                                        )
                                    } else {
                                        return val.value;
                                    }
                                }
                                return val.value;
                            });

                            if (model[key].length > 1) {
                                for (const [index, element] of model[key].entries()) {
                                    model[key + index] = element;
                                }
                            } else {
                                model[key] = model[key][0];
                            }
                        });

                    }

                    /**
                     *Process Relations
                     **/

                    let relationships = entityData.relationships;
                    if (relationships) {
                        Object.keys(relationships).forEach(key => {
                            model[key] = relationships[key].map(val => {
                                let returnVal = {};
                                if (val.relTo) {
                                    Object.keys(val.relTo).forEach(prop => {
                                        returnVal['prop_' + prop] = val.relTo[
                                            prop];
                                    });
                                }

                                if (val.attributes) {
                                    Object.keys(val.attributes).forEach(attr => {
                                        returnVal[attr] = val.attributes[attr].values
                                            .map(vals => {
                                                return vals.value;
                                            })
                                        if (returnVal[attr].length > 1) {
                                            for (const [index, element] of
                                                returnVal[attr].entries()) {
                                                returnVal[attr + index] =
                                                    element;
                                            }
                                        } else {
                                            returnVal[attr] = returnVal[attr][0];
                                        }
                                    });
                                }
                                return returnVal;
                            });

                            if (model[key].length > 1) {
                                for (const [index, element] of model[key].entries()) {
                                    model[key + index] = element;
                                }
                            } else {
                                model[key] = model[key][0];
                            }
                        });

                    }

                    if (properties) {
                        Object.keys(properties).forEach(key => {
                            model['prop_' + key] = properties[key];
                        });

                    }
                    console.log(model);
                },

                _onEntityDataGetFailed: function (e, detail) {
                    console.log(e, detail);
                },

                get compositeAllModelGetLiq() {
                    this._compositeAllModelGet = this._compositeAllModelGet || this.shadowRoot.querySelector(
                        "#compositeAllModelGet");
                    return this._compositeAllModelGet;
                },

                get entityDataGetServiceLiq() {
                    this._entityGetDataService = this._entityGetDataService || this.shadowRoot.querySelector(
                        "#entityGetDataService");
                    return this._entityGetDataService;
                },


            })
        })()
    </script>
</dom-module>