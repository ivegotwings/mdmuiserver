<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">

<dom-module id="rock-cms-viewer">
    <template>
        <pebble-templatizer data-model="[[dataModel]]"></pebble-templatizer>
        <liquid-entity-model-composite-get id="compositeAllModelGet" on-entity-model-composite-get-response="_onCompositeAllModelGetResponse"
            on-error="_onCompositeAllModelGetError"></liquid-entity-model-composite-get>
        <liquid-entity-data-get id="entityGetDataService" operation="getbyids" apply-locale-coalesce="true" on-response="_onEntityDataGetReceived"
            on-error="_onEntityDataGetFailed" data-index="entityData" data-sub-index="data"></liquid-entity-data-get>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'rock-cms-viewer',

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    entityType: {
                        type: String,
                        value: ''
                    },
                    entityId: {
                        type: String,
                        value: ''
                    },
                    dataModel: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                behaviors: [RUFBehaviors.AppBehavior],
                observers: ['onDataReceived(contextData, entityType, entityId)'],

                ready() {},

                onDataReceived: function (contextData, entityType, entityId) {
                    if (contextData && entityType && entityId) {
                        this.compositeModelGet();
                    }
                },

                compositeModelGet: function () {
                    let clonedContextData = DataHelper.cloneObject(this.contextData);
                    clonedContextData.ItemContexts = []
                    clonedContextData.ItemContexts.push({
                        attributeNames: ["_ALL"],
                        relationships: ["_ALL"],
                        type: this.entityType,
                    });
                    let compositeModelAllGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
                        clonedContextData);
                    if (compositeModelAllGetRequest && this.compositeAllModelGetLiq) {
                        this.compositeAllModelGetLiq.requestData = compositeModelAllGetRequest;
                        this.compositeAllModelGetLiq.generateRequest();
                    }
                },

                _onCompositeAllModelGetResponse: function (e, detail) {
                    this.entityModel = detail.response;
                    let clonedContextData = DataHelper.cloneObject(this.contextData);
                    clonedContextData.ItemContexts = []
                    clonedContextData.ItemContexts.push({
                        attributeNames: ["_ALL"],
                        relationships: ["_ALL"],
                        relationshipAttributes: ["enabled"],
                        type: this.entityType,
                        id: this.entityId
                    });

                    let req = DataRequestHelper.createEntityGetRequest(clonedContextData, true);
                    let liquidDataGet = this.entityDataGetServiceLiq;
                    liquidDataGet.requestData = req;
                    liquidDataGet.generateRequest();
                },

                _onCompositeAllModelGetError: function (e, detail) {
                    console.log(e, detail);
                },

                _onEntityDataGetReceived: function (e, detail) {
                    let model = this._prepareModel(detail.response.content.entities[0].data, detail.response
                        .content
                        .entities[0].properties);
                    this.dataModel = model;
                },

                _proccessAttributes: function (attributes, attributemodel) {
                    let model = {};
                    Object.keys(attributes).forEach(key => {
                        if (attributes[key].values) {
                            model[key] = attributes[key].values.map(val => {
                                if (attributemodel[key] && attributemodel[key].properties &&
                                    attributemodel[key].properties
                                    .dataType) {
                                    const dataType = attributemodel[key].properties
                                        .dataType;
                                    if (dataType === "date" || dataType ===
                                        'datetime') {
                                        return FormatHelper.convertFromISODateTime(
                                            val.value,
                                            attributemodel[key].properties.dataType
                                        )
                                    } else {
                                        return val.value;
                                    }
                                }
                                return val.value;
                            });
                        }
                        if (attributes[key].group) {
                            model[key] = attributes[key].group.map(val => {
                                let returnVal = {};
                                Object.keys(val).forEach(nestedVal => {
                                    if (Array.isArray(val[nestedVal].values)) {
                                        returnVal[nestedVal] = val[
                                                nestedVal].values
                                            .map(value => {
                                                return value.value;
                                            });
                                        if (returnVal[nestedVal].length > 1) {
                                            for (const [index, element] of
                                                returnVal[
                                                    nestedVal].entries()) {
                                                returnVal[nestedVal + index] =
                                                    element;
                                            }
                                        } else {
                                            returnVal[nestedVal] =
                                                returnVal[
                                                    nestedVal][0];
                                        }
                                    }
                                });
                                return returnVal;
                            });
                        }
                        model = this._generateArrayKeys(model, key);
                    });
                    return model;
                },

                _generateArrayKeys: function (model, key) {
                    if (model[key].length > 1) {
                        for (const [index, element] of model[key].entries()) {
                            model[key + index] = element;
                        }
                    } else {
                        model[key] = model[key][0];
                    }
                    return model;
                },

                _prepareModel: function (entityData, properties) {
                    let model = {};
                    let attributes = entityData.attributes;
                    let attributemodel = this.entityModel.content.entityModels[0].data.attributes;
                    if (attributemodel) {
                        /**
                         *Process Attributes
                         **/
                        model = this._proccessAttributes(attributes, attributemodel);
                    }

                    /**
                     *Process Relations
                     **/

                    let relationships = entityData.relationships;
                    if (relationships) {
                        Object.keys(relationships).forEach(key => {
                            model[key] = relationships[key].map(val => {
                                let returnVal = {};
                                if (val.relTo) {
                                    Object.keys(val.relTo).forEach(prop => {
                                        returnVal['prop_' + prop] = val.relTo[
                                            prop];
                                    });
                                }

                                if (val.attributes) {
                                    let relAttributeModel = this._proccessAttributes(
                                        val.attributes,
                                        attributemodel);
                                    returnVal = Object.assign(returnVal,
                                        relAttributeModel);
                                }
                                return returnVal;
                            });

                            model = this._generateArrayKeys(model, key);
                        });

                    }

                    if (properties) {
                        Object.keys(properties).forEach(key => {
                            model['prop_' + key] = properties[key];
                        });

                    }
                    return model;
                },

                _onEntityDataGetFailed: function (e, detail) {
                    console.log(e, detail);
                },

                get compositeAllModelGetLiq() {
                    this._compositeAllModelGet = this._compositeAllModelGet || this.shadowRoot.querySelector(
                        "#compositeAllModelGet");
                    return this._compositeAllModelGet;
                },

                get entityDataGetServiceLiq() {
                    this._entityGetDataService = this._entityGetDataService || this.shadowRoot.querySelector(
                        "#entityGetDataService");
                    return this._entityGetDataService;
                },


            })
        })()
    </script>
</dom-module>