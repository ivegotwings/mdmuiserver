<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html">

<link rel="import" href="task-error-grid-datasource.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<!--
`<rock-task-error-grid>`
<b><i>Content development is under progress... </b></i>
@group rock Elements
@element rock-task-error-grid
@demo demo/index.html
-->

<dom-module id="rock-task-error-grid">
    <template>
        <style include="bedrock-style-common"></style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <task-error-grid-datasource 
            id="errorGridDataSource" 
            request="{{request}}" 
            r-data-source="{{rDataSource}}" 
            r-data-formatter="{{rDataFormatter}}"
            buffer-record-size="{{size}}" 
            current-record-size="{{currentRecordSize}}" 
            result-record-size="{{resultRecordSize}}" 
            total-count="{{totalCount}}">
        </task-error-grid-datasource>
        <rock-grid 
            id="errorGrid" 
            selection-enabled 
            r-data-source="{{rDataSource}}" 
            r-data-source-id="errorGridDataSource" 
            config="[[gridConfig]]"
            current-record-size="{{currentRecordSize}}" 
            result-record-size="{{resultRecordSize}}" 
            grid-data-size="{{size}}"
            page-size="50" 
            selected-item="{{selectedEntity}}" 
            total-count="{{totalCount}}"
            max-configured-count="[[maxConfiguredCount]]">
        </rock-grid>
        <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="errorGrid"></bedrock-pubsub>
        <bedrock-pubsub event-name="grid-download-item" handler="_onDownload" target-id="errorGrid"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-task-error-grid',

                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    taskId: {
                        type: String,
                        value: ""
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    selectedErrorRecord: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    request: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    currentRecordSize: {
                        type: Number,
                        notify: true
                    },
                    contextData: {
                        type: Object,
                        value: function() {
                            return {};
                        },
                        observer:'_onContextDataChange'
                    },
                    rDataFormatter: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return this._formatErrorEvents.bind(this);
                        }
                    },
                    /**
                     * Indicates the number of items fetched at a time from the data-source.
                     */
                     pageSize: {
                        type: Number,
                        notify: true,
                        value: 50
                    },

                    _taskErrorConfig : {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],
                observers: [
                    '_gridConfigChanged(_taskErrorConfig,contextData,taskId)'

                ],

                _onContextDataChange: function () {
                    if(!_.isEmpty(this.contextData)) {
                        var context = DataHelper.cloneObject(this.contextData);
                        //App specific
                        var appName = ComponentHelper.getCurrentActiveAppName();
                        if(appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }
                        this.requestConfig('rock-task-error-list', context);
                    }
                },
                onConfigLoaded: function(componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        this.gridConfig = componentConfig.config.gridConfig;
                        this._taskErrorConfig = componentConfig.config;
                    }
                },
                _gridConfigChanged: function (_taskErrorConfig, contextData, taskId) {
                    if (!taskId || _.isEmpty(_taskErrorConfig) || _.isEmpty(contextData)) {
                        return;
                    }
                    var attributes = [];
                    
                    if (_taskErrorConfig.dataRequest) {
                        attributes = _taskErrorConfig.dataRequest.attributes;
                    }

                    var clonedContextData = DataHelper.cloneObject(contextData);
                    clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [{ "type": ["externalevent", "bulkoperationevent"] }];
                    var req = DataRequestHelper.createEntityGetRequest(clonedContextData);

                    req.params.fields.attributes = attributes;
                    this._attributes = attributes;

                    req.params.query.valueContexts = [
                        {
                            "locale": "en-US",
                            "source": "internal"
                        }
                    ];

                    req.params.query.filters.attributesCriterion = [
                        {
                            "taskId": {
                                "exact": this.taskId
                            }
                        },
                        {
                            "eventType": { 
                                "contains": "RECORD_TRANSFORM_ENTITY_IMPORT RECORD_PUBLISH_ENTITY_IMPORT RECORD_PUBLISH_ENTITY_EXPORT LOAD"
                            }
                        },
                        {
                            "eventSubType": { 
                                "contains": "PROCESSING_ERROR PROCESSING_COMPLETE_ERROR" 
                            }
                        }
                    ];

                    this.set('request', req);

                    this._getErrorGrid().reRenderGrid();

                    setTimeout(function () {
                        this._setGridHeight();
                    }.bind(this), 100);
                },
                _getErrorGrid: function () {
                    return ElementHelper.getElement(this, "#errorGrid");
                },
                _onSelectingGridItem: function (e, detail, sender) {
                    this.selectedErrorRecord = detail.item;
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                getSelectedItemIndex: function () {
                    return this._getErrorGrid().getSelectedItemIndex();
                },
                _setGridHeight: function () {
                    var layout = this.parentElement.parentNode.parentNode.root.querySelector('#rockLayoutContainer')
                    var rockGridHeight = 0;

                    if (layout) {
                        var footer = layout.querySelector('rock-footer');
                        rockGridHeight = layout.offsetHeight;

                        if (footer) {
                            rockGridHeight = rockGridHeight - footer.offsetHeight;
                        }
                    }

                    var rockGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid');
                    if (rockGrid && rockGridHeight > 0) {
                        if(rockGrid._getIronDataTable()){
                            rockGrid._getIronDataTable().style.height = rockGridHeight - 80 + 'px';
                        }
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                notifyResize: function () {
                    this._getErrorGrid().notifyResize();
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                scrollToIndex: function (index) {
                    this._getErrorGrid().scrollToIndex(index);
                },
                /**
                 *  Can be used to select an item.
                 */
                selectItem: function (item) {
                    this._getErrorGrid().selectItem(item);
                },

                /**
                 * Can be used to get the grid data.
                 */
                getData: function () {
                    return this._getErrorGrid().getData();
                },
                _formatErrorEvents: function (data) {
                    var formattedData = [];
                    if (data && data.content) {
                        var errorEvents = data.content.events;
                        var contextData = DataHelper.cloneObject(this.contextData);
                        if (errorEvents) {
                            formattedData = DataTransformHelper.transformEntitiesToSimpleSchema(errorEvents,
                                this._attributes, contextData);
                        }
                    }
                    
                    return formattedData;
                },
                _onDownload: function (e) {
                    // var rockGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid');
                    // var selectedItems = rockGrid.getSelectedItems();
                    // if (selectedItems && selectedItems.length && this.contextData) {
                    //     this._loading = true;
                    //     var clonedDataContext = DataHelper.cloneObject(this.contextData);
                    //     var itemContext = {};
                    //     itemContext.id = [];
                    //     itemContext.type = [];

                    //     selectedItems.forEach(function (item) {
                    //         if (item) {
                    //             itemContext.id.push(item.entityId);

                    //             if (itemContext.type.indexOf(item.entityType) == -1) {
                    //                 itemContext.type.push(item.entityType);
                    //             }
                    //         }
                    //     }, this);

                    //     itemContext.attributeNames = ["_ALL"];
                    //     itemContext.relationships = ["_ALL"];
                    //     itemContext.relationshipAttributes = ["_ALL"];
                    //     clonedDataContext[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                    //     var req = DataRequestHelper.createEntityGetRequestForDownload(clonedDataContext, ["downloadDataExcel"]);

                    //     if (req) {

                    //         req.fileName = "EntityData";
                    //         var _this = this;
                    //         RUFUtilities.fileDownload("/data/cop/downloadDataExcel", {
                    //             httpMethod: 'POST',
                    //             data: { data: JSON.stringify(req) },
                    //             successCallback: function (url) {
                    //                 this._loading = false;
                    //             }.bind(_this),
                    //             failCallback: function (responseHtml, url, error) {
                    //                 this._onCOPDownloadFailure(error);
                    //             }.bind(_this)
                    //         });
                           
                    //     }

                    // } else {
                    //     this.showInformationToast("Please select at least one error record from grid to download.");
                    // }
                }
                // _onCOPDownloadFailure: function (e) {
                //     this.showErrorToast("Failed to download error data. Please contact administrator.");
                //     this._loading = false;
                // }
            });
        })();
    </script>

</dom-module>