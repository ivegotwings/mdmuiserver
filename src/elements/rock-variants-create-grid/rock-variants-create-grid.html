<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid/remote-data.html">

<!--
` rock-variants-create-grid` Represents a component that renders all possible variants in the grid based on the selected options.

@demo demo/index.html
-->

<dom-module id="rock-variants-create-grid">
    <template>
        <style include="bedrock-style-common"></style>
        <p>You select <b>{{_attributesCountText}}</b> as possible options. We have created <b>[[totalVariantsCount]]</b> potential
            [[leafEntityDetails.entityType]] options for you. All new [[leafEntityDetails.entityType]]s in the list below will be created unless you
            want to delete the [[leafEntityDetails.entityType]]s from this list.
        </p>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_attributeModelRequest}}"
                                           on-entity-model-composite-get-response = "_onCompositeModelGetResponse">
        </liquid-entity-model-composite-get>
        <liquid-entity-data-get  id="getData" operation="getbyids" request-data="[[_request]]" last-response="{{remoteData}}"
                                 on-response="_onGetResponse">
        </liquid-entity-data-get>
        <liquid-entity-data-save name="attributeSaveDataService" operation="create" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
                                 on-response="_onSaveResponse"           ></liquid-entity-data-save>
        <liquid-entity-data-save name="attributeUpdateDataService" operation="update" request-data="{{_updateRequest}}"
                                 on-response="_onSaveResponse"></liquid-entity-data-save>
        <rock-grid title="Variant Options" id="variantGrid" data="{{data}}" config="{{gridConfig}}"
                   page-size="15"></rock-grid>
        <bedrock-pubsub event-name="delete-item" handler="_onGridDelete" target-id="variantGrid"></bedrock-pubsub>
        <div id="content-actions" align="center">
            <pebble-button class="action-button btn btn-secondary" id="skip" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                    is: 'rock-variants-create-grid',
                    properties: {
                        /**
                         * Specifies the configuration object that is passed to the grid.
                         */
                        gridConfig: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        /**
                        * Indicates the list of attributes present in the variant definition.
                        *
                        */
                        attributesList: {
                            type: Array
                        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                        variantDefinition: {
                            type: Object
                        },
                        _currentIndex: {
                            type: Number,
                            value: 0
                        },
                        //Indicates the list of "leaf entities" that are children of the parent entity.
                        leafEntities: {
                            type: Array
                        },
                        //Indicates the total possible number of variants.
                        totalVariantsCount: {
                            type: Number,
                            value: 1
                        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                        contextData: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        _childRelName:{
                            type:String,
                            value:"isChildOf"
                        }
                    },
                    behaviors: [
                        RUFBehaviors.UIBehavior,
                        RUFBehaviors.ComponentContextBehavior
                    ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    ready:function () {
                        this.gridConfig=this.getParentAppConfig('rock-variants-create-grid','','createVariantsGridConfig');
                        this.variantDefinition=this.getParentAppConfig('rock-variants-create-grid','','variantDefinitionUI');
                    },
                    observers:[
                        '_onDefinitionRender(variantDefinition,contextData,attributesList)'
                    ],
                    _onDefinitionRender: function (variantDefinition, contextData, attributesList) {
                        if(variantDefinition === undefined || contextData === undefined || attributesList === undefined){
                            return;
                        }
                        var sourceAttrs = [];
                        var targetAttrs = [];
                        var medAttrs = [];
                        var leafEntity;
                        var max = 0;
                        var variantLevels={};
                        variantLevels[0]={};
                        if (this.variantDefinition && this.variantDefinition.levels) {
                            this.variantDefinition.levels.forEach(function (level) {
                                if (level.index > max) {
                                    max = level.index;
                                    leafEntity = {index: level.index, entityType: level.entityType};
                                }
                                variantLevels[level.index]={"entityType": level.entityType,"sourceAttributes":[],"targetAttributes":[]};
                                for (var i = 0; i < level.dimensionAttributes.length; i++) {
                                    variantLevels[level.index].sourceAttributes.push(level.dimensionAttributes[i].sourceAttribute);
                                    variantLevels[level.index].targetAttributes.push(level.dimensionAttributes[i].targetAttribute);
                                    sourceAttrs.push(level.dimensionAttributes[i].sourceAttribute);
                                    targetAttrs.push(level.dimensionAttributes[i].targetAttribute);
                                    if (level.index == 1) {
                                        medAttrs.push(level.dimensionAttributes[i].targetAttribute);
                                    } else if (level.index == 2) {
                                        medAttrs.push(level.dimensionAttributes[i].sourceAttribute);
                                    }
                                }
                            });
                            this._variantLevels=variantLevels;
                            if(!this.attributesList || !this.attributesList.length) {
                                this.attributesList = sourceAttrs;
                            }
                            this._attributesIndexMapping=[this.attributesList,medAttrs,targetAttrs];
                            this.targetAttributesList = targetAttrs;
                            var columns=this.targetAttributesList.map(function (attribute) {
                                return {"header":attribute,"name":attribute}
                            });
                            this.gridConfig.tabular.columns=this.gridConfig.tabular.columns.concat(columns);
                            this.leafEntityDetails = leafEntity;
                            this._currentIndex=0;
                            var liquidGet = this.$.getData;
                            this._request = this._getGridRequest(0);
                            if (liquidGet) {
                                liquidGet.generateRequest();
                            }
                            this._getCompositeModel();
                        }
                    },
                    _getGridRequest: function (index,ids, type) {
                        var attributes=this._attributesIndexMapping[index];
                        var relatedAttributes=[];
                        if(index<this.leafEntityDetails.index){
                            relatedAttributes=this._attributesIndexMapping[index+1];
                        }
                        var req= DataRequestHelper.createEntityGetRequest(this.contextData);
                        req.params.fields.attributes = attributes;
                        req.params.fields.relationships =  [this._childRelName];
                        req.params.fields.relatedEntityAttributes= relatedAttributes;
                        if(ids) {
                            req.params.query.ids = ids;
                        }
                        if (type) {
                            req.params.query.filters.typesCriterion = [type];
                        }
                        return req;
                    },
                    _getRelatedEntities: function (entity) {
                        var relatedEntities=[];
                        if (entity && entity.data) {
                            var relationships={};
                            var ctxRelationships={};
                            if (entity.data.relationships) {
                                relationships = entity.data.relationships;
                            }
                            if (entity.data.contexts && this.contextData.contexts && this.contextData.contexts.length) {
                                ctxRelationships = SharedUtils.DataObjectFalcorUtil.getRelationshipsByCtx(entity, this.contextData.contexts[0]);
                            }
                            relationships=DataMergeHelper.mergeRelationships(relationships, ctxRelationships, true);
                            if (relationships) {
                                var isChildRelationshipEntities = relationships[this._childRelName];
                                if (isChildRelationshipEntities) {
                                    isChildRelationshipEntities.forEach(function (relationshipEntity) {
                                        if (relationshipEntity.relTo) {
                                            relatedEntities.push(relationshipEntity.relTo);
                                        }
                                    });
                                }
                            }
                        }
                        return relatedEntities;
                    },
                    _getAttributeValues: function (entity) {
                        this.attributeValues = [];
                        var text = "";
                        if (entity.data) {
                            var attributes = EntityHelper.getAllAttributes(entity);
                            var totalVariantsCount = 1;
                            this._parentEntityAttributes=attributes;
                            if(attributes) {
                                for (var i = 0; i < this.attributesList.length; i++) {
                                    var attribute = attributes[this.attributesList[i]];
                                    if (attribute && attribute.values) {
                                        var values = AttributeHelper.getAttributeValues(attribute.values, ContextHelper.getFirstValueContext(this.contextData));
                                        this.push('attributeValues', {
                                            "name": this.attributesList[i],
                                            "values": values
                                        });
                                        totalVariantsCount = totalVariantsCount * values.length;
                                        text += values.length + " " + this.attributesList[i] + " and";
                                    }
                                }
                            }
                        }
                        this._attributesCountText = text.substring(0, text.lastIndexOf("and"));
                        this.totalVariantsCount = totalVariantsCount;
                    },
                    _onGetResponse: function (e) {
                        var respData = e.detail.response;
                        if (respData) {
                            if (respData.content && respData.content.entities) {
                                var relatedEntities=[];
                                var entities = respData.content.entities;
                                if(this._currentIndex==0){
                                    var entity = entities[0];
                                    this._parentEntity=entity;
                                    this._getAttributeValues(entity);
                                    relatedEntities = this._getRelatedEntities(entity);
                                } else{
                                    for (var i = 0; i < entities.length; i++) {
                                        var entity = entities[i];
                                        var relEnts = this._getRelatedEntities(entity);
                                        relatedEntities = relatedEntities.concat(relEnts);
                                    }
                                }
                                this._currentIndex++;
                                if(relatedEntities.length) {
                                    if (this._currentIndex == this.leafEntityDetails.index) {
                                        this.leafEntities = relatedEntities;
                                        this._leafEntitiesChanged();
                                        return;
                                    } else {
                                        if (!this.entities) {
                                            this.entities = {};
                                        }
                                        this.entities[this._currentIndex] = relatedEntities;
                                    }
                                    var ids = relatedEntities.map(function (ent) {
                                        return ent.id;
                                    });
                                    var type=relatedEntities[0].type;
                                    if (ids.length > 0) {
                                        this._request = this._getGridRequest(this._currentIndex,ids, type);
                                        this.$.getData.generateRequest();
                                    }
                                } else {
                                    this.leafEntities = [];
                                    this._leafEntitiesChanged();
                                }
                            }
                        }
                    },
                    _onCancelTap: function (e) {
                        //raise event with name given for onbackAction in configuration
                        var eventName = "onBack";
                        var eventDetail = {
                            name: eventName
                        };
                        this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                    },
                    _onSaveTap: function (e) {
                        if(!(this._attributeModelsByIndex && this._attributeModelsByIndex[this.leafEntityDetails.index])){
                            return;
                        }
                        var level1Details=this._variantLevels[1];
                        var level1TargetAttrs=level1Details.targetAttributes;
                        this._entitiesToBeUpdated=[];
                        this.level1Combinations=[];
                        var entities=[];
                        var leafEntityAttributeModels=this._attributeModelsByIndex[this.leafEntityDetails.index].attributeModels;
                        for(var i in this.data) {
                            if (this.data[i]["existing"] != "New") {
                                continue;
                            }
                            var id = "e" + ElementHelper.getRandomString();
                            id += this.data[i][this.targetAttributesList[0]];
                            var attributes = [];
                            for (var x = 0; x < this.targetAttributesList.length; x++) {
                                var attributeModel;
                                if(leafEntityAttributeModels) {
                                     attributeModel = leafEntityAttributeModels[this.targetAttributesList[x]];
                                }
                                var selfContext;
                                if(attributeModel){
                                    selfContext=attributeModel.selfContext;
                                }
                                var attr = {
                                        "selfContext": selfContext,
                                        "name": this.targetAttributesList[x],
                                        "value": this.data[i][this.targetAttributesList[x]]
                                    };
                                attributes.push(attr);
                            }
                            var entity=DataTransformHelper.prepareEntityForCreate(id,this.leafEntityDetails.entityType,attributes,this.contextData,"");
                            entities.push(entity);
                            if(this.leafEntityDetails.index==2) {
                                this._relateToLevel1Entity(attributes, id);
                            }
                        }
                        this._totalSaveRequests=0;
                        this._currentSaveRequest=0;
                        this._saveRequests=[];
                        if(entities.length){
                            this._updateSaveRequestDetails(entities,"save");
                        }
                        var level1Ids=[];
                        var level1Entities=[];
                        if(this.leafEntityDetails.index==2){
                            var level1Entities=this._getLevel1Entities();
                            if (level1Entities.length) {
                                this._updateSaveRequestDetails(level1Entities,"save");
                            }
                            level1Ids=level1Entities.map(function (entity) {
                                return entity.id;
                            });
                        } else{
                            level1Ids=entities.map(function (entity) {
                                return entity.id;
                            });
                        }
                        if(this._entitiesToBeUpdated.length){
                            this._updateSaveRequestDetails(this._entitiesToBeUpdated,"update");
                        }
                        if(level1Ids.length) {
                            var selfContext;
                            if(this._attributeModelsByIndex[0] && this._attributeModelsByIndex[0].relationshipModels && this._attributeModelsByIndex[0].relationshipModels[this._childRelName]) {
                                selfContext = this._attributeModelsByIndex[0].relationshipModels[this._childRelName].selfContext;
                            }
                            var relationships = EntityHelper.getRelationshipByType(this._parentEntity, this.getFirstDataContext(),this._childRelName, selfContext);
                            var parentEntityRels = this._makeChildOfRelationshipsArray(level1Ids, level1Details.entityType);
                            relationships[this._childRelName]=parentEntityRels;
                            this._updateSaveRequestDetails([this._parentEntity],"update");
                        }

                        if(this._totalSaveRequests==0){
                            RUFUtilities.appCommon.toastText = "No changes to save";
                            var toastElement = RUFUtilities.pebbleAppToast;
                            toastElement.toastType = "information";
                            toastElement.heading = "information";
                            toastElement.autoClose = true;
                            toastElement.show();
                            var eventName = "onComplete";
                            var eventDetail = {
                                name: eventName,
                                data: this.selectedOptions
                            };
                            this.fireBedrockEvent(eventName, eventDetail, {ignoreId: true});
                        } else{
                            var requestObject=this._saveRequests[this._currentSaveRequest];
                            var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");
                            if (liquidSave) {
                                liquidSave.requestData=requestObject.request;
                                liquidSave.generateRequest();
                            }
                        }
                    },
                    _updateSaveRequestDetails:function (entities,type) {
                        this._totalSaveRequests++;
                        this._saveRequests.push({
                            "request":{
                                "entities": entities
                            },
                            "type":type
                        });
                    },
                    _makeChildOfRelationshipsArray:function (ids,childEntityType) {
                        var rels=[];
                        for(var i in ids){
                            var rel= {
                                "id": "Rel" + ElementHelper.getRandomString(),
                                "direction":"both",
                                "operation":"association",
                                "alias":"isChildOf",
                                "relTo": {
                                    "id": ids[i],
                                    "type": childEntityType
                                }
                            };
                            rels.push(rel);
                        }
                        return rels;
                    },
                    _onSaveResponse:function () {
                        this._currentSaveRequest++;
                        if(this._totalSaveRequests==this._currentSaveRequest) {
                            RUFUtilities.appCommon.toastText = "Variants Saved";
                            var toastElement = RUFUtilities.pebbleAppToast;
                            toastElement.toastType = "success";
                            toastElement.heading = "Success";
                            toastElement.autoClose = true;
                            toastElement.show();
                            var eventName = "onComplete";
                            var eventDetail = {
                                name: eventName,
                                data: this.selectedOptions
                            };
                            this.fireBedrockEvent(eventName, eventDetail, {ignoreId: true});
                        } else{
                            var requestObject=this._saveRequests[this._currentSaveRequest];
                            if(requestObject.type=="save"){
                                var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");
                                if (liquidSave) {
                                    liquidSave.requestData=requestObject.request;
                                    liquidSave.generateRequest();
                                }
                            } else {
                                var liquidUpdate = this.shadowRoot.querySelector("[name=attributeUpdateDataService]");
                                if (liquidUpdate) {
                                    liquidUpdate.requestData = requestObject.request;
                                    liquidUpdate.generateRequest();
                                }
                            }
                        }
                    },
                    _relateToLevel1Entity:function (attributes,id) {
                        var utils = SharedUtils.DataObjectFalcorUtil;
                        var level1Details=this._variantLevels[1];
                        var targetAttrs=level1Details.targetAttributes;
                        var comb={};
                        for(var i in attributes){
                            if(targetAttrs.indexOf(attributes[i].name)>-1) {
                                comb.push(attributes[i]);
                            }
                        }
                        for(var x in this.level1Combinations){
                            if(utils.compareObjects(comb,this.level1Combinations[x].attributes)){
                                this.level1Combinations[x].ids.push(id);
                                return;
                            }
                        }
                        this.level1Combinations.push({"ids":[id],"attributes":comb});
                    },
                    _checkIfMatchingEntityPresent:function (attrs,rels,selfContext) {
                        var utils = SharedUtils.DataObjectFalcorUtil;
                        var presentEntities=[];
                        if(this.entities.hasOwnProperty(1)) {
                            presentEntities=this.entities[1];
                        }
                        for(var p in presentEntities){
                            var matched=false;
                            var attributes = EntityHelper.getAllAttributes(presentEntities[p], this.contextData);
                            if(attributes) {
                                for (var i = 0; i < attrs.length; i++) {
                                    var attribute = attributes[attrs[i].name];
                                    if (attribute && attribute.values) {
                                        var values = AttributeHelper.getAttributeValues(attribute.values, ContextHelper.getFirstValueContext(this.contextData));
                                        if(utils.compareObjects(attrs[i],values[0])){
                                            continue;
                                        }
                                    }
                                    break;
                                }
                                if(i==attrs.length){
                                    matched=true;
                                }
                            }
                            if(matched){
                                var relationships = EntityHelper.getRelationshipByType(presentEntities[p], this.getFirstDataContext(), this._childRelName, selfContext);
                                relationships[this._childRelName]=rels;
                                this._entitiesToBeUpdated.push(presentEntities[p]);
                                return true;
                            }
                        }
                        return false;
                    },
                    _getLevel1Entities:function () {
                        var entities=[];
                        var level1Details=this._variantLevels[1];
                        var sourceAttrs=level1Details.sourceAttributes;
                        var targetAttrs=level1Details.targetAttributes;
                        var attributes=[];
                        for(var i in this.attributeValues){
                            var index=sourceAttrs.indexOf(this.attributeValues[i].name);
                            if(index==-1) {
                                attributes.push(this.attributeValues[i]);
                            }
                        }
                        var level1CompModels=this._attributeModelsByIndex[1];
                        var attributeModels=level1CompModels.attributeModels;
                        var relationshipModels=level1CompModels.relationshipModels;
                        var relSelfContext;
                        if(relationshipModels){
                            var relationshipModel=relationshipModels[this._childRelName];
                            if(relationshipModel){
                                relSelfContext=relationshipModel.selfContext;
                            }
                        }
                        for(var x in this.level1Combinations){
                            var comb=this.level1Combinations[x];
                            var attrs=attributes.concat(comb.attributes);
                            attrs.forEach(function (attr) {
                                var attributeModel=attributeModels[attr.name];
                                if(attributeModel) {
                                    attr.selfContext = attributeModel.selfContext;
                                }
                            });
                            var id = "e" + ElementHelper.getRandomString();
                            var rels=this._makeChildOfRelationshipsArray(comb.ids,this.leafEntityDetails.entityType);
                            var matched=this._checkIfMatchingEntityPresent(attrs,rels,relSelfContext);
                            if(matched){
                                continue;
                            }
                            var entity=DataTransformHelper.prepareEntityForCreate(id,level1Details.entityType,attrs,this.contextData,"");
                            var relationships = EntityHelper.getRelationshipByType(entity, this.getFirstDataContext(), this._childRelName, relSelfContext);
                            relationships[this._childRelName]=rels;
                            entities.push(entity);
                        }
                        return entities;
                    },
                _leafEntitiesChanged: function () {
                var data = [];
                var n = this.attributeValues.length;
                var nameArray = [];
                var valuesArray = [];
                for (var i = 0; i < n; i++) {
                    nameArray.push(this.attributeValues[i].name);
                    valuesArray.push(this.attributeValues[i].values);
                }
                if(!nameArray.length){
                    return;
                }
                var variantDefinition=this.variantDefinition;
                var targetNameArray=nameArray.map(function (name) {
                    for(var x=0;x<variantDefinition.levels.length;x++){
                        var level=variantDefinition.levels[x];
                        for (var i = 0; i < level.dimensionAttributes.length; i++) {
                            if (level.dimensionAttributes[i].sourceAttribute == name) {
                                return level.dimensionAttributes[i].targetAttribute;
                            }
                        }
                    }
                });
                var combinations = this.getAllCombinations(valuesArray);
                for (var i = 0; i < combinations.length; i++) {
                    data[i] = {};
                    for (var j = 0; j < targetNameArray.length; j++) {
                        data[i][targetNameArray[j]] = combinations[i][j];
                    }
                }
                var presentData=[];
                for(var i=0;i< this.leafEntities.length;i++){
                    var attrValues=this.getValueForAttributes(this.leafEntities[i],targetNameArray);
                    var index=data.map(function (element) {return JSON.stringify(element)})
                        .indexOf(JSON.stringify(attrValues));
                    if(index>-1){
                        data.splice(index,1);
                        attrValues['existing']='Existing';
                        presentData.push(attrValues);
                    }
                }
                for(var j=0;j<data.length;j++){
                    data[j]['existing'] ='New';
                }
                this.data = data.concat(presentData);
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            getValueForAttributes:function (entity,attributeNames) {
                var attributeValues = {};
                if (entity.data) {
                    var attributes = EntityHelper.getAllAttributes(entity);
                    if(attributes) {
                        for (var i = 0; i < attributeNames.length; i++) {
                            var attribute = attributes[attributeNames[i]];
                            if (attribute && attribute.values) {
                                var values = AttributeHelper.getAttributeValues(attribute.values, ContextHelper.getFirstValueContext(this.contextData));
                                attributeValues[attributeNames[i]]=values[0];
                            }
                        }
                    }
                }
                return attributeValues;
            },

            // Can be used to get all combinations of the multiple arrays.
            getAllCombinations: function (arraysToCombine) {
                var divisors = [];
                for (var i = arraysToCombine.length - 1; i >= 0; i--) {
                    divisors[i] = divisors[i + 1] ? divisors[i + 1] * arraysToCombine[i + 1].length : 1;
                }
                function getPermutation(n, arraysToCombine) {
                    var result = [],
                        curArray;
                    for (var i = 0; i < arraysToCombine.length; i++) {
                        curArray = arraysToCombine[i];
                        result.push(curArray[Math.floor(n / divisors[i]) % curArray.length]);
                    }
                    return result;
                }
                var numPerms = arraysToCombine[0].length;
                for (var i = 1; i < arraysToCombine.length; i++) {
                    numPerms *= arraysToCombine[i].length;
                }
                var combinations = [];
                for (var i = 0; i < numPerms; i++) {
                    combinations.push(getPermutation(i, arraysToCombine));
                }
                return combinations;
            },
            _onGridDelete: function (e, detail, sender) {
                if(detail.existing=="New") {
                    var index=this.data.indexOf(detail);
                    this.splice('data', index,1);
                    this.$.variantGrid._gridDataLoad();
                }
            },
            //TODO: right now all the selfContext is set as 1 , get attributemodels for each entityType and relationshipType and get corresponding selfContext value
            _getCompositeModel:function () {

                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                var attrNames = this.attributesList;
                if (attrNames && attrNames.length) {
                    compositeModelGetRequest.params.fields.attributes = attrNames;
                }
                compositeModelGetRequest.params.fields.relationships = [this._childRelName];
                this.set("_attributeModelRequest", compositeModelGetRequest);
                var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                this._modelIndex=0;
                if (liquidModelGet) {
                    liquidModelGet.generateRequest();
                }

            },
            _onCompositeModelGetResponse:function (e) {
                if(! this._attributeModelsByIndex){
                    this._attributeModelsByIndex={};
                }
                if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                    this._attributeModelsByIndex[this._modelIndex]={};
                    this._attributeModelsByIndex[this._modelIndex].attributeModels= DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);
                    this._attributeModelsByIndex[this._modelIndex].relationshipModels= DataTransformHelper.transformRelationshipModels(e.detail.response.content.entityModels[0], this.contextData);
                    this._modelIndex++;
                    if(this._modelIndex<=this.leafEntityDetails.index && this._variantLevels[this._modelIndex]) {
                        var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                        compositeModelGetRequest.params.query.name = this._variantLevels[this._modelIndex].entityType;
                        compositeModelGetRequest.params.fields.attributes = this._attributesIndexMapping[this._modelIndex];
                        compositeModelGetRequest.params.fields.relationships = [this._childRelName];
                        this.set("_attributeModelRequest", compositeModelGetRequest);
                        var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                        liquidModelGet.generateRequest();
                    }
                }
            }

        });
        })();
    </script>
</dom-module>