<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href "../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<!--
`rock-create-edit-saved-searches` Represents an element that displays the form to create or edit a saved search.
-->

<dom-module id="rock-create-edit-saved-searches">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex">                
                .savedSearchIcon {
                        color: #036BC3;
                        height: 20px;
                        width: 20px;
                    }
                    .title {
                        color: black;
                        font-size: 16px;
                        font-weight: bold;
                    }
                    paper-checkbox.blue {
                        --paper-checkbox-checked-color: #036BC3;
                        --paper-checkbox-unchecked-color: #7D8690;
                        --paper-checkbox-label-color: #7D8690;
                        --paper-checkbox-label-checked-color: #7D8690;
                        --paper-checkbox-size: 14px;
                    }
                    .cancel {               
                        --pebble-button: {
                                height: 40px;
                                color: #7D8690;
                                border: 1px solid #C1CAD4;
                                font-size: 14px;
                        }
                    }
                    .save {               
                        --pebble-button: {
                                height: 40px;
                                background: #0ABF21;
                                color: #FFFFFF;
                                border: 1px solid #0ABF21;
                                font-size: 14px;
                        }
                    }            
                    .buttons{
                        margin-top: 5px;
                        text-align:center;
                    }
                    .container {
                        margin: 5px 10px;
                    }
                    .marginTop5{
                        margin-top: 5px;
                    }
                    pebble-button::shadow paper-button iron-icon{
                        height: 16px !important;
                        width: 16px !important;
                        color: #036BC3 !important;
                    }
                    pebble-dropdown::shadow paper-dropdown-menu {
                        display: inline;
                    }
        </style>

<div class="veritical layout container">
    <div>
        <iron-icon class="savedSearchIcon" icon="pebble-icons:SavedSearch"></iron-icon>
        <span class="title">{{title}}</span>
    </div>
    <div>
        <pebble-dropdown id="savedSearchDropdown" label="EDIT SAVED SEARCH" items="{{savedSearchItems}}"></pebble-dropdown>
        <bedrock-pubsub on-bedrock-event-dropdown-value-change="onDropdownValueChange"></bedrock-pubsub>
    </div>
    <div>
        <paper-input id="savedSearchNameId" label="NEW SAVED SEARCH NAME" required auto-validate always-float-label error-message="required"
            value={{name}}></paper-input>
    </div>
    <div class="veritical layout marginTop5">
        <div>
            <span>Who can use this saved search?</span>
        </div>
        <div>
            <paper-checkbox data-id="self" class="blue" noink checked="{{self}}" disabled$={{selfDisabled}} on-change="_checkChanged">
                <span>Only I can use this</span>
            </paper-checkbox>
        </div>
        <div>
            <paper-checkbox data-id="allUsersSameRole" class="blue" noink checked="{{allUsersSameRole}}" disabled$={{allUsersSameRoleDisabled}}
                on-change="_checkChanged">
                <span>All Others with my role can use this</span>
            </paper-checkbox>
        </div>
        <div>
            <paper-checkbox data-id="allUsersAllRoles" class="blue" noink checked="{{allUsersAllRoles}}" disabled$={{allUsersAllRolesDisabled}}
                on-change="_checkChanged">
                <span>Everybody in my enterprise can use this</span>
            </paper-checkbox>
        </div>
    </div>
    <div class="buttons">
        <pebble-button class="cancel" button-text="Cancel" noink raised elevation="2" on-tap="_onCancelTap"></pebble-button>
        <pebble-button class="save" button-text="Save" noink raised elevation="2" on-tap="_onSaveTap"></pebble-button>
    </div>
</div>

</template>

<script>
        (function () {
            'use strict';

            Polymer({

                is: 'rock-create-edit-saved-searches',
                properties: {
                    /**
                    * Indicates the title for create/edit saved search popover.
                    */
                    title: {
                        type: String,
                        value: "Create or Edit Saved Search",
                        notify: true
                    },
                    /**
                    * Indicates the create/edit mode for saved search.
                    */
                    editMode: {
                        type: Boolean,
                        reflectToAttribute: true,
                        notify: true
                    },
                    /**
                    * Indicates the config for saved searches.
                    */
                    createEditModel: {
                        type: Array,
                        value: function () { return []; },
                        observer: '_createEditModelChanged'
                    },
                    /**
                    * Indicates all saved searches.
                    */
                    savedSearchItems: {
                        type: String,
                        value: ""

                    },
                    /**
                    * Indicates the name of the saved search.
                    */
                    name: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    /**
                    * Indicates the option 'Only I can use this' is checked or not.
                    */
                    self: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    /**
                    * Indicates the option 'All Others with my role can use this' is checked or not.
                    */
                    allUsersSameRole: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    /**
                    * Indicates if option 'Everybody in my enterprise can use this' is checked or not.
                    */
                    allUsersAllRoles: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    /**
                    * Indicates the option 'Only I can use this' is disabled or not.
                    */
                    selfDisabled: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    /**
                    * Indicates the option 'All Others with my role can use this' is disabled or not.
                    */
                    allUsersSameRoleDisabled: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    /**
                    * Indicates if option 'Everybody in my enterprise can use this' is disabled or not.
                    */
                    allUsersAllRolesDisabled: {
                        type: Boolean,
                        value: false,
                        notify: true
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                _createEditModelChanged: function () {
                    if (this.createEditModel != null && this.createEditModel.length > 0) {
                        var existingSavedSearches = [];
                        for (var i = 0; i < this.createEditModel.length; i++) {
                            existingSavedSearches.push(this.createEditModel[i].name);
                        }

                        this.savedSearchItems = existingSavedSearches.join(",");

                        this._resetControlValues();
                    }
                },
                listeners: {
                    'change': '_onDropdownChange'
                },
                _checkChanged: function (e) {
                    if (this.self) {
                        this._setFlags({ "sameRoleDisable": true, "allDisable": true, "sameRole": false, "all": false });
                    }
                    else if (this.allUsersSameRole) {
                        this._setFlags({ "selfDisable": true, "allDisable": true, "self": false, "all": false });

                    } else if (this.allUsersAllRoles) {
                        this._setFlags({ "selfDisable": true, "sameRoleDisable": true, "self": false, "sameRole": false });
                    }
                    else {
                        this._setFlags({ "selfDisable": false, "sameRoleDisable": false, "allDisable": false, "self": false, "sameRole": false, "all": false });
                    }
                },
                _onDropdownChange: function (e) {
                    if (e.path[0].id == "savedSearchDropdown" && e.detail != undefined) {
                        var selectedIndex = e.detail.newValue;

                        if (selectedIndex != -1) {
                            var dropdownElement = this.$$('pebble-dropdown');
                            var selectedValue = dropdownElement.selectedValue;

                            // Get the object for the current selected saved search                                
                            if (this.createEditModel != null && this.createEditModel.length > 0 && selectedValue != undefined) {
                                var savedSearchObject = {};
                                for (var i = 0; i < this.createEditModel.length; i++) {
                                    if (this.createEditModel[i].name == selectedValue) {
                                        savedSearchObject = this.createEditModel[i];
                                        break;
                                    }
                                }

                                // Set the values for all the controls accordingly
                                this.name = savedSearchObject.name;
                                this._setFlags({ "self": savedSearchObject.self, "sameRole": savedSearchObject.allUsersSameRole, "all": savedSearchObject.allUsersAllRoles });
                                this._setFlags({ "selfDisable": !this.self, "sameRoleDisable": !this.allUsersSameRole, "allDisable": !this.allUsersAllRoles });
                            }
                        }
                    }
                },
                _onCancelTap: function (e) {
                    this._resetControlValues();
                    this.editMode = false;
                },
                _onSaveTap: function (e) {
                    // fire the validation to check if name is given or not. If given, get the saved search name
                    var inputElement = this.$$('paper-input');
                    var flag = inputElement.validate();
                    if (!flag) {
                        return;
                    }

                    if (!this.self && !this.allUsersSameRole && !this.allUsersAllRoles) {
                        // Display a message to the users to check any one of the options
                    }
                    else {
                        var savedSearchObject = { name: this.name, self: this.self, allUsersSameRole: this.allUsersSameRole, allUsersAllRoles: this.allUsersAllRoles }
                        var eventDetail = {
                            name: 'saved-search-save',
                            data: savedSearchObject
                        }
                        this.fire('bedrock-event', eventDetail);
                        this._resetControlValues();
                        this.editMode = false;
                    }
                },
                /*
                    * Re-usable function to clear all control values
                    */
                _resetControlValues: function () {

                    var dropdownElement = this.$$('pebble-dropdown');
                    if (dropdownElement != undefined) {
                        dropdownElement.selectedValue = "";
                    }

                    //clear all the control values
                    var inputElement = this.$$('paper-input');
                    if (inputElement != undefined) {
                        this.name = "";
                        inputElement.removeAttribute("required");
                        inputElement.validate();
                        inputElement.setAttribute("required", true);
                    }

                    // checked and disabled - set to false
                    this._setFlags({ "selfDisable": false, "sameRoleDisable": false, "allDisable": false, "self": false, "sameRole": false, "all": false });
                },
                /*
                    * Re-usable function to manage checked and disabled flags of checkboxes
                    */
                _setFlags: function (flags) {
                    if (flags.self != undefined) {
                        this.self = flags.self;
                    }
                    if (flags.sameRole != undefined) {
                        this.allUsersSameRole = flags.sameRole;
                    }
                    if (flags.all != undefined) {
                        this.allUsersAllRoles = flags.all;
                    }
                    if (flags.selfDisable != undefined) {
                        this.selfDisabled = flags.selfDisable;
                    }
                    if (flags.sameRoleDisable != undefined) {
                        this.allUsersSameRoleDisabled = flags.sameRoleDisable;
                    }
                    if (flags.allDisable != undefined) {
                        this.allUsersAllRolesDisabled = flags.allDisable;
                    }
                }


            });
        })();
    </script>
</dom-module>