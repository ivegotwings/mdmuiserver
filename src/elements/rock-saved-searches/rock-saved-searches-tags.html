<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">


<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-saved-searches-tags">
    <template>
        <style include="bedrock-style-common">
            pebble-button.action {
                display: inline-block;
                border: 1px solid var(--palette-cerulean, #036bc3);
                border-radius: 3px;
                height: 30px;
                margin: 0px 7px 10px 0px;

            --pebble-button: {
                height: 30px !important;
                color: var(--palette-cerulean);
                font-size: var(--default-font-size, 14px);
            };
            --pebble-menu-button: {
                height: 30px !important;
                border-top: 1px solid var(--palette-cerulean);
                border-right: 1px solid var(--palette-cerulean);
                border-bottom: 1px solid var(--palette-cerulean);
                background: #FFFFFF;
                box-sizing: border-box;
            };
            --actions-icon-button: {
                height: 16px;
                width: 16px;
                background: #FFFFFF;
                color: var(--palette-cerulean);
                padding-top: 0px !important;
                padding-right: 0px !important;
                padding-bottom: 0px !important;
                padding-left: 0px !important;
                margin-top: 0;
                margin-right: 5px;
                margin-bottom: 0;
                margin-left: 5px;
                top: -2px;
            };
            --pebble-button-paper-menu: {
                background: #FFFFFF;
            };
            --pebble-button-paper-menu-item: {
                background: #FFFFFF;
                color: var(--palette-cerulean);
                padding-top: 0px;
                padding-right: 8px;
                padding-bottom: 0px;
                padding-left: 8px;
            };
            --paper-button-text:{
                padding-top: 0px;
                padding-right: 2px;
                padding-bottom: 0px;
                padding-left: 0px;
                max-width: 225px;
          };
        }
       
        </style>
        <template is="dom-if" if="[[_savedSearchesButtons.length]]]]">
            <template is="dom-repeat" items="[[_savedSearchesButtons]]" as="savedSearch">
                <pebble-button class="action" noink raised action-menu elevation="0" horizontal-align="right" vertical-align="top" icon="[[savedSearch.icon]]"
                    button-text="[[savedSearch.name]]" data="[[savedSearch]]" actions-data="[[_getActionData(_actionsData,savedSearch)]]" enable-ellipsis="true">>
                </pebble-button>
            </template>
        </template>        
        <template is="dom-if" if="[[!_savedSearchesButtons.length]]">
            <div class="default-message">You don't have any [[savedSearchCategory]] yet.</div>
        </template>
    </template>
    <script>
                    class RockSavedSearchesTags
                        extends Polymer.mixinBehaviors([
                        RUFBehaviors.UIBehavior,
                        RUFBehaviors.ComponentConfigBehavior
                        ], Polymer.Element) {
                        static get is() { return 'rock-saved-searches-tags' }
                        static get properties() {
                            return {
                                savedSearchCategory: {
                                    type: String
                                },

                                /**
                                 * Indicates the saved searches.
                                 */
                                savedSearches: {
                                    type: Object,
                                    notify: true,
                                    value: function () {
                                        return {}
                                    },
                                    observer: '_loadSavedSearches'
                                },

                                _savedSearchesButtons: {
                                    type: Array,
                                    notify: true,
                                    value: function () {
                                        return []
                                    },
                                },
                                _actionsData: {
                                    type: Object,
                                    notify: true,
                                    value: function () {
                                        return {}
                                    }
                                },
                                contextData: {
                                    type: Object,
                                    value: function () {
                                        return {};
                                    },
                                    observer: '_onContextDataChange'
                                }
                            }
                        }

                _onContextDataChange () {
                    if(!_.isEmpty(this.contextData)) {
                        var context = DataHelper.cloneObject(this.contextData);
                        //App specific
                        var appName = ComponentHelper.getCurrentActiveAppName();
                        if(appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }
                        this.requestConfig('rock-saved-searches-tags', context);
                    }
                }
                onConfigLoaded (componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        var actionData = componentConfig.config;
                        for(var action in actionData){
                            if(actionData[action]){
                                actionData[action] = DataHelper.convertObjectToArray(actionData[action]);
                            }
                        }
                        this._actionsData =actionData;
                    }
                }
                _loadSavedSearches () {
                    if (this.savedSearches) {
                        this._savedSearchesButtons = this.savedSearches[this.savedSearchCategory];
                    }
                }
                _getActionData (e,savedSearchesObj) {
                    //delete functionality made available only the creater of the saved search.
                    //Favourite action not needed in other tabs when search is in favourites tab
                    if(!_.isEmpty(this._actionsData)){
                        var actionsDataArray = DataHelper.cloneObject(this._actionsData[this.savedSearchCategory]);
                        var currentUser = DataHelper.getUserId();
                        if(actionsDataArray && actionsDataArray.length > 0) {
                            var maxIndex = actionsDataArray.length - 1;
                            for(var i = maxIndex; i >= 0; i--) {
                                if(actionsDataArray[i].name.toLowerCase()=='delete' && currentUser != savedSearchesObj.createdby) {
                                actionsDataArray.splice(i,1);
                                } else if(actionsDataArray[i].name.toLowerCase() == 'favourites' && savedSearchesObj.isFavourite) {
                                actionsDataArray[i].icon = "pebble-icon:bookmark";
                                }
                            }
                        }
                        return actionsDataArray;
                    }
                    
                }
            }
            customElements.define(RockSavedSearchesTags.is, RockSavedSearchesTags);

    </script>
</dom-module>