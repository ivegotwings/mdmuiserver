<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">

<link rel="import" href="rock-create-edit-saved-searches.html">

<!--
`rock-saved-searches` Represents an element that displays the saved searches.

@demo demo/index.html
-->
<dom-module id="rock-saved-searches">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex">
            /*#savedSearchButton {
                --pebble-button: {
                    height: 32px;
                    padding: 1em 0em 1em 0.3em;
                    color: #2068BD;
                    border: 1px solid #2068BD;
                    font-size: small;
                    margin: 0;
                }
                --pebble-button-dropdown-icon: {
                    height: 20px !important;
                    width: 20px !important;
                }
            }*/
            
            #newSavedSearch {
                font-weight: var(--font-bold, bold);
                font-size: var(--font-size-md, 16px);
            }
            
            #createEditSavedSearch {
                /*padding-left: 5px;*/
                --pebble-button: {
                    font-size: var(--default-font-size, 14px)!important;
                    color: #036BC3;
                }
                --pebble-button-iron-icon: {
                    height: 16px !important;
                    width: 16px !important;
                    color: #036BC3 !important;
                }
            }
            
            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: #ccc;
            }
            
            #savedSearchPopover {
                width: 530px;
            }
            
            .savedSearchLabel {
                color: black;
                font-weight: var(--font-bold, bold);
                font-size: var(--font-size-md, 16px);
                display: inline-block;
            }
            
            #createEditSavedSearch {
                float: right;
            }
            
            :root {
                --pebble-popover-max-width: 100%;
                /*--pebble-popover-max-height: 100%;*/
            }
            
            rock-tabs::shadow pebble-tab-group {
                margin-bottom: 15px;
            }
            
            rock-tabs::shadow pebble-tab-group pebble-tab {
                margin-left: 0;
            }
            
            pebble-button::shadow iron-icon[icon="icons:add"] {
                color: #036bc3!important;
                margin-top: 1px;
            }
            
            #savedSearchPopover::shadow .arrow_box {
                padding: 15px;
            }
            
            #savedSearchButton::shadow paper-button {
                font-size: var(--default-font-size, 14px);
            }
            
            #createEditSavedSearch::shadow paper-button {
                font-size: 12px !important;
            }
            
            #savedSearchPopover::shadow .arrow_box .popover {
                overflow: inherit;
            }
        </style>        
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
        <template is="dom-if" if="[[!viewMode]]">
            <pebble-button id="savedSearchButton" icon="[[icon]]" button-text="[[buttonText]]" noink raised dropdown-icon="[[dropdownIcon]]"
                on-tap="_onSavedSearchTap" class="dropdownIcon dropdownText btn dropdown-outline-primary"></pebble-button>
                <pebble-popover id="savedSearchPopover" for="savedSearchButton" auto-fit-on-attach no-overlap horizontal-align="right">
                    <template is="dom-if" if="[[!editMode]]">
                        <template is="dom-if" if="[[!viewMode]]">
                            <div id="newSavedSearch" class="m-b-20">
                                <div class="savedSearchLabel">Saved Searches</div>
                                <pebble-button icon="pebble-md-icons:Settings" class="pebble-md-icons pull-right m-l-15"></pebble-button>
                                <pebble-button id="createEditSavedSearch" icon="pebble-sm-icons:Add" button-text="Create or Edit Saved Search" noink class="pebble-sm-icons createEditSavedSearch icon"
                                    on-tap="_onCreateEditSavedSearchTap"></pebble-button>
                            </div>
                        </template>                        
                        <rock-tabs id="rock-saved-searches-tabs" config="[[_tabConfig]]" selected-tab="{{_selectedTab}}"></rock-tabs>
                    </template>
                    <template is="dom-if" if="[[editMode]]">
                        <rock-create-edit-saved-searches edit-mode="{{editMode}}" saved-search-id="[[savedSearchId]]" create-edit-model="[[savedSearches]]"></rock-create-edit-saved-searches>
                    </template>
                </pebble-popover>
        </template>
        <template is="dom-if" if="[[viewMode]]">
            <template is="dom-if" if="[[!editMode]]">
                <template is="dom-if" if="[[!viewMode]]">
                    <div id="newSavedSearch">
                        <div class="savedSearchLabel">Saved Searches</div>
                        <pebble-button id="createEditSavedSearch" icon="pebble-sm-icons:Add" button-text="Create or Edit Saved Search" noink class="pebble-sm-icons createEditSavedSearch"
                            on-tap="_onCreateEditSavedSearchTap"></pebble-button>
                    </div>
                </template>                
                <rock-tabs id="rock-saved-searches-tabs" config="[[_tabConfig]]" selected-tab="{{_selectedTab}}"></rock-tabs>
            </template>
            <template is="dom-if" if="[[editMode]]">
                <rock-create-edit-saved-searches edit-mode="{{editMode}}" saved-search-id="[[savedSearchId]]" create-edit-model="[[savedSearches]]"></rock-create-edit-saved-searches>
            </template>
        </template>
    </template>
    <script>
        (function () {
            'use strict';

            var _favSearch = 'favourites';
            var _mySearch = 'my-searches';
            var _sharedSearch = 'shared-searches';
            var tabs = { "favourites": 0, "my-searches": 1, "shared-searches": 2 };

            Polymer({

                is: 'rock-saved-searches',
                /**
                * Fired when any of the saved search is tapped in 
                * saved search widget with name: "rock-saved-search-click". Here, data is the data of the clicked saved search.
                *
                * @event bedrock-event
                */

                /**
                * Fired when user taps/clicks on save button inside Create New Saved Search popover 
                * with the name: "saved-search-save".
                *
                * @event bedrock-event	
                */
                properties: {
                    /**
                    * Indicates the config for tabs.
                    */
                    _tabConfig: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {
                                "scrollable": false,
                                "tabItems": [
                                    {
                                        "name": "favourites",
                                        "title": "Favourites",
                                        "selected": true,
                                        "enableDropdownMenu": false,
                                        "component": {
                                            "name": "rock-saved-searches-tags",
                                            "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                            "properties": {
                                                "saved-search-category": "favourites"
                                            }
                                        }
                                    },
                                    {
                                        "name": "my-searches",
                                        "title": "My Searches",
                                        "enableDropdownMenu": false,
                                        "component": {
                                            "name": "rock-saved-searches-tags",
                                            "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                            "properties": {
                                                "saved-search-category": "my-searches"
                                            }
                                        }
                                    },
                                    {
                                        "name": "shared-searches",
                                        "title": "Shared Searches",
                                        "enableDropdownMenu": false,
                                        "component": {
                                            "name": "rock-saved-searches-tags",
                                            "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                            "properties": {
                                                "saved-search-category": "shared-searches"
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    /**
                    * Indicates the create/edit mode for saved search.
                    */
                    editMode: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                        notify: true
                    },
                    /**
                    * Indicates the read-only mode for saved search. Create/Edit options will not be available for dashboard users.
                    */
                    viewMode: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },
                    /**
                    * Indicates load saved search button icon.
                    */
                    icon: {
                        type: String,
                        value: function () { return null; }

                    },
                    /**
                    * Indicates the load saved search button text.
                    */
                    buttonText: {
                        type: String,
                        value: function () { return null; },
                        reflectToAttribute: true,
                        notify: true
                    },
                    /**
                    * Indicates that the menu button will have the dropdown arrow icon
                    * if the value is set <b>true</b>.
                    */
                    dropdownIcon: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Indicates the search id which is selected by the consumer
                     */
                    savedSearchId: {
                        type: Number,
                        value: null,
                        notify: true
                    },

                    // Indicates saved searches
                    savedSearches: {
                        type: Object,
                        value: function () { return {}; },
                        notify: true,
                        observer: '_onSavedSearchesChange'
                    },

                    // Indicates saved searches
                    _allSavedSearches: {
                        type: Object,
                        value: function () { return { "favourites": {}, "my-searches": {}, "shared-searches": {} }; }
                    },

                    // Selected tab details
                    _selectedTab: {
                        type: Object,
                        value: function () { return {}; },
                        notify: true,
                        observer: '_onSelectedTabChange'
                    },
                },
                _onSavedSearchTap: function (e) {
                    this.$$('#savedSearchPopover').show();
                },
                _onCreateEditSavedSearchTap: function (e) {
                    this.editMode = true;
                    this.async(function () {
                        //This is to execute the logic for all scenarios on create/edit link on-click
                        this.$$('rock-create-edit-saved-searches').OnCreateEditButtonClick();
                    });
                },
                listeners: {
                    'tag-item-select': '_onTagItemSelect'
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                // Fired when rock-tabs creates component
                _onComponentCreating: function (e, detail, sender) {                    
                    var component = detail.data;

                    if (this.savedSearches) {
                       component.properties["saved-searches"] = this.savedSearches;
                    }
                },

                /**
                * Fired when filter tag triggers a tag-item-select event.
                */
                _onTagItemSelect: function (e) {
                    var eventData = {
                        name: "rock-saved-search-click",
                        data: e.detail
                    };
                    this.fire('bedrock-event', eventData);
                },

                // On tab change populate searches
                // Note - this will be removed once we integrated with liquid
                _onSelectedTabChange: function () {
                    if(this.$$('rock-tabs'))
                    {  
                        this.async(function(){                            
                            this.$$('rock-tabs').$$('pebble-tab-group').notifyResize();
                        }, 600); //Delayed to populate the tabs properly                        
                    }
                },                

                // On saved searches change, populate searches and select respected search tab
                _onSavedSearchesChange: function () {
                    this._populateAllSearches();

                    if (this.savedSearchId && this.$$('rock-tabs')) 
                    {
                        var listName = this._getSearchListNameBySearchId();
                        this.$$('rock-tabs').selectedTabIndex = tabs[listName];
                    }

                    if (this.$$('rock-tabs') && this.$$('rock-tabs').$$('rock-saved-searches-tags'))
                    {
                        this.$$('rock-tabs').reloadTabs();                       
                    }
                },

                // Populate all searches
                _populateAllSearches: function () {
                    if (this.savedSearches) {
                        if (this.savedSearches[_mySearch]) {
                            for (var idx = 0; idx < this.savedSearches[_mySearch].length; idx++) {
                                this._allSavedSearches[_mySearch][this.savedSearches[_mySearch][idx].id] = this.savedSearches[_mySearch][idx];
                            }
                        }

                        if (this.savedSearches[_favSearch]) {
                            for (var idx = 0; idx < this.savedSearches[_favSearch].length; idx++) {
                                this._allSavedSearches[_favSearch][this.savedSearches[_favSearch][idx].id] = this.savedSearches[_favSearch][idx];
                            }
                        }

                        if (this.savedSearches[_sharedSearch]) {
                            for (var idx = 0; idx < this.savedSearches[_sharedSearch].length; idx++) {
                                this._allSavedSearches[_sharedSearch][this.savedSearches[_sharedSearch][idx].id] = this.savedSearches[_sharedSearch][idx];
                            }
                        }
                    }

                },

                // Get search list name
                _getSearchListNameBySearchId: function () {
                    if (this._allSavedSearches[_favSearch][this.savedSearchId]) {
                        return _favSearch;
                    }

                    if (this._allSavedSearches[_mySearch][this.savedSearchId]) {
                        return _mySearch;
                    }

                    if (this._allSavedSearches[_sharedSearch][this.savedSearchId]) {
                        return _sharedSearch;
                    }
                }
            });
        })();
    </script>
</dom-module>