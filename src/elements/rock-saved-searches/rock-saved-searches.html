<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href"../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">

<!--
`rock-saved-searches` Represents an element that displays the saved searches.

@demo demo/index.html
-->
<dom-module id="rock-saved-searches">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex">
                .savedSearchIcon {
                        color: #036BC3;
                        height: 20px;
                        width: 20px;
                    }
                    .title {
                        color: black;
                        font-size: 16px;
                    }
                    .required{
                        color:red;
                    }
                    paper-checkbox.blue {
                        --paper-checkbox-checked-color: #036BC3;
                        --paper-checkbox-unchecked-color: #7D8690;
                        --paper-checkbox-label-color: #7D8690;
                        --paper-checkbox-label-checked-color: #7D8690;
                        --paper-checkbox-size: 14px;
                    }
                    .clear {               
                        --pebble-button: {
                                height: 40px;
                                color: #7D8690;
                                border: 1px solid #C1CAD4;
                                font-size: 14px;
                        }
                    }
                    .save {               
                        --pebble-button: {
                                height: 40px;
                                background: #0ABF21;
                                color: #FFFFFF;
                                border: 1px solid #0ABF21;
                                font-size: 14px;
                        }
                    }            
                    .buttons{
                        margin-top: 5px;
                        text-align:center;
                    }
                    .container {
                        margin: 5px 10px;
                    }
                    .marginTop5{
                        margin-top: 5px;
                    }
        </style>
        
        <template is="dom-if" if="[[!editMode]]">
            <rock-tabs id="rock-saved-searches-tabs" config="{{_tabConfig}}"></rock-tabs>
        </template>        
        <template is="dom-if" if="[[editMode]]">
            <div class="veritical layout container">
                 <iron-ajax auto url="/src/data/EntitySearchApp/allSavedSearches.json" handle-as="json" last-response="{{createEditModel}}"></iron-ajax>
                <div>
                    <iron-icon class="savedSearchIcon" icon="pebble-icons:Icons/SavedSearch"></iron-icon>
                    <span class="title">{{title}}</span>
                </div>                
                <div>
                    <pebble-dropdown id="savedSearchDropdown" label="EDIT SAVED SEARCH" items="{{savedSearchItems}}"></pebble-dropdown>
                    <bedrock-pubsub on-bedrock-event-dropdown-value-change="onDropdownValueChange"></bedrock-pubsub>
                </div>                
                <div>
                    <paper-input id="savedSearchNameId" label="NEW SAVED SEARCH NAME" required auto-validate
                        always-float-label error-message="required" value={{name}}></paper-input>
                </div>
                <div class="veritical layout marginTop5">
                    <div>
                        <span>Who can use this saved search?</span>
                    </div>
                    <div>
                        <paper-checkbox data-id="self" class="blue" noink checked="{{self}}" disabled$={{selfDisabled}} 
                             on-change="_checkChanged">
                            <span>Only I can use this</span>
                        </paper-checkbox>
                    </div>
                    <div>
                        <paper-checkbox  data-id="allUsersSameRole" class="blue" noink checked="{{allUsersSameRole}}"
                             disabled$={{allUsersSameRoleDisabled}} on-change="_checkChanged">
                            <span>All Others with my role can use this</span>
                        </paper-checkbox>
                    </div>
                    <div>
                        <paper-checkbox data-id="allUsersAllRoles" class="blue" noink checked="{{allUsersAllRoles}}" 
                                disabled$={{allUsersAllRolesDisabled}} on-change="_checkChanged">
                            <span>Everybody in my enterprise can use this</span>
                        </paper-checkbox>
                    </div>
                </div>
                <div class="buttons">
                    <pebble-button class="clear" button-text="Clear" noink raised elevation="2" on-tap="_onClearTap"></pebble-button>
                    <pebble-button class="save" button-text="Save" noink raised elevation="2" on-tap="_onSaveTap"></pebble-button>
                </div>
            </div>
        </template>
        
    </template>
    <script>
        (function() {
            'use strict';              

            Polymer({

                is: 'rock-saved-searches',
                /**
                * Fired when any of the saved search is tapped in 
                * saved search widget with name: "rock-saved-search". Here, data is the data of the clicked saved search.
                *
                * @event bedrock-event
                */

                /**
                * Fired when user taps/clicks on save button inside Create New Saved Search popover 
                * with the name: "create-savedsearch-save".
                *
                * @event bedrock-event	
                */
                properties: {
                    /**
                    * Indicates the config for tabs.
                    */
                    _tabConfig: {
                        type: Object,
                        notify: true,
                        value: function(){
                            return {
                                    "scrollable": false,
                                    "tabItems": [
                                        {
                                            "name": "favourites",
                                            "title": "Favourites",
                                            "enableDropdownMenu": false,
                                            "component": {
                                                "name": "rock-saved-searches-tags",
                                                "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                                "properties": {
                                                    "saved-search-category": "favourites"
                                                }
                                            }
                                        },
                                        {
                                            "name": "my-searches",
                                            "title": "My Searches",
                                            "enableDropdownMenu": false,
                                            "selected" : true,
                                            "component": {
                                                "name": "rock-saved-searches-tags",
                                                "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                                "properties": {
                                                    "saved-search-category": "my-searches"
                                                }
                                            }
                                        },
                                    ]
                                }
                            }
                        },
                        /**
                        * Indicates the config for saved searches.
                        */
                        createEditModel: {
                            type: Array,
                           value: function() { return []; },
                           observer: '_createEditModelChanged'
                        },
                        /**
                        * Indicates the create/edit mode for saved search.
                        */                            
                        editMode: {
                            type: Boolean,
                            value: false,
                            reflectToAttribute: true
                        },
                        /**
                        * Indicates the title for create/edit saved search popover.
                        */ 
                        title: {
                            type: String,
                            value: "Create or Edit Saved Search",
                            notify: true
                        },
                        /**
                        * Indicates all saved searches.
                        */ 
                        savedSearchItems: {
                            type: String,
                            value: ""
                            
                        },
                        /**
                        * Indicates the name of the saved search.
                        */ 
                        name: {
                            type: String,
                            value: "",
                            notify: true
                        },
                        /**
                        * Indicates the option 'Only I can use this' is checked or not.
                        */ 
                        self: {
                            type: Boolean,
                            value: false,
                            notify: true
                        },
                        /**
                        * Indicates the option 'All Others with my role can use this' is checked or not.
                        */ 
                        allUsersSameRole: {
                            type: Boolean,
                            value: false,
                            notify: true
                        },
                        /**
                        * Indicates if option 'Everybody in my enterprise can use this' is checked or not.
                        */ 
                        allUsersAllRoles: {
                            type: Boolean,
                            value: false,
                            notify: true
                        },
                        /**
                        * Indicates the option 'Only I can use this' is disabled or not.
                        */ 
                        selfDisabled: {
                            type: Boolean,
                            value: false,
                            notify: true
                        },
                        /**
                        * Indicates the option 'All Others with my role can use this' is disabled or not.
                        */ 
                        allUsersSameRoleDisabled: {
                            type: Boolean,
                            value: false,
                            notify: true
                        },
                        /**
                        * Indicates if option 'Everybody in my enterprise can use this' is disabled or not.
                        */ 
                        allUsersAllRolesDisabled: {
                            type: Boolean,
                            value: false,
                            notify: true
                        }
                    },
                    ready:function() {
                        this._resetControlValues();
                    },                                  
                    _createEditModelChanged: function(){                        
                        if(this.createEditModel != null && this.createEditModel.length > 0){
                            var existingSavedSearches = [];
                            for(var i=0;i<this.createEditModel.length;i++){
                                existingSavedSearches.push(this.createEditModel[i].name);
                            }

                            this.savedSearchItems =  existingSavedSearches.join(",");

                            this._resetControlValues();
                        }
                    },
                    listeners: {
                        'tag-item-select': '_onTagItemSelect',
                        'change': '_onDropdownChange'
                    },
                    /**
                    * Fired when filter tag triggers a tag-item-select event.
                    */
                    _onTagItemSelect: function(e) {
                        var eventData = {
                            name : "rock-saved-search",
                            data : e.detail
                        };
                        this.fire('bedrock-event', eventData);
                    },                    
                    _checkChanged: function(e) {                        
                        this._manageCheckboxes();                       
                    },
                    _onDropdownChange: function(e){
                        if(e.path[0].id == "savedSearchDropdown" && e.detail != undefined){
                            var selectedIndex = e.detail.newValue;

                            var dropdownElement = this.$$('pebble-dropdown');
                            var selectedValue = dropdownElement.selectedValue;

                            // Get the object for the current selected saved search
                             var savedSearchObject = {};
                             if(this.createEditModel != null && this.createEditModel.length > 0){
                                
                                for(var i=0;i<this.createEditModel.length;i++){
                                   if(this.createEditModel[i].name == selectedValue){
                                       savedSearchObject = this.createEditModel[i];
                                       break;
                                   }
                                }
                            }

                            // Set the values for all the controls accordingly
                            this.name = savedSearchObject.name;
                            this.self = savedSearchObject.self;
                            this.allUsersSameRole = savedSearchObject.allUsersSameRole;
                            this.allUsersAllRoles = savedSearchObject.allUsersAllRoles; 
                            this.selfDisabled = !this.self;
                            this.allUsersSameRoleDisabled = !this.allUsersSameRole;
                            this.allUsersAllRolesDisabled = !this.allUsersAllRoles;
                        }
                    },                                        
                    _onClearTap: function(e) {
                        this._resetControlValues();                        
                    },
                    _onSaveTap: function(e) {                      
                        // fire the validation to check if name is given or not. If given, get the saved search name
                        var inputElement = this.$$('paper-input');
                        var flag = inputElement.validate();
                        if(!flag){
                            return;
                        }
                        
                        if(!this.self && !this.allUsersSameRole && !this.allUsersAllRoles){
                            // Display a message to the users to check any one of the options
                        }
                        else{
                            var savedSearchObject = { name: this.name, self: this.self, allUsersSameRole: this.allUsersSameRole, allUsersAllRoles: this.allUsersAllRoles}
                            var eventDetail= {
                                name: 'create-savedsearch-save',
                                data: savedSearchObject
                            }      
                            this.fire('bedrock-event', eventDetail);
                        }
                    },
                    /*
                     * Re-usable function to clear all control values
                     */
                    _resetControlValues: function() {
                        
                        var dropdownElement = this.$$('pebble-dropdown');
                        if(dropdownElement != undefined){
                            dropdownElement.selectedValue = "";
                        }  

                        //clear all the control values
                        var inputElement = this.$$('paper-input');
                        if(inputElement != undefined){
                            this.name = "";
                            inputElement.removeAttribute("required");
                            inputElement.validate();
                            inputElement.setAttribute("required", true);
                        }

                        // checked and disabled - set to false
                        this.self = false;
                        this.allUsersSameRole = false;
                        this.allUsersAllRoles = false;
                        this.selfDisabled = false;
                        this.allUsersSameRoleDisabled = false;
                        this.allUsersAllRolesDisabled = false; 
                    },
                    /*
                     * Re-usable function to manage checked and disabled flags of checkboxes
                     */
                    _manageCheckboxes: function() {
                        if(this.self){
                            this.allUsersSameRoleDisabled = true;
                            this.allUsersAllRolesDisabled = true;
                            
                            this.allUsersSameRole = false;
                            this.allUsersAllRoles = false;
                        }
                        else if(this.allUsersSameRole){
                            this.selfDisabled = true;
                            this.allUsersAllRolesDisabled = true;
                            
                            this.self = false;
                            this.allUsersAllRoles = false;

                        }else if(this.allUsersAllRoles) {
                            this.selfDisabled = true;
                            this.allUsersSameRoleDisabled = true;

                            this.self = false;
                            this.allUsersSameRole = false;
                        }
                        else{
                            this.selfDisabled = false;
                            this.allUsersSameRoleDisabled = false;
                            this.allUsersAllRolesDisabled = false;
                            this.self = false;
                            this.allUsersSameRole = false;
                            this.allUsersAllRoles = false;
                        }
                    } 

                    
            });
        })();
    </script>
</dom-module>