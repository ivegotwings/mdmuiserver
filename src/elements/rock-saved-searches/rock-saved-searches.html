<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">

<dom-module id="rock-saved-searches">
    <template>
        <style include="shared-styles"></style>
        <iron-ajax auto url="../../data/saved-searches.json" handle-as="json" last-response="{{savedSearches}}"></iron-ajax>
        <rock-tabs config="{{_tabConfig}}" selected-tab-index="{{_selectedTabIndex}}"></rock-tabs>
    </template>
    <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rock-saved-searches',

        properties: {
         /**
        * Fired when any of the saved search is tapped in saved search widget with name: "rock-saved-search-click" and data is the data of the clicked saved search
        *
        * @event bedrock-event
        */

        /**
         * internal Property denoting the selected index of a tab
         */
         _selectedTabIndex: {
            type: Number,
             value: 0,
             observer: '_tabOrDataChanged'
         },

        /**
         * Contains the data of saved searches
        */
        savedSearches : {
            type : Object,
            notify : true,
             value : function(){return {}},
             observer: '_tabOrDataChanged'
        },
        /**
         * This is a private property. Contains the computed tags from active tab of saved searches
        */
         _tags:{
            type:Array,
            notify: true,
            value:function(){return []},
         },

         /**
          * This is an internal property. Contains the config for tabs
          */
         _tabConfig : {
            type:Object,
             notify: true,
            value:function(){
                return {
                        "fitContainer": false,
                        "scrollable": false,
                        "tabItems": [
                            {
                                "name": "favourites",
                                "title": "Favourites",
                                "enableDropdownMenu": false,
                                "selected" : true,
                                "component": {
                                    "name": "rock-tags",
                                    "path": "/src/elements/rock-tags/rock-tags.html",
                                    "properties": {
                                         "disable-delete" : "false",
                                         "is-non-editable" : "true"
                                    }
                                }
                            },
                            {
                                "name": "my-searches",
                                "title": "My Searches",
                                "enableDropdownMenu": false,
                                "component": {
                                    "name": "rock-tags",
                                    "path": "/src/elements/rock-tags/rock-tags.html",
                                    "properties": {
                                         "disable-delete" : "false",
                                         "is-non-editable" : "true"
                                    }
                                }
                            },
                            {
                                "name": "shared-searches",
                                "title": "Shared Searches",
                                "enableDropdownMenu": false,
                                "component": {
                                    "name": "rock-tags",
                                    "path": "/src/elements/rock-tags/rock-tags.html",
                                    "properties": {
                                         "disable-delete" : "false",
                                         "is-non-editable" : "true"
                                    }
                                }
                            }
                        ]
                }
            }
         }
        },

        listeners: {
            'tag-item-select': '_onTagItemSelect'
        },

        /**
         * This is a private function. It is responsible for computing tags when saved searches or tab changed.
        */
        _tabOrDataChanged : function() {
            this._tags=[];
            if(this._tabConfig) {
                var selectedTab = this._tabConfig.tabItems[this._selectedTabIndex].name;
                if(this.savedSearches && selectedTab && this.savedSearches[selectedTab]) {
                    for(var i =0; i < this.savedSearches[selectedTab].length; i++) {
                        var tag = JSON.parse(JSON.stringify(this.savedSearches[selectedTab][i]));
                        tag["editMode"] = false,
                        this.push('_tags',tag);
                    }
                    this._tabConfig.tabItems[this._selectedTabIndex].component.properties.tags = this._tags;
                }
            }
        },


        /**
            This is called when filter tag fires a tag-item-select event
        */
        _onTagItemSelect : function(e) {
        var selectedTab = this._tabConfig.tabItems[this._selectedTabIndex].name;
            var eventData = {
                name : "rock-saved-search-click",
                data : this.savedSearches[selectedTab][e.detail.index]
            };
            this.fire('bedrock-event',eventData);
        }
      });
    })();

    </script>
</dom-module>