<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-save/liquid-config-save.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="rock-saved-searches-tags.html">
<link rel="import" href="rock-create-edit-saved-searches.html">

<!--
`rock-saved-searches` Represents an element that displays the saved searches.

@demo demo/index.html
-->
<dom-module id="rock-saved-searches">
    <template>
        <custom-style>
            <style include="bedrock-style-common"></style>
            <style include="iron-flex">
                #newSavedSearch {
                    font-weight: var(--font-bold, bold);
                    line-height: 14px;
                }

                #createEditSavedSearch {
                    float: right;
                    margin-right: 10px;
                    line-height: 10px;
                    height: auto;
                    --pebble-button: {
                        font-size: var(--font-size-sm, 12px) !important;
                        color: var(--link-text-color, #036Bc3)!important;
                        font-weight: 500;
                        padding-top: 0;
                        padding-right: 0;
                        padding-bottom: 0;
                        padding-left: 0;
                    };
                    --pebble-icon-dimension: {
                        width: 12px;
                        height: 12px;
                    };
                    --pebble-icon-color: {
                        fill:var(--palette-cerulean-two, #026bc3);
                    }
                }

                pebble-horizontal-divider {
                    --pebble-horizontal-divider-color: #ccc;
                }

                rock-tabs {
                    --pebble-tab-group: {
                        margin-bottom: 15px;
                        width: 100%;
                    }
                    ;
                    --pebble-tab: {
                        margin-left: 0;
                    }
                    ;
                }

                pebble-horizontal-divider {
                    --pebble-horizontal-divider-color: #ccc;
                }

                .savedSearchLabel {
                    color: var(--title-text-color, #191e22);
                    font-weight: var(--font-bold, bold);
                    font-size: var(--default-font-size, 14px);
                    display: inline-block;
                    line-height: 18px;
                }

                pebble-button {
                    --iron-icon: {
                        width: 16px;
                        height: 16px;
                        fill: var(--palette-deep-sea-blue);
                    }
                    --pebble-button-left-icon: {
                        fill: var(--palette-deep-sea-blue);
                    }
                }

                rock-tabs {
                    --rock-tab-content: {
                        @apply --saved-search-tab-content;
                        max-height: 165px;
                        overflow-y: auto;
                    }
                    ;
                }
            </style>
        </custom-style>
        <!--Liquid start-->
        <liquid-config-get id="liqInitiateSearch" operation="initiatesearch" request-data="{{initiateSearchRequestData}}" last-response="{{initiateSearchResponse}}"
            on-response="_onInitiateSearchResponse">
        </liquid-config-get>
        <liquid-config-get id="liqGetSearchResultDetail" operation="getsearchresultdetail" on-response="_onGetSearchResultDetailResponse">
        </liquid-config-get>

        <liquid-config-get id="liqInitiateNameSearch" operation="initiatesearch" request-data="{{initiateNameSearchRequestData}}"
            last-response="{{initiateNameSearchResponse}}" on-response="_onInitiateNameSearchResponse">
        </liquid-config-get>
        <liquid-config-get id="liqGetNameSearchResultDetail" operation="getsearchresultdetail" on-response="_onGetNameSearchResultDetailResponse">
        </liquid-config-get>

        <liquid-config-save name="configSaveService" on-response="_onSaveSearchResponse"></liquid-config-save>
        <!--Liquid end-->
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
        <bedrock-pubsub event-name="favourite-saved-search" handler="_onTapSavedSearchFavourite" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="delete-saved-search" handler="_onTapSavedSearchDelete" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="actions-parent-button-tap" handler="_onTagItemSelect" target-id=""></bedrock-pubsub>
        <!--Title, Settings and Create/Edit link-->
        <div id="newSavedSearch" class="clearfix">
            <template is="dom-if" if="[[showTitle]]">
                <div class="savedSearchLabel">Saved Searches</div>
            </template>
            <template is="dom-if" if="[[showSettings]]">
                <pebble-icon-updated id="refreshButton" icon="pebble-icon:Refresh" data-tooltip="Refresh" class="pebble-icon-color-blue pebble-icon-size-16 pull-right tooltip-bottom"
                    on-tap="refresh"></pebble-icon-updated>
            </template>
            <template is="dom-if" if="[[allowCreateEditSearch]]">
                <pebble-button id="createEditSavedSearch" icon="pebble-icon:Add" button-text="Create or Edit Saved Search" noink class="createEditSavedSearch pebble-icon-color-blue icon"
                    on-tap="_onCreateEditSavedSearchTap"></pebble-button>
            </template>
        </div>
        <!--Tabs section-->
        <template is="dom-if" if="[[!noTabs]]">
            <rock-tabs id="rock-saved-searches-tabs" config="[[_tabConfig]]" selected-tab="{{_selectedTab}}" deferred-render></rock-tabs>
        </template>
        <!--Create/Update section-->
        <template is="dom-if" if="[[noTabs]]">
            <rock-create-edit-saved-searches edit-mode="{{noTabs}}" saved-search-id="[[savedSearchId]]" create-edit-model="[[savedSearches]]"></rock-create-edit-saved-searches>
        </template>
    </template>
    <script>
        (function () {
            'use strict';

            var _favSearch = 'favourites';
            var _mySearch = 'my-searches';
            var _sharedSearch = 'shared-searches';
            var tabs = { "favourites": 0, "my-searches": 1, "shared-searches": 2 };

            Polymer({

                is: 'rock-saved-searches',
                /**
                * Fired when the saved search is tapped in the 
                * saved search widget with the name as `rock-saved-search-click`. 
                * Here, data is the data of the clicked saved search.
                *
                * @event bedrock-event
                */

                /**
                * Fired when the user taps or clicks on the save button inside the `Create New Saved Search popover` 
                * with the name as "saved-search-save".
                *
                * @event bedrock-event	
                */
                properties: {
                    /**
                    * Indicates the config for the tabs.
                    */
                    _tabConfig: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {
                                "scrollable": false,
                                "tabItems": [
                                    {
                                        "name": "favourites",
                                        "title": "Favourites",
                                        "selected": true,
                                        "enableDropdownMenu": false,
                                        "component": {
                                            "name": "rock-saved-searches-tags",
                                            "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                            "properties": {
                                                "saved-search-category": "favourites"
                                            }
                                        }
                                    },
                                    {
                                        "name": "my-searches",
                                        "title": "My Searches",
                                        "enableDropdownMenu": false,
                                        "component": {
                                            "name": "rock-saved-searches-tags",
                                            "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                            "properties": {
                                                "saved-search-category": "my-searches"
                                            }
                                        }
                                    },
                                    {
                                        "name": "shared-searches",
                                        "title": "Shared Searches",
                                        "enableDropdownMenu": false,
                                        "component": {
                                            "name": "rock-saved-searches-tags",
                                            "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                            "properties": {
                                                "saved-search-category": "shared-searches"
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * Indicates the search identification which the consumer selects.
                     */
                    savedSearchId: {
                        type: Number,
                        value: null,
                        notify: true
                    },

                    /** 
                      * Indicates the saved searches.
                      */
                    savedSearches: {
                        type: Object,
                        value: function () { return {}; },
                        notify: true,
                        observer: '_onSavedSearchesChange'
                    },

                    // Indicates saved searches
                    _allSavedSearches: {
                        type: Object,
                        value: function () { return { "favourites": {}, "my-searches": {}, "shared-searches": {} }; }
                    },

                    // Selected tab details
                    _selectedTab: {
                        type: Object,
                        value: function () { return {}; },
                        notify: true,
                        observer: '_onSelectedTabChange'
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    allowCreateEditSearch: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    showSettings: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    noTabs: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    showTitle: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    initiateSearchRequestData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    initiateSearchResponse: {
                        type: Object,
                        value: function () { return {}; },
                        notify: true
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    resultedEntities: {
                        type: Object,
                        value: function () { return []; },
                        notify: true
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    pageSize: {
                        type: Number,
                        value: 100
                    },
                    _originalSearches: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _originalSearchMappings: {
                        type: Array,
                        value: function () { return []; }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    appName: {
                        type: String,
                        value: "app-entity-discovery"
                    },
                    _searchRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _mappingRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _toastMessage: {
                        type: String,
                        value: null
                    },
                    _searchInfo: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _isSearchRequestInProcess: {
                        type: Boolean,
                        value: false
                    }
                },

                listeners: {
                    'tag-item-select': '_onTagItemSelect'
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                observers: [
                    //'_triggerSearchTransform(_originalSearches, _originalSearchMappings)',
                    '_onContextDataChange(contextData, appName)'
                ],

                _onContextDataChange: function (contextData, appName) {
                    if (contextData && !_.isEmpty(contextData) && appName != undefined) {
                        var clonedContextData = DataHelper.cloneObject(this.contextData);
                        var searchCtxData = DataHelper.cloneObject(this._prepareContext(clonedContextData));
                        var mappingCtxData = DataHelper.cloneObject(this._prepareContext(clonedContextData, "searchmapping"));

                        this._searchRequest = DataRequestHelper.createConfigInitialRequest(searchCtxData);
                        this._mappingRequest = DataRequestHelper.createConfigInitialRequest(mappingCtxData);

                        //Initial search for shared
                        var request = DataHelper.cloneObject(this._searchRequest);
                        if (!this._isSearchRequestInProcess) {
                            //Raise initial request for search and on search response raise for mappings
                            var that = this;
                            Polymer.Async.timeOut.after(10).run(() => {
                                that.generateRequest(request);
                                that._isSearchRequestInProcess = true;
                            });
                        }
                    }
                },

                //Prepare context for mappings
                _prepareContext: function (clonedContextData, type) {
                    var context = {};
                    var typesCriterion = [];
                    var userContext = ContextHelper.getFirstUserContext(clonedContextData);

                    if (type == "searchmapping" && userContext) {
                        context = {
                            "app": this.appName,
                            "service": "_ALL",
                            "component": "_ALL",
                            "subComponent": "_ALL",
                            "user": userContext.user,
                            "role": userContext.role
                        };
                        typesCriterion.push("savedSearchMappings");
                    }
                    else {
                        context = {
                            "app": this.appName,
                            "service": "_ALL",
                            "component": "_ALL",
                            "subComponent": "_ALL",
                            "user": "all",
                            "role": "all"
                        };
                        typesCriterion.push("savedSearch"); // , "workflowSavedSearch"
                    }

                    //Set context
                    clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [context];
                    clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = typesCriterion;

                    return clonedContextData;
                },

                _triggerSearchTransform: function () {
                    if (this._originalSearches && this._originalSearchMappings) {
                        var userContext = ContextHelper.getFirstUserContext(this.contextData);
                        this.savedSearches = DataTransformHelper.transformScopes(this._originalSearches, this._originalSearchMappings, userContext, "favoriteSavedSearches");
                        
                        const rockTabs = this.shadowRoot.querySelector('rock-tabs');
                        Polymer.Async.microTask.run(() => {
                            //Reload tabs to get updated tags
                            if (rockTabs && rockTabs.shadowRoot.querySelector('rock-saved-searches-tags')) {
                                rockTabs.readyToRender(true);
                                rockTabs.reloadTabs();
                            }
                        });
                    }
                },

                _onCreateEditSavedSearchTap: function (e) {
                    this.noTabs = true;
                    Polymer.Async.microTask.run(() => {
                        //This is to execute the logic for all scenarios on create/edit link on-click
                        this.shadowRoot.querySelector('rock-create-edit-saved-searches').OnCreateEditButtonClick();
                    });
                },

                // Fired when rock-tabs creates component
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;
                    if (this.savedSearches) {
                        component.properties["saved-searches"] = this.savedSearches;
                        component.properties["context-data"] = this.contextData;
                    }
                },

                /**
                * Fired when filter tag triggers a tag-item-select event.
                */
                _onTagItemSelect: function (e) {

                    var eventName = "rock-saved-search-click";
                    this.fireBedrockEvent(eventName, e.detail, { ignoreId: true });
                },

                // On tab change populate searches
                // Note - this will be removed once we integrated with liquid
                _onSelectedTabChange: function () {
                    const rockTabs = this.shadowRoot.querySelector('rock-tabs');
                    if (rockTabs) {
                        setTimeout(() => {
                            rockTabs.shadowRoot.querySelector('pebble-tab-group').notifyResize();
                        }, 600); //Delayed to populate the tabs properly                        
                    }
                },

                // On saved searches change, populate searches and select respected search tab
                _onSavedSearchesChange: function () {
                    this._populateAllSearches();
                    const rockTabs = this.shadowRoot.querySelector('rock-tabs');
                    if (this.savedSearchId && rockTabs) {
                        var listName = this._getSearchListNameBySearchId();
                        rockTabs.selectedTabIndex = tabs[listName];
                    }

                    if (rockTabs) {
                        rockTabs.readyToRender(true);
                        rockTabs.reloadTabs();
                    }
                },

                // Populate all searches
                _populateAllSearches: function () {
                    if (this.savedSearches) {
                        if (this.savedSearches[_mySearch]) {
                            for (var idx = 0; idx < this.savedSearches[_mySearch].length; idx++) {
                                this._allSavedSearches[_mySearch][this.savedSearches[_mySearch][idx].id] = this.savedSearches[_mySearch][idx];
                            }
                        }

                        if (this.savedSearches[_favSearch]) {
                            for (var idx = 0; idx < this.savedSearches[_favSearch].length; idx++) {
                                this._allSavedSearches[_favSearch][this.savedSearches[_favSearch][idx].id] = this.savedSearches[_favSearch][idx];
                            }
                        }

                        if (this.savedSearches[_sharedSearch]) {
                            for (var idx = 0; idx < this.savedSearches[_sharedSearch].length; idx++) {
                                this._allSavedSearches[_sharedSearch][this.savedSearches[_sharedSearch][idx].id] = this.savedSearches[_sharedSearch][idx];
                            }
                        }
                    }
                },

                // Get search list name
                _getSearchListNameBySearchId: function () {
                    if (this._allSavedSearches[_favSearch][this.savedSearchId]) {
                        return _favSearch;
                    }

                    if (this._allSavedSearches[_mySearch][this.savedSearchId]) {
                        return _mySearch;
                    }

                    if (this._allSavedSearches[_sharedSearch][this.savedSearchId]) {
                        return _sharedSearch;
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                generateRequest: function (requestData) {
                    if (requestData) {
                        this.initiateSearchRequestData = requestData;
                        this.shadowRoot.querySelector('#liqInitiateSearch').generateRequest();
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                generateNameSearchRequest: function (requestData) {
                    if (requestData) {
                        this.initiateNameSearchRequestData = requestData;
                        this.shadowRoot.querySelector('#liqInitiateNameSearch').generateRequest();
                    }
                },

                _onInitiateNameSearchResponse: function (e) {
                    var totalRecords = this.initiateNameSearchResponse.content.totalRecords;
                    var getDetailOptions = { 'from': 0, 'to': totalRecords };
                    this._makeGetNameSearchResultDetailCall(getDetailOptions);
                },

                _makeGetNameSearchResultDetailCall: function (options) {
                    var liqGetNameSearchResultDetail = this.shadowRoot.querySelector('#liqGetNameSearchResultDetail');

                    var searchResultId = this.initiateNameSearchResponse.content.requestId;

                    var reqData = this.initiateNameSearchRequestData;
                    reqData.params.options = options;

                    liqGetNameSearchResultDetail.requestId = searchResultId;
                    liqGetNameSearchResultDetail.requestData = reqData;

                    liqGetNameSearchResultDetail.generateRequest();
                },

                _onGetNameSearchResultDetailResponse: function (e, detail) {

                    var type = this._searchInfo.type;
                    var searchInfo = this._searchInfo.details;

                    //Compare search name and display toast message based on that
                    if (DataHelper.isValidObjectPath(detail, "response.content.configObjects")) {
                        var searchItems = detail.response.content.configObjects;

                        if (searchItems.length > 0 && type == "create") {
                            this.showErrorToast("Search name is already exists, please create search with different name.");
                            return;
                        }
                        else {
                            for (var i = 0; i < searchItems.length; i++) {
                                if (searchItems[i] && searchItems[i].id != searchInfo["saved-search-info"].selectedSearch.searchid) {
                                    this.showErrorToast("Search name is already exists, please create search with different name.");
                                    return;
                                }
                            }
                        }
                    }

                    //Prepare request
                    if (type == "create") {
                        var clonedContextData = DataHelper.cloneObject(this.contextData);
                        var savedSearchContextName = this._getSavedSearchContextName(searchInfo["saved-search-info"].name);

                        var _createRequestData = DataRequestHelper.getConfigCreateRequest(this._prepareCreateContext(clonedContextData, searchInfo), "savedSearch", this.appName, savedSearchContextName);

                        var reqData = { "configObjects": [_createRequestData] }
                        this.generateSaveRequest(reqData, "create");
                        this._toastMessage = searchInfo["saved-search-info"].name + " is saved successfully";
                    }
                    //update
                    else {
                        var selectedSearch = searchInfo["saved-search-info"].selectedSearch;
                        var originalSearch = {};
                        //Find original search based on searchInfo - _originalSearches
                        for (var i = 0; i < this._originalSearches.length; i++) {
                            if (!this._originalSearches[i].data) {
                                continue; //next search
                            }

                            var originalName = this._originalSearches[i].data.contexts[0].jsonData.config.searchname;
                            if (originalName == selectedSearch.searchname) {
                                originalSearch = this._originalSearches[i];
                                break;
                            }
                        }

                        this._setSearchDetailsForUpdate(originalSearch, searchInfo);

                        var reqData = { "configObjects": [originalSearch] }
                        this.generateSaveRequest(reqData, "update");
                        this._toastMessage = searchInfo["saved-search-info"].name + " is updated";
                    }
                },

                _setSearchDetailsForUpdate: function (originalSearch, searchInfo) {
                    var userContext = ContextHelper.getFirstUserContext(this.contextData);
                    var user = this._getUserRolePerAccessType(searchInfo["saved-search-info"], userContext);

                    // Original search details updated based on the changes
                    originalSearch.name = this._getSavedSearchContextName(searchInfo["saved-search-info"].name);
                    originalSearch.data.contexts[0].jsonData.config.name = searchInfo["saved-search-info"].name;
                    originalSearch.data.contexts[0].jsonData.config.accesstype = searchInfo["saved-search-info"].accesstype;
                    originalSearch.data.contexts[0].jsonData.config.dimensions = searchInfo["dimensions"];
                    originalSearch.data.contexts[0].jsonData.config.displayQuery = searchInfo["display-query"];
                    originalSearch.data.contexts[0].jsonData.config.internalQuery = searchInfo["internal-query"];
                    originalSearch.data.contexts[0].jsonData.config.governData = searchInfo["govern-data"];
                    originalSearch.data.contexts[0].context.user = user.user;
                    originalSearch.data.contexts[0].context.role = user.role;
                },

                _onInitiateSearchResponse: function (e) {
                    var totalRecords = this.initiateSearchResponse.content.totalRecords;
                    var getDetailOptions = { 'from': 0, 'to': totalRecords };
                    this._makeGetSearchResultDetailCall(getDetailOptions);
                },

                _makeGetSearchResultDetailCall: function (options) {
                    var liqGetSearchResultDetail = this.shadowRoot.querySelector('#liqGetSearchResultDetail');

                    var searchResultId = this.initiateSearchResponse.content.requestId;

                    var reqData = this.initiateSearchRequestData;
                    reqData.params.options = options;

                    liqGetSearchResultDetail.requestId = searchResultId;
                    liqGetSearchResultDetail.requestData = reqData;

                    liqGetSearchResultDetail.generateRequest();
                },

                _onGetSearchResultDetailResponse: function (e) {
                    var requestType;
                    if (DataHelper.isValidObjectPath(e, "detail.request.requestData.params.query.filters.typesCriterion")) {
                        requestType = e.detail.request.requestData.params.query.filters.typesCriterion[0];
                    }

                    //Transform data and keep the data in savedSearches
                    if (e.detail.response &&
                        e.detail.response.status == "success" &&
                        e.detail.response.content &&
                        e.detail.response.content.configObjects) {
                        if (requestType == "savedSearchMappings") {
                            this._originalSearchMappings = []; //reset
                            this._originalSearchMappings.push.apply(this._originalSearchMappings, e.detail.response.content.configObjects);

                            this._triggerSearchTransform();
                            this._isSearchRequestInProcess = false;
                        }
                        else {
                            if (DataHelper.isValidObjectPath(e, "detail.request.requestData.params.query.contexts")) {
                                var context = e.detail.request.requestData.params.query.contexts[0];
                                var userContext = ContextHelper.getFirstUserContext(this.contextData);
                                var request = DataHelper.cloneObject(this._searchRequest);

                                if (context.user == "all") //Initial response, so reset searches
                                {
                                    this._originalSearches = [];
                                }

                                this._originalSearches.push.apply(this._originalSearches, e.detail.response.content.configObjects);

                                if (context.user == "all") {
                                    //generate request for role
                                    request.params.query.contexts[0].user = "role";
                                    request.params.query.contexts[0].role = userContext.role;
                                }
                                else if (context.user == "role") {
                                    //generate request for individual user
                                    request.params.query.contexts[0].user = userContext.user;
                                    request.params.query.contexts[0].role = userContext.role;
                                }
                                else {
                                    //generate request for mapping
                                    if (DataHelper.isValidObjectPath(this._mappingRequest, "params.options")) {
                                        delete this._mappingRequest.params.options;
                                    }
                                    this.generateRequest(this._mappingRequest);
                                    return;
                                }

                                this.generateRequest(request);
                            }
                        }
                    }
                },

                _onTapSavedSearchFavourite: function (e, detail, sender) {
                    var foundInFav = false;
                    var tag = detail.parentButton;

                    // If mappings available then update
                    if (this._originalSearchMappings && this._originalSearchMappings.length > 0) {
                        var favourites = this._originalSearchMappings[0].data.contexts[0].jsonData.config.favoriteSavedSearches;

                        for (var i = 0; i < favourites.length; i++) {
                            if (favourites[i] == tag.searchname) {
                                favourites.splice(i, 1);
                                foundInFav = true;
                                this._toastMessage = tag.name + " is removed from favourites";
                                break;
                            }
                        }

                        if (!foundInFav) //Its not fav, then make it fav now
                        {
                            favourites.push(tag.searchname);
                            this._toastMessage = tag.name + " is added to favourites";
                        }

                        var reqData = { "configObjects": [this._originalSearchMappings[0]] } //Mapping have only one record
                        this.generateSaveRequest(reqData, "update");
                    }
                    else // When no mapping, then create request and submit
                    {
                        var clonedContextData = DataHelper.cloneObject(this.contextData);
                        var createMappingRequestData = DataRequestHelper.getConfigCreateRequest(this._prepareCreateMappingContext(clonedContextData, tag), "savedSearchMappings", this.appName);

                        var reqData = { "configObjects": [createMappingRequestData] }
                        this.generateSaveRequest(reqData, "create");
                        this._toastMessage = tag.name + " is added to favourites";
                    }
                },

                _onTapSavedSearchDelete: function (e, detail, sender) {
                    var savedSearchDeleteObj = {
                        "id": detail.parentButton.searchid,
                        "type": "savedSearch"
                    }
                    var reqData = { "configObjects": [savedSearchDeleteObj] }
                    this.generateSaveRequest(reqData, "delete");

                    this._toastMessage = detail.parentButton.name + " has been deleted";
                },

                // Can be used to generate the save requests.
                generateSaveRequest: function (reqData, operation) {
                    var configSaveService = this.shadowRoot.querySelector('[name="configSaveService"]');

                    if (configSaveService) {
                        configSaveService.operation = operation;
                        configSaveService.requestData = reqData;
                        configSaveService.generateRequest();
                    }
                },

                _onSaveSearchResponse: function (e) {
                    this._originalSearchMappings = [];
                    this._originalSearches = [];

                    if (this._toastMessage) {
                        this.showSuccessToast(this._toastMessage);
                        this._toastMessage = "";
                    }

                    if (DataHelper.isValidObjectPath(this._searchRequest, "params.options")) {
                        delete this._searchRequest.params.options;
                    }
                    setTimeout(() => {
                        this.generateRequest(this._searchRequest);
                    }, 1000); //Todo - This async will be removed once Notification is integrated                    
                },

                // Can be used to create and update the saved search.
                createUpdateSavedSearch: function (searchInfo, type) {

                    this._searchInfo = {
                        "details": searchInfo,
                        "type": type
                    };

                    var request = DataHelper.cloneObject(this._searchRequest);
                    request.params.query.name = this._getSavedSearchContextName(searchInfo["saved-search-info"].name);
                    delete request.params.query.contexts[0].user;
                    delete request.params.query.contexts[0].role;

                    this.generateNameSearchRequest(request);
                },

                // Context for create saved search
                _prepareCreateContext: function (_clonedContextData, searchInfo) {
                    var context = {};
                    var userContext = ContextHelper.getFirstUserContext(_clonedContextData);
                    var user = this._getUserRolePerAccessType(searchInfo["saved-search-info"], userContext);
                    context = {
                        "app": this.appName,
                        "service": "_ALL",
                        "component": "_ALL",
                        "subComponent": "_ALL",
                        "user": user.user,
                        "role": user.role
                    };

                    var data = {};

                    data = {
                        "config": {
                            "id": ElementHelper.getRandomString(),
                            "accesstype": searchInfo["saved-search-info"].accesstype,
                            "name": searchInfo["saved-search-info"].name,
                            "icon": "pebble-icon:SavedSearch",
                            "createdby": userContext.user,
                            "createdbyrole": userContext.role,
                            "ownershipData": userContext.ownershipData,
                            "dimensions": searchInfo["dimensions"],
                            "displayQuery": searchInfo["display-query"],
                            "internalQuery": searchInfo["internal-query"],
                            "governData": searchInfo["govern-data"]
                        }
                    };

                    var _contextsObject = {
                        "context": context,
                        "jsonData": data
                    }

                    //Set context
                    _clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [_contextsObject];

                    return _clonedContextData;
                },

                _getSavedSearchContextName: function (searchName) {
                    if (searchName && searchName.trim().length > 0) {
                        return "savedsearch_" + searchName.replace(/\s/g, '').toLowerCase();
                    }
                },

                _getUserRolePerAccessType: function (searchInfo, userContext) {

                    if (!searchInfo || !userContext) {
                        return;
                    }

                    if (searchInfo.accesstype) {
                        var user = userContext.user;
                        var role = userContext.role;

                        if (searchInfo.accesstype == "_ALL") {
                            user = "all"; // all users
                            role = "all"; // any role
                        }
                        else if (searchInfo.accesstype == "_ROLE") {
                            user = "role"; // role based users
                        }

                        return {
                            "user": user,
                            "role": role
                        };
                    }
                },

                // Context for create mappings
                _prepareCreateMappingContext: function (clonedContextData, tag) {
                    var context = {};
                    var userContext = ContextHelper.getFirstUserContext(clonedContextData);
                    context = {
                        "app": this.appName,
                        "service": "_ALL",
                        "component": "_ALL",
                        "subComponent": "_ALL",
                        "role": userContext.role,
                        "user": userContext.user
                    };

                    var data = {};

                    data = {
                        "config": {
                            "favoriteSavedSearches": [tag.searchname]
                        }
                    };

                    var contextsObject = {
                        "context": context,
                        "jsonData": data
                    }


                    //Set context
                    clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [contextsObject];

                    return clonedContextData;
                },

                refresh: function () {
                    var request = DataHelper.cloneObject(this._searchRequest);
                    if (!this._isSearchRequestInProcess) {
                        this.generateRequest(request);
                        this._isSearchRequestInProcess = true;
                    }
                }
            });
        })();
    </script>
</dom-module>