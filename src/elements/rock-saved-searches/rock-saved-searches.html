<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="rock-create-edit-saved-searches.html">

<!--
`rock-saved-searches` Represents an element that displays the saved searches.

@demo demo/index.html
-->
<dom-module id="rock-saved-searches">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex">
                #savedSearchButton {
                    --pebble-button: {
                    height: 32px;
                    padding: 1em 0em 1em 0.3em;
                    color: #2068BD;
                    border: 1px solid #2068BD;
                    font-size: small;
                    top: -7px;
                    }
                    --pebble-button-dropdown-icon: {
                        height: 20px !important;
                        width: 20px !important;
                    }
                }
                #newSavedSearch {
                    font-weight: bold;
                    font-size: 16px;                    
                }
                .marginLeft-9 {
                    margin-left: -9px;
                }
                #createEditSavedSearch {
                    padding-left: 5px;
                    --pebble-button: {
                        font-size: 14px !important;
                        color: #036BC3;                        
                    }
                    --pebble-button-iron-icon: {
                        height: 16px !important;
                        width: 16px !important;
                        color: #036BC3 !important;
                    }
                } 
                pebble-horizontal-divider {
                    --pebble-horizontal-divider-color: #ccc;
                }
                #savedSearchPopover {
                    margin-top: -3px;                    
                    width: 550px;
                }
                .savedSearchLabel {
                    color: black;
                    font-weight: bold;
                    font-size: 16px;
                }   
                :root {
                    --pebble-popover-max-width: 100%;
                    --pebble-popover-max-height: 100%;
                }
                rock-tabs::shadow pebble-tab-group {
                    margin-bottom: 15px;
                }
        </style>
        <iron-ajax auto url="/src/data/saved-searches.json" handle-as="json" last-response="{{_createEditModel}}"></iron-ajax>
        <template is="dom-if" if="[[!viewMode]]">
            <pebble-button id="savedSearchButton" icon="{{icon}}" button-text="{{buttonText}}" noink raised 
                dropdown-icon="{{dropdownIcon}}" on-tap="_onSavedSearchTap"></pebble-button>
            <pebble-popover id="savedSearchPopover" for="savedSearchButton" auto-fit-on-attach no-overlap horizontal-align="right">
                <template is="dom-if" if="[[!editMode]]">
                    <template is="dom-if" if="[[!viewMode]]">
                        <div id="newSavedSearch">
                            <div class="savedSearchLabel">Saved Searches</div>                  
                            <pebble-button id="createEditSavedSearch" icon="icons:add" button-text="Create or Edit Saved Search" noink 
                            class="createEditSavedSearch marginLeft-9 icon" on-tap="_onCreateEditSavedSearchTap"></pebble-button>
                            <pebble-horizontal-divider></pebble-horizontal-divider>
                        </div>            
                    </template>
                    <rock-tabs id="rock-saved-searches-tabs" config="{{_tabConfig}}" selected-tab="{{_selectedTab}}"></rock-tabs>
                </template>    
                <template is="dom-if" if="[[editMode]]">                                
                    <rock-create-edit-saved-searches edit-mode="{{editMode}}" saved-search-id="[[savedSearchId]]" create-edit-model="[[_searches]]"></rock-create-edit-saved-searches>
                </template>
            </pebble-popover>
        </template>
        <template is="dom-if" if="[[viewMode]]">
            <template is="dom-if" if="[[!editMode]]">
                    <template is="dom-if" if="[[!viewMode]]">
                        <div id="newSavedSearch">
                            <div class="savedSearchLabel">Saved Searches</div>                  
                            <pebble-button id="createEditSavedSearch" icon="icons:add" button-text="Create or Edit Saved Search" noink 
                            class="createEditSavedSearch marginLeft-9" on-tap="_onCreateEditSavedSearchTap"></pebble-button>
                            <pebble-horizontal-divider></pebble-horizontal-divider>
                        </div>            
                    </template>
                    <rock-tabs id="rock-saved-searches-tabs" config="{{_tabConfig}}" selected-tab="{{_selectedTab}}"></rock-tabs>
                </template>    
                <template is="dom-if" if="[[editMode]]">
                    <rock-create-edit-saved-searches edit-mode="{{editMode}}" saved-search-id="[[savedSearchId]]" create-edit-model="[[_searches]]"></rock-create-edit-saved-searches>
                </template>
        </template>        
    </template>
    <script>
        (function() {
            'use strict';              

            var _favSearch = 'favourites';
            var _mySearch = 'my-searches';
            var _sharedSearch = 'shared-searches';

            Polymer({

                is: 'rock-saved-searches',
                /**
                * Fired when any of the saved search is tapped in 
                * saved search widget with name: "rock-saved-search-click". Here, data is the data of the clicked saved search.
                *
                * @event bedrock-event
                */

                /**
                * Fired when user taps/clicks on save button inside Create New Saved Search popover 
                * with the name: "saved-search-save".
                *
                * @event bedrock-event	
                */
                properties: {
                    /**
                    * Indicates the config for tabs.
                    */
                    _tabConfig: {
                        type: Object,
                        notify: true,
                        value: function(){
                            return {
                                    "scrollable": false,
                                    "tabItems": [
                                        {
                                            "name": "favourites",
                                            "title": "Favourites",
                                            "enableDropdownMenu": false,
                                            "component": {
                                                "name": "rock-saved-searches-tags",
                                                "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                                "properties": {
                                                    "saved-search-category": "favourites"
                                                }
                                            }
                                        },
                                        {
                                            "name": "my-searches",
                                            "title": "My Searches",
                                            "enableDropdownMenu": false,
                                            "selected" : true,
                                            "component": {
                                                "name": "rock-saved-searches-tags",
                                                "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                                "properties": {
                                                    "saved-search-category": "my-searches"
                                                }
                                            }
                                        },
                                        {
                                            "name": "shared-searches",
                                            "title": "Shared Searches",
                                            "enableDropdownMenu": false,
                                            "component": {
                                                "name": "rock-saved-searches-tags",
                                                "path": "/src/elements/rock-saved-searches/rock-saved-searches-tags.html",
                                                "properties": {
                                                    "saved-search-category": "shared-searches"
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        },
                        /**
                        * Indicates the create/edit mode for saved search.
                        */                            
                        editMode: {
                            type: Boolean,
                            value: false,
                            reflectToAttribute: true,
                            notify: true
                        },
                        /**
                        * Indicates the read-only mode for saved search. Create/Edit options will not be available for dashboard users.
                        */                            
                        viewMode: {
                            type: Boolean,
                            value: false,
                            reflectToAttribute: true
                        },                        
                        /**
                        * Indicates load saved search button icon.
                        */          
                        icon: {
                            type: String,
                            value: function() { return null; }  

                        },
                        /**
                        * Indicates the load saved search button text.
                        */
                        buttonText: {
                            type: String,
                            value: function() { return null; },
                            reflectToAttribute: true,
                            notify: true
                        },
                        /**
                        * Indicates that the menu button will have the dropdown arrow icon
                        * if the value is set <b>true</b>.
                        */
                        dropdownIcon: {
                            type: Boolean,
                            value: false
                        },

                        /**
                         * Indicates the search id which is selected by the consumer
                         */
                        savedSearchId: {
                            type: Number,
                            value: null,
                            notify: true
                        }, 

                        // Searches model
                        _createEditModel: {
                            type: Object,
                            value: function () { return {}; },
                            notify: true,
                            observer: '_onModelChange'
                        },

                        // Selected tab details
                        _selectedTab: {
                            type: Object,
                            value: function() {return {}; },
                            notify: true,
                            observer: '_onSelectedTabChange'
                        },                  

                        /**
                         * Indicates the config for saved searches.
                         */
                        _searches: {
                            type: Array,
                            value: function () { return []; },
                            notify: true
                        }
                        
                    },
                    _onSavedSearchTap: function (e) {
                        this.$$('#savedSearchPopover').show();
                    },
                    _onCreateEditSavedSearchTap: function(e) {                                                
                        this.editMode = true;                        
                        this.async(function(){
                            //This is to execute the logic for all scenarios on create/edit link on-click
                            this.$$('rock-create-edit-saved-searches').OnCreateEditButtonClick();
                        });                
                    },
                    listeners: {
                        'tag-item-select': '_onTagItemSelect'
                    },
                    /**
                    * Fired when filter tag triggers a tag-item-select event.
                    */
                    _onTagItemSelect: function(e) {
                        var eventData = {
                            name : "rock-saved-search-click",
                            data : e.detail
                        };
                        this.fire('bedrock-event', eventData);
                    },

                    // On tab change populate create/edit searches
                    _onSelectedTabChange: function() {                        
                        this._populateSearchesPerTab(this._selectedTab.name);                            
                    },

                    // Populate create/edit searches based on tab selection
                    _populateSearchesPerTab: function(tabName){
                        
                        this._searches = [];
                        
                        if(tabName == _favSearch)
                        {
                            this._searches = this._createEditModel.favourites;
                        }
                        else if(tabName == _sharedSearch)
                        {
                            this._searches = this._createEditModel[_sharedSearch];
                        }
                        else //mySearches
                        {
                            this._searches = this._createEditModel[_mySearch];
                        }
                    },

                    // On model change, populate searches and select respected search tab
                    _onModelChange: function(){                        
                        if(this.savedSearchId == null || this.$$('rock-tabs') == null)
                        {
                            this._populateSearchesPerTab(_mySearch);
                        }
                        else
                        {
                            var listName = this._getSearchListNameBySearchId();

                            if(listName == _favSearch)
                            {                                
                                this.$$('rock-tabs').selectedTabIndex = 0;
                            }
                            else if(listName == _sharedSearch)
                            {                                
                                this.$$('rock-tabs').selectedTabIndex = 2;
                            }
                            else
                            {
                                this._populateSearchesPerTab(_mySearch);
                                this.$$('rock-tabs').selectedTabIndex = 1;
                            }
                        }
                    },

                    // Get search list name
                    _getSearchListNameBySearchId: function()
                    {

                        for(var idx = 0; idx < this._createEditModel[_mySearch].length; idx++)
                        {
                            if(this._createEditModel[_mySearch][idx].id == this.savedSearchId)
                            {
                                return _mySearch;
                            }
                        }

                        for(var idx = 0; idx < this._createEditModel.favourites.length; idx++)
                        {
                            if(this._createEditModel.favourites[idx].id == this.savedSearchId)
                            {
                                return _favSearch;
                            }
                        }

                        for(var idx = 0; idx < this._createEditModel[_sharedSearch].length; idx++)
                        {
                            if(this._createEditModel[_sharedSearch][idx].id == this.savedSearchId)
                            {
                                return _sharedSearch;
                            }
                        }                        
                    }                                      
            });
        })();
    </script>
</dom-module>