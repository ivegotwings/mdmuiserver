<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">

<!--
`<rock-header-search>` Represents a textbox with a search icon that provides the global search.

### Example

    <rock-header-search></rock-header-search>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|---------
`--search-box-width` | The width of the search box | 290px
`--search-box-height` | The height of the search box | 20px
`--search-box-border` | The border of the serach box | 1px solid #7d8690
`--search-box-radius` | The radius of the search box | 4px
`--search-box-padding` | The padding of the search box | 2px
`--search-box` | Mixin applied to search box | {}
`--search-icon-fill-color` | The fill color of search icon | #09c021
`--search-icon-stroke-color` | The stroke color of search icon | ''
`--search-icon-margin` | The margin of search icon | 3px 0 0 -28px
`--search-action-icon` | Mixin applied to search icon | {}
`--search-action-hover-pointertype` | The pointer type for serach icon | pointer

@group rock Elements
@element rock-header-search
@demo demo/index.html
-->

<dom-module id="rock-header-search">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">

      :host > paper-icon-button {
        margin-right: 13px;
      }

      .rock-search-form {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        padding: 0 40px 0 74px;
        box-sizing: border-box;
        background: var(--palette-white, #ffffff);
        z-index: 2;
      }
      
      .rock-search-form[show] {
        display: block;
      }

      .search-input {
        min-width: 400px;
        height: 24px;
        border-radius: 3px;
        background-color: var(--palette-white, #ffffff);
        line-height: 0.83;
        padding-left:6px;
        padding-right: 30px;
        border: solid 1px var(--palette-white, #ffffff);
        font-family:var(--default-font-family);
        box-sizing: border-box;
        font-size: var(--font-size-sm, 12px);
        display: block;
        transition: all 0.3s;
      }

      .search-action {
        position: absolute;
        top: 2px;
        right: 2px;       
      }
      .search-action{
          --iron-icon:{
        height: var(--search-action-size, 20px);
        margin: 0;
        position: absolute;
        top: 2px;
        right: 4px;
        fill: var(--top-header-search-icon-color);
      }
    }
      .search-action:hover {
        cursor: var(--search-action-hover-pointertype, pointer);
      }

      .popup-title{
        text-align:left;
        font-size:var(--font-size-sm, 12px);
        color:var(--text-primary-color,#1a2028);
        font-weight: var(--font-bold, bold); 
      }
      .list{
       @apply(--layout-vertical);
      }      
      paper-item #actionItem{
        line-height: 16px;
      }

    </style>

<input id="searchInput" type="text" value="{{inputValue::input}}" placeholder="{{placeHolder}}" on-keyup="_searchOnEnter"
    class="search-input">
<pebble-icon icon="pebble-md-icons:Searchsmall" on-tap="_search" class="search-action pebble-md-icons"></pebble-icon>

<pebble-popover id="searchOptionsPopover" for="searchInput" auto-fit-on-attach no-overlap>
    <div class="list">        
        <template is="dom-repeat" items="[[_searchOptions]]" as="searchOption">
            <paper-item data="[[searchOption]]" on-tap="_onSearchOptionSelect">
                <div id="actionItem">
                    <span class="popup-title">[[inputValue]]</span> [[searchOption.text]]
                </div>
            </paper-item>
        </template>
    </div>
</pebble-popover>

</template>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'rock-header-search',

            properties: {

                /*
                 * Indicates a placeholder for the search.
                 */
                placeHolder: {
                    type: String,
                    value: "Search MDMCenter"
                },

                /*
                 * Indicates the input value for the search.
                 */
                inputValue: {
                    type: String,
                    value: "",
                    observer: "_onInputChange"
                },

                /*
                * Indicates the search action icon.
                */
                icon: {
                    type: String,
                    value: "pebble-icons:SearchArrow"
                },

                searchConfig: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: "_onSearchConfigChange"
                },

                _searchOptions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _selectedSearchOption: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }

            },

            _onSearchConfigChange: function () {
                if(this.searchConfig && !_.isEmpty(this.searchConfig)) {
                    //Set searchOptions and default selectedSearchOption
                    this._searchOptions = this.searchConfig.searchOptions;
                    this._setDefaultSelectedOption();
                }
            },

            /*
             * Can be used to open a global search page.
             */
            _search: function () {
                if(this._selectedSearchOption && !_.isEmpty(this._selectedSearchOption)) {
                    ComponentHelper.appRoute(this._selectedSearchOption.route, { "searchtext": this.inputValue });
                } else {                    
                    ComponentHelper.appRoute("entity-discovery", { "searchtext": this.inputValue }); //Fallback
                }

                this.inputValue = '';
            },

            /*
             * Can be used to execute search on enter.
             */
            _searchOnEnter: function (e) {
                if (e.keyCode === 13) {
                    this._search();
                }
            },

            _onInputChange: function () {
                var searchOptionsPopover = this.shadowRoot.querySelector('#searchOptionsPopover');

                if (searchOptionsPopover && this._searchOptions && this._searchOptions.length > 0) {
                    if (this.inputValue && this.inputValue.trim() != "") {
                        searchOptionsPopover.show();
                    } else {                        
                        this._setDefaultSelectedOption();
                        searchOptionsPopover.hide();
                    }
                }
            },

            _setDefaultSelectedOption: function () {
                if (this._searchOptions) {
                    for (var i = 0; i < this._searchOptions.length; i++) {
                        if (this._searchOptions[i].isDefault) {
                            this._selectedSearchOption = this._searchOptions[i];
                            break;
                        }
                    }
                }
           },
            
           _onSearchOptionSelect: function (e) {
                var searchOptionsPopover = this.shadowRoot.querySelector('#searchOptionsPopover');
                var data = e.currentTarget.data;
                this._selectedSearchOption = data;
                this._search();

                if (searchOptionsPopover) {
                    searchOptionsPopover.hide();
                }
           }
        });
    })();
</script>

</dom-module>