<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">

<!--
`pebble-relationship-grid` Represents relationship grid control of the entity.

The following JSON object is a sample of entity used for loading relationship

```json
{
  "id": "e2",
  "dataObjectInfo": {
    "dataObjectType": "product",
    "dataObjectDomain": "thing"
  },
  "systemInfo": {
    "tenantId": "t1"
  },
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "ctxInfo": [
      {
        "ctxGroup": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          },
          "copy": {
            "values": [
              {
                "value": "This shrug will add warmth and sophistication for your evening out. Three-quarter sleeves make it a perfect match with any dress or shirt",
                "source": "PLM",
                "locale": "en-US"
              },
              {
                "value": "Dieses Röckchen wird aus Wärme und Eleganz für Ihren Abend hinzuzufügen. Dreiviertel -Ärmeln machen es eine perfekte Übereinstimmung mit jedem Kleid oder Shirt",
                "source": "translation.com",
                "locale": "de-DE"
              }
            ]
          },
          "weight": {
            "values": [
              {
                "value": "3",
                "uom": "lb",
                "source": "SAP",
                "locale": "en-US"
              }
            ]
          },
          "launchDate": {
            "values": [
              {
                "value": "2016-07-16T18:33:52.412-07:00",
                "source": "PLM"
              }
            ]
          },
          "allergenInfo": {
            "groups": [
              {
                "doesTradeItemCarryNutritionLabel": {
                  "values": [
                    {
                      "value": "true",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "tradeItemCubeMeasurement": {
                  "values": [
                    {
                      "value": "0.36",
                      "source": "PLM"
                    }
                  ]
                }
              },
              {
                "doesTradeItemCarryNutritionLabel": {
                  "values": [
                    {
                      "value": "false",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "tradeItemCubeMeasurement": {
                  "values": [
                    {
                      "value": "0.78",
                      "source": "PLM"
                    }
                  ]
                }
              }
            ]
          }
        },
        "relationships": {
          "crosssell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "2",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "200",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relToObject": {
                "id": "e4",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            },
            {
              "id": "rel2",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relToObject": {
                "id": "e5",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relToObject": {
                "id": "e6",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ]
        }
      }
    ]
  }
}
```

@demo demo/index.html
-->

<dom-module id="pebble-relationship-grid">
	<template>
		<style include="pebble-styles-shared"></style>
		      <style>
        
            .relation-name {
                font-weight: 500;
                font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
                clear: both;
                padding-top: 10px;
                margin: 0px;
                font-size: var(--font-size-medium);
            }
            
            .relation-name-container {
                clear: left;
                @apply(--layout-horizontal);
                margin:18px 0 0 0;
            }

            .relation-line-box {
                margin-top:16px;
                margin-left:8px;
                margin-right:8px;
                @apply(--layout-flex);
            }

            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: black;
            }

        </style>
		<template is="dom-if" if="{{_dataIsNotNull(data)}}">
			<template is="dom-if" if="{{_isRelationshipType(relationshipType)}}">
				<div class="relation-name-container" align="left">
					<div class="relation-name-box" style="display:inline-block"><span class="relation-name">[[relationshipType]]</span></div>
					<div class="relation-line-box">
						<pebble-horizontal-divider></pebble-horizontal-divider>
					</div>
				</div>
				<pebble-grid id="entityRelationshipGrid" config="{{_getRelationshipGridConfig(relationshipType)}}" page-size="5" attribute-models="{{attributeModels}}" data="{{_getRelationshipGridData(relationshipType)}}"></pebble-grid>					
			</template>
			<template is="dom-if" if="{{!_isRelationshipType(relationshipType)}}">
				<template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex">
					<div class="relation-name-container" align="left">
						<div class="relation-name-box" style="display:inline-block"><span class="relation-name">[[relationship]]</span></div>
						<div class="relation-line-box">
							<pebble-horizontal-divider></pebble-horizontal-divider>
						</div>
					</div>
					<pebble-grid id="entityRelationshipGrid" config="{{_getRelationshipGridConfig(relationship)}}" page-size="5" attribute-models="{{attributeModels}}" data="{{_getRelationshipGridData(relationship)}}"></pebble-grid>
				</template>
			</template>
		</template>
	</template>
<script> 
	(function () {
		'use strict';

		Polymer({
			is: 'pebble-relationship-grid',
			properties: {
				/**
				 * Indicates a data which is wrapped in a data-source that is used as a grid data.
				 * The format for the JSON object is given in the above description.
				 */
				data: {
					type: Object,
					notify: true,
					observer : '_prepareRelationshipGridConfig'
				},
				/*
				*	Indicates transformed relationship data for grid.
				*/	
				relationshipGridData: {
					type: Array,
					notify: true,
					value : function() {
						return [];
					}
				},

				/*
				*	Indicates transformed relationship grid config for grid.
				*/
				relationshipGridConfig : {
					type : Array,
					notify: true,
					value : function() {
						return [];
					}
				},

				/**
				 * Indicates an attribute models to be used.
				 */
				attributeModels: {
					type: Object,
					notify: true,
					value: function () {
						return {};
					}
				},

				relationshipType: {
					type : String,
					notify: true
				},

				relationshipTypeList : {
					type : Array,
					notify : true,
					value : function() {
						return [];
					}
				}
			},
			_dataIsNotNull: function(data){
				if(data)
				{
					return true;
				}
			},
			_isRelationshipType: function(relationshipType){
				if(relationshipType && relationshipType != '' && this.relationshipType != "Relationships")
				{
					return true;
				}
				else
				{
					return false;
				}
			},
			_getRelationshipGridConfig: function(relationshipTypeName) {
				return this.relationshipGridConfig[relationshipTypeName];
			},
			_getRelationshipGridData: function(relationshipTypeName) {
				return this.relationshipGridData[relationshipTypeName];
			},
			_prepareRelationshipGridConfig: function() {
				if(this.data) 
				{
					if(this.data.data && this.data.data.ctxInfo)
					{
						var contextInfo = this.data.data.ctxInfo[0];
						if(contextInfo && contextInfo.relationships)
						{
							if(this.relationshipType == '' || this.relationshipType == "Relationships")
							{
								Object.keys(contextInfo.relationships).forEach(function(element){
									this._populateConfigAndData(element, contextInfo.relationships);
									this.relationshipTypeList.push(element);
								}, this);
							}
							else
							{
								this._populateConfigAndData(this.relationshipType[0], contextInfo.relationships);
							}
						}
					}
				}
			},
			_populateConfigAndData: function(relationshipTypeName, relationships){
				var data = [];
				var config = {};
				config.viewMode = "Tabular";
				config.mode = "Read";
				config.tabular = {};

				var settings = {};
				settings.isMultiSelect = true;
				settings.actions = [{
                    "name":"delete",
                    "icon":"pebble-icons:Delete",
                    "eventName":"delete-item"
                }]; //Needs to add actions
				config.tabular.settings = settings;
				
				var columns = [];
				columns.push({
					"header" : "Related Entity",
					"name" : "Related Entity",
					"sortable" : true,
					"filterable" : false,
					"editType" : ""
				});

				var relatedEntities = relationships[relationshipTypeName.toLowerCase().replace(" ", "")];
				var addColModel = true;
				var relationshipAttributes = null;
				if(this.relationshipCustomGridConfig && this.relationshipCustomGridConfig.attributes)
				{
					relationshipAttributes = this.relationshipCustomGridConfig.attributes;
				}

				relatedEntities.forEach(function(relElement){
					var record = {};
					
					if(relElement.attributes)
					{
						Object.keys(relElement.attributes).forEach(function(item){
							if(addColModel)
							{
								var relAttribute = {};
								
								relAttribute.header = item;
								relAttribute.name = item;
								relAttribute.sortable = true;
								relAttribute.filterable = false;
								relAttribute.editType = "textbox";

								columns.push(relAttribute);
							}

							if(relElement.attributes[item])
							{
								record[item] = relElement.attributes[item].values[0].value;
							}

						}, this);
						addColModel = false;
					}
					record["Related Entity"] = relElement.relToObject.id;
					data.push(record);
				}, this);

				config.tabular.columns = columns;
				config.title = data.length + " Related Products";

				this.relationshipGridConfig[relationshipTypeName] = config;
				this.relationshipGridData[relationshipTypeName] = data;
			}

		});
	})();
</script>
</dom-module>