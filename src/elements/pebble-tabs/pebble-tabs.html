<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../pebble-tab-group/pebble-tab-group.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">

<!--
` <pebble-tabs>` Represents a tabs with Material Design styling. ` <pebble-tabs>` makes it easy to explore and 
switch between different views or functional aspects of an app, or to browse categorized datasets dynamically.

@demo demo/index.html
-->

<dom-module id="pebble-tabs">
    <style>
        pebble-horizontal-divider {
            --pebble-horizontal-divider-color: black;
        }

        iron-icon {
            margin-right: 0.5em
        }
    </style>
    <template>
        <pebble-tab-group id="pebbletabgroup" selected="{{selectedTabIndex}}" scrollable="[[data.config.scrollable)]]" fit-container="[[data.config.fitToContainer]]"
            on-iron-select="_onTabItemSelected" default-selected-tab-index>
            <template is="dom-repeat" items="[[data.config.tabItems]]" as="tabItem">
                <pebble-tab id="[[tabItem.name]]" display-menu="[[tabItem.enableDropdownMenu]]" tab-config="[[tabItem]]">
                    <div class="tab-title">
                        <iron-icon icon="[[tabItem.icon]]"></iron-icon>
                        [[tabItem.title]]
                    </div>
                    <paper-menu class="dropdown-content" on-iron-select="_onMenuItemSelected">
                        <template is="dom-repeat" items="[[tabItem.menuItems]]" as="menuItem">
                            <template is="dom-if" if="[[!_isDivider(menuItem)]]">
                                <paper-item tab-config="[[tabItem]]" menu-item-config="[[menuItem]]">
                                    <iron-icon icon="[[menuItem.icon]]"></iron-icon>
                                    [[menuItem.title]]
                                </paper-item>
                            </template>
                            <template is="dom-if" if="[[_isDivider(menuItem)]]">
                                <paper-item menu-item-config="[[menuItem]]">
                                    <pebble-horizontal-divider></pebble-horizontal-divider>
                                </paper-item>
                            </template>
                        </template>
                    </paper-menu>
                </pebble-tab>
            </template>
        </pebble-tab-group>

        <template is="dom-repeat" items="[[data.config.tabItems]]" as="tabItemContent">
            <div id="content-[[tabItemContent.name]]" hidden>[[tabItemContent.title]]</div>
            <template is="dom-if" if="[[_hasMenu(tabItemContent)]]">
                <template is="dom-repeat" items="[[tabItemContent.menuItems]]" as="menuItemContent">
                    <div id="content-[[menuItemContent.name]]" hidden>[[menuItemContent.title]]</div>
                </template>
            </template>
        </template>
    </template>

    <script>

        (function() {
            'use strict';

            Polymer({
                is: 'pebble-tabs',
                properties: {
                   
                   /**
                    * Property denoting the data of an `element`
                    */
                    data: {
                        type: Object
                    },

                   /**
                    * Property denoting whether the tab will have an dropdown menu icon or not 
                    */
                    displayMenu: {
                        type: Boolean,
                        value: false
                    },

                   /**
                    * Property denoting the selected index of a tab
                    */
                    selectedTabIndex: {
                        type: Number
                    },

                   /**
                    * Property denoting whether the tabs are scrollable and the tab width is based on the label width.
                    */
                    scrollable: {
                        type: Boolean,
                        value: false,
                    },

                   /**
                    * Property denoting whether the tabs expand to fit their container. This currently only applies when
                    * scrollable is true.
                    */
                    fitContainer: {
                        type: Boolean,
                        value: false
                    },

                     _defaultSelectedTabIndex: {
                        type: Number,
                        computed: "_getSelectedTab(data)"
                    },

                    _currentViewName: {
                        type: String
                    }
                },
               
                _getSelectedTab: function(data) {
                    if(data != null && data != undefined)
                    {
                        var tabItems = data.config.tabItems;
                        if (tabItems != null && tabItems != undefined && tabItems.length > 0)
                        {
                            for(var tabItemIndex in tabItems)
                            {   
                                if(tabItems[tabItemIndex].selected)
                                {
                                    this.selectedTabIndex = tabItemIndex;
                                    return tabItemIndex; 
                                }
                            }
                        }
                    }
                },
                
                _onTabItemSelected: function(e) {
                    this._loadContent(e.detail.item.tabConfig);
                },

                _onMenuItemSelected: function(e) {
                    e.stopPropagation();
                    this._loadContent(e.detail.item.menuItemConfig);
                },

                _isDivider: function(item) {
                    return item.name == "divider";
                },

                _hasMenu: function(tabItemContent) {
                    if(tabItemContent.menuItems) {
                        return true;
                    } else {
                        return false;
                    }
                },

                _loadContent: function(config) {
                    if(config) {
                        var viewName = config.name;
                        var contentElement = this.$$("#content-" + viewName);
                        var openSuccessful = false;

                        if(contentElement.children.length > 0) {
                            openSuccessful = true;
                            this._showView(viewName);

                            if(this._currentViewName) {
                                this._hideView(this._currentViewName);
                            }
                            this._currentViewName = viewName;
                        } else {
                            //cleanup first
                            while (contentElement.firstChild) {
                                Polymer.dom(contentElement).removeChild(contentElement.firstChild);
                            }

                            if(config.component) {
                                this.importHref(config.component.path, function (e) {
                                    //component file import successful
                                    var dynamicEl = document.createElement(config.component.name);
                                    
                                    for (var property in config.component.properties) {
                                        if (config.component.properties.hasOwnProperty(property)) {
                                            
                                            var val = config.component.properties[property];
                                            
                                            if (typeof val == "object") {
                                                dynamicEl.setAttribute(property, JSON.stringify(val));
                                            } else {
                                                dynamicEl.setAttribute(property, val);
                                            }
                                        }
                                    }
                                    
                                    dynamicEl.setAttribute("id", "component");
                                    dynamicEl.setAttribute("class", dynamicEl.getAttribute("class") + " view-component");
                                    Polymer.dom(contentElement).appendChild(dynamicEl);

                                    openSuccessful = true;
                                    this._showView(viewName);

                                    if(this._currentViewName) {
                                        this._hideView(this._currentViewName);
                                    }
                                    this._currentViewName = viewName;

                                },function (e) {
                                    console.log(e);
                                });
                            }
                        }

                    } else {
                        console.log("Tabconfig not available");
                    }
                },

                _showView: function(viewName) {
                    if(viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if(contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },

                _hideView: function(viewName) {
                    if(viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if(contentView) {
                            contentView.setAttribute("hidden", "");
                        }
                    }
                }
            });
        })();

    </script>
</dom-module>