<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-workflow-assignment">
    <template>
        <style include="pebble-styles-shared">           
            .message {
                text-align: center;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>

        <liquid-rest id="entityWfAssignment" url="/pass-through-bulk/entitygovernservice/workflowChangeAssignment" method="POST" request-data={{_assignmentRequest}}
            on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest> 
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-workflow-assignment',

                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    contextData: {
                         type:Object,
                         value: function() {
                            return {};
                         }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    selectedEntities: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    assignmentAction: {
                        type: String
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    workflowCriterion: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    resultAttribute: {
                        type: Object
                    },                    

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },                    

                    _assignmentRequest: {
                        type: Object,
                        value: function () { 
                            return {}; 
                        }
                    },

                    _responseMessages: {
                        type: Array,
                        value: function () { 
                            return []; 
                        }
                    }                                        
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [
                    '_executeAssignmentProcess(contextData, selectedEntities, assignmentAction, workflowCriterion)'
                ],

                _executeAssignmentProcess: function () {
                    // Start process when all the details are available
                    if(this.contextData && !_.isEmpty(this.contextData) && 
                       this.selectedEntities && this.selectedEntities.length > 0 &&
                       this.assignmentAction &&
                       this.workflowCriterion && !_.isEmpty(this.workflowCriterion)) {

                           this._loading = true;
                           this._message = "Assignment process started";
                           this._generateAssignmentRequest();
                    }     
                },        

                _getAttributeValue: function(id, attrName) {
                    if(this.selectedEntities && this.selectedEntities.length > 0)
                    {
                        for(var i = 0; i < this.selectedEntities.length; i++) {
                            if(this.selectedEntities[i].id == id) {
                                return this.selectedEntities[i].attributes[attrName] ? this.selectedEntities[i].attributes[attrName].value : "Not found";
                            }
                        }
                    }
                },

                _generateAssignmentRequest: function () {                    
                    //Prepare request without entity
                    var req = DataRequestHelper.createWfChangeAssignmentRequest(null, this.workflowCriterion, this.contextData, this.assignmentAction); 

                    //Add entities to the request
                    var entities = [];
                    for(var i = 0; i < this.selectedEntities.length; i++)
                    {
                        entities.push({
                            "id": this.selectedEntities[i].id,
                            "type": this.selectedEntities[i].type
                        });
                    }
                    req["entities"] = entities;
                    this.set("_assignmentRequest", req);

                    var liquidWfAssign = this.$$("#entityWfAssignment");
                    if (liquidWfAssign) {
                        liquidWfAssign.generateRequest();
                    }
                },

                _onAssignmentSuccess: function (e) {
                    var request = e.detail.request;
                    var responseList = e.detail.response;
                    this._responseMessages = [];
                    
                    for(var i = 0; i < responseList.length; i++) {
                        //set id
                        var assignmentResponse = {
                            "Entity Id": responseList[i].id
                        };

                        //set name
                        if(this.resultAttribute && !_.isEmpty(this.resultAttribute))
                        {
                            var attrValue = this._getAttributeValue(responseList[i].id, this.resultAttribute.name);
                            assignmentResponse[this.resultAttribute.externalName] = attrValue;
                        }

                        assignmentResponse["Workflow Name"] = this.workflowCriterion.workflowName;
                        assignmentResponse["Workflow Activity Name"] = this.workflowCriterion.workflowActivityExternalName;                        

                        var response = DataHelper.isValidObjectPath(responseList[i], "operationResponse.response") ? responseList[i].operationResponse.response : {};

                        //Success
                        if (!_.isEmpty(response) && response.status.toLowerCase() == "success" && 
                            response.statusDetail && response.statusDetail.message) { 
                            assignmentResponse["Message"] = this.assignmentAction.toLowerCase() == "take" ? "Successfully assigned" : "Successfully released";                            
                        } //Error
                        else if (!_.isEmpty(response) && response.status.toLowerCase() == "error" && 
                            response.statusDetail && response.statusDetail.message) { 
                            assignmentResponse["Message"] = "Assignment request failed";                            
                        } //Success or error, show response message
                        else if (!_.isEmpty(response) && response.statusDetail && 
                                 response.statusDetail.messages && response.statusDetail.messages.length > 0) {
                            assignmentResponse["Message"] = response.statusDetail.messages[0].message;                 
                        }                                              

                        this._responseMessages.push(assignmentResponse);

                    }

                    this._triggerFinishStep();
                },

                _onAssignmentFailure: function (e) {
                    this.logError("WorkFlowAssignmentFailure","response",JSON.stringify(e.detail));
                    this._message = "Failed to perform the workflow assignment. Please contact administrator.";
                },

                _triggerFinishStep: function() {
                    var data = {
                                "messages": this._responseMessages,
                                "actions": [                                    
                                    {
                                        "name": "goBack",
                                        "text": "Take me back to where I started",
                                        "isNotApp": true
                                    }                                                                    
                                ]                            
                            };

                        this.businessFunctionData = data;                        
                        var eventName = "onComplete";
                        var eventDetail = {
                            name: eventName
                        }

                        this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                        });
                        
                        this._message = "About to complete, please wait...";
                        this._loading = true;

                        //Reset
                        this.contextData = {};
                        this.selectedEntities = [];
                        this.workflowCriterion = {};
                        this.assignmentAction = "";

                }                              
            });
        })();
    </script>
</dom-module>