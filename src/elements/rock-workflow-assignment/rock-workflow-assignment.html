<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-workflow-assignment">
    <template>
        <style include="pebble-styles-shared">           
            .message {
                text-align: center;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>

        <liquid-rest id="entityWfAssignment" url="/pass-through-bulk/entitygovernservice/workflowChangeAssignment" method="POST" request-data={{_assignmentRequest}}
            on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>

        <liquid-rest id="asyncEntityWfAssignment" url="/data/pass-through/bulkentityservice/createtask" method="POST" request-data={{_asyncAssignmentRequest}}
            on-liquid-response="_onAsyncAssignmentSuccess" on-liquid-error="_onAsyncAssignmentFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-workflow-assignment',

                properties: {

                    /**
                     * Represents selection mode query or count                     
                     */
                    selectionMode: {
                        type: String,
                        value: "count"
                    },

                    /** 
                     * Represents criteria query                     
                     */
                    selectionQuery: {
                        type: Object,
                        value: function() {
                            return {
                                "keywordsCriterion": {
                                    "keywords": "goldensku001",
                                    "operator": "_AND"
                                },
                                "filters": {
                                    "typesCriterion": [
                                        "sku"
                                    ]
                                }
                            };
                        }
                    },
                   /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    contextData: {
                         type:Object,
                         value: function() {
                            return {};
                         }
                    },
                   /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    selectedEntities: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                   /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    assignmentAction: {
                        type: String
                    },
                   /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    workflowCriterion: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                   /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    resultAttribute: {
                        type: Object
                    },                    

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },                    

                    _assignmentRequest: {
                        type: Object,
                        value: function () { 
                            return {}; 
                        }
                    },

                    _responseMessages: {
                        type: Array,
                        value: function () { 
                            return []; 
                        }
                    },

                    syncThreshold: {
                        type: String,
                        value: 20
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [
                    '_executeAssignmentProcess(contextData, assignmentAction, workflowCriterion)'
                ],

                _executeAssignmentProcess: function () {
                    // Start process when all the details are available
                    if(this.contextData && !_.isEmpty(this.contextData) &&
                       this.assignmentAction && this.workflowCriterion && !_.isEmpty(this.workflowCriterion)) {

                           this._loading = true;
                           this._message = "Assignment process started";
                           this._generateAssignmentRequest();
                    }     
                },                

                _getAttributeValue: function(id, attrName) {
                    if(this.selectedEntities && this.selectedEntities.length > 0)
                    {
                        for(var i = 0; i < this.selectedEntities.length; i++) {
                            if(this.selectedEntities[i].id == id) {
                                var attribute;
                                if(this.selectedEntities[i] && DataHelper.isValidObjectPath(this.selectedEntities[i], "data.attributes")) {
                                    attribute = this.selectedEntities[i].data.attributes[attrName];
                                }
                                return attribute ? attribute.values[0].value : "Not found";
                            }
                        }
                    }
                },

                _generateAssignmentRequest: function () {

                    // No selectionMode or selectionMode as count should have selectedEntities to do process
                    if((!this.selectionMode || this.selectionMode == "count") && (!this.selectedEntities || this.selectedEntities.length == 0)) {
                        this._message = "Entities not available for the process";
                        this._loading = false;
                        return;
                    }

                    //Prepare request without entity
                    var req = DataRequestHelper.createWfChangeAssignmentRequest(null, this.workflowCriterion, this.contextData, this.assignmentAction); 

                    //Add entities to the request
                    var entities = [];
                    var entityTypes = [];
                    for (var i = 0; i < this.selectedEntities.length; i++) {
                        entities.push({
                            "id": this.selectedEntities[i].id,
                            "type": this.selectedEntities[i].type
                        });

                        if(entityTypes.indexOf(this.selectedEntities[i].type) == -1) {
                           entityTypes.push(this.selectedEntities[i].type); 
                        }
                    }
                    
                    if(this.selectionMode == "query" || (this.selectionMode == "count" && this.selectedEntities.length > this.syncThreshold)) {
                        if(this.selectionMode == "count") { //query with ids
                            var ids = [0];
                            if (entities.length > 0) {
                                ids = [...new Set(entities.map((obj) => obj.id))];
                            }
                            req.params.query = {
                                "id": ids,
                                "filters": {
                                    "typesCriterion": entityTypes
                                }
                            };
                        } else { //query with keyword
                            req.params.query = this.selectionQuery;
                        }

                        //Async process
                        var asyncLiquidWfAssign = this.$$("#asyncEntityWfAssignment");
                        req.params.taskType = "changeAssignment-query";
                        req.params.operationType = "inboundService";
                        this.set("_asyncAssignmentRequest", req);
                        if (asyncLiquidWfAssign) {
                            asyncLiquidWfAssign.generateRequest();
                        }
                    }
                    else { // Sync process
                        req["entities"] = entities;
                        var liquidWfAssign = this.$$("#entityWfAssignment");
                        this.set("_assignmentRequest", req);
                        if (liquidWfAssign) {
                            liquidWfAssign.generateRequest();
                        }
                    }                                       
                },

                _onAssignmentSuccess: function (e) {
                    var request = e.detail.request;
                    var responseList = e.detail.response;
                    this._responseMessages = [];
                    
                    for(var i = 0; i < responseList.length; i++) {
                        //set id
                        var assignmentResponse = {
                            "Entity Id": responseList[i].id
                        };

                        //set name
                        if(this.resultAttribute && !_.isEmpty(this.resultAttribute))
                        {
                            var attrValue = this._getAttributeValue(responseList[i].id, this.resultAttribute.name);
                            assignmentResponse[this.resultAttribute.externalName] = attrValue;
                        }

                        assignmentResponse["Workflow Name"] = this.workflowCriterion.workflowName;
                        assignmentResponse["Workflow Activity Name"] = this.workflowCriterion.workflowActivityExternalName;                        

                        var response = DataHelper.isValidObjectPath(responseList[i], "operationResponse.response") ? responseList[i].operationResponse.response : {};

                        //Success
                        if (!_.isEmpty(response) && response.status.toLowerCase() == "success" && 
                            response.statusDetail && response.statusDetail.message) { 
                            assignmentResponse["Message"] = this.assignmentAction.toLowerCase() == "take" ? "Successfully assigned" : "Successfully released";                            
                        } //Error
                        else if (!_.isEmpty(response) && response.status.toLowerCase() == "error" && 
                            response.statusDetail && response.statusDetail.message) { 
                            assignmentResponse["Message"] = "Assignment request failed";                            
                        } //Success or error, show response message
                        else if (!_.isEmpty(response) && response.statusDetail && 
                                 response.statusDetail.messages && response.statusDetail.messages.length > 0) {
                            assignmentResponse["Message"] = response.statusDetail.messages[0].message;                 
                        }                                              

                        this._responseMessages.push(assignmentResponse);

                    }

                    this._triggerFinishStep();
                },

                _onAssignmentFailure: function (e) {
                    this._loading = false;
                    this._message = "Failed to perform the workflow assignment. Please contact administrator.";
                    this.logError("WorkFlowAssignmentFailure","response",JSON.stringify(e.detail));
                },

                _onAsyncAssignmentSuccess: function (e) {
                    var response = e.detail.response && e.detail.response.response ? e.detail.response.response : e.detail.response;
                    var request = e.detail.response ? e.detail.response.request : undefined;

                    if((!response || _.isEmpty(response)) ||
                       (DataHelper.isValidObjectPath(response, "dataObjectOperationResponse.status") && response.dataObjectOperationResponse.status.toLowerCase() == "error") ||
                       (response.status && response.status.toLowerCase() == "error")) {
                        this._message = "Assignment request failed";
                        this._loading = false;
                        return;
                    } else {
                        if(response.status && response.status.toLowerCase() == "success") {                            
                            this._responseMessages.push({
                                "Request Id": request ? request.requestId : "Not available",
                                "Task Id": request ? request.taskId : "Not available",
                                "Message": "Assignment process triggered, please verify the status in jobs"
                            });
                        }
                                                
                        this._message = "Assignment request triggered successfully";                        
                        this._triggerFinishStep();
                    }
                },

                _onAsyncAssignmentFailure: function (e) {
                   this._loading = false;
                   this._message = "Failed to perform the workflow assignment. Please contact administrator.";
                   this.logError("WorkFlowAssignmentFailure","response",JSON.stringify(e.detail));
                },

                _triggerFinishStep: function() {
                    var data = {
                                "messages": this._responseMessages,
                                "actions": [                                    
                                    {
                                        "name": "goBack",
                                        "text": "Take me back to where I started",
                                        "isNotApp": true
                                    },
                                    {
                                        "name": "gotoJobDetails",
                                        "text": "Take Me to Job Details",
                                        "isNotApp": true,
                                        "dataRoute":"dashboard"
                                    }                                                                    
                                ]                            
                            };

                        this.businessFunctionData = data;                        
                        var eventName = "onComplete";
                        var eventDetail = {
                            name: eventName
                        }

                        this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                        });
                        
                        this._message = "About to complete, please wait...";
                        this._loading = true;

                        //Reset
                        this.contextData = {};
                        this.selectedEntities = [];
                        this.workflowCriterion = {};
                        this.assignmentAction = "";
                        
                }                              
            });
        })();
    </script>
</dom-module>