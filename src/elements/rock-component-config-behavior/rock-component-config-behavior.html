<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">

<script>
    /*
    * <i><b>Content development is under progress... </b></i>
    * @demo demo/index.html
    * @polymerBehavior RUFBehaviors.ComponentConfigBehavior
    */
    window.RUFBehaviors = window.RUFBehaviors || {};

    /** @polymerBehavior RUFBehaviors.ComponentConfigBehavior */
    RUFBehaviors.ComponentConfigBehavior = {
        properties: {
            componentConfig: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            DEFAULT_CONTEXT_KEY: {
                type: String,
                value: '_DEFAULT'
            }
        },
        requestConfig: function (component, contextData) {
            var configRequest = this._buildConfigRequest(component, contextData);
            this._initiateComponentConfigGetRequest(configRequest);
        },
        onConfigLoaded: function (componentConfig) {
            // This is abstract method and consumer of this behavior need to implement it
        },
        _buildConfigRequest: function (component, contextData) {

            if (!component) {
                component = this.localName;
            }

            if (_.isEmpty(component)) {
                throw "Component name is not available to fetch component config";
            }

            if (!contextData && this.contextData) {
                contextData = this.contextData;
            }

            var configContext = this._createConfigContext(component, contextData);
            var configId = this._createConfigId(configContext);

            return DataRequestHelper.createConfigGetRequestNew(configId, configContext);
        },
        _createConfigContext: function (component, contextData) {
            var appContext = {};
            var domainContext = {};
            var dataContext = {};
            var valueContext = {};
            var itemContext = {};
            var userContext = {};

            var DEFAULT_CONTEXT_KEY = this.DEFAULT_CONTEXT_KEY;

            if (contextData) {
                appContext = ContextHelper.getFirstAppContext(contextData);
                domainContext = ContextHelper.getFirstDomainContext(contextData);
                dataContext = ContextHelper.getFirstDataContext(contextData);
                valueContext = ContextHelper.getFirstValueContext(contextData);
                itemContext = ContextHelper.getFirstItemContext(contextData);
                userContext = ContextHelper.getFirstUserContext(contextData);
            }

            var domain = domainContext && domainContext.domain ? domainContext.domain : DEFAULT_CONTEXT_KEY;
            var app = appContext && appContext.app ? appContext.app : DEFAULT_CONTEXT_KEY;
            var entityType = itemContext && itemContext.type ? itemContext.type : DEFAULT_CONTEXT_KEY;

            var configContext = {
                "component": component,
                "sysDomain": domain,
                "sysApp": app,
                "sysEntityType": entityType,
                "tenant": userContext && userContext.tenant ? userContext.tenant : DEFAULT_CONTEXT_KEY,
                "domain": domain,
                "app": app,
                "entityType": entityType
            };

            // copy over dataContext keys to config context
            configContext = Object.assign(configContext, dataContext);

            configContext.relationship = itemContext && itemContext.relationship ? itemContext.relationship : DEFAULT_CONTEXT_KEY;

            // copy over value context keys to config context
            configContext = Object.assign(configContext, valueContext);

            configContext.role = userContext && userContext.role ? userContext.role : DEFAULT_CONTEXT_KEY,
                configContext.user = userContext && userContext.user ? userContext.user : DEFAULT_CONTEXT_KEY

            return configContext;
        },
        _createConfigId: function (configContext) {
            var configId = 'x-';
            for (var contextKey in configContext) {
                var contextVal = configContext[contextKey];
                if (!_.isEmpty(contextVal) && contextVal != this.DEFAULT_CONTEXT_KEY) {
                    if (configId == 'x-') {
                        configId = configId + contextVal;
                    }
                    else {
                        configId = configId + "_" + contextVal;
                    }
                }
            }

            configId = configId + "_uiConfig";

            return configId;
        },
        _initiateComponentConfigGetRequest: function (configRequest) {
            var liquidCustomElement = customElements.get("liquid-config-get");

            var liquidElement = new liquidCustomElement();

            liquidElement.requestData = configRequest;
            liquidElement.operation = "getbyids";
            liquidElement.addEventListener("response", this._onComponentConfigGetResponse.bind(this));
            liquidElement.addEventListener("error", this._onComponentConfigGetError.bind(this));

            liquidElement.generateRequest();
        },
        _onComponentConfigGetResponse: function (e) {
            if (e.detail) {
                var res = e.detail.response.content;

                if (DataHelper.isValidObjectPath(res, 'configObjects.0.data.contexts.0.jsonData')) {
                    var compConfig = res.configObjects[0].data.contexts[0].jsonData;

                    if (_.isEmpty(compConfig)) {
                        this._logError("RUF_UI_EMPTY_CONFIG", e);
                    }

                    this.componentConfig = compConfig;
                }

                this.onConfigLoaded(this.componentConfig);
            }
        },
        _logError: function (msg, eventData) {
            var logDetail = {
                "request": e.detail.request.requestData,
                "requestId": e.detail.request.requestData.requestId,
                "reason": e.detail.response.reason
            };

            RUFUtilities.Logger.error(msg, logDetail, "ui-config-manager");
        },

        _onComponentConfigGetError: function (e) {
            if (e.detail) {
                this._logError("RUF_UI_CONFIG_GET_EXCEPTION", e);
                console.log('config get request failed with error: ', e.detail);
            }
        }
    };

</script>