<!doctype html>
<html>
<head>
  <title>rock-extension-manage test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../../bower_components/web-component-tester/browser.js"></script>
  
  <link rel="import" href="../rock-extension-manage.html">
</head>
<body>
  <test-fixture id="basic">
    <template>
      <rock-extension-manage></rock-extension-manage>
    </template>
  </test-fixture>
  <script>
      function fireEvent(type, props, node) {
        var event = new CustomEvent(type, {
          bubbles: true,
          cancelable: true
        });
        for (var p in props) {
          event[p] = props[p];
        }
        node.dispatchEvent(event);
      };

      setup(function() {
          rockElement = fixture('basic');
      });
      suite('rock-extension-manage', function() {
        
        test('instantiating the element works', function() {
          assert.equal(rockElement.is, 'rock-extension-manage');
        });

        test('tree is multi select with tree items searchable', function() {
          var treeElement = rockElement.$$("#contextTree");
          assert.equal(treeElement.enableSearch, true);
          assert.equal(treeElement.multiSelect, true);
        });

        test('tree element is loaded with tree data', function(done) {
          rockElement.async(function() {
            var treeElement = rockElement.$$("#contextTree");
            assert.equal(!_.isEmpty(treeElement.data), true);
            done();
          }, 500);
        });

        test('selecting node without children will add extension card in expansion panel', function(done) {
          var itemPath = "0.0";
          rockElement.async(function(){
            var treeElement = rockElement.$$("#contextTree");
            var node = treeElement.getElementNodeByPath(itemPath);
            node.selectItem();
            var div = rockElement.querySelector('.card');
            assert.notEqual(div,null);
            done();
          }, 500);
        });

        test('selecting node with children will not add extension card in expansion panel', function(done) {
          var itemPath = "0.2";
          rockElement.async(function(){
            var treeElement = rockElement.$$("#contextTree");
            var node = treeElement.getElementNodeByPath(itemPath);
            node.selectItem();
            var div = rockElement.querySelector('.card');
            assert.equal(div,null);
            done();
          }, 500);
        });

        test('when a node is selected in tree its parent item is selected', function(done) {
          var itemPath = "0.2";
          rockElement.async(function() {
            var treeElement = rockElement.$$("#contextTree");
            var node = treeElement.getElementNodeByPath(itemPath);
            var parentItem = treeElement.getParentItemForNode(node);
            node.selectItem();
            var selectedItems = treeElement.selectedItems;
            var indeterminateItems = treeElement.indeterminateItems;
            if(indeterminateItems && indeterminateItems.length > 0) {
              for(var i=0; i< indeterminateItems.length; i++) {
                selectedItems.push(indeterminateItems[i]);
              }
            }
            assert.notEqual(selectedItems.indexOf(parentItem), -1);
            done();
          },500);
        });

        test('buttons are visible only when a node in tree is selected', function(done) {
          var buttons = rockElement.$$("#buttonContainer");
          assert.equal(window.getComputedStyle(buttons, null).display, 'none');
          var itemPath = "0.2";
          rockElement.async(function() {
            var treeElement = rockElement.$$("#contextTree");
            var node = treeElement.getElementNodeByPath(itemPath);
            node.selectItem();
            assert.notEqual(window.getComputedStyle(buttons, null).display, 'none');
            done();
          },500);
        });

        test('all selected items are cleared in tree when cancel button clicked', function(done) {
          var cancelButton = rockElement.$$("#cancel");
          var treeElement = rockElement.$$("#contextTree");
          var itemPath = "0.2";
          rockElement.async(function() {
            assert.equal(_.isEmpty(treeElement.selectedItems), true);
            var node = treeElement.getElementNodeByPath(itemPath);
            node.selectItem();
            assert.equal(!_.isEmpty(treeElement.selectedItems), true);
            fireEvent('tap', {}, cancelButton);
            assert.equal(_.isEmpty(treeElement.selectedItems), true);
            done();
          }, 500);
        });
     });
    </script>
</body>
</html>