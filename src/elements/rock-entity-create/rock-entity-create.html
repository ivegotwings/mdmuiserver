<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../rock-attribute/rock-attribute.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<dom-module id="rock-entity-create">
    <template>
        <style include="pebble-styles-shared">
            .attribute-box {
				display: inline-block;
                width: 33%;
			}

            #actions-container {
                padding-top: 30px;
            }

            pebble-button {
                --pebble-button: {
                    height: 30px;
                    font-size: 15px;
                    border: 1px solid #036BC3;
                    color: #036BC3;
                    background: #fff;
                    padding: 0px 30px !important;
                }
            }
        </style>
        <div id="content">
            <template is="dom-repeat" items="[[attributeNames]]" as="name">
                <div class="attribute-box">
                    <rock-attribute mode="edit" attribute-model-object="[[_getAttributeModel(attributeModelResponse, name)]]" attribute-object="{{_getAttribute(_attributeValues,name)}}"
                        original-attribute-object="[[_cloneObject(attribute)]]"></rock-attribute>
                </div>
            </template>
        </div>
        <liquid-entity-get name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
        <div id="actions-container" align="center">
            <pebble-button id="skip" button-text="Cancel" raised on-tap="_onSkipTap"></pebble-button>
            <pebble-button id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-entity-create",

                properties: {
                   importProfileName: {
                       type: String,
                       value: function() { return null; }
                   },
                   attributeNames: {
                       type: Array,
                       value: function() { return []; }
                   },
                   attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {
                                action: "getAttributeModels"
                            };
                        }
                    },
                    attributeModelResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                observers: [
                    '_attributeModelResponseChanged(attributeModelResponse)',
                    '_attributesChanged(attributeNames)'
                ],
                _attributesChanged: function(attributeNames) {
                    var t = {
                            action: "getAttributeModels"
                        };
                    this.set("attributeModelRequest", t);
                },
                _attributeModelResponseChanged: function(attributeModelResponse) {
                    var values = [];
                     var locale = "en-US", 
                            time = 'now', 
                            source = "SAP";
                    if(attributeModelResponse && attributeModelResponse.returnValue 
                    && attributeModelResponse.returnValue.attributeModels && this.attributeNames) {
                        values = DataHelper.transformAttributeToUIFormat(this.attributeNames, attributeModelResponse
                            .returnValue
                            .attributeModels, locale, time, source);
                    }
                    this._attributeValues = values;
                },
                _getAttributeModel: function (attributeModelResponse, name) {
                    var attribute = this._getAttribute(this._attributeValues, name);
                    if (attribute && attributeModelResponse && attributeModelResponse.returnValue &&
                        attributeModelResponse.returnValue.attributeModels) {
                        for (var attributeGroupName in attributeModelResponse.returnValue.attributeModels) {
                            if (attribute.name in attributeModelResponse.returnValue.attributeModels[
                                    attributeGroupName]) {
                                return attributeModelResponse.returnValue.attributeModels[
                                    attributeGroupName][attribute.name];
                            }
                        }
                    }
                },
                _getAttribute: function(_attributeValues, attributeName) {
                    if(_attributeValues && _attributeValues.length && _attributeValues.length>0 && attributeName) {
                        for(var i=0; i<_attributeValues.length; i++) {
                            var attributes = _attributeValues[i].attributes;
                            if(attributes && attributes.length && attributes.length > 0) {
                                for(var j=0; j<attributes.length; j++) {
                                    if(attributes[j].name == attributeName) {
                                        return attributes[j];
                                    }
                                }
                            }
                        }
                    }
                },
                _cloneObject: function (o) {
                    return DataHelper.cloneObject(o);
                },
                _onSaveTap: function(e) {
                    //raise event with name given for onNextAction in configuration
                    var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
                    var attributesJSON = [];
                    if(changedAttributeElements && changedAttributeElements.length > 0) {
                        for (var i = 0; i < changedAttributeElements.length; i++) {
                            var attributeElement = changedAttributeElements[i];
                            var attributeJSON = attributeElement.attributeObject;
                            attributesJSON.push(attributeJSON);
                        }
                    }
                    var eventName = "onSave";
                    var eventDetail = {
                        name: eventName,
                        data: attributesJSON
                    }
                    this.fireBedrockEvent(eventName, eventDetail,{ ignoreId: true });
                },
                _onSkipTap: function(e) {
                    //raise event with name given for onbackAction in configuration
                    var data;
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName,
                        data: data
                    }
                    this.fireBedrockEvent(eventName, eventDetail,{ ignoreId: true });
                }
            });
        })();
    </script>
</dom-module>