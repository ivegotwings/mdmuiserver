<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">

<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<!--
    `rock-entity-create` Represents a component that renders a view for creating a new entity with the options "single entity creation",
    "multiple entities creation", and "bulk entity creation with import".

    Single Entity create renders a list of initial attributes that are to be filled initially for creating an entity.

    @demo demo/index.html
-->
<dom-module id="rock-entity-create">
    <template>
        <style include="pebble-styles-shared">
            .attribute-box {
                display: inline-block;
                width: 33%;
            }
            
            #content-actions {
                padding-top: 30px;
            }
            
            #content-buttons {
                padding: var(--default-box-padding);
            }
            
            #manualActions::shadow #actionsPopover {
                margin-top: 7px;
            }
            
            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
            }
            
            .placeHolder {
                width: 880px;
                height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }
            
            #multiEntityUpperGrid::shadow iron-data-table {
                height: 135px;
            }
            
            #upperGridHeader {
                font-size: 12px;
                margin: 10px;
            }
            
            #content-single-entity {
                box-shadow: 0 1px 7px 0 #c1cad4;
            }
            
            #content-buttons::shadow #manualActions::shadow #actionsPopover::shadow .pebble-xl-icons {
                width: 10px !important;
                height: 10px !important;
            }
            #manualActions::shadow pebble-popover paper-item {
                display: inline-block;
                word-break: break-all;
                width:92px;
                white-space: normal;
                text-align: center;
                padding:10px;
                color:var(--palette-dark, #1a2028);
               }
            #manualActions::shadow pebble-popover {
                width: auto !important;
                min-width: inherit;
                padding: 5px;
                color: var(--palette-white,#fff);
            }
            #manualActions ::shadow paper-item:hover{   
                box-shadow: 0 0 3px 2px rgba(236, 241, 247, 0.7);
                color: var(--primary-button-color, #036bc3);
                
            }
            #manualActions::shadow pebble-popover paper-item #actionItem:hover {
                background: none;
                color: var(--primary-button-color, #036bc3);
            }
            #manualActions::shadow pebble-popover paper-item #actionItem{
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-steel-grey);
                line-height: 16px;
            }            

        </style>
        <div id="content-description" align="center" hidden>
            <!-- description message here -->
            <div class="title m-0">
                Select how you would like to create a new product. You can create one manually or by importing data in any format you have.
            </div>
        </div>
        <div id="content-buttons" align="center" hidden>
            <!-- manual and import buttons here -->
            <iron-ajax auto url="actions-config.json" handle-as="json" last-response="{{actionsData}}"></iron-ajax>
            <pebble-actions id="manualActions" class="dropdownText btn dropdown-outline-primary m-r-5" button-text="Manual" actions-data="[[actionsData]]"></pebble-actions>
            <pebble-button class="import-button dropdownText btn dropdown-outline-primary" button-text="Import" dropdown-icon raised on-tap="_onImportTap"></pebble-button>
        </div>
        <div id="step-label">
            <!-- label of the current step here -->
        </div>
        <div id="content-single-entity" hidden>
            <rock-attribute-list attribute-values="[[_attributeValues]]" attribute-models="[[_attributeModels]]" no-of-columns="3" mode="{{mode}}"></rock-attribute-list>
            <div id="content-actions" class="p-b-10" align="center" hidden>
                <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onSkipTap"></pebble-button>
                <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
            </div>
        </div>
        <div id="content-multiple-entity" hidden>
            <!-- screen for multi entity create function- probably grid -->
            <iron-ajax auto url="config\gridConfig.json" handle-as="json" last-response="{{_gridConfig}}"></iron-ajax>
            <div id="upperGridHeader"><b>[[attributeNames.length]] Attributes</b> ([[_managedAttrs]] Managed, [[_mappedAttrs]] Mapped, [[_newAttrs]]
                New). Last Updated on <b>[[_currentDateTime.date]]</b> at <b>[[_currentDateTime.time]]</b></div>
            <rock-grid id="multiEntityUpperGrid" page-size="2" no-header></rock-grid>
            <bedrock-pubsub on-bedrock-event-save-item="_onSaveItem"></bedrock-pubsub>
        </div>
        <div id="content-entity-import" hidden>
            <div class="placeHolder p-10">
                <p class="title">Download a system template or just upload an existing data file</p>
                <!-- screen for import -->
                <pebble-file-upload accept="application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint,
                    text/plain, application/pdf, image/*" target="/file-upload"></pebble-file-upload>
                <bedrock-pubsub on-bedrock-event-pebble-file-upload-success="_onFileUploadSuccess"></bedrock-pubsub>
            </div>
        </div>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{attributeModelRequest}}" 
            on-response="_onCompositeModelGetResponse"></liquid-entity-model-composite-get>
        <liquid-entity-data-save name="attributeSaveDataService" operation="create" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
            on-response="_onSaveResponse"></liquid-entity-data-save>
        <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-entity-create",

                properties: {
                    /**
                     * Indicates the profile name that is used for imports.
                     */
                    importProfileName: {
                        type: String,
                        value: function() {
                            return null;
                        }
                    },
                    /**
                     * Indicates the names of the attributes that are rendered while creating a single entity.
                     */
                    attributeNames: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                    /**
                     * Indicates the mode in which the attributes are rendered.
                     */
                    mode: {
                        type: String,
                        value: "edit",
                        notify: true
                    },
                    /**
                     * Specifies the request object for attribute model request.
                     */
                    attributeModelRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    /**
                     * Specifies the response object for attribute models.
                     */
                    attributeModelResponse: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    /**
                     * Specifies the source in which entity has to be created.
                     */
                    source: {
                        type: String
                    },
                    /**
                     * Specifies the locale in which entity has to be created.
                     */
                    locale: {
                        type: String
                    },
                    /**
                     * Specifies the list in which entity has to be created.
                     */
                    list: {
                        type: String
                    },
                    /**
                     * Specifies the classification in which entity has to be created.
                     */
                    classification: {
                        type: String
                    },
                    /**
                     * Specifies the type of the entity to be created.
                     */
                    entityType: {
                        type: String
                    },
                    _attributeValues: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                    _attributeModels: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _saveRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _saveResponse: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _currentViewName: {
                        type: String
                    },
                    _isDirty: {
                        type: Boolean,
                        value: false
                    },
                    _gridConfig: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _gridData: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                    _managedAttrs: {
                        type: Number,
                        value: 0
                    },
                    _mappedAttrs: {
                        type: Number,
                        value: 0
                    },
                    _newAttrs: {
                        type: Number,
                        value: 0
                    },
                    _currentDateTime: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    context: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                observers: [
                    '_contextChanged(attributeNames, source, locale, list)'
                ],
                ready: function() {
                    this._prepareContext();
                    this._showView("description");
                    this._showView("buttons");
                },
                _prepareContext: function() {
                    this.source = DataHelper.getParamValue("source");
                    this.locale = DataHelper.getParamValue("locale");
                    this.list = DataHelper.getParamValue("list");
                    this.classification = DataHelper.getParamValue("classification");
                    this.entityType = DataHelper.getParamValue("entityType");
                },
                _getCurrentCtx: function() {
                    var ctxItem = {};
                    ctxItem.list = this.list;
                    ctxItem.classification = this.classification;
                    return ctxItem;
                },
                _contextChanged: function(attributeNames, context) {
                    if (attributeNames && attributeNames.length > 0) {
                        var ctxGroup = this._getCurrentCtx();
                        var t = {
                            "params": {
                                "query": {
                                    "ctx": [
                                        ctxGroup
                                    ],
                                    "locale": this.locale,
                                    "name": this.entityType
                                },
                                "fields": {
                                    "ctxTypes": [
                                        "properties"
                                    ],
                                    "attributes": attributeNames
                                }
                            }
                        };
                        this.set("attributeModelRequest", t);
                        var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                        if (liquidModelGet) {
                            liquidModelGet.generateRequest();
                        }
                    }
                },
                _onCompositeModelGetResponse: function(e) {
                    var values = [];

                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {

                        var valCtx = {
                            "locale": this.locale,
                            "source": this.source
                        };

                        var ctxGroup = this._getCurrentCtx();
                        this._attributeModels = DataHelper.transformAttributeModelsToUIFormat(e.detail.response.content.entityModels[0], ctxGroup);
                        values = DataHelper.transformAttributesToManageFormat({}, this._attributeModels, valCtx);
                    }
                    this._attributeValues = values;
                },
                _onSaveTap: function(e) {
                    //raise event with name given for onNextAction in configuration
                    var attributeList = Polymer.dom(this).node.root.querySelector('rock-attribute-list');
                    var changedAttributeElements = attributeList.getChangedAttributeElements();
                    if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                        // document.querySelector('#app').toastText = "No changes to save";
                        // document.querySelector('#app').$.pebbleAppToast.show();
                        return {
                            "message": "No changes to save"
                        };
                    }
                    var attributesJSON = [];
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        var attributeJSON = attributeElement.attributeObject;
                        attributesJSON.push(attributeJSON);
                    }
                    var changedAttributes = DataHelper.transformAttributeFromUIFormat(attributesJSON);
                    var entityData = {};
                    entityData = this._getEntityData(changedAttributes);

                    //TODO:: this must come from some model config
                    this._populateEntityIdFromAttrVal(entityData, changedAttributes, "cpimProductName");
                    this._populateEntityIdFromAttrVal(entityData, changedAttributes, "shortDescription");
                    this._populateEntityIdFromAttrVal(entityData, changedAttributes, "skuid");
                    this._saveRequest = {
                        "entities": entityData
                    };
                    var liquidSave = this.$$("[name=attributeSaveDataService]");
                    if (liquidSave) {
                        liquidSave.generateRequest();
                    }
                },
                _populateEntityIdFromAttrVal: function(entities, changedAttributes, attrName) {
                    if (attrName in changedAttributes) {
                        var attr = changedAttributes[attrName];

                        if (attr.values && attr.values.length > 0) {
                            entities[0].id = attr.values[0].value;
                        }
                    }
                },
                _onSaveResponse: function(e) {
                    var eventName = "onSave";
                    var eventDetail = {
                        name: eventName
                    }
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _onSkipTap: function(e) {
                    //raise event with name given for onbackAction in configuration
                    var data;
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName,
                        data: data
                    }
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _onActionItemTap: function(e, detail, sender) {
                    if (detail && detail.data) {
                        if (this._isDirty) {
                            if (window.confirm("Changes done so far are saved. Do you want to leave the page?")) {
                                // do nothing
                            } else {
                                return;
                            }
                        }
                        this._isDirty = true;
                        if (detail.data.name == "createSingleProduct") {
                            // show div manual-single
                            this._hideView("description");
                            this._hideView(this._currentViewName);
                            this._showView("single-entity");
                            this._showView("actions");
                            this._currentViewName = "single-entity";
                        }
                        if (detail.data.name == "createMultiProduct") {
                            // show div manual-multi
                            this._hideView("description");
                            this._hideView(this._currentViewName);
                            this._showView("multiple-entity");
                            this._currentViewName = "multiple-entity";
                            this._populateMultiEntityUpperGrid();
                        }
                    }
                },
                _onImportTap: function() {
                    // show div content-import
                    if (this._isDirty) {
                        if (window.confirm("Changes done so far are saved. Do you want to leave the page?")) {
                            // do nothing
                        } else {
                            return;
                        }
                    }
                    this._isDirty = true;
                    this._hideView("description");
                    this._hideView("actions");
                    this._hideView(this._currentViewName);
                    this._showView("entity-import");
                    this._currentViewName = "entity-import";
                },
                _showView: function(viewName) {
                    if (viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if (contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },

                _hideView: function(viewName) {
                    if (viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if (contentView) {
                            contentView.setAttribute("hidden", "");
                        }
                    }
                },
                _getRandomString: function() {
                    var x = 2147483648;
                    return Math.floor(Math.random() * x).toString(36) +
                        Math.abs(Math.floor(Math.random() * x) ^ new Date().getTime()).toString(36);
                },
                _getEntityData: function(attributes) {
                    var entityId = "e" + this._getRandomString();
                    var data = [];
                    var ctxGroup = this._getCurrentCtx();
                    var entity = {
                        id: entityId,
                        entityInfo: {
                            "entityType": this.entityType
                        },
                        properties: {
                            "createdBy": "John Doe"
                        },
                        data: {
                            ctxInfo: [{
                                "ctxGroup": ctxGroup,
                                "attributes": attributes
                            }]
                        }
                    };
                    data.push(entity);
                    return data;
                },
                /**
                 * Can be used to get the information whether the element is dirty or not.
                 */
                getIsDirty: function() {
                    return this._isDirty;
                },

                _populateMultiEntityUpperGrid: function() {
                    //Fetch the attributes from COP and pass to this.attributeNames
                    //Based on attributeNames change, attributeModelRequest will be set
                    //Using attributeModelGetServiceFetch, attribute models will be provided

                    //Prepare grid configuration and data based on COP and Liquid details                    
                    this._prepareMultiEntityUpperGridConfiguration();
                    this._prepareMultiEntityUpperGridData();
                    this._prepareUpperGridHeader();

                    //Set config and data to grid
                    this.$$('#multiEntityUpperGrid').config = this._gridConfig;
                    this.$$('#multiEntityUpperGrid').data = this._gridData;

                    this.async(function() {
                        var gridTable = this.$$('#multiEntityUpperGrid').$$('#pebbleGridContainer').querySelector('iron-data-table');
                        var firstRow = gridTable.querySelectorAll('data-table-row')[1];
                        var secondRow = gridTable.querySelectorAll('data-table-row')[2];

                        // Section start, will be removed this logic once rock-grid updated
                        var firstRowButtons = firstRow.querySelectorAll('pebble-button');
                        if (firstRowButtons.length > 0) {
                            firstRowButtons[0].remove();
                            firstRowButtons[1].remove();
                        }
                        // Section end

                        firstRow.querySelectorAll('data-table-cell')[1].style['font-weight'] = 'bold';
                        secondRow.querySelectorAll('data-table-cell')[1].style['font-weight'] = 'bold';

                        // Attributes matched from managed list is black
                        // Attributes matched from inferred list is green
                        // Attributes are not matched (new), then red                        

                    }, 100);
                },

                _prepareMultiEntityUpperGridConfiguration: function() {
                    this._gridConfig.tabular.columns.push({
                        "header": "Mapping",
                        "name": "mapping"
                    });
                    for (var idx = 0; idx < this.attributeNames.length; idx++) {
                        this._gridConfig.tabular.columns.push({
                            "header": "Column " + (idx + 1),
                            "name": this.attributeNames[idx],
                            "displayType": "textbox"
                        });
                    }
                },

                _prepareMultiEntityUpperGridData: function() {
                    this._gridData = []; //Clear the data
                    var gridRow = {};
                    gridRow["id"] = 1;
                    gridRow["mapping"] = "Excel column name";
                    //First row
                    for (var idx = 0; idx < this.attributeNames.length; idx++) {
                        gridRow[this.attributeNames[idx]] = this.attributeNames[idx];
                    }
                    this._gridData.push(gridRow);

                    gridRow = {};
                    gridRow["id"] = 2;
                    gridRow["mapping"] = "Mapped attribute name";

                    //Second row - Capture the details from data model 
                    for (var idx = 0; idx < this.attributeNames.length; idx++) {
                        if (this._findAttribute(this.attributeNames[idx])) {
                            this._mappedAttrs++;
                            gridRow[this.attributeNames[idx]] = this._findAttribute(this.attributeNames[idx]).name;
                        } else {
                            this._newAttrs++;
                        }
                    }
                    this._gridData.push(gridRow);

                    //Current Datetime
                    var datetime = new Date();
                    this._currentDateTime = {
                        "date": moment(datetime).format('MM/DD/YYYY'),
                        "time": moment(datetime).format('hh:mm A')
                    }
                },

                _findAttribute: function(attribute) {
                    for (var i = 0; i < this._attributeValues.length; i++) {
                        for (var j = 0; j < this._attributeValues[i].attributes.length; j++) {
                            if (this._attributeValues[i].attributes[j].name == attribute) {
                                return this._attributeValues[i].attributes[j];
                            }
                        }
                    }
                },

                _prepareUpperGridHeader: function() {
                    //Total managed attributes                    
                    for (var i = 0; i < this._attributeValues.length; i++) {
                        this._managedAttrs = this._managedAttrs + this._attributeValues[i].attributes.length;
                    }
                },

                _onSaveItem: function(e, details, sender) {
                    //Save logic comes here
                },

                _onFileUploadSuccess: function(e, details, sender) {
                    //After file upload, multi entity creation process starts
                    // show div manual-multi
                    this._hideView("description");
                    this._hideView(this._currentViewName);
                    this._showView("multiple-entity");
                    this._currentViewName = "multiple-entity";
                    this._populateMultiEntityUpperGrid();

                    this.async(function() {
                        //Clear file upload
                        this.$$('pebble-file-upload').reset();
                    });
                }
            });
        })();
    </script>
</dom-module>