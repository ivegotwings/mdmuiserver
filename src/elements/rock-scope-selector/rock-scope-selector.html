<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-save/liquid-config-save.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">

<link rel="import" href="rock-scope-tags.html">
<link rel="import" href="rock-scope-manage.html">

<!--
`rock-scope-selector` Represents an element that displays the scopes.

@demo demo/index.html
-->
<dom-module id="rock-scope-selector">
<template>
    <style include="pebble-styles-shared"></style>
    <style is="custom-style" include="iron-flex">
        #newScope {
            font-weight: var(--font-bold, bold);
            font-size: var(--font-size-md, 16px);
            line-height: 14px;
        }

        #manageScope {
            float: right;
            margin-right: 10px;
            --pebble-button: {
                font-size: var(--font-size-sm, 12px)!important;
                color: #036BC3;
                font-weight: 500;
                padding: 0;
            };
            --pebble-button-iron-icon: {
                height: 16px !important;
                width: 16px !important;
                color: #036BC3 !important;
            }
        }

        pebble-horizontal-divider {
            --pebble-horizontal-divider-color: #ccc;
        }

        .scopeLabel {
            color: var(--title-text-color, #191e22);
            font-weight: var(--font-bold, bold);
            font-size: var(--default-font-size, 14px);
            display: inline-block;
        }

        rock-tabs {
            --pebble-tab-group:{
                margin-bottom: 15px;
                width: 100%;
            }
            --pebble-tab:{
                margin-left: 0;
            }
        }

        .pebble-md-icons{
            --paper-button:{
                color:var(--primary-icon-color, #75808b);
            }
        }

        rock-tabs {
            --rock-tab-content: {
                @apply(--scope-tab-content);
            }
        }
    </style>
    <!--Liquid start-->
    <liquid-config-get id="liqInitiateScope" operation="initiatesearch" request-data="{{initiateScopeRequestData}}" last-response="{{initiateScopeResponse}}"
        on-response="_onInitiateScopeResponse">
    </liquid-config-get>
    <liquid-config-get id="liqGetScopeResultDetail" operation="getsearchresultdetail" on-response="_onGetScopeResultDetailResponse">
    </liquid-config-get>

    <liquid-config-get id="liqInitiateNameScope" operation="initiatesearch" request-data="{{initiateNameScopeRequestData}}"
        last-response="{{initiateNameScopeResponse}}" on-response="_onInitiateNameScopeResponse">
    </liquid-config-get>
    <liquid-config-get id="liqGetNameScopeResultDetail" operation="getsearchresultdetail" on-response="_onGetNameScopeResultDetailResponse">
    </liquid-config-get>

    <liquid-config-save name="configSaveService" on-response="_onSaveScopeResponse"></liquid-config-save>
    <!--Liquid end-->
    <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
    <bedrock-pubsub event-name="favourite-scope" handler="_onTapScopeFavourite" target-id=""></bedrock-pubsub>
    <bedrock-pubsub event-name="delete-scope" handler="_onTapScopeDelete" target-id=""></bedrock-pubsub>
    <bedrock-pubsub event-name="actions-parent-button-tap" handler="_onTagItemSelect" target-id=""></bedrock-pubsub>
    <!--Title, Settings and Create/Edit link-->
    <div id="newScope">
        <template is="dom-if" if="[[showTitle]]">
            <div class="scopeLabel">[[title]]</div>
        </template>
        <template is="dom-if" if="[[showSettings]]">
            <pebble-button id="refreshButton" icon="pebble-md-icons:ToolbarRefresh" data-tooltip="Refresh" class="pebble-md-icons pull-right tooltip-bottom"
                on-tap="refresh"></pebble-button>
        </template>
        <template is="dom-if" if="[[allowManageScope]]">
            <pebble-button id="manageScope" icon="pebble-sm-icons:Add" button-text="Create or Edit Scope Selection" noink class="createEditSavedSearch icon"
                on-tap="_onManageScopeTap"></pebble-button>
        </template>
    </div>
    <!--Tabs section-->
    <template is="dom-if" if="[[!isManageScopes]]">
        <rock-tabs id="rock-scope-tabs" config="[[tabConfig]]" selected-tab="{{_selectedTab}}"></rock-tabs>
    </template>
    <!--Create/Update section-->
    <template is="dom-if" if="[[isManageScopes]]">
        <rock-scope-manage edit-mode="{{isManageScopes}}" scope-id="[[scopeId]]" scopes="[[scopes]]"></rock-scope-manage>
        <bedrock-pubsub event-name="save-scope" handler="_onSaveScope"></bedrock-pubsub>
        <bedrock-pubsub event-name="cancel-scope" handler="_onCancelScope"></bedrock-pubsub>
    </template>
</template>
<script>
    (function () {
        'use strict';

        var _favScope = 'favourites';
        var _myScope = 'my-scopes';
        var _sharedScope = 'shared-scopes';
        var tabs = { "favourites": 0, "my-scopes": 1, "shared-scopes": 2 };

        var scopeTypeName = "scope";
        var scopeMappingsTypeName = "scopeMappings";
        var favScopesName = "favouriteScopes"

        Polymer({

            is: 'rock-scope-selector',
            /**
            * Fired when the scope is tapped in the
            * scope widget with the name as `rock-scope-click`.
            * Here, data is the data of the clicked scope.
            *
            * @event bedrock-event
            */

            /**
            * Fired when the user taps or clicks on the save button inside the `Create New Scope popover` 
            * with the name as "scope-save".
            *
            * @event bedrock-event
            */
            properties: {
                /**
                * Indicates the config for the tabs.
                */
                tabConfig: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {
                            "scrollable": false,
                            "tabItems": [
                                {
                                    "name": "favourite-scopes",
                                    "title": "Favourites",
                                    "selected": true,
                                    "enableDropdownMenu": false,
                                    "component": {
                                        "name": "rock-scope-tags",
                                        "path": "/src/elements/rock-scope-selector/rock-scope-tags.html",
                                        "properties": {
                                            "scope-category": "favourites"
                                        }
                                    }
                                },
                                {
                                    "name": "my-scopes",
                                    "title": "My Scope Selections",
                                    "enableDropdownMenu": false,
                                    "component": {
                                        "name": "rock-scope-tags",
                                        "path": "/src/elements/rock-scope-selector/rock-scope-tags.html",
                                        "properties": {
                                            "scope-category": "my-scopes"
                                        }
                                    }
                                },
                                {
                                    "name": "shared-scopes",
                                    "title": "Shared Scope Selections",
                                    "enableDropdownMenu": false,
                                    "component": {
                                        "name": "rock-scope-tags",
                                        "path": "/src/elements/rock-scope-selector/rock-scope-tags.html",
                                        "properties": {
                                            "scope-category": "shared-scopes"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                /**
                 * Indicates the scope identification which the consumer selects.
                 */
                scopeId: {
                    type: Number,
                    value: null,
                    notify: true
                },

                /**
                  * Indicates scopes.
                  */
                scopes: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true,
                    observer: '_onScopesChange'
                },

                _allScopes: {
                    type: Object,
                    value: function () { return { "favourites": {}, "my-scopes": {}, "shared-scopes": {} }; }
                },

                // Selected tab details
                _selectedTab: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true,
                    observer: '_onSelectedTabChange'
                },

                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                allowManageScope: {
                    type: Boolean,
                    value: false
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                showSettings: {
                    type: Boolean,
                    value: false
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                isManageScopes: {
                    type: Boolean,
                    value: false
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                showTitle: {
                    type: Boolean,
                    value: false
                },

                title: {
                    type: String,
                    value: "Quick Select"
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                initiateScopeRequestData: {
                    type: Object,
                    value: function () { return {}; }
                },
                /**
                * <b><i>Content development is under progress... </b></i>
                */
                initiateScopeResponse: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                pageSize: {
                    type: Number,
                    value: 100
                },

                _originalScopes: {
                    type: Array,
                    value: function () { return []; }
                },

                _originalScopeMappings: {
                    type: Array,
                    value: function () { return []; }
                },

                /**
                * <b><i>Content development is under progress... </b></i>
                */
                appName: {
                    type: String,
                    value: "app-entity-discovery"
                },

                _scopeRequest: {
                    type: Object,
                    value: function () { return {}; }
                },

                _mappingRequest: {
                    type: Object,
                    value: function () { return {}; }
                },

                _toastMessage: {
                    type: String,
                    value: null
                },

                _scopeInfo: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                selectedScope: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                }
            },

            listeners: {
                'tag-item-select': '_onTagItemSelect'
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            observers: [
                '_onContextDataChange(contextData, appName)'
            ],

            _onContextDataChange: function () {
                if (this.contextData && !_.isEmpty(this.contextData)) {
                    var clonedContextData = DataHelper.cloneObject(this.contextData);
                    var scopeCtxData = DataHelper.cloneObject(this._prepareContext(clonedContextData));
                    var mappingCtxData = DataHelper.cloneObject(this._prepareContext(clonedContextData, "scopemappings"));

                    this._scopeRequest = DataRequestHelper.createConfigInitialRequest(scopeCtxData);
                    this._mappingRequest = DataRequestHelper.createConfigInitialRequest(mappingCtxData);

                    //Initial scope for shared
                    var request = DataHelper.cloneObject(this._scopeRequest);
                    //Raise initial request for scopes and on scopes response raise request for mappings
                    this.generateRequest(request);
                }
            },

            //Prepare context for mappings
            _prepareContext: function (clonedContextData, type) {
                var context = {};
                var typesCriterion = [];
                var userContext = ContextHelper.getFirstUserContext(clonedContextData);

                if (type == "scopemappings" && userContext) {
                    context = {
                        "app": this.appName,
                        "service": "_ALL",
                        "component": "_ALL",
                        "subComponent": "_ALL",
                        "user": userContext.user,
                        "role": userContext.role
                    };
                    typesCriterion.push(scopeMappingsTypeName);
                }
                else {
                    context = {
                        "app": this.appName,
                        "service": "_ALL",
                        "component": "_ALL",
                        "subComponent": "_ALL",
                        "user": "all",
                        "role": "all"
                    };
                    typesCriterion.push(scopeTypeName);
                }

                //Set context
                clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [context];
                clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = typesCriterion;

                return clonedContextData;
            },

            _triggerScopeTransform: function () {
                if (this._originalScopes && this._originalScopeMappings) {
                    var userContext = ContextHelper.getFirstUserContext(this.contextData);
                    this.scopes = DataTransformHelper.transformScopes(this._originalScopes, this._originalScopeMappings, userContext, favScopesName, "scope");

                    this.async(function () {
                        //Reload tabs to get updated tags
                        if (this.$$('rock-tabs') && this.$$('rock-tabs').$$('rock-scope-tags')) {
                            this.$$('rock-tabs').reloadTabs();
                        }
                    });
                }
            },

            _onManageScopeTap: function (e) {
                this.isManageScopes = true;
                this.async(function () {
                    //This is to execute the logic for all scenarios on create/edit link on-click
                    this.$$('rock-scope-manage').OnCreateEditButtonClick();
                });
            },

            // Fired when rock-tabs creates component
            _onComponentCreating: function (e, detail, sender) {
                var component = detail.data;
                if (this.scopes) {
                    component.properties["scopes"] = this.scopes;
                }
            },

            /**
            * Fired when filter tag triggers a tag-item-select event.
            */
            _onTagItemSelect: function (e) {
                var eventData = {
                    name: "rock-scope-click",
                    data: e.detail
                };
                this.fire('bedrock-event', eventData);
            },

            // On tab change populate scopes
            _onSelectedTabChange: function () {
                if (this.$$('rock-tabs')) {
                    this.async(function () {
                        this.$$('rock-tabs').$$('pebble-tab-group').notifyResize();
                    }, 600); //Delayed to populate the tabs properly
                }
            },

            // On scope change, populate scopes and select respected scope tab
            _onScopesChange: function () {
                this._populateAllScopes();

                if (this.scopeId && this.$$('rock-tabs')) {
                    var listName = this._getScopeListNameByScopeId();
                    this.$$('rock-tabs').selectedTabIndex = tabs[listName];
                }

                if (this.$$('rock-tabs') && this.$$('rock-tabs').$$('rock-scope-tags')) {
                    this.$$('rock-tabs').reloadTabs();
                }
            },

            // Populate all scopes
            _populateAllScopes: function () {
                if (this.scopes) {
                    if (this.scopes[_myScope]) {
                        for (var idx = 0; idx < this.scopes[_myScope].length; idx++) {
                            this._allScopes[_myScope][this.scopes[_myScope][idx].id] = this.scopes[_myScope][idx];
                        }
                    }

                    if (this.scopes[_favScope]) {
                        for (var idx = 0; idx < this.scopes[_favScope].length; idx++) {
                            this._allScopes[_favScope][this.scopes[_favScope][idx].id] = this.scopes[_favScope][idx];
                        }
                    }

                    if (this.scopes[_sharedScope]) {
                        for (var idx = 0; idx < this.scopes[_sharedScope].length; idx++) {
                            this._allScopes[_sharedScope][this.scopes[_sharedScope][idx].id] = this.scopes[_sharedScope][idx];
                        }
                    }
                }
            },

            // Get scope list name
            _getScopeListNameByScopeId: function () {
                if (this._allScopes[_favScope][this.scopeId]) {
                    return _favScope;
                }

                if (this._allScopes[_myScope][this.scopeId]) {
                    return _myScope;
                }

                if (this._allScopes[_sharedScope][this.scopeId]) {
                    return _sharedScope;
                }
            },
            /**
              * <b><i>Content development is under progress... </b></i>
              */
            generateRequest: function (requestData) {
                if (requestData) {
                    this.initiateScopeRequestData = requestData;
                    this.$$('#liqInitiateScope').generateRequest();
                }
            },
            /**
              * <b><i>Content development is under progress... </b></i>
              */
            generateNameScopeRequest: function (requestData) {
                if (requestData) {
                    this.initiateNameScopeRequestData = requestData;
                    this.$$('#liqInitiateNameScope').generateRequest();
                }
            },

            _onInitiateNameScopeResponse: function (e) {
                var totalRecords = this.initiateNameScopeResponse.content.totalRecords;
                var getDetailOptions = { 'from': 0, 'to': totalRecords };
                this._makeGetNameScopeResultDetailCall(getDetailOptions);
            },

            _makeGetNameScopeResultDetailCall: function (options) {
                var liqGetNameScopeResultDetail = this.$$('#liqGetNameScopeResultDetail');

                var searchResultId = this.initiateNameScopeResponse.content.requestId;

                var reqData = this.initiateNameScopeRequestData;
                reqData.params.options = options;

                liqGetNameScopeResultDetail.requestId = searchResultId;
                liqGetNameScopeResultDetail.requestData = reqData;

                liqGetNameScopeResultDetail.generateRequest();
            },

            _onGetNameScopeResultDetailResponse: function (e, detail) {

                var type = this._scopeInfo.type;
                var scopeInfo = this._scopeInfo.details;

                //Compare scope name and display toast message based on that
                if (DataHelper.isValidObjectPath(detail, "response.content.configObjects")) {
                    var scopeItems = detail.response.content.configObjects;

                    if (scopeItems.length > 0 && type == "create") {
                        this.showErrorToast("Scope name is already exists, please create scope with different name.");
                        return;
                    }
                    else {
                        for (var i = 0; i < scopeItems.length; i++) {
                            if (scopeItems[i] && scopeItems[i].id != scopeInfo["scope-info"].selectedScope.scopeid) {
                                this.showErrorToast("Scope name is already exists, please create scope with different name.");
                                return;
                            }
                        }
                    }
                }

                //Prepare request
                if (type == "create") {
                    var clonedContextData = DataHelper.cloneObject(this.contextData);
                    var scopeContextName = this._getScopeContextName(scopeInfo["scope-info"].name);

                    var _createRequestData = DataRequestHelper.getConfigCreateRequest(this._prepareCreateContext(clonedContextData, scopeInfo), scopeTypeName, this.appName, scopeContextName);

                    var reqData = { "configObjects": [_createRequestData] }
                    this.generateSaveRequest(reqData, "create");
                    this._toastMessage = scopeInfo["scope-info"].name + " is saved successfully";
                }
                //update
                else {
                    var selectedScope = scopeInfo["scope-info"].selectedScope;
                    var originalScope = {};
                    //Find original scope based on scopeInfo - _originalScopes
                    for (var i = 0; i < this._originalScopes.length; i++) {
                        if (!this._originalScopes[i].data) {
                            continue; //next scope
                        }

                        var originalName = this._originalScopes[i].data.contexts[0].jsonData.config.scopename;
                        if (originalName == selectedScope.scopename) {
                            originalScope = this._originalScopes[i];
                            break;
                        }
                    }

                    this._setScopeDetailsForUpdate(originalScope, scopeInfo);

                    var reqData = { "configObjects": [originalScope] }
                    this.generateSaveRequest(reqData, "update");
                    this._toastMessage = scopeInfo["scope-info"].name + " is updated";
                }
            },

            _setScopeDetailsForUpdate: function (originalScope, scopeInfo) {
                var userContext = ContextHelper.getFirstUserContext(this.contextData);
                var user = this._getUserRolePerAccessType(scopeInfo["scope-info"], userContext);

                // Original scope details updated based on the changes
                originalScope.name = this._getScopeContextName(scopeInfo["scope-info"].name);
                originalScope.data.contexts[0].jsonData.config.name = scopeInfo["scope-info"].name;
                originalScope.data.contexts[0].jsonData.config.accesstype = scopeInfo["scope-info"].accesstype;
                originalScope.data.contexts[0].jsonData.config.scope = scopeInfo["scope"];
                delete originalScope.data.contexts[0].jsonData.config.scopename;
                delete originalScope.data.contexts[0].jsonData.config.scopeid;
                originalScope.data.contexts[0].context.user = user.user;
                originalScope.data.contexts[0].context.role = user.role;
            },

            _onInitiateScopeResponse: function (e) {
                var totalRecords = this.initiateScopeResponse.content.totalRecords;
                var getDetailOptions = { 'from': 0, 'to': totalRecords };
                this._makeGetScopeResultDetailCall(getDetailOptions);
            },

            _makeGetScopeResultDetailCall: function (options) {
                var liqGetScopeResultDetail = this.$$('#liqGetScopeResultDetail');

                var searchResultId = this.initiateScopeResponse.content.requestId;

                var reqData = this.initiateScopeRequestData;
                reqData.params.options = options;

                liqGetScopeResultDetail.requestId = searchResultId;
                liqGetScopeResultDetail.requestData = reqData;

                liqGetScopeResultDetail.generateRequest();
            },

            _onGetScopeResultDetailResponse: function (e) {
                var requestType;
                if (DataHelper.isValidObjectPath(e, "detail.request.requestData.params.query.filters.typesCriterion")) {
                    requestType = e.detail.request.requestData.params.query.filters.typesCriterion[0];
                }

                //Transform data and keep the data in scopes
                if (e.detail.response &&
                    e.detail.response.status == "success" &&
                    e.detail.response.content &&
                    e.detail.response.content.configObjects) {
                    if (requestType == scopeMappingsTypeName) {
                        this._originalScopeMappings = []; //reset
                        this._originalScopeMappings.push.apply(this._originalScopeMappings, e.detail.response.content.configObjects);

                        this._triggerScopeTransform();
                    }
                    else {
                        if (DataHelper.isValidObjectPath(e, "detail.request.requestData.params.query.contexts")) {
                            var context = e.detail.request.requestData.params.query.contexts[0];
                            var userContext = ContextHelper.getFirstUserContext(this.contextData);
                            var request = DataHelper.cloneObject(this._scopeRequest);

                            if (context.user == "all") //Initial response, so reset scopes
                            {
                                this._originalScopes = [];
                            }

                            this._originalScopes.push.apply(this._originalScopes, e.detail.response.content.configObjects);

                            if (context.user == "all") {
                                //generate request for role
                                request.params.query.contexts[0].user = "role";
                                request.params.query.contexts[0].role = userContext.role;
                            }
                            else if (context.user == "role") {
                                //generate request for individual user
                                request.params.query.contexts[0].user = userContext.user;
                                request.params.query.contexts[0].role = userContext.role;
                            }
                            else {
                                //generate request for mapping
                                if (DataHelper.isValidObjectPath(this._mappingRequest, "params.options")) {
                                    delete this._mappingRequest.params.options;
                                }
                                this.generateRequest(this._mappingRequest);
                                return;
                            }

                            this.generateRequest(request);
                        }
                    }
                }
            },

            _onTapScopeFavourite: function (e, detail, sender) {
                var foundInFav = false;
                var tag = detail.parentButton;

                // If mappings available then update
                if (this._originalScopeMappings && this._originalScopeMappings.length > 0) {
                    var favourites = this._originalScopeMappings[0].data.contexts[0].jsonData.config[favScopesName];

                    for (var i = 0; i < favourites.length; i++) {
                        if (favourites[i] == tag.scopename) {
                            favourites.splice(i, 1);
                            foundInFav = true;
                            this._toastMessage = tag.name + " is removed from favourites";
                            break;
                        }
                    }

                    if (!foundInFav) //Its not fav, then make it fav now
                    {
                        favourites.push(tag.scopename);
                        this._toastMessage = tag.name + " is added to favourites";
                    }

                    var reqData = { "configObjects": [this._originalScopeMappings[0]] } //Mapping have only one record
                    this.generateSaveRequest(reqData, "update");
                }
                else // When no mapping, then create request and submit
                {
                    var clonedContextData = DataHelper.cloneObject(this.contextData);
                    var createMappingRequestData = DataRequestHelper.getConfigCreateRequest(this._prepareCreateMappingContext(clonedContextData, tag), scopeMappingsTypeName, this.appName);

                    var reqData = { "configObjects": [createMappingRequestData] }
                    this.generateSaveRequest(reqData, "create");
                    this._toastMessage = tag.name + " is added to favourites";
                }
            },

            _onTapScopeDelete: function (e, detail, sender) {
                var scopeDeleteObj = {
                    "id": detail.parentButton.scopeid,
                    "type": scopeTypeName
                }
                var reqData = { "configObjects": [scopeDeleteObj] }
                this.generateSaveRequest(reqData, "delete");

                this._toastMessage = detail.parentButton.name + " has been deleted";
            },

            // Can be used to generate the save requests.
            generateSaveRequest: function (reqData, operation) {
                var configSaveService = this.$$('[name="configSaveService"]');

                if (configSaveService) {
                    configSaveService.operation = operation;
                    configSaveService.requestData = reqData;
                    configSaveService.generateRequest();
                }
            },

            _onSaveScopeResponse: function (e) {
                this._originalScopeMappings = [];
                this._originalScopes = [];

                if (this._toastMessage) {
                    this.showSuccessToast(this._toastMessage);
                    this._toastMessage = "";
                }

                if (DataHelper.isValidObjectPath(this._scopeRequest, "params.options")) {
                    delete this._scopeRequest.params.options;
                }
                this.async(function () {
                    this.generateRequest(this._scopeRequest);
                }, 1000); //Todo - This async will be removed once Notification is integrated
            },

            _onSaveScope: function (e, detail, sender) {
                    if (detail) {

                    var _isUpdate = false;

                    //Check for permission to Update
                    if (!_.isEmpty(detail.selectedScope)) {
                        var _currentUser = ContextHelper.getFirstUserContext(this.contextData);
                        _isUpdate = true;

                        if (_currentUser &&
                            _currentUser.user != detail.selectedScope.createdby &&
                            _currentUser.role != "admin") //Todo: admin role may changed
                        {
                            this.showErrorToast("You do not have permissions to update the scope, please contact administrator.");
                            return;
                        }
                    }

                    //Initiate
                    var _scopeDetails = {
                        "scope-info": detail,
                        "scope": this.selectedScope
                    };

                    if (detail.selectedScope && !_.isEmpty(detail.selectedScope)) {
                        this.createUpdateScope(_scopeDetails, "update");
                    } else {
                        this.createUpdateScope(_scopeDetails, "create");
                    }
                }
            },

            // Can be used to create and update the scope.
            createUpdateScope: function (scopeInfo, type) {

                this._scopeInfo = {
                    "details": scopeInfo,
                    "type": type
                };

                var request = DataHelper.cloneObject(this._scopeRequest);
                request.params.query.name = this._getScopeContextName(scopeInfo["scope-info"].name);
                delete request.params.query.contexts[0].user;
                delete request.params.query.contexts[0].role;

                this.generateNameScopeRequest(request);
            },

            _getScopeContextName: function (scopeName) {
                if (scopeName && scopeName.trim().length > 0) {
                    return "scope_" + scopeName.replace(/\s/g, '').toLowerCase();
                }
            },

            _getUserRolePerAccessType: function (scopeInfo, userContext) {

                if (!scopeInfo || !userContext) {
                    return;
                }

                if (scopeInfo.accesstype) {
                    var user = userContext.user;
                    var role = userContext.role;

                    if (scopeInfo.accesstype == "_ALL") {
                        user = "all"; // all users
                        role = "all"; // any role
                    }
                    else if (scopeInfo.accesstype == "_ROLE") {
                        user = "role"; // role based users
                    }

                    return {
                        "user": user,
                        "role": role
                    };
                }
            },

            // Context for create scope
            _prepareCreateContext: function (_clonedContextData, _scopeDetails) {
                var context = {};
                var userContext = ContextHelper.getFirstUserContext(_clonedContextData);
                var user = this._getUserRolePerAccessType(_scopeDetails["scope-info"], userContext);

                context = {
                    "app": this.appName,
                    "service": "_ALL",
                    "component": "_ALL",
                    "subComponent": "_ALL",
                    "user": user.user,
                    "role": user.role
                };

                var data = {};

                data = {
                    "config": {
                        "id": ElementHelper.getRandomString(),
                        "accesstype": _scopeDetails["scope-info"].accesstype,
                        "name": _scopeDetails["scope-info"].name,
                        "icon": "pebble-icons:SavedSearch",
                        "createdby": userContext.user,
                        "createdbyrole": userContext.role,
                        "ownershipData": userContext.ownershipData,
                        "scope": _scopeDetails["scope"]
                    }
                };

                var _contextsObject = {
                    "context": context,
                    "jsonData": data
                }

                //Set context
                _clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [_contextsObject];

                return _clonedContextData;
            },

            // Context for create mappings
            _prepareCreateMappingContext: function (clonedContextData, tag) {
                var context = {};
                var userContext = ContextHelper.getFirstUserContext(clonedContextData);
                context = {
                    "app": this.appName,
                    "service": "_ALL",
                    "component": "_ALL",
                    "subComponent": "_ALL",
                    "role": userContext.role,
                    "user": userContext.user
                };

                var data = {};

                data = { "config": {} };
                data.config[favScopesName] = [tag.scopename];

                var contextsObject = {
                    "context": context,
                    "jsonData": data
                }

                //Set context
                clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [contextsObject];

                return clonedContextData;
            },

            refresh: function () {
                var request = DataHelper.cloneObject(this._scopeRequest);
                this.generateRequest(request);
            }
        });
    })();
</script>
</dom-module>