<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<!--
`rock-navmenu` Represents the main menu component to navigate in the framework. It implements an accessible material design menu. 

@demo demo/index.html 
-->
<dom-module id="rock-navmenu">
    <template>
        <style include="pebble-styles-shared">

		</style>
<style is="custom-style">
			iron-icon {
				opacity: 0.95;
				color: #ffffff;
				margin: 10px 12px;
			}
			iron-icon[icon="pebble-icons:Menu"]{
                margin: 16px 12px;
            }
			a {
				text-decoration: none;
				color: #ffffff;
				opacity: 0.75;
				display: -ms-flexbox;
				display: -webkit-flex;
				display: inline-flex;
				-ms-flex-direction: row;
				-webkit-flex-direction: row;
				flex-direction: row;
				-ms-flex-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-font-smoothing: antialiased;
				text-rendering: optimizeLegibility;
				font-family: var(--default-font-family);
				font-size: 14px;
				font-weight: 400;
				line-height: 24px;
				white-space: nowrap;
				box-sizing: border-box;
				cursor: pointer;
			}
			
			a[hide] {
				display: none;
			}

            paper-menu{
                padding: 0;                
            }
			
			paper-submenu paper-item {
				font-size: 14px;
				cursor: pointer;
				outline: none;
				white-space: nowrap;
				width: 255px;
				box-sizing: border-box;
				color: #ffffff;
				opacity: 0.95;
				@apply(--layout);
				@apply(--layout-horizontal);
			}
			
			paper-item {
				--paper-item: {
					cursor: pointer;
					padding: 0px;
                        min-height: 40px;
				};
			}
			
			.sublist paper-item {
				padding-left: 30px;
			}
			
			#headerMenuItem a {
				margin-left: 10px;
				font-size: 22px;
			}
			
			.menuIcon {
				float: left;
				cursor: pointer;
			}
			
			pebble-horizontal-divider {
				margin-left: 5px;
				margin-right: 5px;
			}
			.selected {
				width: 4.1px;
  				height: 31px;
  				background-color: var(--navselected-highlight-color);
				display: inline-block;
				margin-right: -5px;
			}
            .subMenuSelected{
                width: 4px;
                height: 43px;
                background: #FFFFFF;
                display: inline-block;
                margin-right: -5px;
            }

		</style>
<paper-menu id="mainMenu" attr-for-item-title="label" multi attr-for-selected="data-route" selected="{{page}}">
    <paper-item id="headerMenuItem">
        <span id="toggleItem" class="menuIcon" on-click="_onHamburgerIconClick">
					<iron-icon icon="pebble-icons:Menu"></iron-icon>
			    </span>
        <img width="15" height="30" src="../../../src/images/logo.svg" on-click="_onHamburgerIconClick"></img>
        <a on-click="_onHamburgerIconClick">MDMCenter</a>
    </paper-item>
    <pebble-horizontal-divider></pebble-horizontal-divider>
    <template is="dom-repeat" items="[[menuItems]]">
        <template is="dom-if" if="[[!_isDivider(item)]]">
            <template is="dom-if" if="[[_hasSubmenu(item)]]">
                <paper-submenu label="[[item.title]]">
                    <paper-item class="menu-trigger">
                        <template is="dom-if" if="{{_subMenuSelected(item,page,queryParams)}}">
                            <div class="selected"></div>
                        </template>
                        <span on-click="_onSubMenuIconClick" item="[[item]]" class="menuIcon">
									<iron-icon id="menuIcon[[index]]" icon="{{item.icon}}"></iron-icon>
								</span>[[item.title]]
                    </paper-item>
                    <paper-menu class="menu-content sublist" multi>
                        <template is="dom-repeat" items="{{item.menuItems}}" as="subMenuItem">
                            <a sub-menu-item="[[subMenuItem]]" on-tap="_subMenuClicked">
                                <template is="dom-if" if="{{_selected(subMenuItem,page,queryParams)}}">
                                    <div class="subMenuSelected"></div>
                                </template>
                                <paper-item item="[[item]]">
                                    [[subMenuItem.title]]
                                </paper-item>
                            </a>
                        </template>
                    </paper-menu>
                </paper-submenu>
            </template>
            <template is="dom-if" if="{{!_hasSubmenu(item)}}">
                <paper-item class="menu-item">
                    <a item="[[item]]" is-landing-page$="[[item.isLandingPage]]" class="menuIcon" on-tap="_menuClicked">
                        <template is="dom-if" if="{{_selected(item,page,queryParams)}}">
                            <div class="selected"></div>
                        </template>
                        <iron-icon id="menuIcon[[index]]" icon="{{item.icon}}"></iron-icon>
                    </a>
                    <a item="[[item]]" is-landing-page$="[[item.isLandingPage]]" on-tap="_menuClicked">{{item.title}}</a>
                </paper-item>
            </template>
        </template>
        <template is="dom-if" if="[[_isDivider(item)]]">
            <pebble-horizontal-divider></pebble-horizontal-divider>
        </template>
    </template>
    <template is="dom-repeat" items="[[menuItems]]">
        <paper-tooltip for="menuIcon[[index]]" position="right" animation-delay="0">[[item.title]]</paper-tooltip>
    </template>

    <template is="dom-repeat" items="[[activeItems]]">
        <paper-item class="menu-item">
            <a item="[[item]]" is-landing-page$="[[item.isLandingPage]]" class="menuIcon" on-tap="_menuClicked">
                <template is="dom-if" if="{{_selected(item,page,queryParams)}}">
                    <div class="selected"></div>
                </template>
                <iron-icon id="menuIcon[[index]]" icon="{{item.icon}}"></iron-icon>
            </a>
            <a item="[[item]]" is-landing-page$="[[item.isLandingPage]]" on-tap="_menuClicked">{{item.title}}</a>
            <template is="dom-if" if="[[!item.nonClosable]]">
                <paper-icon-button name="close" icon="icons:clear" title="Close" on-tap="_onCloseClick"></paper-icon-button>
            </template>
        </paper-item>
    </template>
</paper-menu>
</template>
<script>
    (function () {
        'use strict';

        Polymer({
            is: 'rock-navmenu',

            properties: {
                /**
                * Specifies the list of menu item as a JSON array.
                * JSON Menu Item Format:
                 { 
                    "name": "charts",
                    "title": "Charts",
                    "data_route": "charts",
                    "icon": "pebble-icons:trending-up"
                 }
                * 
                */
                menuItems:
                {
                    type: Array,
                    notify: true
                },
                /**
                * Specifies the route of the current page if routing is enabled.
                * 
                */
                route: {
                    type: Object,
                    reflectToAttribute: true,
                    notify: true
                },
                /**
                * Specifies the current route page if routing is enabled.
                * 
                */
                page: {
                    type: String,
                    reflectToAttribute: true,
                    notify: true
                },
                queryParams: {
                    type: Object,
                    reflectToAttribute: true,
                    notify: true
                },
                /**
                 * Specifies the list of all the links which were opened and are not part of menu.
                 *
                 */
                activeItems: {
                    type: Array,
                    notify: true
                }
            },

            /**
            * Can be used to check whether menu item has any submenu.
            *
            * @param {Element} item A menu item
            */
            _hasSubmenu: function (item) {
                if (item.menuItems && item.menuItems.length > 0) {
                    return true;
                }
                else {
                    return false;
                }
            },

            /**
            * Can be used to check whether menu item is divider.
            *
            * @param {Element} item A menu item
            * 
            */
            _isDivider: function (item) {
                return item.name == "divider";
            },
            /**
             * Can be used to toggle the size of side menu and collapse the opened sub-menus.
             *
             *
             */
            _onHamburgerIconClick: function (e) {
                this._collapseExpandDrawer();
                this._collapseSubMenu();
                e.cancelBubble = true;
            },
            /**
             * Can be used to trigger an event on clicking the icon of menu which contains sub-menus. It toggles the sub-menus and toggles the size of side menu bar.
             *
             *
             */

            _onSubMenuIconClick: function (e) {
                e = e || window.event;
                this._collapseExpandDrawer();
                var subMenus = Polymer.dom(this.$.mainMenu).querySelectorAll("paper-submenu");
              
                if (subMenus && subMenus.length > 0) {
                    for (var i = 0; i < subMenus.length; i++) {
                        if (subMenus[i].$.collapse.className.indexOf("iron-collapse-closed") > -1) {
                            subMenus[i].$.trigger.click();
                        }
                    }
                }

                e.cancelBubble = true;
            },
            /**
             * Can be used to trigger an event on clicking the sub-menu item. It toggles the size of side menu bar.
             *
             *
             */
            _onSubMenuItemClick: function (e) {
                e = e || window.event;
                this._collapseExpandDrawer();
                e.cancelBubble = true;
            },
            /**
             * Can be used to collapse the side menu list.
             *
             *
             */
            _collapseSubMenu: function () {
               
                var subMenus = Polymer.dom(this.$.mainMenu).querySelectorAll("paper-submenu");
                if (subMenus && subMenus.length > 0) {
                    for (var i = 0; i < subMenus.length; i++) {
                        if (subMenus[i].$.collapse.className.indexOf("iron-collapse-opened") > -1) {
                            subMenus[i].$.trigger.click();
                        }
                    }
                }
            },
            /**
             *  Can be used to toggle the size of the side menu.
             *
             *
             */
            _collapseExpandDrawer: function () {
                var drawer = Polymer.dom(document).querySelector("main-app").$.drawerLayout;
                if (drawer) {
                    //ToDo: remove hard coded style and use class toggle
                    if (drawer.style.width == "48px") {
                        drawer.style.width = "256px";
                        drawer.$.contentContainer.style.width = "256px";
                    }
                    else {
                        this._collapseSubMenu();
                        drawer.style.width = "48px";
                        drawer.$.contentContainer.style.width = "48px";
                    }
                }
            },

            _onCloseClick: function (e) {
                this.fire("menu-close-click", { "item": e.target.parentElement.querySelector("a").item });
            },
            /**
             *  Can be used to check whether or not a menu-item is selected.
             *
             *
             */
            _selected: function (item, page, queryParams) {
                if (!queryParams || isEmpty(queryParams)) {
                    if (item.data_route == page || (item.isLandingPage && page == "")) {
                        return true;
                    }
                } else {
                    if ((item.data_route == page && JSON.stringify(queryParams) == JSON.stringify(item.queryParams)) || (item.isLandingPage && page == "")) {
                        return true;
                    }
                }
                return false;
            },
            /**
             *  Can be used to check whether or not any of menu item's sub-menu is selected.
             *
             *
             */
            _subMenuSelected: function (item, page) {
                for (var i = 0; i < item.menuItems.length; i++) {
                    if (item.menuItems[i].data_route == page) {
                        return true;
                    }
                }
                return false;
            },
            _menuClicked: function (e) {
                this._changeRoute(e.currentTarget.item);
            },
            _subMenuClicked: function (e) {
                this._changeRoute(e.currentTarget.subMenuItem);
            },
            _changeRoute: function (item) {
                var queryParams = {};
                if (item.queryParams) {
                    queryParams = item.queryParams;
                }
                if ("/" + item.data_route == document.querySelector("main-app").route.path) {
                    document.querySelector("main-app").set("route.__queryParams", queryParams);
                } else {
                    document.querySelector("main-app").set("route.__queryParams", queryParams);
                    document.querySelector("main-app").set("route.path", "/" + item.data_route);
                }

            }
        });
    })();
</script>
</dom-module>