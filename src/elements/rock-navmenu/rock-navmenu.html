<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">

<!--
`rock-navmenu`
Main menu component for riversand ui framework 

@demo demo/index.html 
-->
<dom-module id="rock-navmenu">
	<template>
		<style include="shared-styles"></style>
		<style is="custom-style">
			iron-icon {
				opacity: 0.95;
				color: #ffffff;
				margin: 12px;
			}
			
			a {
				text-decoration: none;
				color: #ffffff;
				opacity: 0.75;
				display: -ms-flexbox;
				display: -webkit-flex;
				display: flex;
				-ms-flex-direction: row;
				-webkit-flex-direction: row;
				flex-direction: row;
				-ms-flex-align: center;
				-webkit-align-items: center;
				align-items: center;
				font-family: 'Roboto', 'Noto', sans-serif;
				-webkit-font-smoothing: antialiased;
				text-rendering: optimizeLegibility;
				font-size: 14px;
				font-weight: 400;
				line-height: 24px;
				min-height: 48px;
				white-space: nowrap;
				box-sizing: border-box;
				cursor: pointer;
			}
			
			a[hide] {
				display: none;
			}
			
			paper-submenu paper-item {
				font-size: 14px;
				cursor: pointer;
				outline: none;
				white-space: nowrap;
				width: 255px;
				box-sizing: border-box;
				color: #ffffff;
				opacity: 0.95;
				@apply(--layout);
				@apply(--layout-horizontal);
			}
			
			paper-item {
				--paper-item: {
					cursor: pointer;
					padding: 0px;
				}
				;
			}
			
			.sublist paper-item {
				padding-left: 30px;
			}
			
			#headerMenuItem a {
				margin-left: 10px;
				font-size: 30px;
			}
			
			.menuIcon {
				float: left;
				cursor: pointer;
			}
			
			pebble-horizontal-divider {
				margin-left: 5px;
				margin-right: 5px;
			}
		</style>
		<paper-menu id="mainMenu" attr-for-item-title="label" multi attr-for-selected="data-route" selected="{{page}}">
			<paper-item id="headerMenuItem">
				<span id="toggleItem" class="menuIcon" on-click="_onHamburgerIconClick">
					<iron-icon icon="pebble-icons:menu"></iron-icon>
			    </span>
				<img width="15" height="30" src="../../../src/images/logo.svg" on-click="_onHamburgerIconClick"></img>
				<a on-click="_onHamburgerIconClick">MDMCenter</a>
			</paper-item>
			<pebble-horizontal-divider></pebble-horizontal-divider>
			<template is="dom-repeat" items="[[menuItems]]">
				<template is="dom-if" if="[[!_isDivider(item)]]">
					<template is="dom-if" if="[[_hasSubmenu(item)]]">
						<paper-submenu label="[[item.title]]">
							<paper-item class="menu-trigger">
								<span on-click="_onSubMenuIconClick" item="[[item]]" class="menuIcon">
							<iron-icon id="menuIcon[[index]]" icon="{{item.icon}}"></iron-icon>
						</span> [[item.title]]
							</paper-item>
							<paper-menu class="menu-content sublist" multi>
								<template is="dom-repeat" items="{{item.menuItems}}" as="subMenuItem">
									<paper-item on-click="_onSubMenuItemClick" item="[[item]]">[[subMenuItem.title]]</paper-item>
								</template>
							</paper-menu>
						</paper-submenu>
					</template>
					<template is="dom-if" if="{{!_hasSubmenu(item)}}">
						<paper-item>
							<span on-click="_onMenuIconClick" item="[[item]]" is-landing-page$="[[item.isLandingPage]]" class="menuIcon">
							<iron-icon id="menuIcon[[index]]" icon="{{item.icon}}"></iron-icon>
							
						</span>
							<a on-click="_onMenuItemClick" item="[[item]]" is-landing-page$="[[item.isLandingPage]]">{{item.title}}</a>
							<template is="dom-if" if="[[!item.nonClosable]]">
								<paper-icon-button name="close" icon="icons:clear" title="Close" on-tap="_onCloseClick"></paper-icon-button>
							</template>
						</paper-item>
					</template>
				</template>
				<template is="dom-if" if="[[_isDivider(item)]]">
					<pebble-horizontal-divider></pebble-horizontal-divider>
				</template>
			</template>
			<template is="dom-repeat" items="[[menuItems]]">
				<paper-tooltip for="menuIcon[[index]]" position="right" animation-delay="0">[[item.title]]</paper-tooltip>
			</template>
		</paper-menu>
	</template>

	<script>
    (function() {
      'use strict';

      Polymer({
        is: 'rock-navmenu',

        properties: {
			/**
			* List of menu item as a JSON array.
			* If it is set to <b>true</b>, then the card is not draggable.
			* JSON Menu Item Format:
			 { 
				"name": "charts",
        	    "title": "Charts",
        		"data_route": "charts",
        		"icon": "pebble-icons:trending-up",
        		"href": "/charts",
        		"nonClosable": true,
        		"nonMinimizable": true,
        		"component": {
            		"name": "pebble-textbox",
            		"path": "../../src/elements/pebble-textbox/pebble-textbox.html",
            		"properties": {
                	"value": "charts"
                 }
             }
			* 
			*/
			menuItems:
			{
				type: Array,
				notify: true
			},
			/**
			* Specifies route of the current page if routing is enables.
			* 
			*/
			route: {
				type: Object,
				notify: true
			},
			/**
			* Specifies the current route page if routing is enabled.
			* 
			*/
			page: {
				type: String,
				reflectToAttribute: true
			}
        },

		 /**
         * Checks whether menu item has any submenu.
         *
         * @param {Element} item A menu item
         */
        _hasSubmenu: function(item) {
			if(item.menuItems && item.menuItems.length > 0){
				return true;
			}
			else {
				return false;
			}
		},

		 /**
         * Checks whether menu item is divider.
         *
         * @param {Element} item A menu item
         * 
         */
		_isDivider: function(item) {
			return item.name == "divider";
		},

        _onHamburgerIconClick: function(e){
			this._collapseExpandDrawer();
			this._collapseSubMenu();
			e.cancelBubble = true;
		}, 

        _onMenuIconClick: function(e) {
			e = e || window.event;
			this._onDataRouteClick(e);
			e.cancelBubble = true;
		},

		 _onSubMenuIconClick: function(e) {
			e = e || window.event;
			this._collapseExpandDrawer();
			if(e.currentTarget.parentElement.parentElement.$.collapse.className == "iron-collapse-closed"){
				e.currentTarget.parentElement.parentElement.$.trigger.click();
			}
			e.cancelBubble = true;
		},

		_onSubMenuItemClick: function(e){
			e = e || window.event;
			this._onDataRouteClick(e);
			this._collapseExpandDrawer();
			e.cancelBubble = true;
		},

		_onMenuItemClick: function(e) {
			this._collapseExpandDrawer();
			this._onDataRouteClick(e);
			e.cancelBubble = true;
		},

        _onDataRouteClick: function(e) {
			//TODO: temp condition till we get proper styling for icons
			if(e.target.tagName == "PAPER-ICON-BUTTON") {
				return;
			}
			this.fire("menu-click", {"item": e.currentTarget.item} );
                      
		},

		_collapseSubMenu: function(){
			var subMenus = Polymer.dom(this.$.mainMenu).querySelectorAll("paper-submenu");
			if(subMenus && subMenus.length > 0){
				for(var i=0; i< subMenus.length; i++){
					if(subMenus[i].$.collapse.className == "iron-collapse-opened"){
						subMenus[i].$.trigger.click();
					}
				}
			}
		},
        
		_collapseExpandDrawer: function(){
			var drawer = document.querySelector("main-app").$.drawerLayout;		
			if(drawer){
				//ToDo: remove hard coded style and use class toggle
				if(drawer.style.width == "48px"){
					drawer.style.width = "256px";
					drawer.$.contentContainer.style.width = "256px";
				}
				else{
					this._collapseSubMenu();
					drawer.style.width = "48px";
					drawer.$.contentContainer.style.width = "48px";
				}
			}
		},

		_onCloseClick: function(e) {
			this.fire("menu-close-click", {"item": e.target.parentElement.item} );
		}
      });
    })();
  </script>

</dom-module>