<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-externalref-socketio/bedrock-externalref-socketio.html">
<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<!--
`bedrock-notification-receiver` creates the 
client connection to send or receive the notification message for either all users or a specific user.

It reads the server details of where the notification engine is running from the `src/data/config.js` file and generates 
the client's connection for the communication with the server.

After adding this component, you must use the function `window.globalFunctions.getClientSocket();` to get the current running socket 
in the current window tab of the browser.

@demo demo/index.html
-->

<dom-module id="bedrock-notification-receiver">
    <template>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'bedrock-notification-receiver',
                properties: {
                    /*
                    * Indicates the `serverConfig` object that contains the host and port details where the notification engine is hosted.
                    */
                    serverConfig: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        },
                        observer: '_init'
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                _clientSocket: null,
                _init: function () {
                    var self = this;

                    var socketServerUrl = window.location.origin;

                    var connectionOptions = {
                        "force new connection": true,
                        "reconnection": true,
                        "reconnectionDelay": 2000,                  //starts with 2 secs delay, then 4, 6, 8, until 60 where it stays forever until it reconnects
                        "reconnectionDelayMax": 60000,             //1 minute maximum delay between connections
                        "reconnectionAttempts": "Infinity",         //to prevent dead clients, having the user to having to manually reconnect after a server restart.
                        "timeout": 10000,                           //before connect_error and connect_timeout are emitted.
                        "transports": ["websocket", "polling"]     //forces the transport to be only websocket as priority. Server needs to be setup as well/
                    }

                    //console.log('initializing socket connection to the path ', JSON.stringify(socketServerUrl));
                    self._clientSocket = io.connect(socketServerUrl, connectionOptions);
                    //self._clientSocket = io.connect(socketServerUrl);

                    self._clientSocket.on('connect', function () {
                        var userId = DataHelper.getUserId();
                        //console.log("Transport being used: " + self._clientSocket.io.engine.transport.name);
                        //console.log("fired from client to reset: " + self._clientSocket.id + " user id" + userId);
                        self._clientSocket.emit('Connect new user', userId);
                    });

                    self._clientSocket.on("new message", function (data) {
                        //console.log('notification received from server ', JSON.stringify(data));

                        var mainApp = RUFUtilities.mainApp;
                        if (mainApp) {
                            var dataObjectNotificationHandler = mainApp.$$('bedrock-dataobject-notification-handler');
                            if (dataObjectNotificationHandler) {
                                dataObjectNotificationHandler.fireBedrockEvent("dataobject-notification", data, { ignoreId: true });
                            }
                        }
                    }.bind(self));

                    window.globalFunctions = window.globalFunctions || {};
                    globalFunctions.getClientSocket = function () {
                        return self._clientSocket;
                    }

                }
            });
        })();
    </script>

</dom-module>