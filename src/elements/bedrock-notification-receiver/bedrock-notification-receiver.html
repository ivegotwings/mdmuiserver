<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-externalref-socketio/bedrock-externalref-socketio.html">
<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<!--
`bedrock-notification-receiver` Represents a component that creates the 
client connection to send or receive the notification message for either all users or a specific user.

It reads the server details of where notification engine is running from the `src/data/config.js` file and generates 
the client's connection for the communication with the server.

After adding this component user has to use the function `window.globalFunctions.getClientSocket();` to get the current running socket 
in the current window tab of the browser.
-->

<dom-module id="bedrock-notification-receiver">
    <template>
        <iron-ajax auto url="../../data/config.json" handle-as="json" last-response="{{serverConfig}}"></iron-ajax>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'bedrock-notification-receiver',
                properties: {
                    /*
                    * Indicates the `serverConfig` object that contains the host and port details where the notification engine is hosted.
                    */
                    serverConfig: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        },
                        observer: '_init'
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                _clientSocket: null,
                _init: function () {
                    var self = this;
                    if (self.serverConfig.notificationManager && self.serverConfig.notificationManager.Host && self.serverConfig.notificationManager.Port) {
                        var path = self.serverConfig.notificationManager.Host + ":" + self.serverConfig.notificationManager.Port;

                        self._clientSocket = io.connect(path);

                        self._clientSocket.on("new message", function (data) {

                            var mainApp = document.querySelector('main-app');
                            if (mainApp) {
                                var dataObjectNotificationHandler = mainApp.$$('bedrock-dataobject-notification-handler');
                                if(dataObjectNotificationHandler) {
                                    dataObjectNotificationHandler.fireBedrockEvent("dataobject-notification", data, { ignoreId: true});
                                }
                            }
                        }.bind(self));

                        window.globalFunctions = window.globalFunctions || {};
                        globalFunctions.getClientSocket = function () {
                            return self._clientSocket;
                        }
                    }
                }
            });
        })();
    </script>

</dom-module>