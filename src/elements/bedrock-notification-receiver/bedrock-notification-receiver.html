<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<!--<link rel="import" href="../pebble-toast/pebble-toast.html">-->

<link rel="import" href="../bedrock-externalref-socketio/bedrock-externalref-socketio.html">
<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<!--
`bedrock-notification-receiver` Represents a component that creates the 
client connection to send or receive the notification message for either all users or a specific user.

It reads the server details of where notification engine is running from the `src/data/config.js` file and generates 
the client's connection for the communication with the server.

After adding this component user has to use the function `window.globalFunctions.getClientSocket();` to get the current running socket 
in the current window tab of the browser.
-->

<dom-module id="bedrock-notification-receiver">
    <template>
        <iron-ajax auto url="../../data/config.json" handle-as="json" last-response="{{serverConfig}}"></iron-ajax>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'bedrock-notification-receiver',
                properties: {
                    /*
                    * Indicates the `serverConfig` object that contains the host and port details where the notification engine is hosted.
                    */
                    serverConfig: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        },
                        observer: '_init'
                    }
                },
                _clientSocket: null,
                _init: function () {
                    var self = this;
                    if (self.serverConfig.notificationManager && self.serverConfig.notificationManager.Host && self.serverConfig.notificationManager.Port) {
                        var path = self.serverConfig.notificationManager.Host + ":" + self.serverConfig.notificationManager.Port;

                        self._clientSocket = io.connect(path);

                        self._clientSocket.on("new message", function (data) {

                            var actions = SharedEnumsUtil.Enums.actions;
                            if (data) {

                                switch (data.action) {
                                    case actions.saveComplete:
                                        // clear cache
                                        break;
                                    case actions.governComplete:
                                        // clear cache
                                        // give toast as well with refresh link
                                        self._sendPebbleToastWithRefreshLink(data);
                                        break;
                                    case actions.workflowTransitionComplete:
                                        // clear cache
                                        // auto refresh event trigger for workflow component
                                        break;
                                    case actions.saveFail:
                                    case actions.governFail:
                                    case actions.workflowTransitionFail:
                                        self._notifyUIOnBadge(data);
                                        break;

                                }
                            }
                        }.bind(self));

                        window.globalFunctions = window.globalFunctions || {};
                        globalFunctions.getClientSocket = function () {
                            return self._clientSocket;
                        }
                    }
                },

                _notifyUIOnBadge: function (data) {
                    var notificationElement = document.querySelector("main-app").$$('#notificationsList');
                    var notificationLabelElement = document.querySelector("main-app").$$('#mdmNotifications');

                    if (notificationElement) {
                        var notifications = notificationElement.notifications;
                        notificationElement.notifications = [];

                        notifications.push({
                            src: data.source || '',
                            alt: data.alt || '',
                            when: moment(data.timestamp).format("DD MMM YYYY hh:mm a") || '',
                            desc: data.description || ''
                        });

                        notificationElement.notifications = notifications;
                        notificationElement.notifyPath("notifications", notificationElement.notifications.slice());

                        if (notificationLabelElement) {
                            notificationLabelElement.label = notifications.length;
                        }
                    }
                },

                _fireNotificationEvent: function (data) {
                    if (data.context) {
                        if (data.context.appInstanceId) {
                            this.fireBedrockEvent("notification-" + data.context.appInstanceId, data);
                        }
                    }
                },

                _sendPebbleToastWithRefreshLink: function (data) {

                    var entityId, entityType, tenantId;
                    var link = "";
                    if(data.context && data.tenantId) {
                        entityId = data.context.id;
                        entityType = data.context.type;
                        tenantId = data.tenantId;

                        link = "/"+ tenantId +"/entity-manage?id="+ entityId + "&type="+ entityType               
                    }

                    if(!_.isEmpty(link)) {
                        data.description = data.description + " <a href=" + link + ">refresh</a>";
                    }

                    var pebbleToastElement = document.createElement("pebble-toast");
                    pebbleToastElement.setAttribute('id', Date.parse(new Date())); //Just unique id  
                    debugger;              
                    pebbleToastElement.innerHTML = data.description;
                    pebbleToastElement.toastType = data.status;
                    pebbleToastElement.alignToast = "top";
                    // pebbleToastElement.autoClose = true;
                    // pebbleToastElement.toastDuration = 5000; 
                    document.body.appendChild(pebbleToastElement);
                    pebbleToastElement.show();
                }
            });
        })();
    </script>

</dom-module>