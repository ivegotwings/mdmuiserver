<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`<pebble-textbox-collection>` Represents an element which contains tags with manage option

### Example:

    <pebble-collection-container label="[[label]]" values="{{values}}" is-readonly="[[isReadonly]]">
        <div class="tag-container">
            <pebble-textbox id='txtInputTag' label="[[_getLabel(_isEdit)]]" value="{{_tagInputText}}" on-keyup="_onEnter">
                <pebble-icon icon="[[_getIcon(_isEdit)]]" suffix on-tap="_onTapIcon"></pebble-icon>
            </pebble-textbox>
            <span class="message" hidden="[[!_showMessage]]">Already exists</span>
        </div>
    </pebble-collection-container>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--text-collection-container` | Mixin applied to component | {}
`--line-with-icon` | Mixing for a line and dropdown icon section | {}
`--line-with-icon-readonly` | Mixing for a line and dropdown icon section when readonly | {}
`--text-collection-label` | Mixin applied to component label | {}
`--tags-container` | Mixin applied to tags container | {}
`--tag-content` | Mixin applied to tag content | {}
`--tag-value` | Mixin applied to tag value | {}
`--tag-close` | Mixin applied to tag close | {}
`--text-collection-popover` | Mixin applied to tags collection popover | {}
`--dropdown-icon` | Mixin applied to dropdown icon | {}

@group rock Elements
@element pebble-collection-container
@demo demo/index.html
-->

<dom-module id="pebble-collection-container">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex iron-flex-alignment"> 
            #line-with-icon {
                margin-top: -20px; 
                border-bottom: 1px solid #cacaca;                
                text-align: right;
                @apply(--line-with-icon);             
            }

            :host([is-readonly]) #line-with-icon {
                margin-top: 5px;
                border-bottom: 1px solid #cacaca;
                @apply(--line-with-icon-readonly);             
            }
            
            .text-collection-container {
                width: 400px;
                @apply(--text-collection-container);               
            }
            .text-collection-label {
                text-transform: uppercase;
                @apply(--text-collection-label);
            }
            .tags-container {
                max-height: 75px;                
                overflow-y: auto; 
                margin-right: 25px;
                display: block;                
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                @apply(--tags-container);
            }
            .tag-content {
                border: 1px solid #cacaca;
                border-left: 4px solid #cacaca;
                border-radius: 4px;
                margin: 4px;
                padding: 4px;                                
                @apply(--layout-horizontal);
                @apply(--tag-content);                
            }
            .tag-value {
                text-transform: capitalize;
                cursor: pointer;
                @apply(--tag-value);
            }
            :host([is-readonly]) .tag-value {
                cursor: default;
            }
            .tag-close {
                margin-left: 10px;
                @apply(--tag-close);
            }
            .tag-close > pebble-icon {
                --pebble-icon-width: 14px;
                --pebble-icon-height: 14px;
            }
            pebble-icon {
                cursor: pointer;
            }
            pebble-popover {
                --pebble-popover-max-width: 400px;                
                --pebble-popover-width: 380px;                
                @apply(--text-collection-popover);               
            }            
            .dropdown-icon {                
                --pebble-icon-width: 30px;
                --pebble-icon-height: 30px;
                @apply(--dropdown-icon);
            }            
            
        </style>
        <div class="text-collection-container">
            <div class="text-collection-label">[[label]]</div>
            <div class="tags-container">                
                <template is="dom-repeat" items="[[values]]">
                    <div class="tag-content">
                        <div class="tag-value" index$="[[index]]" on-tap="_onTapTag">[[item.value]]</div>                        
                        <div class="tag-close" hidden$="[[isReadonly]]">
                            <pebble-icon icon="pebble-md-icons:Clear" on-tap="_onTapRemove"></pebble-icon>
                        </div>
                    </div>
                </template>                
            </div>            
            <div id="line-with-icon">
                 <pebble-icon hidden$="[[isReadonly]]" class="dropdown-icon" icon="arrow-drop-down" suffix on-tap="_onTapArrowIcon"></pebble-icon>
            </div>            
            <pebble-popover id="tagPopover" for="line-with-icon">
                <content></content>               
            </pebble-popover>
        </div>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-collection-container',

                properties: {
                    /**
                     * Indicates tag items
                     */
                    values: {
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify: true
                    },

                    /**
                     * Indicates label for textbox collection
                     */
                    label: {
                        type: String,
                        value: null
                    },

                    /**
                     * Indicates is-readonly or not
                     */
                    isReadonly: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    }

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                
                /**
                 * Can be used to add tag item
                 */
                add: function(item){
                    if(!this.isReadonly && !this.isExists(item))
                    {
                        this.push('values', item);

                        this.async(function(){
                            this.$$('#tagPopover').refitPopover();
                        });

                        //Trigger add event
                        this.fireBedrockEvent("on-tag-add", item, { ignoreId: true });                    
                    }                    
                },                
                
                /**
                 * Can be used to know the tag exists or not
                 */
                isExists: function(tag){
                    if(!tag)
                    {
                        return;
                    }

                    for(var i = 0; i < this.values.length; i++)
                    {
                        if(this.values[i].value == tag.value)
                        {
                            return true;
                        }
                    }

                    return false;
                },               
                
                /**
                 * Can be used to remove tag item
                 */
                remove: function(item)
                {
                    if(!this.isReadonly && item && this.isExists(item))
                    {
                        this.splice('values', this.values.indexOf(item), 1);

                        //Trigger remove event
                        this.fireBedrockEvent("on-tag-remove", item, { ignoreId: true });
                    }
                },

                /**
                 * Can be used to open popover
                 */
                openPopover:function (e) {                    
                    this.$$('#tagPopover').show();            
                },

                /**
                 * Can be used to close popover
                 */
                closePopover:function (e) {                    
                    this.$$('#tagPopover').hide();            
                },
                
                _onTapRemove: function (e) {
                    var tag = e.model.item;                    
                    this.remove(tag);
                },

                _onTapArrowIcon: function() {
                    this.fireBedrockEvent("on-tap-arrow-icon", null, { ignoreId: true });                    
                },                

                _onTapTag: function(e){
                    var selectedTag = { "item" : e.model.item, "index" : e.target.attributes['index'].value }; //Current edit item                    
                    this.fireBedrockEvent("on-tap-tag", selectedTag, { ignoreId: true });                   
                }

            });
        })();
    </script>

</dom-module>