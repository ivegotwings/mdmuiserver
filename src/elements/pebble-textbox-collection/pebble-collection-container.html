<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-tags/pebble-tags.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`<pebble-textbox-collection>` Represents an element which contains the tags with the "manage" option.

### Example

    <pebble-collection-container label="[[label]]" values="{{values}}" is-readonly="[[isReadonly]]">
        <div class="tag-container">
            <pebble-textbox id='txtInputTag' label="[[_getLabel(_isEdit)]]" value="{{_tagInputText}}" on-keyup="_onEnter">
                <pebble-icon icon="[[_getIcon(_isEdit)]]" suffix on-tap="_onTapIcon"></pebble-icon>
            </pebble-textbox>
            <span class="message" hidden="[[!_showMessage]]">Already exists</span>
        </div>
    </pebble-collection-container>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--text-collection-container` | Mixin applied to component | {}
`--line-with-icon` | Mixing for a line and dropdown icon section | {}
`--line-with-icon-readonly` | Mixing for a line and dropdown icon section when readonly | {}
`--text-collection-label` | Mixin applied to component label | {}
`--tags-container` | Mixin applied to tags container | {}
`--tag-value` | Mixin applied to tag value | {}
`--tag-close-icon` | Mixin applied to tag close | {}
`--text-collection-popover` | Mixin applied to tags collection popover | {}
`--dropdown-icon` | Mixin applied to dropdown icon | {}

@group rock Elements
@element pebble-collection-container
@demo demo/index.html
-->

<dom-module id="pebble-collection-container">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex iron-flex-alignment">
            #line-with-icon {
                border-bottom: 1px solid var(--default-border-color, #c1cad4);
                text-align: right;
                @apply --line-with-icon;
                position: absolute;
                right: 0;
                left: 0;
                bottom: 0;
            }

            #line-with-icon .dropdown-icon {
                margin-right: -8px;
                color: var(--default-icon-color, #7f7f7f);
            }

             :host([is-readonly]) #line-with-icon {
                margin-top: 5px;
                @apply --line-with-icon-readonly;
                border: 0 !important;
            }

            .text-collection-container {
                @apply --text-collection-container;
                position: relative;
                min-height: 28px;
                margin-top: 15px;
            }

            .text-collection-container .tags-container {
                position: relative;
                z-index:9;
            }

            .text-collection-label {
                text-transform: uppercase;
                font-size: var(--font-size-sm, 12px)!important;
                color: #96b0c6;
                line-height: 17px;
                transition: all 0.2s;
                position: absolute;
                top: 6px;
                @apply --text-collection-label;
            }

             :host([is-readonly]) .text-collection-label {
                position: relative;
                top: 0;
            }

            :host([is-readonly]) {
                --pebble-tag-value: {
                    cursor: default;
                };             
            }            

            :host([is-readonly]) .text-collection-container.have-values .text-collection-label {
                top: 0;
                font-size: var(--font-size-sm, 12px)!important;
            }

            .text-collection-container.have-values .text-collection-label {
                top: -16px;
                font-size: var(--font-size-xs, 10px)!important;
            }

            .tags-container {
                min-height: 26px;
                overflow-y: auto;
                margin-right: 25px;
                display: block;
                @apply --layout-horizontal;
                @apply --layout-wrap;
                @apply --tags-container;
            }

            pebble-tags {
                --tag-container: {
                    height: 20px;
                }
                --tag-value: {
                    cursor: pointer;
                    line-height: 19px;
                }
                --paper-icon-button: {
                    padding-top: 0px;
                    padding-right: 0px;
                    padding-bottom: 0px;
                    padding-left: 0px;
                    height: 20px;
                    width: 20px;
                    margin-top: -1px;
                    @apply --tag-close-icon;
                }
            }                
                pebble-icon {
                    cursor: pointer;
                }
                pebble-popover {
                    --pebble-popover-max-width: 400px;                
                    --pebble-popover-width: 260px;                
                    @apply --text-collection-popover;               
                }            
                .dropdown-icon {                
                    --pebble-icon-width: 30px;
                    --pebble-icon-height: 30px;
                    @apply --dropdown-icon;
                }            
                
            </style>
        </custom-style>
        <div class$="text-collection-container [[_valuesClass]]">
            <div class="text-collection-label">[[label]]</div>
            <div class="tags-container">
                <bedrock-pubsub event-name="on-tap-tag-item" handler="_onTapTag"></bedrock-pubsub>
                <bedrock-pubsub event-name="on-tap-tag-remove" handler="_onTapRemove"></bedrock-pubsub>
                <!-- Disabled default edit to implement custom edit -->
                <pebble-tags tags="{{values}}" display-limit="[[displayLimit]]" show-remove-icon="[[!isReadonly]]"></pebble-tags>
            </div>
            <div id="line-with-icon">
                <pebble-icon hidden$="[[isReadonly]]" class="dropdown-icon" icon="arrow-drop-down" suffix></pebble-icon>
            </div>
            <pebble-popover id="tagPopover" for="line-with-icon">
                <slot></slot>
            </pebble-popover>
            <bedrock-pubsub event-name="on-popover-open" handler="_onPopoverOpen"></bedrock-pubsub>
            <bedrock-pubsub event-name="on-popover-close" handler="_onPopoverClose"></bedrock-pubsub>
        </div>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-collection-container',

                properties: {
                    /**
                     * Indicates the tag items.
                     */
                    values: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },

                    /**
                     * Indicates the label for the textbox collection.
                     */
                    label: {
                        type: String,
                        value: null
                    },

                    /**
                     * Specifies whether or not the control is "read-only".
                     */
                    isReadonly: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },

                    /**
                     * Indicates the display limit for tags.
                     */
                    displayLimit: {
                        type: Number,
                        value: 5
                    },

                    _showMoreMessage: {
                        type: Boolean,
                        value: false
                    },

                    _valuesClass: {
                        type: String
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                observers: [
                    '_onValuesChange(values.*)'
                ],

                /**
                 * Can be used to add the tag item.
                 */
                add: function (item) {
                    if (!this.isExists(item)) {
                        this.push('values', item);

                        setTimeout(() =>{
                            this.shadowRoot.querySelector('#tagPopover').refitPopover();
                        }, 10);

                        //Trigger add event
                        this.fireBedrockEvent("on-tag-added-collection", item, { ignoreId: true });
                    }
                },

                /**
                 * Can be used to know whether or not the tag exists.
                 */
                isExists: function (tag) {
                    if (!tag) {
                        return false;
                    }

                    if (this._getTagIndex(tag) != -1) {
                        return true;
                    }

                    return false;
                },

                /**
                 * Can be used to remove the tag item.
                 */
                remove: function (tag) {
                    if (tag) {
                        var index = this._getTagIndex(tag);

                        if (index != -1) {
                            this.splice('values', index, 1);

                            //Trigger remove event
                            this.fireBedrockEvent("on-tag-removed-collection", tag, { ignoreId: true });
                        }
                    }
                },

                /**
                 * Can be used to open the popover.
                 */
                openPopover:function (e) {                    
                    this.shadowRoot.querySelector('#tagPopover').show();            
                },

                /**
                 * Can be used to close the popover.
                 */
                closePopover:function (e) {                    
                    this.shadowRoot.querySelector('#tagPopover').hide();            
                },

                _onValuesChange: function () {
                    if (this.values && this.values.length > 0) {
                        this._valuesClass = "have-values";
                    }
                    else {
                        this._valuesClass = "no-values"
                    }
                },

                _onTapRemove: function (e, detail) {
                    this.fireBedrockEvent("on-tap-remove-collection", detail, { ignoreId: true });
                },

                _onTapTag: function (e) {
                    var selectedTag = { "index": e.detail.index }; //Current edit item                    
                    this.fireBedrockEvent("on-tap-tag-collection", selectedTag, { ignoreId: true });
                },

                _getTagIndex: function (tag) {
                    var index = this.values.indexOf(tag);
                    if (index == -1) {
                        for (var i = 0; i < this.values.length; i++) {
                            if (this.values[i].name.trim().toLowerCase() == tag.name.trim().toLowerCase()) {
                                return i;
                            }
                        }
                    }
                    else {
                        return index;
                    }

                    return -1; //Not find the tag
                },

                _onPopoverOpen: function () {
                    this.fireBedrockEvent("collection-container-open");

                    Polymer.Async.microTask.run(() => {
                        this.shadowRoot.querySelector('#tagPopover').refitPopover();
                    }); //Applied refit after opening the popover
                },

                _onPopoverClose: function () {
                    this.fireBedrockEvent("collection-container-close");
                }
            });
        })();
    </script>

</dom-module>