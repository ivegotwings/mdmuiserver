<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="./pebble-collection-container.html">

<!--
`<pebble-textbox-collection>` Represents an element which contains tags with "add" and "edit" options.

### Example

    <pebble-textbox-collection label='Hashtags' values='[{"value":"color"}, {"value":"size"}]'></pebble-textbox-collection>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--text-collection-manage-tag-container` | Mixin applied to manage tag container | {}
`--add-update-message` | Mixin applied to tag add/update message | {}
`--add-icon-fill-color` | The color property for icon under tag manage container | `green`
`--text-collection-container` | Mixin applied to component | {}
`--line-with-icon` | Mixing for a line and dropdown icon section | {}
`--line-with-icon-readonly` | Mixing for a line and dropdown icon section when readonly | {}
`--text-collection-label` | Mixin applied to component label | {}
`--tags-container` | Mixin applied to tags container | {}
`--tag-value` | Mixin applied to tag value | {}
`--tag-close-icon` | Mixin applied to tag close | {}
`--text-collection-popover` | Mixin applied to tags collection popover | {}
`--dropdown-icon` | Mixin applied to dropdown icon | {}

@group rock Elements
@element pebble-textbox-collection
@demo demo/index.html
-->

<dom-module id="pebble-textbox-collection">
    <template>
        <custom-style><style include="pebble-styles-shared"></style></custom-style>
        <custom-style>
            <style include="iron-flex iron-flex-alignment">
                pebble-icon {
                    cursor: pointer;
                }            
                .tag-container {
                    margin: 0 10px 0 10px;
                    width: 360px;
                    height: 60px;                
                    @apply(--text-collection-manage-tag-container);
                }
                .tag-container > pebble-textbox::shadow pebble-icon {
                    --pebble-icon-fill-color: var(--add-icon-fill-color, green);
                }            
                .message {
                    color:var(--palette-pinkish-red, #ee204c);
                    @apply(--add-update-message);
                }

                pebble-collection-container {
                    @apply(--line-with-icon);
                    @apply(--line-with-icon-readonly);
                    @apply(--text-collection-container);
                    @apply(--text-collection-label);
                    @apply(--tags-container);
                    @apply(--tag-content);
                    @apply(--tag-value);
                    @apply(--tag-close);
                    @apply(--text-collection-popover);
                    @apply(--dropdown-icon);
                }
                
            </style>
        </custom-style>

    <bedrock-pubsub event-name="on-tap-tag-collection" handler="_onTapTag"></bedrock-pubsub>
    <bedrock-pubsub event-name="on-tap-remove-collection" handler="_onTagRemove"></bedrock-pubsub>
    <bedrock-pubsub event-name="on-tap-show-more" handler="_onTapShowMore"></bedrock-pubsub>    
    <bedrock-pubsub event-name="on-popover-close" handler="_onPopoverClose"></bedrock-pubsub>
    <bedrock-pubsub event-name="on-popover-open" handler="_onPopoverOpen"></bedrock-pubsub>    
    <pebble-collection-container label="[[label]]" values="{{_tags}}" is-readonly="[[isReadonly]]" display-limit="[[displayLimit]]" on-tap="_onCollectionContainerTap">
        <div class="tag-container">
            <pebble-textbox id='txtInputTag' label="[[_getLabel(_isEdit)]]" value="{{_tagInputText}}" on-keyup="_onEnter" show-error validation-errors="{{_validationErrors}}">
                <pebble-icon icon="[[_getIcon(_isEdit)]]" suffix on-tap="_onTapIcon"></pebble-icon>
            </pebble-textbox>
        </div>
    </pebble-collection-container>
                
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-textbox-collection',

                properties: {
                    /**
                     * Indicates the tag items.
                     */
                    values: {
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify: true
                    },

                    /**
                     * Indicates the tag items.
                     */
                    _tags: {
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },

                    /**
                     * Indicates the label for the textbox collection.
                     */
                    label: {
                        type: String,
                        value: null
                    },

                    /**
                     * Specifies whether or the control is "read-only".
                     */
                    isReadonly: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Indicates the display limit for the tags.
                     */
                    displayLimit: {
                        type: Number
                    },

                    _tagInputText: {
                        type: String,
                        value: null
                    },                    

                    _currentEditTag: {
                        type: Object,
                        value: function(){ return {}; }
                    },

                    _isEdit: {
                        type: Boolean,
                        value: false
                    },

                    _validationErrors: {
                        type: Array,
                        value: function(){ return[]; },
                        notify: true
                    },

          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    isPopoverOpened: {
                        type: Boolean,
                        value: false
                    },

          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    isRemoveTriggered: {
                        type: Boolean,
                        value: false
                    },

          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    isShowMoreTriggered: {
                        type: Boolean,
                        value: false
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                observers: [
                    '_onValuesChange(values)'
                ],                

                /**
                 * Can be used to add the tag to the collection.
                 */
                add: function(item){
                    this._getCollectionContainer().add(item);
                },

                /**
                 * Can be used to remove the tag from the collection.
                 */
                remove: function(item){
                    this._getCollectionContainer().remove(item);
                },

                /**
                 * Can be used to know whether or not tag exists.
                 */
                isExists: function(item){
                    return this._getCollectionContainer().isExists(item);
                },

                //On values change, apply to tags
                _onValuesChange: function(){                    
                    var _tags = [];

                    if(this.values)
                    {
                        for(var i = 0; i < this.values.length; i++)
                        {
                            var item = {"name": this.values[i], "longName": this.values[i], "color": "#d2d7dd"};
                            _tags.push(item);
                        }

                        this._tags = _tags;
                    }
                },

                _getCollectionContainer: function(){
                    return ElementHelper.getElement(this, "pebble-collection-container");
                },
                

                _onCollectionContainerTap: function () {
                    //Async used because this functionality should execute after closing the existing popover
                    this.async( function() {                    
                        if(this.isReadonly || this.isRemoveTriggered || this.isShowMoreTriggered)
                        {
                            this.isRemoveTriggered = false;
                            this.isShowMoreTriggered = false;
                            return;
                        }

                        this._isEdit = false;

                        var collectionContainer = this._getCollectionContainer();
                        if(collectionContainer && !this.isPopoverOpened) {
                           collectionContainer.openPopover();
                        } else {
                          collectionContainer.closePopover();
                        }
                    });
                },

                _onTapTag: function (e, detail, sender) {
                    if(this.isReadonly)
                    {
                        return;
                    }

                    this._isEdit = true;
                    this._currentEditTag = {"item": this._tags[detail.index], "index": detail.index};
                    this._tagInputText = this._tags[detail.index].name;
                     
                    this.async(function() {
                        this._getCollectionContainer().openPopover();
                    });                                
                },

                _onTapShowMore: function () {
                    this.isShowMoreTriggered = true;
                },

                _getLabel: function(){
                    if(this._isEdit)
                    {
                        return "Update tag";
                    }

                    return "Enter more values here to add";
                },

                _getIcon: function(){
                    if(this._isEdit)
                    {
                        return "save";
                    }

                    return "add-circle";
                },
                
                _onTapIcon: function() {                    
                    
                    var _tagInputText = this._tagInputText ? this._tagInputText.trim() : this._tagInputText;

                    if(!_tagInputText){
                        this._raiseError('Required');
                        return;
                    }

                    if(!this._isEdit)
                    {
                        var item = {"name": _tagInputText};

                        if(this.isExists(item))
                        {   
                            this._raiseError('Already exists');
                            return;
                        }

                        this.add(item);

                        //Add to values
                        this.push('values', item.name)
                        this._notifyValues();                        

                        this._reset();
                    }
                    else if(this._isEdit)
                    {
                        if(!this.isExists(this._currentEditTag.item))
                        {
                            return;
                        }
                        //If updated input is already exists
                        for(var i = 0; i < this._tags.length; i++)
                        {
                            if(i != this._currentEditTag.index && this._tags[i].name.toLowerCase() == _tagInputText.toLowerCase())
                            {
                                this._raiseError('Already exists');
                                return;
                            }
                        }

                        this.set('_tags.' + this._currentEditTag.index + '.name', _tagInputText);
                        this.set('_tags.' + this._currentEditTag.index + '.longName', _tagInputText);

                        //Update to values here
                        this.set('values.' + this._currentEditTag.index, _tagInputText);
                        this._notifyValues();

                        this._getCollectionContainer().closePopover();
                    }                   
                },

                _onTagRemove: function(e, detail, sender){
                    if(this.values[detail.index])
                    {
                        this.splice('values', detail.index, 1);
                        this._notifyValues();
                    }

                    this.isRemoveTriggered = true;
                },

                _notifyValues: function(){
                    var _values = this.values;
                    this.values = [];
                    this.values = _values;
                },

                _raiseError: function(message){
                    this._validationErrors = [];
                    this.push('_validationErrors', message);

                    var _validationErrors = this._validationErrors;
                    this._validationErrors = [];
                    this._validationErrors = _validationErrors;
                },

                _onEnter: function(e) {
                    if (e.keyCode === 13) {
                        this._onTapIcon();
                    }
                },

                _reset: function(){
                    this._tagInputText = '';
                    this._validationErrors = [];
                    this._isEdit = false;
                    this._currentEditTag = {};
                },

                _onPopoverClose: function(){
                    this.isPopoverOpened = false;
                    this._reset();
                },
                
                _onPopoverOpen: function(){
                    this.isPopoverOpened = true;
                    this.shadowRoot.querySelector('#txtInputTag').focus();                  
                }         
            });
        })();
    </script>

</dom-module>