<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`<pebble-textbox-collection>` Represents an element which contains tags with manage option

### Example:

    <pebble-textbox-collection values='[{"name":"color"}, {"name":"size"}]'></pebble-textbox-collection>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--text-collection-container` | Mixin applied to component | {}
`--text-collection-label` | Mixin applied to component label | {}
`--tags-container` | Mixin applied to tags container | {}
`--tag-content` | Mixin applied to tag content | {}
`--tag-value` | Mixin applied to tag value | {}
`--tag-close` | Mixin applied to tag close | {}
`--text-collection-popover` | Mixin applied to tags collection popover | {}
`--text-collection-manage-tag-container` | Mixin applied to manage tag container | {}
`--dropdown-icon` | Mixin applied to dropdown icon | {}
`--add-update-message` | Mixin applied to tag add/update message | {}
`--add-icon-fill-color` | The color property for icon under tag manage container | `green`

@group rock Elements
@element pebble-textbox-collection
@demo demo/index.html
-->

<dom-module id="pebble-textbox-collection">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex iron-flex-alignment">
            pebble-textbox::shadow paper-input {
                margin-top: -25px;               
            }
            .text-collection-container {
                width: 400px;
                @apply(--text-collection-container)
            }
            .text-collection-label {
                text-transform: uppercase;
                @apply(--text-collection-label)
            }
            .tags-container {
                max-height: 75px;                
                overflow-y: auto; 
                margin-right: 25px;
                display: block;                
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                @apply(--tags-container)
            }
            .tag-content{
                border: 1px solid #cacaca;
                border-left: 4px solid #cacaca;
                border-radius: 4px;
                margin: 4px;
                padding: 4px;                                
                @apply(--layout-horizontal);
                @apply(--tag-content)                
            }
            .tag-value {
                text-transform: capitalize;
                cursor: pointer;
                @apply(--tag-value);
            }
            .tag-close {
                margin-left: 10px;
                @apply(--tag-close);
            }
            .tag-close > pebble-icon {
                --pebble-icon-width: 14px;
                --pebble-icon-height: 14px;
            }
            pebble-icon {
                cursor: pointer;
            }
            pebble-popover {
                --pebble-popover-max-width: 400px;                
                --pebble-popover-width: 380px;
                margin-top: -5px;
                @apply(--text-collection-popover)                
            }
            .tag-container {
                margin: 15px 10px 5px 10px;
                width: 360px;                
                @apply(--text-collection-manage-tag-container)
            }
            .tag-container > pebble-textbox::shadow pebble-icon {
                --pebble-icon-fill-color: var(--add-icon-fill-color, green);
            }
            .dropdown-icon {                
                --pebble-icon-width: 30px;
                --pebble-icon-height: 30px;
                @apply(--dropdown-icon)
            }
            .message {
                color: red;
                @apply(--add-update-message)
            }
            
        </style>
        <div class="text-collection-container">
            <div class="text-collection-label">[[label]]</div>
            <div class="tags-container">                
                <template is="dom-repeat" items="[[values]]">
                    <div class="tag-content">
                        <div class="tag-value" index$="[[index]]" on-tap="_onTapEdit">[[item.name]]</div>
                        <div class="tag-close">
                            <pebble-icon icon="pebble-md-icons:Clear" on-tap="_onTapRemove"></pebble-icon>
                        </div>                        
                    </div>
                </template>                
            </div>
            <pebble-textbox id="tagTextCollection" no-Label-Float type="text" readonly>
                <pebble-icon class="dropdown-icon" icon="arrow-drop-down" suffix on-tap="_openPopover"></pebble-icon>
            </pebble-textbox>
            <bedrock-pubsub event-name="on-popover-close" handler="_onPopoverClose"></bedrock-pubsub>
            <bedrock-pubsub event-name="on-popover-open" handler="_onPopoverOpen"></bedrock-pubsub>
            <pebble-popover id="tagPopover" for="tagTextCollection">
                <template is="dom-if" if="[[!_showUpdateWindow]]">            
                    <div class="tag-container">
                        <pebble-textbox id='txtAddTag' label="Enter more values here to add" value="{{_tagInputText}}" on-keyup="_onEnterAdd">
                            <pebble-icon icon="add-circle" suffix on-tap="_onTapAdd"></pebble-icon>
                        </pebble-textbox>
                        <span class="message" hidden="[[!_showMessage]]">Alreay exists</span>
                    </div>
                </template>
                <template is="dom-if" if="[[_showUpdateWindow]]">
                    <div class="tag-container">
                        <pebble-textbox id='txtUpdateTag' label="Update tag" value="{{_tagInputText}}" on-keyup="_onEnterUpdate">
                            <pebble-icon icon="save" suffix on-tap="_onTapUpdate"></pebble-icon>
                        </pebble-textbox>
                        <span class="message" hidden="[[!_showMessage]]">Already exists</span>
                    </div>
                </template>
            </pebble-popover>            
        </div>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-textbox-collection',

                properties: {
                    /**
                     * Indicates tag items
                     */
                    values: {
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },

                    label: {
                        type: String,
                        value: 'HASHTAGS'
                    },

                    _tagInputText: {
                        type: String,
                        value: null
                    },

                    _showMessage: {
                        type: Boolean,
                        value: false
                    },

                    _showUpdateWindow: {
                        type: Boolean,
                        value: false
                    },

                    _currentEditTag: {
                        type: Object,
                        value: function(){ return {}; }
                    }

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                // Public
                /**
                 * Can be used to add tag item
                 */
                add: function(item){
                    if(!this.isExists(item))
                    {
                        this.push('values', item);                        
                        this._reset();

                        this.async(function(){
                            this.$$('#tagPopover').refitPopover();
                        });                      
                    }
                    else
                    {
                        this._showMessage = true;
                    }
                },                
                
                /**
                 * Can be used to know the tag exists or not
                 */
                isExists: function(tag){
                    for(var i = 0; i < this.values.length; i++)
                    {
                        if(this.values[i].name.toLowerCase() == tag.name.toLowerCase())
                        {
                            return true;
                        }
                    }

                    return false;
                },               
                
                /**
                 * Can be used to remove tag item
                 */
                remove: function(item)
                {
                    if(item && this.isExists(item))
                    {
                        this.splice('values', this.values.indexOf(item), 1);
                    }
                },                
                
                //Private
                _reset: function(){
                    this._tagInputText = '';                    
                    this._showMessage = false;
                    this._showUpdateWindow = false;
                    this._currentEditTag = {};
                },

                _openPopover:function (e) {                    
                    this.$$('#tagPopover').show();            
                },

                //Events
                _onTapRemove: function (e) {
                    var tag = e.model.item;                    
                    this.remove(tag);
                },

                _onTapAdd: function() {
                    if(!this._tagInputText || (this._tagInputText && !this._tagInputText.trim()) ){
                        return;
                    }

                    var item = {"name": this._tagInputText};
                    this.add(item);                    
                },

                _onEnterAdd: function(e) {
                    if (e.keyCode === 13) {
                        this._onTapAdd();
                    }
                },

                _onTapEdit: function(e){
                    this._currentEditTag = { "item" : e.model.item, "index" : e.target.attributes['index'].value }; //Current edit item
                    this._tagInputText = this._currentEditTag.item.name;                    
                    this._showUpdateWindow = true;
                    this.$$('#tagPopover').show();                    
                },

                _onTapUpdate: function(){
                    //Verify input data
                    if(!this._tagInputText || (this._tagInputText && !this._tagInputText.trim()) ){
                        return;
                    }

                    //If updated input is already exists
                    for(var i = 0; i < this.values.length; i++)
                    {
                        if(i != this._currentEditTag.index && this.values[i].name == this._tagInputText)
                        {
                            this._showMessage = true;
                            return;
                        }
                    }

                    this.set('values.' + this._currentEditTag.index + '.name', this._tagInputText);
                    this.$$('#tagPopover').hide();
                },

                _onEnterUpdate: function(e){
                    if (e.keyCode === 13) {
                        this._onTapUpdate();
                    }
                },

                _onPopoverClose: function(){
                    this._reset();
                },
                
                _onPopoverOpen: function(){
                    if(this._showUpdateWindow)
                    {
                        this.$$('#txtUpdateTag').focus();
                    }
                    else
                    {
                        this.$$('#txtAddTag').focus();
                    }                   
                }          
            });
        })();
    </script>

</dom-module>