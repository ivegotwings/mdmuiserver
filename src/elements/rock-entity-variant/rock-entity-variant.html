        <link rel="import" href="../../../bower_components/polymer/polymer.html">
        <link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

        <link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
        <link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

        <link rel="import" href="../pebble-tree/pebble-tree.html">
        <link rel="import" href="../pebble-tree/pebble-tree-node.html">
        <link rel="import" href="../pebble-button/pebble-button.html">
        <link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
        <link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
        <link rel="import" href="../rock-grid/remote-data.html">
        <link rel="import" href="../rock-grid/rock-grid.html">
        <link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
        <link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
        <link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

        <!--
        `rock-entity-variant` Represents an element that is used to create new variants and entities.

        @demo demo/index.html
        -->
        <dom-module id="rock-entity-variant">
            <template>
                <style include="pebble-styles-shared">
                    .left {
                        width:30%;
                        border-right: 1px solid var(--palette-cloudy-blue);
                    }

                    .right {
                        width:70%;
                    }

                    .container {
                        width:100%;
                        display: inline-flex;
                display: -webkit-inline-flex;
                    }

                    #tree{
                        margin-top: 47px;
                        box-shadow: 0 1px 7px 0 rgba(156, 166, 178, 0.96);
                        padding: 10px;
                    }

                    #tree::shadow rock-search-bar{
                        height: 30px;
                        border: none;
                        padding: 5px;
                    }

                    pebble-button {
                        vertical-align: baseline-middle;
                        --pebble-button: {
                            height: 30px;
                            padding: 0.5em 0em 0.5em 0em;
                            min-width: 2.14em;
                            margin: 0px;
                        }
                        --pebble-button-iron-icon: {
                            height: 20px;
                            width: 20px;

                        }
                    }

                    pebble-button.pageRange::shadow paper-button {
                        line-height: var(--border-btn-height,24px);
                        height: var(--border-btn-height,24px);
                        box-shadow: none;
                        font-family: var(--default-font-family);
                        color: var(--button-bg-color);
                    }

                    .action-container {
                        display: inline-flex;
                        display: -webkit-inline-flex;
                        float: right;
                    }


                </style>
                <div class="container">
                    <iron-ajax auto url="/src/data/EntityManageApp/variantGridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
                    <iron-ajax auto url="/src/data/EntityManageApp/variant-definition-ui.json" handle-as="json" last-response="{{variantConfig}}"></iron-ajax>
                    <liquid-entity-data-get verbose auto  id="getTreeData" operation="getbyids" request-data="[[_getTreeRequest(entityId)]]"  last-response="{{remoteTreeData}}" >
                    </liquid-entity-data-get>
                    <liquid-entity-data-get verbose  id="getChildrenData" operation="getbyids"   last-response="{{childrenData}}" on-response="_populateChildrenData" >
                    </liquid-entity-data-get>
                    <div class="left">
                        <pebble-tree id = "tree" disabled="[[isEditMode]]" data="[[treeData]]" default-child-depth="[[_getDefaultChildDepth(variantConfig)]]"  selected-items="{{selectedItems}}"  indeterminate-items="{{indeterminateItems}}"  default-expand-depth="1" multi-select enable-search check-child-nodes show-horizontal-divider></pebble-tree>
                    </div>
                    <pebble-vertical-divider></pebble-vertical-divider>
                    <div class="right">
                        <div class ="grid-container">
                            <liquid-entity-get auto name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
                            <template is="dom-if" if="[[_gridRequestAdded(gridRequest,gridConfig)]]">
                            <remote-data id="gridSource" request="[[gridRequest]]" operation="getbyids" data-formatter="{{dataFormatter}}"
                                         current-record-size="{{size}}" total-records="{{totalRecords}}" data-source="{{dataSource}}"></remote-data>
                            <rock-grid id="grid" data-source="{{dataSource}}" data-source-id="gridSource" record-size="{{totalRecords}}" config="{{gridConfig}}"
                                       grid-data-size="{{size}}" page-size="10"  attribute-models="{{attributeModelResponse.returnValue.attributeModels}}" ></rock-grid>
                            <bedrock-pubsub event-name="grid-edit-item" handler="_onGridEdit" target-id="grid"></bedrock-pubsub>
                            </template>
                        </div>
                        <div class="action-container" hidden = "[[!isEditMode]]">
                            <pebble-button class="pageRange btn btn-secondary" button-text="Cancel" on-tap="_cancelAction" noink raised></pebble-button>
                            <pebble-button class="pageRange btn btn-secondary" button-text="Save" on-tap="_saveAction" noink raised></pebble-button>
                        </div>
                    </div>
                    <liquid-entity-data-save verbose name="attributeSaveDataService" operation="update"
                                              last-response="{{saveResponse}}" on-response="_onSaveResponse"></liquid-entity-data-save>
                </div>
            </template>
            <script>
                (function() {
                    'use strict';

                    Polymer({

                        is: 'rock-entity-variant',

                        properties: {
                            /**
                             * Indicates the id of the entity for which we are showing the variants
                             */
                            entityId:{
                              type:String
                            },
                            /**
                             * Indicates tree data in the array form.
                             */
                            treeData: {
                                type: Array,
                                value: function() {return [];}
                            },
                            /**
                             * Indicates the data which we get from liquid component for tree
                             */
                            remoteTreeData: {
                                type: Object,
                                value: function() {return {};},
                                observer:'_populateDataForTree'

                            },
                            /**
                            * Indicates the configuration object that to be passed to grid.
                            */
                            gridConfig: {
                                type: Object,
                                notify: true
                            },
                            /**
                            * Indicates data model object for grid data.
                            */
                            gridData: {
                                type: Object,
                                notify: true
                            },
                            /**
                             * Indicates the currently indeterminate item lists.
                             */
                            indeterminateItems: {
                                type: Array,
                                value: function() {return [];},
                                notify: true
                            },

                            /**
                             * Indicates the currently selected item list.
                             */
                            selectedItems: {
                                type: Array,
                                notify: true,
                                value: function() {return [];},
                                observer:'_selectedItemsChanged'
                            },
                            /**
                            * Specifies whether entity variants in edit mode or not.
                            */
                            isEditMode : {
                                type : Boolean,
                                notify : true,
                                value : false
                            },
                            /**
                             * Specifies all dimensions that are selected in dimension selector.
                             */
                            dimensions: {
                                type: Object
                            },
                            /**
                             * Specifies the request Object to get the tree data
                             */
                            treeRequest : {
                                type: Object,
                                value: function () {
                                return {
                                    "params": {
                                        "query": {
                                            "ctx": [
                                                {"classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry",
                                                "list": "productMaster"}
                                            ],
                                            "valCtx": [
                                                {"locale": "en-US", "source": "SAP"}
                                            ],
                                            "id": "t1_entity1",
                                            "filters": {
                                                "attributesCriterion": [],
                                                "typesCriterion": [
                                                    "nart"
                                                ]
                                            }
                                        },
                                        "fields": {
                                            "ctxTypes": [
                                                "properties"
                                            ],
                                            relationships:[
                                                "isChildOf"
                                            ],
                                            relatedEntityAttributes:[
                                                "cpimProductName","shortName","longName","name"
                                            ]

                                        },
                                        "options": {
                                            "from": 0,
                                            "to": 9
                                        }
                                    }
                                };}
                            },
                            /**
                             * Indicates the request object that is passed to the data element to retrive attribute model data.
                             */
                            attributeModelRequest: {
                                type: Object,
                                value: function () {
                                    return {
                                        action: "getAttributeModels"
                                    };
                                }
                            },
                            /**
                             * Indicates call back function where if user has given any liquid operation and request object to load data
                             * user has to transform data based on their grid config and return array of records.
                             */
                            dataFormatter: {
                                notify: true,
                                value: function () {
                                    return this._getAttributeFormattedData.bind(this);
                                }
                            }
                        },
                        behaviors: [
                            RUFBehaviors.UIBehavior
                        ],
                        observers : [
                            '_editModeChanged(gridConfig.mode)'
                        ],
                        listeners:{
                            'tree-node-expanded':'_treeNodeExpanded'
                        },
                        _getTreeRequest:function () {
                          var req=this.treeRequest;
                          req.params.query.id=this.entityId;
                          if(this.dimensions){
                            req.params.query.ctx = this._prepareContextGroups(this.dimensions.lists);
                            req.params.query.valCtx = this._prepareValueContextGroups(this.dimensions.sources, this.dimensions.locales);
                          }
                          return req;
                        },
                        _getDefaultChildDepth:function () {
                          return this.variantConfig.levels.length;
                        },
                        _treeNodeExpanded: function (e) {
                            this.parent=e.detail;
                            if(!this.parent.nodeData.children || this.parent.nodeData.children.length==0) {
                                this._getChildren(e.detail.nodeData.value);
                            }
                        },

                        _getGridRequest: function () {
                         if(!this.gridConfig){
                             return;
                         }
                          var req= {
                              "params": {
                                  "query": {
                                      "ctx": [
                                          {"classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry",
                                              "list": "productMaster"}
                                      ],
                                      "valCtx": [
                                          {"locale": "en-US", "source": "SAP"}
                                      ],
                                      "ids": [],
                                      "filters": {
                                          "attributesCriterion": [],
                                          "typesCriterion": []
                                      }
                                  },
                                  "fields": {
                                      "ctxTypes": [
                                          "properties"
                                      ],
                                      "attributes":[]
                                  },
                                  "options": {
                                      "from": 0,
                                      "to": 9
                                  }
                              }
                          };
                          if(this.dimensions){
                              req.params.query.ctx = this._prepareContextGroups(this.dimensions.lists)
                              req.params.query.valCtx = this._prepareValueContextGroups(this.dimensions.sources, this.dimensions.locales);
                          }
                            if(this.selectedItems && this.selectedItems.length > 0) {
                                req.params.query.ids=[];
                                this.selectedItems.forEach(function (item) {
                                  req.params.query.ids.push(item.value);
                                });
                            }
                          if(this.indeterminateItems &&this.indeterminateItems.length>0){
                              this.indeterminateItems.forEach(function (item) {
                                  req.params.query.ids.push(item.value);
                              });
                          }
                          if(req.params.query.ids.length==0){
                              req.params.query.ids=[""];
                          }
                          this.gridConfig.tabular.columns.forEach(function (column) {
                              req.params.fields.attributes.push(column.name);
                          });
                          return req;
                        },
                        _selectedItemsChanged : function() {
                            this.async(function () {
                                if(this.selectedItems) {
                                        var request = this._getGridRequest();
                                        this.gridRequest = request;
                                        if(this.$$("#grid")) {
                                            this.$$("#grid").reRenderGrid();
                                        }
                                }
                            });
                        },
                        _editModeChanged : function(mode) {
                            if(mode == 'Edit') {
                                this.set('isEditMode',true);
                            } else {
                                this.set('isEditMode',false);
                            }
                        },

                        _saveAction : function(e) {
                            var entities={};
                            for(var i=0;i<this.editableItems.length;i++){
                                var id=this.editableItems[i].id;
                                entities[id]=this.editableItems[i];
                            }
                            var attributeSaveDataService = this.$$('[name="attributeSaveDataService"]');
                            attributeSaveDataService.requestData={"entities": entities};
                            if(attributeSaveDataService){
                                attributeSaveDataService.generateRequest();
                            }

                        },
                        _onSaveResponse:function (e) {
                            this.isEditMode = false;
                            var that=this;
                            this.editableItems.forEach(function (item) {
                                that.$$("#grid").changeRowToViewMode(item);
                            });
                        },

                        _cancelAction : function(e) {
                            this.isEditMode = false;
                            var that=this;
                            this.editableItems.forEach(function (item) {
                                that.$$("#grid").changeRowToViewMode(item);
                            });
                            this.$$("#grid").reRenderGrid();
                        },
                        _onGridEdit:function (e, detail, sender) {
                            if(!this.editableItems){
                                this.editableItems=[];
                            }
                            this.push('editableItems',detail);
                            this.isEditMode=true;
                        },
                        _getChildren: function (id) {
                            var req=this.treeRequest;
                            req.params.query.id=id;
                            if(this.dimensions){
                                req.params.query.ctx = this._prepareContextGroups(this.dimensions.lists);
                                req.params.query.valCtx = this._prepareValueContextGroups(this.dimensions.sources, this.dimensions.locales);
                            }
                            this.$.getChildrenData.requestData=req;
                            this.$.getChildrenData.generateRequest();
                        },
                        _populateChildrenData:function (e) {
                            var data = [];
                            var respData=e.detail.response;
                            if(respData)
                            {
                                if(respData.content && respData.content.entities)
                                {
                                    var entities = respData.content.entities;
                                    var entityId = Object.keys(entities)[0];
                                    if(entityId){
                                        var entity = entities[entityId];
                                        if(entity && entity.data && entity.data.ctxInfo){
                                            Object.keys(entity.data.ctxInfo).forEach(function(item) {
                                                if(entity.data.ctxInfo[item]) {
                                                    var relationships = entity.data.ctxInfo[item].relationships;
                                                    var relationshipTyleList = [];
                                                    if(relationships) {
                                                        var relatedEntities = relationships["isChildOf"];
                                                        Object.keys(relatedEntities.rels).forEach(function(relItem){
                                                            var record = {};
                                                            var relElement = relatedEntities.rels[relItem];
                                                            if(relElement.attributes) {
                                                                Object.keys(relElement.attributes).forEach(function(item){
                                                                    if(relElement.attributes[item]) {
                                                                        record[item] = relElement.attributes[item].values[0].value;
                                                                    }
                                                                }, this);
                                                            }
                                                            if (relElement.relToObject) {
                                                                record["value"] = relElement.relToObject.id;
                                                                //TODO if entity name is present in data text should be entity name and not entity id
                                                                record["text"] = relElement.relToObject.id;
                                                            }
                                                            data.push(record);
                                                        }, this);
                                                    }
                                                }
                                            }, this);
                                        }
                                    }
                                }
                            }

                            this.parent.nodeData.children=data;
                            var nodeData=this.parent.nodeData;
                            this.parent.nodeData=[];
                            this.parent.nodeData=nodeData;
                        },
                        _populateDataForTree: function(respData){
                            var treeData = [];
                            if(respData)
                            {
                                if(respData.content && respData.content.entities)
                                {
                                    var entities = respData.content.entities;
                                    var entityId = Object.keys(entities)[0];
                                    if(entityId){
                                        treeData=[{"text":entityId, "value":entityId,children:[]}];
                                        var data=[];
                                        var entity = entities[entityId];
                                        if(entity && entity.data && entity.data.ctxInfo){
                                            Object.keys(entity.data.ctxInfo).forEach(function(item) {
                                                if(entity.data.ctxInfo[item]) {
                                                    var relationships = entity.data.ctxInfo[item].relationships;
                                                    var relationshipTyleList = [];

                                                    if(relationships) {
                                                        var relatedEntities = relationships["isChildOf"];
                                                        Object.keys(relatedEntities.rels).forEach(function(relItem){
                                                            var record = {};
                                                            var relElement = relatedEntities.rels[relItem];
                                                            if(relElement.attributes) {
                                                                Object.keys(relElement.attributes).forEach(function(item){
                                                                    if(relElement.attributes[item]) {
                                                                        record[item] = relElement.attributes[item].values[0].value;
                                                                    }
                                                                }, this);
                                                            }
                                                            if (relElement.relToObject) {
                                                                record["value"] = relElement.relToObject.id;
                                                                //TODO if entity name is present in data text should be entity name and not entity id
                                                                record["text"] = relElement.relToObject.id;
                                                            }
                                                            data.push(record);
                                                        }, this);
                                                    }
                                                }
                                            }, this);
                                        }
                                        treeData[0].children=data;
                                    }
                                }
                            }
                            this.treeData=treeData;
                            if(treeData.length>0) {
                                this.push('selectedItems', treeData[0].children[0]);
                            }
                        },

                        _prepareContextGroups: function (lists) {
                            if (lists && lists instanceof Array) {
                                var ctxGroup = [];

                                for (var i = 0; i < lists.length; i++) {
                                    var ctxInfoObject = new Object();
                                    ctxInfoObject.list = lists[i].value;
                                    ctxInfoObject.classification =
                                        "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry";
                                    ctxGroup.push(ctxInfoObject);
                                }

                                return ctxGroup;
                            }
                        },

                        _prepareValueContextGroups: function (sources, locales) {
                            var valueCtxGroup = [];

                            if (sources && locales && sources instanceof Array && locales instanceof Array) {
                                for (var i = 0; i < sources.length; i++) {
                                    for (var j = 0; j < locales.length; j++) {

                                        var valueCtxInfoObject = new Object();
                                        valueCtxInfoObject.source = sources[i].value;
                                        valueCtxInfoObject.locale = locales[j].value;
                                        valueCtxGroup.push(valueCtxInfoObject);
                                    }
                                }

                                return valueCtxGroup;
                            }
                        }, _getAttributeFormattedData: function (data) {
                                var dataArray = [];
                                if(data && data.content) {
                                    var entities = data.content.entities;
                                    if(entities) {
                                        dataArray = Object.keys(entities).map(function (key) {
                                            if (entities.hasOwnProperty(key)) {
                                                return entities[key];
                                            }
                                        });
                                        DataHelper.transformEntitySchemaForGrid(dataArray, this.attributeModelResponse.returnValue.attributeModels);
                                    }
                                }
                                return dataArray;
                        },
                        _gridRequestAdded:function () {
                            if(this.gridConfig && this.gridRequest && !DataHelper.isEmptyObject(this.gridRequest)){
                                return true;
                            }
                            return false;
                        }
                    })
                })();
            </script>
        </dom-module>