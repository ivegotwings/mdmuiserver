<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../pebble-tree/pebble-tree.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<!--
`rock-entity-variant` Represents an element that is used to create new variants and entities.

@demo demo/index.html
-->
<dom-module id="rock-entity-variant">
    <template>
        <style include="pebble-styles-shared">
            .left {
                width:30%;
                border-right: 1px solid var(--palette-cloudy-blue);
            }

            .right {
                width:70%;
            }

            .container {
                width:100%;
                display: inline-flex;
            }

            #tree{
                box-shadow: 0 1px 7px 0 rgba(156, 166, 178, 0.96);
                padding: 10px;
            }

            .btn-with-border{
                margin-right:var(--default-margin,10px);
            }

            #tree::shadow rock-search-bar{
                height: 30px;
                border: 1px solid var(--textbox-border);
                padding: 5px;
            }

            pebble-button {
                vertical-align: -webkit-baseline-middle;
                vertical-align: -moz-baseline-middle;
                vertical-align: baseline-middle;
                --pebble-button: {
                    height: 30px;
                    padding: 0.5em 0em 0.5em 0em;
                    min-width: 2.14em;
                    margin: 0px;
                }
                --pebble-button-iron-icon: {
                    height: 20px;
                    width: 20px;

                }
            }

            pebble-button.pageRange::shadow paper-button {
                line-height: var(--border-btn-height,24px);
                height: var(--border-btn-height,24px);
                box-shadow: none;
                font-family: var(--default-font-family);
                color: var(--button-bg-color);
            }

            .action-container {
                display: inline-flex;
                float: right;
            }
            .tree-title{
                padding-left: 20px;
                margin-top: 17px;
            }

        </style>
        <div class="container">
            <iron-ajax auto url="/src/data/EntityManageApp/variantTreeData.json" handle-as="json" last-response="{{initialNav}}"></iron-ajax>
            <iron-ajax auto url="/src/data/EntityManageApp/variantGridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
            <iron-ajax auto url="/src/data/EntityManageApp/variantGridData.json" handle-as="json" on-response="handleResponse"></iron-ajax>
            <div class="left">
                <div class="tree-title" >
                    {{treeTitle}}
                </div>
                <pebble-tree id = "tree" initial-nav="[[initialNav]]" selected-item="{{selectedItem}}" selected-items="{{selectedItems}}" multi-select enable-search></pebble-tree>
            </div>
            <pebble-vertical-divider></pebble-vertical-divider>
            <div class="right">
                <div class ="grid-container">
                    <pebble-grid id = "pebbleGrid" config="{{gridConfig}}" page-size="10" data="{{gridData}}"></pebble-grid>
                </div>
                <div class="action-container" hidden = [[!isEditMode]]>
                    <pebble-button class="pageRange btn-with-border" button-text="Cancel" on-tap="cancelAction" noink raised></pebble-button>
                    <pebble-button class="pageRange btn-with-border" button-text="Save" on-tap="saveAction" noink raised></pebble-button>
                </div>
            </div>
        </div>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({

                is: 'rock-entity-variant',

                properties: {

                    /**
                     * Indicates initial navigation in the array form.
                     */
                    initialNav: {
                        type: Array,
                        value: function() {return [];}
                    },

                    gridConfig: {
                        type: Object,
                        notify: true
                    },

                    gridData: {
                        type: Object,
                        notify: true
                    },

                    initialGridData : {
                        type: Object,
                        notify: true
                    },

                    /**
                     * Indicates the currently selected item.
                     */
                    selectedItem: {
                        type: String,
                        notify: true
                    },

                    /**
                     * Indicates the currently selected item list.
                     */
                    selectedItems: {
                        type: Array,
                        notify: true,
                        value: function() {return [];},
                        observer : 'selectedItemsChanged'
                    },

                    isEditMode : {
                        type : Boolean,
                        notify : true,
                        value : false
                    }
                },

                observers : [
                    'editModeChanged(gridConfig.mode)'
                ],

                selectedItemsChanged : function() {
                    var foundItems = [];
                    var that = this;
                    if(this.selectedItems && this.selectedItems.length > 0) {
                        if(this.selectedItems.length == 1 && this.selectedItems[0].isNew) {
                            this.gridData = [];
                            this.$.pebbleGrid.addNewRows(1);
                            this.isEditMode = true;
                        } else {
                            for (var i = 0, len = that.initialGridData.length; i < len; i++) {
                                this.selectedItems.forEach(function (item) {
                                    if (that.isDataMatches(that.initialGridData[i], item.text)) {
                                        foundItems.push(that.initialGridData[i]);
                                    }
                                });
                            }
                            this.$.pebbleGrid.data = foundItems;
                            this.$.pebbleGrid.reRenderGrid();
                        }
                    } else if(this.selectedItems && this.selectedItems.length == 0) {
                        this.$.pebbleGrid.data = this.initialGridData;
                        this.$.pebbleGrid.reRenderGrid();
                    }
                },

                isDataMatches :function (data,text) {
                    if(data.shortName.toLowerCase().indexOf(text.toLowerCase()) != -1 ||
                        data.longName.toLowerCase().indexOf(text.toLowerCase()) != -1   ||
                        data.productType.toLowerCase().indexOf(text.toLowerCase()) != -1 ||
                        data.description.toLowerCase().indexOf(text.toLowerCase()) != -1
                    ) {
                        return true;
                    }
                    return false;
                },

                handleResponse : function (e) {
                    var data = e.detail.xhr.response;
//                    console.log(e.detail.xhr.response);
                    this.gridData = data;
                    this.initialGridData = data;
                },

                editModeChanged : function(mode) {
                    if(mode == 'Edit') {
                        this.set('isEditMode',true);
                    } else {
                        this.set('isEditMode',false);
                    }
                },

                saveAction : function(e) {
                    if(this.selectedItems.length == 1 && this.selectedItems[0].isNew) {
                        var newData = this.gridData[0];
                        newData.isEditable = false;
                        this.push('initialGridData', newData);
//                        var arr = [];
//                        arr.push(newData);
                        this.$.pebbleGrid.data = this.initialGridData;
                        this.$.pebbleGrid.reRenderGrid();
                        this.selectedItems[0].isNew = false;
                        this.$.tree.clearSelectedItems();
                    } else {
                        //TODO
                        this.initialGridData = this.gridData;
                        this.$.pebbleGrid.reRenderGrid();
                    }
                    this.isEditMode = false;
                },

                cancelAction : function(e) {
                    this.$.tree.clearSelectedItems();
                    this.$.pebbleGrid.data = this.initialGridData;
                    this.$.pebbleGrid.reRenderGrid();
                    this.isEditMode = false;
                }
            });
        })();
    </script>
</dom-module>