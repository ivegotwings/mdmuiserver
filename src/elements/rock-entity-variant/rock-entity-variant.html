<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">

<link rel="import" href="../pebble-tree/pebble-tree.html">
<link rel="import" href="../pebble-tree/pebble-tree-node.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../rock-grid/remote-data.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="entity-variant-grid-datasource.html">

<!--
        `rock-entity-variant` Represents an element that is used to create the new variants and entities.

        @demo demo/index.html
        -->
<dom-module id="rock-entity-variant">
    <template>
        <style include="pebble-styles-shared">
            .left {
                width: 30%;
                border-right: 1px solid var(--palette-cloudy-blue);
            }
            
            .right {
                width: 70%;
            }
            
            .container {
                margin: 10px;
                width: 98%;
                box-shadow: 0 1px 7px 0 var(--palette-cloudy-blue, #c1cad4);
                display: inline-flex;
                display: -webkit-inline-flex;
            }
            
            #tree::shadow rock-search-bar {
                height: 30px;
                border: none;
                padding: 5px;
            }
            
            pebble-button {
                vertical-align: baseline-middle;
                --pebble-button: {
                    height: 30px;
                    padding: 0.5em 0em 0.5em 0em;
                    min-width: 2.14em;
                    margin: 0px;
                }
                --pebble-button-iron-icon: {
                    height: 20px;
                    width: 20px;
                }
            }
            
            pebble-button.pageRange::shadow paper-button {
                line-height: var(--border-btn-height, 24px);
                height: var(--border-btn-height, 24px);
                box-shadow: none;
                font-family: var(--default-font-family);
                color: var(--button-bg-color);
            }
            
            .action-container {
                display: inline-flex;
                display: -webkit-inline-flex;
                float: right;
            }
        </style>
        <div class="container">
            <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{attributeModelRequest}}" on-response="_onCompositeModelGetResponse" exclude-in-progress></liquid-entity-model-composite-get>
            <liquid-config-get auto id="getManageAppConfig" operation="getconfigs" request-id="getManageAppConfig" request-data="{{_configRequest}}"
                               last-response="{{applicationConfig}}"></liquid-config-get>
            <liquid-entity-data-get auto id="getTreeData" operation="getbyids" request-data="[[_getTreeRequest(entityId,entityType)]]" last-response="{{remoteTreeData}}">
            </liquid-entity-data-get>
            <liquid-entity-data-get id="getChildrenData" operation="getbyids" last-response="{{childrenData}}" on-response="_populateChildrenData">
            </liquid-entity-data-get>
            <div class="left">
                <pebble-tree id="tree" class="p-t-15" disabled="[[isEditMode]]" data="[[treeData]]" default-child-depth="[[_getDefaultChildDepth(variantConfig)]]"
                    selected-items="{{selectedItems}}" indeterminate-items="{{indeterminateItems}}" default-expand-depth="1"
                    multi-select enable-search check-child-nodes show-horizontal-divider></pebble-tree>
            </div>
            <pebble-vertical-divider></pebble-vertical-divider>
            <div class="right p-t-5 p-b-5">
                <pebble-button class="btn btn-primary m-r-10 m-t-10 pull-right" button-text="Variant Configurator" on-tap="_openVariantDialog"></pebble-button>
                <rock-business-function-dialog id="bFDialog" config="{{getConfig('rock-entity-variant', '', 'businessFunctionVariantsCreate', 'app-entity-manage')}}"></rock-business-function-dialog>
                <div class="grid-container">
                    <template is="dom-if" if="[[_gridRequestAdded(gridRequest,gridConfig)]]">
                    <entity-variant-grid-datasource id="gridSource" request="[[gridRequest]]" total-records="{{totalRecords}}" current-record-size="{{size}}"
                        data-source="{{dataSource}}" data-formatter="{{dataFormatter}}"></entity-variant-grid-datasource>
                    <rock-grid id="grid" data-source="{{dataSource}}" data-source-id="gridSource" config="{{getConfig('rock-entity-variant', '', 'variantGridConfig', 'app-entity-manage')}}"
                        page-size="15" record-size="{{totalRecords}}" grid-data-size="{{size}}" attribute-models="[[_attributeModels]]"></rock-grid>
                    <bedrock-pubsub event-name="grid-edit-item" handler="_onGridEdit" target-id="grid"></bedrock-pubsub>
                    </template>
                </div>
                <div class="action-container" hidden="[[!isEditMode]]">
                    <pebble-button class="pageRange btn btn-secondary" button-text="Cancel" on-tap="_cancelAction" noink raised></pebble-button>
                    <pebble-button class="pageRange btn btn-secondary" button-text="Save" on-tap="_saveAction" noink raised></pebble-button>
                </div>
            </div>
            <liquid-entity-data-save name="attributeSaveDataService" operation="update" last-response="{{saveResponse}}" on-response="_onSaveResponse"></liquid-entity-data-save>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({

                is: 'rock-entity-variant',

                properties: {
                    /**
                     * Indicates the identification of the entity for which the variants are shown.
                     */
                    entityId: {
                        type: String
                    },
                    /**
                     * Indicates the identification of the entity type for which the variants are shown.
                     */
                    entityType: {
                        type: String
                    },
                    /**
                     * Indicates the locale dimension for which the attributes are managed.
                     */
                    locale: {
                        type: String
                    },
                    /**
                     * Indictaes the list for which the attributes are managed.
                     */
                    list: {
                        type: String
                    },
                    /**
                     * Indictaes the classification for which the attributes are managed.
                     */
                    classification: {
                        type: String,
                        value: "_ALL"
                    },
                    /**
                     * Indictaes the source dimension for which the attributes are managed.
                     */
                    source: {
                        type: String
                    },
                    /**
                     * Indicates tree data in the array form.
                     */
                    treeData: {
                        type: Array,
                        value: function () { return []; }
                    },
                    /**
                     * Indicates the data for tree which we get from the liquid component.
                     */
                    remoteTreeData: {
                        type: Object,
                        value: function () { return {}; },
                        observer: '_populateDataForTree'

                    },
                    /**
                    * Indicates the configuration object that is passed to the grid.
                    */
                    gridConfig: {
                        type: Object,
                        notify: true,
                        computed: "getConfig('rock-entity-variant', '', 'variantGridConfig', 'app-entity-manage')"
                    },
                    /**
                    * Indicates data model object for the grid data.
                    */
                    gridData: {
                        type: Object,
                        notify: true
                    },
                    /**
                     * Indicates the currently indeterminate item lists.
                     */
                    indeterminateItems: {
                        type: Array,
                        value: function () { return []; },
                        notify: true
                    },

                    /**
                     * Indicates the currently selected item list.
                     */
                    selectedItems: {
                        type: Array,
                        notify: true,
                        value: function () { return []; },
                        observer: '_selectedItemsChanged'
                    },
                    /**
                    * Specifies whether entity variants are in edit mode or not.
                    */
                    isEditMode: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    /**
                     * Indicates the request object that is passed to the data element to retrive the attribute model data.
                     */
                    attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates call back function where if user has given any liquid operation and request object to load the data, then
                     * user has to transform the data based on their grid configuration and return an array of records.
                     */
                    dataFormatter: {
                        notify: true,
                        value: function () {
                            return this._getAttributeFormattedData.bind(this);
                        }
                    },

                    variantConfig: {
                        type: Object,
                        computed: "getConfig('rock-entity-variant', '', 'variantDefinitionUI', 'app-entity-manage')"
                    },
                    _configRequest: {
                        type: Object,
                        value: function () {
                            return {
                                "apps": [
                                    "app-entity-manage"
                                ],
                                "tenantId": this.tenantId,
                                "security": {
                                    "user": "user1",
                                    "role": "role1"
                                },
                                "ctx": []
                            };
                        },
                        notify: true
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                observers: [
                    '_onGridConfigChange(gridConfig,entityType)',
                    '_editModeChanged(gridConfig.mode)'
                ],
                listeners: {
                    'tree-node-expanded': '_treeNodeExpanded'
                },
                _getTreeRequest: function () {
                    var req = {
                        "params": {
                            "query": {
                                "ctx": [
                                    {
                                        "classification": this.classification,
                                        "list": this.list
                                    }
                                ],
                                "valCtx": [
                                    { "locale": this.locale, "source": this.source }
                                ],
                                "id": this.entityId,
                                "filters": {
                                    "attributesCriterion": [],
                                    "typesCriterion": [
                                        this.entityType
                                    ]
                                }
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                relationships: [
                                    "isChildOf"
                                ],
                                relatedEntityAttributes: [
                                    "cpimProductName", "name"
                                ]

                            },
                            "options": {
                                "from": 0,
                                "to": 9
                            }
                        }
                    };
                    return req;
                },
                _getDefaultChildDepth: function () {
                    if (this.variantConfig && Object.keys(this.variantConfig).length > 0) {
                        return this.variantConfig.levels.length;
                    }
                },
                _treeNodeExpanded: function (e) {
                    this.parent = e.detail;
                    if (!this.parent.nodeData.children || this.parent.nodeData.children.length == 0) {
                        this._getChildren(e.detail.nodeData.value,e.detail.nodeData.type);
                    }
                },

                _getGridRequest: function () {
                    if (!this.gridConfig) {
                        return;
                    }
                    var req = {
                        "params": {
                            "query": {
                                "ctx": [
                                    {
                                        "classification": this.classification,
                                        "list": this.list
                                    }
                                ],
                                "valCtx": [
                                    { "locale": this.locale, "source": this.source }
                                ],
                                "ids": [],
                                "filters": {
                                    "attributesCriterion": [],
                                    "typesCriterion": []
                                }
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "attributes": []
                            },
                            "options": {
                                "from": 0,
                                "to": 9
                            }
                        }
                    };

                    if (this.selectedItems && this.selectedItems.length > 0) {
                        req.params.query.ids = [];
                        this.selectedItems.forEach(function (item) {
                            req.params.query.ids.push(item.value);
                            req.params.query.filters.typesCriterion.push(item.type);
                        });
                    }
                    if (this.indeterminateItems && this.indeterminateItems.length > 0) {
                        this.indeterminateItems.forEach(function (item) {
                            req.params.query.ids.push(item.value);
                            req.params.query.filters.typesCriterion.push(item.type);
                        });
                    }
                    if (req.params.query.ids.length == 0) {
                        req.params.query.ids = [""];
                    }
                    req.params.fields.attributes=this.gridConfig.dataRequest.attributes;
//                    this.gridConfig.tabular.columns.forEach(function (column) {
//                        req.params.fields.attributes.push(column.name);
//                    });
                    return req;
                },
                _selectedItemsChanged: function () {
                    this.async(function () {
                        if (this.selectedItems && this.gridConfig && !DataHelper.isEmptyObject(this.gridConfig)) {
                            var request = this._getGridRequest();
                            this.gridRequest = request;
                            if (this.$$("#grid")) {
                                this.$$("#grid").reRenderGrid();
                            }
                        }
                    });
                },
                _editModeChanged: function (mode) {
                    if (mode == 'Edit') {
                        this.set('isEditMode', true);
                    } else {
                        this.set('isEditMode', false);
                    }
                },

                _saveAction: function (e) {
                    var entities = [];
                    for (var i = 0; i < this.editableItems.length; i++) {
                        var entity=DataHelper.cloneObject(this.editableItems[i]);
                        delete entity.errors;
                        delete entity.index;
                        var attrs={};
                        for(var key in entity.attributes){
                            delete entity.attributes[key]._originalValue;
                            attrs[key]={"values" : [entity.attributes[key]]};
                        }
                        entity.data={
                            ctxInfo: [{
                                "ctxGroup": {"list":this.list,"classification":this.classification},
                                "attributes": attrs
                            }]
                        };
                        delete entity.attributes;
                        delete entity.entityType;
                        delete entity._rowStatus;
                        entities.push(entity);
                    }
                    var attributeSaveDataService = this.$$('[name="attributeSaveDataService"]');
                    attributeSaveDataService.requestData = { "entities": entities };
                    if (attributeSaveDataService) {
                        attributeSaveDataService.generateRequest();
                    }
                },
                _onSaveResponse: function (e) {
                    this.isEditMode = false;
                    var that = this;
                    this.editableItems.forEach(function (item) {
                        that.$$("#grid").changeRowToViewMode(item.index);
                    });
                },

                _cancelAction: function (e) {
                    this.isEditMode = false;
                    var that = this;
                    this.editableItems.forEach(function (item) {
                        that.$$("#grid").changeRowToViewMode(item.index);
                    });
                    this.$$("#grid").reRenderGrid();
                },
                _onGridEdit: function (e, detail, sender) {
                    if (!this.editableItems) {
                        this.editableItems = [];
                    }
                    this.push('editableItems', detail);
                    this.isEditMode = true;
                },
                _getChildren: function (id, type) {
                    var req = {
                        "params": {
                            "query": {
                                "ctx": [
                                    {
                                        "classification": this.classification,
                                        "list": this.list
                                    }
                                ],
                                "valCtx": [
                                    { "locale": this.locale, "source": this.source }
                                ],
                                "id": id,
                                "filters": {
                                    "attributesCriterion": [],
                                    "typesCriterion": [
                                        type
                                    ]
                                }
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                relationships: [
                                    "isChildOf"
                                ],
                                relatedEntityAttributes: [

                                ]
                            },
                            "options": {
                                "from": 0,
                                "to": 9
                            }
                        }
                    };
                    this.$.getChildrenData.requestData = req;
                    this.$.getChildrenData.generateRequest();
                },
                _getRelatedEntitiesData: function (entity) {
                    var data = [];
                    var dataContext = {
                        "list": this.list,
                        "classification": this.classification,
                        "source": this.source,
                        "time": "now",
                        "locale": this.locale
                    };
                    if (entity && entity.data && entity.data.ctxInfo) {
                        var ctx = DataHelper.prepareCtx(dataContext);
                        var relationshipsList;
                        for (var i = 0; i < entity.data.ctxInfo.length; i++) {
                            var ctxData = entity.data.ctxInfo[i];
                            var compareResult = DataObjectFalcorUtil.compareCtx(ctxData.ctxGroup, ctx);
                            if (compareResult) {
                                relationshipsList = ctxData.relationships;
                                break;
                            }
                        }
                        if (relationshipsList) {
                            var isChildRelationshipEntities = relationshipsList["isChildOf"];
                            if (isChildRelationshipEntities) {
                                isChildRelationshipEntities.forEach(function (relationshipEntity) {
                                    var relatedEntity = {};
                                    if (relationshipEntity.relTo) {
                                        relatedEntity["value"] = relationshipEntity.relTo.id;
                                        //TODO if entity name is present in data text should be entity name and not entity id
                                        relatedEntity["text"] = relationshipEntity.relTo.id;
                                        relatedEntity["type"] = relationshipEntity.relTo.entityInfo.entityType;
                                        data.push(relatedEntity);
                                    }
                                });
                            }
                        }
                    }
                    return data;
                },
                _populateChildrenData: function (e) {
                    var data = [];
                    var respData = e.detail.response;
                    if (respData) {
                        if (respData.content && respData.content.entities) {
                            var entities = respData.content.entities;
                            var entity = entities[0];
                            data = this._getRelatedEntitiesData(entity);
                        }
                    }
                    this.parent.nodeData.children = data;
                    var nodeData = this.parent.nodeData;
                    this.parent.nodeData = [];
                    this.parent.nodeData = nodeData;
                    this.parent.refreshChildList();
                },
                _populateDataForTree: function (respData) {
                    var treeData = [];
                    if (respData) {
                        if (respData.content && respData.content.entities) {
                            var entities = respData.content.entities;
                            var entity = entities[0];
                            var entityId = entity.id;
                            treeData = [{ "text": entityId, "value": entityId,"type": this.entityType, children: [] }];
                            var data = this._getRelatedEntitiesData(entity);
                            treeData[0].children = data;
                        }
                    }
                    this.treeData = treeData;
                    if (treeData.length > 0) {
                        this.push('selectedItems', treeData[0]);
                    }
                },
                _prepareContextGroups: function (lists) {
                    if (lists && lists instanceof Array) {
                        var ctxGroup = [];

                        for (var i = 0; i < lists.length; i++) {
                            var ctxInfoObject = new Object();
                            ctxInfoObject.list = lists[i].value;
                            ctxInfoObject.classification =
                                "_ALL";
                            ctxGroup.push(ctxInfoObject);
                        }

                        return ctxGroup;
                    }
                },
                _prepareValueContextGroups: function (sources, locales) {
                    var valueCtxGroup = [];

                    if (sources && locales && sources instanceof Array && locales instanceof Array) {
                        for (var i = 0; i < sources.length; i++) {
                            for (var j = 0; j < locales.length; j++) {

                                var valueCtxInfoObject = new Object();
                                valueCtxInfoObject.source = sources[i].value;
                                valueCtxInfoObject.locale = locales[j].value;
                                valueCtxGroup.push(valueCtxInfoObject);
                            }
                        }

                        return valueCtxGroup;
                    }
                }, _getAttributeFormattedData: function (data) {
                    if (data && data.content) {
                        var entities = data.content.entities;
                        if (entities) {
                            var dataContext = {
                                "list": this.list,
                                "classification": this.classification,
                                "source": this.source,
                                "time": "now",
                                "locale": this.locale
                            };

                            DataHelper.transformEntitySchemaForGrid(entities, this._attributeModels, dataContext);
                        }
                    }
                    
                    return entities;
                },
                _gridRequestAdded: function () {
                    if (this.gridConfig && this.gridRequest && !DataHelper.isEmptyObject(this.gridRequest)) {
                        return true;
                    }
                    return false;
                },
                _openVariantDialog: function () {
                    this.$$("#bFDialog").sharedData = {
                        "list": this.list,
                        "source": this.source,
                        "locale": this.locale,
                        "entity-id": this.entityId,
                        "entity-type": this.entityType,
                    };
                    this.$$("#bFDialog").open();
                },
                _onGridConfigChange: function () {
                    if (!(this.gridConfig && this.gridConfig.dataRequest)) {
                        return;
                    }
                    var attrNames = this.gridConfig.dataRequest.attributes;
                    var req = {
                        "params": {
                            "query": {
                                "ctx": [
                                    {
                                        "list": this.list,
                                        "classification": this.classification
                                    }
                                ],
                                filters:{
                                    "typesCriterion":[this.entityType]
                                },
                                "locale": this.locale,
                                "name": this.entityType
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "attributes": attrNames
                            }
                        }
                    };
                    this.set("attributeModelRequest", req);
                    var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                    if (liquidModelGet) {
                        liquidModelGet.generateRequest();
                    }
                },
                _onCompositeModelGetResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        var ctx = {
                            "list": this.list,
                            "classification": this.classification
                        };
                        this._attributeModels = DataHelper.transformAttributeModelsToUIFormat(e.detail.response.content.entityModels[0], ctx);
                    }
                }
            })
        })();
    </script>
</dom-module>