<link rel="import" href="../../../bower_components/polymer/polymer.html">


<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">


<!--
`<rock-entity-todo>` Represents an element that displays the list of "to-do" items for an entity.

### Example

    <template is="dom-bind">
        <iron-ajax url="entities.json" last-response="{{response}}" auto></iron-ajax>
		<rock-entity-todo entities="{{response}}"></rock-entity-todo>                
	</template>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--entity-todo-icon-outer` | Mixin applied to icon outer circle | {}
`--entity-todo-container` | Mixin applied to entity item container | {}
`--entity-todo-content` | Mixin applied to entity item content | {}
`--entity-todo-icon-width` | The width of icon | ``
`--entity-todo-icon-height` | The height of icon | ``

@group rock Elements
@element rock-entity-todo
@demo demo/index.html
-->

<dom-module id="rock-entity-todo">
    <template>
            <style include="bedrock-style-common bedrock-styles-scroll-bar">
                .container {
                    @apply --layout-horizontal;
                    align-items: center;
                    -webkit-align-items: center;
                    /* Safari 7.0+ */
                    max-height: 250px;
                    padding: 2px 0px;
                    cursor: pointer;
                    @apply --entity-todo-container;
                    position: relative;
                }

                .entity-icon-outer {
                    @apply --layout;
                    @apply --layout-center-center;
                    @apply --paper-font-common-base;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    margin-right: 10px;
                    @apply --entity-todo-icon-outer;
                }

                .entity-content {
                    align-self: flex-center;
                    -webkit-align-self: flex-center;
                    @apply --entity-todo-content;
                    font-size: 12px !important;
                    color: var(--dark-title-color, #1a2028);
                }

                .entity-content:hover {
                    color: var(--focused-line, #026bc3);
                }

                .container:hover {
                    color: var(--focused-line, #026bc3);
                    background-color: var(--bgColor-hover, #e8f4f9);
                }

                .container:hover::before {
                    position: absolute;
                    content: '';
                    top: 0;
                    width: 20px;
                    bottom: 0;
                    left: -20px;
                    background-color: var(--bgColor-hover, #e8f4f9);
                }

                .container:hover::after {
                    position: absolute;
                    content: '';
                    top: 0;
                    width: 20px;
                    bottom: 0;
                    right: -20px;
                    background-color: var(--bgColor-hover, #e8f4f9);
                }

                .todo-data-container {
                    min-height: 120px;
                    max-height: 100%;
                    overflow-x: hidden;
                    overflow-y: auto;
                    position: relative;
                }
            </style>
        <div class="todo-data-container">
            <div hidden$="[[_isTodosAvailable(todos)]]">No todos available for this entity</div>
            <template is="dom-repeat" items="[[todos]]">
                <div class="container" id="[[_getId(item.data.name, index)]]" data="[[item.data]]" on-tap="_onTap">
                    <div class="entity-icon-outer">
                        <pebble-icon icon="[[_setIcon(item.icon.name)]]" class="pebble-icon-size-30"></pebble-icon>
                    </div>
                    <div class="entity-content">
                        [[item.data.label]]
                    </div>
                </div>
                [[_applyStyle(item, index)]]
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'rock-entity-todo',

            properties: {

                /**
                *  Indicates the list of entities in the "JSON" format.
                */
                data: {
                    type: Object,
                    notify: true,
                    value: function () { return {}; }
                },

                _defaultIcon: {
                    type: String,
                    value: "pebble-icon:channel-filled"
                },

                contextData: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    observer: "_onContextDataChange"
                },

                todos: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentConfigBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],

            _onContextDataChange: function() {
                if(!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData); 

                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if (appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }

                    // if there are multiple context combinations selected, config cannot be 
                    // fetched for multiple contexts. At a time only for one context.
                    // Showing self level mapped when there are multiple context combinations.
                    var dataContexts = ContextHelper.getDataContexts(context);

                    if(dataContexts && dataContexts.length > 1) {
                        context[ContextHelper.CONTEXT_TYPE_DATA] = [];
                    }
                    
                    this.requestConfig('rock-entity-todo', context);
                }
            },

            onConfigLoaded: function(componentConfig) {
                if(componentConfig && componentConfig.config && componentConfig.config.todos) {
                    this.todos = DataHelper.convertObjectToArray(componentConfig.config.todos);
                }
            },

            _isTodosAvailable: function() {
                if(!this.todos || this.todos.length == 0) {
                    return false;
                }

                return true;
            },

            /**
             * Can be used to raise on-tap events as per the configuration.
             */
            _onTap: function (e) {
                
                if(this._getWritePermission() === false) {
                    this.showWarningToast("You do not have permissions to perform this action.");
                    return;
                }
                var eventDetail = {
                    name: e.currentTarget.data.eventName,
                    data: e.currentTarget.data
                }

                this.dispatchEvent(new CustomEvent('bedrock-event', {detail:eventDetail,bubbles:true,composed:true}));
            },

            _getId: function (name, index) {
                return name + '_' + index;
            },

            _applyStyle: function (item, index) {
                if(!item.icon) {
                    return;
                }
                setTimeout(() =>{
                    var container = this.shadowRoot.querySelector('#' + this._getId(item.data.name, index));
                    if(container) {
                        var outerdiv = container.querySelector('.entity-icon-outer');
                        var icon = container.querySelector('pebble-icon');

                        outerdiv.style['background-color'] = item.icon.backgroundColor;
                        icon.style['color'] = item.icon.stroke;
                        icon.style['background-color'] = item.icon.fill;
                    }
                }, 150); //Delayed to capture dom elements
            },

            _setIcon: function(icon) {
                if(!icon) {
                    return this._defaultIcon;
                }

                return icon;
            },

            _getWritePermission: function () {
                var writePermission = true;
                var itemContext = this.getFirstItemContext();
                if(DataHelper.isValidObjectPath(itemContext, "permissionContext.writePermission")) {
                    writePermission = itemContext.permissionContext.writePermission;
                }

                return writePermission;
            }
        });
    </script>
</dom-module>
