<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">


<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/liquid-response-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">


<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">

<link rel="import" href="../rock-assets-search-grid/assets-search-grid-datasource.html">


<!--
 `rock-asset-manage` Represents an element that manages all the assets linked to an entity.
 @demo demo/index.html
-->
<dom-module id="rock-asset-manage">
    <template>
        <style include="bedrock-style-common">
             :host {
                padding: 20px;
                display: block;
            }
            
            #messageCard {
                text-align: center;
            }

            .asset-name-container {
                clear: left;
                @apply --layout-horizontal;
                padding: 10px 0 0;
                flex-direction: row-reverse !important;
                border-radius: 3px;
                margin: 2px 0px 0 0px;
                flex-direction: row-reverse !important;
                -webkit-flex-direction: row-reverse !important;
            }
        </style>
        <template is="dom-repeat" items="{{assetTypeList}}" as="asset" index-as="colIndex" notify-dom-change>
            <div id="assetContainer_[[asset]]">
                <pebble-accordion header-text="[[_getAssetTypeTitle(asset)]]" default-icon="pebble-icon:RightArrow" open-icon="pebble-icon:Expand">
                    <div class="asset-name-container">
                        <pebble-button icon="pebble-icon:Add" asset="[[asset]]" class="btn btn-primary m-r-20" button-text="Add" on-click="_onAddAssetClick"></pebble-button>
                    </div>
                    <liquid-entity-data-get auto id="datasource_[[asset]]" operation="getbyids" request-data="[[_getAssetGridRequest(asset)]]"
                        on-response="_populateDataForGrid" exclude-in-progress></liquid-entity-data-get>
                    <rock-grid id$="grid_[[asset]]" config="{{_getAssetGridConfig(asset)}}" page-size="10"></rock-grid>
                    <bedrock-pubsub event-name="refresh-grid" handler="_onRefreshAssetGridEvent" target-id="grid_[[asset]]"></bedrock-pubsub>
                    <liquid-rest id="getThumbnail_[[asset]]" asset="[[asset]]" url="/data/pass-through/binaryobjectservice/get" method="POST"
                        on-liquid-response="_onGetThumbnailResponse">
                    </liquid-rest>
                    <bedrock-pubsub event-name="grid-custom-toolbar-event" handler="_onCustomToolbarEvent" target-id="grid_[[asset]]"></bedrock-pubsub>
                    <bedrock-pubsub event-name="download-original-asset" handler="_onOriginalAssetDownloadAction"></bedrock-pubsub>
                    <bedrock-pubsub event-name="delete-asset-relationship" handler="_onDeleteAssetRelationshipAction"></bedrock-pubsub>
                </pebble-accordion>
            </div>
        </template>
        <bedrock-pubsub event-name="refresh-relationship-grid" handler="_onRefreshRelationshipGridEvent" target-id="assetDialog"></bedrock-pubsub>
        <div id="messageCard"> {{_message}}</div>
        <liquid-rest id="getDownloadUrl" url="/data/pass-through/binarystreamobjectservice/prepareDownload" method="POST" on-liquid-response="_onGetDownloadUrlResponse">
        </liquid-rest>
        <liquid-entity-data-save id="entitySaveService" request-data="[[_saveRequest]]" last-response="{{_saveResponse}}" on-response="_onSaveResponse"
            on-error="_onSaveError">
        </liquid-entity-data-save>
    </template>
    <script>
        Polymer({
            is: 'rock-asset-manage',
            properties: {
                /**
                 *  Indicates the context data.
                 */
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                configContext: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _assetConfig: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                assetTypeList: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _message: {
                    type: String,
                    value: ""
                },
                noThumbnailPath: {
                    type: String,
                    value: "/src/images/no-thumbnail.svg"
                },
                loadingThumbnailPath: {
                    type: String,
                    value: "/src/images/loading-thumbnail.svg"
                },
                _entityRelations: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _relationshipType: {
                    type: String,
                    value: null
                }
            },
            observers: [
                '_assetsConfigChanged(assetsGridConfigs,contextData,configContext)'
            ],
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],
            created() {
                this._onRelationshipModelGetResponse = this._onRelationshipModelGetResponse.bind(this);
                this._onRelatedEntityAttributeModelGetResponse = this._onRelatedEntityAttributeModelGetResponse.bind(this);
            },
            /**
              * <b><i>Content development is under progress... </b></i> 
              */
            ready: function () {
                this.assetsGridConfigs = this.getParentAppConfig('rock-asset-manage', '', 'assetsGridConfigs');
            },
            _getAssetTypeTitle: function (asset) {
                if (asset) {
                    var config = this.assetsGridConfigs[asset];
                    if (config && config.title && config.title != "") {
                        return config.title;
                    }
                }
                return asset;
            },
            _assetsConfigChanged: function (assetsGridConfigs, contextData, configContext) {
                if (!(assetsGridConfigs === undefined || contextData === undefined || configContext === undefined)) {
                    this._message = "";
                    if (_.isEmpty(this.contextData) || _.isEmpty(this.configContext)) {
                        return;
                    }
                    this._prepareRequest();
                    if (this.assetsGridConfigs && Object.keys(this.assetsGridConfigs).length) {
                        this._assets = Object.keys(this.assetsGridConfigs);
                        var assetTypeName = this.configContext.relationshipTypeName;
                        if (assetTypeName == "Assets") {
                            this._assetTypeList = this._assets;
                        } else {
                            this._assetTypeList = [assetTypeName];
                            if (!this.assetsGridConfigs.hasOwnProperty(assetTypeName)) {
                                var assetTitle = this.configContext.relationshipTitle;
                                if (!assetTitle) {
                                    assetTitle = assetTypeName;
                                }
                                this._message = "Configuration for asset type: " + assetTitle + " not present";
                                return;
                            }
                        }
                        this._counter = this._assetTypeList.length;
                        var liquidElement = document.createElement("liquid-entity-model-composite-get");
                        liquidElement.addEventListener("entity-model-composite-get-response", this._onRelationshipModelGetResponse);
                        
                        Object.keys(this.assetsGridConfigs).forEach(function (assetType) {
                            if (assetType && this._assetTypeList.indexOf(assetType) > -1) {
                                var gridConfig = this.assetsGridConfigs[assetType].gridConfig;
                                var fieldDetails;
                                var relatedEntityAttributes = [];
                                var relationshipAttributes = [];
                                if (gridConfig.viewMode == "Tile") {
                                    fieldDetails = gridConfig.tile.tileItems;
                                } else if (gridConfig.viewMode == "List") {
                                    fieldDetails = gridConfig.list.listItems;
                                }
                                relatedEntityAttributes.push(fieldDetails.image);
                                relatedEntityAttributes.push(fieldDetails.title);
                                relatedEntityAttributes.push(fieldDetails.subtitle);
                                relatedEntityAttributes.push(fieldDetails.id);
                                relatedEntityAttributes.push("thumbnailid");
                                relatedEntityAttributes.push("property_objectkey");
                                var fields = fieldDetails.fields;
                                for (var i = 0; i < fields.length; i++) {
                                    if (fields[i].isRelationshipAttribute) {
                                        relationshipAttributes.push(fields[i].name);
                                    } else {
                                        relatedEntityAttributes.push(fields[i].name);
                                    }
                                }
                                if (!this._relationshipTypeAndAttributes) {
                                    this._relationshipTypeAndAttributes = {};
                                }
                                this._relationshipTypeAndAttributes[assetType] = {
                                    'relationshipAttributes': relationshipAttributes,
                                    'relatedEntityAttributes': relatedEntityAttributes
                                }
                                this._assetConfig[assetType] = {};
                                this._assetConfig[assetType].gridConfig = this.assetsGridConfigs[assetType].gridConfig;
                                this._initiateRelationshipModelRequest(liquidElement, assetType, relationshipAttributes);
                            }
                        }, this);
                    } else {
                        this._message = "Assets are not configured for current entity type: " + this.entityType;
                    }
                }
            },
            _prepareRequest: function () {
                this._entityGetReq = DataRequestHelper.createEntityGetRequest(this.contextData);
            },
            _initiateRelationshipModelRequest: function (liquidElement, relationshipType, relationshipAttributes) {
                liquidElement.name = relationshipType;

                var itemContext = this.getFirstItemContext();

                itemContext.attributeNames = [];
                itemContext.relationships = [relationshipType];
                itemContext.relationshipAttributes = relationshipAttributes;

                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                liquidElement.requestData = compositeModelGetRequest;
                liquidElement.generateRequest();
            },
            _onRelationshipModelGetResponse: function (e) {
                if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                    var relType = "";
                    if (e.detail.request) {
                        relType = e.detail.request.requestData.params.fields.relationships[0];
                    }
                    var compositeModel = e.detail.response.content.entityModels[0];

                    if (relType && compositeModel && compositeModel.data) {
                        var relationships = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);

                        if (relationships && relationships[relType]) {
                            var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;

                            if (rel) {
                                if (this._assetConfig[relType]) {
                                    this._assetConfig[relType].selfContext = relationships[relType].selfContext;
                                    this._assetConfig[relType].relatedEntityModel = {};
                                    this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                    this._assetConfig[relType].relationshipAttributeModels = {};
                                }

                                var relatedEntityInfo = [];

                                if (rel.properties && Object.keys(rel.properties).length) {
                                    relatedEntityInfo = rel.properties.relatedEntityInfo;
                                    if (relatedEntityInfo && relatedEntityInfo.length) {
                                        this._assetConfig[relType].relatedEntityModel.relatedEntityContexts = relatedEntityInfo;
                                        var relEntityTypes = relatedEntityInfo.map(function (relContext) {
                                            if (relContext.relEntityType) {
                                                return relContext.relEntityType;
                                            }
                                        });
                                        this._assetConfig[relType].relatedEntityTypes = relEntityTypes;
                                    }

                                    if (rel.attributes) {
                                        var relData = {};
                                        relData.data = {};
                                        relData.data.attributes = rel.attributes;

                                        this._assetConfig[relType].relationshipAttributeModels = DataTransformHelper.transformAttributeModels(relData, this.contextData);
                                    }

                                    if (this._relationshipTypeAndAttributes[relType]) {
                                        var relatedEntityAttributes = this._relationshipTypeAndAttributes[relType].relatedEntityAttributes;

                                        if (relatedEntityAttributes && relatedEntityAttributes.length) {
                                            //Initiate attr model get
                                            this._initiateAttributeModelRequest(relType, relatedEntityInfo, relatedEntityAttributes);
                                        } else {
                                            this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                            this._counter--;
                                            if (this._counter == 0) {
                                                this.assetTypeList = this._assetTypeList;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        this._counter--;
                        if (this._counter == 0) {
                            this.assetTypeList = this._assetTypeList;
                        }
                    }
                }
            },
            _initiateAttributeModelRequest: function (relationshipType, relatedEntityContexts, relatedEntityAttributes) {
                var liquidElement = document.createElement("liquid-entity-model-composite-get");
                liquidElement.name = relationshipType;

                var ids = [];

                var typesCriterion = [];
                var contexts = [];
                var valContext = this.getFirstValueContext();
                if (!valContext) {
                    return;
                }
                if (relatedEntityContexts) {
                    relatedEntityContexts.forEach(function (relContext) {
                        if (relContext) {
                            ids.push(relContext.relEntityType + "_entityCompositeModel");
                            if (relContext.relContexts) {
                                relContext.relContexts.forEach(function (ctxItem) {
                                    contexts.push(ctxItem);
                                }, this);
                            }
                        }
                    }, this);
                }

                var req = {
                    "params": {
                        "query": {
                            "contexts": contexts,
                            "locale": valContext.locale,
                            "ids": ids
                        },
                        "fields": {
                            "ctxTypes": [
                                "properties"
                            ],
                            "attributes": relatedEntityAttributes
                        }
                    }
                };

                liquidElement.requestData = req;
                liquidElement.addEventListener("entity-model-composite-get-response", this._onRelatedEntityAttributeModelGetResponse);
                liquidElement.generateRequest();
            },
            _onRelatedEntityAttributeModelGetResponse: function (e) {
                if (!this._typeThumbnailMapping) {
                    this._typeThumbnailMapping = {};
                }
                var relType = e.currentTarget.name;
                if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                    var compositeModel = e.detail.response.content.entityModels[0];
                    var attributeModels = DataTransformHelper.transformAttributeModels(compositeModel, this.contextData);
                    var properties = compositeModel.properties;
                    if (properties.hasOwnProperty("defaultThumbnailId")) {
                        this._typeThumbnailMapping[compositeModel.name] = properties.defaultThumbnailId;
                    }
                    if (relType) {
                        if (this._assetConfig[relType] && attributeModels) {
                            this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = attributeModels;
                        } else {
                            this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                        }
                    }
                }
                this._counter--;
                if (this._counter == 0) {
                    this.assetTypeList = this._assetTypeList;
                }
            },
            _getAssetGridConfig: function (relationshipTypeName) {
                var gridConfig;
                if (this._assetConfig[relationshipTypeName]) {
                    gridConfig = this._assetConfig[relationshipTypeName].gridConfig
                }
                return gridConfig;
            },
            _getAssetGridRequest: function (relationshipTypeName) {
                var req = DataHelper.cloneObject(this._entityGetReq);

                if (req && relationshipTypeName) {
                    var relAttr;
                    if (this._relationshipTypeAndAttributes) {
                        relAttr = this._relationshipTypeAndAttributes[relationshipTypeName];
                    }
                    if (relAttr) {
                        req.params.fields.relationshipAttributes = relAttr.relationshipAttributes;
                        req.params.fields.relatedEntityAttributes = relAttr.relatedEntityAttributes;
                    }
                    req.params.fields.relationships = [relationshipTypeName];
                }
                return req;
            },
            _getRelationshipAttributeModels: function (relationshipTypeName) {
                if (!this._assetConfig) {
                    return {};
                }
                var config = this._assetConfig[relationshipTypeName];
                if (config) {
                    return config.relationshipAttributeModels;
                }
                return {};
            },
            _getRelatedEntityAttributeModels: function (relationshipTypeName) {
                if (!this._assetConfig) {
                    return {};
                }
                var config = this._assetConfig[relationshipTypeName];
                if (config && config.relatedEntityModel) {
                    return config.relatedEntityModel.relatedEntityAttributeModels;
                }
                return {};
            },
            _populateDataForGrid: function (event) {
                var respData = event.detail.response;
                var currentRel = "";
                if (event.detail.request) {
                    currentRel = event.detail.request.requestData.params.fields.relationships[0];
                }
                var relationshipAttributeModels = this._getRelationshipAttributeModels(currentRel);
                var relatedEntityAttributeModels = this._getRelatedEntityAttributeModels(currentRel);

                var data = [];
                if (respData) {
                    if (respData.content && respData.content.entities) {
                        var entities = respData.content.entities;
                        if (entities && entities.length > 0) {
                            var entityId = entities[0].id;
                            if (entityId) {
                                var entity = entities[0];
                                var isSelfContext = true;
                                var relConfig = this._assetConfig[currentRel];
                                if (relConfig && relConfig.hasOwnProperty("selfContext")) {
                                    isSelfContext = relConfig.selfContext;
                                }
                                var relationships = EntityHelper.getRelationshipsBasedOnContext(entity, this.getFirstDataContext(), isSelfContext);
                                if (!_.isEmpty(relationships)) {
                                    this._entityRelations[currentRel] = relationships[currentRel];
                                    this._entityRelations[currentRel].forEach(function (relItem) {
                                        if (relItem) {
                                            var record = {};
                                            if (relItem.attributes) {
                                                Object.keys(relItem.attributes).forEach(function (item) {
                                                    if (item && relItem.attributes[item]) {
                                                        var value = relItem.attributes[item].values[0].value;
                                                        record[item] = this._formatValue(relationshipAttributeModels, item, value);
                                                    }
                                                }, this);
                                            }
                                            if (relItem.relTo) {
                                                record["Related Entity"] = record["id"] = relItem.relTo.id;
                                                record["type"] = relItem.relTo.type;

                                                if (relItem.relTo.data) {
                                                    //var relCtxList = relContexts[item];
                                                    var relatedAttributes = EntityHelper.getAllAttributes(relItem.relTo);
                                                    if (relatedAttributes) {
                                                        Object.keys(relatedAttributes).forEach(function (
                                                            attrItem) {
                                                            if (attrItem && relatedAttributes[attrItem]) {
                                                                var value = relatedAttributes[attrItem].values[0].value;
                                                                record[attrItem] = this._formatValue(relatedEntityAttributeModels, attrItem, value);
                                                            }
                                                        }, this);
                                                    }
                                                }
                                            }
                                            if (!record.thumbnailid) {
                                                record.thumbnailid = this._typeThumbnailMapping[record.type];
                                            }

                                            if (record.thumbnailid) {
                                                record.thumbnail = this.loadingThumbnailPath;
                                            } else {
                                                record.thumbnail = this.noThumbnailPath;
                                            }
                                            data.push(record);
                                        }
                                    }, this);
                                }
                            }
                        }
                    }
                }
                var grid = this.shadowRoot.querySelector("#grid_" + currentRel);
                grid.data = data;
            },
            _formatValue: function (models, item, value) {
                if (!models) {
                    return value;
                }
                var model = models[item];
                if (model &&
                    model.dataType &&
                    (model.dataType.toLowerCase() == "date" ||
                        model.dataType.toLowerCase() == "datetime")) {
                    return FormatHelper.convertFromISODateTime(value, model.dataType, model.dateFormat);
                }

                return value;
            },
            _onAddAssetClick: function (e) {
                var asset = e.currentTarget.asset;
                const { relatedEntityTypes, selfContext } = this._assetConfig[asset].relatedEntityTypes;
                const {id , type} = ContextHelper.getFirstItemContext(this.contextData);
                
                const sharedData = {
                    "title": this._getAssetTypeTitle(asset),
                    "mode": "asset",
                    "types-criterion": relatedEntityTypes,
                    "relationship-type": asset,
                    "selected-entities": [{id, type}],
                    "self-context": selfContext
                };

                this.openBusinessFunctionDialog({name: 'rock-relationship-add'}, sharedData);
            },
            _onRefreshAssetGridEvent: function (e, detail) {
                var targetId = detail.id;
                var grid = this.shadowRoot.querySelector("#" + targetId);
                grid.data = [];
                var assetName = targetId.replace("grid_", "");
                this._refreshGridByAssetName(assetName);
            },
            _onRefreshRelationshipGridEvent: function (e, detail) {
                this.fireBedrockEvent("refresh-entity-thumbnail", {}, { "ignoreId": true });
                var assetName = detail.relationshipType;
                var grid = this.shadowRoot.querySelector("#grid_" + assetName);
                grid.data = [];
                this._refreshGridByAssetName(assetName);
            },
            _refreshGridByAssetName: function (assetName) {
                var targetId = "datasource_" + assetName;
                var liq = this.shadowRoot.querySelector("#" + targetId);
                if (liq) {
                    liq.generateRequest();
                }
            },
            //Download asset functions
            _onOriginalAssetDownloadAction: function (e, detail) {
                if (detail) {
                    var fileName = detail.property_objectkey;
                    if (fileName) {
                        var req = {
                            "binaryStreamObject": {
                                "id": fileName,
                                "type": "binarystreamobject",
                                "data": {}
                            }
                        };
                        var downloadUrlLiquid = this.shadowRoot.querySelector("#getDownloadUrl");
                        if (downloadUrlLiquid) {
                            downloadUrlLiquid.requestData = req;
                            downloadUrlLiquid.generateRequest();
                        }
                    }
                }
            },
            _onDeleteAssetRelationshipAction: function (e, detail) {
                var updateRequest = DataRequestHelper.generateRelationshipProcessRequest(this.contextData);
                this._relationshipType = this.configContext.relationshipTypeName;

                if (!this._entityRelations || _.isEmpty(this._entityRelations)) {
                    return;
                }

                var relDelItem;
                var relationsByType = this._entityRelations[this._relationshipType];
                //RelationshipType available when child item is selected in tab
                if (relationsByType) {
                    if (relationsByType.length > 0) {
                        for (var i = 0; i < relationsByType.length; i++) {
                            if (relationsByType[i].relTo.id == detail.id) {
                                relDelItem = relationsByType[i];
                                break;
                            }
                        }
                    }
                }
                else { //When root tab is selected
                    var isRelFound = false;
                    for (var key in this._entityRelations) {
                        this._relationshipType = key;
                        relationsByType = this._entityRelations[this._relationshipType];
                        if (relationsByType.length > 0) {
                            for (var i = 0; i < relationsByType.length; i++) {
                                if (relationsByType[i].relTo.id == detail.id) {
                                    relDelItem = relationsByType[i];
                                    isRelFound = true;
                                    break;
                                }
                            }
                        }

                        if (isRelFound) {
                            break;
                        }
                    }
                }

                if (relDelItem && !_.isEmpty(relDelItem) && this._relationshipType) {
                    relDelItem.action = "delete"; //Set delete
                    updateRequest.data.relationships[this._relationshipType] = [relDelItem];

                    this._saveRequest = {
                        "entities": [updateRequest]
                    };

                    var entitySaveLiquid = this.shadowRoot.querySelector("#entitySaveService");
                    if (entitySaveLiquid) {
                        entitySaveLiquid.operation = "update";
                        entitySaveLiquid.generateRequest();
                    }
                }
            },

            _onSaveResponse: function (e, detail) {
                var grid = this.shadowRoot.querySelector("#grid_" + this._relationshipType);

                if (grid) {
                    grid.data = [];
                    this._refreshGridByAssetName(this._relationshipType);
                    this._relationshipType = null; //reset
                }
            },

            _onSaveError: function (e, detail) {
                this.showErrorToast("Unable to delete the asset relationship, please contact administrator.");
            },

            _onCustomToolbarEvent: function (e, detail) {
                if (detail && detail.name == "originalAssetDownload") {
                    this._originalAssetsDownload();
                }
            },
            _originalAssetsDownload: function () {
                var rockGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid');
                var selectedItems = rockGrid.getSelectedItems();
                var filenames = [];
                if (selectedItems && selectedItems.length) {
                    if (selectedItems.length > 5) {
                        this.showInformationToast("Simultaneous download of maximum 5 assets are allowed.");
                    }
                    selectedItems.forEach(function (item) {
                        if (item && item.property_objectkey) {
                            filenames.push(item.property_objectkey)
                        }
                    }, this);
                    var req = {
                        "binaryStreamObject": {
                            "ids": filenames,
                            "type": "binarystreamobject",
                            "data": {}
                        }
                    };
                    var downloadUrlLiquid = this.shadowRoot.querySelector("#getDownloadUrl");
                    if (downloadUrlLiquid) {
                        downloadUrlLiquid.requestData = req;
                        downloadUrlLiquid.generateRequest();
                    }
                } else {
                    this.showInformationToast("Please select at least one asset from grid to download.");
                }
            },
            _onGetDownloadUrlResponse: function (e) {
                const a = document.createElement('a');
                a.download = "";
                
                LiquidResponseHelper.downloadURLResponseMapper(e, downloadURL => {
                    a.href = downloadURL;
                    a.click();
                });
            }
        });
    </script>
</dom-module>