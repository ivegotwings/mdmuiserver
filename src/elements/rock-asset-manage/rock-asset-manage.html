<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../rock-assets-search-grid/assets-search-grid-datasource.html">
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<!--
 `rock-asset-manage` Manage all the assets linked to an entity
-->
<dom-module id="rock-asset-manage">
    <template>
        <style  include="pebble-styles-shared">
            :host{
                padding: 20px;
                display: block;
            }
            :host::shadow #assetContainer_hasimages pebble-accordion rock-grid::shadow grid-tile-view::shadow .item-container{
                width: calc(25% - 20px);
                min-height: 302px;
            }
            #messageCard {
                text-align: center;
            }
            .asset-name-container {
                clear: left;
                @apply(--layout-horizontal);
                padding: 10px 0 0;
                flex-direction: row-reverse !important;
                border-radius: 3px;
                margin: 2px 0px 0 0px;
                flex-direction: row-reverse !important;
                -webkit-flex-direction: row-reverse !important;
            }
        </style>
        <template is="dom-repeat" items="{{assetTypeList}}" as="asset" index-as="colIndex" notify-dom-change>
                <div id="assetContainer_[[asset]]">
                    <pebble-accordion header-text="[[_getAssetTypeTitle(asset)]]" default-icon="expand-less" open-icon="expand-more">
                        <div class="asset-name-container">
                            <pebble-button icon="pebble-sm-icons:Add" asset="[[asset]]" class="btn btn-primary m-r-20" button-text="Add"
                                           on-click="_onAddAssetClick"></pebble-button>
                        </div>
                        <liquid-entity-data-get auto id="datasource_[[asset]]" operation="getbyids" request-data="[[_getAssetGridRequest(asset)]]"   on-response="_populateDataForGrid"
                                                exclude-in-progress></liquid-entity-data-get>
                        <rock-grid id$="grid_[[asset]]" config="{{_getAssetGridConfig(asset)}}" page-size="10"></rock-grid>
                        <bedrock-pubsub event-name="refresh-grid" handler="_onRefreshAssetGridEvent" target-id="grid_[[asset]]"></bedrock-pubsub>
                        <liquid-rest id="getThumbnail_[[asset]]" asset="[[asset]]" url="/pass-through/binaryobjectservice/get" method="POST"  on-liquid-response="_onGetThumbnailResponse">
                        </liquid-rest>
                        <bedrock-pubsub event-name="grid-custom-toolbar-event" handler="_onCustomToolbarEvent" target-id="grid_[[asset]]"></bedrock-pubsub>
                        <bedrock-pubsub event-name="download-original-asset" handler="_onOriginalAssetDownloadAction" ></bedrock-pubsub>
                    </pebble-accordion>
                </div>
        </template>
        <rock-business-function-dialog id="assetDialog" name="rock-relationship-add"></rock-business-function-dialog>
        <bedrock-pubsub event-name="refresh-relationship-grid" handler="_onRefreshRelationshipGridEvent" target-id="assetDialog"></bedrock-pubsub>
        <div id="messageCard"> {{_message}}</div>
        <liquid-rest id="getDownloadUrl" url="/pass-through/binarystreamobjectservice/prepareDownload" method="POST"  on-liquid-response="_onGetDownloadUrlResponse">
        </liquid-rest>
    </template>
    <script>
        Polymer({
                is: 'rock-asset-manage',
                properties: {
                    /*
                     *  Indicates context data
                     */
                    contextData: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    configContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _assetConfig:{
                        type:Object,
                        value:function () {
                            return {};
                        }
                    },
                    assetTypeList:{
                        type:Array,
                        value: function () {
                            return [];
                        }
                    },
                    _message:{
                        type:String,
                        value:""
                    }
                },
                observers: [
                    '_assetsConfigChanged(assetsGridConfigs,contextData,configContext)'
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                ready:function () {
                    this.assetsGridConfigs = this.getParentAppConfig('rock-asset-manage', '', 'assetsGridConfigs');
                },
            _getAssetTypeTitle: function (asset) {
                if (asset) {
                    var config = this.assetsGridConfigs[asset];
                    if (config && config.title && config.title != "") {
                        return config.title;
                    }
                }
                return asset;
            },
            _assetsConfigChanged: function () {
                    this._message="";
                    if(_.isEmpty(this.contextData) || _.isEmpty(this.configContext)){
                        return;
                    }
                this._prepareRequest();
                if (this.assetsGridConfigs && Object.keys(this.assetsGridConfigs).length) {
                    this._assets = Object.keys(this.assetsGridConfigs);
                    var assetTypeName=this.configContext.relationshipTypeName;
                    if (assetTypeName=="Assets") {
                        this._assetTypeList = this._assets;
                    } else {
                        this._assetTypeList = [assetTypeName];
                        if(!this.assetsGridConfigs.hasOwnProperty(assetTypeName)){
                            var assetTitle=this.configContext.relationshipTitle;
                            if(!assetTitle){
                                assetTitle=assetTypeName;
                            }
                            this._message="Configuration for asset type: "+assetTitle+" not present";
                            return;
                        }
                    }
                    this._counter=this._assetTypeList.length;
                    Object.keys(this.assetsGridConfigs).forEach(function (assetType) {
                        if (assetType && this._assetTypeList.indexOf(assetType)>-1) {
                            var gridConfig = this.assetsGridConfigs[assetType].gridConfig;
                            var fieldDetails;
                            var relatedEntityAttributes = [];
                            var relationshipAttributes = [];
                            if (gridConfig.viewMode == "Tile") {
                                fieldDetails = gridConfig.tile.tileItems;
                            } else if (gridConfig.viewMode == "List") {
                                fieldDetails = gridConfig.list.listItems;
                            }
                            relatedEntityAttributes.push(fieldDetails.image);
                            relatedEntityAttributes.push(fieldDetails.title);
                            relatedEntityAttributes.push(fieldDetails.subtitle);
                            relatedEntityAttributes.push(fieldDetails.id);
                            relatedEntityAttributes.push("thumbnailid");
                            relatedEntityAttributes.push("property_objectkey");
                            var fields = fieldDetails.fields;
                            for (var i = 0; i < fields.length; i++) {
                                if(fields[i].isRelationshipAttribute){
                                    relationshipAttributes.push(fields[i].name);
                                } else {
                                    relatedEntityAttributes.push(fields[i].name);
                                }
                            }
                            if(!this._relationshipTypeAndAttributes){
                                this._relationshipTypeAndAttributes={};
                            }
                            this._relationshipTypeAndAttributes[assetType] = {
                                'relationshipAttributes': relationshipAttributes,
                                'relatedEntityAttributes': relatedEntityAttributes
                            }
                            this._assetConfig[assetType] = {};
                            this._assetConfig[assetType].gridConfig = this.assetsGridConfigs[assetType].gridConfig;
                            this._initiateRelationshipModelRequest(assetType, relationshipAttributes);
                        }
                    }, this);
                } else {
                  this._message = "Assets are not configured for current entity type: " + this.entityType;
                }
            },
            _prepareRequest: function () {
                this._entityGetReq = DataRequestHelper.createEntityGetRequest(this.contextData);
            },
            _initiateRelationshipModelRequest: function (relationshipType, relationshipAttributes) {
                var liquidElement = document.createElement("liquid-entity-model-composite-get");
                liquidElement.name = relationshipType;

                var itemContext = this.getFirstItemContext();

                itemContext.attributeNames = [];
                itemContext.relationships = [relationshipType];
                itemContext.relationshipAttributes = relationshipAttributes;

                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                liquidElement.requestData = compositeModelGetRequest;
                liquidElement.addEventListener("entity-model-composite-get-response", this._onRelationshipModelGetResponse.bind(this));
                liquidElement.generateRequest();
            },
            _onRelationshipModelGetResponse: function (e) {
                if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                    var relType = "";
                    if (e.detail.request) {
                        relType = e.detail.request.requestData.params.fields.relationships[0];
                    }
                    var compositeModel = e.detail.response.content.entityModels[0];

                    if (relType && compositeModel && compositeModel.data) {
                        var relationships = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);

                        if (relationships && relationships[relType]) {
                            var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;

                            if (rel) {
                                if (this._assetConfig[relType]) {
                                    this._assetConfig[relType].selfContext = relationships[relType].selfContext;
                                    this._assetConfig[relType].relatedEntityModel = {};
                                    this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                    this._assetConfig[relType].relationshipAttributeModels = {};
                                }

                                var relatedEntityInfo = [];

                                if (rel.properties && Object.keys(rel.properties).length) {
                                    relatedEntityInfo = rel.properties.relatedEntityInfo;
                                    if (relatedEntityInfo && relatedEntityInfo.length) {
                                        this._assetConfig[relType].relatedEntityModel.relatedEntityContexts = relatedEntityInfo;
                                        var relEntityTypes=relatedEntityInfo.map(function (relContext) {
                                            if(relContext.relEntityType) {
                                                return relContext.relEntityType;
                                            }
                                        });
                                        this._assetConfig[relType].relatedEntityTypes=relEntityTypes;
                                    }

                                    if (rel.attributes) {
                                        var relData = {};
                                        relData.data = {};
                                        relData.data.attributes = rel.attributes;

                                        this._assetConfig[relType].relationshipAttributeModels = DataTransformHelper.transformAttributeModels(relData, this.contextData);;
                                    }

                                    if (this._relationshipTypeAndAttributes[relType]) {
                                        var relatedEntityAttributes = this._relationshipTypeAndAttributes[relType].relatedEntityAttributes;

                                        if (relatedEntityAttributes && relatedEntityAttributes.length) {
                                            //Initiate attr model get
                                            this._initiateAttributeModelRequest(relType, relatedEntityInfo, relatedEntityAttributes);
                                        } else {
                                            this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                            this._counter--;
                                            if (this._counter == 0) {
                                                this.assetTypeList=this._assetTypeList;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        this._counter--;
                        if (this._counter == 0) {
                            this.assetTypeList=this._assetTypeList;
                        }
                    }
                }
            },
            _initiateAttributeModelRequest: function (relationshipType, relatedEntityContexts, relatedEntityAttributes) {
                var liquidElement = document.createElement("liquid-entity-model-composite-get");
                liquidElement.name = relationshipType;

                var ids = [];

                var typesCriterion = [];
                var contexts = [];
                var valContext = this.getFirstValueContext();

                if (relatedEntityContexts) {
                    relatedEntityContexts.forEach(function (relContext) {
                        if (relContext) {
                            ids.push(relContext.relEntityType + "_entityCompositeModel");
                            if (relContext.relContexts) {
                                relContext.relContexts.forEach(function (ctxItem) {
                                    contexts.push(ctxItem);
                                }, this);
                            }
                        }
                    }, this);
                }

                var req = {
                    "params": {
                        "query": {
                            "contexts": contexts,
                            "locale": valContext.locale,
                            "ids": ids
                        },
                        "fields": {
                            "ctxTypes": [
                                "properties"
                            ],
                            "attributes": relatedEntityAttributes
                        }
                    }
                };

                liquidElement.requestData = req;
                liquidElement.addEventListener("entity-model-composite-get-response", this._onRelatedEntityAttributeModelGetResponse.bind(this));
                liquidElement.generateRequest();
            },
            _onRelatedEntityAttributeModelGetResponse: function (e) {
                var relType = e.currentTarget.name;
                if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                    var compositeModel = e.detail.response.content.entityModels[0];
                    var attributeModels = DataTransformHelper.transformAttributeModels(compositeModel, this.contextData);

                    if (relType) {
                        if (this._assetConfig[relType] && attributeModels) {
                            this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = attributeModels;
                        } else {
                            this._assetConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                        }
                    }
                }
                this._counter--;
                if (this._counter == 0) {
                    this.assetTypeList=this._assetTypeList;
                }
            },
            _getAssetGridConfig: function (relationshipTypeName) {
                var gridConfig;
                if (this._assetConfig[relationshipTypeName]) {
                    gridConfig = this._assetConfig[relationshipTypeName].gridConfig
                }
                return gridConfig;
            },
            _getAssetGridRequest:function (relationshipTypeName) {
                var req = DataHelper.cloneObject(this._entityGetReq);

                if (req && relationshipTypeName) {
                    var relAttr;
                    if (this._relationshipTypeAndAttributes) {
                        relAttr=this._relationshipTypeAndAttributes[relationshipTypeName];
                    }
                    if (relAttr) {
                        req.params.fields.relationshipAttributes = relAttr.relationshipAttributes;
                        req.params.fields.relatedEntityAttributes = relAttr.relatedEntityAttributes;
                    }
                    req.params.fields.relationships = [relationshipTypeName];
                }
                return req;
            },
            _getRelationshipAttributeModels: function (relationshipTypeName) {
                if(!this._assetConfig){
                    return {};
                }
                var config = this._assetConfig[relationshipTypeName];
                if (config) {
                    return config.relationshipAttributeModels;
                }
                return {};
            },
            _getRelatedEntityAttributeModels: function (relationshipTypeName) {
                if(!this._assetConfig){
                    return {};
                }
                var config = this._assetConfig[relationshipTypeName];
                if (config && config.relatedEntityModel) {
                    return config.relatedEntityModel.relatedEntityAttributeModels;
                }
                return {};
            },
            _populateDataForGrid: function (event) {
                var respData=event.detail.response;
                var currentRel = "";
                var thumbnailIds=[];
                if (event.detail.request) {
                    currentRel = event.detail.request.requestData.params.fields.relationships[0];
                }
                var relationshipAttributeModels = this._getRelationshipAttributeModels(currentRel);
                var relatedEntityAttributeModels = this._getRelatedEntityAttributeModels(currentRel);

                var data = [];
                if (respData) {
                    if (respData.content && respData.content.entities) {
                        var entities = respData.content.entities;
                        if (entities && entities.length > 0) {
                            var entityId = entities[0].id;
                            if (entityId) {
                                var entity = entities[0];
                                var isSelfContext = true;
                                var relConfig = this._assetConfig[currentRel];
                                if (relConfig && relConfig.hasOwnProperty("selfContext")) {
                                    isSelfContext = relConfig.selfContext;
                                }
                                var relationships = EntityHelper.getRelationshipsBasedOnContext(entity, this.getFirstDataContext(), isSelfContext);
                                if (!_.isEmpty(relationships)) {
                                    var relatedEntities = relationships[currentRel];
                                    relatedEntities.forEach(function (relItem) {
                                        if (relItem) {
                                            var record = {};
                                            if (relItem.attributes) {
                                                Object.keys(relItem.attributes).forEach(function (item) {
                                                    if (item && relItem.attributes[item]) {
                                                        var value= relItem.attributes[item].values[0].value;
                                                        record[item]=this._formatValue(relationshipAttributeModels,item,value);
                                                    }
                                                }, this);
                                            }
                                            if (relItem.relTo) {
                                                record["Related Entity"] = record["id"] = relItem.relTo.id;
                                                record["type"] = relItem.relTo.type;

                                                if (relItem.relTo.data) {
                                                    //var relCtxList = relContexts[item];
                                                    var relatedAttributes = EntityHelper.getAllAttributes(relItem.relTo);
                                                    if (relatedAttributes) {
                                                        Object.keys(relatedAttributes).forEach(function (
                                                            attrItem) {
                                                            if (attrItem && relatedAttributes[attrItem]) {
                                                                var value=relatedAttributes[attrItem].values[0].value;
                                                                record[attrItem] = this._formatValue(relatedEntityAttributeModels,attrItem,value);
                                                            }
                                                        }, this);
                                                    }
                                                }
                                            }
                                            if(record.thumbnailid){
                                                thumbnailIds.push(record.thumbnailid);
                                            }
                                            data.push(record);
                                        }
                                    }, this);
                                }
                            }
                        }
                    }
                }
                this._generateGetThumbnailRequest(thumbnailIds,currentRel);
                var grid=this.$$("#grid_"+currentRel);
                grid.data=data;
            },
            _generateGetThumbnailRequest:function (thumbnailIds,currentRel) {
                var req = DataRequestHelper.createEntityGetRequest(this.contextData);
                req.params.query.ids=thumbnailIds;
                req.params.query.filters.typesCriterion=["imagerendition"];
                req.params.query.valueContexts=[];
                req.params.fields.attributes=["blob"];
                delete req.params.options;
                var getThumbnailLiquid=this.$$("#getThumbnail_"+currentRel);
                if(getThumbnailLiquid){
                    getThumbnailLiquid.requestData=req;
                    getThumbnailLiquid.generateRequest();
                }
            },
            _onGetThumbnailResponse:function (e) {
                var thumbnails={};
                if (e.detail && e.detail.response && e.detail.response.response) {
                    var response = e.detail.response.response;

                    if (response.status.toLowerCase() == "success") {
                        var binaryObjects=response.binaryObjects;
                        if(binaryObjects) {
                            for (var i = 0; i < binaryObjects.length; i++) {
                                if (binaryObjects[i].data) {
                                    thumbnails[binaryObjects[i].id] = binaryObjects[i].data.blob;
                                }
                            }
                        }
                    }
                }
                var currentRel=e.currentTarget.asset;
                var grid=this.$$("#grid_"+currentRel);
                var data=grid.data;
                for(var key in thumbnails){
                    var index=data.findIndex(function (entity) {
                        return entity.thumbnailid==key;
                    });
                    if(index>-1) {
                        var entity = DataHelper.cloneObject(data[index]);
                        entity.thumbnail = "data:image;base64," + thumbnails[key];
                        grid.splice('data', index, 1, entity);
                    }
                }
            },
            _formatValue: function(models,item, value) {
                if(!models){
                    return value;
                }
                var model=models[item];
                if(model &&
                    model.dataType &&
                    (model.dataType.toLowerCase()  == "date" ||
                    model.dataType.toLowerCase()  == "datetime")) {
                    return FormatHelper.convertFromISODateTime(value, model.dataType, model.dateFormat);
                }

                return value;
            },
            _onAddAssetClick:function (e) {
                var asset=e.currentTarget.asset;
                var typesCriterion= this._assetConfig[asset].relatedEntityTypes;
                var title=this._getAssetTypeTitle(asset);
                var assetDialog=this.$$("#assetDialog");
                var itemContext=ContextHelper.getFirstItemContext(this.contextData);
                var entity={"id":itemContext.id,"type":itemContext.type};
                assetDialog.sharedData = {
                    "mode":"asset",
                    "context-data": this.contextData,
                    "types-criterion":typesCriterion,
                    "relationship-type":asset,
                    "title":title,
                    "selected-entities":[entity],
                    "self-context": this._assetConfig[asset].selfContext
                };
                assetDialog.open();
            },
            _refreshAssetGrid:function (e,detail) {
                var targetId=detail.id;
                targetId=targetId.replace("grid_","datasource_");
                var liq=this.$$("#"+targetId);
                if(liq){
                    liq.generateRequest();
                }
            },
            _onRefreshAssetGridEvent:function (e,detail) {
                var targetId=detail.id;
                var assetName=targetId.replace("grid_","");
                this._refreshGridByAssetName(assetName);
            },
            _onRefreshRelationshipGridEvent:function (e,detail) {
                var assetName=detail.relationshipType;
                this._refreshGridByAssetName(assetName);
            },
            _refreshGridByAssetName:function (assetName) {
                var targetId="datasource_"+assetName;
                var liq=this.$$("#"+targetId);
                if(liq){
                    liq.generateRequest();
                }
            },
            //Download asset functions
            _onOriginalAssetDownloadAction:function (e,detail) {
                if(detail) {
                    var fileName = detail.property_objectkey;
                    if (fileName) {
                        var req = {
                            "binaryStreamObject": {
                                "id": fileName,
                                "type": "binarystreamobject",
                                "data": {}
                            }
                        };
                        var downloadUrlLiquid = this.$$("#getDownloadUrl");
                        if (downloadUrlLiquid) {
                            downloadUrlLiquid.requestData = req;
                            downloadUrlLiquid.generateRequest();
                        }
                    }
                }
            },
            _onCustomToolbarEvent:function (e,detail) {
                if(detail && detail.name=="originalAssetDownload"){
                    this._originalAssetsDownload();
                }
            },
            _originalAssetsDownload: function () {
                var rockGrid = Polymer.dom(this).node.$$('rock-grid');
                var selectedItems=rockGrid.getSelectedItems();
                var filenames=[];
                if (selectedItems && selectedItems.length ) {
                    if(selectedItems.length>5){
                        this.showInformationToast("Simultaneous download of maximum 5 assets are allowed.");
                    }
                    selectedItems.forEach(function (item) {
                        if (item && item.property_objectkey) {
                            filenames.push(item.property_objectkey)
                        }
                    }, this);
                    var req = {
                        "binaryStreamObject": {
                            "ids": filenames,
                            "type": "binarystreamobject",
                            "data": {}
                        }
                    };
                    var downloadUrlLiquid = this.$$("#getDownloadUrl");
                    if (downloadUrlLiquid) {
                        downloadUrlLiquid.requestData=req;
                        downloadUrlLiquid.generateRequest();
                    }
                }else {
                    this.showInformationToast("Please select at least one asset from grid to download.");
                }
            },
            _onGetDownloadUrlResponse:function (e) {
                if (e.detail && e.detail.response && e.detail.response.response) {
                    var response = e.detail.response.response;
                    if (response.status.toLowerCase() == "success") {
                        var binaryStreamObjects=response.binaryStreamObjects;
                        if(binaryStreamObjects) {
                            for (var i = 0; i < binaryStreamObjects.length; i++) {
                                if (binaryStreamObjects[i].data) {
                                    var downloadURL=binaryStreamObjects[i].data.properties.downloadURL;
                                    if(downloadURL){
                                        var a = document.createElement('a');
                                        a.href = downloadURL;
                                        a.download = "";
                                        a.style.display = 'none';
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                    }
                                }
                            }
                        }
                    }
                }
            }

        });
    </script>
</dom-module>