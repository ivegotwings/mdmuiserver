<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-combo-box/pebble-combo-box.html">

<link rel="import" href="../pebble-tags/pebble-tags.html">


<!--
`rock-variants-option-select`

@demo demo/index.html
-->
<dom-module id="rock-variants-option-select">
    <template>
        <style include="pebble-styles-app"></style>
        <style>
            p {
                text-align: center;
            }
            
            .flexbox-container {
                display: -ms-flex;
                display: -webkit-flex;
                display: flex;
                padding: 20px 10px 20px 10px;
            }
            
            .box1 {
                width: 12%;
            }
            
            .box2 {
                margin-right: 10px;
                width: 40%;
            }
            
            .box3 {
                margin-left: 10px;
                width: 40%;
            }
            
            pebble-button.removeButton {
                color: #C1CAD4;
                --pebble-button: {
                    min-width: 40px;
                    height: 40px;
                }
            }
            
            pebble-button.addButton {
                color: #09C021;
                --pebble-button: {
                    min-width: 40px;
                    height: 40px;
                }
            }
            
            .optionButton {
                float: right;
                /*--pebble-button: {*/
                /*border-bottom: 1px solid #036BC3;*/
                /*}*/
            }
            
            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: #ccc;
                float: left;
                width: calc(100% - 20px);
            }
            
            .label {
                color: #C1CAD4;
            }
        </style>
        <div>
            <p>You can select multiple <b>Options</b> to create <b>SKUs</b></p>
        </div>
        <liquid-entity-data-get id="getData" operation="getbyids" request-data="[[_getRequest(variantDefinition,entityId)]]" last-response="{{remoteData}}"
            on-response="_onResponse">
        </liquid-entity-data-get>
        <liquid-entity-data-save name="attributeSaveDataService" operation="update" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
            on-response="_onSaveResponse"></liquid-entity-data-save>
        <template is="dom-repeat" items="{{selectedOptions}}">
            <div class="flexbox-container" id="row[[index]]">
                <div class="box1">
                    <pebble-button class="removeButton" icon="pebble-icons:RemoveCircle" item="[[item]]" on-tap="_removeOption"></pebble-button>
                    <span style="vertical-align: super;">[[_getSerialNumber(index)]]</span>
                </div>
                <div class="box2">
                    <div class="label">OPTION</div>
                    <pebble-combo-box items="[[options]]" selected-item="{{item.option}}" index="[[index]]" on-selection-changed="_optionLovSelectionChanged"></pebble-combo-box>
                </div>
                <div class="box3">
                    <div class="label">VALUES</div>
                    <pebble-combo-box items="{{_getValues(item.option,item)}}" selected-items="{{item.values}}" multi-select on-selection-changed="_valuesLovSelectionChanged"></pebble-combo-box>
                </div>
            </div>
        </template>
        <div class="flexbox-container">
            <div class="box1">
                <pebble-button class="addButton" icon="icons:add-circle" on-tap="_addNewRow"></pebble-button>
            </div>
        </div>
        <div id="content-actions" align="center">
            <pebble-button class="action-button btn btn-secondary" id="skip" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>

    </template>
    <script>
        Polymer({
            is: 'rock-variants-option-select',
            properties: {
                /**
                 * Indicates the index of a tag.
                 */
                attributesList: {
                    type: Array
                },
                selectedOptions: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                    notify: true
                },
                _reupdateOptions: {
                    type: Boolean,
                    value: false
                },
                options: {
                    type: Array,
                    computed: '_getOptions(variantDefinition, selectedOptions,_reupdateOptions)',
                    notify: true
                },
                /**
                 * Indictaes the identification of the entity for which the attributes are managed.
                 */
                entityId: {
                    type: String
                },
                /**
                 * Indicates the locale dimension for which the attributes are managed.
                 */
                locale: {
                    type: String
                },
                /**
                 * Indictaes the list for which the attributes are managed.
                 */
                list: {
                    type: String
                },
                /**
                 * Indictaes the classification for which the attributes are managed.
                 */
                classification: {
                    type: String,
                    value: "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                },
                /**
                 * Indictaes the source dimension for which the attributes are managed.
                 */
                source: {
                    type: String
                },
                variantDefinition: {
                    type: Object,
                    value: function () { return {}; },
                    computed: "getParentAppConfig('rock-variants-create-grid', '', 'variantDefinitionExternal')"
                },
                _saveRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            _onDefinitionRender: function () {
                this.$.getData.generateRequest();
            },
            _getRequest: function (variantsDefinition) {
                var req = {
                    "params": {
                        "query": {
                            "ctx": [{
                                "list": this.list,
                                "classification": this.classification
                            }],
                            "valCtx": [{
                                "source": this.source,
                                "locale": this.locale
                            }],
                            "id": this.entityId,
                            "filters": {
                                "attributesCriterion": [],
                                "relationshipsCriterion": [],
                                "typesCriterion": ["nart"]
                            }
                        },
                        "fields": {
                            "ctxTypes": [
                                "properties"
                            ],
                            "attributes": [],
                            "relationships": [
                            ]
                        },
                        "options": {
                            "totalRecords": 10,
                            "includeRequest": false
                        }
                    }
                };
                var attributes = [];
                var attributesList = [];
                variantsDefinition.levels.forEach(function (level) {
                    for (var i = 0; i < level.dimensions.length; i++) {
                        attributes.push(level.dimensions[i].sourceAttribute);
                        attributesList.push({ "name": level.dimensions[i].sourceAttribute, "optional": level.dimensions[i].optional });
                    }
                });
                this.attributesList = attributesList;
                req.params.fields.attributes = attributes;
                return req;
            },
            _onResponse: function () {
                var data = this.remoteData;
                if (data && data.content) {
                    var entities = data.content.entities;
                    if (entities) {
                        var dataContext = {
                            "list": this.list,
                            "classification": this.classification,
                            "source": this.source,
                            "time": "now",
                            "locale": this.locale
                        };
                        var entity = entities[0];
                        this.originalEntity = entity;
                        if (entity.data) {
                            var ctx = DataHelper.prepareCtx(dataContext);
                            var valCtx = DataHelper.prepareValCtx(dataContext);
                            var attributes = SharedUtils.DataObjectFalcorUtil.getAttributesByCtx(entity, ctx);
                            for (var i = 0; i < this.attributesList.length; i++) {
                                var attribute = attributes[this.attributesList[i].name];
                                if (attribute && attribute.values) {
                                    var value = DataHelper._getCurrentValue(attribute.values, valCtx).value;
                                    var values = [];
                                    if (typeof value === 'string') {
                                        values = [{ "title": value, "id": value }];
                                    } else {
                                        values = value.map(function (val) {
                                            return { "title": val, "id": val };
                                        })
                                    }
                                    this.push('selectedOptions', {
                                        "option": { "title": this.attributesList[i].name },
                                        "values": values
                                    });
                                }
                            }
                        }
                    }
                }
            },
            _addNewRow: function () {
                var newOption = { "option": "", "values": [] };
                this.push('selectedOptions', newOption);
                //TODO open lov for option
                var newOptionIndex = this.selectedOptions.length - 1;
            },
            _getSerialNumber: function (index) {
                return index + 1;
            },
            _removeOption: function (e) {
                var item = e.target.item;
                var index = this.selectedOptions.indexOf(item);
                this.splice('selectedOptions', index, 1);
            },
            _onCancelTap: function (e) {
                //raise event with name given for onbackAction in configuration
                var eventName = "onCancel";
                var eventDetail = {
                    name: eventName
                };
                this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
            },
            _onSaveTap: function (e) {
                if (this.selectedOptions.length == 0) {
                    alert("Please select at least 1 option");
                    return;
                }
                var selectedOptions = this.selectedOptions;
                var attrNames = selectedOptions.map(function (selectedItem) {
                    if (selectedItem.option && selectedItem.values && selectedItem.values.length > 0) {
                        return selectedItem.option.title;
                    }
                });
                for (i = 0; i < this.attributesList.length; i++) {
                    var attribute = this.attributesList[i];
                    if (!attribute.optional) {
                        if (attrNames.indexOf(attribute.name) == -1) {
                            alert("Adding values for " + attribute.name + " is compulsary");
                            return;
                        }
                    }
                }
                var attributes = {};
                for (var i = 0; i < selectedOptions.length; i++) {
                    if (selectedOptions[i].option && selectedOptions[i].values && selectedOptions[i].values.length > 0) {
                        var values = selectedOptions[i].values.map(function (valueJson) {
                            return valueJson.title;
                        });
                        var attr = {
                            "name": selectedOptions[i].option.title,
                            "value": values,
                            "source": this.source,
                            "locale": this.locale
                        };
                        attributes[attr.name] = { "values": [attr] };
                    }
                }
                var entityData = this.originalEntity;
                var contextualData = {};
                contextualData.ctxInfo = [];
                var ctxItem = {};
                ctxItem.ctxGroup = { "list": this.list, "classification": this.classification };
                ctxItem.attributes = attributes;
                contextualData.ctxInfo.push(ctxItem);
                entityData["data"] = contextualData;

                if (!_.isEmpty(entityData)) {
                    this._saveRequest = {
                        "entities": [entityData]
                    };
                    var liquidSave = this.$$("[name=attributeSaveDataService]");
                    if (liquidSave) {
                        liquidSave.generateRequest();
                    }
                }
            },
            _onSaveResponse: function () {
                var eventName = "onSave";
                var eventDetail = {
                    name: eventName,
                    data: { "entity-id": this.entityId, "source": this.source, "locale": this.locale, "list": this.list }
                };
                this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
            },
            _openOptionPopover: function (e) {
                var index = e.currentTarget.index;
                this.$$("#optionPopover" + index).open();
                this.$$('#lov' + index).activate();
            },
            _openValuesPopover: function (e) {
                var index = e.currentTarget.index;
                this.$$("#valuesPopover" + index).open();
                this.$$('#vLov' + index).activate();
            },
            _getOptions: function (variantsDefinition, selectedOptions) {
                var options = [];
                variantsDefinition.levels.forEach(function (level) {
                    for (var i = 0; i < level.dimensions.length; i++) {
                        options.push(level.dimensions[i].sourceAttribute);
                    }
                });
                for (var i = 0; i < this.selectedOptions.length; i++) {
                    var index = options.indexOf(this.selectedOptions[i].option.title);
                    if (index > -1) {
                        delete options[index];
                    }
                }
                var lovOptions = [];
                options.forEach(function (option) {
                    lovOptions.push({ "title": option });
                });
                return lovOptions;
            },
            _getValues: function (option) {
                //TODO add mechanism to get values given an option name. Right now Just hard coding some values
                var values = {
                    "colors": ["Dark", "Light", "Azure"],
                    "materials": ["Silk", "Cotton", "Polyster", "Wool"],
                    "primarySizes": ["1.3oz", "1.8oz"],
                    "secondarySizes": ["s", "m", "xl", "xxl", "xxxl"]
                };
                if (option) {
                    return values[option.title].map(function (item) {
                        return { "title": item, "id": item };
                    });
                }
                return [];
            },
            _optionLovSelectionChanged: function (e) {
                this._reupdateOptions = !this._reupdateOptions;
            }
        });
    </script>
</dom-module>