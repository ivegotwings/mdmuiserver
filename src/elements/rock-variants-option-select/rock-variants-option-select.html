<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-combo-box/pebble-combo-box.html">

<link rel="import" href="../rock-tags/rock-tags.html">


<!--
`rock-variants-option-select`

@demo demo/index.html
-->
<dom-module id="rock-variants-option-select">
    <template>
        <style include="pebble-styles-app"></style>
        <style>
            p{
                text-align: center;
            }
            .flexbox-container {
                display: -ms-flex;
                display: -webkit-flex;
                display: flex;
                padding:20px 10px 20px 10px;
            }

            .box1  {
                width: 12%;
            }
            .box2  {
                margin-right: 10px;
                width: 40%;
            }
            .box3  {
                margin-left: 10px;
                width: 40%;
            }
            pebble-button.removeButton {
                color:#C1CAD4;
                --pebble-button: {
                 min-width: 40px;
                 height: 40px;
                }
            }
            pebble-button.addButton {
                color:#09C021;
                --pebble-button: {
                    min-width: 40px;
                    height: 40px;
                }
            }
            .optionButton {
                float:right;
                /*--pebble-button: {*/
                    /*border-bottom: 1px solid #036BC3;*/
                /*}*/
            }
            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: #ccc;
                float:left;
                width:calc(100% - 20px);
            }
            .label{
                color:#C1CAD4;
            }
        </style>
        <div>
            <p>You can select multiple <b>Options</b> to create <b>SKUs</b></p>
        </div>
        <iron-ajax id="guideme-ajax" auto url="/src/data/guideme-data.json" handle-as="json" last-response="{{data}}"></iron-ajax>
        <iron-ajax id="guideme-ajax" auto url="/src/data/EntityManageApp/variant-definition-external.json" handle-as="json" last-response="{{variantsDefinition}}"></iron-ajax>
        <template is="dom-repeat" items="{{selectedOptions}}">
            <div class="flexbox-container" id="row[[index]]">
                <div class="box1">
                    <pebble-button class="removeButton"  icon="pebble-icons:RemoveCircle" item="[[item]]" on-tap="_removeOption"></pebble-button>
                    <span style="vertical-align: super;">[[_getSerialNumber(index)]]</span>
                </div>
                <div class="box2">
                    <div class="label">OPTION</div>
                    <pebble-combo-box items="[[_getOptions(selectedOptions)]]" selected-item="{{item.option}}" on-selection-changed="_optionLovSelectionChanged" ></pebble-combo-box>
                </div>
                <div class="box3">
                    <div class="label">VALUES</div>
                    <pebble-combo-box items="{{_getValues(item.option,data)}}" selected-items="{{item.values}}" multi-select show-color  on-selection-changed="_valuesLovSelectionChanged" ></pebble-combo-box>
                </div>
            </div>
        </template>
        <div class="flexbox-container">
        <div class="box1">
        <pebble-button class="addButton" icon="icons:add-circle" on-tap="_addNewRow"></pebble-button>
        </div>
        </div>
        <div id="content-actions" align="center">
            <pebble-button class="action-button btn btn-secondary" id="skip" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>

    </template>
    <script>
        Polymer({
            is: 'rock-variants-option-select',
            properties: {
                /**
                 * Indicates the index of a tag.
                 */
                selectedOptions: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                    notify:true
                },
                options:{
                    type: Array,
                    computed:'_getOptions(variantDefinition, selectedOptions)'
                    notify:true
                }

            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            _addNewRow:function () {
                var newOption={"option":"","values":[]};
                this.push('selectedOptions',newOption);
                //TODO open lov for option
                var newOptionIndex=this.selectedOptions.length-1;
            },
            _getSerialNumber: function (index) {
                return index+1;
            },
            _removeOption:function (e) {
                var item=e.target.item;
                var index=this.selectedOptions.indexOf(item);
                this.splice('selectedOptions',index,1);
            },
            _onCancelTap: function(e) {
                //raise event with name given for onbackAction in configuration
                var eventName = "onCancel";
                var eventDetail = {
                    name: eventName
                };
                this.fireBedrockEvent(eventName, eventDetail,{ ignoreId: true });
            },
            _onSaveTap: function(e) {
                if(this.selectedOptions.length==0){
                    alert("select at least 1 option");
                    return;
                }
                var eventName = "onSave";
                var eventDetail = {
                    name: eventName,
                    data:this.selectedOptions
                };
                this.fireBedrockEvent(eventName, eventDetail,{ ignoreId: true });
            },
            _openOptionPopover:function (e) {
                var index=e.currentTarget.index;
                this.$$("#optionPopover"+index).open();
                this.$$('#lov'+index).activate();
            },
            _openValuesPopover:function (e) {
                var index=e.currentTarget.index;
                this.$$("#valuesPopover"+index).open();
                this.$$('#vLov'+index).activate();
            },
            _getOptions:function (variantsDefinition, selectedOptions) {
                var options=[];
                variantsDefinition.levels.forEach(function (level) {
                   for(var i=0;i<level.dimensions.length;i++){
                        options.push({"title":level.dimensions[i].sourceAttribute});
                   }
                });
                for(var i=0;i<this.selectedOptions.length;i++){
                    var index=options.indexOf(this.selectedOptions[i].option.title);
                    if(index>-1){
                        delete options[index];
                    }
                }
                var lovOptions=[];
                options.forEach(function (option) {
                    lovOptions.push({"title":option});
                });
                return lovOptions;
            },
            _getValues:function (option) {
                if(option) {
                    var dimensionObjects = this.data.filter(function (data) {
                        return data.name.toLowerCase() == option.title.toLowerCase();
                    });
                    if (dimensionObjects.length > 0) {
                        return dimensionObjects[0].variants;
                    }
                }
                return [];
            }
        });
    </script>
</dom-module>