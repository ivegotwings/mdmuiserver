<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer-quill/polymer-quill.html">

<dom-module id="pebble-richtexteditor">
  <template>
    <style include="quill-core quill-snow pebble-styles-shared"></style>   
    <div hidden$="[[readOnly]]">
        <label hidden$="[[!label]]" aria-hidden="true">[[label]]</label>
        <div id="content">
          <div id="toolbar">
            <button class="ql-header tooltip-bottom" type="button" value="1" data-tooltip="Header Big" data-placement="bottom"></button>
            <button class="ql-header tooltip-bottom" type="button" value="2" data-tooltip="Header Medium" data-placement="bottom"></button>

            <button class="ql-blockquote tooltip-bottom" type="button" data-tooltip="Blockquote" data-placement="bottom"></button>
            <button class="ql-bold tooltip-bottom" type="button" data-tooltip="Bold" data-placement="bottom"></button>
            <button class="ql-italic tooltip-bottom" type="button" data-tooltip="Italic" data-placement="bottom"></button>
            <button class="ql-underline tooltip-bottom" type="button" data-tooltip="Underline" data-placement="bottom"></button>
            <button class="ql-strike tooltip-bottom" type="button" data-tooltip="Strike" data-placement="bottom"></button>

            <select class="ql-align tooltip-bottom" data-tooltip="Align" data-placement="bottom">
              <option selected="selected"></option>
              <option value="center"></option>
              <option value="right"></option>
              <option value="justify"></option>
            </select>
        
            <button class="ql-image tooltip-bottom" type="button" data-tooltip="Image" data-placement="bottom"></button>
            <button class="ql-list tooltip-bottom" type="button" value="ordered" data-tooltip="List" data-placement="bottom"></button>
            <button class="ql-list tooltip-bottom" type="button" value="bullet" data-tooltip="Bullet" data-placement="bottom"></button>
            
            <button class="ql-link tooltip-bottom" type="button" data-tooltip="Link" data-placement="bottom"></button>
            <button class="ql-clean tooltip-bottom" type="button" data-tooltip="clean" data-placement="bottom"></button>
          </div>
          <div id="editor"></div>
        </div>      
    </div> 
    <div hidden$="[[!readOnly]]">
      <label hidden$="[[!label]]" aria-hidden="true">[[label]]:</label>
      <div id="viewBox"></div>
    </div>
    <bedrock-validator show-error="[[showError]]" validation-errors="{{validationErrors}}" input="[[value]]" pattern="[[pattern]]" min-length="[[minlength]]" max-length="[[maxlength]]"  precision="[[precision]]" required="[[required]]"
        invalid="{{invalid}}" error-message="{{errorMessage}}" min="[[min]]" max="[[max]]"  type="[[validationType]]" type-array="[[validationTypeArray]]"></bedrock-validator>

  </template>
  <script>
    class PebbleRichtexteditor extends Polymer.Element {
      static get is() { return 'pebble-richtexteditor' }

      ready() {
        super.ready();
        var _this = this;
        this.quill = new Quill(this.$.editor,{
          modules: {
            toolbar: this.$.toolbar           
          },
          placeholder: 'Enter the text here...',
          theme: 'snow'  // or 'bubble'
        })
      }

      connectedCallback() {
        super.connectedCallback();
        var _this = this;        
        this.quill.on('text-change', function(delta, oldDelta, source){
             _this._onTextChange();            
        });
        if(this.$.editor.querySelector('.ql-editor')) {
          this.editor = this.$.editor.querySelector('.ql-editor');         
        }

      }

      disconnectedCallback() {
        super.disconnectedCallback();
        var _this = this;   
        this.quill.off('text-change',_this._onTextChange());
      }

      static get properties() {
        return {           
            /**
            * Indicates the label for the richtexteditor.
            * It allows to add descriptive text for the richtexteditor to inform the user about the type of data 
            * expected in the richtexteditor. 
            */
            label: {
              type: String
            },
            
            /**
            * Indicates the encoded html output from the richtexteditor.
            */
            value: {
                type: String,
                notify: true,
                observer: '_onValueChange'               
            },

            /**
            * Specifies whether or not the richtexteditor is non-editable. 
            * Set it to <b>true</b> to make the textbox read-only.
            */
            readOnly: {
              type: Boolean,
              value: false,                 
              observer: '_onReadOnlySet'

            },
            
            /**
            * Indicates the richtexteditor content container.
            */
            editor:{
              type: Object
            }
            
        }
      }
           
      _onReadOnlySet() {
        if(this.readOnly == true){
          this._setViewModeValue();            
        } else{
          this._setEditorValue();  
        }      
      }
  
      //Set the input value when the RTE is in edit mode
      _setEditorValue() {
        var editorContent = this.value;
        if(this.editor && this.value) {            
            this.editor.innerHTML = editorContent;
        }
      }

      //Set the input value when the RTE is in view mode
      _setViewModeValue() {
        this.$.viewBox.innerHTML = this.value;
      }
      
      //Handle the text change event on the editor
      _onTextChange(){        
        if(this.editor) {
          var encodedText =  this.editor.innerHTML;
          //Return without doing anything for unchanged value
          if(this.value == encodedText) {
            return;
          } 
          this.value = encodedText;
        }       
      }

      //Handle the value change from the editor as well as outside controls like revert/clear
      _onValueChange() {
        if(this.editor) {
          var encodedText =  this.editor.innerHTML;
          if(this.value == encodedText) { //value changed from editor
            return;
          } else if (this.value == "") { 
            this.editor.innerHTML = "";
          } else if (this.value != encodedText) { //value changed from other controls like revert or clear
            this.editor.innerHTML = this.value;
          }
        }        
      }    
      
    }
    customElements.define(PebbleRichtexteditor.is, PebbleRichtexteditor);  
  </script> 
</dom-module>