<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer-quill/polymer-quill.html">

<dom-module id="pebble-richtexteditor">
  <template>
    <style include="quill-core quill-snow bedrock-style-common">
      label {
        font-size:var(--default-font-size, 12px) !important;
        color:var(--input-label-color,#96b0c6);
        line-height: 17px;
        margin-top: 17px;
      } 

     .ql-snow .ql-picker.ql-expanded .ql-picker-options{
        z-index: 999;
      }
      
    </style>   
    <div hidden$="[[readOnly]]">
        <label hidden$="[[!label]]" aria-hidden="true">[[label]]</label>
        <div id="content">
          <div id="toolbar">
            
            <select class="ql-size tooltip-bottom" data-tooltip="Size">
              <option value="small"></option>
              <option selected="selected"></option>
              <option value="large"></option>
              <option value="huge"></option>
            </select>

            <button type="button" class="ql-list tooltip-bottom" data-tooltip="Bulleted List" value="bullet">
            <button type="button" class="ql-list tooltip-bottom" data-tooltip="Ordered List" value="ordered">

            <button type="button" class="ql-indent tooltip-bottom" data-tooltip="Decrease Indent" value="-1"></button>
            <button type="button" class="ql-indent tooltip-bottom" data-tooltip="Increase Indent" value="+1"></button>
            
            <button type="button" class="ql-bold tooltip-bottom" data-tooltip="Bold"></button> 
            <button type="button" class="ql-italic tooltip-bottom" data-tooltip="Italic"></button> 
            <button type="button" class="ql-underline tooltip-bottom" data-tooltip="Underline"></button> 
            <button type="button" class="ql-strike tooltip-bottom" data-tooltip="Strike"></button> 
            <button type="button" class="ql-script tooltip-bottom" data-tooltip="Subscript" value="sub"></button> 
            <button type="button" class="ql-script tooltip-bottom" data-tooltip="Superscript" value="super"></button>
            
            <select class="ql-background tooltip-bottom" data-tooltip="Background Color">
              <option value="#000000"></option>
              <option value="#e60000"></option>
              <option value="#ff9900"></option>
              <option value="#ffff00"></option>
              <option value="#008a00"></option>
              <option value="#0066cc"></option>
              <option value="#9933ff"></option>
              <option selected="selected"></option>
              <option value="#facccc"></option>
              <option value="#ffebcc"></option>
              <option value="#ffffcc"></option>
              <option value="#cce8cc"></option>
              <option value="#cce0f5"></option>
              <option value="#ebd6ff"></option>
              <option value="#bbbbbb"></option>
              <option value="#f06666"></option>
              <option value="#ffc266"></option>
              <option value="#ffff66"></option>
              <option value="#66b966"></option>
              <option value="#66a3e0"></option>
              <option value="#c285ff"></option>
              <option value="#888888"></option>
              <option value="#a10000"></option>
              <option value="#b26b00"></option>
              <option value="#b2b200"></option>
              <option value="#006100"></option>
              <option value="#0047b2"></option>
              <option value="#6b24b2"></option>
              <option value="#444444"></option>
              <option value="#5c0000"></option>
              <option value="#663d00"></option>
              <option value="#666600"></option>
              <option value="#003700"></option>
              <option value="#002966"></option>
              <option value="#3d1466"></option>
            </select>
              
            <select class="ql-color tooltip-bottom" data-tooltip="Text Color">
              <option selected="selected"></option>
              <option value="#e60000"></option>
              <option value="#ff9900"></option>
              <option value="#ffff00"></option>
              <option value="#008a00"></option>
              <option value="#0066cc"></option>
              <option value="#9933ff"></option>
              <option value="#ffffff"></option>
              <option value="#facccc"></option>
              <option value="#ffebcc"></option>
              <option value="#ffffcc"></option>
              <option value="#cce8cc"></option>
              <option value="#cce0f5"></option>
              <option value="#ebd6ff"></option>
              <option value="#bbbbbb"></option>
              <option value="#f06666"></option>
              <option value="#ffc266"></option>
              <option value="#ffff66"></option>
              <option value="#66b966"></option>
              <option value="#66a3e0"></option>
              <option value="#c285ff"></option>
              <option value="#888888"></option>
              <option value="#a10000"></option>
              <option value="#b26b00"></option>
              <option value="#b2b200"></option>
              <option value="#006100"></option>
              <option value="#0047b2"></option>
              <option value="#6b24b2"></option>
              <option value="#444444"></option>
              <option value="#5c0000"></option>
              <option value="#663d00"></option>
              <option value="#666600"></option>
              <option value="#003700"></option>
              <option value="#002966"></option>
              <option value="#3d1466"></option>
            </select>
            
            <button class="ql-header tooltip-bottom" value="1" data-tooltip="Header Big"></button>
            <button class="ql-header tooltip-bottom" value="2" data-tooltip="Header Medium"></button>
            
            <select class="ql-align tooltip-bottom" data-tooltip="Align">
              <option selected="selected"></option>
              <option value="center"></option>
              <option value="right"></option>
              <option value="justify"></option>
            </select>
            
            <button type="button" class="ql-link tooltip-bottom" data-tooltip="Link"></button>            
            <button type="button" class="ql-image tooltip-bottom" data-tooltip="Image"></button>            
            <button type="button" class="ql-clean tooltip-bottom" data-tooltip="Clean"></button> 

          </div>
          <div id="editor"></div>
        </div>      
    </div> 
    <div hidden$="[[!readOnly]]">
      <label hidden$="[[!label]]" aria-hidden="true">[[label]]:</label>
      <div id="viewBox"></div>
    </div>
    <bedrock-validator show-error="[[showError]]" validation-errors="{{validationErrors}}" input="[[value]]" pattern="[[pattern]]" min-length="[[minlength]]" max-length="[[maxlength]]"  precision="[[precision]]" required="[[required]]"
        invalid="{{invalid}}" error-message="{{errorMessage}}" min="[[min]]" max="[[max]]"  type="[[validationType]]" type-array="[[validationTypeArray]]"></bedrock-validator>

  </template>
  <script>
    class PebbleRichtexteditor extends Polymer.Element {
      static get is() { return 'pebble-richtexteditor' }

      ready() {
        super.ready();
        var _this = this;
        this.quill = new Quill(this.$.editor,{
          modules: {
            toolbar: this.$.toolbar           
          },
          placeholder: 'Enter the text here...',
          theme: 'snow'  // or 'bubble'
        })
      }

      connectedCallback() {
        super.connectedCallback();
        var _this = this;        
        this.quill.on('text-change', function(delta, oldDelta, source){
             _this._onTextChange();            
        });
        if(this.$.editor.querySelector('.ql-editor')) {
          this.editor = this.$.editor.querySelector('.ql-editor');         
        }

      }

      disconnectedCallback() {
        super.disconnectedCallback();
        var _this = this;   
        this.quill.off('text-change',_this._onTextChange());
      }

      static get properties() {
        return {           
            /**
            * Indicates the label for the richtexteditor.
            * It allows to add descriptive text for the richtexteditor to inform the user about the type of data 
            * expected in the richtexteditor. 
            */
            label: {
              type: String
            },
            
            /**
            * Indicates the encoded html output from the richtexteditor.
            */
            value: {
                type: String,
                notify: true,
                observer: '_onValueChange'               
            },

            /**
            * Specifies whether or not the richtexteditor is non-editable. 
            * Set it to <b>true</b> to make the textbox read-only.
            */
            readOnly: {
              type: Boolean,
              value: false,                 
              observer: '_onReadOnlySet'

            },
            
            /**
            * Indicates the richtexteditor content container.
            */
            editor:{
              type: Object
            }
            
        }
      }
           
      _onReadOnlySet() {
        if(this.readOnly == true){
          this._setViewModeValue();            
        } else{
          this._setEditorValue();  
        }      
      }
  
      //Set the input value when the RTE is in edit mode
      _setEditorValue() {
        var editorContent = this.value;
        if(this.editor && this.value) {            
            this.editor.innerHTML = editorContent;
        }
      }

      //Set the input value when the RTE is in view mode
      _setViewModeValue() {
        this.$.viewBox.innerHTML = this.value;
      }
      
      //Handle the text change event on the editor
      _onTextChange(){        
        if(this.editor) {
          var encodedText =  this.editor.innerHTML;
          //Return without doing anything for unchanged value
          if(this.value == encodedText) {
            return;
          } 
          this.value = encodedText;
        }       
      }

      //Handle the value change from the editor as well as outside controls like revert/clear
      _onValueChange() {
        if(this.editor) {
          var encodedText =  this.editor.innerHTML;
          if(this.value == encodedText) { //value changed from editor
            return;
          } else if (this.value == "") { 
            this.editor.innerHTML = "";
          } else if (this.value != encodedText) { //value changed from other controls like revert or clear
            this.editor.innerHTML = this.value;
          }
        }        
      }    
      
    }
    customElements.define(PebbleRichtexteditor.is, PebbleRichtexteditor);  
  </script> 
</dom-module>