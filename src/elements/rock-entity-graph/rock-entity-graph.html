<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-graph-tree/rock-entity-graph-tree.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">

<dom-module id="rock-entity-graph">
    <template>
        <style>
            .splitscreenContainer{
                display: flex;
                flex-flow: row;
                height: 100%;
            }
            .left-panel{
                width:25%;
                overflow-y: auto;
                border-right: 1px solid var(--default-border-color, #c1cad4);
            }
            .right-panel{
                width:75%;
            }
        </style>
        <liquid-config-aggregate-get id="getAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-discovery"
        context-data="[[prepareContextDataForLiquid(contextData)]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>

        <!-- <pebble-accordion header-text="Entity Graph" default-icon="chevron-right" open-icon="expand-more"> -->
            <div class="splitscreenContainer">
                <div class="left-panel">
                    <!--rock-entity-graph-tree id="topFamilyTree" config-only entity-id="[[_getEntityId()]]" entity-type="[[_getEntityType()]]" 
                    tree-config="[[treeConfig]]" ></rock-entity-graph-tree-->
                    <rock-entity-graph-tree id="childFamilyTree" context-data="[[contextData]]" item-data="{{_itemData}}"></rock-entity-graph-tree>
                </div>
                <div class="right-panel">
                    <template is="dom-if" if="[[applicationConfig.components]]">
                                
                        <template is="dom-if" if="[[_isGridView]]">
                            <rock-relationship-manage mode="[[mode]]" context-data="[[contextData]]" config-context="[[configContext]]" no-of-columns="[[noOfColumns]]" do-sync-validation$="[[doSyncValidation]]"></rock-relationship-manage>
                        </template>                    
                        <template is="dom-if" if="[[!_isGridView]]">
                            <div>

                                <rock-entity-quick-manage id="entityQuickManage" context-data="[[contextData]]" current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]"
                                    selected-entity="[[_selectedEntity]]" tab-config="[[getQuickManageConfig('rock-entity-quick-manage', 'rock-tabs')]]"
                                    toolbar-config="[[getQuickManageConfig('rock-entity-quick-manage', 'pebble-toolbar')]]" fixes="[[getQuickManageConfig('rock-entity-quick-manage', 'rock-entity-tofix')]]"></rock-entity-quick-manage>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
        <!-- </pebble-accordion> -->
    </template>
<script>
(function(){

    Polymer({
        is: "rock-entity-graph",
        properties:{
            contextData: {
                type: Object,
                value: function () {
                    return {};
                },
                notify:true
            },
            configContext: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            _itemData:{
                type:Object,
                value: function() {
                    return {};
                }
            },
            _isGridView:{
                type:Boolean,
                value: true
            },
            configContext: {
                type: Object,
                value: function() {
                    return {
                        // "relationshipType": "Relationships",
                        // "relationshipNames": [
                        //     "productpresentationtolot",
                        //     "ensembletoproductpresentation"
                        // ],
                        // "addRelationshipMode": "lov",
                        // "relationshipTitle": "Lots",
                        // "relationshipTypeName": "productpresentationtolot"
                        };
                },
                notify: true
            },
            mode: {
                type: String,
                value: function(){
                    return "view";
                }
            },
            noOfColumns: {
                type: Number,
                value: 3
            },
            doSyncValidation: {
                type: Boolean,
                value: true
            },
            relationshipGridConfigs: {
                type: Object,
                value: function () { return {}; }
            },
            clickedEntityTypes: {
                type: Array,
                value: function () { return []; }
            }
        },
        behaviors: [
            RUFBehaviors.AppBehavior
        ],
        observers: [
            '_itemClickHandler(_itemData)'
        ],
        _itemClickHandler: function(){
            console.log(this._itemData)
            if(this._itemData && !_.isEmpty(this._itemData)){

                if(this._itemData.viewMode && this._itemData.id && this._itemData.type){
                    if(this.clickedEntityTypes[this.clickedEntityTypes.length-1] != this._itemData.id + "_" + this._itemData.relationshipName){
                        if(this._itemData.viewMode == "QUICK_MANAGE"){
                            this.contextData.ItemContexts = [];
                            this.push('contextData.ItemContexts', {"id":this._itemData.id,"type":this._itemData.type});
                            this._isGridView = false;
                            setTimeout(() => {
                                this.shadowRoot.querySelector('#entityQuickManage').reload();
                            }, 0);
                        }
                         else if(this._itemData.viewMode == "GRID"){
                            this.set("configContext", {"relationshipTitle":"SKUs","relationshipTypeName":this._itemData.relationshipName});
                            this.set('contextData.ItemContexts', [{"id":this._itemData.id,"type":this._itemData.type}]);
                            var liquidElemet = this.shadowRoot.querySelector("#getAppConfig");
                            liquidElemet.contextData=this.contextData;
                            if(liquidElemet.appName != "app-entity-manage"){
                                liquidElemet.appName = "app-entity-manage";
                            }
                            liquidElemet.refresh();
                            this._isGridView = true;
                        }
                         this.clickedEntityTypes.push(this._itemData.id + "_" + this._itemData.relationshipName);
                    }
                }
            }
        },
        _onApplicationConfigReceived: function (e) {
            this.set('applicationConfig', e.detail);

            var relationshipManageConfig = e.detail.components["rock-relationship-manage"];
            if(relationshipManageConfig){
                var relationshipGridConfig = relationshipManageConfig.config.relationshipGridConfig;
                var relationshipManage = this.shadowRoot.querySelector("rock-relationship-manage");
                relationshipManage.set("relationshipGridConfigs", relationshipGridConfig);
            }
        },
        getQuickManageConfig: function (componentName, configName) {
            var componentConfig = {};
            if (this.applicationConfig && this.applicationConfig.components) {
                var components = this.applicationConfig["components"];
                var config = components[componentName].config;
                if (config) {
                    componentConfig = config[configName];
                }
            }
            return componentConfig;
        },
        prepareContextDataForLiquid: function(context){
            var contextData = DataHelper.cloneObject(context);
            if(contextData.ItemContexts){
                delete contextData['ItemContexts'];
            }
            return contextData;
        }
    });
})();

</script>
</dom-module>