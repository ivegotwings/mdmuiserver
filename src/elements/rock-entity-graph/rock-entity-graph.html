<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../pebble-resizable-panels/pebble-resizable-panels.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-graph-tree/rock-entity-graph-tree.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>

<dom-module id="rock-entity-graph">
    <template>
        <style include="bedrock-styles-scroll-bar">
            :host{
                --rock-grid-actions:{
                    display:none;
                }
                --rock-relationship-manage-message-card:{
                    display: none;
                }
                --quick-manage-header: {
                    display: none;
                }
            }
            .left-panel{
                height: 100%;
                overflow: auto;
            }
            .message {
                padding: 10px;
                margin: 10px 20px;
                background: var(--palette-pale-grey-four, #eff4f8);
                text-align: center;
                border-radius: 3px;
            }
        </style>
        <liquid-config-aggregate-get id="getAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-discovery"
        context-data="[[prepareContextDataForLiquid(contextData)]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
           <pebble-resizable-panels>
                <div class="left-panel" panel-width="30%">
                    <rock-entity-graph-tree id="childFamilyTree" context-data="[[contextData]]" item-data="{{_itemData}}"></rock-entity-graph-tree>
                </div>
                <div class="right-panel" panel-width="70%">
                    <template is="dom-if" if="{{!_visibleMessageCard(_itemData)}}">
                        <template is="dom-if" if="[[applicationConfig.components]]">
                                    
                            <template is="dom-if" if="[[_isGridView]]">
                                <rock-relationship-manage mode="[[mode]]" context-data="[[_getContextData(applicationConfig.*)]]" config-context="[[_getConfigContext(applicationConfig.*)]]" 
                                no-of-columns="[[noOfColumns]]" do-sync-validation$="[[doSyncValidation]]"
                                relationship-grid-configs="[[_getRelationshipGridConfigs(applicationConfig.*)]]"></rock-relationship-manage>
                            </template>                    
                            <template is="dom-if" if="[[!_isGridView]]">
                                <div>

                                    <rock-entity-quick-manage id="entityQuickManage" context-data="[[contextData]]" current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]"
                                        selected-entity="[[_selectedEntity]]" tab-config="[[getQuickManageConfig('rock-entity-quick-manage', 'rock-tabs')]]"
                                        toolbar-config="[[getQuickManageConfig('rock-entity-quick-manage', 'pebble-toolbar')]]" fixes="[[getQuickManageConfig('rock-entity-quick-manage', 'rock-entity-tofix')]]"></rock-entity-quick-manage>
                                </div>
                            </template>
                        </template>
                    </template>
                    <template is="dom-if" if="{{_visibleMessageCard(_itemData)}}">
                        <div class="message">Select left section to see results.</div>
                    </template>
                </div>
            </pebble-resizable-panels>
    </template>
<script>
(function(){
    Polymer({
        is: "rock-entity-graph",
        properties:{
            contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            configContext: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            _itemData:{
                type:Object,
                value: function() {
                    return {};
                }
            },
            _isGridView:{
                type:Boolean,
                value: true
            },
            // configContext: {
            //     type: Object,
            //     value: function() {
            //         return {
            //             // "relationshipType": "Relationships",
            //             // "relationshipNames": [
            //             //     "productpresentationtolot",
            //             //     "ensembletoproductpresentation"
            //             // ],
            //             // "addRelationshipMode": "lov",
            //             // "relationshipTitle": "Lots",
            //             // "relationshipTypeName": "productpresentationtolot"
            //             };
            //     },
            //     notify: true
            // },
            mode: {
                type: String,
                value: function(){
                    return "view";
                }
            },
            noOfColumns: {
                type: Number,
                value: 3
            },
            doSyncValidation: {
                type: Boolean,
                value: true
            },
            relationshipGridConfigs: {
                type: Object,
                value: function () { return {}; }
            },
            clickedEntityTypes: {
                type: Array,
                value: function () { return []; }
            }
        },
        behaviors: [
            // RUFBehaviors.AppBehavior
            RUFBehaviors.ComponentContextBehavior,
			RUFBehaviors.UIBehavior
        ],
        observers: [
            '_itemClickHandler(_itemData)'
        ],
        _itemClickHandler: function(){
            if(this._itemData && !_.isEmpty(this._itemData)){
                if(this._itemData.viewMode && this._itemData.id && this._itemData.type){
                   // if(this.clickedEntityTypes[this.clickedEntityTypes.length-1] != this._itemData.id + "_" + this._itemData.relationshipName){
                        if(this._itemData.viewMode == "QUICK_MANAGE"){
                            this.contextData.ItemContexts = [];

                            //Image quick manage attributes are not coming when context data having contexts
                            if(this._itemData.type == "image"){
                                delete this.contextData.Contexts;
                            }
                            this.push('contextData.ItemContexts', {"id":this._itemData.id,"type":this._itemData.type});
                            this._isGridView = false;
                            setTimeout(() => {
                                this.shadowRoot.querySelector('#entityQuickManage').reload();
                            }, 0);
                        }
                         else if(this._itemData.viewMode == "GRID"){
                            // this.set("configContext", {"relationshipTypeName":this._itemData.relationshipName});
                            // this.contextData.ItemContexts = [];
                            // this.push('contextData.ItemContexts', {"id":this._itemData.id,"type":this._itemData.type, "relationships":[this._itemData.relationshipName], attributeNames:[], relationshipAttributes:[] });
                            var liquidElemet = this.shadowRoot.querySelector("#getAppConfig");
                            liquidElemet.contextData =  this._getContextData();
                            if(liquidElemet.appName != "app-entity-manage"){
                                liquidElemet.appName = "app-entity-manage";
                            }
                            liquidElemet.refresh();
                            this._isGridView = true;
                        }
                    //      this.clickedEntityTypes.push(this._itemData.id + "_" + this._itemData.relationshipName);
                    // }
                }
            }
        },
        _visibleMessageCard:function(){
            if(this._itemData && this._itemData.viewMode){
                return false;
            }
            return true;
        },
        _onApplicationConfigReceived: function (e) {
            
            if(e.detail){
                this.set('applicationConfig', {});
                this.set('applicationConfig', e.detail);
                
                // var components = e.detail.components;
                // if(components['rock-tabs'] && components['rock-tabs'].config && components['rock-tabs'].config.tabItems){
                    
                //     var rockTabItems =  components['rock-tabs'].config.tabItems;
                //     for (let i = 0; i < rockTabItems.length; i++) {
                //         const element = rockTabItems[i];
                //         if(element && element.name == "relationships"){
                //             if(element.component && element.component.properties){
                //                 if(element.component.properties['config-context']){
                //                     var configContext =  element.component.properties['config-context'];
                //                     configContext.relationshipNames = [this._itemData.relationshipName];
                //                     this.set('configContext', configContext);
                //                 }
                //                 if(element.component.properties['mode']){
                //                     this.set('mode', element.component.properties['mode']);
                //                 }
                //                 if(element.component.properties['do-sync-validation']){
                //                     this.set('doSyncValidation', element.component.properties['do-sync-validation']);
                //                 }
                //                 if(element.component.properties['no-of-columns']){
                //                     this.set('noOfColumns', element.component.properties['no-of-columns']);
                //                 }
                //             }
                //             break;
                //         }
                        
                //     }
                // }
                
                // var relationshipManageConfig = components["rock-relationship-manage"];
                // if(relationshipManageConfig){
                //     var relationshipGridConfig = relationshipManageConfig.config.relationshipGridConfig;
                //     var relationshipManage = this.shadowRoot.querySelector("rock-relationship-manage");
                //     if(relationshipManage){
                //         relationshipManage.set("relationshipGridConfigs", relationshipGridConfig);
                //         // relationshipManage.refresh();
                //     }
                // }
            }
        },
        // _getContextData:function(appConfig, itemData){
        //     if(this.applicationConfig && this.applicationConfig.components){
        //         var components = this.applicationConfig.components;
        //         if(components['rock-tabs'] && components['rock-tabs'].config && components['rock-tabs'].config.tabItems){
                    
        //             var rockTabItems =  components['rock-tabs'].config.tabItems;
        //             for (let i = 0; i < rockTabItems.length; i++) {
        //                 const element = rockTabItems[i];
        //                 if(element && element.name == "relationships"){
        //                     if(element.component && element.component.properties){
        //                         if(element.component.properties['mode']){
        //                             this.set('mode', element.component.properties['mode']);
        //                         }
        //                         if(element.component.properties['do-sync-validation']){
        //                             this.set('doSyncValidation', element.component.properties['do-sync-validation']);
        //                         }
        //                         if(element.component.properties['no-of-columns']){
        //                             this.set('noOfColumns', element.component.properties['no-of-columns']);
        //                         }
        //                         if(element.component.properties['config-context']){
        //                             var configContext =  element.component.properties['config-context'];
        //                             configContext.relationshipNames = [this._itemData.relationshipName];
                                    
        //                             this.set('configContext', configContext);
        //                             // var relationshipManageConfig = components["rock-relationship-manage"];
        //                             // if(relationshipManageConfig){
        //                             //     var relationshipGridConfig = relationshipManageConfig.config.relationshipGridConfig;
        //                             //     var relationshipManage = this.shadowRoot.querySelector("rock-relationship-manage");
        //                             //     if(relationshipManage){
        //                             //         relationshipManage.set("relationshipGridConfigs", {});
        //                             //         relationshipManage.set("relationshipGridConfigs", relationshipGridConfig);
        //                             //         // relationshipManage.refresh();
        //                             //     }
        //                             // }
        //                             break;
        //                         }
        //                     }
                           
        //                 }
                        
        //             }
        //         }
        //     }
        //     return this.configContext;
        // },
        _getContextData:function(){
            var contextData = DataHelper.cloneObject(this.contextData);
            if(contextData.ItemContexts && (contextData.ItemContexts.length == 1)){
                if(this._itemData.id){
                    contextData.ItemContexts[0].id = this._itemData.id;
                }
                if(this._itemData.relationshipName){
                    contextData.ItemContexts[0].relationships = [this._itemData.relationshipName];
                }
                if(this._itemData.type){
                    contextData.ItemContexts[0].type = this._itemData.type;
                }
            }
            // return this.contextData;
            // console.log(this.contextData)
            return contextData;
        },
        _getConfigContext:function(){
            var configContext = {"relationshipType":"Relationships"}
            if(this._itemData){
                if(this._itemData.relationshipName){
                    configContext.relationshipNames = [this._itemData.relationshipName];
                }
                configContext.relationshipTypeName = this._itemData.relationshipName;
            }
            return configContext;
        },
        _getRelationshipGridConfigs:function(){
            var gridConfigs = {};
            if(this.applicationConfig && this.applicationConfig.components){
                var components = this.applicationConfig["components"];
                var relationshipManageConfig = components["rock-relationship-manage"];
                if(relationshipManageConfig){
                    gridConfigs = relationshipManageConfig.config.relationshipGridConfig;
                }
            }
            return gridConfigs;
        },
        getQuickManageConfig: function (componentName, configName) {
            var componentConfig = {};
            if (this.applicationConfig && this.applicationConfig.components) {
                var components = this.applicationConfig["components"];
                var config = components[componentName].config;
                if (config) {
                    componentConfig = config[configName];
                }
            }
            return componentConfig;
        },
        prepareContextDataForLiquid: function(context){
            var contextData = DataHelper.cloneObject(context);
            if(contextData.ItemContexts){
                delete contextData['ItemContexts'];
            }
            return contextData;
        }
    });
})();
</script>
</dom-module>