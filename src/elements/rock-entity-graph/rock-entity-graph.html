<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-resizable-panels/pebble-resizable-panels.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-graph-tree/rock-entity-graph-tree.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">


<dom-module id="rock-entity-graph">
    <template>
        <style include="bedrock-styles-scroll-bar bedrock-style-common">
            :host{
                --rock-relationship-manage-message-card:{
                    display: none;
                }
                --quick-manage-header: {
                    display: none;
                }
                --rock-where-used-grid-govern-toggle:{
                    display: none;
                }
            }
            .graph-container{
                height: 100%;
                position:relative;
            }
            .left-panel{
                height: 100%;
                overflow: auto;
            }
            .right-panel{
                height: 100%;
                overflow: auto;
            }
            #variantGen {
                float: right;               
            }
            .default-message {
                padding: 10px;
                background: var(--palette-pale-grey-four, #eff4f8);
                font-size: var(--default-font-size, 14px);
                text-align: center;
                border-radius: 3px;
                font-weight: normal;
                line-height: 18px
            }
            rock-relationship-grid {
                --rock-relationship-grid-controls: {
                    padding: 0;
                    margin: 0;
                }               
            }

            rock-where-used-grid {
                --rock-where-used-grid-controls:{
                    padding: 0;
                    margin: 0;
                } 
            }
            
            rock-relationship-manage {
            --relationship-manage: {
                padding-top: 0;
            }
            }

        </style>
        <div class="graph-container">
            <template is="dom-if" if="[[_isGraphTreeConfigAvailable(_graphTreeConfig)]]" restamp>
                <pebble-resizable-panels>
                    <div class="left-panel" panel-width="30%">
                        <rock-entity-graph-tree id="graphTree" tree-config="[[_graphTreeConfig]]" context-data="[[contextData]]" item-data="{{selectedItem}}"></rock-entity-graph-tree> 
                    </div>
                    <div class="right-panel" panel-width="70%">
                        <template is="dom-if" if="[[_getVisibility('rock-variant-configurator')]]">
                            <pebble-button id="variantGen" class="btn btn-primary m-t-10 m-r-20 auto-width" button-text="Variant Configurator" raised on-tap="_onConfigureVariantsTap"></pebble-button>
                            <div class="clearfix"></div>
                        </template>
                        <template is="dom-if" if="{{!_visibleMessageCard(selectedItem)}}" restamp>
                            <template is="dom-if" if="[[_visibleGridView(selectedItem.viewMode, _panelContentLoaded)]]">
                                <rock-relationship-manage id="relationshipManage" class="p-t-10"></rock-relationship-manage>
                            </template>                    
                            <template is="dom-if" if="[[_visibleQuickManageView(selectedItem.viewMode, _panelContentLoaded)]]">
                                <rock-entity-quick-manage id="entityQuickManage" no-header></rock-entity-quick-manage>
                            </template>
                        </template>
                        <template is="dom-if" if="{{_visibleMessageCard(selectedItem)}}">
                            <div class="m-10"><div class="default-message">Select left section to see results.</div></div>
                        </template>
                    </div>
                </pebble-resizable-panels>
            </template>
            <bedrock-pubsub event-name="grid-data-refreshed" handler="_onRefreshGrid" ></bedrock-pubsub>
        </div>
    </template>
<script>
(function(){

    class RockEntityGraph
        extends Polymer.mixinBehaviors([
                    RUFBehaviors.ComponentContextBehavior,
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentConfigBehavior,
                    RUFBehaviors.AppBehavior
                ], Polymer.Element) {
        static get is() { return 'rock-entity-graph' }

        ready() {
            super.ready();
        }
        static get properties() {
            return {
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: "_onContextDataChange"
                },
                configData: {
					type: Object,
					value: function () { 
						return {}; 
					}
				},
                configContext: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                selectedItem:{
                    type:Object,
                    value: function() {
                        return {};
                    },
                    observer: "_onTreeItemChange"
                },
                _graphTreeConfig: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                _gridConfigLoaded:{
                    type:Boolean,
                    value:false
                },
                _panelContentLoaded:{
                    type:Boolean,
                    value:false
                },
                _entityContextData:{
                    type:Object,
                    value: function(){
                        return {};
                    }
                }
            }
        }
        _onContextDataChange(){
            if(!_.isEmpty(this.contextData)) {
                var context = DataHelper.cloneObject(this.contextData);
                //App specific
                var appName = ComponentHelper.getCurrentActiveAppName();
                if(appName) {
                    context[ContextHelper.CONTEXT_TYPE_APP] = [{
                        "app": appName
                    }];
                }
                this.requestConfig('rock-entity-graph', context);
            }
        }
        onConfigLoaded(componentConfig) {
            if(componentConfig && componentConfig.config) {
                this.configData = componentConfig.config;
                if(_.isEmpty(this._graphTreeConfig)){
                    this._graphTreeConfig = componentConfig.config.entityGraphTreeConfig;
                }else{
                    this._onGridConfigLoaded(componentConfig.config);
                }
            }   
        }

        /**
         * Checks if the given component is visible or not
         */ 
         _getVisibility(componentName) {
            if (typeof (this.configData) == "object") {
                if(this.configData.componentsVisibility) {
                    return this.configData.componentsVisibility[componentName];
                }
            }
        }

        refresh(){
            this._onRefreshGrid();
        }
        _onRefreshGrid(ev){
            if(this.selectedItem && !_.isEmpty(this.selectedItem)){
                var graphTree = this.shadowRoot.querySelector("#graphTree");
                if(graphTree){
                    graphTree.reRenderTreeChildList();
                }
                var relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
                if(relationshipManage){
                    relationshipManage.refresh()
                }
                var quickManageDom = this.shadowRoot.querySelector('#entityQuickManage');
                if(quickManageDom){
                    quickManageDom.refresh();
                }
            }
        }
        _isGraphTreeConfigAvailable(graphTreeConfig) {
            if(!_.isEmpty(graphTreeConfig)) {
                return true;
            }
            return false;
        }
        _onTreeItemChange(){
            if(!_.isEmpty(this.selectedItem) && this.selectedItem.viewMode){
                this.set("_entityContextData", this._getEntityContextData());
                
                
                if(this._isGridView()){
                    this.set("_panelContentLoaded", false);
                    var context = DataHelper.cloneObject(this._entityContextData);
                    context[ContextHelper.CONTEXT_TYPE_APP] = [{
                        "app": "app-entity-manage"
                    }];
                    this.requestConfig("rock-entity-detail-tabs", context);
                }else{
                    this.set("_panelContentLoaded", true);
                    Polymer.Async.timeOut.after(100).run(() => {
                        this._reloadQuickManage();
                    })
                }

            }else{
                this.set("_entityConfigContext", {});
                this.set("_entityContextData", {});
            }
        }
        _reloadQuickManage(){
            var quickManageDom = this.shadowRoot.querySelector('#entityQuickManage');
            if(quickManageDom){
                quickManageDom.reset();
                quickManageDom.contextData= this._entityContextData;
                quickManageDom.selectedEntity = {id:this.selectedItem.id, type:this.selectedItem.type}
                quickManageDom.reloadHeader();
            }
        }
        _reloadGrid(mode, doSyncValidation, noOfColumns, configContext){
            var relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
            if(relationshipManage){
                relationshipManage.reset();
                Polymer.Async.microTask.run(() => {
                    relationshipManage.mode = mode;
                    relationshipManage.doSyncValidation = doSyncValidation;
                    relationshipManage.noOfColumns = noOfColumns;
                    relationshipManage.configContext = configContext;
                    relationshipManage.contextData = this._entityContextData;
                });
            }
        }
        _visibleMessageCard(_selectedItem){
            if(_selectedItem && _selectedItem.viewMode){
                return false;
            }
            return true;
        }
        _visibleGridView(_selectedItem){
            if(this.selectedItem && this.selectedItem.viewMode  && this._isGridView() && this._panelContentLoaded){
                return true;
            }
            return false;
        }
        _visibleQuickManageView(){
            if(this.selectedItem && this.selectedItem.viewMode  && !this._isGridView() && this._panelContentLoaded){
                return true;
            }
            return false;
        }
        _isGridView(){
            return this.selectedItem && (this.selectedItem.viewMode == "GRID");
        }
        _isAssets(){
            if(this.selectedItem && this.selectedItem.type){
                if(this.selectedItem.type == "image" || this.selectedItem.type == "video" ||
                                this.selectedItem.type == "document" || this.selectedItem.type == "audio"){
                    return true;
                }
            }
            return false;
        }
        _onGridConfigLoaded(tabConfig){
            var configContext = {};
            var mode, doSyncValidation, noOfColumns;
            if(this.selectedItem){
                if(this.selectedItem.relationshipName){
                    configContext.relationshipNames = [this.selectedItem.relationshipName];
                }
                if(this.selectedItem.relationshipOwnership && this.selectedItem.relationshipOwnership == "whereused"){
                    configContext.direction = "up";
                    if(this.selectedItem.type){
                        configContext.fromEntityType = this.selectedItem.type
                    }
                }
                configContext.relationshipTypeName = this.selectedItem.relationshipName;
            }
            if(tabConfig && !_.isEmpty(tabConfig)){
                var componentProperties;
                if(tabConfig.tabItems){
                    if(this._isAssets() && tabConfig.tabItems.assets){
                        var assetComponent = tabConfig.tabItems.assets;
                        if(assetComponent.component && assetComponent.component.properties){
                            componentProperties = assetComponent.component.properties;
                        }
                    }else if(tabConfig.tabItems.relationships && !configContext.direction){
                        var relComponent = tabConfig.tabItems.relationships;
                        if(relComponent.component && relComponent.component.properties){
                            componentProperties = relComponent.component.properties;
                        }
                    }
                }
                if(componentProperties && !_.isEmpty(componentProperties)){
                    if(componentProperties['config-context']){
                        var _configContext =  componentProperties['config-context'];
                        if(_configContext.addRelationshipMode){
                            configContext["addRelationshipMode"] = _configContext.addRelationshipMode;
                        }
                        if(_configContext.relationshipType){
                            configContext["relationshipType"] = _configContext.relationshipType;
                        }
                    }
                    if(componentProperties['mode']){
                        mode = componentProperties['mode'];
                    }
                    if(componentProperties['do-sync-validation']){
                        doSyncValidation = componentProperties['do-sync-validation'];
                    }
                    if(componentProperties['no-of-columns']){
                        noOfColumns = componentProperties['no-of-columns'];
                    }
                }
            }
            this.set("_panelContentLoaded", true);
            Polymer.Async.timeOut.after(100).run(() => {
                this._reloadGrid(mode, doSyncValidation, noOfColumns, configContext);
            })
        
        }
        _getEntityContextData(){
            var contextData = DataHelper.cloneObject(this.contextData);
            
            if(this.selectedItem && !_.isEmpty(this.selectedItem)){
                var itemContext = {}
                if(this.selectedItem.id){
                    itemContext.id = this.selectedItem.id;
                }
                if(this.selectedItem.relationshipName){
                    itemContext.relationships = [this.selectedItem.relationshipName];
                }
                if(this.selectedItem.type){
                    itemContext.type = this.selectedItem.type;
                }
                
                if(this._isGridView()){
                    if(this.selectedItem.parentType){
                        itemContext.type = this.selectedItem.parentType;
                    }
                }
                if(this._isAssets()){
                    contextData.Contexts = [];
                    if(!this._isGridView()){
                        contextData[ContextHelper.CONTEXT_TYPE_DOMAIN] = [{domain:"digitalAsset"}];
                    }
                }
                contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
            }else{
                delete contextData['ItemContexts'];
            }
            return contextData;
        }

        _onConfigureVariantsTap() {
            this.openBusinessFunctionDialog({name: 'rock-wizard-variant-configurator'});
        }
    }

    customElements.define(RockEntityGraph.is, RockEntityGraph)

})();
</script>
</dom-module>
