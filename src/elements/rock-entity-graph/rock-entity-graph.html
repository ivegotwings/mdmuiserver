<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-resizable-panels/pebble-resizable-panels.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-graph-tree/rock-entity-graph-tree.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../rock-classification-tree/rock-classification-tree.html">

<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">


<dom-module id="rock-entity-graph">
    <template>
        <style include="bedrock-styles-scroll-bar bedrock-style-common">
            :host{
                display: block;
                height: 100%;
                --quick-manage-header: {
                    display: none;
                }
                --rock-where-used-grid-govern-toggle:{
                    display: none;
                }
                --pebble-vertical-divider: {
                    background-color: #c1cad4;
                    height: 100%;
                    border: 0px;
                    min-height: 0px;
                    width: 2px;
                    margin-top: 0px;
                    margin-right: 0px;
                    margin-bottom: 0px;
                    margin-left: 0px;
                }
            }
            .graph-container{
                height: 100%;
                position:relative;
            }
            .only-attribute .only-attribute-container{
                display: grid;
                display: -ms-grid;
                -ms-grid-rows: max-content 1fr;
                grid-template-rows: max-content 1fr;
                -ms-grid-columns: 1fr;
                grid-template-columns: 1fr;
                height: 100%;
            }

            .only-attribute .only-attribute-container .col-8-4-grid-child-1 {
                -ms-grid-row: max-content;
                -ms-grid-column: 1;
                min-width:0px;                
            }

            .only-attribute .only-attribute-container .col-8-4-grid-child-2 {
                -ms-grid-row: 2;
                -ms-grid-column: 1;
                min-width:0px;
                min-height: 0px;
            }

            .message {
                padding: 10px;
                margin: 10px 20px;
                background: var(--palette-pale-grey-four, #eff4f8);
                text-align: center;
                border-radius: 3px;
            }
            .graph-grid-wrapper,.grid-container{
                height:100%;
            }
            .left-panel{
                height: 100%;
                overflow: auto;
            }
            .right-panel{
                height: 100%;
                overflow: auto;
            }
            #variantGen {
                float: right;               
            }
           
        </style>
        <div class="graph-container">
            <liquid-entity-data-get id="rootNodeGet" operation="getbyids" on-error="_onLineagePathError"
                on-response="_onRootNodeGetResponse" exclude-in-progress></liquid-entity-data-get>
            <liquid-entity-model-get id="liquidModelGet" operation="getbyids" request-data="[[_modelRequest]]" on-response="_onModelReceived" on-error="_onModelGetFailed"></liquid-entity-model-get>
        
            <template is="dom-if" if="[[_isGraphTreeConfigAvailable(_graphTreeConfig)]]" restamp>
                <pebble-resizable-panels>
                    <div class="left-panel" panel-width="30%">
                        <template is="dom-if" if="[[_isClassificationTree(_graphTreeConfig)]]">
                            <rock-classification-tree id="classificationTree" taxonomy="[[taxonomy]]" is-model-tree="[[isModelTree]]"
                                context-data="[[contextData]]" multi-select="[[multiSelect]]" leaf-node-only="[[leafNodeOnly]]"
                                enable-node-click="true" hide-leaf-node-checkbox="[[hideLeafNodeCheckbox]]" root-node-data="{{_rootNodeData}}"></rock-classification-tree> 
                        </template>
                        <template is="dom-if" if="[[!_isClassificationTree(_graphTreeConfig)]]">
                            <rock-entity-graph-tree id="graphTree" tree-config="[[_graphTreeConfig]]" context-data="[[contextData]]" item-data="{{selectedItem}}"></rock-entity-graph-tree> 
                        </template>
                    </div>
                    <div class="right-panel" panel-width="70%">
                        <div class="base-grid-structure">
                            <div class="base-grid-structure-child-1">
                                <template is="dom-if" if="[[_getVisibility('rock-variant-configurator')]]">
                                    <pebble-button id="variantGen" class="btn btn-primary m-t-10 m-r-20 auto-width" button-text="Variant Configurator" raised on-tap="_onConfigureVariantsTap"></pebble-button>
                                    <div class="clearfix"></div>
                                </template>
                            </div>
                            <div class$="base-grid-structure-child-2 [[onlyAttribute]]">
                                <template is="dom-if" if="{{!_visibleMessageCard(selectedItem)}}" restamp>
                                    <div class="graph-grid-wrapper only-attribute-container">	
                                        <div class="grid-container col-8-4-grid-child-1">
                                            <template is="dom-if" if="[[_visibleGridView(selectedItem.viewMode, _panelContentLoaded)]]">
                                                <rock-relationship-manage id="relationshipManage"></rock-relationship-manage>
                                            </template>  
                                        </div>
                                        <div class="col-8-4-grid-child-2">               
                                            <template is="dom-if" if="[[_visibleQuickManageView(selectedItem.viewMode, _panelContentLoaded)]]">
                                                <rock-entity-quick-manage id="entityQuickManage" no-header></rock-entity-quick-manage>
                                            </template>
                                        </div>   
                                    </div>
                                </template>
                                <template is="dom-if" if="{{_visibleMessageCard(selectedItem)}}">
                                    <div class="m-10"><div class="default-message">Select left section to see results.</div></div>
                                </template>
                            </div>
                        </div>
                    </div>
                </pebble-resizable-panels>
            </template>
            <bedrock-pubsub event-name="classification-item-clicked" handler="_onClassificationClickHandler" target-id="classificationTree"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-data-refreshed" handler="_onRefreshTree" ></bedrock-pubsub>
        </div>
    </template>
<script>
(function(){

    class RockEntityGraph
        extends Polymer.mixinBehaviors([
                    RUFBehaviors.ComponentContextBehavior,
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentConfigBehavior,
                    RUFBehaviors.AppBehavior
                ], Polymer.Element) {
        static get is() { return 'rock-entity-graph' }

        ready() {
            super.ready();
        }
        static get properties() {
            return {
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: "_onContextDataChange"
                },
                configData: {
					type: Object,
					value: function () { 
						return {}; 
					}
				},
                configContext: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                onlyAttribute:{
                    type:String,
                    value:""
                },
                selectedItem:{
                    type:Object,
                    value: function() {
                        return {};
                    },
                    observer: "_onTreeItemChange"
                },
                _graphTreeConfig: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                _gridConfigLoaded:{
                    type:Boolean,
                    value:false
                },
                _panelContentLoaded:{
                    type:Boolean,
                    value:false
                },
                _entityContextData:{
                    type:Object,
                    value: function(){
                        return {};
                    }
                },
                taxonomy:{
                    type:String,
                    value:""
                },
                multiSelect:{
                    type:Boolean,
                    value:false
                },
                leafNodeOnly:{
                    type:Boolean,
                    value:true
                },
                hideLeafNodeCheckbox:{
                    type:Boolean,
                    value:true
                },
                _selectedClassificationNode:{
                    type:Object
                },
                isModelTree:{
                    type:Boolean,
                    value:true
                },
                _rootNodeData:{
                    type:Object,
                    value: function(){
                        return {}
                    },
                    notify:true
                }
            }
        }
        static get observers(){
            return [
                
            ]
        }
        _onContextDataChange(){
            if(!_.isEmpty(this.contextData)) {
                var context = DataHelper.cloneObject(this.contextData);
                //App specific
                var appName = ComponentHelper.getCurrentActiveAppName();
                if(appName) {
                    context[ContextHelper.CONTEXT_TYPE_APP] = [{
                        "app": appName
                    }];
                }
                this.requestConfig('rock-entity-graph', context);
            }
        }
        onConfigLoaded(componentConfig) {
            if(componentConfig && componentConfig.config) {
                this.configData = componentConfig.config;
                if(_.isEmpty(this._graphTreeConfig)){
                    this._graphTreeConfig = componentConfig.config.entityGraphTreeConfig;
                    if(this._graphTreeConfig.isClassificationTree){
                        this._initiateClassificationTree();    
                    }
                }else{
                    this._onGridConfigLoaded(componentConfig.config);
                }
            }   
        }
        _isClassificationTree(){
            if(this._graphTreeConfig && this._graphTreeConfig.isClassificationTree){
                return true;
            }
            return false;
        }
        _initiateClassificationTree(){
            var rootNodeGet = this.shadowRoot.querySelector("#rootNodeGet");
            if(rootNodeGet){
                rootNodeGet.requestData = DataRequestHelper.createEntityGetRequest(this.contextData);
                rootNodeGet.generateRequest();
            }
        }
        _onRootNodeGetResponse(ev){
            var rootNodeData = {}
            if(DataHelper.isValidObjectPath(ev, "detail.response.content.entities.0.data")){
                rootNodeData['text'] = this._getNodeTitle(ev.detail.response.content.entities[0], this._graphTreeConfig.treeNodeTitle);
            }
            rootNodeData.isRootNode = true;
            rootNodeData.expanded = true;
            if(DataHelper.isValidObjectPath(this._graphTreeConfig, "relationships.0.relationshipName")){
                var relationshipName = this._graphTreeConfig.relationships[0].relationshipName;
                rootNodeData.relationshipName = relationshipName;
                rootNodeData.relationshipOwnership = "whereused";
            }

            //start classification request
            if (!this.taxonomy || this.taxonomy == "undefined") {
                var firstItemContext = ContextHelper.getFirstItemContext(this.contextData);
                if(firstItemContext && firstItemContext.id){
                    this.taxonomy = firstItemContext.id;
                    rootNodeData.id = firstItemContext.id;
                    if(firstItemContext.type){
                        rootNodeData.type = firstItemContext.type;
                    }
                }
            }
            if(this.taxonomy){
                Polymer.Async.timeOut.after(30).run(() => {
                    this.set("_rootNodeData", rootNodeData);
                    const contextTree = this.shadowRoot.querySelector("#classificationTree");
                    if (contextTree) {
                        contextTree.generateRequest();
                    }
                })
            }else{
                console.warn("No taxonomy found.")
            }
        }
        _getNodeTitle(entity, attribute){
            var _title = "";
            if(entity && attribute){
                if(attribute.indexOf("attribute:") > -1){
                    var _keyName = attribute.substr(10, attribute.length);
                    var _attribute;
                    if(entity.data){
                        _attribute = EntityHelper.getAttribute(entity, _keyName);
                    }else{
                        if(entity.attributes && entity.attributes[_keyName]){
                            _attribute = entity.attributes[_keyName];
                        }
                    }
                    _title = AttributeHelper.getFirstAttributeValue(_attribute);
                }else{
                    _title = attribute;
                }
            }
            if(!_title && entity.id){
                _title = entity.id;
            }
            return _title;
        }
        _onClassificationClickHandler(ev){
            var selectedNode = ev.detail;
            if(selectedNode){
                selectedNode.highlightNode = true;
                if(!_.isEmpty(this._selectedClassificationNode)){
                    this._selectedClassificationNode.highlightNode = false;
                }
                this._selectedClassificationNode = selectedNode;
                if(selectedNode.nodeData){
                    var clonedClassification = DataHelper.cloneObject(selectedNode.nodeData);
                    clonedClassification.viewMode = "GRID";
                    this.set("selectedItem", clonedClassification);
                }
            }
        }
        _initiateModelRequest(){
            if(!this.selectedItem.modelLoaded){
                var entityModelElement = this.shadowRoot.querySelector("#liquidModelGet");
                if(entityModelElement){
                    if(this.selectedItem.isRootNode){
                        var ids = [this.selectedItem.relationshipName+"_relationshipModel"];
                        entityModelElement.requestData = DataRequestHelper.createGetModelRequest("relationshipModel", ids);
                        entityModelElement.generateRequest();
                    }
                }
            }else{
                this._onGridConfigLoaded();
            }
        }
        _onModelReceived(ev){

            // this.selectedItem.modelResponse = ev.
            this.selectedItem.modelLoaded = true;
            this._onGridConfigLoaded();
        }
        /**
         * Checks if the given component is visible or not
         */ 
         _getVisibility(componentName) {
            if (typeof (this.configData) == "object") {
                if(this.configData.componentsVisibility) {
                    return this.configData.componentsVisibility[componentName];
                }
            }
        }

        refresh(){
            this._onRefreshGrid();
        }
        _onRefreshTree(ev){
            if(this.selectedItem && !_.isEmpty(this.selectedItem)){
                var graphTree = this.shadowRoot.querySelector("#graphTree");
                if(graphTree){
                    graphTree.reRenderTreeChildList();
                }
            }
        }
        _onRefreshGrid(ev){
            var relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
            if(relationshipManage){
                relationshipManage.refresh()
            }
            var quickManageDom = this.shadowRoot.querySelector('#entityQuickManage');
            if(quickManageDom){
                quickManageDom.refresh();
            }
        }
        _isGraphTreeConfigAvailable(graphTreeConfig) {
            if(!_.isEmpty(graphTreeConfig)) {
                return true;
            }
            return false;
        }
        _onTreeItemChange(){
            if(!_.isEmpty(this.selectedItem) && this.selectedItem.viewMode){
                this.set("_entityContextData", this._getEntityContextData());
                
                if(this._isClassificationTree()){
                    this._onGridConfigLoaded();
                    return;
                }
                if(this._isGridView()){
                    this.set("_panelContentLoaded", false);
                    var context = DataHelper.cloneObject(this._entityContextData);
                    context[ContextHelper.CONTEXT_TYPE_APP] = [{
                        "app": "app-entity-manage"
                    }];
                    this.requestConfig("rock-entity-detail-tabs", context);
                }else{
                    this.set("_panelContentLoaded", true);
                    Polymer.Async.timeOut.after(100).run(() => {
                        this._reloadQuickManage();
                    })
                }

            }else{
                this.set("_entityConfigContext", {});
                this.set("_entityContextData", {});
            }
        }
        _reloadQuickManage(){
            var quickManageDom = this.shadowRoot.querySelector('#entityQuickManage');
            if(quickManageDom){
                quickManageDom.reset();
                quickManageDom.contextData= this._entityContextData;
                quickManageDom.selectedEntity = {id:this.selectedItem.id, type:this.selectedItem.type}
                quickManageDom.reloadHeader();
            }
        }
        _reloadGrid(mode, doSyncValidation, noOfColumns, configContext){
            var relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
            if(relationshipManage){
                relationshipManage.reset();
                Polymer.Async.microTask.run(() => {
                    relationshipManage.mode = mode;
                    relationshipManage.doSyncValidation = doSyncValidation;
                    relationshipManage.noOfColumns = noOfColumns;
                    relationshipManage.configContext = configContext;
                    relationshipManage.contextData = this._entityContextData;
                });
            }
        }
        _visibleMessageCard(_selectedItem){
            if(_selectedItem && _selectedItem.viewMode){
                return false;
            }
            return true;
        }
        _visibleGridView(_selectedItem){
            if(this.selectedItem && this.selectedItem.viewMode  && this._isGridView() && this._panelContentLoaded){
                return true;
            }
            return false;
        }
        _visibleQuickManageView(){
            this.set("onlyAttribute","");
            if(this.selectedItem && this.selectedItem.viewMode  && !this._isGridView() && this._panelContentLoaded){
                this.set("onlyAttribute","only-attribute");
                return true;
            }            
            return false;
        }
        _isGridView(){
            return this.selectedItem && (this.selectedItem.viewMode == "GRID");
        }
        _isAssets(){
            if(this.selectedItem && this.selectedItem.type){
                if(this.selectedItem.type == "image" || this.selectedItem.type == "video" ||
                                this.selectedItem.type == "document" || this.selectedItem.type == "audio"){
                    return true;
                }
            }
            return false;
        }
        _onGridConfigLoaded(tabConfig){
            var configContext = {};
            var mode, doSyncValidation, noOfColumns;
            if(this.selectedItem){
                if(this.selectedItem.relationshipName){
                    configContext.relationshipNames = [this.selectedItem.relationshipName];
                }
                if(this.selectedItem.relationshipOwnership && this.selectedItem.relationshipOwnership == "whereused"){
                    configContext.direction = "up";
                    if(this.selectedItem.type){
                        configContext.fromEntityType = this.selectedItem.type
                    }
                }
                configContext.relationshipTypeName = this.selectedItem.relationshipName;
            }
            if(tabConfig && !_.isEmpty(tabConfig)){
                var componentProperties;
                if(tabConfig.tabItems){
                    if(this._isAssets() && tabConfig.tabItems.assets){
                        var assetComponent = tabConfig.tabItems.assets;
                        if(assetComponent.component && assetComponent.component.properties){
                            componentProperties = assetComponent.component.properties;
                        }
                    }else if(tabConfig.tabItems.relationships && !configContext.direction){
                        var relComponent = tabConfig.tabItems.relationships;
                        if(relComponent.component && relComponent.component.properties){
                            componentProperties = relComponent.component.properties;
                        }
                    }
                }
                if(componentProperties && !_.isEmpty(componentProperties)){
                    if(componentProperties['config-context']){
                        var _configContext =  componentProperties['config-context'];
                        if(_configContext.addRelationshipMode){
                            configContext["addRelationshipMode"] = _configContext.addRelationshipMode;
                        }
                        if(_configContext.relationshipType){
                            configContext["relationshipType"] = _configContext.relationshipType;
                        }
                    }
                    if(componentProperties['mode']){
                        mode = componentProperties['mode'];
                    }
                    if(componentProperties['do-sync-validation']){
                        doSyncValidation = componentProperties['do-sync-validation'];
                    }
                    if(componentProperties['no-of-columns']){
                        noOfColumns = componentProperties['no-of-columns'];
                    }
                }
            }else if(this._isClassificationTree()){
                if(this.selectedItem.relationshipType){
                    configContext["relationshipType"] = this.selectedItem.relationshipName;
                }
                if(this.selectedItem.isRootNode){
                    configContext.fromEntityType = "classification"
                }
            }
            this.set("_panelContentLoaded", true);
            Polymer.Async.timeOut.after(100).run(() => {
                this._reloadGrid(mode, doSyncValidation, noOfColumns, configContext);
            })
        
        }
        _getEntityContextData(){
            var contextData = DataHelper.cloneObject(this.contextData);
            
            if(this.selectedItem && !_.isEmpty(this.selectedItem)){
                var itemContext = {}
                if(this.selectedItem.id){
                    itemContext.id = this.selectedItem.id;
                }
                if(this.selectedItem.relationshipName){
                    itemContext.relationships = [this.selectedItem.relationshipName];
                }
                if(this.selectedItem.type){
                    itemContext.type = this.selectedItem.type;
                }
                
                if(this._isGridView()){
                    if(this.selectedItem.parentType){
                        itemContext.type = this.selectedItem.parentType;
                    }
                }
                if(this._isAssets()){
                    contextData.Contexts = [];
                    if(!this._isGridView()){
                        contextData[ContextHelper.CONTEXT_TYPE_DOMAIN] = [{domain:"digitalAsset"}];
                    }
                }
                contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
            }else{
                delete contextData['ItemContexts'];
            }
            return contextData;
        }

        _onConfigureVariantsTap() {
            this.openBusinessFunctionDialog({name: 'rock-wizard-variant-configurator'});
        }
    }

    customElements.define(RockEntityGraph.is, RockEntityGraph)

})();
</script>
</dom-module>
