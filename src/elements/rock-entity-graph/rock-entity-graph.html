<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../pebble-resizable-panels/pebble-resizable-panels.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-graph-tree/rock-entity-graph-tree.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">


<dom-module id="rock-entity-graph">
    <template>
        <style include="bedrock-styles-scroll-bar bedrock-style-common">
            :host{
                --rock-relationship-manage-message-card:{
                    display: none;
                }
                --quick-manage-header: {
                    display: none;
                }
                --rock-where-used-grid-govern-toggle:{
                    display: none;
                }
            }
            .graph-container{
                height: 100%;
                position:relative;
            }
            .left-panel{
                height: 100%;
                overflow: auto;
            }
            .right-panel{
                height: 100%;
                overflow: auto;
            }
            .message {
                padding: 10px;
                margin: 10px 20px;
                background: var(--palette-pale-grey-four, #eff4f8);
                text-align: center;
                border-radius: 3px;
            }
        </style>
        <liquid-config-get id="getConfig" operation="getbyids" request-data="[[_configRequest]]" on-response="_onConfigsGetResponse"></liquid-config-get>
            <div class="graph-container">
                <pebble-resizable-panels>
                    <div class="left-panel" panel-width="30%">
                        <template is="dom-if" if="[[_isGraphTreeConfigAvailable(_graphTreeConfig)]]" restamp>
                            <rock-entity-graph-tree id="graphTree" tree-config="[[_graphTreeConfig]]" context-data="[[contextData]]" item-data="{{_itemData}}"></rock-entity-graph-tree>
                        </template>
                    </div>
                    <div class="right-panel" panel-width="70%">
                        <template is="dom-if" if="{{!_visibleMessageCard(_itemData)}}">
                                        
                            <template is="dom-if" if="[[_visibleGridView(_itemData, _appConfigLoaded)]]">
                                <rock-relationship-manage id="relationshipManage" mode="[[_getGridConfig('mode', _gridConfig)]]" context-data="[[_entityContextData]]" config-context="[[_entityConfigData]]" 
                                no-of-columns="[[_getGridConfig('noOfColumns', _gridConfig)]]" do-sync-validation$="[[_getGridConfig('doSyncValidation', _gridConfig)]]" ></rock-relationship-manage>
                            </template>                    
                            <template is="dom-if" if="[[_visibleQuickManageView(_itemData, _appConfigLoaded)]]">
                                <rock-entity-quick-manage no-header id="entityQuickManage" current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]"
                                        selected-entity="[[_selectedEntity]]"></rock-entity-quick-manage>
                            </template>
                            
                        </template>
                        <template is="dom-if" if="{{_visibleMessageCard(_itemData)}}">
                            <div class="m-20"><div class="default-message">Select left section to see results.</div></div>
                        </template>
                    </div>
                </pebble-resizable-panels>
            </div>
            <bedrock-pubsub event-name="grid-data-refreshed" handler="_onRefreshGrid" ></bedrock-pubsub>
    </template>
<script>
(function(){
    Polymer({
        is: "rock-entity-graph",
        properties:{
            contextData: {
                type: Object,
                value: function () {
                    return {};
                },
                observer: "_onContextDataChange"
            },
            configContext: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            _itemData:{
                type:Object,
                value: function() {
                    return {};
                }
            },
            _graphTree:{
                type:Element
            },
            _configLiquidElement:{
                type:Element
            },
            _entityConfigData:{
                type: Object,
                value: function(){
                    return {};
                }
            },
            _entityContextData:{
                type: Object,
                value: function(){
                    return {};
                }
            },
            _appConfigLoaded:{
                type:Boolean,
                value:false
            },
            _relationshipTabsConfigs: {
                type: Object,
                value: function () { return {}; }
            },
            _quickManageConfig:{
                type:Object,
                value:function(){
                    return {};
                }
            },
            _gridConfig:{
                type:Object,
                value:function(){
                    return {};
                }
            },
            _configRequest:{
                type:Object,
                value:function(){
                    return {};
                }
            },
            _graphTreeConfig: {
                type: Object,
                value: function() {
                    return {};
                }
            }
        },
        behaviors: [
            RUFBehaviors.ComponentContextBehavior,
			RUFBehaviors.UIBehavior,
            RUFBehaviors.ComponentConfigBehavior
        ],
        observers: [
            '_itemClickHandler(_itemData)'
        ],
        attached:function(){
            this._graphTree = this.shadowRoot.querySelector("#graphTree");
            this._configLiquidElement = this.shadowRoot.querySelector("#getConfig");
        },
        _onContextDataChange: function() {
            if(!_.isEmpty(this.contextData)) {
                var context = DataHelper.cloneObject(this.contextData);
                //App specific
                var appName = ComponentHelper.getCurrentActiveAppName();
                if(appName) {
                    context[ContextHelper.CONTEXT_TYPE_APP] = [{
                        "app": appName
                    }];
                }
                    
                this.requestConfig('rock-entity-graph', context);
            }
        },
        onConfigLoaded: function(componentConfig) {
            if(componentConfig && componentConfig.config) {
                this._graphTreeConfig = componentConfig.config.entityGraphTreeConfig;
            }   
        },
        _isGraphTreeConfigAvailable: function(graphTreeConfig) {
            if(!_.isEmpty(graphTreeConfig)) {
                return true;
            }

            return false;
        },
        _onRefreshGrid:function(ev){
            if(this._itemData && !_.isEmpty(this._itemData)){
                this._graphTree.reRenderTreeChildList();
            }
        },
        _isAssets: function(){
            if(this._itemData && this._itemData.type){
                if(this._itemData.type == "image" || this._itemData.type == "video" ||
                                this._itemData.type == "document" || this._itemData.type == "audio"){
                    return true;
                }
            }
            return false;
        },
        _onConfigsGetResponse: function(ev){
            if(ev.detail && ev.detail.response){
                if(this._itemData && !_.isEmpty(this._itemData)){
                    var res = ev.detail.response;
                    if(!_.isEmpty(res)){
                        if(res.content && res.content.configObjects){

                            var config;
                            for (let i = 0; i < this._itemData.requestObjects.length; i++) {
                                const reqObj = this._itemData.requestObjects[i];
                                
                                config = DataHelper.findEntityById(res.content.configObjects, reqObj.params.query.name+"_uiConfig");
                                if(config && config.data && config.data.contexts){
                                    reqObj.requestLoaded = true;
                                    var _contexts = config.data.contexts;
                                    if(_contexts && _contexts.length > 0 && _contexts[0].jsonData){
                                        if(_contexts[0].jsonData.config){
                                            var jsonConfig = _contexts[0].jsonData.config;
                                            if(this._itemData.viewMode == "GRID"){
                                                    if(jsonConfig.relationshipGridConfig){
                                                        this.set("_gridConfig.relationshipGridConfigs", jsonConfig.relationshipGridConfig);
                                                        this.set("_gridConfig.relationshipTypeList", []);
                                                        this.set("_entityConfigData", this._getConfigContext());
                                                        
                                                        var relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
                                                        if(relationshipManage){
                                                            relationshipManage.relationshipTypeList = [];
                                                            relationshipManage.relationshipGridConfigs = this._gridConfig.relationshipGridConfigs;
                                                            this.set('_appConfigLoaded', true);
                                                        }else{
                                                            this.set('_appConfigLoaded', true);
                                                            setTimeout(() => {
                                                                relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
                                                                if(relationshipManage){
                                                                    relationshipManage.relationshipTypeList = [];
                                                                    relationshipManage.relationshipGridConfigs = this._gridConfig.relationshipGridConfigs;
                                                                }
                                                            }, 0);
                                                        }
                                                    }else{                                                       
                                                        this.set("_relationshipTabsConfigs", jsonConfig);
                                                        this._configRequest = this._itemData.requestObjects[1];
                                                        this._configLiquidElement.generateRequest();
                                                    }
                                            }else{
                                                this._quickManageConfig = jsonConfig;
                                                setTimeout(() => {
                                                    var quickManageDom = this.shadowRoot.querySelector('#entityQuickManage');
                                                    if(quickManageDom){
                                                        quickManageDom.reset();
                                                        quickManageDom.contextData= this._entityContextData;
                                                        quickManageDom.tabConfig = this._quickManageConfig['rock-tabs'];
                                                        quickManageDom.toolbarConfig = this._quickManageConfig['pebble-toolbar'];
                                                        quickManageDom.fixes = this._quickManageConfig['rock-entity-tofix'];
                                                        quickManageDom.reloadHeader();
                                                    }
                                                }, 0);
                                                this.set('_appConfigLoaded', true);
                                            }
                                        }

                                    }
                                }

                            }

                        }
                    }
                    
                }
            }
        },
        _itemClickHandler: function(){
            if(this._itemData && !_.isEmpty(this._itemData)){
                if(this._itemData.viewMode && this._itemData.id && this._itemData.type){
                    this.set('_appConfigLoaded', false);
                    this.set("_gridConfig", {});
                    this.set("_quickManageConfig", {});
                    this.set("_relationshipTabsConfigs", {});
                    this.set("_entityConfigData", {});
                    this.set("_entityContextData", {});
                    this.set("_entityContextData", this._getContextData());
                    var reqObj;
                    if(this._itemData.viewMode == "QUICK_MANAGE"){
                        var _appName = "app-entity-discovery";
                        if(this._isAssets()){
                            _appName = "app-assets-discovery";
                        }
                        reqObj = this._getConfigRequest(_appName, "rock-entity-quick-manage");
                        this._itemData.requestObjects = [reqObj]
                    }else if(this._itemData.viewMode == "GRID"){
                        reqObj = this._getConfigRequest("app-entity-manage", "rock-relationship-manage");
                        var tabsReqObj = this._getConfigRequest("app-entity-manage", "rock-tabs");
                        this._itemData.requestObjects = [tabsReqObj, reqObj];
                    }
                    this._configRequest = this._itemData.requestObjects[0];
                    this._configLiquidElement.generateRequest();

                }
            }
        },
        _getConfigRequest: function(_appName, _componentName){
            var reqObj = {}
            var itemContext = ContextHelper.getFirstItemContext(this._entityContextData);
            var userContext = ContextHelper.getFirstUserContext(this._entityContextData);
            
            if(this._itemData.viewMode == "QUICK_MANAGE"){
                itemContext = {}
            }
            var context = {
                "app": _appName,
                "service": "_ALL",
                "component": _componentName,
                "subComponent": "_ALL",
                "entityType": "",
                "role": ""
            };
            if (itemContext && itemContext.type) {
                context.entityType = itemContext.type;
            }
            else {
                delete context.entityType;
            }
            if (userContext && userContext.role) {
                context.role = userContext.role;
            }
            else {
                delete context.role;
            }
            reqObj = DataRequestHelper.createConfigGetRequest(_appName, context);
            return reqObj;
        },
        _visibleMessageCard:function(){
            if(this._itemData && this._itemData.viewMode){
                return false;
            }
            return true;
        },
        _visibleGridView:function(){
            if(this._itemData && this._itemData.viewMode  && (this._itemData.viewMode == "GRID") && this._appConfigLoaded){
                return true;
            }
            return false;
        },
        _visibleQuickManageView: function(){
            if(this._itemData && this._itemData.viewMode  && (this._itemData.viewMode == "QUICK_MANAGE") && this._appConfigLoaded){
                return true;
            }
            return false;
        },
        _getGridConfig: function(configName){
            if(this._gridConfig && !_.isEmpty(this._gridConfig)){
                return this._gridConfig[configName]
            }
        },
        _getContextData:function(){
            var contextData = DataHelper.cloneObject(this.contextData);
            contextData.ItemContexts = [{}];
            
            if(this._itemData && !_.isEmpty(this._itemData)){
                if(this._itemData.id){
                    contextData.ItemContexts[0].id = this._itemData.id;
                }
                if(this._itemData.relationshipName){
                    contextData.ItemContexts[0].relationships = [this._itemData.relationshipName];
                }
                if(this._itemData.type){
                    contextData.ItemContexts[0].type = this._itemData.type;
                }
                
                if(this._itemData.viewMode == "GRID"){
                    if(this._itemData.parentType){
                        contextData.ItemContexts[0].type = this._itemData.parentType;
                    }
                }
                if(this._isAssets()){
                    contextData.Contexts = [];
                }
            }else{
                delete contextData['ItemContexts'];
            }
            return contextData;
        },
        _getConfigContext:function(){
            
            var configContext = {}
            if(this._itemData){
                if(this._itemData.relationshipName){
                    configContext.relationshipNames = [this._itemData.relationshipName];
                }
                configContext.relationshipTypeName = this._itemData.relationshipName;
            }
            if(this._relationshipTabsConfigs && !_.isEmpty(this._relationshipTabsConfigs)){
                var rockTabItems =  this._relationshipTabsConfigs.tabItems;
                var componentProperties;
                for (let i = 0; i < rockTabItems.length; i++) {
                    const element = rockTabItems[i];
                    componentProperties = {}
                    if(this._isAssets()){
                        if(element && element.name == "assets"){
                            if(element.component && element.component.properties){
                                componentProperties = element.component.properties;
                            }
                        }
                    }else{
                        if(element && element.name == "relationships"){
                            if(element.component && element.component.properties){
                                componentProperties = element.component.properties;
                            }
                        }
                    }
                    if(componentProperties && !_.isEmpty(componentProperties)){
                        if(componentProperties['config-context']){
                            var _configContext =  componentProperties['config-context'];
                            if(_configContext.addRelationshipMode){
                                configContext["addRelationshipMode"] = _configContext.addRelationshipMode;
                            }
                            if(_configContext.relationshipType){
                                configContext["relationshipType"] = _configContext.relationshipType;
                            }
                        }
                        if(componentProperties['mode']){
                            this.set("_gridConfig.mode", componentProperties['mode']);
                        }
                        if(componentProperties['do-sync-validation']){
                            this.set("_gridConfig.doSyncValidation", componentProperties['do-sync-validation']);
                        }
                        if(componentProperties['no-of-columns']){
                            this.set("_gridConfig.noOfColumns", componentProperties['no-of-columns']);
                        }
                        break;
                    }
                }
            }
            return configContext;
        }

    });
})();
</script>
</dom-module>
