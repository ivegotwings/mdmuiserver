<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../pebble-resizable-panels/pebble-resizable-panels.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../rock-relationship-manage/rock-relationship-manage.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-graph-tree/rock-entity-graph-tree.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<dom-module id="rock-entity-graph">
    <template>
        <style include="bedrock-styles-scroll-bar">
            :host{
                /* --rock-grid-actions:{
                    display:none;
                } */
                
                --rock-relationship-manage-message-card:{
                    display: none;
                }
                --quick-manage-header: {
                    display: none;
                }
                /* --grid-actions: {
                    display: none; 
                } */
                --rock-where-used-grid-govern-toggle:{
                    display: none;
                }
                /* --grid-quick-manage:{
                    display:none;
                } */
            }
            .left-panel{
                height: 100%;
                overflow: auto;
            }
            .right-panel{
                height: 100%;
            }
            .message {
                padding: 10px;
                margin: 10px 20px;
                background: var(--palette-pale-grey-four, #eff4f8);
                text-align: center;
                border-radius: 3px;
            }
        </style>
        <!--liquid-config-aggregate-get id="getAssetsDiscoveryAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-assets-discovery"
        context-data="[[_getContextData(_itemData)]]" on-config-get-response="_onAssetsApplicationConfigReceived"></liquid-config-aggregate-get-->
    
        <liquid-config-aggregate-get id="getAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-discovery"
        context-data="[[_getContextData(_itemData)]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
           <pebble-resizable-panels>
                <div class="left-panel" panel-width="30%">
                    <rock-entity-graph-tree id="graphTree" context-data="[[contextData]]" item-data="{{_itemData}}"></rock-entity-graph-tree>
                </div>
                <div class="right-panel" panel-width="70%">
                    <template is="dom-if" if="{{!_visibleMessageCard(_itemData)}}">
                                    
                        <template is="dom-if" if="[[_visibleGridView(_itemData, applicationConfigLoaded)]]">
                            <rock-relationship-manage id="relationshipManage" mode="[[mode]]" context-data="[[_entityContextData]]" config-context="[[_entityConfigData]]" 
                            no-of-columns="[[noOfColumns]]" do-sync-validation$="[[doSyncValidation]]" ></rock-relationship-manage>
                        </template>                    
                        <template is="dom-if" if="[[_visibleQuickManageView(_itemData, applicationConfigLoaded)]]">
                            <rock-entity-quick-manage no-header id="entityQuickManage" context-data="[[_entityContextData]]" current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]"
                                    selected-entity="[[_selectedEntity]]" tab-config="[[getQuickManageConfig('rock-entity-quick-manage', 'rock-tabs')]]"
                                    toolbar-config="[[getQuickManageConfig('rock-entity-quick-manage', 'pebble-toolbar')]]"  fixes="[[getQuickManageConfig('rock-entity-quick-manage', 'rock-entity-tofix')]]"></rock-entity-quick-manage>
                        </template>
                        
                    </template>
                    <template is="dom-if" if="{{_visibleMessageCard(_itemData)}}">
                        <div class="message">Select left section to see results.</div>
                    </template>
                </div>
            </pebble-resizable-panels>
            <bedrock-pubsub event-name="grid-data-refreshed" handler="_onRefreshGrid" ></bedrock-pubsub>
    </template>
<script>
(function(){
    Polymer({
        is: "rock-entity-graph",
        properties:{
            contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            configContext: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            _itemData:{
                type:Object,
                value: function() {
                    return {};
                }
            },
            mode: {
                type: String,
                value: function(){
                    return "view";
                }
            },
            noOfColumns: {
                type: Number,
                value: 3
            },
            doSyncValidation: {
                type: Boolean,
                value: true
            },
            relationshipGridConfigs: {
                type: Object,
                value: function () { return {}; }
            },
            clickedEntityTypes: {
                type: Array,
                value: function () { return []; }
            },
            _graphTree:{
                type:Element
            },
            _configLiquidElement:{
                type:Element
            },
            _entityConfigData:{
                type: Object,
                value: function(){
                    return {};
                }
            },
            _entityContextData:{
                type: Object,
                value: function(){
                    return {};
                }
            },
            applicationConfigLoaded:{
                type:Boolean,
                value:false
            },
            applicationConfig:{
                type:Object,
                value:function(){
                    return {};
                }
            },
            assetsApplicationConfig:{
                type:Object,
                value: function(){
                    return {}
                }
            }
        },
        behaviors: [
            // RUFBehaviors.AppBehavior
            RUFBehaviors.ComponentContextBehavior,
			RUFBehaviors.UIBehavior
        ],
        observers: [
            '_itemClickHandler(_itemData)'
        ],
        attached:function(){
            this._graphTree = this.shadowRoot.querySelector("#graphTree");
            this._configLiquidElement = this.shadowRoot.querySelector("#getAppConfig");
        },
        _onRefreshGrid:function(ev){
            if(this._itemData && !_.isEmpty(this._itemData)){
                this._graphTree.reRenderTreeChildList();
            }
        },
        _isAssets: function(){
            if(this._itemData && this._itemData.type){
                if(this._itemData.type == "image" || this._itemData.type == "video" ||
                                this._itemData.type == "document" || this._itemData.type == "audio"){
                    return true;
                }
            }
            return false;
        },
        _onAssetsApplicationConfigReceived: function(ev){
            if(ev.detail){
                this.set('assetsApplicationConfig', ev.detail);
            }
        },
        _itemClickHandler: function(){
            if(this._itemData && !_.isEmpty(this._itemData)){
                if(this._itemData.viewMode && this._itemData.id && this._itemData.type){
                    this._entityContextData = this._getContextData();
                    if(this._itemData.viewMode == "QUICK_MANAGE"){
                        this.applicationConfigLoaded = true;
                        setTimeout(() => {
                            this.shadowRoot.querySelector('#entityQuickManage').reload();
                        }, 0);
                    }else if(this._itemData.viewMode == "GRID"){
                        if(this._configLiquidElement.appName != "app-entity-manage"){
                            this._configLiquidElement.appName = "app-entity-manage";
                        }
                        this._configLiquidElement.refresh();
                    }
                }
            }
        },
        _visibleMessageCard:function(){
            if(this._itemData && this._itemData.viewMode){
                return false;
            }
            return true;
        },
        _visibleGridView:function(){
            if(this._itemData && this._itemData.viewMode  && (this._itemData.viewMode == "GRID") && this.applicationConfigLoaded){
                return true;
            }
            return false;
        },
        _visibleQuickManageView: function(){
            if(this._itemData && this._itemData.viewMode  && (this._itemData.viewMode == "QUICK_MANAGE") && this.applicationConfigLoaded){
                return true;
            }
            return false;
        },
        _onApplicationConfigReceived: function (e) {
            
            if(e.detail){
                
                this.set('applicationConfig', {});
                this.set('applicationConfig', e.detail);
                
                if(this._itemData && !_.isEmpty(this._itemData)){
                    if(this._itemData.viewMode == "GRID"){
                        this.relationshipGridConfigs = {};
                        if(this.applicationConfig && this.applicationConfig.components){
                            var components = this.applicationConfig["components"];
                            var relationshipManageConfig = components["rock-relationship-manage"];
                            if(relationshipManageConfig){
                                this.relationshipGridConfigs = relationshipManageConfig.config.relationshipGridConfig;
                            }
                        }
                        this._entityConfigData = this._getConfigContext();
                        var relationshipManage = this.shadowRoot.querySelector("#relationshipManage");
                        if(relationshipManage){
                            relationshipManage.relationshipTypeList = [];
                            relationshipManage.relationshipGridConfigs = this.relationshipGridConfigs;
                        }
                        this.set('applicationConfigLoaded', true);
                    }
                    
                }
                
            }
        },
        _getContextData:function(){
            var contextData = DataHelper.cloneObject(this.contextData);
            if(!contextData.ItemContexts){
                contextData.ItemContexts = [{}];
            }
            if(this._itemData && !_.isEmpty(this._itemData)){
                if(this._itemData.id){
                    contextData.ItemContexts[0].id = this._itemData.id;
                }
                if(this._itemData.relationshipName){
                    contextData.ItemContexts[0].relationships = [this._itemData.relationshipName];
                }
                if(this._itemData.type){
                    contextData.ItemContexts[0].type = this._itemData.type;
                }
                
                if(this._itemData.viewMode == "GRID"){
                    if(this._itemData.parentType){
                        contextData.ItemContexts[0].type = this._itemData.parentType;
                    }
                }
                if(this._isAssets()){
                    delete contextData.Contexts;
                }
            }else{
                delete contextData['ItemContexts'];
            }
            return contextData;
        },
        _getConfigContext:function(){
            
            var configContext = {}
            if(this._itemData){
                if(this._itemData.relationshipName){
                    configContext.relationshipNames = [this._itemData.relationshipName];
                }
                configContext.relationshipTypeName = this._itemData.relationshipName;
            }
            var components = this.applicationConfig["components"];
            if(components && components['rock-tabs'] && components['rock-tabs'].config && components['rock-tabs'].config.tabItems){
                    
                var rockTabItems =  components['rock-tabs'].config.tabItems;
                var componentProperties;
                for (let i = 0; i < rockTabItems.length; i++) {
                    const element = rockTabItems[i];
                    componentProperties = {}
                    if(this._isAssets()){
                        if(element && element.name == "assets"){
                            if(element.component && element.component.properties){
                                componentProperties = element.component.properties;
                            }
                        }
                    }else{
                        if(element && element.name == "relationships"){
                            if(element.component && element.component.properties){
                                componentProperties = element.component.properties;
                            }
                        }
                    }
                    if(componentProperties && !_.isEmpty(componentProperties)){
                        if(componentProperties['config-context']){
                            var _configContext =  componentProperties['config-context'];
                            if(_configContext.addRelationshipMode){
                                configContext["addRelationshipMode"] = _configContext.addRelationshipMode;
                            }
                            if(_configContext.relationshipType){
                                configContext["relationshipType"] = _configContext.relationshipType;
                            }
                        }
                        if(componentProperties['mode']){
                            this.set('mode', componentProperties['mode']);
                        }
                        if(componentProperties['do-sync-validation']){
                            this.set('doSyncValidation', componentProperties['do-sync-validation']);
                        }
                        if(componentProperties['no-of-columns']){
                            this.set('noOfColumns', componentProperties['no-of-columns']);
                        }
                        break;
                    }
                }
            }
            return configContext;
        },
        getQuickManageConfig: function (componentName, configName) {
            var componentConfig = {};
            var appConf = this.applicationConfig;
            if(this._isAssets()){
                appConf = this.assetsApplicationConfig;
            }
            if (appConf && appConf.components) {
                var components = appConf["components"];
                if(components && components[componentName]){
                    var config = components[componentName].config;
                    if (config) {
                        componentConfig = config[configName];
                    }
                }
            }
            return componentConfig;
        },
        prepareContextDataForLiquid: function(context){
            var contextData = DataHelper.cloneObject(context);
            if(contextData.ItemContexts){
                delete contextData['ItemContexts'];
            }
            return contextData;
        }
    });
})();
</script>
</dom-module>
