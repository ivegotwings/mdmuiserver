<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="improt" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../rock-relationship-grid/rock-relationship-grid.html">
<!--
`rock-relationship-manage` Represents a relationship component in the framework.
It renders the list of attributes based on the specified relationship type.

@group rock Elements
@element rock-relationship-manag4e
@demo demo/index.html
-->
<dom-module id="rock-relationship-manage">
    <template>
        <style include="pebble-styles-shared">
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    border: 1px solid #bbc1d2;
                    font-size: 15px;
                }
            }
            
            #buttonContainer {
                height: 50px;
                background: #fff;
                position: fixed;
                bottom: 0px;
                width: 75%;
            }
        </style>
        <liquid-entity-model-composite-get name="compositeEntityModelGet" request-data="{{_entityModelRequest}}" on-response="_onEntityModelGetResponse">
        </liquid-entity-model-composite-get>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_attributeModelRequest}}" on-response="_onCompositeModelGetResponse">
        </liquid-entity-model-composite-get>
        <rock-relationship-grid id="entityRelationshipGrid" relationship-type="[[context.relationshipTypeName]]" rel-req="[[requestObj]]"
            relationship-grid-config="{{relationshipGridConfigs}}" attribute-models="[[_attributeModels]]" page-size="100" dimensions="[[_dimensions]]"></rock-relationship-grid>

        <bedrock-pubsub event-name="grid-selecting-item" handler="onSelectingGridItem" target-id="entityRelationshipGrid"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-relationship-manage",

                properties: {
                    context: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    requestObj: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * Indictaes the identification of the entity for which the attributes are managed.
                     */
                    entityId: {
                        type: String
                    },
                    /**
                    * Indictaes the identification of the entity for which the attributes are managed.
                    */
                    entityType: {
                        type: String
                    },
                    /**
                     * Indictaes the locale dimension for which the attributes are managed.
                     */
                    locale: {
                        type: String
                    },
                    /**
                     * Indictaes the list for which the attributes are managed.
                     */
                    list: {
                        type: String
                    },
                    /**
                     * Indictaes the source dimension for which the attributes are managed.
                     */
                    source: {
                        type: String
                    },

                    relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },

                    _entityModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                observers: [
                    '_prepareRequest(relationshipGridConfigs)'
                ],

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                ready: function () {
                    this.relationshipGridConfigs = this.getParentAppConfig('rock-relationship-manage');
                },

                //TODO: Improve this
                _getCurrentCtx: function () {
                    var ctx = {};
                    ctx.list = this.list;
                    ctx.classification = "_ALL";
                    return ctx;
                },

                _prepareRequest: function (config) {
                    var ctx = this._getCurrentCtx();

                    var req = {
                        "params": {
                            "query": {
                                "ctx": [ctx],
                                "valCtx": [{
                                    "source": this.source,
                                    "locale": this.locale
                                }],
                                "id": this.entityId,
                                "filters": {
                                    "attributesCriterion": [],
                                    "relationshipsCriterion": [],
                                    "typesCriterion": [this.entityType]
                                }
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "relationships": [],
                                "relationshipAttributes": [],
                                "relatedEntityAttributes": []
                            },
                            "options": {
                                "from": 0,
                                "to": 0
                            }
                        }
                    };

                    this.requestObj = req;

                    this._dimensions = {
                        "source": this.source,
                        "locale": this.locale,
                        "list": this.list
                    }

                    this._initiateEntityModelRequest();
                     var attributeNames = this._getAllAttributeNames(config);
                    this._initiateAttributeModelRequest(attributeNames);
                },
                _initiateEntityModelRequest: function () {
                    var ctx = this._getCurrentCtx();

                    var req = {
                        "params": {
                            "query": {
                                "ctx": [
                                    {
                                        "list": "productMaster"
                                    }
                                ],
                                "id": this.entityType,
                                "name":  this.entityType,
                                "filters": {
                                    "typesCriterion": [
                                        "entityManageModel"
                                    ]
                                }
                            },
                            "fields": {
                                "attributes": ["_ALL"],
                                "relationships": ["_ALL"]
                            }
                        }
                    }

                    this.set("_entityModelRequest", req);

                    var liquidModelGet = this.$$("[name=compositeEntityModelGet]");

                    if (liquidModelGet) {
                        liquidModelGet.generateRequest();
                    }
                },
                _initiateAttributeModelRequest: function (attributeNames) {
                    var ctx = this._getCurrentCtx();

                    var t = {
                        "params": {
                            "query": {
                                "ctx": [
                                    ctx
                                ],
                                "locale": this.locale,
                                "name": this.entityType
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "attributes": attributeNames
                            }
                        }
                    };

                    this.set("_attributeModelRequest", t);

                    var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");

                    if (liquidModelGet) {
                        liquidModelGet.generateRequest();
                    }
                },
                _onEntityModelGetResponse: function(e) {
                     if (this.verbose) {
                        console.log("_attributeModelResponseChanged _attributeModelResponse: " + JSON.stringify(_attributeModelResponse, null, 2), +" entityId: " + this.entityId);
                    }
                    debugger;
                    if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                        debugger;
                    }
                },
                _onCompositeModelGetResponse: function (e) {
                    if (this.verbose) {
                        console.log("_attributeModelResponseChanged _attributeModelResponse: " + JSON.stringify(_attributeModelResponse, null, 2), +" entityId: " + this.entityId);
                    }

                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        var ctx = this._getCurrentCtx();

                        var compositeModel = e.detail.response.content.entityModels[0];

                        this._attributeModels = DataHelper.transformAttributeModelsToUIFormat(compositeModel, ctx);
                    }
                },
                _getAllAttributeNames: function (config) {
                    var attributes = [];
                    if (config) {
                        this._relationships = Object.keys(config);

                        if (this._relationships) {
                            this._relationships.forEach(function (item) {
                                if (item) {

                                    var relationshipAttributes = [];

                                    var columns = config[item].tabular.columns;
                                    if (columns) {
                                        columns.forEach(function (col) {
                                            if (col && col.name != "Related Entity") {
                                                attributes.push(col.name);
                                            }
                                        }, this);
                                    }
                                }
                            }, this);
                        }
                    }
                    return attributes;

                }
            });
        })();
    </script>
</dom-module>