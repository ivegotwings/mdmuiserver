<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="improt" href="../bedrock-helpers/data-helper.html">
<link rel="improt" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../rock-relationship-grid/rock-relationship-grid.html">
<!--
`rock-relationship-manage` Represents a relationship component in the framework.
It renders the list of attributes based on the specified relationship type.

@group rock Elements
@element rock-relationship-manage
@demo demo/index.html
-->
<dom-module id="rock-relationship-manage">
    <template>
        <style include="pebble-styles-shared">
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    border: 1px solid #bbc1d2;
                    font-size: 15px;
                }
            }
            
            #buttonContainer {
                height: 50px;
                background: #fff;
                position: fixed;
                bottom: 0px;
                width: 75%;
            }
            
            #messageCard {
                text-align: center;
            }
        </style>

        <rock-relationship-grid id="entityRelationshipGrid" relationship-type="[[configContext.relationshipTypeName]]" rel-req="[[requestObj]]"
            relationship-grid-configs="{{_relationshipGridConfigs}}" page-size="100" context-data="[[contextData]]"></rock-relationship-grid>
        <div id="messageCard" hidden="[[_isMessageAvailable]]">

        </div>
        <bedrock-pubsub event-name="grid-selecting-item" handler="onSelectingGridItem" target-id="entityRelationshipGrid"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-relationship-manage",

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    configContext: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    requestObj: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _relationshipModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relationshipTypeAndAttributes: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _isMessageAvailable: {
                        type: Boolean,
                        value: true
                    }
                },

                observers: [
                    'initiateRelationshipManage(relationshipGridConfigs, contextData.Contexts)'
                ],

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _tracker: [],
                ready: function () {
                    this.relationshipGridConfigs = this.getParentAppConfig('rock-relationship-manage');
                },

                initiateRelationshipManage: function (config, contextData) {
                    this._tracker = [];

                    if (_.isEmpty(this.relationshipGridConfigs) || _.isEmpty(this.contextData)) {
                        return;
                    }

                    Object.keys(this.relationshipGridConfigs).forEach(function (relType) {
                        if (relType) {
                            var columns = this.relationshipGridConfigs[relType].tabular.columns;
                            if (columns) {
                                var relatedEntityAttributes = [];
                                var relationshipAttributes = [];

                                columns.forEach(function (col) {
                                    if (col && col.name != "Related Entity") {
                                        if (col.isRelatedEntityAttribute) {
                                            relatedEntityAttributes.push(col.name);
                                        } else {
                                            relationshipAttributes.push(col.name);
                                        }
                                    }
                                }, this);

                                this._relationshipTypeAndAttributes[relType] = {
                                    'relationshipAttributes': relationshipAttributes,
                                    'relatedEntityAttributes': relatedEntityAttributes
                                }

                                this._relConfig[relType] = {};
                                this._relConfig[relType].gridConfig = this.relationshipGridConfigs[relType];
                                this._initiateRelationshipModelRequest(relType, relationshipAttributes);
                            }
                        }
                    }, this);

                    this._prepareRequest();
                },
                _prepareRequest: function () {
                    this.requestObj = DataRequestHelper.createEntityGetRequest(this.contextData);
                },
                _initiateRelationshipModelRequest: function (relationshipType, relationshipAttributes) {
                    var liquidElement = document.createElement("liquid-entity-model-composite-get");
                    liquidElement.name = relationshipType;

                    var itemContext = this.getFirstItemContext();

                    itemContext.attributeNames = [];
                    itemContext.relationships = [relationshipType];
                    itemContext.relationshipAttributes = relationshipAttributes;

                    var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                    this._tracker.push(relationshipType);
                    liquidElement.requestData = compositeModelGetRequest;
                    liquidElement.addEventListener("entity-model-composite-get-response", this._onRelationshipModelGetResponse.bind(this));
                    liquidElement.generateRequest();
                },
                _onRelationshipModelGetResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                        var relType = "";
                        if (e.detail.request) {
                            relType = e.detail.request.requestData.params.fields.relationships[0];
                        }
                        var compositeModel = e.detail.response.content.entityModels[0];

                        if (relType && compositeModel && compositeModel.data) {
                            var relationships = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);

                            if (relationships && relationships[relType]) {
                                var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;

                                if (rel) {
                                    if (this._relConfig[relType]) {
                                        this._relConfig[relType].selfContext = relationships[relType].selfContext;
                                        this._relConfig[relType].relatedEntityModel = {};
                                        this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                        this._relConfig[relType].relationshipAttributeModels = {};
                                    }

                                    var relatedEntityInfo = [];

                                    if (rel.properties && Object.keys(rel.properties).length) {
                                        relatedEntityInfo = rel.properties.relatedEntityInfo;
                                        if (relatedEntityInfo && relatedEntityInfo.length) {
                                            this._relConfig[relType].relatedEntityModel.relatedEntityContexts = relatedEntityInfo;
                                        }

                                        if (rel.attributes) {
                                            var relData = {};
                                            relData.data = {};
                                            relData.data.attributes = rel.attributes;

                                            this._relConfig[relType].relationshipAttributeModels = DataTransformHelper.transformAttributeModels(relData, this.contextData);;
                                        }

                                        if (this._relationshipTypeAndAttributes[relType]) {
                                            var relatedEntityAttributes = this._relationshipTypeAndAttributes[relType].relatedEntityAttributes;

                                            if (relatedEntityAttributes && relatedEntityAttributes.length) {
                                                //Initiate attr model get
                                                this._initiateAttributeModelRequest(relType, relatedEntityInfo, relatedEntityAttributes);
                                            } else {
                                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                                DataHelper.arrayRemove(this._tracker, relType);
                                                if (this._tracker.length == 0) {
                                                    this._relationshipGridConfigs = this._relConfig;
                                                }
                                            }
                                        }


                                    }
                                }
                            }
                        } else {
                            DataHelper.arrayRemove(this._tracker, relType);

                            if(this._relConfig[relType]) {
                                delete this._relConfig[relType];
                            }

                            //TODO: Needs to change it with proper component
                            if (this._tracker.length == 0) {
                                this._isMessageAvailable = false;
                                var messageDiv = Polymer.dom(this).node.$.messageCard;
                                if (messageDiv) {
                                    messageDiv.textContent = "Relationships are not configured for current entity type: " + this.entityType;
                                }
                            }
                        }
                    }
                },
                _initiateAttributeModelRequest: function (relationshipType, relatedEntityContexts, relatedEntityAttributes) {
                    var liquidElement = document.createElement("liquid-entity-model-composite-get");
                    liquidElement.name = relationshipType;

                    var ids = [];

                    var typesCriterion = [];
                    var contexts = [];
                    var valContext = this.getFirstValueContext();

                    if (relatedEntityContexts) {
                        relatedEntityContexts.forEach(function (relContext) {
                            if (relContext) {
                                ids.push(relContext.relEntityType + "_entityManageModel");
                                if (relContext.relContexts) {
                                    relContext.relContexts.forEach(function (ctxItem) {
                                        contexts.push(ctxItem);
                                    }, this);
                                }
                            }
                        }, this);
                    }

                    var req = {
                        "params": {
                            "query": {
                                "contexts": contexts,
                                "locale": valContext.locale,
                                "ids": ids
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "attributes": relatedEntityAttributes
                            }
                        }
                    };

                    liquidElement.requestData = req;
                    liquidElement.addEventListener("entity-model-composite-get-response", this._onRelatedEntityAttributeModelGetResponse.bind(this));
                    liquidElement.generateRequest();
                },
                _onRelatedEntityAttributeModelGetResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        var compositeModel = e.detail.response.content.entityModels[0];
                        var relType = e.currentTarget.name;
                        var attributeModels = DataTransformHelper.transformAttributeModels(compositeModel, this.contextData);

                        if (relType) {
                            if (this._relConfig[relType] && attributeModels) {
                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = attributeModels;
                            } else {
                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                            }
                            DataHelper.arrayRemove(this._tracker, relType);
                            if (this._tracker.length == 0) {
                                this._relationshipGridConfigs = this._relConfig;
                            }
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>