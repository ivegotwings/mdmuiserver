<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="improt" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../rock-relationship-grid/rock-relationship-grid.html">
<!--
`rock-relationship-manage` Represents a relationship component in the framework.
It renders the list of attributes based on the specified relationship type.

@group rock Elements
@element rock-relationship-manage
@demo demo/index.html
-->
<dom-module id="rock-relationship-manage">
    <template>
        <style include="pebble-styles-shared">
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    border: 1px solid #bbc1d2;
                    font-size: 15px;
                }
            }
            
            #buttonContainer {
                height: 50px;
                background: #fff;
                position: fixed;
                bottom: 0px;
                width: 75%;
            }
        </style>

        <rock-relationship-grid id="entityRelationshipGrid" relationship-type="[[context.relationshipTypeName]]" rel-req="[[requestObj]]"
            relationship-grid-configs="{{_relationshipGridConfigs}}" page-size="100" dimensions="[[_dimensions]]"></rock-relationship-grid>

        <bedrock-pubsub event-name="grid-selecting-item" handler="onSelectingGridItem" target-id="entityRelationshipGrid"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-relationship-manage",

                properties: {
                    context: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    requestObj: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indictaes the identification of the entity for which the attributes are managed.
                     */
                    entityId: {
                        type: String
                    },
                    /**
                    * Indicates the identification of the entity for which the attributes are managed.
                    */
                    entityType: {
                        type: String
                    },
                    /**
                     * Indictaes the locale dimension for which the attributes are managed.
                     */
                    locale: {
                        type: String
                    },
                    /**
                     * Indictaes the list for which the attributes are managed.
                     */
                    list: {
                        type: String
                    },
                    /**
                     * Indictaes the source dimension for which the attributes are managed.
                     */
                    source: {
                        type: String
                    },
                    relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _relationshipModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relationshipTypeAndAttributes: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                observers: [
                    'initiateRelationshipManage(relationshipGridConfigs)'
                ],

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                _tracker: [],
                ready: function () {
                    this.relationshipGridConfigs = this.getParentAppConfig('rock-relationship-manage');
                },

                initiateRelationshipManage: function (config) {
                    this._tracker = [];
                    if (this.relationshipGridConfigs) {
                        Object.keys(this.relationshipGridConfigs).forEach(function (relType) {
                            if (relType) {
                                var columns = this.relationshipGridConfigs[relType].tabular.columns;
                                if (columns) {
                                    var relatedEntityAttributes = [];
                                    var relationshipAttributes = [];

                                    columns.forEach(function (col) {
                                        if (col && col.name != "Related Entity") {
                                            if (col.isRelatedEntityAttribute) {
                                                relatedEntityAttributes.push(col.name);
                                            } else {
                                                relationshipAttributes.push(col.name);
                                            }
                                        }
                                    }, this);

                                    this._relationshipTypeAndAttributes[relType] = {
                                        'relationshipAttributes': relationshipAttributes,
                                        'relatedEntityAttributes': relatedEntityAttributes
                                    }

                                    this._relConfig[relType] = {};
                                    this._relConfig[relType].gridConfig = this.relationshipGridConfigs[relType];
                                    this._initiateRelationshipModelRequest(relType, relationshipAttributes);
                                }
                            }
                        }, this);

                        this._prepareRequest();
                    }
                },
                //TODO: Improve this
                _getCurrentCtx: function () {
                    var ctx = {};
                    ctx.list = this.list;
                    ctx.classification = "_ALL";
                    return ctx;
                },
                _prepareRequest: function () {
                    var ctx = this._getCurrentCtx();

                    var req = {
                        "params": {
                            "query": {
                                "ctx": [ctx],
                                "valCtx": [{
                                    "source": this.source,
                                    "locale": this.locale
                                }],
                                "id": this.entityId,
                                "filters": {
                                    "attributesCriterion": [],
                                    "relationshipsCriterion": [],
                                    "typesCriterion": [this.entityType]
                                }
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "relationships": [],
                                "relationshipAttributes": [],
                                "relatedEntityAttributes": []
                            },
                            "options": {
                                "from": 0,
                                "to": 0
                            }
                        }
                    };

                    this.requestObj = req;

                    this._dimensions = {
                        "source": this.source,
                        "locale": this.locale,
                        "list": this.list
                    }
                },
                _initiateRelationshipModelRequest: function (relationshipType, relationshipAttributes) {
                    var ctx = this._getCurrentCtx();
                    var liquidElement = document.createElement("liquid-entity-model-composite-get");
                    liquidElement.name = relationshipType;

                    var req = {
                        "params": {
                            "query": {
                                "ctx": [ctx],
                                "locale": "en-US",
                                "name": this.entityType
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "relationships": [relationshipType],
                                "relationshipAttributes": relationshipAttributes
                            }
                        }
                    };
                    this._tracker.push(relationshipType);
                    liquidElement.requestData = req;
                    liquidElement.addEventListener("response", this._onRelationshipModelGetResponse.bind(this));
                    liquidElement.generateRequest();
                },
                _onRelationshipModelGetResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                        var relType = "";
                        if (e.detail.request) {
                            relType = e.detail.request.requestData.params.fields.relationships[0];
                        }
                        var compositeModel = e.detail.response.content.entityModels[0];

                        if (relType && compositeModel && compositeModel.data) {
                            var ctxData = compositeModel.data.ctxInfo;

                            if (ctxData) {
                                ctxData.forEach(function (ctxItem) {
                                    var relationships = ctxItem.relationships;

                                    if (relationships && relationships[relType]) {
                                        var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;

                                        if (rel) {
                                            if (this._relConfig[relType]) {
                                                this._relConfig[relType].relatedEntityModel = {};
                                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                                this._relConfig[relType].relationshipAttributeModels = {};
                                            }

                                            var relatedEntityInfo = [];

                                            if (rel.properties && Object.keys(rel.properties).length) {
                                                relatedEntityInfo = rel.properties.relatedEntityInfo;
                                                if (relatedEntityInfo && relatedEntityInfo.length) {
                                                    this._relConfig[relType].relatedEntityModel.relatedEntityCtxInfo = relatedEntityInfo;
                                                }

                                                if (rel.attributes) {
                                                    var relData = {};
                                                    relData.data = {};
                                                    relData.data.attributes = rel.attributes;

                                                    this._relConfig[relType].relationshipAttributeModels = DataHelper.transformAttributeModelsToUIFormat(relData, this._getCurrentCtx());;
                                                }

                                                if (this._relationshipTypeAndAttributes[relType]) {
                                                    var relatedEntityAttributes = this._relationshipTypeAndAttributes[relType].relatedEntityAttributes;

                                                    if (relatedEntityAttributes && relatedEntityAttributes.length) {
                                                        //Initiate attr model get
                                                        this._initiateAttributeModelRequest(relType, relatedEntityInfo, relatedEntityAttributes);
                                                    } else {
                                                        this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                                        this._arrayRemove(this._tracker, relType);
                                                        if (this._tracker.length == 0) {
                                                            this._relationshipGridConfigs = this._relConfig;
                                                        }
                                                    }
                                                }


                                            }
                                        }
                                    }

                                }, this);
                            }
                        }
                    }
                },
                _initiateAttributeModelRequest: function (relationshipType, relatedEntityInfo, relatedEntityAttributes) {
                    var ctx = this._getCurrentCtx();
                    var liquidElement = document.createElement("liquid-entity-model-composite-get");
                    liquidElement.name = relationshipType;

                    var ids = [];

                    if (relatedEntityInfo && relatedEntityInfo.length) {
                        relatedEntityInfo.forEach(function (relEntity) {
                            if (relEntity && relEntity.relEntityType) {
                                ids.push(relEntity.relEntityType + "_entityManageModel");
                            }
                        }, this);
                    }

                    var req = {
                        "params": {
                            "query": {
                                "ctx": [ctx],
                                "locale": this.locale,
                                "ids": ids
                            },
                            "fields": {
                                "ctxTypes": [
                                    "properties"
                                ],
                                "attributes": relatedEntityAttributes
                            }
                        }
                    };

                    liquidElement.requestData = req;
                    liquidElement.addEventListener("response", this._onRelatedEntityAttributeModelGetResponse.bind(this));
                    liquidElement.generateRequest();
                },
                _onRelatedEntityAttributeModelGetResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        var ctx = this._getCurrentCtx();

                        var compositeModel = e.detail.response.content.entityModels[0];
                        var relType = e.currentTarget.name;
                        var attributeModels = DataHelper.transformAttributeModelsToUIFormat(compositeModel, ctx);

                        if (relType) {
                            if (this._relConfig[relType] && attributeModels) {
                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = attributeModels;
                            } else {
                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                            }
                            this._arrayRemove(this._tracker, relType);
                            if (this._tracker.length == 0) {
                                this._relationshipGridConfigs = this._relConfig;
                            }
                        }
                    }
                },
                _arrayRemove: function (arr, val) {
                    var index = -1;

                    index = arr.indexOf(val);

                    while (index >= 0) {
                        arr.splice(index, 1);
                        index = arr.indexOf(val);
                    }
                }
            });
        })();
    </script>
</dom-module>