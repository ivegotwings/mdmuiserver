<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="improt" href="../bedrock-helpers/data-helper.html">
<link rel="improt" href="../bedrock-helpers/context-helper.html">
<link rel="improt" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-entity-relationship-search-result/rock-entity-relationship-search-result.html">
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">

<!--
`rock-relationship-manage` Represents a relationship component in the framework.
It renders the list of attributes based on the specified relationship type.

@group rock Elements
@element rock-relationship-manage
@demo demo/index.html
-->
<dom-module id="rock-relationship-manage">
    <template>
        <style include="bedrock-style-common">
            :host {
                padding: 20px 20px 0;
                display: block;
            }
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    border: 1px solid #bbc1d2;
                    font-size: 15px;
                }
            }

            #buttonContainer {
                height: 50px;
                background: #fff;
                position: fixed;
                bottom: 0px;
                width: 75%;
            }

            #messageCard {
                text-align: center;
                padding: 15px;
                @apply --rock-relationship-manage-message-card;
            }

            rock-where-used-grid {
                --iron-data-table: {
                    overflow: visible!important;
                };
            }

        </style>
      <rock-business-function-dialog id="wfTransitionDialog" context-data="[[contextData]]"></rock-business-function-dialog>
      <rock-business-function-dialog id="wfAssignmentDialog" context-data="[[contextData]]"></rock-business-function-dialog>
      <div class="content">
            <template is="dom-if" if="displayedRelationshipTypeListChunks.length">
                <template is="dom-repeat" items="[[displayedRelationshipTypeListChunks]]" as="relationshipTypeList">
                    <template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship">
                        <rock-entity-relationship-search-result
                            id="entityRelationshipSearchResult_[[relationship]]"
                            readonly$="[[readonly]]"
                            relationship="[[relationship]]"
                            config-context="[[configContext]]"
                            page-size="100"
                            context-data="[[contextData]]"
                            do-sync-validation$="[[doSyncValidation]]"
                            functional-mode="[[functionalMode]]">
                        </rock-entity-relationship-search-result>
                    </template>
                </template>
            </template>
      </div>
      <div id="messageCard" hidden="[[!_isMessageAvailable]]">
      </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-relationship-manage",

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i>
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i>
                      */
                    configContext: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onConfigContextChange'
                    },
                    _isMessageAvailable: {
                        type: Boolean,
                        value: false
                    },
                    functionalMode: {
                        type: String,
                        value: "default"
                    },
                    relationshipTypeList:{
                        type:Array,
                        value: function () {
                            return [];
                        }
                    },
                    globalEdit:{
                        type:Boolean,
                        notify:true
                    },
                    doSyncValidation: {
                        type: Boolean,
                        value: true
                    },
                    relationshipChunkLength: {
                        type: Number,
                        value: 5
                    },
                },

                observers: [
                ],

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                created() {
                    this.relationshipTypeList = [];
                    this.relationshipTypeListChunks = [];
                    this.displayedRelationshipTypeListChunks = [];
                    this.displayedRelationshipTypeListChunksIndex = 1;

                    this._onScrollListDebounce = _.debounce(this._onScrollList.bind(this), 300);
                },

                attached() {
                    if(this.scrollContainer)
                        this.scrollContainer.addEventListener('scroll', this._onScrollListDebounce);
                },

                detached() {
                    if(this.scrollContainer)
                        this.scrollContainer.removeEventListener('scroll', this._onScrollListDebounce)
                },

                get scrollContainer() {
                    const query = this.shadowRoot.querySelectorAll('.content');
                    return query ? query[0] : null;
                },

                get hasScroll() {
                    const { scrollHeight, offsetHeight } = this.scrollContainer;

                    return scrollHeight > offsetHeight;
                },

                get isLoadFinished() {
                    return this.displayedRelationshipTypeListChunks.length === this.relationshipTypeListChunks.length;
                },

                _onScrollList() {
                    if(!this._lazyLoad) return;

                    const { scrollHeight, scrollTop, offsetHeight } = this.scrollContainer;

                    const scrollDiff = scrollHeight - offsetHeight - scrollTop;

                    const PRELOAD_HEIGHT = 100;

                    if(this.isLoadFinished) {
                        this.loading = false;
                        return;
                    }

                    if (scrollDiff <= PRELOAD_HEIGHT)
                        return this._loadMoreAttributes();
                },

                _loadMoreAttributes() {
                    const itemsToPush = this.relationshipTypeListChunks.slice(this.displayedRelationshipTypeListChunksIndex, ++this.displayedRelationshipTypeListChunksIndex);

                    if (!itemsToPush.length) {
                        this.loading = false;
                        return;
                    }

                    this.loading = true;

                    window.requestAnimationFrame(()=> {
                        const displayedRelationshipTypeListChunks = this.displayedRelationshipTypeListChunks.concat(itemsToPush);
                        this.set('displayedRelationshipTypeListChunks', displayedRelationshipTypeListChunks);
                    });
                },

                _onConfigContextChange: function() {
                    const {
                        relationshipTypeName,
                        relationshipNames
                    } = this.configContext;

                    const relationshipTypeList = relationshipTypeName ? [relationshipTypeName] : relationshipNames;

                    if(!relationshipTypeList.length) {
                        this._isMessageAvailable = true;
                        var messageDiv = this.$.messageCard;
                        if (messageDiv) {
                            messageDiv.textContent = "No Default Relationship is configured. Please select a relationship from the menu.";
                        }
                        return;
                    }

                    this.relationshipTypeListChunks = relationshipTypeList.reduce((res, item) => {
                        const chunkIndex = res.length;

                        const currentChunk = res[chunkIndex - 1];

                        if (chunkIndex && currentChunk && currentChunk.length < this.relationshipChunkLength)
                            currentChunk.push(item);
                        else
                            res.push([item]);

                        return res;
                    }, []);


                    const displayedRelationshipTypeListChunks = this.relationshipTypeListChunks.slice(0, this.displayedRelationshipTypeListChunksIndex);
                    
                    this.set('displayedRelationshipTypeListChunks', displayedRelationshipTypeListChunks);

                    if(this.isLoadFinished) {
                        this.loading = false;
                        return;
                    }

                    //after rendering initial attributes need to check if container has scroll
                    //in case it doesn't have, need to trigger loading next chunk manually
                    setTimeout(()=> {
                        if(!this.hasScroll)
                            this._loadMoreAttributes();
                    }, 0);
                },
                
                getIsDirty: function () {
                    var searchResult = this.shadowRoot.querySelector('rock-entity-relationship-search-result');

                    return searchResult && searchResult.getIsDirty();
                },

                getControlIsDirty: function () {
                    var searchResult = this.shadowRoot.querySelector('rock-entity-relationship-search-result');

                    return searchResult && searchResult.getControlIsDirty();
                },

                refresh: function (){
                    var searchResult = this.shadowRoot.querySelector('rock-entity-relationship-search-result');

                    return searchResult && searchResult.refresh();
                }
            });
        })();
    </script>
</dom-module>