<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="improt" href="../bedrock-helpers/data-helper.html">
<link rel="improt" href="../bedrock-helpers/context-helper.html">
<link rel="improt" href="../bedrock-helpers/data-transform-helper.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-relationship-grid/rock-relationship-grid.html">
<link rel="import" href="../rock-where-used-grid/rock-where-used-grid.html">
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">

<!--
`rock-relationship-manage` Represents a relationship component in the framework.
It renders the list of attributes based on the specified relationship type.

@group rock Elements
@element rock-relationship-manage
@demo demo/index.html
-->
<dom-module id="rock-relationship-manage">
    <template>
        <style include="pebble-styles-shared">
            .button {
                --pebble-button: {
                    height: 30px;
                    width: 100px;
                    border: 1px solid #bbc1d2;
                    font-size: 15px;
                }
            }

            #buttonContainer {
                height: 50px;
                background: #fff;
                position: fixed;
                bottom: 0px;
                width: 75%;
            }

            #messageCard {
                text-align: center;
                padding: 15px;
            }

            rock-where-used-grid {
                --iron-data-table: {
                    overflow: visible!important;
                };
                --rock-grid-iron-list: {
                     will-change: normal;
                }
            }

        </style>

      <rock-business-function-dialog id="wfTransitionDialog"></rock-business-function-dialog>
      <rock-business-function-dialog id="wfAssignmentDialog"></rock-business-function-dialog>
      <template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex" notify-dom-change>
         <template is="dom-if" if="{{!_isUpdirection(relationship)}}">
            <rock-relationship-grid id="entityRelationshipGrid_[[relationship]]" relationship="[[relationship]]" add-relationship-mode="[[configContext.addRelationshipMode]]"
                relationship-type="[[configContext.relationshipType]]" relationship-title="[[configContext.relationshipTitle]]" rel-req="[[requestObj]]"
                relationship-grid-config="[[_getRelationshipGridConfig(relationship)]]" page-size="100" context-data="[[contextData]]"
                do-sync-validation$="[[doSyncValidation]]" message-code-mapping="[[messageCodeMapping]]" functional-mode="[[functionalMode]]"
                type-thumbnail-mapping="[[_typeThumbnailMapping]]"></rock-relationship-grid>
        </template>
        <template is="dom-if" if="{{_isUpdirection(relationship)}}">
            <rock-where-used-grid id="entityRelationshipGrid_[[relationship]]" relationship="[[relationship]]" relationship-title="[[configContext.relationshipTitle]]"
                rel-req="[[requestObj]]" relationship-grid-config="[[_getRelationshipGridConfig(relationship)]]" page-size="100"
                context-data="[[contextData]]" do-sync-validation$="[[doSyncValidation]]" message-code-mapping="[[messageCodeMapping]]" govern-grid-actions-config="[[workflowActions]]"></rock-where-used-grid>
            <bedrock-pubsub event-name="govern-grid-action-click" handler="_onWorkflowActionTap" target-id="entityRelationshipGrid_[[relationship]]"></bedrock-pubsub>
        </template>
      </template>
      <div id="messageCard" hidden="[[!_isMessageAvailable]]">
      </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-relationship-manage",

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    configContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    requestObj: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    doSyncValidation: {
                        type: Boolean,
                        value: true
                    },                    
                    _relationshipGridConfigs: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _relationshipModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relationshipTypeAndAttributes: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _isMessageAvailable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    messageCodeMapping: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    functionalMode: {
                        type: "String",
                        value: "default"
                    },
                },

                observers: [
                    'initiateRelationshipManage(relationshipGridConfigs, contextData.Contexts)',
                ],

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _tracker: [],
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                ready: function () {
                    this.relationshipGridConfigs = this.getParentAppConfig('rock-relationship-manage', '', 'relationshipGridConfig');
                    this.messageCodeMapping = this.getParentAppConfig('rock-relationship-manage', '', 'messageCodeMapping');
                    this.workflowActions = this.getParentAppConfig('rock-relationship-manage', '', 'workflowActions');
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                initiateRelationshipManage: function (config, contextData) {
                    this._tracker = [];

                    if (_.isEmpty(this.relationshipGridConfigs) || _.isEmpty(this.contextData)) {
                        return;
                    }
                    if (!this.configContext.relationshipTypeName ) {
                        if(this.configContext.relationshipNames && this.configContext.relationshipNames.length) {
                            this._relationships = this.configContext.relationshipNames;
                        }else{
                            this._isMessageAvailable = true;
                            var messageDiv = this.$.messageCard;
                            if (messageDiv) {
                                messageDiv.textContent = "No Default Relationship is configured. Please select a relationship from the menu.";
                            }
                            return;
                        }
                    }  else {
                        this._relationships = [this.configContext.relationshipTypeName];
                        if(!this.relationshipGridConfigs[this.configContext.relationshipTypeName]){
                            this._isMessageAvailable = true;
                            var messageDiv = this.$.messageCard;
                            if (messageDiv) {
                                messageDiv.textContent = "Relationships are not configured for current entity type: " + this.configContext.relationshipTitle;
                            }
                            return;
                        }
                    }

                    this._relationships.forEach(function (relType) {
                        if (relType && this.relationshipGridConfigs[relType]) {
                            var relGridConfig=this.relationshipGridConfigs[relType].gridConfig;
                            if(relGridConfig) {
                                var relatedEntityAttributes = [];
                                var relationshipAttributes = [];
                                if(relGridConfig.viewMode=="Tabular") {
                                    var columns = this.relationshipGridConfigs[relType].gridConfig.tabular.columns;
                                    if (columns) {
                                        columns.forEach(function (col) {
                                            if (col && (col.name != "Related Entity" || col.name != "From Entity" || col.name != "Entity Type")) {
                                                if (col.isRelatedEntityAttribute || col.isFromEntityAttribute) {
                                                    relatedEntityAttributes.push(col.name);
                                                } else {
                                                    relationshipAttributes.push(col.name);
                                                }
                                            }
                                        }, this);
                                    }
                                } else {
                                    var fieldDetails;
                                    if (relGridConfig.viewMode == "Tile") {
                                        fieldDetails = relGridConfig.tile.tileItems;
                                    } else if (relGridConfig.viewMode == "List") {
                                        fieldDetails = relGridConfig.list.listItems;
                                    }
                                    relatedEntityAttributes.push(fieldDetails.image);
                                    relatedEntityAttributes.push(fieldDetails.thumbnailId);
                                    relatedEntityAttributes.push(fieldDetails.title);
                                    relatedEntityAttributes.push(fieldDetails.subtitle);
                                    relatedEntityAttributes.push(fieldDetails.id);
                                    relatedEntityAttributes.push("property_objectkey");
                                    var fields = DataHelper.cloneObject(fieldDetails.fields);

                                    //Add sort fields
                                    if(relGridConfig && DataHelper.isValidObjectPath(relGridConfig, "tile.settings.sort.default")) {
                                        var sortFieldDetails = DataHelper.cloneObject(relGridConfig.tile.settings.sort.default);
                                        for(var i = 0; i < sortFieldDetails.length; i++) {
                                            if(!fields.find(obj => obj.name == sortFieldDetails[i].field)) {
                                                sortFieldDetails[i].name = sortFieldDetails[i].field;
                                                fields.push(sortFieldDetails[i]);
                                            }
                                        }
                                    }

                                    for (var i = 0; i < fields.length; i++) {
                                        if(fields[i].isRelationshipAttribute){
                                            relationshipAttributes.push(fields[i].name);
                                        } else {
                                            relatedEntityAttributes.push(fields[i].name);
                                        }
                                    }
                                    if(!this._relationshipTypeAndAttributes){
                                        this._relationshipTypeAndAttributes={};
                                    }
                                }

                                this._relationshipTypeAndAttributes[relType] = {
                                    'relationshipAttributes': relationshipAttributes,
                                    'relatedEntityAttributes': relatedEntityAttributes
                                }
                                this._relConfig[relType] = {};
                                this._relConfig[relType].gridConfig = this.relationshipGridConfigs[relType].gridConfig;
                                this._relConfig[relType].governDataConfig = this.relationshipGridConfigs[relType].governDataConfig;
                                this._relConfig[relType].relationshipTypeAndAttributes =  this._relationshipTypeAndAttributes[relType];
                                this._relConfig[relType].addRelLovConfig = this.relationshipGridConfigs[relType].addRelLovConfig;
                                this._relConfig[relType].quickManageConfig = this.relationshipGridConfigs[relType].quickManageConfig;
                                this._initiateRelationshipModelRequest(relType, relationshipAttributes);
                            }
                        }
                    }, this);

                    this._prepareRequest();
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                getIsDirty: function () {
                    var relationshipGrid = this.shadowRoot.querySelector("rock-relationship-grid");
                    if (relationshipGrid) {
                        var currentRelGridContainer = relationshipGrid.shadowRoot.querySelector("div[id^='relContainer_']:not([hidden])");
                        if (currentRelGridContainer) {
                            var relGrid = currentRelGridContainer.querySelector('rock-grid');
                            if (relGrid) {
                                return relGrid.isDirty();
                            }
                        }
                    }
                    return false;
                },
                _prepareRequest: function () {
                    this.requestObj = DataRequestHelper.createEntityGetRequest(this.contextData);
                },
                _initiateRelationshipModelRequest: function (relationshipType, relationshipAttributes) {
                    var liquidElement = document.createElement("liquid-entity-model-composite-get");
                    liquidElement.name = relationshipType;
                    var compositeModelGetRequest = {};

                    if (this.relationshipGridConfigs[relationshipType] && this.relationshipGridConfigs[relationshipType].direction == "up") {
                        var contextData = DataHelper.cloneObject(this.contextData);
                        var itemContext = contextData[ContextHelper.CONTEXT_TYPE_ITEM][0];

                        itemContext.attributeNames = [];
                        itemContext.type = this.relationshipGridConfigs[relationshipType].fromEntityTypes[0];
                        itemContext.relationships = [relationshipType];
                        itemContext.relationshipAttributes = relationshipAttributes;

                        compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(contextData);

                        if (this._relConfig[relationshipType]) {
                            this._relConfig[relationshipType].direction = this.relationshipGridConfigs[relationshipType].direction; 
                            this._relConfig[relationshipType].fromEntityTypes = this.relationshipGridConfigs[relationshipType].fromEntityTypes; 
                        }                        
                    } else {
                        var itemContext = this.getFirstItemContext();

                        itemContext.attributeNames = [];
                        itemContext.relationships = [relationshipType];
                        itemContext.relationshipAttributes = relationshipAttributes;

                        compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                    }

                    this._tracker.push(relationshipType);
                    liquidElement.requestData = compositeModelGetRequest;
                    liquidElement.addEventListener("entity-model-composite-get-response", this._onRelationshipModelGetResponse.bind(this));
                    liquidElement.generateRequest();
                },
                _onRelationshipModelGetResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                        var relType = "";
                        if (e.detail.request) {
                            relType = e.detail.request.requestData.params.fields.relationships[0];
                        }
                        var compositeModel = e.detail.response.content.entityModels[0];

                        if (relType && compositeModel && compositeModel.data) {
                            var relationships = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);

                            if (relationships && relationships[relType]) {
                                var rel = relationships[relType] && relationships[relType].length ? relationships[relType][0] : undefined;

                                if (rel) {
                                    if (this._relConfig[relType]) {
                                        this._relConfig[relType].selfContext = relationships[relType].selfContext;
                                        this._relConfig[relType].relatedEntityModel = {};
                                        this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                        this._relConfig[relType].relationshipAttributeModels = {};
                                        this._relConfig[relType].relationshipAttributeModels = {};

                                    }

                                    var relatedEntityInfo = [];

                                    if (rel.properties && Object.keys(rel.properties).length) {
                                        relatedEntityInfo = rel.properties.relatedEntityInfo;
                                        if (relatedEntityInfo && relatedEntityInfo.length) {
                                            this._relConfig[relType].relatedEntityModel.relatedEntityContexts = relatedEntityInfo;
                                            var relEntityTypes=relatedEntityInfo.map(function (relContext) {
                                                if(relContext.relEntityType) {
                                                    return relContext.relEntityType;
                                                }
                                            });
                                            this._relConfig[relType].relatedEntityTypes=relEntityTypes;
                                            
                                        }
                                        var hasWritePermission=rel.properties.hasWritePermission;
                                        if(this._relConfig[relType].gridConfig){
                                            this._relConfig[relType].gridConfig["hasWritePermission"] = hasWritePermission;
                                            if(!hasWritePermission){
                                            
                                                var toolbarConfig = this._relConfig[relType].gridConfig.toolbarConfig.buttonItems;
                                                if(toolbarConfig){
                                                    var buttons = toolbarConfig[0].buttons;
                                                    for(var button in buttons){
                                                        if(buttons[button].name == 'edit' || buttons[button].name == 'upload'){
                                                        buttons[button].visible = false;
                                                        }
                                                    }
                                                } 
                                            }
                                        }
                                        if (rel.attributes) {
                                            var relData = {};
                                            relData.data = {};
                                            relData.data.attributes = rel.attributes;

                                            this._relConfig[relType].relationshipAttributeModels = DataTransformHelper.transformAttributeModels(relData, this.contextData);;
                                        }

                                        if (this._relationshipTypeAndAttributes[relType]) {
                                            var relatedEntityAttributes = this._relationshipTypeAndAttributes[relType].relatedEntityAttributes;

                                            if (relatedEntityAttributes && relatedEntityAttributes.length) {
                                                //Initiate attr model get
                                                this._initiateAttributeModelRequest(relType, relatedEntityInfo, relatedEntityAttributes);
                                            } else {
                                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                                                DataHelper.arrayRemove(this._tracker, relType);
                                                if (this._tracker.length == 0) {
                                                    this._relationshipGridConfigs = this._relConfig;
                                                    this.relationshipTypeList=this._relationships;
                                                }
                                            }
                                        }

                                    }
                                }
                            }
                        } else {
                            DataHelper.arrayRemove(this._tracker, relType);

                            if (this._relConfig[relType]) {
                                delete this._relConfig[relType];
                            }

                            //TODO: Needs to change it with proper component
                            if (this._tracker.length == 0) {
                                this._isMessageAvailable = true;
                                var messageDiv = Polymer.dom(this).node.$.messageCard;
                                if (messageDiv) {
                                    messageDiv.textContent = "Relationships are not configured for current entity type: " + this.entityType;
                                }
                            }
                        }
                    }
                },
                _initiateAttributeModelRequest: function (relationshipType, relatedEntityContexts, relatedEntityAttributes) {
                    var liquidElement = document.createElement("liquid-entity-model-composite-get");
                    liquidElement.name = relationshipType;

                    var ids = [];

                    var typesCriterion = [];
                    var contexts = [];
                    var valContext = this.getFirstValueContext();

                    if (relatedEntityContexts) {
                        relatedEntityContexts.forEach(function (relContext) {
                            if (relContext) {
                                ids.push(relContext.relEntityType + "_entityCompositeModel");
                                if (relContext.relContexts) {
                                    relContext.relContexts.forEach(function (ctxItem) {
                                        contexts.push(ctxItem);
                                    }, this);
                                }
                            }
                        }, this);
                    }

                    var req = {
                        "params": {
                            "query": {
                                "contexts": contexts,
                                "locale": valContext.locale,
                                "ids": ids
                            },
                            "fields": {
                                "attributes": relatedEntityAttributes
                            }
                        }
                    };

                    liquidElement.requestData = req;
                    liquidElement.addEventListener("entity-model-composite-get-response", this._onRelatedEntityAttributeModelGetResponse.bind(this));
                    liquidElement.generateRequest();
                },
                _onRelatedEntityAttributeModelGetResponse: function (e) {
                    if(!this._typeThumbnailMapping) {
                        this._typeThumbnailMapping = {};
                    }
                    var relType = e.currentTarget.name;

                    if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
                        var compositeModel = e.detail.response.content.entityModels[0];
                        var attributeModels = DataTransformHelper.transformAttributeModels(compositeModel, this.contextData);
                        var properties=compositeModel.properties;
                        if(properties.hasOwnProperty("defaultThumbnailId")){
                            this._typeThumbnailMapping[compositeModel.name]=properties.defaultThumbnailId;
                        }
                        if (relType) {
                            if (this._relConfig[relType] && attributeModels) {
                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = attributeModels;
                            } else {
                                this._relConfig[relType].relatedEntityModel.relatedEntityAttributeModels = {};
                            }
                        }
                    }

                    DataHelper.arrayRemove(this._tracker, relType);
                    if (this._tracker.length == 0) {
                        this._relationshipGridConfigs = this._relConfig;
                        this.relationshipTypeList=this._relationships;
                    }
                },
                _getRelationshipGridConfig: function (relationshipTypeName) {
                    return this._relationshipGridConfigs[relationshipTypeName];
                },
                _isUpdirection: function(relType) {
                    if(this.relationshipGridConfigs[relType].direction == "up") {
                        return true;
                    }

                    return false;
                },
                _onWorkflowActionTap: function(e, detail) {
                    var selectedItems;
                    var relationship = detail.data.relationship;
                    var selectionMode = "count"; //set default
                    var selectionQuery = {};

                    if(this.$$("rock-where-used-grid[id=entityRelationshipGrid_" + relationship + "]")) {
                        selectedItems = this.$$("rock-where-used-grid[id=entityRelationshipGrid_" + relationship + "]").getSelectedItems();
                    }

                    //SelectedItems should not be blank, because using count
                    if(_.isEmpty(selectedItems)) {
                        this.showErrorToast("Select atleast one entity for which you want to perform this action.");
                        return;
                    }

                    //Workflow and activity name should be same for the selected items to process Transitions or Assignments
                    if(!this._isSelectedItemsValid(selectedItems)) {
                        this.showErrorToast("All selected entities should be under same workflow and activity to perform this action");
                        return;
                    }

                    //Prepare selectedItems as per business function requirement
                    var businessFunctionSelectedItems = [];
                    var entityIds = [];
                    var entityTypes = [];

                    //Pick the workflow details from one of the selectedItems
                    var wfDetails = {
                        "workflowName": selectedItems[0].workflowName,
                        "workflowLongName": selectedItems[0].workflowLongName,
                        "activityName": selectedItems[0].activityName,
                        "activityLongName": selectedItems[0].activityLongName
                    };

                    //Prepare required details for BF process
                    for(var i = 0; i < selectedItems.length; i++) {
                        businessFunctionSelectedItems.push({
                            "id": selectedItems[i].id,
                            "type": selectedItems[i].type
                        });
                    }

                    //Prepare selectionQuery - Remove when selection implemented for the govern grid
                    selectionQuery.ids = [...new Set(selectedItems.map((obj) => obj.id))];
                    selectionQuery.filters = {
                        "typesCriterion": [...new Set(selectedItems.map((obj) => obj.type))]
                    };

                    if(detail.data.eventName == "action-takeTask" || detail.data.eventName == "action-releaseTask") {
                        var action = detail.data.eventName == "action-takeTask" ? "take" : "release";
                        this._showAssignmentDialog(detail, action, selectionMode, selectionQuery, businessFunctionSelectedItems, wfDetails);
                    }
                    else if(detail.data.eventName == "action-wfTransitions") {
                        this._showTransitionDialog(detail, action, selectionMode, selectionQuery, businessFunctionSelectedItems, wfDetails);
                    }
                },
                _isSelectedItemsValid: function(selectedItems) {
                    var isValid = true;
                    for(var i = 1; i < selectedItems.length; i++) {
                        if(selectedItems[i].workflowName != selectedItems[i - 1].workflowName ||
                           selectedItems[i].activityName != selectedItems[i - 1].activityName) {
                            isValid = false;
                            break;
                        }
                    }

                    return isValid;
                },
                _showAssignmentDialog: function (detail, action, selectionMode, selectionQuery, selectedItems, wfDetails) {
                    var assignmentDialog = this.$$("#wfAssignmentDialog");
                    assignmentDialog.name = detail.data.componentName;
                    assignmentDialog.sharedData = { "selection-mode": selectionMode, "selection-query": selectionQuery, "selected-entities": selectedItems, "context-data": this.contextData, "assignment-Action": action, "workflow-external-name": wfDetails.workflowLongName, "workflow-activity-external-name": wfDetails.activityLongName, "workflow-name": wfDetails.workflowName, "workflow-activity-name": wfDetails.activityName };
                    assignmentDialog.open();
                },
                _showTransitionDialog: function (detail, action, selectionMode, selectionQuery, selectedItems, wfDetails) {
                    var currentWorkflow = {
                        "name": wfDetails.workflowLongName,
                        "activityName": wfDetails.activityName,
                        "activityExternalName": wfDetails.activityLongName
                    }

                    var transitionDialog = this.$$("#wfTransitionDialog");
                    transitionDialog.name = detail.data.componentName;
                    transitionDialog.sharedData = { "selection-mode": selectionMode, "selection-query": selectionQuery, "selected-entities": selectedItems, "context-data": this.contextData, "current-workflow": currentWorkflow };
                    transitionDialog.open();
                    var existingTitle = transitionDialog.getTitle();
                    transitionDialog.setTitle(existingTitle + " - " + wfDetails.activityLongName);
                }
            });
        })();
    </script>
</dom-module>