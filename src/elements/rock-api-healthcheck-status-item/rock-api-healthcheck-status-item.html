<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/communication-icons.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icon/pebble-icon-updated.html">

<dom-module id="rock-api-healthcheck-status-item">

  <template>
      <style include="bedrock-style-common bedrock-style-gridsystem bedrock-styles-scroll-bar">
         :host {
          margin-bottom: 2px;
          display: table;
          width: 100%;
        }

        pre {
          max-height: 400px;
          overflow-y: scroll;
        }

        .statusRow {
          cursor: pointer;
        }

        #descriptionRow {
          padding: 10px 10px 10px 40px;
          width: 100%;
          font-size: var(--default-font-size, 14px);
        }

        .descriptipn-title {
          vertical-align: text-top;
        }

        .status-title-wrap {
          background-color: var(--palette-pale-grey-four, #eff4f8);
        }

        .status-title {
          padding: 5px 0 5px 5px;
        }
        .pebble-status-desc-icon {
          display:inline-block;
          vertical-align: middle;
        }
      </style>
    <div class="statusRow">
      <div class="status-title-wrap" on-click="_handleRowClick">        
          <div class="col-12">
            <div class="status-title">      
              <pebble-icon-updated icon="pebble-icon:Check" id="statusIcon" class="pebble-icon-size-16 pebble-status-desc-icon"></pebble-icon-updated>
              <span class="m-l-8 descriptipn-title">{{name}}</span>
              <div class="m-l-4 pull-right">
                <span class="descriptipn-title">{{timeTaken}} ms</span>
                <span class="flex"></span>
                <pebble-icon-updated icon="pebble-icon:RightArrow" class="pebble-icon-size-16" id="descriptionIcon"></pebble-icon-updated>
              </div>
            </div>
          </div>        
      </div>
      <div id="descriptionRow" hidden$="{{!collapse}}"> 
          <div><strong>Url: </strong>{{url}}</div>                  
          <div><strong>Message: </strong>{{message}}</div> 
          <pebble-button raised noink on-click="_handleModalOpen" class="btn btn-success m-t-15" button-text="View technical detail"></pebble-button>
          <pebble-dialog id="pebbleDialog" show-close-icon dialog-title="Technical detail" modal>
            <pre>{{detail}}</pre>
            <div class="buttons">
              <pebble-button dialog-confirm class="btn btn-secondary" button-text="Ok"></pebble-button>      
            </div>
          </pebble-dialog>
      </div>      
    </div>
    <liquid-rest id="mycall" url="{{url}}" method="GET" request-data="{{request}}" on-response="_onResponseReceived" on-error="_onResponseFailed">
    </liquid-rest>
  </template>
  <script>
    Polymer({
      is: 'rock-api-healthcheck-status-item',
      ready: function () {
        this.$.mycall.generateRequest()
      },
      _onResponseReceived: function (e) {
        var response = e.detail.response;

        if (response.status == "success") {
          this.$.statusIcon.icon = "pebble-sm-icons:successCheck";
        }
        else if (response.status == "error") {
          this.$.statusIcon.icon = "pebble-sm-icons:errorcheck";
        }
        else if (response.status == "warning") {
          this.$.statusIcon.icon = "pebble-sm-icons:indeterminate";
        }

        this.status = response.status;
        this.message =response.msg;
        this.detail = JSON.stringify(response.detail, undefined, 2);
        this.timeTaken = response.detail && response.detail.stats && response.detail.stats.timeTaken ? response.detail.stats.timeTaken : "-1";
      },
      _onResponseFailed: function (event, response) {
        this.collapse = true;
        this.$.statusIcon.icon = "pebble-sm-icons:errorcheck";
      },
      _handleRowClick: function () {
        this.collapse = !this.collapse;
        if (this.collapse) {
          this.$.descriptionIcon.icon = "pebble-sm-icons:Expand";
        } else {
          this.$.descriptionIcon.icon = "pebble-sm-icons:Collapse";
        }
      },
      _handleModalOpen: function () {
        this.$.pebbleDialog.open();
      },

      properties: {
        name: {
          type: String
        },
        collapse: {
          type: Boolean,
          value: false

        },
        url: {
          name: {
            type: String
          }
        },
        message: {
          name: {
            type: String
          }
        },
        status: {
          type: String,
          value: "Unknown"
        },
        detail: {
          type: String,
          value: ""
        },
        timeTaken: {
          type: String,
          value: "-1"
        }
      }
    });
  </script>
</dom-module>