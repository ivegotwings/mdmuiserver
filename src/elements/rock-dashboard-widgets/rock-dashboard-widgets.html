<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/mutable-data.html">
<link rel="import" href="../rock-widget-panel/rock-widget-panel.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
@group rock Elements
@element rock-dashboard-widgets
@demo demo/index.html
-->
<dom-module id="rock-dashboard-widgets">
    <template>
        <style>
            rock-widget-panel{
                display:block;
                @apply --rock-widget-panel;
            }
        </style>
       <rock-widget-panel config="[[config]]" context-data="[[contextData]]"></rock-widget-panel>
    </template>
    <script>
        class RockDashboardWidgets
            extends Polymer.mixinBehaviors([RUFBehaviors.ComponentConfigBehavior], Polymer.OptionalMutableData(Polymer.Element)) {
            static get is() { return 'rock-dashboard-widgets' }
            ready() {
                super.ready();
            }
            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function() {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },
                    config: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    type: {
                        type: String
                    }
                }
            }
            /**
            *
            */
            connectedCallback() {
                super.connectedCallback();
            }
            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }
            _onContextDataChange() {
                Polymer.RenderStatus.afterNextRender(this,()=>{
                    if(this.type && !_.isEmpty(this.contextData)) {
                        let context = DataHelper.cloneObject(this.contextData);
                        //App specific
                        let appName = ComponentHelper.getCurrentActiveAppName();
                        if(appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }

                    this.requestConfig("rock-"+this.type+"-widgets", context);
                }
                });
            }
            onConfigLoaded(componentConfig) {
                if(componentConfig && componentConfig.config) {
                    let config = componentConfig.config;
                    let widgets = DataHelper.convertObjectToArray(config.widgets);
                    for(let widget in widgets){
                        if(widgets[widget].config){
                            widgets[widget].config.iconButtons = DataHelper.convertObjectToArray(widgets[widget].config.iconButtons);
                        }
                    }
                    config.widgets = widgets;
                    this.config = config;
                }
            }
            
            
        }
        customElements.define(RockDashboardWidgets.is, RockDashboardWidgets);
    </script>
</dom-module>