<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-externalref-falcor/bedrock-externalref-falcor.html">

<script>
  /*
  * @demo demo/index.html
  * @polymerBehavior RUFBehaviors.DataChannel
  */
  'use strict';

  var RUFBehaviors = RUFBehaviors || {};


  RUFBehaviors.DataChannel = {

    properties: {
      /**
        * Indicates key for the translation.If it is set to <b>true</b>, then it uses provided key when
        * the translation does not exist for that key.
        */
      _models: {
        type: Object,
        value: {}
      },
      callCounters: {
        type: Object,
        value: function () {
          return {};
        }
      }
    },
    getCallCounters: function () {
      return JSON.stringify(this.callCounters);
    },
    updateCallCounters: function (operation) {

      if (this.callCounters === undefined) {
        this.callCounters = {}
      };

      if (this.callCounters[operation] !== undefined) {
        this.callCounters[operation] = this.callCounters[operation] + 1
      }
      else {
        this.callCounters[operation] = 1;
      }
    },
    getModel: function (channelName) {
      if (channelName === undefined || channelName === '') {
        channelName = 'dataObjectChannel'; // Do we need this default?
      }

      var model = null;

      if (this._models === undefined) {
        this._models = {};
      }

      if (this._models === {} || this._models[channelName] === undefined) {
        model = this._createModel(channelName);
        if (this._models[channelName] === undefined) { //just double check..
          this._models[channelName] = model;
        }
      }
      else {
        model = this._models[channelName];
      }

      return model;
    },
    _createModel: function (channelName) {
      var channelConfig = this._getChannelConfig(channelName);

      var tenantId = this._getTenantId();
      channelConfig.path = channelConfig.path + '?tid=' + tenantId;

      var falcorDataSource = new falcor.HttpDataSource(channelConfig.path, { crossDomain: true, withCredentials: false });
      var model = new falcor.Model({
        source: falcorDataSource,
        maxSize: channelConfig.maxSize,
        collectRatio: channelConfig.collectRatio//,
        // errorSelector: function(error){
        //     error.$expires = -1000 * 60 * 2;
        // } 
      });

      if (channelConfig.treatErrorsAsValues) {
        model.treatErrorsAsValues();
      }

      return model;
    },
    _getChannelConfig: function (channelName) {
      var allConfigs = this._getAllChannelConfigs();
      if (allConfigs.channels[channelName] !== undefined) {
        return allConfigs.channels[channelName];
      }
      else {
        throw "Requested data channel " + channelName + " does not exist in channel config";
      }
    },
    _getAllChannelConfigs: function () {
      return {
        'channels': {
          'dataObjectChannel': {
            'path': '/data/dataObjects.json',
            'maxSize': 15000,
            'collectRatio': 0.75,
            'treatErrorsAsValues': false
          },
          'configDataChannel': {
            'path': '/data/configs.json',
            'maxSize': 15000,
            'collectRatio': 0.75,
            'treatErrorsAsValues': false
          },
          'notificationDataChannel': {
            'path': '/data/notificationData.json',
            'maxSize': 15000,
            'collectRatio': 0.75,
            'treatErrorsAsValues': false
          }
        }
      };
    },
    _getTenantId: function () {
      var tenantId = 't1';
      var mainApp = document.querySelector("main-app");
      if (mainApp) {
        tenantId = mainApp.tenantId;
      }
      
      return tenantId;
    }
  };

</script>