<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-attribute-manage/rock-attribute-manage.html">


<dom-module id="rock-business-condition-attribute-manage">
    <template>
        <style include="pebble-styles-shared"></style>

        <liquid-entity-model-get id="businessConditionsGet" operation="getbyids" request-id="businessConditionsGet" on-response="_onBusinessConditionsGetResponse"
                                 on-error="_onBusinessConditionsGetError"></liquid-entity-model-get>
        <rock-attribute-manage id="attributeManage" mode="edit" functional-mode="dataFunction" configContext="{}"></rock-attribute-manage>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'rock-business-condition-attribute-manage',
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                properties: {
                    businessConditionId: {
                        type: String,
                        value: ""
                    },
                    contextData:{
                        type:Object,
                        value:function () {
                            return {};
                        }
                    },
                    _impactAttributes : {
                        type:Array,
                        value:function () {
                            return [];
                        }
                    }
                },
                observers:['_initialConditionsLoaded(businessConditionId,contextData)'],
                _initialConditionsLoaded: function (businessConditionId,contextData) {
                    if(businessConditionId && contextData && !_.isEmpty(contextData)){
                        this._requestBusinessConditions();
                    }
                },
                _requestBusinessConditions: function () {
                        var clonedContextData = DataHelper.cloneObject(this.contextData);
                        // Prepare ItemContext
                        var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                        itemContext.id = this.businessConditionId;
                        itemContext.type = "businessCondition";
                        itemContext.attributes=["impactAttributes"];

                        clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                        // Create Request and Get
                        var businessConditionsGet = this.$$('#businessConditionsGet');
                        if (businessConditionsGet) {
                            businessConditionsGet.requestData = DataRequestHelper.createEntityGetRequest(clonedContextData);
                            businessConditionsGet.generateRequest();
                        }
                },
                _onBusinessConditionsGetResponse: function (e) {
                    var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                    if (responseContent) {
                        var businessConditions = responseContent.entityModels;
                        var dataContext = ContextHelper.getFirstDataContext(this.contextData);
                        if (typeof (businessConditions) !== "undefined" && businessConditions.length > 0) {
                                var businessCondition = businessConditions[0];
                                var attributes=DataTransformHelper.transformAttributes(businessCondition,{},this.contextData);
                                if(attributes && attributes["impactAttributes"] ){
                                     this._impactAttributes=attributes["impactAttributes"].value;
                                }
                        }
                    }
                    this._setAttributeManageContext();
                },
                _setAttributeManageContext:function () {
                    var attributeManage=this.$$("#attributeManage");
                    if(attributeManage){
                        var contextData=DataHelper.cloneObject(this.contextData);
                        var itemContext=ContextHelper.getFirstItemContext(contextData);
                        itemContext.attributeNames=["id","displayName","brand"];
                        attributeManage.contextData=contextData;
                    }
                }
            });
        })();
    </script>
</dom-module>