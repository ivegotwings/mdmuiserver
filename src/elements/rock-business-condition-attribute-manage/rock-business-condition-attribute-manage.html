<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-attribute-manage/rock-attribute-manage.html">


<dom-module id="rock-business-condition-attribute-manage">
    <template>
        <style include="pebble-styles-shared"></style>

        <liquid-entity-model-get id="businessConditionsGet" operation="getbyids" request-id="businessConditionsGet" on-response="_onBusinessConditionsGetResponse"
                                 on-error="_onBusinessConditionsGetError"></liquid-entity-model-get>
        <template is="dom-if" if="[[_noAttributesFound]]">
            <div align="center">
                No attributes configured for this business condition. Please contact system administrator.
            </div>
        </template>
        <rock-attribute-manage allow-save-on-error id="attributeManage" no-of-columns="3" mode="edit" functional-mode="dataFunction" config-context="[[configContext]]"></rock-attribute-manage>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'rock-business-condition-attribute-manage',
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                properties: {
                    businessConditionId: {
                        type: String,
                        value: ""
                    },
                    contextData:{
                        type:Object,
                        value:function () {
                            return {};
                        }
                    },
                    configContext:{
                        type:Object,
                        value:function () {
                            return {}
                        }
                    },
                    _impactAttributes : {
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },
                    _noAttributesFound:{
                        type:Boolean,
                        value:false
                    }
                },
                observers:['_initialConditionsLoaded(businessConditionId,contextData)'],
                _initialConditionsLoaded: function (businessConditionId,contextData) {
                    if(businessConditionId && contextData && !_.isEmpty(contextData)){
                        this._requestBusinessConditions();
                    }

                },
                _requestBusinessConditions: function () {
                        var clonedContextData = DataHelper.cloneObject(this.contextData);
                        // Prepare ItemContext
                        var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                        itemContext.id = this.businessConditionId;
                        itemContext.type = "businessCondition";
                        itemContext.attributeNames=["impactAttributes"];
                        clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                        clonedContextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
                        // Create Request and Get
                        var businessConditionsGet = this.$$('#businessConditionsGet');
                        if (businessConditionsGet) {
                            businessConditionsGet.requestData = DataRequestHelper.createEntityGetRequest(clonedContextData);
                            businessConditionsGet.generateRequest();
                        }
                },
                _onBusinessConditionsGetResponse: function (e) {
                    var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                    if (responseContent) {
                        var businessConditions = responseContent.entityModels;
                        if (typeof (businessConditions) !== "undefined" && businessConditions.length > 0) {
                                var businessCondition = businessConditions[0];
                                this.configContext = {"groupName": businessCondition.name};
                            var impactAttributesObj=EntityHelper.getAttribute(businessCondition,"impactAttributes");
                                if(impactAttributesObj ){
                                     this._impactAttributes=AttributeHelper.getAttributeValues(impactAttributesObj.values,this.contextData[ContextHelper.CONTEXT_TYPE_VALUE]);
                                }
                        }
                    }
                    this._setAttributeManageContext();
                },
                _setAttributeManageContext:function () {
                    var attributeManage=this.$$("#attributeManage");
                    if(this._impactAttributes && this._impactAttributes.length) {
                        if (attributeManage) {
                            var contextData = DataHelper.cloneObject(this.contextData);
                            var itemContext = ContextHelper.getFirstItemContext(contextData);
                            itemContext.attributeNames = this._impactAttributes;
                            attributeManage.contextData = contextData;
                        }
                    } else{
                        this._noAttributesFound=true;
                    }
                }
            });
        })();
    </script>
</dom-module>