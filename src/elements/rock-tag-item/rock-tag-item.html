<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">
<link rel="import" href="../pebble-datetime-picker/pebble-datetime-picker-overlay.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<!--
`rock-tag-item`
 tag item which can be used in filters or for representing some selection.
@demo demo/index.html
-->
<dom-module id="rock-tag-item">
    <template>
        <style include="pebble-styles-app"></style>
        <style>
         :host {
                display: inline-flex;
                display: -webkit-inline-flex;
                box-sizing: border-box;
                margin-right:var(--default-margin-right,6px);
                vertical-align: top;
                --default-tag-border:#ff0;
                --paper-radio-button-size:var(--font-size-sm);
                font-size: var(--default-font-size, 14px);
            }           
            .tag-value{
                font-size:var(--font-size-sm);
                line-height: var(--default-tag-height,21px);
                display:inline-flex;
                margin-right: 4px;
            }
            .tag-item-container{
                @apply(--tag-style);
                float:left;
                margin: 5px 0;
            }
            .tag-item-container.green {
                border-left-color: var(--palette-kelly-green);
            }
            .tag-item-container.orange {
                border-left-color: var(--palette-pumpkin-orange);
            }
            .tag-item-container.violet {
                border-left-color: var(--palette-deep-lavender);
            }
            .tag-item-container.yellow {
                border-left-color: var(--palette-goldenrod);
            }
            paper-input {
                width: 90%;
            }
            .dialogOptions paper-radio-button{
                display: block ;
            }
            paper-button.datebuttons {
                margin-top: 10px;
                height: 30px;
                min-width: 150px;
                background: #DBE4EB;
                border-radius: 2px;
                display: block;
                margin-top: 6px !important;
                padding-top: 6px !important;
                margin-left: 15px !important;
                margin-right: 15px !important;
                text-align: center;
            }
            paper-button.datebuttons:hover {
                background: #1976D2;
                color: #FFFFFF;
            }
            paper-button.datebuttons[active]{
                background: #1976D2;
                color: #FFFFFF;
            }
            .name{
                color: #1a2028;
            }
            pebble-button {
                text-transform: none;
                border-radius: 3px;
                height: 30px;
                line-height: 30px;
            }  
            pebble-button::shadow paper-button{
                font-size: var(--default-font-size, 14px);
                width: 100px;
            }  
            #filterPopover{
                min-width: 240px;
                padding: 10px;
            }
            pebble-textarea::shadow paper-textarea::shadow paper-input-container{
                padding: 0;
            }
            pebble-textarea::shadow paper-textarea::shadow paper-input-container::shadow .floated-label-placeholder{
                line-height: 0;
            }
            pebble-popover::shadow .arrow_box:before, pebble-popover::shadow .arrow_box:after{
                top: -24px;
            }
            pebble-popover::shadow .arrow_box:before{
                border-width: 7px;
            }
            pebble-popover pebble-lov{
                 padding: 0;
            }
            pebble-popover pebble-lov::shadow #searchbox .item{
                padding-top: 0;
            }
            pebble-popover .dialogOptions paper-radio-button{
                padding: 0px 0 20px 0;
            }
            pebble-popover .dialogOptions paper-radio-button::shadow #offRadio, pebble-popover .dialogOptions paper-radio-button::shadow #onRadio{
                top: -9px;
            }
            pebble-popover .dialogOptions paper-radio-button input{               
                width: 100px;
                font-size: 15px;
                padding: 0 4px;
                line-height: 30px;
            }
        </style>
        <div id="rock-tag" class="tag-item-container border">
            <template is="dom-if" if="{{_isIconEnabled}}">
                <iron-icon id="icon" src="[[src]]" icon="[[icon]]"></iron-icon>
            </template>
            <span class="tag-value" on-tap="_onTapEvent"><span class="name">{{longName}}:</span>
            <template is="dom-if" if="{{_hasValue}}">
                {{valueString}}
            </template>
            <template is="dom-if" if="{{!_hasValue}}">
                All
            </template>
            </span>
            <pebble-icon on-tap="_onTapEvent" icon="pebble-icons:ExpandMore"></pebble-icon>
            <template is="dom-if" if="{{!disableDelete}}">
                <paper-icon-button on-tap="_removeItem" icon="pebble-icons:TagCancel"></paper-icon-button>
            </template>
        </div>
        <pebble-popover id="filterPopover" for="rock-tag" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
            <template is="dom-if" if="{{_isTextBox}}">
               <pebble-lov id="lov" items="{{options}}" multi-select show-image on-selection-changed="_lovSelectionChanged" show-sub-title>
                </pebble-lov>
            </template>
            <template is="dom-if" if="{{_isTextArea}}">
                <pebble-textarea class="input" placeholder="{{longName}}" value="{{temp}}"></pebble-textarea>
                <div class="PebbleButtonPadding text-center m-t-15">
                    <pebble-button class="success-btn m-r-7" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
                    <pebble-button class="default-btn" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
                    <div class="clearfix"></div>
                </div>
            </template>
            <template is="dom-if" if="{{_isNumeric}}">
                <paper-radio-group aria-labelledby="{{longName}}" class="dialogOptions">
                    <paper-radio-button name="range">
                        <div class="col-50 pull-left">
                            <div class="radio-name">Min</div>
                            <input is="iron-input" type="number" bind-value="{{gte}}">
                        </div>
                        <div class="col-50 pull-left">
                            <div class="radio-name">Max</div>
                            <input is="iron-input" type="number" bind-value="{{lte}}">
                        </div>
                        <div class="clearfix"></div>
                    </paper-radio-button>
                    <paper-radio-button name="equalToDate">
                        <div class="col-90 pull-left">
                            <div class="radio-name">Equal to</div>
                            <input is="iron-input" type="number" bind-value="{{equalNum}}">
                        </div>
                        <div class="clearfix"></div>
                    </paper-radio-button>
                </paper-radio-group>
                <div class="PebbleButtonPadding text-center">
                    <pebble-button class="success-btn m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
                    <pebble-button class="default-btn m-l-5" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
                </div>
            </template>
        </pebble-popover>
        <template is="dom-if" if="{{_isDateTime}}">
            <pebble-datetime-picker-overlay id="rangepicker" for="rock-tag" picker-type="daterange" show-ranges heading-format="ddd, MMM DD YYYY"
                start-date-value="{{gte}}" end-date-value="{{lte}}" on-date-range-selected="_updateValue"></pebble-datetime-picker-overlay>
        </template>
    </template>
    <script>
        Polymer({
            is: 'rock-tag-item',
            properties: {
                /**
                 * Fired when the tag is to be removed from the tag list. Data passed:  {index: this.index}
                 *
                 * @event tag-item-remove
                 */

                /**
                 * Fired when the tag is not editable and on tap of tag. Data passed:  {index: this.index}
                 *
                 * @event tag-item-select
                 */

                /**
                 * Fired when user edits the tag and tag is changed equal edit mode to view mode.
                 *
                 * @event tag-value-change (pub-sub event)
                 * @param {Object} detail
                 * @param {Object} detail.name gives the attribute name  
                 * @param {Object} detail.value gives the attribute value			
                 */
                /**
                 * Indicates the index of a tag.
                 */
                index: {
                    type: Number,
                    value: 0
                },
                /**
                 * Indicates the size of the tags. possible values: small, medium and large.
                 */
                size: {
                    type: String,
                    value: 'small'
                },
                /**
             * Specifies whether or not a tag must be deleted.
    
             */
                disableDelete: {
                    type: Boolean,
                    value: false
                },
                /**
                 * Indicates the value of the attribute shown in the tag.
                 */
                value: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    notify: true
                },
                /**
                 * Indicates the name of the attribute shown in the tag.
                 */
                name: {
                    type: String,
                    value: '',
                    notify: true
                },
                /**
                 * Indicates the long name of the attribute shown in the tag.
                 */
                longName: {
                    type: String,
                    value: '',
                    notify: true
                },
                /**
                 * Boolean flag which will become true when user passes icon( name of icon present in icons set) or src(image path).
                 */
                _isIconEnabled: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                /**
                 * Specifies the icon name or index in the set of icons available in
                 * the icon set. Note that you must not specify the src property when the icon property is specified.
                 */
                icon: {
                    type: String,
                    value: '',
                    notify: true,
                    observer: '_iconPassed'
                },
                /**
            * Indicates the URL of an image for the icon. Note that you must not specify the src property when the icon property is specified.
    .
            */
                src: {
                    type: String,
                    value: '',
                    notify: true,
                    observer: '_iconPassed'
                },
                /**
                 * Specifies whether or not the value of the tag is editable.
                 */
                isNonEditable: {
                    type: Boolean,
                    value: false
                },
                /**
                 * Boolean flag to check if the attribute only has both name and value or only name
                 */
                _hasValue: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    computed: '_isValueDefined(value)'
                },
                /**
                 * Indicates the Color of the tag.
                 */
                tagColor: {
                    type: String,
                    notify: true,
                    observer: '_colorChanged'
                },
                /**
                 * Indicates the display type of the tag.
                 */
                displayType: {
                    type: String,
                    observer: "_displayTypeChanged"
                },
                /**
                 * Indicates the measurement dimension for the selected time.
                 */
                selectedTimeMeasure: {
                    type: String,
                    value: "Minutes"
                },
                /**
                 * Indicates the from Date value.
                 */
                fromDate: {
                    type: String
                },
                 /**
                 * Indicates the complete value string to be shown in tag.
                 */
                valueString: {
                    type: String,
                    value: ""
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            /**
             * Change the tag from view  mode to edit mode
             */
            _makeEditable: function () {
                if (this._isDateTime) {
                    this.async(function () {
                        this.$$('#rangepicker').open();
                    });
                } else {
                    this.$.filterPopover.positionTarget = this.$$('.tag-value');
                    this.$.filterPopover.open();
                    if (this.$$('#lov')) {
                        this.$$('#lov').activate();
                    }
                    //need to give some time to polymer to reflect the property change, thus async
                    this.async(function () {
                        var input = this.$.filterPopover.querySelector(".input");
                        if (input) {
                            input.focus();
                        }
                    }, 2);
                }
                this.fire('tag-item-opened',this);
            },
            /**
             * Change the tag from edit  mode to view mode
             */
            _fireChangeEvent: function () {
                var attribute = {
                    name: this.name,
                    value: this.value
                };
                if (this.value != undefined && this.value != null && this.name != undefined && this.name !=
                    null) {
                    this.fireBedrockEvent('tag-value-change', attribute, {
                        ignoreId: true
                    });
                }
            },
            _displayTypeChanged: function () {
                switch (this.displayType) {
                    case 'textBox':
                        this._isTextBox = true;
                        break;
                    case 'textArea':
                        this._isTextArea = true;
                        break;
                    case 'dropDown':
                        this._isDropDown = true;
                        break;
                    case 'dateTime':
                        this._isDateTime = true;
                        break;
                    case 'numeric':
                        this._isNumeric = true;
                        break;
                }
            },
            /**
             * This method is called when someone taps on the tag. If tag is editable, then the tag is switched to edit mode otherwise tag-item-select event is fired
             */
            _onTapEvent: function (e) {
                if (!this.isNonEditable) {
                    this._makeEditable();
                } else {
                    this.fireBedrockEvent('tag-item-select', {
                        index: this.index
                    });
                }
            },
            /**
             * Handler for removing the tag item
             */
            _removeItem: function () {
                if (!this.disableDelete) {
                    var attribute = {
                        name: this.name,
                        index: this.index
                    };
                    this.valueString = "";
                    this.value = {};
                    this.fire('tag-item-remove', attribute);
                }
            },
            /**
             * Handler for checking if value exists
             */
            _isValueDefined: function (value) {
                if (value) {
                    if (_.isEmpty(value) || value.hasOwnProperty("eq") && !value.eq) {
                        return false;
                    }
                    this.setValueString(value);
                    return true;
                } else {
                    return false;
                }
            },
            /**
             * Handler for checking if any icon name is passed or any path for an icon is provided
             */
            _iconPassed: function () {
                if (this.icon || this.src) {
                    this._isIconEnabled = true;
                } else {
                    this._isIconEnabled = false;
                }
            },
            /**
             * Handler for checking if tagColor attribute is changed and if changed, change the color of the tag to the new color
             */
            _colorChanged: function () {
                if (this.tagColor) {
                    this.customStyle['--tag-color'] = this.tagColor;
                }
                this.updateStyles();
            },
            attached: function () {
                if (!this.longName && this.name) {
                    this.longName = this.name;
                }
                if (!this.displayType) {
                    this.displayType = "textArea";
                }
            },
            _updateValue: function (e) {
                if (this._isDateTime) {
                    if (this.gte == this.lte) {
                        this.value = {
                            "eq": this.gte
                        };
                    } else {
                        this.value = {
                            "gte": this.gte,
                            "lte": this.lte
                        };
                    }
                } else if (this._isNumeric) {
                    if (this.$$('paper-radio-group').selected == "range") {
                        this.value = {
                            "gte": this.gte,
                            "lte": this.lte
                        };
                    } else {
                        this.value = {
                            "eq": this.equalNum
                        };
                    }
                } else {
                    this.value = {
                        "eq": this.temp
                    };
                }
                this.setValueString(this.value);
                this.$.filterPopover.hide();
                this._fireChangeEvent();
            },
            _dismissDialog: function () {
                this.$.filterPopover.hide();
            },
            /** 
            * Can be used to set the value for the valueString property.
            */
            setValueString: function (value) {
                if (value.gte && value.lte) {
                    this.valueString = value.gte + "-" + value.lte;
                    this.gte = value.gte;
                    this.lte = value.lte;
                } else if (value.gte) {
                    this.valueString = ">= " + value.gte;
                    this.gte = value.gte;
                } else if (value.lte) {
                    this.valueString = "<= " + value.lte;
                    this.lte = value.lte;
                } else if (value.eq) {
                    this.valueString = value.eq;
                    this.temp = value.eq;
                } else if (value.from && value.to) {
                    this.valueString = value.from + "-" + value.to;
                    this.from = value.from;
                    this.to = value.to;
                } else {
                    this.valueString = "";
                }
            },
            _lovSelectionChanged: function () {
                var lov = this.$$("#lov");
                var selectedItems = [];
                for (var i = 0; i < lov.selectedItems.length; i++) {
                    selectedItems.push(lov.selectedItems[i].title);
                }
                this.value = {
                    "eq": selectedItems
                };
                this.setValueString(this.value);
                this._fireChangeEvent();
            }
        });
    </script>
</dom-module>