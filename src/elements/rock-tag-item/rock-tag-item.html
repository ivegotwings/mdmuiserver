<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">
<link rel="import" href="../pebble-datetime-picker/pebble-datetime-picker.html">
<link rel="import" href="../pebble-time-picker/pebble-time-picker.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">

<!--
`rock-tag-item`
 tag item which can be used in filters or for representing some selection.

@demo demo/index.html
-->
<dom-module id="rock-tag-item">
    <template>
        <style include="pebble-styles-app"></style>
        <style>
      :host {
        display: inline-flex;
        box-sizing: border-box;
        margin-right:var(--default-margin-right,6px);
        vertical-align: top;
        --default-tag-border:#ff0;
        --paper-radio-button-size:var(--font-size-small);
      }    
      .tag-value{
        font-size:var(--font-size-small);
        line-height: var(--default-tag-height,21px);
        display:inline-flex;
        margin-right: 4px;
      }
      .tag-item-container{
        @apply(--tag-style);
        float:left;
        margin: 4px 0;
      }
      paper-icon-button::shadow #icon{
        /*color: #333;
        height: 10px;*/
      }
      paper-input {
        width: 90%;
      }
      .dateOptions paper-radio-button{
             display: block ;
     }


    </style>

<div class="tag-item-container border">
        <template is="dom-if" if="{{_isIconEnabled}}">
            <iron-icon id="icon" src="[[src]]" icon="[[icon]]"></iron-icon>
        </template>
        <template is="dom-if" if="{{_hasValue}}">
            <span class="tag-value" on-tap="_onTapEvent">{{longName}}: {{value}}</span>
        </template>
        <template is="dom-if" if="{{!_hasValue}}">
            <span class="tag-value" on-tap="_onTapEvent">{{longName}}: All</span>
        </template>
        <template is="dom-if" if="{{editMode}}">
            <pebble-icon  icon="pebble-icons:ExpandMore"></pebble-icon>
        </template>
        <template is="dom-if" if="{{!disableDelete}}">
            <paper-icon-button on-tap="_removeItem" icon="pebble-icons:TagCancel"></paper-icon-button>
        </template>
</div>

        <pebble-dialog id="filterDialog" no-overlap horizontal-align="left" vertical-align="top" no-cancel-on-outside-click no-cancel-on-esc-key style="display: block;">
            <template is="dom-if" if="{{_isTextBox}}">
                <pebble-textbox  class="input" label="{{longName}}" value="{{temp}}"  ></pebble-textbox>
            </template>
            <template is="dom-if" if="{{_isCheckBox}}">
            <pebble-dropdown  class="input" label="{{longName}}" items="Yes,No"  selected-value="{{temp}}"></pebble-dropdown>
            </template>
            <template is="dom-if" if="{{_isTextArea}}">
            <pebble-textarea  class="input"  placeholder="{{longName}}"  value="{{temp}}" ></pebble-textarea>
            </template>
            <template is="dom-if" if="{{_isDateTime}}">
            <paper-radio-group aria-labelledby="{{longName}}" class="dateOptions">
                <paper-radio-button name="withInTime"  >
                   With in the last
                    <input   is="iron-input" style="width: 50px;margin: 0 5px 0 5px" type="number" bind-value="{{withinTime}}">
                    <pebble-dropdown  style="width: 50%; " items="Minutes,Seconds, Hours" selected-index="0"    selected-value="{{withinTimeMeasure}}"></pebble-dropdown>
                </paper-radio-button>
             <paper-radio-button name="moreThanTime">
                 More than  <input  is="iron-input" style="width: 50px;margin: 0 5px 0 5px" type="number" bind-value="{{moreThanTime}}">
                     <pebble-dropdown  style="width: 50%" items="Minutes,Seconds, Hours"  selected-index="0"   selected-value="{{moreThanTimeMeasure}}"></pebble-dropdown> ago
             </paper-radio-button>
             <paper-radio-button name="betweenDates">
                 Between
                 <input  style="width: 100px;margin-left:5px"  is="iron-input" bind-value="{{fromDate}}">
                 <pebble-button class="date-button"  id="fromPicker" icon="icons:date-range" picker="pickFromDate" on-tap="_showPicker" ></pebble-button>
                 and
                 <input  style="width: 100px;margin-left:5px"  is="iron-input"  bind-value="{{toDate}}">
                 <pebble-button class="date-button" id="toPicker" icon="icons:date-range"  picker="pickToDate" on-tap="_showPicker" ></pebble-button>
             </paper-radio-button>
            <paper-radio-button name="inRangeDuration">
                In range   <input   is="iron-input"  style="width: 70px;margin: 0 5px 0 5px;text-align: center" bind-value="{{fromDuration}}" placeholder="-3w 4d"> to   <input   is="iron-input"  style="width: 70px;margin: 0 5px 0 5px;text-align: center" bind-value="{{toDuration}}" placeholder="4w 3d">
            </paper-radio-button>
            <paper-radio-button name="equalToDate">
                    Equal to
                <input  is="iron-input" style="width: 100px;margin-left:5px" bind-value="{{equalDate}}">
                <pebble-button class="date-button"  id="equalPicker" icon="icons:date-range" picker="pickEqualDate" on-tap="_showPicker" ></pebble-button>
            </paper-radio-button>
            </paper-radio-group>
            </template>
            <template is="dom-if" if="{{_isNumeric}}">
                <paper-radio-group aria-labelledby="{{longName}}" class="dateOptions">
                    <paper-radio-button name="range">
                      Min
                        <input   is="iron-input" style="width: 70px;margin: 0 5px 0 5px" type="number" bind-value="{{min}}">
                      Max
                        <input   is="iron-input" style="width: 70px;margin: 0 5px 0 5px" type="number" bind-value="{{max}}">
                    </paper-radio-button>
                    <paper-radio-button name="equalToDate">
                        Equal to
                        <input  is="iron-input" style="width: 100px;margin-left:5px" type="number" bind-value="{{equalNum}}">
                    </paper-radio-button>
                </paper-radio-group>
            </template>
            <div>
            <paper-button raised dialog-confirm on-tap="_updateValue">Update</paper-button>
            <paper-button dialog-dismiss on-tap="_dismissDialog">Close</paper-button>
            </div>
        </pebble-dialog>


        <pebble-datetime-picker   id="pickFromDate" for="fromPicker" value="{{fromDate}}" picker-type="date" date-format="DD/MM/YYYY" date-value="{{fromDateValue}}" time-value="{{fromTimeValue}}" utc-value="{{fromUtcDateTime}}"></pebble-datetime-picker>
        <pebble-datetime-picker   id="pickToDate" for="toPicker" value="{{toDate}}" picker-type="date" date-format="DD/MM/YYYY" date-value="{{toDateValue}}" time-value="{{toTimeValue}}" utc-value="{{toUtcDateTime}}"></pebble-datetime-picker>
        <pebble-datetime-picker   id="pickEqualDate" for="equalPicker" value="{{equalDate}}" picker-type="date" date-format="DD/MM/YYYY" date-value="{{equalDateValue}}" time-value="{{equalTimeValue}}" utc-value="{{equalUtcDateTime}}"></pebble-datetime-picker>
    </template>
<script>

    Polymer({
        is: 'rock-tag-item',
        properties: {
            /**
            * Fired when the tag is to be removed from the tag list. Data passed:  {index: this.index}
            *
            * @event tag-item-remove
            */

            /**
            * Fired when the tag is not editable and on tap of tag. Data passed:  {index: this.index}
            *
            * @event tag-item-select
            */

            /**
                    * Fired when user edits the tag and tag is changed equal edit mode to view mode.
                    *
                    * @event tag-value-change (pub-sub event)
                    * @param {Object} detail
            * @param {Object} detail.name gives the attribute name  
            * @param {Object} detail.value gives the attribute value			
                    */

            /**
            * Indicates the index of a tag.
            */
            index: {
                type: Number,
                value: 0
            },
            /**
            * Indicates the size of the tags. possible values: small, medium and large.
            */
            size: {
                type: String,
                value: 'small'
            },
            /**
             * Specifies whether or not a tag must be deleted.
    
             */
            disableDelete: {
                type: Boolean,
                value: false
            },
            /**
            * Indicates the value of the attribute shown in the tag.
            */
            value: {
                type: String,
                value: '',
                notify: true
            },
            /**
            * Indicates the name of the attribute shown in the tag.
            */
            name: {
                type: String,
                value: '',
                notify: true
            },
            longName: {
                type: String,
                value: '',
                notify: true
            },
            /**
             * Specifies whether or not the tag is in view or edit mode.
             */
            editMode: {
                type: Boolean,
                value: false,
                notify:true
            },
            /**
             * Boolean flag which will become true when user passes icon( name of icon present in icons set) or src(image path).
            */
            _isIconEnabled: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Specifies the icon name or index in the set of icons available in
             * the icon set. Note that you must not specify the src property when the icon property is specified.
             */
            icon: {
                type: String,
                value: '',
                notify: true,
                observer: '_iconPassed'
            },
            /**
            * Indicates the URL of an image for the icon. Note that you must not specify the src property when the icon property is specified.
    .
            */
            src: {
                type: String,
                value: '',
                notify: true,
                observer: '_iconPassed'
            },
            /**
             * Specifies whether or not the value of the tag is editable.
            */
            isNonEditable: {
                type: Boolean,
                value: false
            },
            /**
             * Boolean flag to check if the attribute only has both name and value or only name
             */
            _hasValue: {
                type: Boolean,
                value: false,
                notify: true,
                computed: '_isValueDefined(value)'
            },
            /**
             * Indicates the Color of the tag.
             */
            tagColor: {
                type: String,
                notify: true,
                observer: '_colorChanged'
            },
            displayType:{
                type:String,
                observer:"_displayTypeChanged"
            },
            selectedTimeMeasure:{
                type:String,
                value:"Minutes"
            },
            fromDate:{
                type:String
            }
        },
        /**
          * Change the tag from view  mode to edit mode
        */
        _makeEditable: function (e) {
            this.editMode = true;
            //need to give some time to polymer to reflect the property change, thus async
                this.$.filterDialog.positionTarget =this.$$('.tag-value');
                this.$.filterDialog.open();
                this.async(function () {
                    var input= this.$.filterDialog.querySelector(".input");
                    if(input) {
                        input.focus();
                    }
                },2);
        },
        /**
          * Change the tag from edit  mode to view mode
        */
        _makeNonEditable: function (e,value) {
            this.editMode = false;
            var attribute = {
                name: this.name,
                value:value
            };
            if (this.value != undefined && this.value != null && this.name != undefined && this.name != null) {
                this.fire('bedrock-event', { name: "tag-value-change", data: attribute });
            }
        },
        _displayTypeChanged: function () {
              switch(this.displayType){
                  case 'checkBox':
                      this._isCheckBox=true;
                      break;
                  case 'textBox':
                      this._isTextBox=true;
                      break;
                  case 'textArea':
                      this._isTextArea=true;
                      break;
                  case 'dropDown':
                      this._isDropDown=true;
                      break;
                  case 'dateTime':
                      this._isDateTime=true;
                      break;
                  case 'numeric':
                      this._isNumeric=true;
                      break;
              }
        },
        /**
          * This method is called when someone taps on the tag. If tag is editable, then the tag is switched to edit mode otherwise tag-item-select event is fired
        */
        _onTapEvent: function (e) {
            if (!this.isNonEditable) {
                this._makeEditable(e);
            } else {
                this.fire('tag-item-select', { index: this.index });
            }
        },
        /**
         * Handler for removing the tag item
         */
        _removeItem: function () {
            if (!this.disableDelete) {
                this.fire('tag-item-remove', { index: this.index });
            }
        },
        /**
         * Handler for checking if value exists
         */
        _isValueDefined: function (value) {
            if (value) {
                return true;
            } else {
                return false;
            }
        },
        /**
        * Handler for checking if any icon name is passed or any path for an icon is provided
        */
        _iconPassed: function () {
            if (this.icon || this.src) {
                this._isIconEnabled = true;
            } else {
                this._isIconEnabled = false;
            }
        },
        /**
         * Handler for checking if tagColor attribute is changed and if changed, change the color of the tag to the new color
         */
        _colorChanged: function () {
            if (this.tagColor) {
                this.customStyle['--tag-color'] = this.tagColor;
            }
            this.updateStyles();
        },
        attached: function () {
            if(this.editMode==undefined){
                this.editMode=false;
            }
        },
        _showPicker: function (e) {
            this.$[e.target.getAttribute('picker')].show();
        },
        _updateValue: function (e) {
            var value;
            if(this._isDateTime) {
                switch (this.$$('paper-radio-group').selected){
                    case "withInTime":
                       value= {
                           withinTime: this.withinTime,
                           measure: this.withinTimeMeasure
                       };
                       break;
                    case "moreThanTime":
                      value={
                           moreThanTime: this.moreThanTime,
                           measure: this.moreThanTimeMeasure
                       };
                       break;
                   case "betweenDates":
                      value={
                           "from": this.fromDate,
                           "to":this.toDate
                       };
                       break;
                   case "inRangeDuration":
                       value={
                           "fromDuration": this.fromDuration,
                           "toDuration": this.toDuration
                       };
                       break;
                   case "equalToDate":
                       value={"eq":this.equalDate};
                       this.value=this.equalDate;
                       break;
                }

                if (this.$$('paper-radio-group').selected !="equalToDate") {
                    this.value=JSON.stringify(value);
                }
            } else if(this._isNumeric){
                if(this.$$('paper-radio-group').selected=="range"){
                    value={"min":this.min,"max":this.max};
                    this.value=JSON.stringify(value);
                } else{
                     value={"eq":this.equalNum};
                    this.value=this.equalNum;
                }
            }else{
                   this.value = this.temp;
                   value={"eq":this.temp};
            }

            this._makeNonEditable(e,value);
        },
        _dismissDialog: function () {
            this.editMode=false;
        }
    });

</script>
</dom-module>