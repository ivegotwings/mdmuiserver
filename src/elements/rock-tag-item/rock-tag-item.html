<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-button-group/paper-button-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">
<link rel="import" href="../pebble-datetime-picker/pebble-datetime-picker.html">
<link rel="import" href="../pebble-time-picker/pebble-time-picker.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<!--
`rock-tag-item`
 tag item which can be used in filters or for representing some selection.

@demo demo/index.html
-->
<dom-module id="rock-tag-item">
    <template>
        <style include="pebble-styles-app"></style>
        <style>
      :host {
        display: inline-flex;
        box-sizing: border-box;
        margin-right:var(--default-margin-right,6px);
        vertical-align: top;
        --default-tag-border:#ff0;
        --paper-radio-button-size:var(--font-size-small);
      }    
      .tag-value{
        font-size:var(--font-size-small);
        line-height: var(--default-tag-height,21px);
        display:inline-flex;
        margin-right: 4px;
      }
      .tag-item-container{
        @apply(--tag-style);
        float:left;
        margin: 4px 0;
      }
      paper-icon-button::shadow #icon{
        /*color: #333;
        height: 10px;*/
      }
      paper-input {
        width: 90%;
      }
      .dateOptions paper-radio-button{
             display: block ;
     }
    paper-button.datebuttons {
        margin-top: 10px;
        height: 30px;
        min-width: 150px;
        background: #DBE4EB;
        -webkit-border-radius:2px;
        -moz-border-radius: 2px;
        border-radius: 2px;
        display: block;
        margin-top: 6px !important;
        padding-top: 6px !important;
        margin-left: 15px !important;
        margin-right: 15px !important;
        text-align: center;
    }
      paper-button.datebuttons:hover {
            background: #1976D2;
            color: #FFFFFF;
        }

    paper-button.datebuttons[active]{
            background: #1976D2;
            color: #FFFFFF;
    }



    </style>

<div class="tag-item-container border">
        <template is="dom-if" if="{{_isIconEnabled}}">
            <iron-icon id="icon" src="[[src]]" icon="[[icon]]"></iron-icon>
        </template>
        <template is="dom-if" if="{{_hasValue}}">
            <span class="tag-value" on-tap="_onTapEvent">{{longName}}: {{valueString}}</span>
        </template>
        <template is="dom-if" if="{{!_hasValue}}">
            <span class="tag-value" on-tap="_onTapEvent">{{longName}}: All</span>
        </template>
        <template is="dom-if" if="{{editMode}}">
            <pebble-icon  icon="pebble-icons:ExpandMore"></pebble-icon>
        </template>
        <template is="dom-if" if="{{!disableDelete}}">
            <paper-icon-button on-tap="_removeItem" icon="pebble-icons:TagCancel"></paper-icon-button>
        </template>
</div>

        <pebble-dialog id="filterDialog" no-overlap horizontal-align="left" vertical-align="top"  style="display: block;">
            <template is="dom-if" if="{{_isTextBox}}">
                <pebble-textbox  class="input" label="{{longName}}" value="{{temp}}"  ></pebble-textbox>
            </template>
            <template is="dom-if" if="{{_isCheckBox}}">
            <pebble-dropdown  class="input" label="{{longName}}" items="Yes,No"  selected-value="{{temp}}"></pebble-dropdown>
            </template>
            <template is="dom-if" if="{{_isTextArea}}">
            <pebble-textarea  class="input"  placeholder="{{longName}}"  value="{{temp}}" ></pebble-textarea>
            </template>
            <template is="dom-if" if="{{_isDateTime}}">
                <paper-button-group aria-labelledby="dateFilter" selected="{{temp}}">
                <paper-button class="datebuttons"  name="Today" on-tap="_selectDateItem">Today</paper-button>
                <paper-button class="datebuttons"  name="Yesterday" on-tap="_selectDateItem">Yesterday</paper-button>
                <paper-button class="datebuttons"  name="Last 7 days" on-tap="_selectDateItem">Last 7 days</paper-button>
                <paper-button class="datebuttons"  name="Last 30 days" on-tap="_selectDateItem">Last 30 days</paper-button>
                <paper-button class="datebuttons"  name="This Month" on-tap="_selectDateItem">This Month</paper-button>
                <paper-button class="datebuttons"  name="Last Month" on-tap="_selectDateItem">Last Month</paper-button>
                <paper-button class="datebuttons"  name="Custom" on-tap="_selectDateItem">Custom</paper-button>
                </paper-button-group>

            <!--<paper-radio-group aria-labelledby="{{longName}}" class="dateOptions">-->
                <!--<paper-radio-button name="withInTime"  >-->
                   <!--With in the last-->
                    <!--<input   is="iron-input" style="width: 50px;margin: 0 5px 0 5px" type="number" bind-value="{{withinTime}}">-->
                    <!--<pebble-dropdown  style="width: 50%; " items="Minutes,Seconds, Hours" selected-index="0"    selected-value="{{withinTimeMeasure}}"></pebble-dropdown>-->
                <!--</paper-radio-button>-->
             <!--<paper-radio-button name="moreThanTime">-->
                 <!--More than  <input  is="iron-input" style="width: 50px;margin: 0 5px 0 5px" type="number" bind-value="{{moreThanTime}}">-->
                     <!--<pebble-dropdown  style="width: 50%" items="Minutes,Seconds, Hours"  selected-index="0"   selected-value="{{moreThanTimeMeasure}}"></pebble-dropdown> ago-->
             <!--</paper-radio-button>-->
             <!--<paper-radio-button name="betweenDates">-->
                 <!--Between-->
                 <!--<input  style="width: 100px;margin-left:5px"  is="iron-input" bind-value="{{fromDate}}">-->
                 <!--<pebble-button class="date-button"  id="fromPicker" icon="icons:date-range" picker="pickFromDate" on-tap="_showPicker" ></pebble-button>-->
                 <!--and-->
                 <!--<input  style="width: 100px;margin-left:5px"  is="iron-input"  bind-value="{{toDate}}">-->
                 <!--<pebble-button class="date-button" id="toPicker" icon="icons:date-range"  picker="pickToDate" on-tap="_showPicker" ></pebble-button>-->
             <!--</paper-radio-button>-->
            <!--<paper-radio-button name="inRangeDuration">-->
                <!--In range   <input   is="iron-input"  style="width: 70px;margin: 0 5px 0 5px;text-align: center" bind-value="{{fromDuration}}" placeholder="-3w 4d"> to   <input   is="iron-input"  style="width: 70px;margin: 0 5px 0 5px;text-align: center" bind-value="{{toDuration}}" placeholder="4w 3d">-->
            <!--</paper-radio-button>-->
            <!--<paper-radio-button name="equalToDate">-->
                    <!--Equal to-->
                <!--<input  is="iron-input" style="width: 100px;margin-left:5px" bind-value="{{equalDate}}">-->
                <!--<pebble-button class="date-button"  id="equalPicker" icon="icons:date-range" picker="pickEqualDate" on-tap="_showPicker" ></pebble-button>-->
            <!--</paper-radio-button>-->
            <!--</paper-radio-group>-->
            </template>
            <template is="dom-if" if="{{_isNumeric}}">
                <paper-radio-group aria-labelledby="{{longName}}" class="dateOptions">
                    <paper-radio-button name="range">
                      Min
                        <input   is="iron-input" style="width: 70px;margin: 0 5px 0 5px" type="number" bind-value="{{min}}">
                      Max
                        <input   is="iron-input" style="width: 70px;margin: 0 5px 0 5px" type="number" bind-value="{{max}}">
                    </paper-radio-button>
                    <paper-radio-button name="equalToDate">
                        Equal to
                        <input  is="iron-input" style="width: 100px;margin-left:5px" type="number" bind-value="{{equalNum}}">
                    </paper-radio-button>
                </paper-radio-group>
            </template>
            <div>
                <pebble-button  button-text="Update" noink raised elevation="4" dialog-confirm on-tap="_updateValue"></pebble-button>
                <pebble-button dialog-dismiss on-tap="_dismissDialog"  button-text="Close"></pebble-button>
            </div>
        </pebble-dialog>


        <pebble-datetime-picker   id="pickFromDate" for="fromPicker" value="{{fromDate}}" picker-type="date" date-format="DD/MM/YYYY" date-value="{{fromDateValue}}" time-value="{{fromTimeValue}}" utc-value="{{fromUtcDateTime}}"></pebble-datetime-picker>
        <pebble-datetime-picker   id="pickToDate" for="toPicker" value="{{toDate}}" picker-type="date" date-format="DD/MM/YYYY" date-value="{{toDateValue}}" time-value="{{toTimeValue}}" utc-value="{{toUtcDateTime}}"></pebble-datetime-picker>
        <pebble-datetime-picker   id="pickEqualDate" for="equalPicker" value="{{equalDate}}" picker-type="date" date-format="DD/MM/YYYY" date-value="{{equalDateValue}}" time-value="{{equalTimeValue}}" utc-value="{{equalUtcDateTime}}"></pebble-datetime-picker>
    </template>
<script>

    Polymer({
        is: 'rock-tag-item',
        properties: {
            /**
            * Fired when the tag is to be removed from the tag list. Data passed:  {index: this.index}
            *
            * @event tag-item-remove
            */

            /**
            * Fired when the tag is not editable and on tap of tag. Data passed:  {index: this.index}
            *
            * @event tag-item-select
            */

            /**
                    * Fired when user edits the tag and tag is changed equal edit mode to view mode.
                    *
                    * @event tag-value-change (pub-sub event)
                    * @param {Object} detail
            * @param {Object} detail.name gives the attribute name  
            * @param {Object} detail.value gives the attribute value			
                    */

            /**
            * Indicates the index of a tag.
            */
            index: {
                type: Number,
                value: 0
            },
            /**
            * Indicates the size of the tags. possible values: small, medium and large.
            */
            size: {
                type: String,
                value: 'small'
            },
            /**
             * Specifies whether or not a tag must be deleted.
    
             */
            disableDelete: {
                type: Boolean,
                value: false
            },
            /**
            * Indicates the value of the attribute shown in the tag.
            */
            value: {
                type: Object,
                value: function () {
                    return {};
                },
                notify: true
            },
            /**
            * Indicates the name of the attribute shown in the tag.
            */
            name: {
                type: String,
                value: '',
                notify: true
            },
            longName: {
                type: String,
                value: '',
                notify: true
            },
            /**
             * Specifies whether or not the tag is in view or edit mode.
             */
            editMode: {
                type: Boolean,
                value: false,
                notify:true
            },
            /**
             * Boolean flag which will become true when user passes icon( name of icon present in icons set) or src(image path).
            */
            _isIconEnabled: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Specifies the icon name or index in the set of icons available in
             * the icon set. Note that you must not specify the src property when the icon property is specified.
             */
            icon: {
                type: String,
                value: '',
                notify: true,
                observer: '_iconPassed'
            },
            /**
            * Indicates the URL of an image for the icon. Note that you must not specify the src property when the icon property is specified.
    .
            */
            src: {
                type: String,
                value: '',
                notify: true,
                observer: '_iconPassed'
            },
            /**
             * Specifies whether or not the value of the tag is editable.
            */
            isNonEditable: {
                type: Boolean,
                value: false
            },
            /**
             * Boolean flag to check if the attribute only has both name and value or only name
             */
            _hasValue: {
                type: Boolean,
                value: false,
                notify: true,
                computed: '_isValueDefined(value)'
            },
            /**
             * Indicates the Color of the tag.
             */
            tagColor: {
                type: String,
                notify: true,
                observer: '_colorChanged'
            },
            displayType:{
                type:String,
                observer:"_displayTypeChanged"
            },
            selectedTimeMeasure:{
                type:String,
                value:"Minutes"
            },
            fromDate:{
                type:String
            },
            valueString:{
                type:String,
                value:""
            }
        },
        /**
          * Change the tag from view  mode to edit mode
        */
        _makeEditable: function (e) {
            this.editMode = true;
            //need to give some time to polymer to reflect the property change, thus async
                this.$.filterDialog.positionTarget =this.$$('.tag-value');
                this.$.filterDialog.open();
                this.async(function () {
                    var input= this.$.filterDialog.querySelector(".input");
                    if(input) {
                        input.focus();
                    }
                },2);
        },
        /**
          * Change the tag from edit  mode to view mode
        */
        _makeNonEditable: function (e) {
            this.editMode = false;
            var attribute = {
                name: this.name,
                value:this.value
            };
            if (this.value != undefined && this.value != null && this.name != undefined && this.name != null) {
                this.fire('bedrock-event', { name: "tag-value-change", data: attribute });
            }
        },
        _displayTypeChanged: function () {
              switch(this.displayType){
                  case 'checkBox':
                      this._isCheckBox=true;
                      break;
                  case 'textBox':
                      this._isTextBox=true;
                      break;
                  case 'textArea':
                      this._isTextArea=true;
                      break;
                  case 'dropDown':
                      this._isDropDown=true;
                      break;
                  case 'dateTime':
                      this._isDateTime=true;
                      break;
                  case 'numeric':
                      this._isNumeric=true;
                      break;
              }
        },
        /**
          * This method is called when someone taps on the tag. If tag is editable, then the tag is switched to edit mode otherwise tag-item-select event is fired
        */
        _onTapEvent: function (e) {
            if (!this.isNonEditable) {
                this._makeEditable(e);
            } else {
                this.fire('tag-item-select', { index: this.index });
            }
        },
        /**
         * Handler for removing the tag item
         */
        _removeItem: function () {
            if (!this.disableDelete) {
                this.fire('tag-item-remove', { index: this.index });
            }
        },
        /**
         * Handler for checking if value exists
         */
        _isValueDefined: function (value) {
            if (value) {
                this.setValueString(value);
                return true;
            } else {
                return false;
            }
        },
        /**
        * Handler for checking if any icon name is passed or any path for an icon is provided
        */
        _iconPassed: function () {
            if (this.icon || this.src) {
                this._isIconEnabled = true;
            } else {
                this._isIconEnabled = false;
            }
        },
        /**
         * Handler for checking if tagColor attribute is changed and if changed, change the color of the tag to the new color
         */
        _colorChanged: function () {
            if (this.tagColor) {
                this.customStyle['--tag-color'] = this.tagColor;
            }
            this.updateStyles();
        },
        attached: function () {
            if(this.editMode==undefined){
                this.editMode=false;
            }
            if(!this.longName && this.name){
                this.longName=this.name;
            }
            if(!this.displayType){
                this.displayType="textArea";
            }
        },
        _showPicker: function (e) {
            this.$[e.target.getAttribute('picker')].show();
        },
        _updateValue: function (e) {
            if(this._isDateTime) {
                if(this.temp =="Custom"){
                    this.value={
                           "from": this.from,
                           "to":this.to
                       };
                }else{
                    this.value={"eq":this.temp};
                }
//                switch (this.$$('paper-radio-group').selected){
//                    case "withInTime":
//                       this.value= {
//                           withinTime: this.withinTime,
//                           measure: this.withinTimeMeasure
//                       };
//                        this.valueString="Within the last "+ this.withinTime+" "+ this.withinTimeMeasure;
//                        break;
//                    case "moreThanTime":
//                        this.value={
//                           moreThanTime: this.moreThanTime,
//                           measure: this.moreThanTimeMeasure
//                       };
//                       this.valueString="More than "+ this.moreThanTime+" "+ this.moreThanTimeMeasure+ " ago";
//                       break;
//                   case "betweenDates":
//                       this.value={
//                           "from": this.fromDate,
//                           "to":this.toDate
//                       };
//                      this.valueString=this.fromDate+"-"+this.toDate;
//                       break;
//                   case "inRangeDuration":
//                       this.value={
//                           "fromDuration": this.fromDuration,
//                           "toDuration": this.toDuration
//                       };
//                       this.valueString="from "+ this.fromDuration+ (this.fromDuration[0]=="-"?" ago to ":" from now to " )+ this.toDuration+ (this.toDuration[0]=="-"?" ago":" from now");
//                       break;
//                   case "equalToDate":
//                       this.value={"eq":this.equalDate};
//                       break;
//                }
            } else if(this._isNumeric){
                if(this.$$('paper-radio-group').selected=="range"){
                    this.value={"min":this.min,"max":this.max};
                } else{
                    this.value={"eq":this.equalNum};
                }
            }else{
                this.value={"eq":this.temp};
            }
            this.setValueString(this.value);
            this._makeNonEditable(e);
        },
        _dismissDialog: function () {
            this.editMode=false;
        },
        setValueString: function (value) {
            if(value.min && value.max) {
                this.valueString = value.min + "-" + value.max;
                this.min=value.min;
                this.max=value.min;
            } else if(value.min){
                this.valueString=">= "+ value.min;
                this.min=value.min;
            } else if(value.max){
                this.valueString="<= "+ value.max;
                this.max=value.min;
            } else if(value.eq){
                this.valueString=value.eq;
                this.temp=value.eq;
            }else if(value.from && value.to){
                this.valueString = value.from + "-" + value.to;
                this.from=value.from;
                this.to=value.to;
            }
        }
    });

</script>
</dom-module>