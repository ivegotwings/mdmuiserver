<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<!--
`rock-tag-item`
 tag item which can be used in filters or for representing some selection.

@demo demo/index.html
-->
<dom-module id="rock-tag-item">
  <template>
    <style include="pebble-styles-shared"></style>
    <style>
      :host {
        display: inline-flex;
        box-sizing: border-box;
        margin-right:var(--default-margin-right,6px);
      }    
      .tag-value{
        font-size: var(--default-font-size);
        line-height: var(--default-tag-height,24px);
        display:inline-flex;
      }
      .tag-item-container{
        @apply(--tag-style);
        float:left;
        margin: 0px;
        padding: 2px 0 5px 3px;
      }
      

      paper-icon-button::shadow #icon{
        /*color: #333;*/
        height: 14px;
      }
      paper-input {
        width: 90%;
      }

    </style>
    
      <div class="tag-item-container border">
        <template is="dom-if" if="{{!editMode}}">
          <template is="dom-if" if="{{_isIconEnabled}}" >
            <iron-icon  id="icon" src="[[src]]" icon="[[icon]]" ></iron-icon>
          </template>
          <template is="dom-if" if="{{_hasValue}}">
            <span class="tag-value" on-tap="_onTapEvent">{{name}}: {{value}}</span>
          </template>
          <template is="dom-if" if="{{!_hasValue}}">
            <span class="tag-value" on-tap="_onTapEvent">{{name}}</span>
          </template>
          <template is="dom-if" if="{{!disableDelete}}">
            <paper-icon-button on-tap="_removeItem" icon="icons:cancel"></paper-icon-button>
          </template>
        </template>
        <template is="dom-if" if="{{editMode}}">
          <paper-input id="input" label="{{name}}" value="{{value}}" on-blur="_makeNonEditable"></paper-input>
        </template>

      </div>
  </template>
  <script>

    Polymer({
      is: 'rock-tag-item',
      properties: {
        /**
        * Fired when the tag is to be removed from the tag list. Data passed:  {index: this.index}
        *
        * @event tag-item-remove
        */

        /**
        * Fired when the tag is not editable and on tap of tag. Data passed:  {index: this.index}
        *
        * @event tag-item-select
        */

        /**
				* Fired when user edits the tag and tag is changed from edit mode to view mode.
				*
				* @event tag-value-change (pub-sub event)
				* @param {Object} detail
        * @param {Object} detail.name gives the attribute name  
        * @param {Object} detail.value gives the attribute value			
				*/

        /**
        * Indicates the index of a tag.
        */
        index:{
         type:Number,
         value:0
        },
        /**
        * Indicates the size of the tags. possible values: small, medium and large.
        */
        size:{
          type:String,
          value:'small'
        },
        /**
         * Specifies whether or not a tag must be deleted.

         */
        disableDelete:{
          type:Boolean,
          value: false
        },
        /**
        * Indicates the value of the attribute shown in the tag.
        */
        value: {
          type: String,
          value: '',
          notify: true,
          observer: '_valueChanged'
        },
        /**
        * Indicates the name of the attribute shown in the tag.
        */
        name: {
          type: String,
          value: '',
          notify: true
        },
        /**
         * Specifies whether or not the tag is in view or edit mode.
         */
        editMode: {
          type: Boolean,
          value: false
        },
        /**
         * Boolean flag which will become true when user passes icon( name of icon present in icons set) or src(image path).
        */
        _isIconEnabled: {
          type: Boolean,
          value:false,
          notify : true
        },
        /**
         * Specifies the icon name or index in the set of icons available in
         * the icon set. Note that you must not specify the src property when the icon property is specified.
         */
        icon: {
          type: String,
          value:'',
          notify:true,
          observer:'_iconPassed'
         },
        /**
        * Indicates the URL of an image for the icon. Note that you must not specify the src property when the icon property is specified.
.
        */
        src: {
          type: String,
          value:'',
          notify:true,
          observer:'_iconPassed'
        },
        /**
         * Specifies whether or not the value of the tag is editable.
        */
        isNonEditable: {
          type: Boolean,
          value: false
        },
        /**
         * Boolean flag to check if the attribute only has both name and value or only name
         */
        _hasValue: {
          type: Boolean,
          value:false,
          notify : true,
          computed: '_isValueDefined(value)'
        },
        /**
         * Indicates the Color of the tag.
         */
         tagColor:{
           type:String,
           notify:true,
           observer:'_colorChanged'
         },
         /**
         * Specifies whether or not the value of the tag is changed.
         */
         hasValueChanged: {
           type: Boolean,
           value: false
         }
       },
      /**
        * Change the tag from view  mode to edit mode
      */
      _makeEditable: function(e) {
          this.editMode = true;
          //need to give some time to polymer to reflect the property change, thus async
          this.async(function() {
              this.$$('#input').inputElement.focus();//TODO: focus() on paper-input should have worked
            });
      },
      /**
        * Change the tag from edit  mode to view mode
      */
      _makeNonEditable: function(e) {
        this.editMode = false;
          var attribute = {
            name: this.name,
            value: this.value
          }         
          if(this.value != undefined && this.value != null && this.name != undefined && this.name != null && this.hasValueChanged){
            this.hasValueChanged = false; // resetting the property
            this.fire('bedrock-event', { name: "tag-value-change", data: attribute});   
          }
      },
      /**
        * This method is called when someone taps on the tag. If tag is editable, then the tag is switched to edit mode otherwise tag-item-select event is fired
      */
      _onTapEvent : function(e) {
         if(!this.isNonEditable) {
            this._makeEditable(e);
         } else {
            this.fire('tag-item-select', {index: this.index});
         }
      },
      /**
       * Handler for removing the tag item
       */
      _removeItem: function() {
        if (!this.disableDelete) {
          this.fire('tag-item-remove', {index: this.index});
        }
      },
      /**
       * Handler for checking if value exists
       */
      _isValueDefined : function(value) {
        if(value) {
          return true;
        } else {
          return false;
        }
      },
       /**
       * Handler for checking if any icon name is passed or any path for an icon is provided
       */
      _iconPassed: function(){
        if(this.icon || this.src) {
             this._isIconEnabled=true;
          } else {
             this._isIconEnabled=false;
          }
      },
      /**
       * Handler for checking if tagColor attribute is changed and if changed, change the color of the tag to the new color
       */
      _colorChanged:function(){
        if(this.tagColor){
          this.customStyle['--tag-color'] = this.tagColor;
        }
         this.updateStyles();
      },
      /**
       * Handler for checking if tag value is changed and if changed, update hasValueChanged property to true
       */
      _valueChanged: function(newValue, oldValue) {
          if(oldValue != undefined && newValue != oldValue){
            this.hasValueChanged = true;
          }
      }
    });

  </script>
</dom-module>
