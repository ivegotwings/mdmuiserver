<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../bedrock-datachannel/bedrock-datachannel.html">

<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../pebble-toast/pebble-toast.html">

<!--
`bedrock-dataobject-notification-handler`
-->

<dom-module id="bedrock-dataobject-notification-handler">
    <template>
        <bedrock-pubsub event-name="dataobject-notification" handler="_onDataObjectNotification"></bedrock-pubsub>
        <bedrock-pubsub event-name="notification-tap" handler="_onNotificationTap"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'bedrock-dataobject-notification-handler',
                properties: {

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                attached: function () {
                    RUFEventHandlers.reloadClick = function () {
                        if (event.currentTarget) {
                            var appId = event.currentTarget.getAttribute('appId');
                            if (appId) {
                                var appElement = ComponentHelper.getAppById(appId);
                                if (appElement && appElement.refresh) {
                                    appElement.refresh();
                                    RUFEventHandlers.continueClick();
                                }
                            }
                        }
                    };

                    RUFEventHandlers.continueClick = function () {
                        if (event.target) {
                            var toast = this._getPebbleToast(event.target);
                            if (toast) {
                                toast.close();
                            }
                        }
                    }.bind(this);
                },

                _onDataObjectNotification: function (e) {
                    var self = this;
                    var data = e.detail;
                    var actions = SharedEnumsUtil.Enums.actions;
                    if (data) {
                        switch (data.action) {
                            case actions.SaveComplete:
                                // clear cache
                                self._fireNotificationEvent("save-complete", data);
                                break;
                            case actions.GovernComplete:
                                self._updateCache(data);
                                if (data.showNotificationToUser) {
                                    this.debounce(data.context.id, function () {
                                        self._onGovernComplete(data);
                                    }, 2000);
                                }
                                break;
                            case actions.WorkflowTransitionComplete:
                            case actions.WorkflowAssignmentComplete:
                                self._updateCache(data);
                                if (data.showNotificationToUser) {
                                    self._onWorkflowTransitionComplete(data);
                                }
                                break;
                            case actions.SaveFail:
                            case actions.GovernFail:
                                self._onSaveAndGovernFail(data);
                                break;
                            case actions.WorkflowTransitionFail:
                            case actions.WorkflowAssignmentFail:
                                self._onWorkflowTransitionFail(data);
                                break;
                        }
                    }
                },

                _updateCache: function (data) {
                    if (data && data.context) {
                        var utils = SharedUtils.DataObjectFalcorUtil;

                        var pathKeys = utils.getPathKeys();

                        if (pathKeys) {
                            var entityDataIndex = "entityData";
                            var entityGovernDataIndex = "entityGovernData";

                            var dataObjectId = data.context.id;
                            var dataObjectType = data.context.type;

                            var entityDataFalcorModel = RUFBehaviors.DataChannel.getModel(entityDataIndex);
                            var entityGovernDataFalcorModel = RUFBehaviors.DataChannel.getModel(entityGovernDataIndex);

                            if (entityDataFalcorModel) {
                                entityDataFalcorModel.invalidate([pathKeys.root, entityDataIndex, dataObjectType, pathKeys.byIds, dataObjectId]);
                            }

                            if (entityGovernDataFalcorModel) {
                                entityGovernDataFalcorModel.invalidate([pathKeys.root, entityGovernDataIndex, dataObjectType, pathKeys.byIds, dataObjectId]);
                            }
                        }
                    }
                },

                // if app is active: auto refresh workflow panel by firing workflow-transition-complete event.
                // if app is minimized: send pebble toast with link saying wants to open entity. 
                _onWorkflowTransitionComplete: function (data) {
                    if (data.context && data.tenantId) {
                        if (data.context.appInstanceId) {
                            var activeApp = ComponentHelper.getCurrentActiveApp();

                            if (activeApp && activeApp.id == data.context.appInstanceId) {
                                activeApp.fireBedrockEvent("workflow-transition-complete", data, { ignoreId: true });
                            } else {
                                var app = ComponentHelper.getAppById(data.context.appInstanceId);
                                if (app) {
                                    description = data.context.workflowAction + " in " + data.context.workflowName + ": " + data.context.workflowActivityName + " has been successfully done for a/an " + data.context.type + " with ID " + data.context.id + ".";
                                    data.description = description;
                                    this._prepareParamsForEntityManageApp(data);
                                    this._notifyUIOnBadge(data);
                                }
                            }
                        }
                    }
                },

                //if app is active: send pebble toast with link saying wants to refresh entity.
                // if app is minimized: send pebble toast with link saying wants to open entity.                 
                _onGovernComplete: function (data) {
                    if (data.context && data.tenantId) {
                        var isActiveApp = false;
                        var isMinimizedApp = false;

                        isActiveApp = this._isActiveApp(data.context.appInstanceId);
                        if (!isActiveApp) {
                            var app = ComponentHelper.getAppById(data.context.appInstanceId);
                            if (app) {
                                isMinimizedApp = true;
                            }
                        }

                        if (isActiveApp || isMinimizedApp) {
                            var description = "";
                            var actions = "";
                            if (isActiveApp) {
                                var link = "/" + data.tenantId + "/entity-manage?id=" + data.context.id + "&type=" + data.context.type;
                                description = 'Some changes that you made have been verified by the system. Do you want to refresh the page to see the changes?';
                                actions = '<div id="toast-button"><a href=' + link + ' onclick="RUFEventHandlers.reloadClick()" appId="' + data.context.appInstanceId + '">Reload</a></div>';

                                data.description = description + actions;
                                this._sendToast(data);
                            } else if (isMinimizedApp) {
                                description = 'Some changes that you made have been verified by the system for a/an ' + data.context.type + ' with ID ' + data.context.id + '.';
                                data.description = description;
                                this._prepareParamsForEntityManageApp(data);
                                this._notifyUIOnBadge(data);
                            }
                        }
                    }

                    //incase needs to do some other stuff. right now not in use.
                    this._fireNotificationEvent("govern-complete", data);
                },

                // update notification badge and notification list.
                _onSaveAndGovernFail: function (data) {
                    if (data && data.context) {
                        data.description = data.context.type + " " + data.context.id + " has some errors. Please resolve.";
                        this._prepareParamsForEntityManageApp(data);
                        this._notifyUIOnBadge(data);
                    }
                },

                // update notification badge and notification list.
                _onWorkflowTransitionFail: function (data) {
                    if (data && data.context) {
                        if (data && data.context) {
                            data.description = data.context.type + " " + data.context.id + " could not be " + data.context.workflowAction + " in " + data.context.workflowName + ": " + data.context.workflowActivityName;
                            this._prepareParamsForEntityManageApp(data);
                            this._notifyUIOnBadge(data);
                        }
                    }
                },

                //if app is active: fire event with given event name for active app.
                _fireNotificationEvent: function (eventName, data) {
                    if (data.context) {
                        if (data.context.appInstanceId) {
                            var activeApp = ComponentHelper.getCurrentActiveApp();
                            if (activeApp.id == data.context.appInstanceId) {
                                activeApp.fireBedrockEvent(eventName, data, { ignoreId: true });
                            }
                        }
                    }
                },

                // update notification badge and notification list.
                _notifyUIOnBadge: function (data) {
                    var mainApp = document.querySelector("main-app");

                    if (!mainApp) {
                        return;
                    }

                    var notificationElement = mainApp.$$('#notificationsList');

                    if (!notificationElement) {
                        return;
                    }

                    var notificationLabelElement = mainApp.$$('#mdmNotifications');

                    if (notificationElement) {
                        var notifications = notificationElement.notifications;
                        notificationElement.notifications = [];

                        notifications.unshift({
                            src: data.source || '',
                            alt: data.alt || '',
                            when: moment(data.timestamp).format("DD MMM YYYY hh:mm a") || '',
                            desc: data.description || '',
                            data: data.paramData
                        });

                        notificationElement.notifications = notifications;
                        notificationElement.notifyPath("notifications", notificationElement.notifications.slice());

                        if (notificationLabelElement) {
                            notificationLabelElement.label += 1;
                        }
                    }
                },

                _isActiveApp: function (id) {
                    var active = false;
                    if (id) {
                        var activeApp = ComponentHelper.getCurrentActiveApp();
                        if (activeApp) {
                            if (id == activeApp.id) {
                                active = true;
                            }
                        }
                    }
                    return active;
                },

                _sendToast: function (data) {
                    if (data) {
                        var mainApp = document.querySelector('main-app');
                        if (mainApp) {
                            var pebbleToastElement = mainApp.$$('#dataobject-notification-toast');

                            if (!pebbleToastElement) {
                                pebbleToastElement = document.createElement("pebble-toast");
                                pebbleToastElement.setAttribute('id', 'dataobject-notification-toast');
                                mainApp.root.appendChild(pebbleToastElement);
                            }
                            
                            if (pebbleToastElement && !pebbleToastElement.opened) {
                                pebbleToastElement.uniqueId = data.context.id;
                                pebbleToastElement.innerHTML = data.description;
                                pebbleToastElement.toastType = data.status;
                                pebbleToastElement.alignToast = "top";
                                pebbleToastElement.toastDuration = 25000;
                                pebbleToastElement.autoClose = true; 
                                pebbleToastElement.show();
                            }
                        }
                    }
                },

                _getPebbleToast: function (component) {
                    var parentElement = component.parentElement;

                    if (parentElement.is == "pebble-toast") {
                        return parentElement;
                    } else {
                        return this._getPebbleToast(parentElement);
                    }
                },

                _onNotificationTap: function (e, detail) {
                    var appId = detail.appId;
                    var params = {
                        "id": detail.id,
                        "type": detail.type
                    };

                    if (appId) {
                        var appElement = ComponentHelper.getAppById(appId);
                        if (appElement && appElement.refresh) {
                            appElement.refresh();
                        }
                    }

                    ComponentHelper.appRoute("entity-manage", params);

                    var mainApp = document.querySelector("main-app");

                    if (!mainApp) {
                        return;
                    }

                    var notificationElementPopover = mainApp.$$('#popoverNotifications');

                    if (notificationElementPopover) {
                        notificationElementPopover.hide();
                    }
                },

                _prepareParamsForEntityManageApp: function (data) {
                    if (data) {
                        data.paramData = {
                            "id": data.context.id,
                            "type": data.context.type,
                            "appId": data.context.appInstanceId
                        };
                    }
                }
            });
        })();
    </script>

</dom-module>