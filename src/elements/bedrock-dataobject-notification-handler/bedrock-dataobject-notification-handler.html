<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../bedrock-datachannel/bedrock-datachannel.html">

<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../pebble-toast/pebble-toast.html">

<!--
<i><b>Content development is under progress... </b></i>
 @demo demo/index.html
-->

<dom-module id="bedrock-dataobject-notification-handler">
    <template>
        <bedrock-pubsub event-name="dataobject-notification" handler="_onDataObjectNotification"></bedrock-pubsub>
        <bedrock-pubsub event-name="notification-tap" handler="_onNotificationTap"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'bedrock-dataobject-notification-handler',
                properties: {

                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                /**
                  * Content is not appearing - Content development is under progress.
                  */
                attached: function () {
                    window.RUFEventHandlers = window.RUFEventHandlers || {};
                    RUFEventHandlers.reloadClick = function () {
                        if (event.currentTarget) {
                            var appId = event.currentTarget.getAttribute('appId');
                            var appElement;

                            if (appId) {
                                appElement = ComponentHelper.getAppById(appId);
                            } else {
                                appElement = ComponentHelper.getCurrentActiveApp();
                            }

                            if (appElement && appElement.refresh) {
                                appElement.refresh();
                                RUFEventHandlers.continueClick();
                            }
                        }
                    };
                    /**
                      * Content is not appearing - Content development is under progress.
                      */
                    RUFEventHandlers.continueClick = function () {
                        if (event.target) {
                            var toast = this._getPebbleToast(event.target);
                            if (toast) {
                                toast.close();
                            }
                        }
                    }.bind(this);
                },

                _onDataObjectNotification: function (e) {
                    var self = this;
                    var data = e.detail;
                    var actions = SharedEnumsUtil.Enums.actions;
                    if (data) {
                        switch (data.action) {
                            case actions.SaveComplete:
                                // clear cache
                                self._fireNotificationEvent("save-complete", data);
                                break;
                            case actions.SystemSaveComplete:
                            case actions.GovernComplete:
                                self._updateCache(data);
                                var dataId = data.context && data.context.id ? data.context.id : -1;
                                if (data.showNotificationToUser) {
                                    self._debouncer = Polymer.Debouncer.debounce(self._debouncer, Polymer.Async.timeOut.after(2000), () => {
                                        self._onGovernComplete(data);
                                    });
                                }
                                break;
                            case actions.WorkflowTransitionComplete:
                                self._updateCache(data);
                                // There can be any number of notifications in case of transition based on govern rules, WF model.
                                // debounce of 1 second to ensure that UI doesn't get refreshed multiple times if there are many notifiations in 1 second.
                                var dataId = data.context && data.context.id ? data.context.id : -1;
                                if (data.showNotificationToUser) {
                                    self._debouncer = Polymer.Debouncer.debounce(self._debouncer, Polymer.Async.timeOut.after(2000), () => {
                                        self._onWorkflowTransitionComplete(data);
                                    });
                                }
                                break;
                            case actions.WorkflowAssignmentComplete:
                                self._updateCache(data);
                                if (data.showNotificationToUser) {
                                    self._onWorkflowTransitionComplete(data);
                                }
                                break;
                            case actions.SaveFail:
                            case actions.GovernFail:
                            case actions.SystemSaveFail:
                                self._onSaveAndGovernFail(data);
                                break;
                            case actions.WorkflowTransitionFail:
                            case actions.WorkflowAssignmentFail:
                                self._onWorkflowTransitionFail(data);
                                break;
                            case actions.RSConnectComplete:
                                self._onRSConnectComplete(data);
                                break;
                            case actions.RSConnectFail:
                                self._onRSConnectFail(data);
                                break;
                            case actions.BusinessConditionSaveComplete:
                                self._onBusinessConditionSaveComplete(data);
                                break;
                            case actions.BusinessConditionSaveFail:
                                self._onBusinessConditionSaveFail(data);
                                break;
                        }
                    }
                },

                _updateCache: function (data) {
                    if (data && data.context) {
                        var dataObject = {
                            "id": data.context.id,
                            "type": data.context.type
                        };

                        LiquidDataObjectUtils.invalidateDataObjectCache(dataObject);
                    }
                },
                _onBusinessConditionSaveComplete: function (data) {
                    if (data.context && data.tenantId) {
                        if (data.context.appInstanceId) {
                            var activeApp = ComponentHelper.getCurrentActiveApp();

                            if (activeApp && activeApp.id == data.context.appInstanceId) {
                                ComponentHelper.fireBedrockEvent("business-condition-save-response", data, { ignoreId: true });
                            } else {
                                var app = ComponentHelper.getAppById(data.context.appInstanceId);
                                if (app) {
                                    description = description = 'Some changes that you made have been verified by the system for a/an ' + data.context.type + ' with ID ' + data.context.id + '.';
                                    data.description = description;
                                    this._prepareParamsForEntityManageApp(data);
                                    this._notifyUIOnBadge(data, false);
                                }
                            }
                        }
                    }
                },
                _onBusinessConditionSaveFail: function (data) {
                    description = description = 'Some changes that you made have been verified by the system for a/an ' + data.context.type + ' with ID ' + data.context.id + '.';
                    data.description = description;
                    this._prepareParamsForEntityManageApp(data);
                    this._notifyUIOnBadge(data, false);

                },

                // if app is active: auto refresh workflow panel by firing workflow-transition-complete event.
                // if app is minimized: send pebble toast with link saying wants to open entity. 
                _onWorkflowTransitionComplete: function (data) {
                    if (data.context && data.tenantId) {
                        if (data.context.appInstanceId) {
                            var activeApp = ComponentHelper.getCurrentActiveApp();

                            if (activeApp && activeApp.id == data.context.appInstanceId) {
                                activeApp.fireBedrockEvent("workflow-transition-complete", data, { ignoreId: true });
                            } else {
                                var app = ComponentHelper.getAppById(data.context.appInstanceId);
                                if (app) {
                                    data.description = data.context.workflowAction + " in " + data.context.workflowName + ": " + data.context.workflowActivityName + " has been successfully done for a/an " + data.context.type + " with ID " + data.context.id + ".";
                                    this._prepareParamsForEntityManageApp(data);
                                    this._notifyUIOnBadge(data, false);
                                }
                            }
                        }
                    }
                },

                //if app is active: send pebble toast with link saying wants to refresh entity.
                // if app is minimized: send pebble toast with link saying wants to open entity.                 
                _onGovernComplete: function (data) {
                    if (data.context && data.tenantId) {
                        var isActiveApp = false;
                        var isMinimizedApp = false;

                        isActiveApp = this._isActiveApp(data.context.appInstanceId);
                        if (!isActiveApp) {
                            var app = ComponentHelper.getAppById(data.context.appInstanceId);
                            if (app) {
                                isMinimizedApp = true;
                            }
                        }

                        if (isActiveApp || isMinimizedApp) {
                            var description = "";
                            var actions = "";
                            if (isActiveApp) {
                                // var link = "/" + data.tenantId + "/entity-manage?id=" + data.context.id + "&type=" + data.context.type;
                                description = 'Some changes that you made have been verified by the system. Do you want to refresh the page to see the changes?';
                                actions = '<div id="toast-button"><a href="#" onclick="RUFEventHandlers.reloadClick()" appId="' + data.context.appInstanceId + '">Reload</a></div>';
                                data.description = description + actions;
                                this._fireNotificationEvent("govern-complete", data);
                            } else if (isMinimizedApp) {
                                description = 'Some changes that you made have been verified by the system for a/an ' + data.context.type + ' with ID ' + data.context.id + '.';
                                data.description = description;
                                this._prepareParamsForEntityManageApp(data);
                                this._notifyUIOnBadge(data, false);
                            }
                        }
                    }

                },  

                // update notification badge and notification list.
                _onSaveAndGovernFail: function (data) {
                    if (data && data.context) {
                        data.description = data.context.type + " " + data.context.id + " has some errors. Please resolve.";
                        this._prepareParamsForEntityManageApp(data);
                        this._notifyUIOnBadge(data, false);
                    }
                },

                // update notification badge and notification list.
                _onWorkflowTransitionFail: function (data) {
                    if (data && data.context) {
                        if (data && data.context) {
                            data.description = data.context.type + " " + data.context.id + " could not be " + data.context.workflowAction + " in " + data.context.workflowName + ": " + data.context.workflowActivityName;
                            this._prepareParamsForEntityManageApp(data);
                            this._notifyUIOnBadge(data, false);
                        }
                    }
                },
                _onRSConnectEntityModelImportComplete:function(data){
                    this._prepareParamsForTaskDetailApp(data, "success");
                    var appName = data.paramData.appName;
                    var appParams = data.paramData.params;

                    if (appName && appParams) {
                        var description = "";
                        var actions = "";
                        if (this._isAppOpened(appName, appParams)) {
                            description = 'File for this task is imported successfully. Please click on reload';
                            actions = '<div id="toast-button"><a href="#" onclick="RUFEventHandlers.reloadClick()">Reload</a></div>';
                            data.description = description + actions;
                            this._sendToast(data);
                        } else {
                            if (data.workAutomationId) {
                                description = 'File for task <a href="task-detail?id='+data.workAutomationId+'">' + data.workAutomationId + '</a> is imported successfully.';
                            } else {
                                description = 'File is imported successfully.';
                            }
                            data.description = description;
                            this._notifyUIOnBadge(data, true);
                        }
                    }
                },
                _onRSConnectDownloadComplete: function (data) {
                    this._prepareParamsForTaskDetailApp(data, "success");

                    var appName = data.paramData.appName;
                    var appParams = data.paramData.params;

                    if (appName && appParams) {
                        var description = "";
                        var actions = "";
                        if (this._isAppOpened(appName, appParams)) {
                            description = 'File for this task is ready for download. Please click on reload';
                            actions = '<div id="toast-button"><a href="#" onclick="RUFEventHandlers.reloadClick()">Reload</a></div>';

                            data.description = description + actions;
                            this._sendToast(data);
                        } else {
                            if (data.workAutomationId) {
                                description = 'File for task <a href="task-detail?id='+data.workAutomationId+'">' + data.workAutomationId + '</a> is ready for download.';
                            } else {
                                description = 'File is ready for download.';
                            }
                            data.description = description;
                            this._notifyUIOnBadge(data, true);
                        }
                    }
                },

                _onRSConnectComplete: function (data) {
                    if(data && data.type && data.type == 'entityModel'){
                        this._onRSConnectEntityModelImportComplete(data);
                    }else{
                        this._onRSConnectDownloadComplete(data);
                    }
                    //incase needs to do some other stuff.
                    this._fireNotificationEvent("rsConnnect-complete", data);
                },

                _onRSConnectFail: function (data) {
                    this._prepareParamsForTaskDetailApp(data, "error");

                    var appName = data.paramData.appName;
                    var appParams = data.paramData.params;

                    if (appName && appParams) {
                        var description = "";
                        var actions = "";
                        if (this._isAppOpened(appName, appParams)) {
                            description = 'This task is completed with error(s). Please click on reload for more details.';
                            actions = '<div id="toast-button"><a href="#" onclick="RUFEventHandlers.reloadClick()">Reload</a></div>';

                            data.description = description + actions;
                            this._sendToast(data);
                        } else {
                            description = 'Task ' + data.workAutomationId + ' is completed with error(s).';
                            data.description = description;
                            this._notifyUIOnBadge(data, true);
                        }
                    }

                    //incase needs to do some other stuff
                    this._fireNotificationEvent("rsConnnect-fail", data);
                },

                //if app is active: fire event with given event name for active app.
                _fireNotificationEvent: function (eventName, data) {
                    if (data.context) {
                        if (data.context.appInstanceId) {
                            var activeApp = ComponentHelper.getCurrentActiveApp();
                            if (activeApp.id == data.context.appInstanceId) {
                                activeApp.fireBedrockEvent(eventName, data, { ignoreId: true });
                            }
                        }
                    }
                },

                // update notification badge and notification list.
                _notifyUIOnBadge: function (data, isSystem) {
                    var appCommon = RUFUtilities.appCommon;

                    if (!appCommon) {
                        return;
                    }

                    var notificationElement, notificationLabelElement;

                    if (!isSystem) {
                        this._userNotificationsList = this._userNotificationsList || appCommon.shadowRoot.querySelector('#userNotificationsList');
                        this._mdmUserNotifications = this._mdmUserNotifications || appCommon.shadowRoot.querySelector('#mdmUserNotifications');
                        notificationElement = this._userNotificationsList;
                        notificationLabelElement = this._mdmUserNotifications;
                    } else {
                        this._systemNotificationsList = this._systemNotificationsList || appCommon.shadowRoot.querySelector('#systemNotificationsList');
                        this._mdmSystemNotifications = this._mdmSystemNotifications || appCommon.shadowRoot.querySelector('#mdmSystemNotifications');
                        notificationElement = this._systemNotificationsList;
                        notificationLabelElement = this._mdmSystemNotifications;
                    }

                    if (!notificationElement) {
                        return;
                    }

                    if (notificationElement) {
                        var notifications = notificationElement.notifications;
                        notificationElement.notifications = [];

                        notifications.unshift({
                            src: data.source || '',
                            alt: data.alt || '',
                            when: moment(data.timestamp).format("DD MMM YYYY hh:mm a") || '',
                            desc: data.description || '',
                            data: data.paramData
                        });

                        notificationElement.notifications = notifications;
                        notificationElement.notifyPath("notifications", notificationElement.notifications.slice());

                        if (notificationLabelElement) {
                            notificationLabelElement.label += 1;
                        }
                    }
                },

                _isActiveApp: function (id) {
                    var active = false;
                    if (id) {
                        var activeApp = ComponentHelper.getCurrentActiveApp();
                        if (activeApp) {
                            if (id == activeApp.id) {
                                active = true;
                            }
                        }
                    }
                    return active;
                },

                showToast: function (data) {
                    if(data){
                        this._sendToast(data);
                    }
                },

                _sendToast: function (data) {
                    var appCommon = RUFUtilities.appCommon;
                    
                    if (!data || !appCommon) return;
                    
                    this._pebbleToastElement = this._pebbleToastElement || appCommon.shadowRoot.querySelector('#dataobject-notification-toast');

                    if (!this._pebbleToastElement) {
                        this._pebbleToastElement = document.createElement("pebble-toast");
                        this._pebbleToastElement.setAttribute('id', 'dataobject-notification-toast');
                        appCommon.root.appendChild(this._pebbleToastElement);
                    }

                    if (this._pebbleToastElement && !this._pebbleToastElement.opened) {
                        var uniqueId = "";
                        if (data.context && data.context.id) {
                            uniqueId = data.context.id;
                        } else if (data.workAutomationId) {
                            uniqueId = data.workAutomationId;
                        }

                        this._pebbleToastElement.uniqueId = uniqueId;
                        this._pebbleToastElement.innerHTML = data.description;
                        this._pebbleToastElement.toastType = data.status;
                        this._pebbleToastElement.alignToast = "top";
                        this._pebbleToastElement.toastDuration = 25000;
                        this._pebbleToastElement.autoClose = true;
                        this._pebbleToastElement.show();
                    }
                },

                _getPebbleToast: function (component) {
                    var parentElement = component.parentElement;

                    if (parentElement.is == "pebble-toast") {
                        return parentElement;
                    } else {
                        return this._getPebbleToast(parentElement);
                    }
                },

                _onNotificationTap: function (e, detail) {
                    var appId = detail.appId;
                    var appName = detail.appName;
                    var params = detail.params;

                    if (appId) {
                        var appElement = ComponentHelper.getAppById(appId);
                        if (appElement && appElement.refresh) {
                            appElement.refresh();
                        }
                    } else {
                        var viewName = ComponentHelper.getViewNameWithQueryParams(params, appName);
                        var appElement = ComponentHelper.getContentViewByName(viewName);

                        if(appElement) {
                            const firstChild = appElement.$.content.firstElementChild;

                            if (firstChild && typeof firstChild.refresh === 'function') {
                                firstChild.refresh();
                            }
                        }
                    }

                    ComponentHelper.appRoute(appName, params);

                    var appCommon = RUFUtilities.appCommon;

                    if (!appCommon) {
                        return;
                    }

                    this._userNotificationElementPopover = this._userNotificationElementPopover || appCommon.querySelector('#popoverUserNotifications');
                    this._systemNotificationElementPopover = this._systemNotificationElementPopover || appCommon.querySelector('#popoverSystemNotifications');

                    if (this._userNotificationElementPopover) {
                        this._userNotificationElementPopover.hide();
                    }

                    if (this._systemNotificationElementPopover) {
                        this._systemNotificationElementPopover.hide();
                    }
                },

                _prepareParamsForEntityManageApp: function (data) {
                    if (data && data.context) {
                        data.paramData = {
                            "params": {
                                "id": data.context.id,
                                "type": data.context.type
                            },
                            "appId": data.context.appInstanceId,
                            "appName": "entity-manage"
                        };
                    }
                },

                _prepareParamsForTaskDetailApp: function (data, msgType) {
                    if (data) {
                        data.paramData = {
                            "params": {
                                "id": data.workAutomationId
                            },
                            "appName": "task-detail",
                            "type": msgType
                        };
                    }
                },

                _isAppOpened: function (appName, params) {
                    var mainApp = RUFUtilities.mainApp;
                    if (mainApp && mainApp.pageRoute) {
                        var pageRoute = mainApp.pageRoute;

                        if (pageRoute.path.indexOf(appName) > 0) {
                            var utils = SharedUtils.DataObjectFalcorUtil;
                            if (utils.compareObjects(params, pageRoute.__queryParams)) {
                                return true;
                            } else {
                                return false;
                            }
                        } else {
                            return false;
                        }
                    }
                    return false;
                }
            });
        })();
    </script>

</dom-module>