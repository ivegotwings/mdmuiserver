<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-model-import">
    <template>
        <style include="bedrock-style-common">
            .placeHolder {                
                width: 80%;
                height: 100%;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
                @apply --placeholder;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
                color: var(--palette-steel-grey, #75808b);
            }
        </style>

        <div class="placeHolder p-10">
            <p class="title"></p>
            <!--a href="#" class="btn-link" on-tap="_selectFile">Download</a> a system template or just upload an existing data file
            
            <!-- screen for import -->
            <pebble-file-upload id="fileUpload" allowed-file-types="[[allowedFileTypes]]"></pebble-file-upload>
            <bedrock-pubsub event-name="pebble-file-upload-success" handler="_onFileUploadSuccess" target-id="fileUpload"></bedrock-pubsub>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-model-import",

                properties: {
                    _copProcessModelRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _fileName: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    businessFunctionData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    allowedFileTypes: {
                        type: Array,
                        value: function () { return []; }
                    },
                    copContext: {
                        type: Object,
                        value: function() { return {}; }
                    },
                    _workAutomationId: {
                        type: String
                    },
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _onFileUploadSuccess: function (e, detail, sender) {

                    var fileName = detail.fileName;
                    this.set("_fileName", detail.originalFileName);

                    var formData = new FormData();
                    formData.append("file", detail.file);
                    formData.append("fileName", fileName);

                    var fileDetails = {
                        "file": detail.file,
                        "fileName": detail.fileName,
                        "originalFileName": detail.originalFileName
                    };

                    var req = DataRequestHelper.createImportRequest(fileDetails, this.copContext);
                    this._workAutomationId = DataHelper.generateUUID();
                    req.dataObject.properties.workAutomationId = this._workAutomationId;

                    formData.append("requestData", JSON.stringify(req));

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/data/cop/processmodel', true);
                    xhr.responseType = 'json';
                    xhr.onload = function (e) {
                        if (e.currentTarget && e.currentTarget.response) {
                            var response = e.currentTarget.response;
                            e.detail = {
                                "response": response
                            }
                            if ((response.response && response.response.status == "success") ||
                                (response.dataObjectOperationResponse && response.dataObjectOperationResponse.status == "success")) {
                                this._onProcessModelSuccess(e);
                            } else {
                                this._onProcessModelFailure(e);
                            }

                        }
                    }.bind(this);
                    xhr.send(formData);

                    var liqTransform = this.shadowRoot.querySelector("#copProcessModel");
                    if (liqTransform) {
                        liqTransform.generateRequest();
                    }
                },
                _onProcessModelSuccess: function (e) {
                    var response = e.detail.response;
                    if (response && response.dataObjectOperationResponse && response.dataObjectOperationResponse.status.toLowerCase() == "success") {
                        // go to next step in wizard
                        var data = {
                            "messages": [
                                {
                                    "message": "The Data Model has been uploaded and will be processed by the system"
                                },
                                {
                                    "message": "You can view the status of the processing in the Data Model Dashboard"
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Take me back to where I started",
                                    "action": { "name": "refresh-data" }
                                },
                                {
                                    "name": "gotoTaskDetails",
                                    "text": "Show me the task details",
                                    "dataRoute": "task-detail",
                                    "queryParams": {
                                        "id": this._workAutomationId
                                    }
                                }
                            ]
                        };
                        this.businessFunctionData = data;
                        var eventName = "onNext";
                        var eventDetail = {
                            name: eventName
                        };
                        setTimeout(() =>{
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 1000);
                    } else {
                        this.logWarning("UnexpectedCOP", "response", JSON.stringify(e.detail.response));
                        this.showErrorToast("Unable to process the data model. Please check the service or contact your administrator.");
                    }
                },
                _onProcessModelFailure: function (e) {
                    this.logWarning("UnexpectedCOP", "response", JSON.stringify(e.detail.response));
                    this.showErrorToast("Unable to process the data model. Please check the service or contact your administrator.");
                }
            });
        })();
    </script>
</dom-module>
