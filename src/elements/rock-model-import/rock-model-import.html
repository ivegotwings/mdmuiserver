<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-model-import">
    <template>
        <style include="bedrock-style-common">
            .placeHolder {
                width: 880px;
                height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
                color: var(--palette-steel-grey, #75808b);
            }
        </style>

        <div class="placeHolder p-10">
            <p class="title"><a href="#" class="btn-link" on-tap="_selectFile">Download</a> a system template or just upload an existing data
                file
            </p>
            <!-- screen for import -->
            <pebble-file-upload allowed-file-types="[[allowedFileTypes]]"></pebble-file-upload>
            <bedrock-pubsub on-bedrock-event-pebble-file-upload-success="_onFileUploadSuccess"></bedrock-pubsub>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-model-import",

                properties: {
                    _copProcessModelRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _fileName: {
                        type: String
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    businessFunctionData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    allowedFileTypes: {
                        type: Array,
                        value: function () { return []; }
                    },
                    copContext: {
                        type: Object,
                        value: function() { return {}; }
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _onFileUploadSuccess: function (e, detail, sender) {

                    var fileName = detail.fileName;
                    this.set("_fileName", detail.originalFileName);

                    var formData = new FormData();
                    formData.append("file", detail.file);
                    formData.append("fileName", fileName);
                    formData.append("service", this.copContext.service);
                    formData.append("channel", this.copContext.channel);
                    formData.append("format", this.copContext.format);
                    formData.append("source", this.copContext.source);
                    formData.append("subtype", this.copContext.subtype);
                    formData.append("order", this.copContext.order);

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/data/cop/processmodel', true);
                    xhr.responseType = 'json';
                    xhr.onload = function (e) {
                        if (e.currentTarget && e.currentTarget.response) {
                            var response = e.currentTarget.response;
                            e.detail = {
                                "response": response
                            }
                            if ((response.response && response.response.status == "success") ||
                                (response.dataObjectOperationResponse && response.dataObjectOperationResponse.status == "success")) {
                                this._onProcessModelSuccess(e);
                            } else {
                                this._onProcessModelFailure(e);
                            }

                        }
                    }.bind(this);
                    xhr.send(formData);

                    var liqTransform = this.shadowRoot.querySelector("#copProcessModel");
                    if (liqTransform) {
                        liqTransform.generateRequest();
                    }
                },
                _onProcessModelSuccess: function (e) {
                    var response = e.detail.response;
                    if (response && response.dataObjectOperationResponse && response.dataObjectOperationResponse.status.toLowerCase() == "success") {
                        // go to next step in wizard
                        var data = {
                            "messages": [
                                {
                                    "message": "The Data Model has been uploaded and will be processed by the system"
                                },
                                {
                                    "message": "You can view the status of the processing in the Data Model Dashboard"
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Close Data Model Loader"
                                },
                                {
                                    "name": "nextAction",
                                    "text": "Take me to File Upload Status",
                                    "dataRoute": "dashboard"
                                }
                            ]
                        };
                        this.businessFunctionData = data;
                        var eventName = "onNext";
                        var eventDetail = {
                            name: eventName
                        };
                        setTimeout(() =>{
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 5000);
                    } else {
                        this.logWarning("UnexpectedCOP", "response", JSON.stringify(e.detail.response));
                        this.showErrorToast("Unable to process the data model. Please check the service or contact your administrator.");
                    }
                },
                _onProcessModelFailure: function (e) {
                    this.logWarning("UnexpectedCOP", "response", JSON.stringify(e.detail.response));
                    this.showErrorToast("Unable to process the data model. Please check the service or contact your administrator.");
                }
            });
        })();
    </script>
</dom-module>