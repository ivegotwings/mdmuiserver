<link rel="import" href="../../../bower_components/polymer/polymer.html">

<script>
    (function () {
/**
`bedrock-pubsub` Represents the basic publish-subscribe functionality.
        
You can fire a custom event of type `bedrock-event`, with a detail object containing `name` and `data` 
fields to send a signal as shown in the below code:
        
`this.fire('bedrock-event', {name: 'hello', data: null});`
        
You can listen for `bedrock-event-<name>` event on a `bedrock-pubsub` element to receive a signal as shown
in the below code:
        
`<bedrock-pubsub on-bedrock-event-hello="{{helloSignal}}">`
        
You can fire a signal event from anywhere and all `bedrock-pubsub` elements receive the event regardless
of where they are in DOM.
        
@demo demo/index.html
*/
        Polymer({
            is: 'bedrock-pubsub',
            properties: {
                /**
                * Indicates an App identification. There is no need to pass this value when you use it.
                */
                appId: {
                    type: String,
                    value: ""
                },
                /**
                * Indicates the event name that needs to be subscribed.
                */
                eventName: {
                    type: String,
                    reflectToAttribute: true
                },
                /**
                * Indicates an event handler name.
                */
                handler: {
                    type: String
                },
                /**
                * Indicates the identification of the target element, which pulishes the event.
                */
                targetId: {
                    type: String,
                    value: ""
                }

            },
            attached: function () {
                var mainApp = document.querySelector("main-app");
                if (mainApp) {
                    var contentViewMgr = mainApp.$$("rock-content-view-manager");
                    if (contentViewMgr) {
                        var activeContentView = contentViewMgr.$.contentViewManager.querySelector(
                            "rock-content-view:not([hidden])");
                        if (activeContentView) {
                            var viewComponent = activeContentView.$$("#content-view-container").querySelector(".view-component");
                            if (viewComponent) {
                                this.appId = viewComponent.id;
                            }
                            this._registerEvent();
                        }
                    }
                } else {

                    this._registerEvent();
                }

                pubsubInstances.push(this);
            },
            detached: function () {
                var i = pubsubInstances.indexOf(this);
                if (i >= 0) {
                    pubsubInstances.splice(i, 1);
                }
            },

            _getPubSubContainer: function (element) {
                var parentNode = element.parentNode;
                if (parentNode) {
                    if (parentNode.isRufComponent) {
                        return parentNode;
                    }
                    else if (parentNode.host && parentNode.host.isRufComponent) {
                        return parentNode.host;
                    }
                    else {
                        return this._getPubSubContainer(Polymer.dom(parentNode));
                    }
                }
                return parentNode;
            },
            _registerEvent: function () {
                var pubSubContainer = this._getPubSubContainer(Polymer.dom(this));
                if (pubSubContainer && this.eventName) {
                    var eventAttr = "bedrock-event-" + this.eventName;
                    if (this.targetId) {
                        eventAttr = eventAttr + "-" + this.targetId;
                    }
                    if (pubSubContainer.appId) {
                        eventAttr = eventAttr + "-" + pubSubContainer.appId;
                    }
                    pubSubContainer.listen(pubSubContainer, eventAttr, this.handler);
                }
            },
            registerEvent: function() {
                this._registerEvent();
            }
        });

        //pubsub instance storage
        var pubsubInstances = [];

        // event dispatcher
        function publish(name, data) {
            var rufEevent = new CustomEvent('bedrock-event-' + name, {
                bubbles: false,
                detail: data
            });
            // dispatch named-event to all pubsubInstances
            pubsubInstances.forEach(function (s) {
                s.dispatchEvent(rufEevent);
            });
        }

        // signal listener at document
        document.addEventListener('bedrock-event', function (e) {
            publish(e.detail.name, e.detail.data);
        });

    })();
</script>