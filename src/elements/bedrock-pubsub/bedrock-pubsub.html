<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<script>
    (function () {
        /**
        `bedrock-pubsub` provides the basic publish-subscribe functionality for the events.
        
        ### Example
                
        You can fire a custom event of type `bedrock-event`, with a detail object containing `name` and `data` 
        fields to send a signal as shown in the below code:
                
        `this.dispatchEvent(new CustomEvent('bedrock-event', {name: 'hello', data: null});`
                
        You can listen for `bedrock-event-<name>` event on a `bedrock-pubsub` element to receive a signal as shown
        in the below code:
                
        `<bedrock-pubsub on-bedrock-event-hello="{{helloSignal}}">`
                
        You can fire a signal event from anywhere and all `bedrock-pubsub` elements receive the event regardless
        of where they are in DOM.
                
        @demo demo/index.html
        */
        this.globalPubSubInstances = {};

        Polymer({
            is: 'bedrock-pubsub',
            properties: {
                /**
                * Indicates an identifier for the App. There is no need to pass this value when you use it.
                */
                appId: {
                    type: String,
                    value: ""
                },
                /**
                * Indicates the event name that needs subscription.
                */
                eventName: {
                    type: String
                },
                /**
                * Indicates an event handler name.
                */
                handler: {
                    type: String
                },
                /**
                * Indicates the identifier of the target element that pulishes the event.
                */
                targetId: {
                    type: String,
                    value: ""
                },

                name: {
                    type: String,
                    value: ""
                }
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            ready: function () {
                //pubsub instance storage
                if (!RUFUtilities.pubsubListenerRegistry) {
                    RUFUtilities.pubsubListenerRegistry  = {'universal' : []};
                    RUFUtilities.pubsubEventNameRegistry = {'universal' : []};

                    document.addEventListener('bedrock-event', this._onBedrockEvent.bind(this));
                }   

                var activeApp = ComponentHelper.getCurrentActiveApp();
                if (activeApp) {
                    this.appId = activeApp.id;
                }               
                Polymer.Async.microTask.run(() => {
                    this._registerEvent();
                    if (this.name) {
                        if (!globalPubSubInstances[this.name]) {
                            globalPubSubInstances[this.name] = [];    
                        }
                        globalPubSubInstances[this.name].push(this);
                    }
                });
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            detached: function () {
                this._cleanGlobalPubSubInstances();
            },

            // event dispatcher
            _publish: function publish(name, data) {
                var rufEevent = new CustomEvent('bedrock-event-' + name, {
                    bubbles: false,
                    detail: data
                });
                var instance = globalPubSubInstances['bedrock-event-' + name];
                if (instance && instance.length > 0) {
                    instance.forEach((i) => i.dispatchEvent(rufEevent));
                }
            },

            _onBedrockEvent: function (e) {
                this._publish(e.detail.name, e.detail.data);
            },

            _getPubSubContainer: function (element) {
                var parentNode = element.parentNode;
                if (parentNode) {
                    if (parentNode.isRufComponent) {
                        return parentNode;
                    }
                    else if (parentNode.host && parentNode.host.isRufComponent) {
                        return parentNode.host;
                    }
                    else {
                        return this._getPubSubContainer(Polymer.dom(parentNode));
                    }
                }
                return parentNode;
            },
            _registerEvent: function () {
                var pubSubContainer = this._getPubSubContainer(Polymer.dom(this).node);
                var pubsubContent = {}
                if (pubSubContainer && this.eventName) {
                    var eventAttr = "bedrock-event-" + this.eventName;
                    if (this.targetId) {
                        eventAttr = eventAttr + "-" + this.targetId;
                    }

                    if (pubSubContainer.localName == "main-app" || ((pubSubContainer.className.indexOf('view-component') > -1) && pubSubContainer.contentViewManager && pubSubContainer.id)) {
                        eventAttr = eventAttr + "-" + pubSubContainer.id;
                    }
                    else {
                        var appId = pubSubContainer.getAppId();
                        if (appId && appId != "") {
                            eventAttr = eventAttr + "-" + appId;
                        }
                    }

                    pubsubContent.element = pubSubContainer
                    pubsubContent.eventName = eventAttr;
                    pubSubContainer.listen(pubSubContainer, eventAttr, this.handler);
                    if(this.appId) {
                        RUFUtilities.pubsubEventNameRegistry[this.appId] = RUFUtilities.pubsubEventNameRegistry[this.appId] || [];
                        RUFUtilities.pubsubListenerRegistry[this.appId] = RUFUtilities.pubsubListenerRegistry[this.appId] || [];
                        var index = RUFUtilities.pubsubEventNameRegistry[this.appId].indexOf(this.eventName); 
                        if (index === -1) {
                            RUFUtilities.pubsubEventNameRegistry[this.appId].push(this.eventName);
                            RUFUtilities.pubsubListenerRegistry[this.appId].push([pubsubContent]);
                        } else {
                            RUFUtilities.pubsubListenerRegistry[this.appId][index].push(pubsubContent);
                        }                       
                    } else {
                        var index = RUFUtilities.pubsubEventNameRegistry['universal'].indexOf(this.eventName);
                        if (index === -1) {
                            RUFUtilities.pubsubListenerRegistry['universal'].push([pubsubContent]);
                            RUFUtilities.pubsubEventNameRegistry['universal'].push(this.eventName);
                        } else {
                            RUFUtilities.pubsubListenerRegistry['universal'][index].push(pubsubContent);
                        }
                    }
                    
                    if (!this.name) {
                        ComponentHelper.addToDeleteQueue(this);
                    }
                } else {
                    //What to do ??
                    //ComponentHelper.addToDeleteQueue(this);
                }
            },
            /**
              * Content development is under progress. 
              */
            registerEvent: function () {
                this._registerEvent();
            },

            _cleanGlobalPubSubInstances: function () {
                if (this.name) {
                    var instances = globalPubSubInstances[this.name];
                    if (instances) {
                        var index = instances.indexOf(this);

                        if (index > -1) {
                            instances.splice(index, 1);
                        }
                    }
                }
            }
        });
    })();

</script>
