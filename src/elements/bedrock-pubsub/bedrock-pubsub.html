<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<script>
    (function () {
        /**
        `bedrock-pubsub` provides the basic publish-subscribe functionality for the events.
        
        ### Example
                
        You can fire a custom event of type `bedrock-event`, with a detail object containing `name` and `data` 
        fields to send a signal as shown in the below code:
                
        `this.dispatchEvent(new CustomEvent('bedrock-event', {name: 'hello', data: null});`
                
        You can listen for `bedrock-event-<name>` event on a `bedrock-pubsub` element to receive a signal as shown
        in the below code:
                
        `<bedrock-pubsub on-bedrock-event-hello="{{helloSignal}}">`
                
        You can fire a signal event from anywhere and all `bedrock-pubsub` elements receive the event regardless
        of where they are in DOM.
                
        @demo demo/index.html
        */
        //pubsub instance storage
        this.pubsubInstances = [];
        this._pubsubListenerRegistry = []
        
        Polymer({
            is: 'bedrock-pubsub',
            properties: {
                /**
                * Indicates an identifier for the App. There is no need to pass this value when you use it.
                */
                appId: {
                    type: String,
                    value: ""
                },
                /**
                * Indicates the event name that needs subscription.
                */
                eventName: {
                    type: String,
                    reflectToAttribute: true
                },
                /**
                * Indicates an event handler name.
                */
                handler: {
                    type: String
                },
                /**
                * Indicates the identifier of the target element that pulishes the event.
                */
                targetId: {
                    type: String,
                    value: ""
                },

                _pubsubListenerRegistry: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                }
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            attached: function () {

                var mainApp = document.querySelector("main-app");
                if (mainApp && mainApp.shadowRoot) {
                    var contentViewMgr = mainApp.shadowRoot.querySelector("rock-content-view-manager");
                    if (contentViewMgr) {
                        var activeContentView = contentViewMgr.$.contentViewManager.querySelector(
                            "rock-content-view:not([hidden])");
                        if (activeContentView) {
                            var viewComponent = activeContentView.shadowRoot.querySelector("#content-view-container").querySelector(".view-component");
                            if (viewComponent && DataHelper.isEmptyObject(this.appId)) {
                                this.appId = viewComponent.id;
                            }
                        }
                        this._registerEvent();
                    }  else {
                        this._registerEvent();
                    }
                } else {
                    this._registerEvent();
                }
                pubsubInstances.push(this);
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            detached: function () {
                var _pubsubListenerRegistryDetach=[];
                var i = pubsubInstances.indexOf(this);
                if (i >= 0) {
                    pubsubInstances.splice(i, 1);
                }               
                _pubsubListenerRegistryDetach = _pubsubListenerRegistry;
                _pubsubListenerRegistryDetach.forEach(function (v,index) {
                    if (v.pubsubElement == this) {                       
                        _pubsubListenerRegistry.splice(index, 1);
                    }
                }.bind(this));
            },

            _getPubSubContainer: function (element) {
                var parentNode = element.parentNode;
                if (parentNode) {
                    if (parentNode.isRufComponent) {
                        return parentNode;
                    }
                    else if (parentNode.host && parentNode.host.isRufComponent) {
                        return parentNode.host;
                    }
                    else {
                        return this._getPubSubContainer(Polymer.dom(parentNode));
                    }
                }
                return parentNode;
            },
            _registerEvent: function () {
                var pubSubContainer = this._getPubSubContainer(Polymer.dom(this).node);
                var pubsubContent = {}
                if (pubSubContainer && this.eventName) {
                    var eventAttr = "bedrock-event-" + this.eventName;
                    if (this.targetId) {
                        eventAttr = eventAttr + "-" + this.targetId;
                    }

                    if (!DataHelper.isEmptyObject(this.appId)) {
                        eventAttr = eventAttr + "-" + this.appId;
                    } else {
                        if (pubSubContainer.localName == "main-app" || ((pubSubContainer.className.indexOf('view-component') > -1) && pubSubContainer.contentViewManager)) {
                            if (pubSubContainer.id) {
                                eventAttr = eventAttr + "-" + pubSubContainer.id;
                            } else {
                                eventAttr = eventAttr + "-" + pubSubContainer.getAppId();
                            }
                        }
                        else {
                            var appId = pubSubContainer.getAppId();
                            if (appId && appId != "") {
                                eventAttr = eventAttr + "-" + appId;
                            }
                        }
                    }                    
                    pubsubContent.element = pubSubContainer
                    pubsubContent.eventName = eventAttr;
                    pubsubContent.pubsubElement = this;
                    _pubsubListenerRegistry.push(pubsubContent);
                    pubSubContainer.listen(pubSubContainer, eventAttr, this.handler);
                }
            },
            /**
              * Content development is under progress. 
              */
            registerEvent: function () {
                this._registerEvent();
            }
        });

        

        // event dispatcher
        function publish(name, data) {
            var rufEevent = new CustomEvent('bedrock-event-' + name, {
                bubbles: false,
                detail: data
            });
            // dispatch named-event to all pubsubInstances
            pubsubInstances.forEach(function (s) {
                s.dispatchEvent(rufEevent);
            });
        }

        // signal listener at document
        document.addEventListener('bedrock-event', function (e) {
            publish(e.detail.name, e.detail.data);
        });

    })();

</script>