<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/security-context-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">

<!--
`rock-disclaimer` Represents an element that renders the disclaimer for an App.
@demo demo/index.html
-->

<dom-module id="rock-disclaimer">
    <template>
        <style include="pebble-styles-shared">
           
            pebble-dialog{
                --dialog-component:{
                    width:570px !important;
                }
            }
            pebble-button#deny {
                --pebble-button-paper-style:{
                    color: var(--secondary-button-text-color, #75808b);
                    background-color: var(--secondary-button-color, #ffffff);
                    border: 1px solid var(--secondary-button-border-color, #c1cad4);
                    font-weight:var(--font-bold, bold) !important;
                    height: 30px;
                }
			}

            pebble-button#accept {
                --pebble-button-paper-style:{
                    color: var(--button-text-color, #ffffff);
                    background-color: var(--success-button-color, #09c021);
                    border-color: var(--success-button-color, #09c021);
                    font-weight:var(--font-bold, bold);
                    height: 30px;
                }
			}
        </style>
        <app-localstorage-document id="disclaimerStorage" key="disclaimer" data="{{_disclaimerObject}}" session-only="true"></app-localstorage-document>
        
        <pebble-dialog id="disclaimerDialog" modal small vertical-offset="150" horizontal-align="auto" vertical-align="auto" 
            no-cancel-on-outside-click no-cancel-on-esc-key>
            <div>
                <span>
                    <pebble-icon icon="{{_currentMessageIcon}}"></pebble-icon>
                </span>
                <span>{{_currentMessageText}}</span>
            </div>
            <div class="buttons-right" align="right">
                <pebble-button id="deny" button-text="Do not accept" on-tap="_denied" ></pebble-button>
                <pebble-button id="accept" button-text="Accept" on-tap="_accepted" ></pebble-button>
            </div>
        </pebble-dialog>
        <bedrock-pubsub on-bedrock-event-user-logout="_clearSession"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-disclaimer',
                properties: {
                    /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    messages:{
                        type:Array,
                        value:function(){
                            return [];
                        }
                    },
                    userDetails: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onUserDetailsChange'
                    },
                    viewOpened:{
                        type:Boolean,
                        observer: '_appViewOpened'
                    },
                    _disclaimerObject:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    },
                    _currentMessageId:{
                        type:Number,
                        value:0
                    },
                    _currentMessageText:{
                        type:String,
                        value:function(){
                            return "";
                        }
                    },
                    _currentMessageIcon:{
                        type:String,
                        value:function(){
                            return "";
                        }
                    }
                },
                _onUserDetailsChange: function(){
                    console.log(this._disclaimerObject)
                    var disclaimerObj = _.isEmpty(this._disclaimerObject) ? {} : JSON.parse(this._disclaimerObject);
                    if(this.userDetails && this.userDetails.isAuthenticated)
                    {
                        if(this.disclaimerObj && (this.disclaimerObj.userName != this.userDetails.userName)){
                            disclaimerObj = {userName:"", agreed:false}
                        }
                        disclaimerObj.userName = this.userDetails.userName;
                    }
                    this._disclaimerObject = JSON.stringify(disclaimerObj);
                },
                _appViewOpened: function(){
                    if(this.messages && this.messages.length > 0)
                    {
                        var disclaimerObj =JSON.parse(this._disclaimerObject);
                        if(disclaimerObj && !disclaimerObj.agreed)
                        {
                            this._openDialog(0);
                        }
                    }
                },
                _computeMessage:function(_type){
                    var computedValue = "";
                    if(this.messages && this.messages.length > 0)
                    {
                        var message = this.messages[this._currentMessageId];
                        if(message)
                        {
                            computedValue = message[_type];
                        }
                    }
                    return computedValue;
                },
                _openDialog:function(_messageId)
                {
                    this.set("_currentMessageId", _messageId);
                    //setting title
                    this.$.disclaimerDialog.set('dialogTitle', this._computeMessage('title'));
                    //setting message 
                    this._currentMessageText = this._computeMessage('message');
                    //setting message icons
                    this._currentMessageIcon = this._computeMessage('icon');
                    this.$.disclaimerDialog.open();
                },
                _accepted:function(){
                    var disclaimerObj =JSON.parse(this._disclaimerObject);
                    disclaimerObj.agreed = true;
                    this._disclaimerObject =JSON.stringify(disclaimerObj);
                    this.$.disclaimerDialog.close();
                },
                _denied:function(){
                    if(this._currentMessageId < this.messages.length-1)
                    {   
                        var nextMessageId = this._currentMessageId + 1;
                        this._openDialog(nextMessageId);
                    }else{
                        SecurityContextHelper.logout();
                    }
                },
                _clearSession:function(){
                    this.$.disclaimerStorage.destroy();
                }
            });
        })();
    </script>
</dom-module>