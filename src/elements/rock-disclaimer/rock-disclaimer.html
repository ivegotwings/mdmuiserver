<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-helpers/security-context-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
`rock-disclaimer` Represents an element that renders the disclaimer for an App.
@demo demo/index.html
-->

<dom-module id="rock-disclaimer">
    <template>
        <style include="bedrock-style-common"></style>   
        <template is="dom-if" if="[[_isDisclaimerNeeded(messages)]]">
            <pebble-dialog id="disclaimerDialog" modal alert-box vertical-offset="150" horizontal-align="auto" vertical-align="auto" 
                no-cancel-on-outside-click no-cancel-on-esc-key>
                <div>
                    <span>
                        <pebble-icon icon="{{_currentMessage.icon}}" class="pebble-icon-color-blue m-r-5"></pebble-icon>
                    </span>
                    <span>{{_currentMessage.message}}</span>
                </div>
                <div class="buttons-right m-t-5" align="center">
                    <pebble-button id="deny" class="close btn btn-secondary m-r-5" button-text="{{_currentMessage.denyButtonLabel}}" on-tap="_denied" ></pebble-button>
                    <pebble-button id="accept" class="apply btn btn-success" button-text="{{_currentMessage.acceptButtonLabel}}" on-tap="_accepted" ></pebble-button>
                </div>
            </pebble-dialog>
        </template>
        <bedrock-pubsub on-bedrock-event-user-logout="_clearSession" name="bedrock-event-user-logout"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-disclaimer',
                properties: {
                    /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    messages:{
                        type:Array,
                        value:function(){
                            return [];
                        },
                        notify: true
                    },
                    userDetails: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onUserDetailsChange'
                    },
                    viewOpened:{
                        type:Boolean,
                        observer: '_appViewOpened'
                    },
                    _currentMessageId:{
                        type:Number,
                        value:0
                    },
                    _currentMessage:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    },
                    contextData:{
                        type:Object,
                        observer:"_onContextDataChange"
                    }
                },

                behaviors: [RUFBehaviors.ComponentConfigBehavior],

                _onContextDataChange: function(){
                    if(!_.isEmpty(this.contextData)){
                        var context = DataHelper.cloneObject(this.contextData);
                        var appName = ComponentHelper.getCurrentActiveAppName();
                        if(appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }
                        this.requestConfig("rock-disclaimer", context);
                    }
                },

                onConfigLoaded: function (componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        if(componentConfig.config.disclaimers && componentConfig.config.disclaimers.visible){
                            delete componentConfig.config.disclaimers.visible;
                            var disclaimers = DataHelper.convertObjectToArray(componentConfig.config.disclaimers);
                            this.messages = disclaimers;
                            this._appViewOpened();
                        }
                    }
                },

                _onUserDetailsChange: function(){                    
                    var disclaimerObj = _.isEmpty(sessionStorage.getItem('disclaimer')) ? {} : JSON.parse(sessionStorage.getItem('disclaimer'));
                    if(this.userDetails && this.userDetails.isAuthenticated)
                    {
                        if(typeof disclaimerObj === "string"){
                            disclaimerObj = JSON.parse(disclaimerObj);
                        }
                        if(disclaimerObj && (disclaimerObj.userName != this.userDetails.userName)){
                            disclaimerObj = {userName:"", agreed:false}
                        }
                        disclaimerObj.userName = this.userDetails.userName;
                        sessionStorage.setItem("disclaimer", JSON.stringify(disclaimerObj));
                    }
                },

                _appViewOpened: function(){
                    if(this.messages && this.messages.length > 0)
                    {
                        var disclaimerObj = JSON.parse(sessionStorage.getItem('disclaimer'));
                        if(disclaimerObj && !disclaimerObj.agreed)
                        {
                            this._openDialog(0);
                        }
                    }
                },

                _openDialog:function(_messageId)
                {
                    this.set("_currentMessageId", _messageId);
                    if(this.messages && this.messages.length > 0)
                    {
                        this._currentMessage = this.messages[_messageId];
                    }
                    setTimeout(() => {
                        const disclaimerDialog = this.shadowRoot.querySelector("#disclaimerDialog");
                        disclaimerDialog.set('dialogTitle', this._currentMessage.title);
                        disclaimerDialog.open();
                    }, 0);
                },

                _accepted:function(){
                    var disclaimerObj =  JSON.parse(sessionStorage.getItem('disclaimer'));
                    if(disclaimerObj){
                        if(typeof disclaimerObj === "string"){
                            disclaimerObj =  JSON.parse(disclaimerObj);
                        }
                        disclaimerObj.agreed = true;
                        sessionStorage.setItem('disclaimer', JSON.stringify(disclaimerObj));
                    }
                    this.shadowRoot.querySelector("#disclaimerDialog").close();
                },

                _denied:function(){
                    if(this._currentMessageId < this.messages.length-1)
                    {   
                        var nextMessageId = this._currentMessageId + 1;
                        this._openDialog(nextMessageId);
                    }else{
                        SecurityContextHelper.logout();
                    }
                },

                _clearSession:function(){
                    sessionStorage.clear();
                },

                _isDisclaimerNeeded:function(){
                    if(this.messages && this.messages.length > 0){
                        return true;
                    }
                    return false;
                }
            });
        })();
    </script>
</dom-module>