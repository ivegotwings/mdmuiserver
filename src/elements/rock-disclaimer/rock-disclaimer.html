<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../bedrock-helpers/security-context-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">

<!--
`rock-disclaimer` Represents an element that renders the disclaimer for an App.
@demo demo/index.html
-->

<dom-module id="rock-disclaimer">
    <template>
        <style include="bedrock-style-common"></style>
        <app-localstorage-document id="disclaimerStorage" key="disclaimer" data="{{_disclaimerObject}}" session-only="true"></app-localstorage-document>
        
        <pebble-dialog id="disclaimerDialog" modal alert-box vertical-offset="150" horizontal-align="auto" vertical-align="auto" 
            no-cancel-on-outside-click no-cancel-on-esc-key>
            <div>
                <span>
                    <pebble-icon icon="{{_currentMessage.icon}}"></pebble-icon>
                </span>
                <span>{{_currentMessage.message}}</span>
            </div>
            <div class="buttons-right" align="right">
                <pebble-button id="deny" class="close btn btn-secondary m-r-5" button-text="{{_currentMessage.denyButtonLabel}}" on-tap="_denied" ></pebble-button>
                <pebble-button id="accept" class="apply btn btn-success" button-text="{{_currentMessage.acceptButtonLabel}}" on-tap="_accepted" ></pebble-button>
            </div>
        </pebble-dialog>
        <bedrock-pubsub on-bedrock-event-user-logout="_clearSession"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-disclaimer',
                properties: {
                    /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    messages:{
                        type:Array,
                        value:function(){
                            return [];
                        }
                    },
                    userDetails: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onUserDetailsChange'
                    },
                    viewOpened:{
                        type:Boolean,
                        observer: '_appViewOpened'
                    },
                    _disclaimerObject:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    },
                    _currentMessageId:{
                        type:Number,
                        value:0
                    },
                    _currentMessage:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    }
                },
                _onUserDetailsChange: function(){
                    var disclaimerObj = _.isEmpty(this._disclaimerObject) ? {} : JSON.parse(this._disclaimerObject);
                    if(this.userDetails && this.userDetails.isAuthenticated)
                    {
                        if(this.disclaimerObj && (this.disclaimerObj.userName != this.userDetails.userName)){
                            disclaimerObj = {userName:"", agreed:false}
                        }
                        disclaimerObj.userName = this.userDetails.userName;
                    }
                    this._disclaimerObject = JSON.stringify(disclaimerObj);
                },
                _appViewOpened: function(){
                    if(this.messages && this.messages.length > 0)
                    {
                        var disclaimerObj =JSON.parse(this._disclaimerObject);
                        if(disclaimerObj && !disclaimerObj.agreed)
                        {
                            this._openDialog(0);
                        }
                    }
                },
                _openDialog:function(_messageId)
                {
                    this.set("_currentMessageId", _messageId);
                    if(this.messages && this.messages.length > 0)
                    {
                        this._currentMessage = this.messages[_messageId];
                    }
                    //setting title
                    this.$.disclaimerDialog.set('dialogTitle', this._currentMessage.title);
                    this.$.disclaimerDialog.open();
                },
                _accepted:function(){
                    var disclaimerObj =JSON.parse(this._disclaimerObject);
                    disclaimerObj.agreed = true;
                    this._disclaimerObject =JSON.stringify(disclaimerObj);
                    this.$.disclaimerDialog.close();
                },
                _denied:function(){
                    if(this._currentMessageId < this.messages.length-1)
                    {   
                        var nextMessageId = this._currentMessageId + 1;
                        this._openDialog(nextMessageId);
                    }else{
                        SecurityContextHelper.logout();
                    }
                },
                _clearSession:function(){
                    this.$.disclaimerStorage.destroy();
                }
            });
        })();
    </script>
</dom-module>