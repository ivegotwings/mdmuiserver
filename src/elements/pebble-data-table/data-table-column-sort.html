<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="data-table-icons.html">

<dom-module id="data-table-column-sort">
  <template>
    <style include="bedrock-style-common">
       :host {
        display: block;
        margin: 0 4px;
        cursor: pointer;
      }

       :host([hidden]) {
        display: none;
      }

      pebble-icon {
        position: relative;
        opacity: .84;
        transition: all .2s;
       }   

      @supports (-ms-ime-align: auto) { /* For EDGE browser */        
        pebble-icon {
          padding: 0!important;
        }
      }

      pebble-icon:hover,
      pebble-icon[focused] {
        color: var(--default-primary-color);
      }

      pebble-icon:not([direction]) {
        opacity: .26;
        position: relative;
        @apply --pebble-icon-opacity;
      }

      pebble-icon[direction='desc'] {
        transform: rotate(-180deg);
      }

      pebble-icon[hidden] {
        display: none;
      }

      .order {
        font-size: 9px;
        font-weight: bold;
        position: absolute;
        right: 4px;
        bottom: 8px;
        @apply --data-table-column-sort-order;
      }

      .wrapper {
        position: relative;
        top: -1px;
      }
    </style>

    <div class="wrapper">
      <pebble-icon id="sortIcon" class="pebble-icon-size-10 pebble-icon-color-blue" on-tap="_sort" icon="pebble-icon:sort-desc" direction$="[[direction]]"></pebble-icon>
      <div class="order">[[order]]</div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'data-table-column-sort',

      properties: {
        direction: {
          type: String,
          notify: true
        },
        path: {
          type:String
        },
        order: {
          type: Number,
          computed: '_order(path, sortOrder, sortOrder.length)'
        },
        sortOrder: {
          type:Array
        },
        dataType: {
          type:String
        }
      },

      observers: ['_sortOrderChanged(sortOrder.*)'],

      _order: function (path, sortOrder, length) {
        if (length <= 1) {
          return '';
        }

        for (let i = 0; i < length; i++) {
          if (sortOrder[i].path === path) {
            return i + 1;
          }
        }
      },

      _sortOrderChanged: function (sortOrder) {
        if (sortOrder != undefined) {
          // TODO: if sortOrder for this column has been removed from outside, direction is not updated.
          if (sortOrder.base) {
            sortOrder.base.forEach(function (sort) {
              if (sort.path === this.path) {
                this.direction = sort.direction;
                return;
              }
            }.bind(this));
          }
        }
      },

      _sort: function () {
        switch (this.direction) {
          case 'asc':
            this.direction = 'desc';
            break;

          case 'desc':
            this.direction = 'asc';
            break;

          default:
            this.direction = 'asc';
            break;
        }

        this.dispatchEvent(new CustomEvent('sort-direction-changed', {detail:{
          path: this.path,
          direction: this.direction,
          dataType:this.dataType
        },bubbles:true,composed:true}));
      }
    });
  </script>
</dom-module>
