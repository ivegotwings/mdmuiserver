<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">

<dom-module id="grid-selection-popover">
  <template>
    <style include="bedrock-style-common">
      li {
        list-style: none;
        -webkit-transition: all 0.3s;
        -moz-transition: all 0.3s;
        -o-transition: all 0.3s;
        transition: all 0.3s;
      }

      .checkbox-wrapper {
        margin-right: 10px;
        float: left;
        margin-top: 4px;
        pointer-events: none;
      }

      .item-wrapper {
        float: left;
        padding: 5px 0;
      }

      .title {
        font-size: 12px;
        line-height: 14px;
        word-break: break-word;
        font-weight: 400;
        text-transform: capitalize;
        color: var(--palette-steel-grey, #75808b);
      }

      ul {
        margin: 0px;
        padding: 0px;
        z-index: initial;
      }

      #actionButtons {
        padding-top: 10px;
        text-align: center;
      }

      .item {
        text-align: left;
        cursor: pointer;
        color: var(--palette-steel-grey, #75808b);
        @apply --popup-item;
        overflow: hidden;
      }

      .item[selected] {
        color: var(--dropdown-selected-font, #036bc3);
      }

      .item:hover,
      .item[focused] {
        background: var(--dropdown-selected, #e8f4f9);
        color: var(--dropdown-selected-font, #036bc3);
      }

      .popoverContent {
        position: relative;
        z-index: 10000;
      }

      #gridSelectionPopover {
        @apply --popover-position;
      }
    </style>
    <pebble-icon id="gridSelectionFilterIcon" class="pebble-icon-size-10" icon="[[icon]]" on-tap="_onPopoverOpen"></pebble-icon>
      <pebble-popover id="gridSelectionPopover" for="gridSelectionFilterIcon" no-overlap vertical-align="auto"
        horizontal-align="auto">
        <div class="popoverContent">
          <ul>
            <template is="dom-repeat" items="{{selectionOptions}}">
              <li class="item" on-tap="_onSelectionOptionClick" id="[[index]]">
                <div class="checkbox-wrapper">
                  <pebble-checkbox item="[[item.value]]" checked="{{item.checked}}">
                    <span class="title">[[item.label]]</span>
                  </pebble-checkbox>
                </div>
              </li>
            </template>
          </ul>
          <div id="actionButtons" class="buttons">
            <pebble-button id="cancelButton" class="close btn btn-secondary m-r-5" button-text="Close" noink elevation="2" on-tap="_onClose"></pebble-button>
            <pebble-button id="confirmButton" class="apply btn btn-success" button-text="Apply" noink elevation="2" on-tap="_onApply"></pebble-button>
          </div>
        </div>
      </pebble-popover>
    <bedrock-pubsub event-name="on-popover-close" handler="_onPopoverClose"></bedrock-pubsub>

  </template>
  <script>
    Polymer({
      is: 'grid-selection-popover',
      properties: {
        selectionOptions: {
          type: Array,
          value: function () {
            return [];
          }
        },
        selectedOption: {
          type: Object,
          value: function () {
            return {}
          }
        },
        previousStateKey: {
          type: String,
          value: ''
        },
        icon: {
          type: String,
          value: 'pebble-icon:Down'
        }
      },
      _onPopoverOpen: function (e) {
        this.shadowRoot.querySelector('#gridSelectionPopover').show();
      },
      _onPopoverClose: function () {
        this.onClose();
      },
      onClose: function () {
        if (this.previousStateKey != '') {
          var completeOptions = DataHelper.cloneObject(this.selectionOptions);
          completeOptions.forEach(function (value, key) {
            if (this.previousStateKey == key) {
              value.checked = true;
            } else {
              value.checked = false;
            }
          }.bind(this));
          this.set("selectionOptions", completeOptions);
        } else {
          this.resetSelection();
        }
      },
      _onClose: function () {
        this.shadowRoot.querySelector('#gridSelectionPopover').hide();
        this.onClose();
      },
      _onSelectionOptionClick: function (e) {
        this.selectedOption = Object.create({});
        var checkedId = parseInt(e.currentTarget.id);
        var completeOptions = DataHelper.cloneObject(this.selectionOptions);
        completeOptions.forEach(function (value, key) {
          if (checkedId == key) {
            value.checked = !value.checked;
            if (value.checked == true) {
              this.selectedOption = value;
            }
          } else {
            value.checked = false;
          }
        }.bind(this));
        this.set("selectionOptions", completeOptions);
      },
      _onApply: function (e) {
        this.shadowRoot.querySelector('#gridSelectionPopover').hide();
        var detail = this.selectedOption;
        if (Object.keys(this.selectedOption).length > 0) {
          var completeOptions = DataHelper.cloneObject(this.selectionOptions);
          completeOptions.forEach(function (value, key) {
            if (value && value.checked == true) {
              this.previousStateKey = key.toString();
            }
          }.bind(this));
        } else {
          this.previousStateKey = '';
        }
        var eventDetail = DataHelper.cloneObject(detail);
        this.dispatchEvent(new CustomEvent("selection-changed", { detail: eventDetail, bubbles: true, composed: true }));
      },
      resetSelection: function () {
        this.selectedOption = Object.create({});
        this.previousStateKey = '';
        var completeOptions = DataHelper.cloneObject(this.selectionOptions);
        completeOptions.forEach(function (value, key) {
          value.checked = false;
        });
        this.set("selectionOptions", completeOptions);
      }
    });
  </script>
</dom-module>