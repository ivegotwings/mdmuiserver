<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<dom-module id="data-table-row">

  <template>
    <custom-style>
      <style>
         :host {
          display: flex;
          display: -webkit-flex;
          flex-direction: column;
          opacity: 1;
          cursor: pointer;

          @apply --pebble-data-table-row;
        }

         :host([selected]) .cells {
          @apply --pebble-data-table-row-selected;
        }

         :host(:not([header])[even]) {
          @apply --pebble-data-table-row-even;
        }

         :host(:not([header]):not([even])) {
          @apply --pebble-data-table-row-odd;
        }

         :host(:focus) {
          outline: none;
          @apply --pebble-data-table-row-focused;
        }

         :host(:not([header]):hover) {
          @apply --pebble-data-table-row-hover;
        }

         :host(:focus):after {
          @apply --pebble-data-table-row-focused-after;
        }

         :host:after {
          @apply --pebble-data-table-row-after;
        }

        .cells {
          display: flex;
          display: -webkit-flex;
          flex-direction: row;
          width: 100%;         
        }
        .picked{
          @apply --pebble-data-table-row-cell;
        }
        
        .cells:hover::after {
          @apply --pebble-data-table-row-cell-after;
        }
        .cells {
            -moz-user-select: none;          
            -khtml-user-select: none;          
            -webkit-user-select: none;          
            user-select: none;
          
        }
      </style>
    </custom-style>
    <div class="cells" on-mousedown="dragMouseDown" on-mouseup="closeDragElement" on-track="handleTrack">
      <slot name="row-header"></slot>
      <slot name="data-table-checkbox-slot"></slot>
      <slot name="data-table-cell-slot"></slot>
    </div>
    <div class="details">
      <slot name="data-table-row-detail-slot"></slot>
    </div>
  </template>
  <script>
    Polymer({
      is: 'data-table-row',

      properties: {
        beforeBind: {
          type:Object
        },
        expanded: {
          type: Boolean,
          reflectToAttribute: true
        },
        index: {
          type:Number
        },
        item: {
          type:Object
        },
        selected: {
          type: Boolean,
          reflectToAttribute: true
        },
        _static: {
          type: Object,
          value: { id: 0 }
        },
        rowDragDropEnabled:{
          type:Boolean
        },
        pickedIndex:{
          type:Number
        }
      },

      observers: ['_beforeBind(beforeBind, index, item.*, selected, expanded)'],

      behaviors: [
          RUFBehaviors.UIBehavior
      ],

      attached: function () {
        if (this.domHost && this.domHost.tagName.toUpperCase() === 'PEBBLE-DATA-TABLE') {
          var id = this._static.id++;

          var item = this.parentElement;
          if (!item._rowId) {
            this._contentElement = document.createElement('slot');
            
            this.id = 'item' + id;
            if(this.hasAttribute('header')){
              this._contentElement.setAttribute('name', "header");
            }else{
              this._contentElement.setAttribute('name', "#"+this.id);
              this.slot = "#"+this.id;
            }
           // if(this.slot && (this.slot == 'data-table-list-item')){
           //   this._contentElement.setAttribute('name', "#"+this.id);
              // this.slot = "#"+this.id;
            // }else{
            //   this._contentElement.setAttribute('name', 'data-table-header');
            // }
            Polymer.dom(item).node.appendChild(this._contentElement);
            item._rowId = id;
            Polymer.dom(this.domHost).node.appendChild(this);
            
            // reset the cached value for shady root owner to make this.domHost
            // return correct value.  `
            this._ownerShadyRoot = undefined;
          }
        }
      },
      dragMouseDown: function (e) {
         if (this.rowDragDropEnabled) {
            this.pickedIndex = this.index;
            this.parentNode["pickedRowIndex"] = this.index;
          }
      },
      handleTrack: function (e) {
        if (this.rowDragDropEnabled) {
          switch (e.detail.state) {
            case 'start':
              e.detail.pickedIndex = this.pickedIndex;
              this._addPickedBackgroundColor();
              this.fireBedrockEvent("drag-started", e.detail, { ignoreId: true });
              break;
            case 'track':
              this.fireBedrockEvent("drag-inprogress", e.detail, { ignoreId: true });
              break;
          }
        }
      },
      closeDragElement: function (e) {
        if (this.rowDragDropEnabled) {
          var eventDetail = {
            "pickedRowIndex": this.parentNode["pickedRowIndex"],
            "droppedAtIndex": this.index,
            "event": e
          };
          this._removePickedBackgroundColor();
          this.fireBedrockEvent("drag-ended", eventDetail, { ignoreId: true });
          if (eventDetail.pickedRowIndex !== eventDetail.droppedAtIndex) {
            this.fireBedrockEvent("row-dropped", eventDetail, { ignoreId: true });
          }
        }
      },
      _addPickedBackgroundColor: function () {
        var dataTableRows = this.parentElement.querySelectorAll('data-table-row');
        for (var i = 0; i < dataTableRows.length; i++) {
          if (dataTableRows[i].shadowRoot.querySelector('.cells') && this.pickedIndex == i-1) {
            dataTableRows[i].shadowRoot.querySelector('.cells').classList.add('picked');
          }
        }
      },
      _removePickedBackgroundColor: function () {
        var dataTableRows = this.parentElement.querySelectorAll('data-table-row');
        for (var i = 0; i < dataTableRows.length; i++) {
          if (dataTableRows[i].shadowRoot.querySelector('.cells')) {
            dataTableRows[i].shadowRoot.querySelector('.cells').classList.remove('picked');
          }
        }
      },    
      _beforeBind: function (beforeBind, index, item, selected, expanded) {
        //TODO need to check functionally what all combinations should aloow to execute this function instead waiting for all params with some other values.
        if (!(beforeBind === undefined || index === undefined || item === undefined || selected === undefined || expanded === undefined)) {
          var data = {
            index: index,
            item: item.base,
            expanded: expanded,
            selected: selected
          };

          beforeBind(data, this);
        }
      }
    });
  </script>
</dom-module>