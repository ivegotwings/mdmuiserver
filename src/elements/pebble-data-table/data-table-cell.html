<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="data-table-templatizer-behavior.html">

<dom-module id="data-table-cell">
  <template>
    <style>
       :host {
        flex: 1 0 100px;
        padding: 0 24px 0 24px;
        min-height: 10px;
        /* Prevent iron-list from looping when item height is really small */
        height: 48px;
        display: flex;
        align-items: center;
        /*overflow: hidden;*/
        transition: flex-basis 200ms, flex-grow 200ms;
      }

       :host([hidden]) {
        display: none;
      }
    </style>
    <slot></slot>
  </template>
  <script>
    Polymer({
      is: 'data-table-cell',
      behaviors: [saulis.DataTableTemplatizerBehavior],

      properties: {
        alignRight: {
          type: Boolean
        },
        column: Object,
        flex: Number,
        header: Boolean,
        hidden: Boolean,
        order: Number,
        template: Object,
        width: String,

        beforeBind: {
          type: Object,
          value: function () {
            return function (data, cell) { };
          }
        }
      },

      observers: [
        '_beforeBind(beforeBind, column.*, index, item.*, expanded, selected)',
        '_beforeBindHeader(beforeBind, column.*)',
        '_alignRightChanged(alignRight)',
        '_columnChanged(_instance, column)',
        '_columnPathChanged(_instance, column.*)',
        '_flexChanged(flex)',
        '_hiddenChanged(hidden)',
        '_orderChanged(order)',
        '_widthChanged(width)'],

      attached: function () {
        if (!Polymer.Settings.useShadow) {
          // cell is supposed to be placed outside the local dom of pebble-data-table.
          Polymer.StyleTransformer.dom(this, 'pebble-data-table', this._scopeCssViaAttr, true);
          if (this.domHost) {
            Polymer.StyleTransformer.dom(this, this.domHost.tagName.toLowerCase(), this._scopeCssViaAttr, false);
          }
        }
      },

      _alignRightChanged: function (alignRight) {
        if (alignRight != undefined) {
          this.style.flexDirection = alignRight ? 'row-reverse' : 'row';
        }
      },

      _beforeBind: function (beforeBind, column, index, item, expanded, selected) {
        //TODO need to check functionally what all combinations should aloow to execute this function instead waiting for all params with some other values.
        if (!(beforeBind === undefined || column === undefined || index === undefined || item == undefined || expanded === undefined || selected === undefined)) {
          var data = {
            column: column.base,
            index: index,
            item: item.base,
            expanded: expanded,
            selected: selected
          };

          beforeBind(data, this);
        }
      },

      // header cells aren't bound with item, index etc. so _beforeBind is never
      // called for them so we need a separate observer.
      _beforeBindHeader: function (beforeBind, column) {
        if (!(beforeBind === undefined || column === undefined)) {
          if (this.header) {
            var data = {
              column: column.base
            };

            beforeBind(data, this);
          }
        }
      },

      _hiddenChanged: function (hidden) {
        if (hidden != undefined) {
          this.toggleAttribute('hidden', hidden);
        }
      },

      _orderChanged: function (order) {
        if (order != undefined) {
          this.style.order = order;
        }
      },

      _flexChanged: function (flex) {
        if (flex != undefined) {
          this.style.flexGrow = flex;
        }
      },

      _widthChanged: function (width) {
        if (width != undefined) {
          this.style.flexBasis = width;
        }
      },

      _columnChanged: function (instance, column) {
        if (!(instance === undefined || column === undefined)) {
          instance.column = column;
        }
      },

      _columnPathChanged: function (instance, column) {
        // sometimes instance isn't ready to be notified yet and throws an error.
        if (!(instance === undefined || column === undefined)) {
          Polymer.Async.microTask.run(() => {
            // TODO: hack to avoid: https://github.com/Polymer/polymer/issues/3307
            this._parentProps = this._parentProps || {};
            instance.notifyPath(column.path, column.value);
          });
        }
      }
    });
  </script>
</dom-module>