<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
@group rock Elements
@element rock-business-actions
@demo demo/index.html
-->
<dom-module id="rock-business-actions">
    <template>
        <style include="bedrock-style-common"></style>
        <style>
        </style>
        <pebble-actions id="actionsButton" button-icon="[[buttonIcon]]" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
            button-text="[[buttonText]]" actions-data="[[businessActions]]">
        </pebble-actions>
        <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
        <liquid-entity-model-get id="entityGetWorkflowDefinition" operation="getbyids" request-id="req1" request-data={{workflowDefinitionRequest}}
            on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <liquid-rest id="entityWfAssignment" url="/data/pass-through/entitygovernservice/workflowChangeAssignment" method="POST"
            request-data={{_wfAssignmentRequest}} on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
    </template>
    <script>
        class RockBusinessActions
            extends Polymer.mixinBehaviors([
                RUFBehaviors.AppBehavior,
                RUFBehaviors.ComponentContextBehavior, 
                RUFBehaviors.ComponentConfigBehavior
            ], Polymer.Element) {
            static get is() { return 'rock-business-actions' }
            ready() {
                super.ready();
            }
            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },
                    showWorkflowActions: {
                        type: Boolean,
                        value: false
                    },
                    businessActions: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    buttonText: {
                        type: String,
                        value: "Actions"
                    },
                    buttonIcon: {
                        type: String,
                        value: "pebble-icon:action-take-task"
                    },
                    isSingleEntityProcess: {
                        type: Boolean,
                        value: false
                    },
                    workflowDefinitionRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _wfAssignmentRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    businessActionsConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _runningInstances: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _currentWorkflowAction: {
                        type: String
                    },
                    _failedWorkflows: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _doneWorkflows: {
                        type: Array,
                        value: function () { return []; }
                    },
                    workflowInfo: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: "_onWorkflowInfoChange"
                    }
                }
            }
            static get observers() {
                return []
            }
            /**
            *
            */
            connectedCallback() {
                super.connectedCallback();
            }
            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }

            _onContextDataChange() {
                if (!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if (appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }

                    this.requestConfig('rock-business-actions', context);
                }
            }

            onConfigLoaded(componentConfig) {
                if (componentConfig && componentConfig.config) {
                    var actionGroups = [];

                    if (componentConfig.config.actionGroups) {
                        for (var key in componentConfig.config.actionGroups) {
                            var group = componentConfig.config.actionGroups[key];

                            if (!this.showWorkflowActions && group.isWorkflowActions) {
                                continue;
                            }

                            group.actions = DataHelper.convertObjectToArray(group.actions);
                            actionGroups.push(group);
                        }

                        this.businessActions = actionGroups;
                    }
                }
                //disable actions based on dimension selector selection status
                //pass all the actions you want to disable on multiple dimensions in actionsToDisable
                var actionsToDisable = ["snapshots"];
                this._disableActions(actionsToDisable);
            }

            _disableActions(actionsToDisable) {
                var dataContext = this.getDataContexts();
                if (dataContext.length > 1) {
                    this.businessActions.forEach(elm => {
                        elm.actions.forEach(action => {
                            if (actionsToDisable.indexOf(action.name) !== -1) {
                                action.visible = false;
                            }
                        });
                    });
                }
            }

            _onWorkflowInfoChange() {
                if (this.isSingleEntityProcess && !_.isEmpty(this.workflowInfo)) {
                    this._toggleActionItems();
                }
            }

            triggerProcess(selectedDetails, workflowCriterion) {
                if (!this._currentAction || !this._currentAction.data) return;

                const { eventName, componentName, subComponentName } = this._currentAction.data;

                if (!eventName) {
                    this.showErrorToast("Unknown action triggered, system cannot do the process.");
                    return;
                }

                const { selectedItems, selectionMode, selectionQuery } = selectedDetails;
                
                this._workflowCriterion = workflowCriterion || {};

                const asyncAvailable = eventName == "action-takeTask" || eventName == "action-releaseTask" || eventName == "action-wfTransitions" || eventName == "action-add-context" || eventName == "action-reassignTask" || eventName == "action-view-snapshot";

                if (!asyncAvailable || (asyncAvailable && selectionMode == "count")) {
                    if (DataHelper.isEmptyObject(selectedItems)) {
                        this.showErrorToast(
                            "Select atleast one entity for which you want to perform this action."
                        );
                        return;
                    }
                }

                if (asyncAvailable) {
                    if (selectionMode == "query" && DataHelper.isEmptyObject(selectionQuery)) {
                        this.showErrorToast(
                            "Selection query should be available for which you want to perform this action."
                        );
                        return;
                    }
                }else if (!DataHelper.isEmptyObject(selectedItems) && (selectedItems.length > 20)) {
                    this.showErrorToast("Maximum 20 entities can be selected.");
                    return;
                }

                if (!DataHelper.isEmptyObject(selectedItems)) {
                    this._selectedItems = selectedItems;
                }

                let detail = null;
                let sharedData = null;

                switch(eventName) {
                    case 'action-takeTask':
                        return this._showAssignmentDialog(this._currentAction, "take", selectionMode, selectionQuery);
                    case 'action-releaseTask':
                        return this._showAssignmentDialog(this._currentAction, "release", selectionMode, selectionQuery);
                    case 'action-reassignTask':
                        return this._showAssignmentDialog(this._currentAction, "reassign", selectionMode, selectionQuery);
                    case 'action-compare-entities':
                        return this._compareEntities();
                    case 'action-wfTransitions':
                        //Fetch the wf details from the URL
                        const { 
                            userId,
                            workflowName,
                            wfActivityName, 
                            workflowActivityName, 
                            workflowActivityExternalName
                        } = this._workflowCriterion;

                        detail = {
                            name: componentName,
                            mergeTitle: true,
                            title: workflowActivityExternalName
                        };
                        
                        sharedData = {
                            "selection-mode": selectionMode,
                            "selection-query": selectionQuery,
                            "selected-entities": this._selectedItems,
                            "current-workflow": {
                                "name": workflowName,
                                "activityName": workflowActivityName
                            }
                        };
                        break;
                    case 'action-rollup':
                        detail = {
                            name: componentName,
                            subName: subComponentName
                        };

                        sharedData = {"selected-entities": this._selectedItems};
                        break;
                    case 'action-re-publish':
                        detail = {
                            name: componentName,
                            subName: subComponentName
                        };

                        sharedData = { "selected-entities": this._selectedItems, "selection-mode": selectionMode};
                        break;                        
                    case 'action-add-context':
                        var properties = this._currentAction.data.properties;
                        var entityTypeManager = EntityTypeManager.getInstance();
                        if(!properties || _.isEmpty(properties.allowedEntityTypes)) {
                            this.showErrorToast("Entities are not allowed for reclassification, please contact administrator.");
                            return;
                        }

                        var allowedTypesExtenalNamesList = properties.allowedEntityTypes.map(function(entityType){
                            return entityTypeManager.getTypeExternalNameById(entityType) || entityType;
                        })
                        if(!this._isSelectedItemsAllowed(properties.allowedEntityTypes)) {
                            this.showErrorToast("Only " + allowedTypesExtenalNamesList.join(", ")  + " entities can be reclassified, please select allowed entities.");
                            return;
                        }

                        detail = {
                            name: componentName,
                            subName: subComponentName
                        };
                        sharedData = {
                            "title": this._currentAction.data.title,
                            "selected-entities": this._selectedItems,
                            "selection-mode": selectionMode,
                            "selection-query": selectionQuery,
                            "taxonomy": properties.context.taxonomy
                        };
                        break;
                    default:
                        this.showErrorToast("Not implemented, please contact administrator.");
                        break;
                }

                this.openBusinessFunctionDialog(detail, sharedData);
            }

            _isSelectedItemsAllowed(allowedEntityTypes) {
                var allowed = true;
                for(var entityIdx = 0; entityIdx < this._selectedItems.length; entityIdx++) {
                    if(this._selectedItems[entityIdx] && allowedEntityTypes.indexOf(this._selectedItems[entityIdx].type) == -1) {
                        allowed = false;
                        break;
                    }
                }

                return allowed;
            }

            _compareEntities() {
                var mainApp = RUFUtilities.mainApp;
                var dataRoute = this._currentAction.data.dataRoute;
                var entityIds = [];
                var entityTypes = [];

                this._selectedItems.forEach(function (selectedItem) {
                    entityIds.push(selectedItem.id);

                    if (entityTypes.indexOf(selectedItem.type) < 0) {
                        entityTypes.push(selectedItem.type);
                    }
                });

                var compareEntitiesContextId = ElementHelper.getRandomId();
                var compareEntititesContextData = {
                    "entityIds": entityIds,
                    "entityTypes": entityTypes,
                    "contextData": this.contextData
                }

                sessionStorage.setItem(compareEntitiesContextId, JSON.stringify(compareEntititesContextData));
                ComponentHelper.setQueryParamsWithoutEncode({ "compareEntitiesContextId": compareEntitiesContextId });
                mainApp.changePageRoutePath(dataRoute);
            }

            _showAssignmentDialog(detail, action, selectionMode, selectionQuery) {
                const { 
                    workflowName, 
                    workflowShortName, 
                    workflowActivityName,
                    workflowActivityExternalName
                } = this._workflowCriterion;

                var workflowInfo = [{
                    "name": workflowShortName,
                    "activityName": workflowActivityName
                }];

                const sharedData = {
                    "selection-mode": selectionMode,
                    "selection-query": selectionQuery,
                    "selected-entities": this._selectedItems,
                    "assignment-Action": action,
                    "workflow-info": workflowInfo
                };
                var dialogTitle = this._getTitleByAction(action);

                this.openBusinessFunctionDialog({name: detail.data.componentName, title:dialogTitle}, sharedData);
            }

            _getTitleByAction(action) {
                var dialogTitle = "";
                switch(action){
                    case "take":
                            dialogTitle = "Take Task";
                        break;
                    case "release":
                            dialogTitle = "Release Task";
                        break;
                    case "reassign":
                            dialogTitle = "Reassign Task";
                        break;
                }

                return dialogTitle;
            }

            _toggleActionItems() {
                var assignmentActions = this.shadowRoot.querySelector("#actionsButton");
                if (assignmentActions) {
                    var items = assignmentActions.getActionItems();
                    var userContext = ContextHelper.getFirstUserContext(this.contextData);
                    var assignedUser;

                    if (DataHelper.isValidObjectPath(this.workflowInfo, "data.contexts.0.attributes.activities.group.0.assignedUser")) {
                        assignedUser = AttributeHelper.getFirstAttributeValue(this.workflowInfo.data.contexts[0].attributes.activities.group[0].assignedUser);
                    }

                    //Default enable both
                    if (!_.isEmpty(items)) {
                        for (var i = 0; i < items.length; i++) {
                            items[i].removeAttribute("disabled");
                        }
                    }

                    if (assignedUser && !_.isEmpty(userContext) && !_.isEmpty(items)) {
                        var disableActionName;
                        var user = userContext.user;
                        if (user.lastIndexOf("_user") > 0) {
                            user = user.replace('_user', '');
                        }
                        if (assignedUser.lastIndexOf("_user") > 0) {
                            assignedUser = assignedUser.replace('_user', '');
                        }
                        if (user == assignedUser) {
                            disableActionName = "takeTask";
                        }
                        else {
                            disableActionName = "releaseTask";
                        }

                        for (var i = 0; i < items.length; i++) {
                            if (items[i].data.name == disableActionName) {
                                items[i].setAttribute("disabled", "");
                                break;
                            }
                        }
                    }
                }
            }

            _onActionItemTap(e, detail, sender) {
                //If it is bulk process, then need selected entities list, that should come from consumer
                if (!this.isSingleEntityProcess) {
                    this._currentAction = detail;
                    this.fireBedrockEvent("business-actions-action-click", detail);
                    return;
                }

                this._failedWorkflows = [];
                this._doneWorkflows = [];
                if (!detail) return;

                if (detail.data.eventName.indexOf("context") != -1) {
                    this.fireBedrockEvent("on-context-manage-tap", detail, { ignoreId: true });
                    return;
                }

                if (detail.data.eventName.indexOf("snapshot") != -1) {
                    this.fireBedrockEvent("on-snapshot-view-tap", detail, { ignoreId: true });
                    return;
                }

                if (_.isEmpty(this.workflowInfo)) {
                    this.showErrorToast("Workflow details not available, cannot perform the operation now.");
                    return;
                }

                if (detail.data.eventName == "action-takeTask") {
                    this._currentWorkflowAction = "take";
                }
                if (detail.data.eventName == "action-releaseTask") {
                    this._currentWorkflowAction = "release";
                }
                if (detail.data.eventName == "action-reassignTask") {
                    this._currentWorkflowAction = "reassign";
                }
                
                if (this.workflowInfo && this.workflowInfo.data) {
                    var runningInstances = [];

                    //Note: Here, workflow runtime data would be always in the context of workflow so no need to check for data.attributes
                    var contexts = this.workflowInfo.data && this.workflowInfo.data.contexts ? this.workflowInfo.data.contexts : [];
                    for (var i = 0; i < contexts.length; i++) {
                        var currContextItem = contexts[i];
                        var currContext = currContextItem.context;
                        var currWorkflowName = currContext.workflow;
                        var contextAttrs = currContextItem.attributes;

                        if (currWorkflowName) {
                            var runtimeInstance = {
                                "name": currWorkflowName,
                                "activityName": AttributeHelper.getFirstAttributeValue(contextAttrs.activities.group[0].activityName),
                                "activityAssignedUser": AttributeHelper.getFirstAttributeValue(contextAttrs.activities.group[0].assignedUser)
                            };
                            runningInstances.push(runtimeInstance);
                        }
                    }

                    if (runningInstances.length > 0) {
                        this.set("_runningInstances", runningInstances);
                        var itemContext = this.getFirstItemContext();

                        const sharedData = {
                            "selected-entities": DataHelper.cloneObject(this.getItemContexts()),
                            "workflow-info":runningInstances,
                            "assignment-action": this._currentWorkflowAction,
                            "is-single-entity-process": this.isSingleEntityProcess
                        };
                        var dialogTitle = this._getTitleByAction(this._currentWorkflowAction);
                        this.openBusinessFunctionDialog({ name: 'rock-wizard-workflow-assignment', title:dialogTitle }, sharedData); 
                    } else {
                        this.showErrorToast("Entity is not available in any workflow.");
                    }
                }
            }

            _getEntityObject() {
                var itemCtx = ContextHelper.getFirstItemContext(this.contextData);
                var entity = {
                    "id": itemCtx.id,
                    "type": itemCtx.type
                };
                return entity;
            }

            refresh(invalidateEntityCache = true) {
                if (invalidateEntityCache) {
                    //Invalidate entity cache
                    var entity = this._getEntityObject();
                    LiquidDataObjectUtils.invalidateDataObjectCache(entity);
                }
            }

            reloadComponent() {
                this._onContextDataChange();
            }
        }
        customElements.define(RockBusinessActions.is, RockBusinessActions);
    </script>
</dom-module>