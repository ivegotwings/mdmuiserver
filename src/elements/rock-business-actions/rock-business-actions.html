<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
@group rock Elements
@element rock-business-actions
@demo demo/index.html
-->
<dom-module id="rock-business-actions">
    <template>
        <style include="bedrock-style-common"></style>
        <style>
        </style>
        <pebble-actions id="actionsButton" button-icon="[[buttonIcon]]" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
            button-text="[[buttonText]]" actions-data="[[businessActions]]">
        </pebble-actions>
        <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
        <liquid-entity-model-get id="entityGetWorkflowDefinition" operation="getbyids" request-id="req1" request-data={{workflowDefinitionRequest}}
            on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <liquid-rest id="entityWfAssignment" url="/data/pass-through/entitygovernservice/workflowChangeAssignment" method="POST"
            request-data={{_wfAssignmentRequest}} on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
    </template>
    <script>
        class RockBusinessActions
            extends Polymer.mixinBehaviors([
                RUFBehaviors.AppBehavior,
                RUFBehaviors.ComponentContextBehavior, 
                RUFBehaviors.ComponentConfigBehavior
            ], Polymer.Element) {
            static get is() { return 'rock-business-actions' }
            ready() {
                super.ready();
            }
            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },
                    showWorkflowActions: {
                        type: Boolean,
                        value: false
                    },
                    businessActions: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    buttonText: {
                        type: String,
                        value: "Actions"
                    },
                    buttonIcon: {
                        type: String,
                        value: "pebble-icon:action-take-task"
                    },
                    isSingleEntityProcess: {
                        type: Boolean,
                        value: false
                    },
                    workflowDefinitionRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _wfAssignmentRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    businessActionsConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _runningInstances: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _foundWorkflowNames: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _currentWorkflowAction: {
                        type: String
                    },
                    _failedWorkflows: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _doneWorkflows: {
                        type: Array,
                        value: function () { return []; }
                    },
                    workflowInfo: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: "_onWorkflowInfoChange"
                    }
                }
            }
            static get observers() {
                return []
            }
            /**
            *
            */
            connectedCallback() {
                super.connectedCallback();
            }
            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }

            _onContextDataChange() {
                if (!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if (appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }

                    this.requestConfig('rock-business-actions', context);
                }
            }

            onConfigLoaded(componentConfig) {
                if (componentConfig && componentConfig.config) {
                    var actionGroups = [];

                    if (componentConfig.config.actionGroups) {
                        for (var key in componentConfig.config.actionGroups) {
                            var group = componentConfig.config.actionGroups[key];

                            if (!this.showWorkflowActions && group.isWorkflowActions) {
                                continue;
                            }

                            group.actions = DataHelper.convertObjectToArray(group.actions);
                            actionGroups.push(group);
                        }

                        this.businessActions = actionGroups;
                    }
                }
            }

            _onWorkflowInfoChange() {
                if (this.isSingleEntityProcess && !_.isEmpty(this.workflowInfo)) {
                    this._toggleActionItems();
                }
            }

            triggerProcess(selectedDetails, workflowCriterion) {
                if (!this._currentAction || !this._currentAction.data) return;

                const { eventName, componentName, subComponentName } = this._currentAction.data;

                if (!eventName) {
                    this.showErrorToast("Unknown action triggered, system cannot do the process.");
                    return;
                }

                const { selectedItems, selectionMode, selectionQuery } = selectedDetails;
                
                this._workflowCriterion = workflowCriterion || {};

                const asyncAvailable = eventName == "action-takeTask" || eventName == "action-releaseTask" || eventName == "action-wfTransitions";

                if (!asyncAvailable || (asyncAvailable && selectionMode == "count")) {
                    if (DataHelper.isEmptyObject(selectedItems)) {
                        this.showErrorToast(
                            "Select atleast one entity for which you want to perform this action."
                        );
                        return;
                    }
                }

                if (asyncAvailable) {
                    if (selectionMode == "query" && DataHelper.isEmptyObject(selectionQuery)) {
                        this.showErrorToast(
                            "Selection query should be available for which you want to perform this action."
                        );
                        return;
                    }
                }else if (!DataHelper.isEmptyObject(selectedItems) && (selectedItems.length > 20)) {
                    this.showErrorToast("Maximum 20 entities can be selected.");
                    return;
                }

                if (!DataHelper.isEmptyObject(selectedItems)) {
                    this._selectedItems = selectedItems;
                }

                let detail = null;
                let sharedData = null;

                switch(eventName) {
                    case 'action-takeTask':
                        return this._showAssignmentDialog(this._currentAction, "take", selectionMode, selectionQuery);
                    case 'action-releaseTask':
                        return this._showAssignmentDialog(this._currentAction, "release", selectionMode, selectionQuery);
                    case 'action-compare-entities':
                        return this._compareEntities();
                    case 'action-wfTransitions':
                        //Fetch the wf details from the URL
                        const { 
                            userId,
                            workflowName,
                            wfActivityName, 
                            workflowActivityName, 
                            workflowActivityExternalName
                        } = this._workflowCriterion;

                        detail = {
                            name: componentName,
                            mergeTitle: true,
                            title: workflowActivityExternalName
                        };
                        
                        sharedData = {
                            "selection-mode": selectionMode,
                            "selection-query": selectionQuery,
                            "selected-entities": this._selectedItems,
                            "current-workflow": {
                                "name": workflowName,
                                "activityName": workflowActivityName
                            }
                        };
                        break;
                    case 'action-rollup':
                        detail = {
                            name: componentName,
                            subName: subComponentName
                        };

                        sharedData = {"selected-entities": this._selectedItems};
                        break;
                    case 'action-re-publish':
                        detail = {
                            name: componentName,
                            subName: subComponentName
                        };

                        sharedData = { "selected-entities": this._selectedItems, "selection-mode": selectionMode};
                        break;
                    case 'action-add-context':
                        var properties = this._currentAction.data.properties;
                        var entityTypeManager = EntityTypeManager.getInstance();
                        var allowedTypesExtenalNamesList = properties.allowedEntityTypes.map(function(entityType){
                            return entityTypeManager.getTypeExternalNameById(entityType) || entityType;
                        })
                        if(!this._isSelectedItemsAllowed(properties.allowedEntityTypes)) {
                            this.showErrorToast("Only " + allowedTypesExtenalNamesList.join(", ")  + " entities can be reclassified, please try again.");
                            return;
                        }

                        detail = {
                            name: componentName,
                            subName: subComponentName
                        };
                        sharedData = { "selected-entities": this._selectedItems, "selection-mode": selectionMode, "taxonomy": properties.context.taxonomy };
                        break;
                    default:
                        this.showErrorToast("Not implemented, please contact administrator.");
                        break;
                }

                this.openBusinessFunctionDialog(detail, sharedData);
            }

            _isSelectedItemsAllowed(allowedEntityTypes) {
                var allowed = true;
                for(var entityIdx = 0; entityIdx < this._selectedItems.length; entityIdx++) {
                    if(this._selectedItems[entityIdx] && allowedEntityTypes.indexOf(this._selectedItems[entityIdx].type) == -1) {
                        allowed = false;
                        break;
                    }
                }

                return allowed;
            }

            _compareEntities() {
                var mainApp = RUFUtilities.mainApp;
                var dataRoute = this._currentAction.data.dataRoute;
                var entityIds = [];
                var entityTypes = [];

                this._selectedItems.forEach(function (selectedItem) {
                    entityIds.push(selectedItem.id);

                    if (entityTypes.indexOf(selectedItem.type) < 0) {
                        entityTypes.push(selectedItem.type);
                    }
                });

                var compareEntitiesContextId = ElementHelper.getRandomId();
                var compareEntititesContextData = {
                    "entityIds": entityIds,
                    "entityTypes": entityTypes,
                    "contextData": this.contextData
                }

                sessionStorage.setItem(compareEntitiesContextId, JSON.stringify(compareEntititesContextData));
                ComponentHelper.setQueryParamsWithoutEncode({ "compareEntitiesContextId": compareEntitiesContextId });
                mainApp.changePageRoutePath(dataRoute);
            }

            _showAssignmentDialog(detail, action, selectionMode, selectionQuery) {
                const { 
                    workflowName, 
                    workflowShortName, 
                    workflowActivityName,
                    workflowActivityExternalName
                } = this._workflowCriterion;
                
                const sharedData = {
                    "selection-mode": selectionMode,
                    "selection-query": selectionQuery,
                    "selected-entities": this._selectedItems,
                    "assignment-Action": action,
                    "workflow-external-name": workflowName,
                    "workflow-activity-external-name": workflowActivityExternalName,
                    "workflow-name": workflowShortName,
                    "workflow-activity-name": workflowActivityName
                };

                this.openBusinessFunctionDialog({name: detail.data.componentName}, sharedData);
            }

            _toggleActionItems() {
                var assignmentActions = this.shadowRoot.querySelector("#actionsButton");
                if (assignmentActions) {
                    var items = assignmentActions.getActionItems();
                    var userContext = ContextHelper.getFirstUserContext(this.contextData);
                    var assignedUser;

                    if (DataHelper.isValidObjectPath(this.workflowInfo, "data.contexts.0.attributes.activities.group.0.assignedUser")) {
                        assignedUser = AttributeHelper.getFirstAttributeValue(this.workflowInfo.data.contexts[0].attributes.activities.group[0].assignedUser);
                    }

                    //Default enable both
                    if (!_.isEmpty(items)) {
                        for (var i = 0; i < items.length; i++) {
                            items[i].removeAttribute("disabled");
                        }
                    }

                    if (assignedUser && !_.isEmpty(userContext) && !_.isEmpty(items)) {
                        var disableActionName;
                        var user = userContext.user;
                        if (user.lastIndexOf("_user") > 0) {
                            user = user.replace('_user', '');
                        }
                        if (assignedUser.lastIndexOf("_user") > 0) {
                            assignedUser = assignedUser.replace('_user', '');
                        }
                        if (user == assignedUser) {
                            disableActionName = "takeTask";
                        }
                        else {
                            disableActionName = "releaseTask";
                        }

                        for (var i = 0; i < items.length; i++) {
                            if (items[i].data.name == disableActionName) {
                                items[i].setAttribute("disabled", "");
                                break;
                            }
                        }
                    }
                }
            }

            _onActionItemTap(e, detail, sender) {
                //If it is bulk process, then need selected entities list, that should come from consumer
                if (!this.isSingleEntityProcess) {
                    this._currentAction = detail;
                    this.fireBedrockEvent("business-actions-action-click", detail);
                    return;
                }

                this._failedWorkflows = [];
                this._doneWorkflows = [];
                if (!detail) return;

                if (detail.data.eventName.indexOf("context") != -1) {
                    this.fireBedrockEvent("on-context-manage-tap", detail, { ignoreId: true });
                    return;
                }

                if (_.isEmpty(this.workflowInfo)) {
                    this.showErrorToast("Workflow details not available, cannot perform the operation now.");
                    return;
                }

                if (detail.data.eventName == "action-takeTask") {
                    this._currentWorkflowAction = "take";
                }
                if (detail.data.eventName == "action-releaseTask") {
                    this._currentWorkflowAction = "release";
                }

                if (this.workflowInfo && this.workflowInfo.data) {
                    var foundWorkflowNames = [];
                    var runningInstances = [];

                    //Note: Here, workflow runtime data would be always in the context of workflow so no need to check for data.attributes
                    var contexts = this.workflowInfo.data && this.workflowInfo.data.contexts ? this.workflowInfo.data.contexts : [];

                    for (var i = 0; i < contexts.length; i++) {
                        var currContextItem = contexts[i];
                        var currContext = currContextItem.context;
                        var currWorkflowName = currContext.workflow;
                        var contextAttrs = currContextItem.attributes;

                        if (currWorkflowName) {
                            var runtimeInstance = {
                                "name": currWorkflowName,
                                "activityName": AttributeHelper.getFirstAttributeValue(contexts[i].attributes.activities.group[0].activityName)
                            };

                            runningInstances[currWorkflowName] = {};
                            runningInstances[currWorkflowName] = runtimeInstance;
                            foundWorkflowNames.push(currWorkflowName);
                        }
                    }
                    if (foundWorkflowNames.length > 0) {
                        this.set("_runningInstances", runningInstances);
                        this.set("_foundWorkflowNames", foundWorkflowNames);
                        var itemContext = this.getFirstItemContext();
                        itemContext.workflowNames = foundWorkflowNames;

                        this.workflowDefinitionRequest = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                        this.shadowRoot.querySelector("#entityGetWorkflowDefinition").generateRequest();
                    } else {
                        this.showErrorToast("Entity is not available in any workflow.");
                    }
                }
            }

            _onDefinitionReceived(e) {
                var workflowDefinitionResponse = e.detail.response;
                if (workflowDefinitionResponse && workflowDefinitionResponse.content && workflowDefinitionResponse.content.entityModels && workflowDefinitionResponse.content.entityModels.length > 0) {
                    var workflowData = [];

                    for (var i = 0; i < workflowDefinitionResponse.content.entityModels.length; i++) {
                        var entityModel = workflowDefinitionResponse.content.entityModels[i];
                        var workflowName = entityModel.name;

                        if (entityModel.data && entityModel.data.attributes) {
                            var wfAttributes = entityModel.data.attributes;
                            this._runningInstances[workflowName]["wfLongName"] = AttributeHelper.getFirstAttributeValue(wfAttributes.workflowName);

                            var workflowActivites = wfAttributes.activities;
                            if (workflowActivites) {
                                var workflowActivitiesGroup = workflowActivites.group;
                                if (workflowActivitiesGroup && workflowActivitiesGroup instanceof Array) {
                                    for (var i = 0; i < workflowActivitiesGroup.length; i++) {
                                        var activityName = AttributeHelper.getFirstAttributeValue(workflowActivitiesGroup[i].activityName);
                                        if (activityName === this._runningInstances[workflowName]["activityName"]) {
                                            this._runningInstances[workflowName]["activityExternalName"] = AttributeHelper.getFirstAttributeValue(workflowActivitiesGroup[i].externalName);
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    this._currentWfIndex = 0;
                    this._generateAssignmentRequest();
                }
            }
            
            _onDefinitionGetFailed(e) {
                Polymer.Base._error('workflow definition get failed with error ', e.detail);
            }

            _generateAssignmentRequest() {
                var entity = this._getEntityObject();
                var runtimeInstance = this._runningInstances[this._foundWorkflowNames[this._currentWfIndex]];
                var wfCriterion = this._getWfCriterion(runtimeInstance);
                if (!_.isEmpty(wfCriterion)) {
                    var req = DataRequestHelper.createWfChangeAssignmentRequest(entity, wfCriterion, this.contextData, this._currentWorkflowAction);

                    //Add hotline flag if hotline is enabled
                    if (DataHelper.isHotlineModeEnabled()) {
                        req.hotline = true;
                    }

                    this.set("_wfAssignmentRequest", req);
                    var liquidWfAssign = this.shadowRoot.querySelector("#entityWfAssignment");
                    if (liquidWfAssign) {
                        liquidWfAssign.generateRequest();
                    }
                }
            }

            _onAssignmentSuccess(e) {
                var response = e.detail.response;
                var entity = this._getEntityObject();
                if (response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                    var statusDetail = response.response.statusDetail;
                    var workflowJson = this._runningInstances[this._foundWorkflowNames[this._currentWfIndex]];
                    if (statusDetail.messages && statusDetail.messages.length > 0) {
                        this._failedWorkflows.push(workflowJson);
                    } else if (statusDetail.message) {
                        this._doneWorkflows.push(workflowJson);
                    }
                }
                this._currentWfIndex++;
                if (this._currentWfIndex < this._foundWorkflowNames.length) {
                    this._generateAssignmentRequest();
                } else if (response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                    var messageObject = this._getMessageObject();
                    this._showToastMessage(messageObject);
                    setTimeout(() => {
                        //this._refreshView();
                        var eventName = "workflow-assignment-complete";
                        var eventDetail = {
                            name: eventName
                        }
                        this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                        this.refresh();
                    }, 5000)
                }
                else {
                    this.showErrorToast("There is a problem with the server.Please try after some time")
                }
            }

            _onAssignmentFailure(e) {
                this.logWarning("WorkFlowAssignmentFailure", "response", JSON.stringify(e.detail));
                this.showErrorToast("Failed to perform the workflow assignment. Please contact administrator.");
            }

            _getWfCriterion(runtimeInstance) {
                var wfCriterion;
                if (runtimeInstance && runtimeInstance.name && runtimeInstance.activityName) {
                    wfCriterion = {
                        "workflowShortName": runtimeInstance.name,
                        "workflowActivityName": runtimeInstance.activityName
                    };
                }
                return wfCriterion;
            }

            _getMessageObject() {
                var entity = this._getEntityObject();
                var entityName;

                entityName = this._messageAttributeValue ? this._messageAttributeValue + " (" + entity.id + ")" : entity.id;
                var messageObject = {
                    "message": "",
                    "type": ""
                };
                var actionDone;
                if (this._currentWorkflowAction == "take") {
                    actionDone = "assigned to";
                }
                if (this._currentWorkflowAction == "release") {
                    actionDone = "released from";
                }
                if (this._foundWorkflowNames.length == this._doneWorkflows.length && this._foundWorkflowNames.length == 1) {
                    var workflowJson = this._doneWorkflows[0];
                    messageObject.message = "The {0} of type {1} selected is in {2} as part of {3} business process has been {4} you.".format(entityName, entity.type, workflowJson.activityExternalName, workflowJson.wfLongName, actionDone);
                    messageObject.type = "success";
                } else if (this._foundWorkflowNames.length == this._failedWorkflows.length && this._foundWorkflowNames.length == 1) {
                    var workflowJson = this._failedWorkflows[0];
                    messageObject.message = "You do not have permission to take an action on this {0}. Workflow name: {1}; Step: {2}. \nPlease contact your administrator.".format(entity.type, workflowJson.activityExternalName, workflowJson.wfLongName);
                    messageObject.type = "error";
                } else if (this._foundWorkflowNames.length == this._doneWorkflows.length) {
                    var message = "The {0} of type {1} selected is in ".format(entityName, entity.type);
                    message = this._buildMessage(this._doneWorkflows, message);
                    message = message + "have been {0} you".format(actionDone);
                    messageObject.message = message;
                    messageObject.type = "success";
                }
                else if (this._foundWorkflowNames.length == this._failedWorkflows.length) {
                    var message = "You do not have permission to take an action on this {1} as part of ".format(entityName, entity.type);
                    message = this._buildMessage(this._failedWorkflows, message);
                    message = message + "as you do not belong to role mapped to the workflow steps in the system. \nPlease contact your administrator.";
                    messageObject.message = message;
                    messageObject.type = "error";
                }
                else {
                    var message1 = "The {0} of type {1} selected is in ".format(entityName, entity.type);
                    message1 = this._buildMessage(this._doneWorkflows, message1);
                    message1 = message1 + "have been {0} you.".format(actionDone) + '<br>';

                    var message2 = "You do not have permission to take an action on this {1} as part of ".format(entityName, entity.type);
                    message2 = this._buildMessage(this._failedWorkflows, message2);
                    message2 = message2 + "as you do not belong to role mapped to the workflow steps in the system. \nPlease contact your administrator.";

                    messageObject.message = message1 + message2;
                    messageObject.type = "success";
                }
                return messageObject;
            }

            _showToastMessage(msgObject) {
                if (msgObject) {
                    if (msgObject.type == "error") {
                        this.showErrorToast(msgObject.message, 10000);
                    } else if (msgObject.type == "success") {
                        this.showSuccessToast(msgObject.message, 10000);
                    }
                }
            }

            _buildMessage(workflows, message) {
                for (var i = 0; i < workflows.length; i++) {
                    message = message + "{0} as part of {1} business process, ".format(workflows[i].activityExternalName, workflows[i].wfLongName)
                }
                return message;
            }

            _getEntityObject() {
                var itemCtx = ContextHelper.getFirstItemContext(this.contextData);
                var entity = {
                    "id": itemCtx.id,
                    "type": itemCtx.type
                };
                return entity;
            }

            refresh(invalidateEntityCache = true) {
                if (invalidateEntityCache) {
                    //Invalidate entity cache
                    var entity = this._getEntityObject();
                    LiquidDataObjectUtils.invalidateDataObjectCache(entity);
                }
            }
        }
        customElements.define(RockBusinessActions.is, RockBusinessActions);
    </script>
</dom-module>