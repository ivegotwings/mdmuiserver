<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-context-mappings-grid">
    <template>
        <style include="bedrock-style-common">
            :host {
                --paper-input-container: {
                    bottom: 8px;
                    position: relative;
                }
                ;
                --item-length-overflow: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            pebble-popover {
                --pebble-popover-width: 260px;
            }

            pebble-textbox {
                --pebble-textbox-paper-input-style: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            #inputDiv pebble-textbox {
                --pebble-textbox-paper-input-style: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    width: 90%;
                }
            }

            #inputDiv {
                width: 250px;
            }

            .attributes-text .context-text {
                line-height: 56px;
            }

            #iconDiv {
                align-self: flex-end;
                -webkit-align-self: flex-end;
                padding: 0 15px;
                margin-left: -32px;
                cursor: pointer;
                margin-bottom: 10px;
            }

            .actionButton {
                height: 20px;
                width: 20px;
            }

            pebble-data-table {
                height: 340px;
            }

            pebble-data-table data-table-row[header] {
                font-weight: var(--font-bold, bold);
                color: var(--palette-cerulean, #036bc3);
                border-bottom: none;
                text-transform: uppercase;
                font-size: var(--table-head-font-size, 11px);
            }

            pebble-data-table data-table-row:not([header]) {
                color: var(--palette-dark, #1a2028);
                font-size: var(--default-font-size, 12px);
                height: 100%;
                background-color: var(--palette-white, #ffffff);
            }

            pebble-data-table data-table-row:not([header]):hover,
            pebble-data-table data-table-row[selected] {
                background-color: var(--table-row-selected-color, #c1cad4) !important;
            }

            pebble-data-table data-table-row:not([header]):hover data-table-checkbox,
            pebble-data-table data-table-row[selected] data-table-checkbox {
                background-color: var(--palette-white, #ffffff) !important;
            }

            pebble-data-table data-table-checkbox {
                flex-basis: 16px !important;
                padding: 0 !important;
            }

            pebble-data-table data-table-row data-table-cell.check-filter {
                flex: 0 0 16px !important;
                padding: 0!important;
            }

            pebble-data-table data-table-row[header] {
                --pebble-direction-icon-button: {
                    opacity: 0.7 !important;
                }
            }

            pebble-data-table data-table-row data-table-cell {
                padding: 0 0 0 10px!important;
            }

            #gridManage {
                text-align: right;
                font-size: 0;
            }

            #gridManage pebble-icon {
                display: inline-block;
                vertical-align: middle;
            }

            .gridCountMsg {
                font-weight: bold;
                margin-right: 10px;
                font-size: var(--grid-msg-font-size, 12px);
                display: inline-block;
                vertical-align: middle;
            }

            #context-header {
                font-size: 12px;
                padding: 10px;
            }

            rock-dimension-selector {
                --dimension-selector-simple-button: {
                    width: 120px;
                }
            }

            #type-label {
                font-weight: bold;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div id="grid-heading">
            <strong>Context Mappings</strong>
        </div>
        <div id="context-header">
            <span id="type-label">Entity Type: </span> [[entityType]]
        </div>
        <div id="gridManage">
            <span class="gridCountMsg">Showing [[_getGridRecordsCount(_gridData)]] items</span>
            <pebble-icon class="pebble-icon-size-16 tooltip-bottom m-r-10" id="add" icon="pebble-icon:Add" data-tooltip="Add" raised
                on-tap="_onAddTap"></pebble-icon>
            <pebble-icon class="pebble-icon-size-16 tooltip-bottom" id="delete" icon="pebble-icon:Delete" data-tooltip="Delete" raised
                on-tap="_onDeleteTap"></pebble-icon>
        </div>
        <div id="grid-container">
            <pebble-data-table id="mapping-grid" items="{{_gridData}}" multi-selection>
                <data-table-column slot="column-slot" name="Context">
                    <template>
                        <div id="inputContextDiv" slot="cell-slot-content" index="[[index]]">
                            <pebble-textbox readonly class="column-text" id="context_[[index]]" no-label-float row-id="[[index]]" value="{{item.context}}"
                                title="{{item.context}}"></pebble-textbox>
                        </div>
                        <div id="iconContextDiv" slot="cell-slot-content">
                            <pebble-icon class="dropdown-icon pebble-icon-size-10" id="dropdownContextIcon_[[index]]" row-id="[[index]]" icon="pebble-icon:Down"
                                on-tap="_showContextLOV"></pebble-icon>
                        </div>
                    </template>
                </data-table-column>
                <data-table-column slot="column-slot" name="Excel Column">
                    <template>
                        <div id="inputExcelDiv" slot="cell-slot-content" index="[[index]]">
                            <pebble-textbox class="column-text" id="excelColumn_[[index]]" row-id="[[index]]" no-label-float value="[[item.excelColumn]]"
                                title="[[item.excelColumn]]"></pebble-textbox>
                        </div>
                        <div id="iconExcelDiv" slot="cell-slot-content">
                            <pebble-icon class="dropdown-icon pebble-icon-size-10" id="dropdownExcelIcon__[[index]]" row-id="[[index]]" icon="pebble-icon:Down"
                                on-tap="_showExcelLOV"></pebble-icon>
                        </div>
                        <div id="buttonDiv" slot="cell-slot-content">
                            <pebble-icon class="action-button-focus pebble-icon-size-16 tooltip-right m-l-20" data-tooltip="Build Path" icon="pebble-icon:value-mapping"
                                id="btnBuildPath_[[index]]" raised on-tap="_onTapBuildPath" hidden$="[[!item.isPath]]"></pebble-icon>
                        </div>
                    </template>
                </data-table-column>
            </pebble-data-table>
            <pebble-popover class="attributes-popover" id="excelColumnPopover" for="" no-overlap vertical-align="auto" horizontal-align="auto">
                <pebble-lov id="excelColumnLOV" row-id="[[index]]" items="[[gridExcelFields]]" on-selection-changed="_onExcelColumnSelectionChanged"></pebble-lov>
            </pebble-popover>
            <pebble-popover class="attributes-popover" id="contextPopover" for="" no-overlap vertical-align="auto" horizontal-align="auto">
                <pebble-lov id="contextLOV" row-id="[[index]]" items="[[gridContexts]]" on-selection-changed="_onContextSelectionChanged"></pebble-lov>
            </pebble-popover>
        </div>
        <div id="actions-container" class="m-t-20" align="center">
            <pebble-button class="action-button btn btn-secondary m-r-5" id="cancel" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
            <pebble-button class="action-button btn btn-primary m-r-5" id="cancel" button-text="Skip" raised on-tap="_onSkipTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>

        <!-- Context get -->
        <liquid-rest id="contextModelGet" url="/data/pass-through/entitymodelservice/getcontext" method="POST" request-data="{{_contextModelGetReq}}"
            on-liquid-response="_onContextModelGetResponse" on-liquid-error="_onContextModelGetFailed"></liquid-rest>
        <liquid-entity-data-get id="initiateEntitySearch" operation="initiatesearch" request-data="{{entityGetrequest}}" last-response="{{initiateSearchResponse}}"
            on-error="_onGetSearchError" on-response="_onInitiateEntitySearchResponse" exclude-in-progress></liquid-entity-data-get>
        <liquid-entity-data-get id="getEntitySearchResultDetail" operation="getsearchresultdetail" request-data="{{entityGetrequest}}"
            request-id="[[initiateSearchResponse.content.requestId]]" last-response="{{getEntitySearchResultsResponse}}" on-error="_onGetSearchError"
            on-response="_onGetEntitySearchResultDetailResponse" exclude-in-progress></liquid-entity-data-get>

        <!-- Mappings get/save -->
        <liquid-rest id="getMappings" url="/data/cop/getMappings" method="POST" request-data="[[_getMappingsRequest]]" on-liquid-response="_onGetMappingsResponse"
            on-liquid-error="_onMappingsError"></liquid-rest>
        <liquid-rest id="saveMappings" url="/data/cop/saveMappings" method="POST" on-liquid-response="_onMappingsSaveResponse" on-liquid-error="_onMappingsError"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-context-mappings-grid",

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    copContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    mappingsRequestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    mappingConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    entityGetrequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    contexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    taxonomies: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    gridExcelFields: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    gridContexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },
                observers: [
                    "_onMappingsDataChange(mappingsRequestData, contextData, copContext)"
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                _onMappingsDataChange: function () {
                    if (!_.isEmpty(this.contextData) && !_.isEmpty(this.mappingsRequestData) && !_.isEmpty(this.copContext)) {
                        var itemContext = ContextHelper.getFirstItemContext(this.contextData);
                        if (itemContext) {
                            this.entityType = itemContext.type;
                            this._contextModelGetReq = DataRequestHelper.createContextModelGetRequest(itemContext.type);

                            var liquidElement = this.$$('#contextModelGet');
                            if (liquidElement) {
                                liquidElement.generateRequest();
                            }
                        }
                    }
                },

                _onContextModelGetResponse: function (e) {
                    var response = e.detail.response.response;

                    if (response) {
                        var entityModels = response.entityModels;

                        if (entityModels && entityModels.length) {
                            var contexts = entityModels[0].data ? entityModels[0].data.contexts : undefined;
                            var _ctxKeys = [];

                            if (contexts) {
                                var _contexts = [];
                                contexts.forEach(function (context) {
                                    _contexts.push(context.context);

                                    var ctxKeys = Object.keys(context.context);
                                    if (ctxKeys && ctxKeys.length) {
                                        ctxKeys.forEach(function (ctxKey) {
                                            if (_ctxKeys.indexOf(ctxKey) < 0) {
                                                _ctxKeys.push(ctxKey);
                                            }
                                        }, this);
                                    }
                                }, this);

                                this._contexts = _contexts;
                            }

                            var _ctxIds = [];
                            if (_ctxKeys && _ctxKeys.length) {
                                _ctxKeys.forEach(function (item) {
                                    if (item) {
                                        _ctxIds.push(item);
                                    }
                                }, this);
                            }

                            this.contexts = _ctxIds;

                            //Fetch taxonomy type entities
                            var contextData = DataHelper.cloneObject(this.contextData);
                            var firstItemContext = ContextHelper.getFirstItemContext(contextData);
                            if (firstItemContext) {
                                firstItemContext.type = "taxonomy";
                                firstItemContext.attributeNames = ["_ALL"];
                                var req = DataRequestHelper.createEntityGetRequest(contextData);
                                delete req.params.options;
                                this.entityGetrequest = req;

                                //Trigger request
                                var taxonomyGetElement = this.$$("#initiateEntitySearch");
                                if (taxonomyGetElement) {
                                    taxonomyGetElement.generateRequest();
                                }
                            }
                        }
                    }
                },

                _onContextModelGetFailed: function (e, detail) {
                    this.logError("Context get error", detail);
                    this.showSuccessToast("Unable to get context details, please contact administrator.");
                },

                _onInitiateEntitySearchResponse: function (e, detail) {
                    if (detail && detail.response && detail.response.status == "success") {
                        var taxonomyGetElement = this.$$("#getEntitySearchResultDetail");
                        if (taxonomyGetElement) {
                            taxonomyGetElement.generateRequest();
                        }
                    } else {
                        this._raiseTaxonomyError(detail);
                    }
                },

                _onGetEntitySearchResultDetailResponse: function (e, detail) {
                    if (detail && detail.response && detail.response.status == "success") {
                        var response = detail.response;
                        if (response.content && response.content.entities && response.content.entities.length) {
                            this.taxonomies = detail.response.content.entities;
                        }

                        //Fetch context mappings now
                        //this._getMappings();
                        this._prepareGridData();
                    } else {
                        this._raiseTaxonomyError(detail);
                    }
                },

                _getMappings: function () {
                    var selectedContexts = [{
                        "type": "entitytype",
                        "value": this.entityType
                    }];
                    var types = ["contextmapping"];
                    var req = DataRequestHelper.createMappingsGetRequest(this.contextData, this.copContext, selectedContexts, types);
                    req.params.rsconnect.headers.entities = this.mappingsRequestData.headerFields;
                    req.params.query.contexts[0].ownershipdata = this.ownershipdata && this.ownershipdata != "undefined" ? this.ownershipdata : "";
                    this.set("_getMappingsRequest", req);
                    var getMappings = this.shadowRoot.querySelector("#getMappings");
                    if (getMappings) {
                        getMappings.generateRequest();
                    }
                },

                _onGetMappingsResponse: function (e, detail) {
                    if ( !DataHelper.isValidObjectPath(detail, "response.response.status") || 
                          detail.response.response.status.toLowerCase() != "success") {
                        this.showErrorToast("Unable to fetch context mappings, please contact administrator.");
                        return;
                    }

                    var response = detail.response.response;
                    if (response.entities) {
                        if (response.entities.length > 0 && DataHelper.isValidObjectPath(response, "entities.0.data.contexts.0.attributes")) {
                            this._mappingAttributes = response.entities[0].data.contexts[0].attributes;
                        }
                    }
                },

                _onGetSearchError: function (e, detail) {
                    this._raiseTaxonomyError(detail);
                },

                _raiseTaxonomyError: function (detail) {
                    this.logError("Taxonomy entity get error", detail);
                    this.showSuccessToast("Unable to get taxonomy details, please contact administrator.");
                },

                _prepareGridData: function () {
                    var gridData = [];
                    var contexts = [];
                    for (var i = 0; i < this.contexts.length; i++) {
                        var rowData = {
                            "context": this.contexts[i],
                            "excelColumn": "Excel Column",
                            "index": i
                        };
                        this._setBuildPath(rowData);
                        gridData.push(rowData);
                        contexts.push({
                            "id": this.contexts[i],
                            "title": this.contexts[i]
                        });
                    }

                    var excelFields = [];
                    for (var i = 0; i < this.mappingsRequestData.headerFields.length; i++) {
                        excelFields.push({
                            "id": this.mappingsRequestData.headerFields[i],
                            "title": this.mappingsRequestData.headerFields[i]
                        });
                    }

                    this.set("gridExcelFields", excelFields);
                    this.set("gridContexts", contexts);
                    this.set("_gridData", gridData);
                },

                _setBuildPath: function (rowData, rowId) {
                    var pathFields = this.mappingConfig["path-fields"];
                    if (pathFields && pathFields.indexOf(rowData.context.toLowerCase()) != -1) {
                        rowData.isPath = true;
                    } else {
                        rowData.isPath = false;
                    }

                    if (rowId >= 0) {
                        var btnBuildPath = this.root.querySelector("#btnBuildPath_" + rowId);
                        if (btnBuildPath) {
                            if (rowData.isPath) {
                                btnBuildPath.removeAttribute("hidden");
                            } else {
                                btnBuildPath.setAttribute("hidden", "");
                            }
                        }
                    }
                },

                _showExcelLOV: function (e) {
                    var id = "excelColumn";
                    this._showLOV(e, id);
                },

                _showContextLOV: function (e) {
                    var id = "context";
                    this._showLOV(e, id);
                },

                _showLOV: function (e, id) {
                    var rowId = e.currentTarget.rowId;
                    if (rowId >= 0) {
                        var lov = this.shadowRoot.querySelector("#" + id + "LOV");
                        var popover = this.shadowRoot.querySelector("#" + id + "Popover");
                        if (lov && popover) {
                            lov.currentRowId = rowId;
                            popover.for = id + "_" + rowId;
                            popover.show();
                            lov.clear();
                        }
                    }
                },

                _onExcelColumnSelectionChanged: function (e, detail) {
                    var id = "excelColumn";
                    this._onLOVSelectionChanged(detail, id);
                },

                _onContextSelectionChanged: function (e, detail) {
                    var id = "context";
                    this._onLOVSelectionChanged(detail, id);
                },

                _onLOVSelectionChanged: function (detail, id) {
                    var lovId = "#" + id + "LOV";
                    var popoverId = "#" + id + "Popover";
                    var txtId = "#" + id;

                    var popover = this.shadowRoot.querySelector(popoverId);
                    popover.for = "";
                    popover.hide();

                    var lov = this.shadowRoot.querySelector(lovId);
                    if (lov) {
                        var rowId = lov.currentRowId;
                        if (rowId >= 0) {
                            var columnTxtbox = this.root.querySelector(txtId + "_" + rowId);
                            if (!columnTxtbox) {
                                columnTxtbox = this.shadowRoot.querySelector(txtId + "_" + rowId);
                            }
                            if (columnTxtbox) {
                                var row = this._getParentRow(columnTxtbox);
                                if (row) {
                                    //Set row context on selection change
                                    if (id == "context") {
                                        row.item.context = detail.item.title;
                                        this._setBuildPath(row.item, rowId);
                                    }
                                    columnTxtbox.value = detail.item.title;
                                    columnTxtbox.title = detail.item.title;
                                }
                            }
                        }
                    }
                },

                _getParentRow: function (element) {
                    if (element) {
                        if (element.is == "data-table-row") {
                            return element;
                        } else {
                            return this._getParentRow(element.parentNode);
                        }
                    }
                    return undefined;
                },

                _onCancelTap: function (e) {
                    var eventName = "context-mapping-cancel";
                    var eventDetail = {
                        "name": eventName,
                    };
                    this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                },

                _onSkipTap: function (e) {
                    var eventName = "context-mapping-skip";
                    var eventDetail = {
                        "name": eventName,
                    };
                    this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                },

                _onAddTap: function () {
                    this.push("_gridData", {
                        "context": "",
                        "excelColumn": "",
                        "index": this._gridData.length
                    });

                    //Notify Grid data
                    var temp = this._gridData;
                    this._gridData = [];
                    this._gridData = temp;
                },

                _onDeleteTap: function () {
                    var grid = this.shadowRoot.querySelector("#mapping-grid");
                    if (grid) {
                        var selectedItems = grid.getSelectedItems();
                        if (selectedItems.length == 0) {
                            //Show message if needed - Please select an item for delete
                            return;
                        }
                        var gridData = [];
                        for (var i = 0; i < this._gridData.length; i++) {
                            var isDelete = false;
                            for (var j = 0; j < selectedItems.length; j++) {
                                if (this._gridData[i].context.toLowerCase() == selectedItems[j].context.toLowerCase() &&
                                    this._gridData[i].index == selectedItems[j].index) {
                                    isDelete = true;
                                    break;
                                }
                            }

                            if (!isDelete) {
                                gridData.push(this._gridData[i]);
                            }
                        }

                        //Reset row index
                        for (var i = 0; i < gridData.length; i++) {
                            gridData[i].index = i;
                        }

                        this.set("_gridData", gridData);
                    }
                },

                _getGridRecordsCount: function() {
                    if(!this._gridData) {
                        return 0;
                    }

                    return this._gridData.length;
                }
            });
        })();
    </script>
</dom-module>