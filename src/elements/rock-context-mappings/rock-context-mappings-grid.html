<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-mapping-grid-behavior/bedrock-mapping-grid-behavior.html">

<link rel="import" href="../rock-context-mappings/rock-context-path-builder.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-context-mappings-grid">
    <template>
        <style include="bedrock-style-common">
            :host {
                display: block;
                height: 100%;
                --paper-input-container: {
                    bottom: 8px;
                    position: relative;
                }
                ;
                --item-length-overflow: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            pebble-popover {
                --pebble-popover-width: 260px;
            }

            pebble-textbox {
                --pebble-textbox-paper-input-style: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            pebble-data-table data-table-row[header] {
                font-weight: var(--font-bold, bold);
                color: var(--palette-cerulean, #036bc3);
                border-bottom: none;
                text-transform: uppercase;
                font-size: var(--table-head-font-size, 11px);
            }

            pebble-data-table data-table-row:not([header]) {
                color: var(--palette-dark, #1a2028);
                font-size: var(--default-font-size, 12px);
                height: 100%;
                background-color: var(--palette-white, #ffffff);
            }

            pebble-data-table data-table-row:not([header]):hover,
            pebble-data-table data-table-row[selected] {
                background-color: var(--table-row-selected-color, #c1cad4) !important;
            }

            pebble-data-table data-table-row:not([header]):hover data-table-checkbox,
            pebble-data-table data-table-row[selected] data-table-checkbox {
                background-color: var(--palette-white, #ffffff) !important;
            }

            pebble-data-table data-table-checkbox {
                flex-basis: 16px !important;
                padding: 0 !important;
            }

            pebble-data-table data-table-row data-table-cell.check-filter {
                flex: 0 0 16px !important;
                padding: 0!important;
            }

            pebble-data-table data-table-row[header] {
                --pebble-direction-icon-button: {
                    opacity: 0.7 !important;
                }
            }

            pebble-data-table data-table-row data-table-cell {
                padding: 0 0 0 10px!important;
            }

            #gridManage {
                font-size: 0;
                padding: 10px;
            }

            #gridManage pebble-icon {
                display: inline-block;
                vertical-align: middle;
            }

            .gridCountMsg {
                font-weight: bold;
                margin-right: 10px;
                font-size: var(--grid-msg-font-size, 12px);
                display: inline-block;
                vertical-align: middle;
            }

            .button-siblings {
                height: calc(100% - 50px);
            }

            #context-header {
                font-size: 12px;
                padding: 10px;
            }

            #type-label {
                font-weight: bold;
            }

            pebble-actions {
                text-transform: none;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <div id="grid-heading">
                    <strong>Context Mappings for [[entityTypeExternalName]]</strong>
                </div>
                <div id="gridManage">
                    <span class="gridCountMsg">[[_getGridRecordsCountMessage(_gridData)]]</span>
                    <span class="pull-right">
                        <pebble-icon class="pebble-icon-size-16 tooltip-bottom m-r-10" id="add" icon="pebble-icon:action-add" data-tooltip="Add"
                            raised on-tap="_onAddTap"></pebble-icon>
                        <pebble-icon class="pebble-icon-size-16 tooltip-bottom" id="delete" icon="pebble-icon:action-delete" data-tooltip="Delete"
                            raised on-tap="_onDeleteTap"></pebble-icon>
                    </span>
                </div>
            </div>
            <div class="base-grid-structure-child-2">
                <div id="grid-container" class="button-siblings">
                    <pebble-data-table id="mapping-grid" items="{{_gridData}}" multi-selection>
                        <data-table-column slot="column-slot" name="Context">
                            <template>
                                <div id="inputContextDiv" slot="cell-slot-content" index="[[index]]">
                                    <pebble-textbox readonly class="column-text" id="context_[[index]]" no-label-float row-id="[[index]]" value="{{item.context}}"
                                        title="{{item.context}}"></pebble-textbox>
                                </div>
                                <div id="iconContextDiv" slot="cell-slot-content">
                                    <pebble-icon class="dropdown-icon pebble-icon-size-10" id="dropdownContextIcon_[[index]]" row-id="[[index]]" icon="pebble-icon:navigation-action-down"
                                        on-tap="_showContextLOV"></pebble-icon>
                                </div>
                            </template>
                        </data-table-column>
                        <data-table-column slot="column-slot" name="Excel Column">
                            <template>
                                <div id="inputExcelDiv" slot="cell-slot-content" index="[[index]]">
                                    <pebble-textbox readonly class="column-text" id="excelColumn_[[index]]" row-id="[[index]]" no-label-float value="[[item.excelColumn]]"
                                        title="[[item.excelColumn]]"></pebble-textbox>
                                </div>
                                <div id="iconExcelDiv" slot="cell-slot-content">
                                    <pebble-icon class="dropdown-icon pebble-icon-size-10" id="dropdownExcelIcon__[[index]]" row-id="[[index]]" icon="pebble-icon:navigation-action-down"
                                        on-tap="_showExcelLOV"></pebble-icon>
                                </div>
                                <div id="buttonDiv" slot="cell-slot-content">
                                    <pebble-icon class="action-button-focus pebble-icon-size-16 tooltip-right m-l-20" data-tooltip="Build Path" icon="pebble-icon:build-path"
                                        id="btnBuildPath_[[index]]" row-id="[[index]]" raised on-tap="_onTapBuildPath" hidden$="[[!item.isPath]]"></pebble-icon>
                                </div>
                            </template>
                        </data-table-column>
                    </pebble-data-table>
                    <pebble-popover class="attributes-popover" id="excelColumnPopover" for="" no-overlap vertical-align="auto" horizontal-align="auto">
                        <pebble-lov id="excelColumnLOV" row-id="[[index]]" items="[[gridExcelFields]]" on-selection-changed="_onExcelColumnSelectionChanged"></pebble-lov>
                    </pebble-popover>
                    <pebble-popover class="attributes-popover" id="contextPopover" for="" no-overlap vertical-align="auto" horizontal-align="auto">
                        <pebble-lov id="contextLOV" row-id="[[index]]" items="[[gridContexts]]" on-selection-changed="_onContextSelectionChanged"></pebble-lov>
                    </pebble-popover>
                </div>
                <div id="actions-container" class="m-t-10" align="center">
                    <pebble-button class="action-button btn btn-secondary m-r-10" id="back" button-text="Back" raised on-tap="_onBackTap"></pebble-button>
                    <pebble-button class="action-button btn btn-primary m-r-10" id="skip" button-text="Skip" raised on-tap="_onSkipTap"></pebble-button>
                    <pebble-button class="action-button btn dropdown-success m-r-10" id="saveandcontinue" button-text="Save & Continue" raised on-tap="_onSaveTap"></pebble-button>
                </div>
            </div>
        </div>

        <!--Dirty check dialog-->
        <pebble-dialog id="context-mappings-dirty-check-Dialog" dialog-title="Confirmation" modal alert-box show-cancel show-ok no-cancel-on-outside-click
            no-cancel-on-esc-key>
            <p>[[_dirtyCheckConfirmationMessage]]</p>
        </pebble-dialog>
        <bedrock-pubsub event-name="on-buttonok-clicked" handler="_discardContextChanges" target-id="context-mappings-dirty-check-Dialog"></bedrock-pubsub>

        <!-- Build path dialog -->
        <pebble-dialog id="buildPathDialog" dialog-title="CONTEXT PATH SELECTION" modal show-close-icon no-cancel-on-outside-click
            no-cancel-on-esc-key>
            <rock-context-path-builder id="contextPathBuilder"></rock-context-path-builder>
        </pebble-dialog>

        <!-- Build Path events -->
        <bedrock-pubsub event-name="context-build-path-cancel" handler="_onCancelBuildPath" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="context-build-path-select" handler="_onSelectBuildPath" target-id=""></bedrock-pubsub>

        <!-- Mappings get/save -->
        <liquid-rest id="getMappings" url="/data/cop/getMappings" method="POST" request-data="[[_getMappingsRequest]]" on-liquid-response="_onGetMappingsResponse"
            on-liquid-error="_onMappingsError"></liquid-rest>
        <liquid-rest id="saveMappings" url="/data/cop/saveMappings" method="POST" request-data="[[_saveMappingsRequest]]" on-liquid-response="_onMappingsSaveResponse"
            on-liquid-error="_onMappingsError"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-context-mappings-grid",

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    businessFunctionData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    copContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    mappingConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    mappingData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    entityGetrequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    contexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    taxonomies: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    gridExcelFields: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    gridContexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _mappingAttributes: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _contextPathFields: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    domain: {
                        type: String,
                        value: "thing"
                    },

                    copFormat: {
                        type: String,
                        value: "Excel"
                    },

                    taxonomy: {
                        type: String,
                        value: ""
                    },

                    selectedOptions: {
                        type: Object,
                        value: function () {
                            return { "role": "_DEFAULT", "ownershipData": "_DEFAULT", "saveType": "self" }
                        }
                    }
                },
                observers: [
                    "_onMappingsDataChange(mappingConfig, businessFunctionData, contextData, copContext)"
                ],
                behaviors: [
                    RUFBehaviors.MappingGridBehavior
                ],

                _onMappingsDataChange: async function () {
                    if(!_.isEmpty(this.businessFunctionData) && this.businessFunctionData["context-mapping-data"]) {
                        this.mappingData = this.businessFunctionData["context-mapping-data"];
                    }

                    if (!_.isEmpty(this.contextData) && !_.isEmpty(this.mappingData) && !_.isEmpty(this.mappingConfig) && !_.isEmpty(this.copContext)) {
                        this._loading = true;
                        var itemContext = ContextHelper.getFirstItemContext(this.contextData);
                        if (itemContext) {
                            this.entityType = itemContext.type;
                            this.contexts = this.mappingData.contexts;
                            this.taxonomies = this.mappingData.taxonomies;
                            this.taxonomy = this.mappingData.taxonomy;
                            this.domain = this.mappingData.domain;
                            this.entityTypeExternalName = this.mappingData.entityTypeExternalName;
                            this.contextExternalNames = this.mappingData.contextExternalNames;
                            this.fileFormat = this.mappingData.fileFormat;
                            this.selectedOptions = this.mappingData.selectedOptions;
                            //Fetch context mappings now
                            this._getMappings();
                        }
                    }
                },

                _getMappings: function () {
                    var selectedContexts = [{
                        "type": "entitytype",
                        "value": this.entityType
                    }];
                    var types = ["contextmapping"];
                    var req = DataRequestHelper.createMappingsGetRequest(this.contextData, this.copContext, selectedContexts, types, this.selectedOptions);
                    req.params.rsconnect.headers.entities = this.mappingData.headerFields;
                    req.params.query.contexts[0].ownershipdata = this.selectedOptions.ownershipData;
                    this.set("_getMappingsRequest", req);
                    var getMappings = this.shadowRoot.querySelector("#getMappings");
                    if (getMappings) {
                        getMappings.generateRequest();
                    }
                },

                _onGetMappingsResponse: function (e, detail) {
                    if (!DataHelper.isValidObjectPath(detail, "response.response.status") ||
                        detail.response.response.status.toLowerCase() != "success") {
                        this.showErrorToast("Unable to fetch context mappings, please contact administrator.");
                        this._loading = false;
                        return;
                    }

                    var response = detail.response.response;
                    if (response.entities) {
                        if (response.entities.length > 0 && DataHelper.isValidObjectPath(response, "entities.0.data.contexts")) {
                            var contexts = response.entities[0].data.contexts || [];
                            for (var i = 0; i < contexts.length; i++) {
                                for (var key in contexts[i].attributes) {
                                    this._mappingAttributes[key] = contexts[i].attributes[key];
                                }
                            }
                        }
                    }

                    //Prepare grid now
                    this._prepareGridData();
                },

                _prepareGridData: function () {
                    var gridData = [];
                    var contexts = [];
                    for (var i = 0; i < this.contexts.length; i++) {
                        var attributeValue = this._getMappingAttribute(this.contexts[i]);
                        var rowData = {
                            "context": this._getContextExternalName(this.contexts[i]),
                            "excelColumn": attributeValue,
                            "index": i
                        };
                        this._setBuildPath(rowData);
                        gridData.push(rowData);
                        contexts.push({
                            "id": this.contexts[i],
                            "title": this._getContextExternalName(this.contexts[i])
                        });
                    }

                    var excelFields = [];
                    for (var i = 0; i < this.mappingData.headerFields.length; i++) {
                        excelFields.push({
                            "id": this.mappingData.headerFields[i],
                            "title": this.mappingData.headerFields[i]
                        });
                    }

                    this.set("gridExcelFields", excelFields);
                    this.set("gridContexts", contexts);
                    this.set("_gridData", gridData);
                    this._loading = false;

                    //Before redirecting to next, set the grid
                    if (this._discardChanges) {
                        this._discardChanges = false;
                        this.async(function () {
                            RUFBehaviors.MappingGridBehaviorImpl._triggerEvent.call(this);
                        }, 500);
                    }
                },

                _getContextExternalName: function (contextName) {
                    return this.contextExternalNames[contextName] || contextName;
                },

                _getContextKeyByExternalName: function (contextExternalName) {
                    for (var key in this.contextExternalNames) {
                        if (this.contextExternalNames[key] == contextExternalName) {
                            return key || contextExternalName;
                        }
                    }
                    return contextExternalName;
                },

                _getMappingAttribute: function (context) {
                    var attributeValue = "";
                    if (this._mappingAttributes && this._mappingAttributes[context] &&
                        this._mappingAttributes[context].values && this._mappingAttributes[context].values.length) {
                        attributeValue = this._mappingAttributes[context].values[0].value || "";
                    }

                    return attributeValue;
                },

                _setBuildPath: function (rowData, rowId) {
                    if (this._contextPathFields && this._contextPathFields.indexOf(rowData.context.toLowerCase()) != -1) {
                        rowData.isPath = true;
                    } else {
                        rowData.isPath = false;
                    }

                    if (rowId >= 0) {
                        var btnBuildPath = this.root.querySelector("#btnBuildPath_" + rowId);
                        if (btnBuildPath) {
                            if (rowData.isPath) {
                                btnBuildPath.removeAttribute("hidden");
                            } else {
                                btnBuildPath.setAttribute("hidden", "");
                            }
                        }
                    }
                },

                _showExcelLOV: function (e) {
                    var id = "excelColumn";
                    this._showLOV(e, id);
                },

                _showContextLOV: function (e) {
                    var id = "context";
                    this._showLOV(e, id);
                },

                _showLOV: function (e, id) {
                    var rowId = e.currentTarget.rowId;
                    if (rowId >= 0) {
                        var lov = this.shadowRoot.querySelector("#" + id + "LOV");
                        var popover = this.shadowRoot.querySelector("#" + id + "Popover");
                        if (lov && popover) {
                            lov.currentRowId = rowId;
                            popover.for = id + "_" + rowId;
                            popover.show();
                            lov.clear();
                        }
                    }
                },

                _onExcelColumnSelectionChanged: function (e, detail) {
                    var id = "excelColumn";
                    this._onLOVSelectionChanged(detail, id);
                },

                _onContextSelectionChanged: function (e, detail) {
                    var id = "context";
                    this._onLOVSelectionChanged(detail, id);
                },

                _onLOVSelectionChanged: function (detail, id) {
                    var lovId = "#" + id + "LOV";
                    var popoverId = "#" + id + "Popover";
                    var txtId = "#" + id;

                    var popover = this.shadowRoot.querySelector(popoverId);
                    popover.for = "";
                    popover.hide();

                    this._isMappingChanged = true;
                    var lov = this.shadowRoot.querySelector(lovId);
                    if (lov) {
                        var rowId = lov.currentRowId;
                        if (rowId >= 0) {
                            var columnTxtbox = this.root.querySelector(txtId + "_" + rowId);
                            if (!columnTxtbox) {
                                columnTxtbox = this.shadowRoot.querySelector(txtId + "_" + rowId);
                            }
                            if (columnTxtbox) {
                                var row = this._getParentRow(columnTxtbox);
                                if (row) {
                                    //Set row context/excelColumn on selection change
                                    if (id == "context") {
                                        row.item.context = detail.item.title;
                                        this._setBuildPath(row.item, rowId);
                                    } else {
                                        row.item.excelColumn = detail.item.title;
                                    }
                                    columnTxtbox.value = detail.item.title;
                                    columnTxtbox.title = detail.item.title;
                                }
                            }
                        }
                    }
                },

                _getParentRow: function (element) {
                    if (element) {
                        if (element.is == "data-table-row") {
                            return element;
                        } else {
                            return this._getParentRow(element.parentNode);
                        }
                    }
                    return undefined;
                },

                _onBackTap: function (e) {
                    this.currentEventName = "onBack";
                    RUFBehaviors.MappingGridBehaviorImpl._triggerDirtyCheck.call(this, "context");
                },

                _discardContextChanges: function () {
                    this._discardChanges = true;
                    this._prepareGridData(); //Discarded the changes
                },

                _onSkipTap: function (e) {
                    this.currentEventName = "onSkip";
                    this._setAttributeMappingsData();
                    RUFBehaviors.MappingGridBehaviorImpl._triggerDirtyCheck.call(this, "context");
                },

                _onSaveTap: function (e) {
                    if (this._isDuplicateGridDataAvailable()) {
                        this.showErrorToast("Please provide unique contexts.");
                        return;
                    }

                    this._loading = true;
                    var mappings = this._transformGridDataToSaveMappings();

                    if (!_.isEmpty(mappings)) {
                        var selectedContexts = [{
                            "type": "entitytype",
                            "value": this.entityType
                        }];

                        var saveRequest = DataRequestHelper.createMappingsSaveRequest(this.contextData, this.copContext, selectedContexts, "contextmapping", this.selectedOptions);
                        if (!_.isEmpty(saveRequest)) {
                            saveRequest.entity.data.contexts[0].attributes = mappings;
                            saveRequest.entity.data.contexts[0].context.ownershipdata = this.selectedOptions.ownershipData;
                            saveRequest.entity.data.contexts[0].context.format = this.fileFormat;
                            this.set("_saveMappingsRequest", saveRequest);
                            var saveMappings = this.shadowRoot.querySelector("#saveMappings");
                            if (saveMappings) {
                                saveMappings.generateRequest();
                            }
                        }
                    } else {
                        this.showSuccessToast("There are no changes in mappings to save.");
                        this._loading = false;
                    }
                },

                _onMappingsSaveResponse: function (e, detail) {
                    var response = detail && detail.response && detail.response.response ? detail.response.response : "";
                    if (response && response.status == "success") {
                        this.showSuccessToast("Context mappings saved successfully.");
                        //Trigger event to goto next step
                        this._setAttributeMappingsData(true);
                        var eventName = "onNext";
                        var eventDetail = {
                            name: eventName,
                            data: {}
                        }
                        this.fireBedrockEvent(eventName, eventDetail, {
                            ignoreId: true
                        });
                        this._loading = false;
                        this._isMappingChanged = false;
                        return;
                    }

                    this._loading = false;
                    this.showErrorToast("Unable to save context mappings, please contact administrator.");
                },

                _onMappingsError: function (e, detail) {
                    this.logError("Mapping get/save error", detail);
                    this.showErrorToast("Unable to perform mappings operation, please contact administrator.");
                    this._loading = false;
                },

                _isDuplicateGridDataAvailable: function () {
                    var uniqueContexts = [...new Set(this._gridData.map((obj) => obj.context))];

                    if (this._gridData.length != uniqueContexts.length) {
                        return true;
                    }

                    return false;
                },

                _transformGridDataToSaveMappings: function () {
                    var mappings = {};
                    var contextMapping = DataHelper.cloneObject(this._mappingAttributes);
                    var self = this;
                    this._gridData.forEach(function (row) {
                        var mappedValues = [];
                        var contextKey = self._getContextKeyByExternalName(row.context);
                        if (contextMapping[contextKey]) {
                            //If excel column value matched, then do not consider as change
                            if (row.excelColumn != contextMapping[contextKey].values[0].value) {
                                mappedValues.push(self._populateMappingValue(row.excelColumn));
                                var deleteExisting = self._populateMappingValue(contextMapping[contextKey].values[0].value);
                                deleteExisting.action = "delete";
                                mappedValues.push(deleteExisting);
                            }

                            delete contextMapping[contextKey];
                        } else {
                            var mappingVal = self._populateMappingValue(row.excelColumn);
                            if (mappingVal) {
                                mappedValues.push(mappingVal);
                            }
                        }

                        if (mappedValues && mappedValues.length) {
                            mappings[contextKey] = {
                                "values": mappedValues
                            };
                        }
                    });

                    //Remaining mappings not in grid, so consider as delete
                    if (!_.isEmpty(contextMapping)) {
                        for (var key in contextMapping) {
                            contextMapping[key].action = "delete";
                            mappings[key] = contextMapping[key];
                        }
                    }

                    return mappings;
                },

                _populateMappingValue: function (excelValue) {
                    if (!excelValue) {
                        return;
                    }
                    var valContext = ContextHelper.getFirstValueContext(this.contextData);

                    return {
                        "value": excelValue,
                        "locale": valContext.locale,
                        "source": valContext.source
                    }
                },

                _onAddTap: function () {
                    this.push("_gridData", {
                        "context": "",
                        "excelColumn": "",
                        "index": this._gridData.length
                    });
                    this._isMappingChanged = true;
                    //Notify Grid data
                    var temp = this._gridData;
                    this._gridData = [];
                    this._gridData = temp;
                },

                _onDeleteTap: function () {
                    var grid = this.shadowRoot.querySelector("#mapping-grid");
                    if (grid) {
                        var selectedItems = grid.getSelectedItems();
                        if (selectedItems.length == 0) {
                            //Show message if needed - Please select an item for delete
                            return;
                        }
                        var gridData = [];
                        for (var i = 0; i < this._gridData.length; i++) {
                            var isDelete = false;
                            for (var j = 0; j < selectedItems.length; j++) {
                                if (this._gridData[i].context.toLowerCase() == selectedItems[j].context.toLowerCase() &&
                                    this._gridData[i].index == selectedItems[j].index) {
                                    isDelete = true;
                                    break;
                                }
                            }

                            if (!isDelete) {
                                gridData.push(this._gridData[i]);
                            }
                        }

                        //Reset row index
                        for (var i = 0; i < gridData.length; i++) {
                            gridData[i].index = i;
                        }
                        this._isMappingChanged = true;
                        this.set("_gridData", gridData);
                    }
                },

                _getGridRecordsCountMessage: function () {
                    if (!this._gridData || this._gridData.length == 0) {
                        return "Showing 0 results";
                    }

                    return "Showing 1 - " + this._gridData.length + " items of total " + this._gridData.length + " results";
                },

                _onTapBuildPath: function (e, detail) {
                    var rowId = e.currentTarget.rowId;
                    this.currentPathEl = this.shadowRoot.querySelector("#excelColumn_" + rowId);
                    //Assign details to path component
                    var contextPathBuilder = this.shadowRoot.querySelector("#contextPathBuilder");
                    if (contextPathBuilder) {
                        //Reset
                        contextPathBuilder.inputPath = "";
                        contextPathBuilder.headerFields = [];
                        //Set excel details
                        contextPathBuilder.inputPath = this.currentPathEl.value;
                        contextPathBuilder.headerFields = this.mappingData.headerFields;
                    }
                    this._toggleBuildPathDialog(true);
                },

                _onCancelBuildPath: function (e, detail) {
                    this._toggleBuildPathDialog(false);
                },

                _onSelectBuildPath: function (e, detail) {
                    var row = this._getParentRow(this.currentPathEl);
                    if (row) {
                        row.item.excelColumn = this.currentPathEl.value = detail.selectedPath;
                        this.currentPathEl.title = detail.selectedPath;
                        this._toggleBuildPathDialog(false);
                    }
                },

                _toggleBuildPathDialog: function (open) {
                    var buildPathDialog = this.shadowRoot.querySelector("#buildPathDialog");
                    if (buildPathDialog) {
                        if (open) {
                            buildPathDialog.open();
                        } else {
                            buildPathDialog.close();
                        }
                    }
                },

                //Prepare non context fields based on context mappings
                _getNonTaxonomyFields: function (fromGridData) {
                    var nonContextFields = [];
                    var contextFields = [];
                    var categoryPathSeperator = this.appSetting('dataDefaults').categoryPathSeparator;

                    //Collect context fields from grid / initial mapping contexts
                    if (fromGridData) {
                        var self = this;
                        this._gridData.forEach(function (row) {
                            if (row.excelColumn) {
                                var columns = [];
                                columns = row.excelColumn.split(categoryPathSeperator);
                                contextFields = contextFields.concat(columns);
                                //Update mappingAttributes
                                var key = self._getContextKeyByExternalName(row.context);
                                if (self._mappingAttributes && self._mappingAttributes[key]) {
                                    self._mappingAttributes[key].values[0].value = row.excelColumn;
                                } else {
                                    var mappingVal = self._populateMappingValue(row.excelColumn);
                                    self._mappingAttributes[key] = {
                                        "values": [
                                            mappingVal
                                        ]
                                    }
                                }
                            }
                        });
                    } else {
                        if (!_.isEmpty(this._mappingAttributes)) {
                            for (var key in this._mappingAttributes) {
                                if (this._mappingAttributes[key] &&
                                    this._mappingAttributes[key].values &&
                                    this._mappingAttributes[key].values.length) {
                                    for (var i = 0; i < this._mappingAttributes[key].values.length; i++) {
                                        var columns = [];
                                        columns = this._mappingAttributes[key].values[i].value.split(categoryPathSeperator);
                                        contextFields = contextFields.concat(columns);
                                    }
                                }
                            }
                        }
                    }

                    //Prepare non-context fields
                    for (var i = 0; i < this.mappingData.headerFields.length; i++) {
                        if (contextFields.indexOf(this.mappingData.headerFields[i]) == -1) {
                            nonContextFields.push(this.mappingData.headerFields[i]);
                        }
                    }

                    return nonContextFields;
                },

                _setAttributeMappingsData: function(fromGridData = false) {
                    var attributeFields = this._getNonTaxonomyFields(fromGridData);
                    var mappingData = {
                        "headerFields": attributeFields && attributeFields.length > 0 ? attributeFields : this.mappingData.headerFields,
                        "taxonomies": this.taxonomies,
                        "taxonomy": this.taxonomy,
                        "contexts": this.contexts,
                        "domain": this.domain,
                        "fileFormat": this.fileFormat,
                        "selectedOptions": this.selectedOptions
                    }

                    //Prepare mapping data, and pass the same as businessFunctionData
                    if(!this.businessFunctionData) {
                        this.businessFunctionData = {};
                    }
                    this.businessFunctionData["attribute-mapping-data"] = mappingData;
                    ComponentHelper.getParentElement(this).businessFunctionData = this.businessFunctionData;
                }
            });
        })();
    </script>
</dom-module>