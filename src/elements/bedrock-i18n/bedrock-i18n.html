<link rel="import" href="../../../bower_components/app-localize-behavior/app-localize-behavior.html">

<script>
/**
* `RUFBehaviors.Internationalization` wraps the Polymer.AppLocalizeBehavior component and in turn[format.js](http://formatjs.io/) library to
* help you internationalize your application. Note that if you're on a browser that
* does not natively support the [Intl](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl)
* object, you must load the polyfill yourself. An example polyfill can
* be found [here](https://github.com/andyearnshaw/Intl.js/).
*
* `RUFBehaviors.Internationalization` supports the same [message-syntax](http://formatjs.io/guides/message-syntax/)
* of format.js, in its entirety; use the library docs as reference for the
* available message formats and options.
*
* Sample application loading resources:
*
*     <dom-module id="x-app">
*        <template>
*         <div>{{localize('hello', 'name', 'Batman')}}</div>
*        </template>
*        <script>
*           Polymer({
*             is: "x-app",
*
*             behaviors: [
*               RUFBehaviors.Internationalization
*             ],
*
*             properties: {
*               language: {
*                 value: 'en'
*               },
*             }
*             //explicitly loading resources from remote url if bedrock-init is not used
*             attached: function() {
*               this.loadResources(this.resolveUrl('locales.json'));
*             },
*           });
*        &lt;/script>
*     </dom-module>
*
* Alternatively, you can also inline your resources inside the app itself:
*
*     <dom-module id="x-app">
*        <template>
*         <div>{{localize('hello', 'name', 'Batman')}}</div>
*        </template>
*        <script>
*           Polymer({
*             is: "x-app",
*
*             behaviors: [
*               RUFBehaviors.Internationalization
*             ],
*
*             properties: {
*               language: {
*                 value: 'en'
*               },
*               //overriding resources if bedrock-init is not used
*               resources: {
*                 value: function() {
*                   return {
*                     'en': { 'hello': 'My name is {name}.' },
*                     'fr': { 'hello': 'Je m\'apelle {name}.' }
*                   }
*               }
*             }
*           });
*        &lt;/script>
*     </dom-module>
*
* @demo demo/index.html
* @polymerBehavior RUFBehaviors.Internationalization
*/

   var RUFBehaviors = RUFBehaviors || {};
   RUFBehaviors.Internationalization = {
      
      properties: {
        /**
        * If true, will use the provided key when
        * the translation does not exist for that key.
        */
         useKeyIfMissing: {
            type: Boolean,
            value: true
         },
        /**
        * Overriden resources, which are specific to rock element or page
        */
         overridenResources: {
            type: Object
         }
         
      },
      ready: function(){
         var _this = this;
         if(this.nodeName == 'BEDROCK-INIT') {
            this.addEventListener('app-localize-resources-loaded', function() {
               var proto = this.constructor.prototype;
               proto.__localizationCache.loadedResources = this.resources;
               this.fire('resources-loaded', {resources : this.resources, language: this.language});
            });
         }
         else {
            window.addEventListener('resources-loaded', function(e){
              _this.resources = e.detail.resources;
              _this.language = e.detail.language;
            });
         }
      },

      /**
      * Initializes the internationalization resources.
      *
      * @method init
      * @param {(String)} resourcePath The remote path for resource
      * @param {(String)} localeLanguage The locale language for resource
      */
      init: function(resourcePath, localeLanguage) {
      
        if(localeLanguage!=undefined && localeLanguage != ''){
           this.language = localeLanguage;
        }
        if(resourcePath != undefined){
          if(this.nodeName == 'BEDROCK-INIT') {
             this.loadResources(resourcePath);
          }
        }
      },
      /**
      * Appends the localization resources.
      *
      * @method appendResource
      * @param {(String)} path The remote path for resource
      * @param {(String)} elementId The consumer component id
      */
      appendResource: function(path, elementId){
         var proto = this.constructor.prototype;

         // If the global ajax object has not been initialized, initialize and cache it.
         var ajax = proto.__localizationCache.ajax;
         if (!ajax) {
            ajax = proto.__localizationCache.ajax = document.createElement('iron-ajax');
         }

         var request = proto.__localizationCache.requests[path];
         if (!request) {
            ajax.url = path;
            var request = ajax.generateRequest();

            request.completes.then(
               this.__onAppendRequestResponse.bind(this),
               this.__onAppendRequestError.bind(this));

               // Cache the instance so that it can be reused if the same path is loaded.
               proto.__localizationCache.requests[path] = request;
        } else {
          request.completes.then(
          this.__onAppendRequestResponse.bind(this),
          this.__onAppendRequestError.bind(this));
        }
      },

      /**
      * Switches the language for resources.
      *
      * @method switchLangauge
      * @param {(String)} newDefaultLangauge The new language for resources
      */
      switchLangauge: function(newDefaultLangauge){
         if(newDefaultLangauge != undefined){
            this.language = newDefaultLangauge;
        }
      },
      __onAppendRequestResponse: function(event){
         if(event.response){
            //ToDo: prepare context specific key and append resources
            this.overridenResources = event.response;
         }
      },
      __onAppendRequestError: function(event){

      }

   };
   RUFBehaviors.Internationalization = [Polymer.AppLocalizeBehavior, RUFBehaviors.Internationalization];
</script>