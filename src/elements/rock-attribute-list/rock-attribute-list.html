<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-attribute/rock-attribute.html">

<!--
`rock-attribute-list` Represents attribute-list component in the framework.
It renders the list of attributes based on the specified parameters.

@demo demo/index.html 
-->
<dom-module id="rock-attribute-list">
	<template>
		<style include="pebble-styles-shared">
			.group-name {
				font-weight: bold;
				font-family: var(--default-font-family);
				clear: both;
				margin: 0px;
				font-size: var(--font-size-medium);
                color: var(--palette-dark-three);
			}
            .group-container{
                margin-bottom: 20px;
            }
			
			.group-name-container {
				clear: left;
				@apply(--layout-horizontal);
                background: var( --palette-pale-grey-four);
                padding: 10px;
                border-radius: 3px;                
			}
			
			.group-line-box {
				margin-top: 16px;
				margin-left: 8px;
				margin-right: 8px;
				@apply(--layout-flex);
			}
			
			.group-line-container {
				float: right;
				border-bottom: 1px solid black;
			}
			
			.attribute-box {
				display: inline-block;
				/*border: 1px solid black;*/
			}
			
			.attribute-box-1 {
				width: 100%;
			}
			
			.attribute-box-2 {
				width: calc(50% - 2px);
			}
			
			.attribute-box-3 {
				width: 33%;
			}
			
			pebble-horizontal-divider {
				border-top: 1px dotted #8c8b8b;
			}           

		</style>
		<template id="grouplist" is="dom-repeat" items="[[attributeValues]]" as="group">
			<div class="group-container">
				<div class="group-name-container" align="left">
					<div class="group-name-box"><span class="group-name">[[group.longName]]</span></div>
				</div>
				<template is="dom-repeat" items="[[group.attributes]]" as="attribute">
					<div class$="[[_getAttributeClass(noOfColumns)]]">
						<rock-attribute mode="{{mode}}"  errors="{{attribute.errors}}" attribute-model-object="[[_getAttributeModel(attributeModels, attribute)]]" attribute-object="{{attribute}}"
							original-attribute-object="[[_cloneObject(attribute)]]"></rock-attribute>
					</div>
				</template>
			</div>
		</template>
	</template>
	<script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-attribute-list',
                created: function () {
                    //console.log('list created');
                },
                attached: function () {
                    //console.log('list attached');
                },
                ready: function () {
                    //console.log('list ready');
                    var self=this;
                    this.$.grouplist.addEventListener('dom-change',function () {
						this.async(function () {
                            self._getErrorLength(self.attributeValues);
                        },1);
                    });
                },
                properties: {
                    /**
                     * Indicates whether the attribute should be rendered in edit mode or view mode. 
                     * The two possible values are <b>view</b> and <b>edit</b>.
                     */
                    mode: {
                        type: String,
                        value: "view",
                        notify: true
                    },
                    /**
                     * Indicates the no of columns in which the attributes should be rendered. Possible values are 1, 2 and 3.
                     */
                    noOfColumns: {
                        type: Number,
                        value: 1
                    },
                    /**
                     * Indicates the attribute model objects which should be used to render the attributes.
                     * JSON sample to be added here.
                     */
                    attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the attribute value objects which should be used to render the attributes.
                     * JSON sample to be added here.
                     */
                    attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Indictaes the locale dimension for which the attribute list is used.
                     * Currently not used, but may be needed as info.
                     */
                    locale: {
                        type: String
                    },
                    /**
                     * Indictaes the list for which the attribute list is used.
                     * Currently not used, but may be needed as info.
                     */
                    list: {
                        type: String
                    },
                    /**
                     * Indictaes the source dimension for which the attribute list is used.
                     * Currently not used, but may be needed as info.
                     */
                    source: {
                        type: String
                    }
                },
                observers: [
                    '_getErrorLength(attributeValues)'
                ],
                _getAttributeClass: function (n) {
                    return "attribute-box attribute-box-" + n;
                },
                _getAttribute: function (attributeModel, attributeValues) {
                    if (attributeModel && attributeValues && attributeModel.name in attributeValues) {
                        var attribute = attributeValues[attributeModel.name];
                        return attribute;
                    }
                },
                _getAttributeGroups: function (attributeModels) {
                    var groups = [];
                    if (attributeModels) {
                        var groupsArray = this._toArray(attributeModels);
                        return groupsArray;
                    }
                },
                _arrayExists: function (a, item) {
                    for (var i = 0; i < a.length; i++) {
                        if (a[i].name === item.name) {
                            return true;
                        }
                    }
                    return false;
                },
                _toArray: function (obj) {
                    return Object.keys(obj).map(function (key) {
                        return obj[key];
                    });
                },
                _getAttributeModel: function (attributeModels, attribute) {
                    var model;
                    if (attributeModels) {
                        for (var attributeGroupName in attributeModels) {
                            if (attribute.name in attributeModels[attributeGroupName]) {
                                model = attributeModels[attributeGroupName][attribute.name];
                                break;
                            }
                        }
                    }
                    if(_.isEmpty(model)) {
                        //set default model as textbox
                        //TODO: find a better way for getting default model
                        model =  {
                            "name": attribute.name,
                            "longName": attribute.name,
                            "displayType": "textbox"
                        };
                    }
                    return model;
                },
                getChangedAttributeElements: function() {
                    var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
                    return changedAttributeElements;
                },
                resetChanged: function() {
                    var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        attributeElement.changed = false;
                    }
                },
                revertAll: function () {
                    var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll(
                        'rock-attribute[changed]');
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        attributeElement.attributeObject = this._cloneObject(attributeElement.originalAttributeObject);
                        attributeElement.changed = false;
                    }
                    this.mode = "view";
                },
                _cloneObject: function (o) {
                    return DataHelper.cloneObject(o);
                },
                _getErrorLength: function (attributeValues) {
                    var errorCount=0;
                    for(var i=0;i<attributeValues.length;i++){
                        for(var j=0;j<attributeValues[i].attributes.length;j++){
                            var att=attributeValues[i].attributes[j];
                            if(att.errors && att.errors.length>0){
                                errorCount++;
                            }
                        }
                    }
                    this.fire("bedrock-event",{name: "error-length-changed",data:errorCount});
                },
                /**
                 * Can be used to get if the element is dirty
                 */
                getIsDirty: function() {
                    var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
                    if(changedAttributeElements && changedAttributeElements.length && changedAttributeElements.length > 0) {
                        return true;
                    }
                }
            });
        })();
    </script>
</dom-module>