<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../rock-attribute/rock-attribute.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<!--
`rock-attribute-list` Represents attribute-list component in the framework.
It renders the list of attributes based on the specified parameters.

@demo demo/index.html 
-->
<dom-module id="rock-attribute-list">
  <template>
    <style include="pebble-styles-shared">

      .group-container {
        /*border-top:1px solid black;*/
        /*border-bottom:1px solid black;*/
      }

      .group-name {
        font-weight: 500;
        font-family: var(--default-font-family);
        clear: both;
        margin: 0px;
        font-size: 16px;
      }
      
      .group-name-container {
        clear: left;
        @apply(--layout-horizontal);
      }

      .group-line-box {
        margin-top:16px;
        margin-left:8px;
        margin-right:8px;
        @apply(--layout-flex);
      }
      
      .group-line-container {
        float: right;
        border-bottom: 1px solid black;
      }
      
      .attribute-box {
        display: inline-block;
        /*border: 1px solid black;*/
      }
      
      .attribute-box-1 {
        width: 100%;
      }
      
      .attribute-box-2 {
        width: 49%;
      }
      
      .attribute-box-3 {
        width: 33%;
      }
       pebble-horizontal-divider{
        border-top: 1px dotted #8c8b8b; 
      }
      
      .button {
           --pebble-button: {
                height: 30px;
                width: 100px;
                border: 1px solid #bbc1d2;
                font-size: 15px;
          }
      }
      .focus {
             --pebble-button: {
                height: 30px;
                width: 100px;
                font-size: 15px;
                background: #09c021;
                color: white;
            }
        }
       #buttonContainer {
            height: 50px;
            width: 75%;
            background: #fff;
            position: fixed;
            bottom: 0px;
            display: none;
        }
    </style>
<bedrock-pubsub on-bedrock-event-route-changed="onRouteChange"></bedrock-pubsub>
<template is="dom-repeat" items="[[_attributeValues]]" as="group">
  <div class="group-container">
    <div class="group-name-container" align="left">
      <div class="group-name-box" style="display:inline-block"><span class="group-name">[[group.longName]]</span></div>
<div class="group-line-box">
  <pebble-horizontal-divider></pebble-horizontal-divider>
</div>
</div>
<template is="dom-repeat" items="[[group.attributes]]" as="attribute">
  <div class$="[[_getAttributeClass(noOfColumns)]]">
    <rock-attribute mode="{{mode}}" attribute-model-object="[[_getAttributeModel(attributeModelResponse, attribute)]]" attribute-object="{{attribute}}"
      original-attribute-object="[[_cloneObject(attribute)]]"></rock-attribute>
  </div>
</template>
</div>
</template>
<liquid-entity-getdata log-internal-detail name="attributeGetDataService" operation="getentities" request="{{attributeRequest}}"
  response="{{attributeResponse}}"></liquid-entity-getdata>
<!--<liquid-entity-get name="attributeGetService" request="{{attributeRequest}}" response="{{attributeResponse}}"></liquid-entity-get>-->
<liquid-entity-get name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
<div id="buttonContainer" align="center">
  <pebble-button id="cancel" class="button" button-text="Cancel" on-tap="revert" elevation=1 raised></pebble-button>
  <pebble-button id="save" class="focus" button-text="Save" on-tap="save" elevation=1 raised></pebble-button>
</div>
</template>

<template is="dom-repeat" items="[[_attributeValues]]" as="group">
  <div class="group-container">
    <div class="group-name-container" align="left">
      <div class="group-name-box" style="display:inline-block"><span class="group-name">[[group.longName]]</span></div>
<div class="group-line-box">
  <pebble-horizontal-divider></pebble-horizontal-divider>
</div>
</div>
<template is="dom-repeat" items="[[group.attributes]]" as="attribute">
  <div class$="[[_getAttributeClass(noOfColumns)]]">
    <rock-attribute mode="{{mode}}" attribute-model-object="[[_getAttributeModel(attributeModelResponse, attribute)]]" attribute-object="{{attribute}}"
      original-attribute-object="[[_cloneObject(attribute)]]"></rock-attribute>
  </div>
</template>
</div>
</template>
<liquid-entity-getdata log-internal-detail name="attributeGetDataService" operation="getentities" request="{{attributeRequest}}"
  response="{{attributeResponse}}"></liquid-entity-getdata>
<!--<liquid-entity-get name="attributeGetService" request="{{attributeRequest}}" response="{{attributeResponse}}"></liquid-entity-get>-->
<liquid-entity-get name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
<div id="buttonContainer" align="center">
  <pebble-button id="cancel" class="button" button-text="Cancel" on-tap="revert" elevation=1 raised></pebble-button>
  <pebble-button id="save" class="focus" button-text="Save" on-tap="save" elevation=1 raised></pebble-button>
</div>
</template>
<script>
    (function () {
      'use strict';
      //console.log('outside polymer of list');

      Polymer({
        is: 'rock-attribute-list',
        created: function () {
          //console.log('list created');
        },
        attached: function () {
          //console.log('list attached');
        },
        ready: function () {
          //console.log('list ready');
          this.entityId = this._getEntityId();
        },
        properties: {
          /**
          * Indicates whether the attribute should be rendered in edit mode or view mode. 
          * The two possible values are <b>view</b> and <b>edit</b>.
          */
          mode: {
            type: String,
            value: "view",
            notify: true
          },
          noOfColumns: {
            type: Number,
            value: 1
          },
          /**
          * Indicates the request object that is passed to the data element to retrive attribute data.
            Sample: { 
                      action: "getAttributes" 
                    }
          */
          attributeRequest: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
            * Indicates the response object that is received from the data element for the attribute get request.
            */
          attributeResponse: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
          * Indicates the request object that is passed to the data element to retrive attribute model data.
            Sample: { 
                      action: "getAttributeModels" 
                    }
          */
          attributeModelRequest: {
            type: Object,
            value: function () {
              return { action: "getAttributeModels" };
            }
          },
          /**
          * Indicates the response object that is received from the data element for the attribute get request.
          */
          attributeModelResponse: {
            type: Object,
            value: function () {
              return {};
            }
          },
          context: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _attributeValues: {
            type: Array,
            value: function () {
              return [];
            }
          },
          entityId: {
            type: String,
            notify: true
          }
        },
        observers: [
          '_attributeResponseChanged(attributeResponse)',
          '_attributeModelResponseChanged(attributeModelResponse)',
          '_contextChanged(context, entityId)',
          '_modeChanged(mode)'
        ],
        onRouteChange: function (e) {
          //Todo: need better way to handle query string parameters as rock-attribute-list is reusable
          //we need configurable way to read querystring parameter
          var entityId = this._getEntityId();
          if (entityId && entityId != this.entityId) {
            this.entityId = entityId;
          }
        },
        _getAttributeClass: function (n) {
          return "attribute-box attribute-box-" + n;
        },
        _getAttribute: function (attributeModel, attributeValues) {
          if (attributeModel && attributeValues && attributeModel.name in attributeValues) {
            var attribute = attributeValues[attributeModel.name];
            return attribute;
          }
        },
        _getAttributeGroups: function (attributeModelResponse) {
          var groups = [];
          if (attributeModelResponse && attributeModelResponse.returnValue && attributeModelResponse.returnValue.attributeModels) {
            var groups = attributeModelResponse.returnValue.attributeModels;
            var groupsArray = this._toArray(groups);
            return groupsArray;
          }
        },
        _arrayExists: function (a, item) {
          for (var i = 0; i < a.length; i++) {
            if (a[i].name === item.name) {
              return true;
            }
          }
          return false;
        },
        _toArray: function (obj) {
          return Object.keys(obj).map(function (key) {
            return obj[key];
          });
        },
        _contextChanged: function (context, entityId) {
          if (context && context.attributeGroups) {
            var t = { action: "getAttributeModels", "attributeGroups": context.attributeGroups };
            this.set("attributeModelRequest", t);
            // this.attributeModelRequest.attributeGroups = context.attributeGroups;
            // this.notifyPath('attributeModelRequest');
          }
        },
        _modeChanged: function (mode) {
          if (mode == 'edit') {
            this.$.buttonContainer.style.display = "inline-block";
          }
          else {
            this.$.buttonContainer.style.display = "none";
          }
        },
        _attributeModelResponseChanged: function (attributeModelResponse) {
          if (attributeModelResponse && attributeModelResponse.returnValue && attributeModelResponse.returnValue.attributeModels) {
            var attributeNames = [];
            for (var attributeGroupName in attributeModelResponse.returnValue.attributeModels) {
              for (var attributeName in attributeModelResponse.returnValue.attributeModels[attributeGroupName]) {
                attributeNames.push(attributeName);
              }
            }

            var req = {
              "data": {
                "query": {
                  "ctx": [
                    {
                      "list": "productMaster",
                      "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                    }
                  ],
                  "valCtx": [
                    {
                      "source": "SAP",
                      "locale": "en-US"
                    }
                  ],
                  "id": this.entityId,
                  "filters": {
                    "attributesCriterion": [],
                    "relationshipsCriterion": [],
                    "typesCriterion": ["nart"]
                  }
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": attributeNames,
                  "relationships": [
                    "ALL"
                  ]
                },
                "options": {
                  "totalRecords": 10,
                  "includeRequest": false
                }
              }
            };

            this.set("attributeRequest", req);
            //this.set("attributeRequest.attributeNames", attributeNames);
          }
        },
        _attributeResponseChanged: function (attributeResponse) {
          var values = [];
          var locale = 'en-US', time = 'now', source = 'SAP';
          if (attributeResponse && attributeResponse.data && attributeResponse.data.entities && this.entityId in attributeResponse.data.entities
            && this.attributeModelResponse && this.attributeModelResponse.returnValue && this.attributeModelResponse.returnValue.attributeModels) {
            var contextKey = Object.keys(attributeResponse.data.entities[this.entityId].data.ctxInfo)[0];
            var attributes = attributeResponse.data.entities[this.entityId].data.ctxInfo[contextKey].attributes;

            //ToDo: read following through configuration to set rock title bar
            if (attributes.cpimProductName && attributes.cpimSkinType) {
              this._setTitleBar(attributes.cpimProductName.values[0].value, attributes.cpimSkinType.values[0].value);
            }


            values = DataHelper.transformAttributeToUIFormat(attributes, this.attributeModelResponse.returnValue.attributeModels, locale, time, source);
          }
          this._attributeValues = values;
        },
        _getAttributeModel: function (attributeModelResponse, attribute) {
          if (attribute && attributeModelResponse && attributeModelResponse.returnValue
            && attributeModelResponse.returnValue.attributeModels) {
            for (var attributeGroupName in attributeModelResponse.returnValue.attributeModels) {
              if (attribute.name in attributeModelResponse.returnValue.attributeModels[attributeGroupName]) {
                return attributeModelResponse.returnValue.attributeModels[attributeGroupName][attribute.name];
              }
            }
          }
        },
        getAttributeValues: function () {
          return this._attributeValues;
        },
        save: function () {
          document.querySelector('#app').$.pebbleAppToast.fitInto = document.querySelector('#app').$.toastArea;
          //check if any changes
          //if none, then return operationResult with warning message else proceed
          var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
          if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
            document.querySelector('#app').toastText = "No changes to save";
            document.querySelector('#app').$.pebbleAppToast.show();
            return { "message": "No changes to save" };//TODO: Prepare OR
          }

          //validate - if error then return operationResult, else proceed

          //prepare attribute JSON from changed attributes
          var attributesJSON = [];
          for (var i = 0; i < changedAttributeElements.length; i++) {
            var attributeElement = changedAttributeElements[i];
            var attributeJSON = attributeElement.attributeObject;
            attributesJSON.push(attributeJSON);
          }
          console.log('attributesJSON', attributesJSON);

          document.querySelector('#app').toastText = "Attribute Data saved successfully!!";
          document.querySelector('#app').$.pebbleAppToast.show();
          return attributesJSON;
          //set requestObject for process liquid

          //once the request is done, check the response and return operationResult

        },

        revert: function () {
          var changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
          for (var i = 0; i < changedAttributeElements.length; i++) {
            var attributeElement = changedAttributeElements[i];
            attributeElement.attributeObject = this._cloneObject(attributeElement.originalAttributeObject);
            attributeElement.changed = false;
          }
          this.mode = "view";
        },
        _cloneObject: function (o) {
          return DataHelper.cloneObject(o);
        },
        _getEntityId: function () {
          var mainApp = document.querySelector('main-app');
          if (mainApp && mainApp.route && mainApp.route.__queryParams && "id" in mainApp.route.__queryParams) {
            return mainApp.route.__queryParams['id'];
          }
        },
        _setTitleBar: function (title, subtitle) {
          var mainApp = document.querySelector('main-app');
          if (mainApp) {
            var contentViewMgr = mainApp.$$("rock-content-view-manager");
            if (contentViewMgr) {
              var activeContentView = contentViewMgr.$.contentViewManager.querySelector("rock-content-view:not([hidden])");
              if (activeContentView) {
                var contentComponent = activeContentView.$$("#component");
                if (contentComponent) {
                  var rockTitleBar = contentComponent.$$("rock-titlebar");
                  if (rockTitleBar) {
                    rockTitleBar.subTitle = subtitle;
                    rockTitleBar.title = title;

                  }
                }
              }
            }
          }

        }
      });
    })();
  </script>
</dom-module>