<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">

<link rel="import" href="../rock-attribute/rock-attribute.html">
<!--
`rock-attribute-list` Represents the attribute-list component in the framework.
It renders the list of attributes based on the specified parameters.

@demo demo/index.html 
-->
<dom-module id="rock-attribute-list">
    <template>
        <style include="pebble-styles-shared">
            .group-name {
                font-weight: var(--font-bold, bold);
                font-family: var(--default-font-family);
                clear: both;
                margin: 0px;
                font-size: var(--font-size-md);
                color: var(--title-text-color);
            }

            .group-container {
                margin-bottom: 20px;
            }

            .group-name-container {
                clear: left;
                @apply(--layout-horizontal);
                background: var( --palette-pale-grey-four);
                padding: 6px;
                border-radius: 3px;
            }

            .group-line-box {
                margin-top: 16px;
                margin-left: 8px;
                margin-right: 8px;
                @apply(--layout-flex);
            }

            .group-line-container {
                float: right;
                border-bottom: 1px solid black;
            }

            .attribute-box {
                display: inline-block;
                padding: 0 20px;
                vertical-align: bottom;
            }

            .attribute-wrapper {
                margin: 0 -30px;
            }

            .attribute-box-1 {
                width: 100%;
            }

            .attribute-box-2 {
                width: calc(50% - 2px);
            }

            .attribute-box-3 {
                width: 33%;
            }

            pebble-horizontal-divider {
                border-top: 1px dotted var(--default-border-color);
            }
        </style>
        <template id="attributeRepeat" is="dom-repeat" items="[[attributeValues]]" as="attribute" notify-dom-change>

            <template is="dom-if" if="[[_checkRenderGroupBar(attribute, 0)]]">
                <pebble-accordion header-text="[[groupName]]" default-icon="expand-less" open-icon="expand-more">
                    <div class="attribute-wrapper">
            </template>

            <div class$="[[_getAttributeClass(noOfColumns)]]" name$="[[attribute.name]]">
                <rock-attribute context-data="[[contextData]]" mode="{{mode}}" errors="{{attribute.errors}}" server-errors="[[_getAttributeMessage(attribute,attributeMessages)]]"
                    attribute-model-object="[[_getAttributeModel(attributeModels, attribute)]]" attribute-object="{{attribute}}"
                    original-attribute-object="[[_cloneObject(attribute)]]"></rock-attribute>
            </div>

            <template is="dom-if" if="[[_checkRenderGroupBar(attribute, 1)]]">
                </div>
                </pebble-accordion>
            </template>

        </template>
    </template>
    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'rock-attribute-list',
                created: function () {
                    //console.log('list created');
                },
                attached: function () {
                    //console.log('list attached');
                },
                ready: function () {
                    //console.log('list ready');
                    var self = this;
                    this.$.attributeRepeat.addEventListener('dom-change', function () {
                        this.async(function () {
                            self._calculateErrorLength(self.attributeValues);
                        }, 1);
                    });
                },
                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates whether the attribute is rendered in edit mode or view mode. 
                     * The two possible values are <b>view</b> and <b>edit</b>.
                     */
                    mode: {
                        type: String,
                        value: "view",
                        notify: true
                    },
                    /**
                     * Indicates the number of columns in which the attributes are rendered. Possible values are 1, 2 and 3.
                     */
                    noOfColumns: {
                        type: Number,
                        value: 1
                    },
                    /**
                     * Indicates the attribute model objects which renders the attributes.
                     * JSON sample to be added here.
                     */
                    attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the attribute value objects which renders the attributes.
                     * JSON sample to be added here.
                     */
                    attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Indicates the attribute value objects which renders the attributes.
                     * JSON sample to be added here.
                     */
                    attributeMessages: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indictaes the locale dimension for which the attribute list is used.
                     */
                    locale: {
                        type: String
                    },
                    /**
                     * Indictaes the list for which the attribute list is used.
                     */
                    list: {
                        type: String
                    },
                    /**
                     * Indictaes the source dimension for which the attribute list is used.
                     */
                    source: {
                        type: String
                    },
                    showGroupName: {
                        type: Boolean,
                        value: false
                    },
                    groupName: {
                        type: String,
                        value: "My Attributes"
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_calculateErrorLength(attributeValues)',
                    '_modeChanged(mode)'
                ],
                _getAttributeClass: function (n) {
                    return "attribute-box attribute-box-" + n;
                },
                _getAttributeModel: function (attributeModels, attribute) {
                    var model;
                    if (attributeModels) {
                        if (attribute.name in attributeModels) {
                            model = attributeModels[attribute.name];
                        }
                    }                                 

                    if (_.isEmpty(model)) {
                        //set default model as textbox
                        //TODO: find a better way for getting default model
                        model = {
                            "name": attribute.name,
                            "longName": attribute.name,
                            "displayType": "textbox",
                            "viewName": "Other Attributes"
                        };
                    }

                    if (_.isEmpty(model.dataType)) {
                        model.dataType = 'string';
                    }                    

                    if (_.isEmpty(model.displayType)) {
                        var dataType = model.dataType ? model.dataType.toLowerCase() : model.dataType;
                        model.displayType = this._getDisplayType(dataType);
                    }                    

                    return model;
                },
                _getDisplayType: function (dataType) {
                    var displayType = 'textbox';

                    switch (dataType) {
                        case 'boolean':
                            {
                                displayType = 'boolean';
                                break;
                            }
                        case 'date':
                            {
                                displayType = 'date';
                                break;
                            }
                        case 'datetime':
                            {
                                displayType = 'datetime';
                                break;
                            }
                        case 'decimal':
                            {
                                displayType = 'textbox';
                                break;
                            }
                    }

                    return displayType;
                },
                /**
                * Can be used to get all the attribute objects that are changed in the attribute-list.
                */
                getChangedAttributeElements: function() {
                    var node = Polymer.dom(this).node;
                    var changedAttributeElements = Polymer.dom(this).node.querySelectorAll('rock-attribute[changed]');
                    if(changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                        changedAttributeElements = Polymer.dom(this).node.root.querySelectorAll('rock-attribute[changed]');
                    }
                    return changedAttributeElements;
                },
                /**
                 * Can be used to reset all the changed attribute objects to their original object values.
                 */
                resetChanged: function () {
                    var changedAttributeElements = this.getChangedAttributeElements();
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        attributeElement.changed = false;
                    }
                },
                /**
                 * Can be used to reset all the changed attribute objects to their original object values and switch
                 * the mode from "edit" to "view".
                 */
                revertAll: function () {
                    var changedAttributeElements = this.getChangedAttributeElements();
                    for (var i = 0; i < changedAttributeElements.length; i++) {
                        var attributeElement = changedAttributeElements[i];
                        attributeElement.attributeObject = this._cloneObject(attributeElement.originalAttributeObject);
                        attributeElement.changed = false;
                    }
                    this.mode = "view";
                },
                _cloneObject: function (o) {
                    return DataHelper.cloneObject(o);
                },
                _calculateErrorLength: function (attributeValues) {
                    var errorCount = 0;
                    for (var i = 0; i < attributeValues.length; i++) {
                        var att = attributeValues[i];
                        if (att.errors && att.errors.length > 0) {
                            errorCount++;
                        }
                    }

                    var eventDetail = {
                        data: errorCount
                    }

                    this.fireBedrockEvent("error-length-changed", eventDetail, {
                        ignoreId: true
                    });
                },
                _modeChanged: function (mode) {
                    var data = {
                        "mode": mode,
                        "node": this
                    };
                    this.fire("bedrock-event", {
                        name: "list-mode-changed",
                        data: data
                    });
                },
                /**
                 * Can be used to get if the element is dirty.
                 */
                getIsDirty: function () {
                    var changedAttributeElements = this.getChangedAttributeElements();
                    if (changedAttributeElements && changedAttributeElements.length &&
                        changedAttributeElements.length > 0) {
                        return true;
                    }
                },

                _checkRenderGroupBar: function (attribute, saveAsPrevious) {
                    var result = false;

                    if (this._previousViewName != this.groupName) {
                        result = true;
                    }
                    if (saveAsPrevious) {
                        this._previousViewName = this.groupName;
                    }

                    return result;
                },
                _getAttributeMessage: function (attribute) {
                    if (attribute && this.attributeMessages) {
                        var messages = this.attributeMessages[attribute.name];
                        if (messages && messages.length) {
                            return messages;
                        }
                    }
                    return [];
                }
            });
        })();
    </script>
</dom-module>