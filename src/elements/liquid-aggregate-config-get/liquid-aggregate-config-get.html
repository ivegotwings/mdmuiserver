<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-config-get-new/liquid-config-get-new.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<!--
`liquid-config-get-new`

@demo demo/index.html 
-->
<dom-module id="liquid-aggregate-config-get">
    <template>
         <liquid-config-get-new id="getConfig" operation="getbyids" request-id="req1" request-data={{request}} on-response="_onConfigsGetResponse"></liquid-config-get-new>
    </template>
    <script>
        (function () {
            'use strict';
        
            Polymer({
                is: 'liquid-aggregate-config-get',
                properties: {
                    request: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    configs: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _components: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                generateRequest: function() {
                    this.$$('#getConfig').generateRequest();
                },
                _onConfigsGetResponse: function (e) {
                    var configs = e.detail.response.content;
                    var ctx = this.request.params.query.contexts[0];
                    var configJson = SharedUtils.DataObjectFalcorUtil.getConfigByCtx(configs, ctx);
                    if(configJson) {
                        if(configJson && configJson.config && configJson.config.components && configJson.config.components.length > 0) {
                            this.set("_components", configJson.config.components);
                            this.request = DataRequestHelper.createGetConfigRequest(ctx.app, this._components[0]);
                            this.generateRequest();
                        } else {
                            this.configs[ctx.component] = configJson;
                            var i = this._components.indexOf(ctx.component);
                            if(i != -1 && i < this._components.length - 1) {
                                this.request = DataRequestHelper.createGetConfigRequest(ctx.app, this._components[i+1]);
                                this.generateRequest();
                            } else {
                                var eventName = "config-get-response";
                                var eventDetail = {
                                    name: eventName,
                                    configs: this.configs
                                };
                                this.fireBedrockEvent(eventName, eventDetail,{ ignoreId: true });
                            }
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>