<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-entity-delete">
    <template>
        <style include="bedrock-style-common">
            .message {
                text-align: center;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>
        <liquid-rest id="asyncEntityBulkDelete" method="POST" url="{{_requestURL}}" request-data="{{_asyncDeleteRequest}}" on-liquid-response="_onAsyncDeleteSuccess"
            on-liquid-error="_onAsyncDeleteFailure">
        </liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-entity-delete',

                properties: {

                    /**
                     * Represents selection mode query or count
                     */
                    selectionMode: {
                        type: String,
                        value: "count"
                    },

                    /**
                     * Represents criteria query
                     */
                    selectionQuery: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },

                    _deleteRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _asyncDeleteRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _requestURL: {
                        type: String,
                        value: null
                    },

                    _taskId: {
                        type: String,
                        value: null
                    },

                    syncThreshold: {
                        type: String,
                        value: 20
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [
                    '_executeDeleteProcess(contextData)'
                ],

                _executeDeleteProcess: function () {
                    // Start process when all the details are available
                    if (this.contextData && !_.isEmpty(this.contextData)) {
                        this._loading = true;
                        this._message = "Delete process started";
                        this._generateDeleteRequest();
                    }
                },

                _generateDeleteRequest: function () {
                    // No selectionMode or selectionMode as count should have selectedEntities to do process
                    if ((!this.selectionMode || this.selectionMode == "count") && (!this.selectedEntities || this.selectedEntities.length == 0)) {
                        this._message = "Entities not available, unable to execute delete process";
                        this._loading = false;
                        return;
                    }

                    if (!this.selectionQuery || _.isEmpty(this.selectionQuery)) {
                        this._message = "Selection query not available, unable to execute delete process";
                        this._loading = false;
                        return;
                    }

                    //Initiate request
                    var deleteRequest = {
                        "params": {
                            "soft-delete": true
                        }
                    };

                    //Add hotline flag if hotline is enabled
                    if (DataHelper.isHotlineModeEnabled()) {
                        deleteRequest.hotline = true;
                    }

                    //Async process
                    deleteRequest.params.operationType = "inboundService";

                    var requestURL = "/data/pass-through/bulkentityservice/createtask";
                    if (this.selectionQuery.params && this.selectionQuery.params.isCombinedQuerySearch) {
                        deleteRequest.params.taskType = "delete-multi-query";
                        deleteRequest.entities = [this.selectionQuery.entity];
                        requestURL = "/data/pass-through-combined-query/bulkentityservice/createtask";
                    } else {
                        deleteRequest.params.taskType = "delete-query";
                        deleteRequest.params.query = this.selectionQuery.params ? this.selectionQuery.params.query : this.selectionQuery;
                    }

                    //Add clientAttributes
                    var valueContext = ContextHelper.getFirstValueContext(this.contextData);
                    var userContext = ContextHelper.getFirstUserContext(this.contextData);
                    var clientMessage = "Delete entities";

                    deleteRequest.clientAttributes = {
                        "taskName": {
                            "values": [{
                                "source": valueContext.source,
                                "locale": valueContext.locale,
                                "value": clientMessage
                            }]
                        }
                    };

                    this.set("_asyncDeleteRequest", deleteRequest);
                    this.set("_requestURL", requestURL);

                    var asyncLiquidDelete = this.shadowRoot.querySelector("#asyncEntityBulkDelete");
                    if (asyncLiquidDelete) {
                        asyncLiquidDelete.generateRequest();
                    }
                },

                _onAsyncDeleteSuccess: function (e) {
                    var response = e.detail.response && e.detail.response.response ? e.detail.response.response : e.detail.response;
                    var request = e.detail.response ? e.detail.response.request : undefined;

                    if ((!response || _.isEmpty(response)) ||
                        (DataHelper.isValidObjectPath(response, "dataObjectOperationResponse.status") && response.dataObjectOperationResponse.status.toLowerCase() == "error") ||
                        (response.status && response.status.toLowerCase() == "error")) {
                        this._message = "Entity delete process failed, please contact administrator";
                        this._loading = false;
                        return;
                    } else {
                        if (response.status && response.status.toLowerCase() == "success") {
                            if (request && request.taskId) {
                                this._taskId = request.taskId;
                            }
                        }

                        this._message = "Delete request triggered successfully";
                        this._triggerFinishStep();
                    }
                },

                _onAsyncDeleteFailure: function (e) {
                    this._loading = false;
                    this._message = "Entity delete process failed, please contact administrator";
                    this.logError("BuldEntityDeleteFailure", "response", JSON.stringify(e.detail));
                },

                _triggerFinishStep: function () {
                    var message = "Delete process is started, you can review the progress of the task " + this._taskId + " in task details.";
                    var actions = [{
                        "name": "goBack",
                        "text": "Take me back to where I started",
                        "isNotApp": true
                    },
                    {
                        "name": "gotoJobDetails",
                        "text": "Show me the task details",
                        "isNotApp": true,
                        "dataRoute": "task-detail",
                        "queryParams": {
                            "id": this._taskId
                        }
                    }];

                    var data = {
                        "messages": [{
                            "message": message
                        }],
                        "actions": actions
                    };

                    this.businessFunctionData = data;
                    var eventName = "onComplete";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });

                    this._message = "About to complete, please wait...";
                    this._loading = true;

                    //Reset
                    this.contextData = {};
                    this.selectedEntities = [];
                }
            });
        })();
    </script>
</dom-module>