<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../liquid-rest/liquid-rest.html" />

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="rock-log-service-item.html">

<dom-module id="rock-log-service">
  <template>
    <style include="bedrock-style-common">
      .block {
        padding: 0 20px;
      }
    </style>
    <div class="block">
      <template id="loggerListTemplate" is="dom-repeat" items="[[loggerArray]]">
        <rock-log-service-item item="[[item]]" selected-value="[[item.level]]">
        </rock-log-service-item>
      </template>
      <pebble-button id="statusIcon" class="btn btn-primary m-b-10" button-text="Save" on-click="_handleSave"></pebble-button>

      <liquid-rest id="loggerConfigGet" url="/data/logger/get" method="GET" on-liquid-response="_onLoggerConfigGetResponse" on-liquid-error="_onLoggerConfigGetError"></liquid-rest>
      <liquid-rest id="loggerConfigSave" url="/data/logger/set" method="POST" on-liquid-response="_onLoggerConfigSaveResponse" on-liquid-error="_onLoggerConfigSaveError"></liquid-rest>

    </div>
  </template>
  <script>
    Polymer({
      is: 'rock-log-service',
      properties: {
        loggerObj: {
          type: Object
        },
        loggerArray: {
          type: Array,
          value: function () {
            return [];
          }
        },
        _loggerConfigPostRequest: {
          type: Object
        }
      },
      observers: [
        'loggerObjObserver(loggerObj)'
      ],
      attached: function () {
        this._getConfigData();
      },
      loggerObjObserver: function () {
        var arr = [];
        for (var key in this.loggerObj) {
          arr.push({ title: key, level: this.loggerObj[key].level });
        }
        this.set("loggerArray", arr);
      },
      _getConfigData: function () {
        var loggerConfigGet = this.shadowRoot.querySelector("#loggerConfigGet");
        loggerConfigGet.generateRequest();
      },
      _onLoggerConfigGetResponse: function (e) {
        this.set("loggerObj", e.detail.response);
      },
      _onLoggerConfigGetError: function (e) {
        console.log("logConfigError", JSON.stringify(e.detail, null, 2))
      },
      _handleSave: function () {
        //todo need to handle save functionality
        var finalObj = {};
        for (var i = 0; i < this.loggerArray.length; i++) {
          //var element = this.loggerArray[i];
          finalObj[this.loggerArray[i]["title"]] = { level: this.loggerArray[i]["level"] }
        }
        this.generateSaveRequest(finalObj, "update");
      },
      generateSaveRequest: function (reqData, operation) {
        var configSaveService = this.shadowRoot.querySelector('#loggerConfigSave');

        if (configSaveService) {
          configSaveService.operation = operation;
          configSaveService.requestData = reqData;
          configSaveService.generateRequest();
        }
      },
      _onLoggerConfigSaveResponse: function (e) {
        this.set("loggerObj", e.detail.response);
        console.log("_onLoggerConfigSaveResponse", JSON.stringify(e.detail, null, 2))
      },
      _onLoggerConfigSaveError: function (e) {
        console.log("logConfigError", JSON.stringify(e.detail, null, 2))
      }
    });
  </script>
</dom-module>