<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-grid-datasource-behavior/bedrock-grid-datasource-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="entity-relationship-grid-datasource">
    <template>
        <liquid-entity-data-get id="getEntityRelationships" operation="getbyids" request-data="[[request]]" last-response="{{entityRelationshipsResponse}}"
        use-data-coalesce exclude-in-progress>
        </liquid-entity-data-get>
    </template>
    <script>
        Polymer({
            is: 'entity-relationship-grid-datasource',
            properties: {
                _getEntityRelationshipsElement: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                _success: {
                    type: Function
                },
                _error: {
                    type: Function
                },
                _options: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                }
            },

            behaviors: [
                RUFBehaviors.GridDataSourceBehavior
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._getEntityRelationshipsElement = Polymer.dom(this).node.shadowRoot.querySelector(
                    "liquid-entity-data-get[id='getEntityRelationships']");

                this.rDataSource = this._dataSource.bind(this);
            },

            _dataSource: function (options, success, error) {
                // Attach one-time event
                this._success = success;
                this._error = error;
                DataHelper.oneTimeEvent(this._getEntityRelationshipsElement, 'response', this._onRelationshipsReponse
                    .bind(this));

                // Set Options
                this._options = options;

                // Set Range
                var requestOptions = this._prepareRequestOptions(options);
                this.set("request.params.options", requestOptions);

                // Make Request
                this._getEntityRelationshipsElement.generateRequest();
            },

            _onRelationshipsReponse: function (event) {
                    var totalRelCount = undefined;

                    // Format ResponseData
                    var entityRelationships = this._formatResponse(this.entityRelationshipsResponse,event);
                    if (typeof (entityRelationships) == 'undefined') {
                        entityRelationships = [];
                    } else {
                        //Get the total count of relationships
                        var resp = this.entityRelationshipsResponse;
                        if (resp) {
                            if (resp.content && resp.content.entities) {
                                var entities = resp.content.entities;
                                if (entities && entities.length > 0) {
                                    var entity = entities[0];
                                    var relationshipsTotalCount = entity.relationshipsTotalCount;
                                    if(relationshipsTotalCount && event.detail.request) {
                                        var currentRel = event.detail.request.requestData.params.fields.relationships[0];
                                        totalRelCount = relationshipsTotalCount[currentRel];
                                    }
                                }
                            }
                        }
                    }

                    // UpdateCurrent RecordSize
                    this._updateCurrentRecordSize(this._options, entityRelationships,totalRelCount, totalRelCount);

                    // Invoke Callback
                    this._success(entityRelationships);
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            resetDataSource: function() {
                this._resetDataSource();
            }
        });
    </script>
</dom-module>