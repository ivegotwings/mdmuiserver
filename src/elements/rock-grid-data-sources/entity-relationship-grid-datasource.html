<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-grid-datasource-behavior/bedrock-grid-datasource-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">


<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="entity-relationship-grid-datasource">
    <template>
        <template is="dom-if" if="[[!enableModelRelationships]]">
            <liquid-entity-data-get id="getEntityRelationships" operation="getbyids" request-data="[[request]]" last-response="{{entityRelationshipsResponse}}"
                exclude-in-progress include-type-external-name>
            </liquid-entity-data-get>
        </template>
        <template is="dom-if" if="[[enableModelRelationships]]">
            <liquid-entity-model-get id="getEntityModelRelationships" operation="getbyids" request-data="[[request]]" last-response="{{entityRelationshipsResponse}}"
                exclude-in-progress include-type-external-name>
            </liquid-entity-model-get>
        </template>
    </template>
    <script>
        Polymer({
            is: 'entity-relationship-grid-datasource',
            properties: {
                applyContextCoalesce: {
                    type: Boolean,
                    value: false
                },
                enableModelRelationships: {
                    type: Boolean,
                    value: false
                },
                _success: {
                    type: Function
                },
                _error: {
                    type: Function
                },
                _options: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                dataIndex: {
                    type: String,
                    value: "entityData"
                },
                dataSubIndex: {
                    type: String,
                    value: "data"
                }
            },

            behaviors: [
                RUFBehaviors.GridDataSourceBehavior
            ],
            /**
              * <b><i>Content development is under progress... </b></i> 
              */
            ready: function () {
                this.rDataSource = this._dataSource.bind(this);
            },

            _dataSource: function (options, success, error) {
                // Attach one-time event
                this._success = success;
                this._error = error;

                let liquidElement = this.enableModelRelationships ? this.shadowRoot.querySelector('#getEntityModelRelationships') : this.shadowRoot.querySelector('#getEntityRelationships');
                liquidElement.returnObjectsCollectionName = 'entities';

                DataHelper.oneTimeEvent(liquidElement, 'response', this._onRelationshipsReponse
                    .bind(this));

                // Set Options
                this._options = options;

                // Set Range
                var requestOptions = this._prepareRequestOptions(options);
                this.set("request.params.options", requestOptions);

                if (this.applyContextCoalesce) {
                    liquidElement.useDataCoalesce = true;
                }

                // Make Request
                liquidElement.generateRequest();
            },

            _onRelationshipsReponse: async function (event) {
                var totalRelCount = undefined;

                // Format ResponseData
                var entityRelationships = await this._formatResponse(this.entityRelationshipsResponse, event);
                if (typeof (entityRelationships) == 'undefined') {
                    entityRelationships = [];
                } else {
                    //Get the total count of relationships
                    var resp = this.entityRelationshipsResponse;
                    if (resp) {
                        if (resp.content && resp.content.entities) {
                            var entities = resp.content.entities;
                            if (entities && entities.length > 0) {
                                var entity = entities[0];
                                var relationshipsTotalCount = entity.relationshipsTotalCount;
                                if (relationshipsTotalCount && event.detail.request) {
                                    var currentRel = event.detail.request.requestData.params.fields.relationships[0];
                                    totalRelCount = relationshipsTotalCount[currentRel];
                                }
                            }
                        }
                    }
                }

                // UpdateCurrent RecordSize
                this._updateCurrentRecordSize(this._options, entityRelationships, totalRelCount, totalRelCount);

                // Invoke Callback
                this._success(entityRelationships);
            },
            /**
              * <b><i>Content development is under progress... </b></i> 
              */
            resetDataSource: function () {
                this._resetDataSource();
            }
        });
    </script>
</dom-module>