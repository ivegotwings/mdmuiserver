<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-grid-datasource-behavior/bedrock-grid-datasource-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="entity-variant-grid-datasource">
    <template>
        <liquid-entity-data-get id="getEntities" operation="getbyids" request-data="[[request]]" last-response="{{response}}"
                                on-error="_onError"        exclude-in-progress>
        </liquid-entity-data-get>
    </template>
    <script>
            class EntityVariantGridDatasource
                extends Polymer.mixinBehaviors([
                    RUFBehaviors.GridDataSourceBehavior
                ], Polymer.Element) {
                static get is() { return 'entity-variant-grid-datasource' }
                static get properties() {
                    return {
                        _getLiquidElement: {
                            type: Object,
                            value: function () {
                                return {}
                            }
                        },
                        _options: {
                            type: Object,
                            value: function () {
                                return {}
                            }
                        }
                    }
                }
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready () {
                super.ready();
                this._getLiquidElement = Polymer.dom(this).node.shadowRoot.querySelector(
                    "liquid-entity-data-get");

                this.dataSource = this._dataSource.bind(this);
            }
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            resetDataSource() {
                this._resetDataSource();
            }

            _dataSource (options, success, error) {
                // Attach one-time event
                DataHelper.oneTimeEvent(this._getLiquidElement, 'response', this._onResponse
                    .bind(this, success, error));
                this._error=error;
                // Set Options
                this._options = options;

                // Set Range
                let requestOptions = this._prepareRequestOptions(this._options);
                this.set("request.params.options", requestOptions);

                // Make Request
                this._getLiquidElement.generateRequest();
            }

            _onResponse (success, error) {
                if (this._lastPage < this._options.page) {
                    
                    // Format ResponseData
                    let entities = this._formatResponse(this.response);
                    if (typeof (entities) == 'undefined') {
                        entities = [];
                    }
                    // UpdateCurrent RecordSize
                    this._updateCurrentRecordSize(this._options, entities);

                    // Invoke Callback
                    success(entities);
                }
            }
            _onError () {
                this._error();
            }
        }
        customElements.define(EntityVariantGridDatasource.is, EntityVariantGridDatasource);

    </script>
</dom-module>