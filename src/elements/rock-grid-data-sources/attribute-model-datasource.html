<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-lov-datasource-behavior/bedrock-lov-datasource-behavior.html">
<link rel="import" href="../bedrock-grid-datasource-behavior/bedrock-grid-datasource-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/bedrock-helpers.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<link rel="import" href="reference-model-datasource.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="attribute-model-datasource">
    <template>
        <reference-model-datasource id="referenceModelDataSource" reference-models="{{referenceModels}}"></reference-model-datasource>
        <bedrock-pubsub event-name="reference-models-recieved" handler="_onRefModelsGet" target-id="referenceModelDataSource"></bedrock-pubsub>
        <liquid-entity-model-composite-get id="compositeModelGet" name="compositeAttributeModelGet" on-entity-model-composite-get-response="_onCompositeGetResponse"
            on-error="_onCompositeGetError" exclude-in-progress>
        </liquid-entity-model-composite-get>
        <liquid-entity-model-get id="liquidModelInitSearch" operation="initiatesearch" request-data="{{request}}" on-error="_onError"
            last-response="{{_initSearchResponse}}" exclude-in-progress></liquid-entity-model-get>
        <liquid-entity-model-get id="liquidModelGetResult" operation="getsearchresultdetail" request-data="{{request}}" on-error="_onError"
            request-id="[[_initSearchResponse.content.requestId]]" last-response="{{searchResultResponse}}" exclude-in-progress></liquid-entity-model-get>
    </template>
    <script>
        Polymer({
            is: 'attribute-model-datasource',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                mode: {
                    type: String,
                    value: ""
                },
                schema: {
                    type: String,
                    value: ""
                },
                _liquidInitSearchElement: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _liquidGetSearchElement: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _options: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                _totalCount: {
                    type: Number,
                    notify: true,
                    value: 0
                },
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                rDataSource: {
                    type: Object,
                    notify: true,
                    reflectToAttribute :true
                },
                rDataFormatter: {
                    type: Function,
                    notify: true
                },
                request: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _compositeModelresponse: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                _succesCallback: {
                    type: Function
                },
                _errorCallback: {
                    type: Function
                },
                referenceModels: {
                    type: Object,
                    value: function () { return {}; }
                },
                referenceModelsReady: {
                    type: Boolean,
                    value: false,
                    notify: true
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LOVDataSourceBehavior,
                RUFBehaviors.GridDataSourceBehavior
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                // var referenceModelDataSource = this.shadowRoot.querySelector("[id=referenceModelDataSource]");
                // if(referenceModelDataSource) {
                //     console.log("generating request for ref models: ", window.performance.now());
                //     referenceModelDataSource.generateRequest();
                // }

                this._liquidInitSearchElement = this.$$('#liquidModelInitSearch');
                this._liquidGetSearchElement = this.$$('#liquidModelGetResult');
                this._liquidCompositeGetElement = this.$$('#compositeModelGet');
                if(!_.isEmpty(this.mode)) {
                    if(this.mode === "all") {
                        this.rDataSource = this._dataSource.bind(this);
                    }
                }
            },

            _onRefModelsGet: function(e, detail) {
                console.log("ref models recieved: ", window.performance.now());
                this.set("referenceModelsReady", true);
                if(!_.isEmpty(this.mode)) {
                    if(this.mode === "all") {
                        this.rDataSource = this._dataSource.bind(this);
                    }
                }
            },

            resetDataSource: function () {
                this.isRequestInitiated = false;
                this._resetDataSource();
            },

            _dataSource: function (options, success, error) {

                this._succesCallback = success.bind(this);
                this._errorCallback = error.bind(this);

                if (_.isEmpty(this.request)) {
                    return;
                }

                DataHelper.oneTimeEvent(this._liquidInitSearchElement, 'response', this._onInitSearchResponse.bind(
                    this));

                DataHelper.oneTimeEvent(this._liquidGetSearchElement, 'response', this._onGetSearchResponse.bind(
                    this, success, error));

                this._error = error;

                // Filter
                var keywordsCriterion;
                if (this.keywordsCriterionBuilder instanceof Function) {
                    keywordsCriterion = this.keywordsCriterionBuilder(options.filter);
                }
                var sortCriterion;
                if (this.sortCriterionBuilder instanceof Function) {
                    sortCriterion = this.sortCriterionBuilder(options.sortOrder);
                }
                var filterCriterion;
                if (this.filterCriterionBuilder instanceof Function) {
                    filterCriterion = this.filterCriterionBuilder(options.filter);
                }

                if(sortCriterion){
                    this.request.params["sort"] = sortCriterion;
                } else{
                    if(this.request.params.sort){
                        delete  this.request.params.sort;
                    }
                }

                if (filterCriterion) {
                    if(filterCriterion.propertiesCriterion) {
                        this.set("request.params.query.filters.propertiesCriterion", filterCriterion.propertiesCriterion);
                    } else {
                        delete this.request.params.query.filters.propertiesCriterion;
                    }
                    if(filterCriterion.attributesCriterion) {
                        this.set("request.params.query.filters.attributesCriterion", filterCriterion.attributesCriterion);
                    } else {
                        delete this.request.params.query.filters.attributesCriterion;
                    }
                } else if (this.request.params.query.filters) {
                    delete this.request.params.query.filters.propertiesCriterion;
                    delete this.request.params.query.filters.attributesCriterion;
                }

                if (keywordsCriterion) {
                    this.set("request.params.query.filters.keywordsCriterion", keywordsCriterion);
                } else if (this.request.params.query.filters && this.request.params.query.filters.keywordsCriterion !== undefined) {
                    delete this.request.params.query.filters.keywordsCriterion;
                }

                // Set Options
                this._options = options;
                this._options["viewMode"] = this.schema;


                if(this.checkIfRequestChanged()) {
                    if(this.schema == "lov") {
                        this.isRequestInitiated = false;
                        this._options.page = 1;
                    } else if(this.schema == "grid") {
                        this.resetDataSource();
                    }
                }

                // Set Range
                var requestOptions = this._prepareRequestOptions(this._options);
                this.set("request.params.options", requestOptions);

                this.reTriggerRequest();
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            reTriggerRequest: function () {
                if(this.mode === "all") {
                    if (!this.isRequestInitiated) {
                        this._liquidInitSearchElement.generateRequest();
                    } else {
                        this._liquidGetSearchElement.generateRequest();
                    }
                } else {
                    this._getData();
                }
            },
            _onInitSearchResponse: function (e) {
                this._totalCount = e.detail.response.content.totalRecords;
                this._resultRecordSize = e.detail.response.content.resultRecordSize;
                this._lastRequest = DataHelper.cloneObject(this.request);
                this._liquidGetSearchElement.generateRequest();
                this.isRequestInitiated = true;
            },
            _onGetSearchResponse: function (success, error) {
                if (typeof (this.rDataFormatter) == 'function') {
                    if (this.searchResultResponse.status === "success") {
                        this._updateReferenceEntityInfo(this.searchResultResponse);
                    } else {
                        error();
                    }
                }
            },
            _onError: function (e) {
                var response = e.detail.response; //need to check why this is response.response
                if (response && response.status && response.status.toLowerCase() == "error") {
                    var message = "";
                    if (response.statusDetail && response.statusDetail.message) {
                        message = " with message: " + response.statusDetail.message;
                    }

                    this.showErrorToast("Attribute model lov load failed" + message + ". Please contact your administrator.");
                }
            },

            /**
            * <b><i>Content development is under progress... </b></i> 
            */
            _getData: function (request) {

                if (_.isEmpty(this.request)) {
                    return;
                }

                if (this._liquidCompositeGetElement) {
                    this._liquidCompositeGetElement.requestData = this.request;
                    this._liquidCompositeGetElement.generateRequest();
                }
            },

            _onCompositeGetResponse: function (e) {
                var response = e.detail.response;
                if (typeof (this.rDataFormatter) == 'function') {
                    if (response && response.status === "success") {
                        this._compositeModelresponse = e.detail;
                        this._updateReferenceEntityInfo(response);
                    }
                }
            },

            _onCompositeGetError: function (e) {
                this.logError("AttributeModelsError",e);
            },

            _updateReferenceEntityInfo: function(response) {
                if(!_.isEmpty(this.referenceModels)) {
                    if (response && response.content && !_.isEmpty(response.content.entityModels)) {
                        if(this.mode === "all") { 
                            DataHelper.updateReferenceTypeAttributeModels(response.content.entityModels, this.referenceModels);
                        } else {
                            DataHelper.updateReferenceTypeAttributeModels(response.content.entityModels[0].data.attributes, this.referenceModels);

                            if(response.content.entityModels[0].contexts && response.content.entityModels[0].contexts.length > 0) {
                                for(var i=0; i<response.content.entityModels[0].contexts.length; i++) {
                                    var context = response.content.entityModels[0].contexts[i];
                                    var specificCtxAttributeModels = SharedUtils.DataObjectFalcorUtil.getAttributesByCtx(response.content.entityModels[0], context);

                                    DataHelper.updateReferenceTypeAttributeModels(specificCtxAttributeModels, this.referenceModels);
                                }
                            }
                        }
                    }
                }
                this._callSuccessCallback(response);
            },

            _callSuccessCallback: function(response) {
                if(this.mode === "all") {
                    if(this.schema == "lov") {
                        this._succesCallback(this.rDataFormatter(response));
                    } else if(this.schema == "grid") {
                        if (this._lastPage < this._options.page) {

                            //this._requestForCompositeModel(this.searchResultResponse);
                            // Format ResponseData
                            var searchResults = this._formatResponse(response);
                            if (typeof (searchResults) == 'undefined') {
                                searchResults = [];
                            }

                            // UpdateCurrent RecordSize
                            this._updateCurrentRecordSize(this._options, searchResults, this._totalCount,this._resultRecordSize);

                            // Invoke Callback
                            this._succesCallback(searchResults);
                        } else {
                            this._errorCallback();
                        }
                    }
                } else {
                    this.rDataFormatter(response, this._compositeModelresponse.request.requestData);
                }
            }
        });
    </script>
</dom-module>