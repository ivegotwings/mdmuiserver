<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">

<dom-module id="rock-entity-quick-manage">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
            .thumb-image {
                width: 50px;
                height: 50px;
            }

            .product-head {
                padding-left: 5px;
                font-size: 13px;
                color: #cacaca;
            }

            .product-name {
                padding-left: 5px;
                font-weight: bold;
            }

            .product-right {
                text-align: right;
            }

            rock-entity-header {
                --attribute-panel-width: 60%;
                --attribute-width: 100%;
                @apply(--rock-entity-manage-header)
            }

            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            #buttonPanel {
                display: inline-block;
            }

            #buttonPanel pebble-button,
            #buttonPanel pebble-toolbar::shadow paper-toolbar {
                display: inline-block;
                vertical-align: middle;
            }

            #buttonPanel pebble-button {
            }

            .flex-end-justified {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            .first-row {
                padding-top: 10px;
                font-size: 14px;
            }

            .right-section {
                text-align: right;
            }

            .right-section pebble-button {
                --pebble-button: {
                    min-width: 2em;
                }
            }

            rock-tabs::shadow .tab-content{
                padding: 10px;
                max-height: 400px;
                overflow-y: scroll;
            }

            #attrName {
                font-size: 12px;
                color: #cacaca;
            }

            #attrVal {
                font-weight: bold;
            }

            #quick-manage-header {
                border-bottom: 1px solid #cacaca;
            }

            pebble-toolbar {
                --pebble-toolbar-button-icon: {
                    padding: 4.5px;
                    border: 0px;
                    min-width: 2.14em;
                    margin: 0px;
                    top: 3px;
                    color: var(--buttontext-color, #616161);
                }
                --pebble-toolbar-menubutton: {
                    border: 0px;
                }
                --pebble-button: {
                    color: var(--palette-kelly-green, #09c021);
                    font-weight: var(--font-medium, 500);
                }
                --pebble-button-iron-icon: {
                    height: 16px;
                    width: 16px;
                    margin-right: 5px;
                }
                --pebble-toolbar-pebble-button-menu-item-icon: {
                    width: 16px;
                    height: 16px;
                }
                --paper-menu-background-color: var(--palette-white, #ffffff);
                --pebble-horizontal-divider-color:var(--buttontext-color, #616161);
            }

            .message {
                font-weight: 500;
                padding: 10px;
                background: #f5f5f5;
                border-radius: 3px;
            }

            pebble-icon[disabled]::shadow iron-icon{
                fill:var(--outer-badge-color, #c1cad4);
            }
            #maximize {
                color: var(--outer-badge-color, #c1cad4);
            }

            pebble-icon::shadow iron-icon {
                height: 14px;
                width: 14px;
            }

            pebble-toolbar::shadow paper-button-group pebble-button::shadow iron-icon,
            pebble-button::shadow iron-icon,
            pebble-toolbar::shadow paper-button-group pebble-button::shadow paper-button {
                width: 16px!important;
                height: 16px!important;
                min-width: 16px;
                margin: 0 2px !important;
            }

            #buttonPanel pebble-button,
            #buttonPanel pebble-toolbar::shadow paper-toolbar::shadow .toolbar-tools,
            #buttonPanel pebble-toolbar::shadow paper-toolbar {
                height: 25px;
                float: left;
                padding: 0px;
            }

            #quick-manage-entity {
                height: 350px;
                @apply(--quick-manage-section);
            }
        </style>
        <div id="quick-manage-header" hidden$="[[!_entityId]]">
            <div class="first-row layout horizontal">
                <div>
                    <span id="attrName">Product</span><br>
                    <span id="attrVal">[[_getEntityDetailsForHeader(selectedEntity, tabConfig)]]</span>
                </div>
                <div class="layout flex right-section">
                    <span id="selected-item">[[_getSelectedItemIndex(currentIndex, totalRecords)]]</span>
                    <span id="previous"><pebble-icon icon="pebble-icons:Up" on-tap="_onTapNavigation" data-args="previous" disabled$="[[_setFlag('previous', currentIndex, totalRecords)]]"></pebble-icon></span>
                    <span id="next"><pebble-icon icon="pebble-icons:Down" on-tap="_onTapNavigation" data-args="next" disabled$="[[_setFlag('next', currentIndex, totalRecords)]]"></pebble-icon></span>
                    <span id="maximize"><pebble-icon icon="pebble-md-icons:Expand" class="tooltip-bottom" data-tooltip="Expand"  on-tap="_onTapMaximize"></pebble-icon></span>
                </div>
            </div>
            <div class="second-row flex-end-justified">
                <div id="buttonPanel">
                    <pebble-button id="pebbleButton" class="iconTextButton" on-click="_openPopover" icon="[[_computeIcon(fixes.completionPercentage)]]"
                        button-text="[[fixes.completionPercentage]]%" class="percentage"></pebble-button>
                    <pebble-popover id="tofixPopover" class="pebble-md-icons" for="pebbleButton" horizontal-align="right" auto-fit-on-attach no-overlap>
                        <rock-entity-tofix data="[[fixes]]"></rock-entity-tofix>
                    </pebble-popover>
                    <pebble-toolbar id="quickManageToolbar" config-data="[[toolbarConfig]]"></pebble-toolbar>                    
                    <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="quickManageToolbar"></bedrock-pubsub>
                </div>
            </div>
        </div>
        <div id="quick-manage-entity" hidden$="[[!_entityId]]">
            <bedrock-pubsub event-name="error-length-changed" handler="_errorLengthChanged"></bedrock-pubsub>
            <rock-tabs id="rockTabs" config="{{tabConfig}}">
            </rock-tabs>
            <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
        </div>
        <div class="message" hidden$="[[_entityId]]">Please select an entity from grid.</div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-entity-quick-manage',

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /*
                     * Indicates the config for tab element
                     */
                    tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    toolbarConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    fixes: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _entityId: {
                        type: String,
                        value: null
                    },

                    _entityType: {
                        type: String,
                        value: null
                    },

                    /**
                     * Indicates current selected item index
                     */
                    currentIndex: {
                        type: Number,
                        value: -1,
                        notify: true
                    },

                    /**
                     * Indicates total count of the records
                     */
                    totalRecords: {
                        type: Number,
                        value: 0
                    },

                    /**
                     * Indicates selected item
                     */
                    selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * Indicates whether to write logs or not.
                     */
                    verbose: {
                        type: Boolean,
                        value: false
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                attached: function() {
                    this.reload();
                },

                reload: function () {
                    this._setHeader();

                    if (this.$$('#rockTabs')) {
                        //Passing true will execute the reload as per configuration
                        this.$$('#rockTabs').reloadCurrentTab(true);
                    }
                },

                _onToolbarEvent: function(e, detail) {
					var event = detail.name;

					switch (event.toLowerCase()) {
						case "refresh":
							this._refreshEvent(e, detail);
							break;
						case "add":
                            this._addEvent(e, detail);
							break;
                        case "delete":
                            this._deleteEvent(e, detail);
							break;
                        case "cut":
                            this._cutEvent(e, detail);
							break;
						default:
							this.fireBedrockEvent("grid-custom-toolbar-event", detail);
							break;
					}
				},
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _deleteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _refreshEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _computeIcon: function (percentage) {
                    var per = Math.round(percentage / 10) * 10;
                    return "pebble-md-icons:Percentage";
                },
                _openPopover: function () {
                    this.$.tofixPopover.show();
                },
                _onTapNavigation: function (e) {
                    var target;
                    if (e.path) {
                        target = e.target;
                    } else {
                        target = e.currentTarget;
                    }
                    var eventName = 'on-tap-' + target.attributes["data-args"].value;
                    this.fireBedrockEvent(eventName, {
                        data: this.currentEntityIndex
                    });
                },
                _onTapMaximize: function () {
                    if (this._entityId) {
                        document.querySelector("main-app").set('pageRoute.__queryParams', {
                            "id": this._entityId,
                            "type": this._entityType
                        });
                        document.querySelector("main-app").changePageRoutePath("entity-manage");
                    }
                },
                _getSelectedItemIndex: function () {
                    if (this.currentIndex == -1 && this.totalRecords == 0) {
                        return "";
                    } else {
                        return (this.currentIndex + 1) + " - " + this.totalRecords;
                    }
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.name.indexOf("attribute") != -1 && component.properties) {
                        // Set attribute names to context
                        var _contextData = DataHelper.cloneObject(this.contextData);
                        var itemContext = DataHelper.cloneObject(this.getFirstItemContext());

                        if(itemContext)
                        {
                             itemContext.attributeNames = component.properties["config-context"].attributeNames;
                             _contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                        }

                        component.properties['context-data'] = _contextData;
                    }
                },
                _setHeader: function () {
                    var dataContext = this.getFirstDataContext();
                    var itemContext = this.getFirstItemContext();

                    this._entityId = itemContext.id;
                    this._entityType = itemContext.type;
                },

                _errorLengthChanged: function (e, detail) {
                    this.$$('#rockTabs')._currentTabErrorLength = detail;
                },
                _setFlag: function (nav) {
                    if (nav == "previous" && this.currentIndex == 0) {
                        return true;
                    } else if (nav == "next" && this.currentIndex == (this.totalRecords - 1)) {
                        return true;
                    }

                    return false;
                },
                _getEntityDetailsForHeader: function () {
                    if (this.selectedEntity && this.selectedEntity.attributes && this.tabConfig.tabItems) {
                        var arrtName = this.tabConfig.tabItems[0].component.properties["config-context"].attributeNames[
                            0];
                        if (this.selectedEntity.attributes[arrtName]) {
                            return this.selectedEntity.attributes[arrtName].value;
                        }

                        return "";
                    }
                }
            });
        })();
    </script>
</dom-module>