<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../rock-entity-quick-manage-elements/rock-entity-quick-manage-elements.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-entity-quick-manage">
    <template>
        <style include="iron-flex bedrock-style-common">
            :host{
                display:block;
                height:100%;
            }
            .thumb-image {
                width: 50px;
                height: 50px;
            }
            .product-head {
                padding-left: 5px;
                font-size: 13px;
                color: var(--palette-cloudy-blue, #c1cad4);
            }
            .product-name {
                padding-left: 5px;
                font-weight: var(--font-bold, bold);
            }
            .product-right {
                text-align: right;
            }
            rock-entity-header {
                --attribute-panel-width: 60%;
                --attribute-width: 100%;
                @apply --rock-entity-manage-header;
            }
            .trim {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }
            .first-row {
                padding-top: 10px;
                font-size: var(--default-font-size, 14px);
            }
            .right-section {
                text-align: right;
            }
            .right-section pebble-button {
                --pebble-button: {
                    min-width: 2em;
                }
            }            
            #attrName {
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-cloudy-blue, #c1cad4);
            }
            #attrVal {
                font-weight: var(--font-bold, bold);
            }
            #quick-manage-header {
                border-bottom: 1px solid var(--palette-cloudy-blue, #c1cad4);
                @apply  --quick-manage-header;
            } 
            #maximize {
                color: var(--icon-color, #757575);
                padding: 0 5px;
            } 
           
            #quick-manage-entity {
                position: relative;
                height:100%;
            }
            #tofixPopover {
                padding: 5px 0px;
            }
           
            #previous {
                padding: 0px 5px;
            }
            #next {
                padding: 0px 0px 0px 5px;
            }             
            rock-tabs {
                --rock-tab-content: {
                    overflow-y:auto;
                    overflow-x:hidden;
                    padding: 10px;
                };
                --default-button-container:{
                    position: relative;
                    bottom: 20px;
                };
                --rock-attribute-manage:{
                    position: relative;
                    display: block;
                    height: calc(100% - 20px);
                };
                --rock-attribute-list-container:{
                    padding:0px 0px 20px 0px;
                }
            }            
            #selected-item {
                font-size: var(--font-size-sm, 12px);
                color: var(--primary-icon-color, #75808b);
            }
        </style> 
        <div class="base-grid-structure"> 
            <div class="base-grid-structure-child-1">
                <div id="quick-manage-header"  hidden$="[[!_showComponent(selectedEntity,_entityId)]]">
                    <div class="first-row layout horizontal">
                        <template is="dom-if" if="[[!noHeader]]">
                            <div>
                                <span id="attrName">Product</span><br>
                                <span id="attrVal">[[_getEntityDetailsForHeader(selectedEntity, tabConfig)]]</span>
                            </div>
                        </template>
                        <div class="layout flex right-section">
                            <span id="selected-item">[[_getSelectedItemIndex(currentIndex, currentRecordSize)]]</span>
                            <span id="previous"><pebble-icon icon="pebble-icon:navigation-action-up" class="pebble-icon-size-14" on-tap="_onTapNavigation" data-args="previous" disabled$="[[_setFlag('previous', currentIndex, currentRecordSize)]]"></pebble-icon></span>
                            <span id="next"><pebble-icon icon="pebble-icon:navigation-action-down" class="pebble-icon-size-14 m-r-5" on-tap="_onTapNavigation" data-args="next" disabled$="[[_setFlag('next', currentIndex, currentRecordSize)]]"></pebble-icon></span>

                            <template is="dom-if" if="[[showExpandIcon]]">
                                <span id="maximize"><pebble-icon icon="pebble-icon:window-action-expand" class="tooltip-bottom pebble-icon-size-14" data-tooltip="Expand"  on-tap="_onTapMaximize"></pebble-icon></span>
                            </template>
                        </div>
                        <div id="buttonPanel">
                            <pebble-toolbar id="quickManageToolbar" config-data="[[toolbarConfig]]"></pebble-toolbar>
                            <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="quickManageToolbar"></bedrock-pubsub>
                        </div>
                    </div>
                </div>
            </div>
            <div class="base-grid-structure-child-2">
                <template is="dom-if" if="[[_showComponent(selectedEntity,_entityId)]]">
                    <div id="quick-manage-entity">
                        <bedrock-pubsub event-name="error-length-changed" handler="_errorLengthChanged"></bedrock-pubsub>
                            <rock-tabs id="rockTabs" readonly="[[readonly]]" config="{{tabConfig}}">
                            </rock-tabs>
                        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
                    </div>
                </template>
            </div>
        </div>
        
        <div class="default-message" hidden$="[[_showComponent(selectedEntity,_entityId)]]">
            <span>[[_errorMessage]]</span>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-entity-quick-manage',

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false		
                    },
                    /*
                     * Indicates the configuration for the "tab" element.
                     */
                    tabConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    toolbarConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    fixes: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _entityId: {
                        type: String,
                        value: null
                    },

                    _entityType: {
                        type: String,
                        value: null
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    showExpandIcon: {
                        type: Boolean,
                        value: true
                    },

                    /**
                     * Indicates the index for the currently selected item.
                     */
                    currentIndex: {
                        type: Number,
                        value: -1,
                        notify: true
                    },

                    /**
                     * Indicates the total count of the records.
                     */
                    currentRecordSize: {
                        type: Number,
                        value: 0
                    },

                    /**
                     * Indicates the selected item.
                     */
                    selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * Specifies whether or not to to write the logs.
                     */
                    verbose: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    noHeader: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Specifies whether we are showing entity attributes or relationship attributes. Possible values: 'default', 'relationship'.
                     */
                    dataObjectType: {
                        type: String,
                        value: "default"
                    },
                    _errorMessage: {
                        type: String,
                        value: "Loading..."
                    },
                    //When QM is for relationship
                    relationship: {
                        type: String
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],

                observers: [
                    '_onContextDataChange(contextData.*)'
                ],

                _onContextDataChange: function() {
                    if(!_.isEmpty(this.contextData)) {
                        var context = DataHelper.cloneObject(this.contextData);

                        var config = "rock-entity-quick-manage";
                        if(this._isRelMode(this.dataObjectType)) {
                            if(this.relationship) {
                                var itemContext = ContextHelper.getFirstItemContext(context);
                                if(!_.isEmpty(itemContext)) {
                                    itemContext.relationship = this.relationship;
                                } else {
                                    context[ContextHelper.CONTEXT_TYPE_ITEM] = [{
                                        "relationship": this.relationship
                                    }];
                                }
                            }
                            config = "rock-entity-relationship-quick-manage";
                        }

                        this.requestConfig(config, context);
                    }
                },

                onConfigLoaded: function(componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        //set tabConfig                        
                        var tabConfig = componentConfig.config.tabConfig;

                        //Should come from configuration, delete it once nearest get is enabled (Enable below stmt for reference-discovery testing)
                        //tabConfig.tabItems.attributes.component.properties["config-context"].attributeNames = ["_ALL"];

                        tabConfig.tabItems = DataHelper.convertObjectToArray(tabConfig.tabItems);
                        this.tabConfig = tabConfig;

                        //set toolbarConfig
                        var toolbarConfig = componentConfig.config.toolbarConfig;
                        var buttonItems = DataHelper.convertObjectToArray(toolbarConfig.buttonItems);
                        for(var i = 0; i < buttonItems.length; i++) {
                            buttonItems[i].buttons = DataHelper.convertObjectToArray(buttonItems[i].buttons);
                        }
                        this.toolbarConfig = {"buttonItems": buttonItems};

                        this.reload();
                    }
                },

                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                reload: function () {
                    this._setHeader();
                    if(this.getIsDirty()){
                        if(window.confirm("There are unsaved changes. Do you want to discard the changes?")) {
                            this._reloadTab();
                        }
                    }else{
                        this._reloadTab();
                    }
                },

                _reloadTab: function(){
                    const tabs = this.shadowRoot.querySelector('#rockTabs');
                    if (this._entityId && tabs) {
                        tabs.readyToRender(true);
                        tabs.reloadCurrentTab(true);
                    }
                },

                reset: function(){
                    this.set("tabConfig", {});
                    this.set("toolbarConfig", {});
                    this.currentIndex = -1;
                    this._setHeader();
                    const tabs = this.shadowRoot.querySelector('#rockTabs');
                    if (this._entityId && tabs) {
                        //Passing true will execute the reload as per configuration
                        tabs.reset();
                    }
                },
                reloadHeader: function(){
                    this._setHeader();
                },
                
                getIsDirty: function () {
                    var tabs = this.$$("#rockTabs");
                    if (tabs && tabs.getIsDirty) {
                        return tabs.getIsDirty();
                    }
                },                
                _onToolbarEvent: function (e, detail) {
                    var event = detail.name;

                    switch (event.toLowerCase()) {
                        case "refresh":
                            this._refreshEvent(e, detail);
                            break;
                        case "add":
                            this._addEvent(e, detail);
                            break;
                        case "delete":
                            this._deleteEvent(e, detail);
                            break;
                        case "cut":
                            this._cutEvent(e, detail);
                            break;
                        case "edit":
                            this._editEvent(e, detail);
                            break;
                        default:
                            this.fireBedrockEvent("grid-custom-toolbar-event", detail);
                            break;
                    }
                },
                _addEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _deleteEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _cutEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _editEvent: function (e, detail, sender) {
                    alert("event triggered: " + detail.name);
                },
                _refreshEvent: function (e, detail, sender) {
                    this.reload();
                },
                _computeIcon: function (percentage) {
                    var per = Math.round(percentage / 10) * 10;
                    return "pebble-icon:percentage-circle";
                },
                _openPopover: function () {
                    this.$.tofixPopover.show();
                },
                _onTapNavigation: function (e) {
                    var target;
                    if (e.path) {
                        target = e.target;
                    } else {
                        target = e.currentTarget;
                    }
                    var eventName = 'on-tap-' + target.attributes["data-args"].value;
                    this.fireBedrockEvent(eventName, {
                        data: this.currentEntityIndex
                    });
                },
                _onTapMaximize: function () {
                    if (this._entityId) {
                        var params = {
                            "id": this._entityId,
                            "type": this._entityType
                        };
                        ComponentHelper.appRoute("entity-manage", params);
                    }
                },
                _getSelectedItemIndex: function () {
                    if (this.currentIndex == -1 && this.currentRecordSize == 0) {
                        return "";
                    } else {
                        return (this.currentIndex + 1) + " - " + this.currentRecordSize;
                    }
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.name.indexOf("attribute") != -1 && component.properties) {
                        // Set attribute names to context
                        var _contextData = DataHelper.cloneObject(this.contextData);
                        var itemContext = ContextHelper.getFirstItemContext(_contextData);

                        if (itemContext && component.properties["config-context"]) {
                            itemContext.attributeNames = component.properties["config-context"].attributeNames;
                            itemContext.relationshipAttributes = component.properties["config-context"].relationshipAttributes;
                            _contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                        }
                        component.properties['context-data'] = _contextData;
                    }
                },
                _setHeader: function () {
                    var itemContext = this.getFirstItemContext();
                    if (itemContext) {
                        if (this.dataObjectType == "relationship") {
                            var relationshipAttribute = itemContext.relationshipAttributes
                            //TODO: Verify below bug fix and fix it again in devline
                            //var relAttrFromConfig = this._getRelationshipAttributesFromConfig();
                            //relationshipAttribute = relationshipAttribute.concat(relAttrFromConfig);

                            if(relationshipAttribute && relationshipAttribute.length == 0 && !_.isEmpty(this.selectedEntity)){
                                this.set('_errorMessage', "Attributes are not available for this relationship.");
                            }else if(this.selectedEntity == null || _.isEmpty(this.selectedEntity)){
                                this.set('_errorMessage', "Please select a relationship from grid.");
                            }else{
                                this._entityId = itemContext.relationshipId;
                                this._entityType = this.selectedEntity.type;
                            }
                        } else {
                            this.set('_errorMessage', "Please select an entity from grid.");
                            this._entityId = itemContext.id;
                            this._entityType = itemContext.type;

                            if(this.tabConfig && this.tabConfig.tabItems && this.tabConfig.tabItems.length > 0){
                                var tabItem = this.tabConfig.tabItems[0];
                                if(tabItem && tabItem.component && tabItem.menuProviderComponent){
                                    tabItem.component.properties["context-data"] = this.contextData;
                                }
                            }
                        }
                    }
                },

                _getRelationshipAttributesFromConfig: function() {
                    if (this.tabConfig && this.tabConfig.tabItems) {
                        var relAttributes = this.tabConfig.tabItems.find(function (item) {
                            if (item.name == "relationshipAttributes") {
                                return item;
                            }
                        });

                        if (relAttributes.component &&
                            relAttributes.component.properties &&
                            relAttributes.component.properties["config-context"]) {
                            return relAttributes.component.properties["config-context"].relationshipAttributes;
                        }
                    }
                },

                _errorLengthChanged: function (e, detail) {
                    this.shadowRoot.querySelector('#rockTabs')._currentTabErrorLength = detail;
                },
                _setFlag: function (nav) {
                    if (nav == "previous" && this.currentIndex == 0) {
                        return true;
                    } else if (nav == "next" && this.currentIndex == (this.currentRecordSize - 1)) {
                        return true;
                    }

                    return false;
                },
                _getEntityDetailsForHeader: function () {
                    if (this.selectedEntity && this.selectedEntity.attributes && this.tabConfig.tabItems) {
                        var configContext = this.tabConfig.tabItems[0].component.properties[
                            "config-context"];
                        if (!_.isEmpty(configContext)) {
                            var arrtName = this.tabConfig.tabItems[0].component.properties[
                                "config-context"].attributeNames[
                                0];
                            if (this.selectedEntity.attributes[arrtName]) {
                                return this.selectedEntity.attributes[arrtName].value;
                            }
                        }
                        return "";
                    }
                },
                refresh: function (){
                    this._refreshEvent();

                },
                _showComponent: function(selectedEntity, entityId) {
                    if(!_.isEmpty(selectedEntity) || entityId == "-1") {
                        return true;
                    }

                    return false;
                },
                _isRelMode:function () {
                    return this.dataObjectType == "relationship";
                }
            });
        })();
    </script>
</dom-module>
