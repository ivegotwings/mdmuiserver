<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">

<dom-module id="rock-bulk-edit-grid">
    <template>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <attribute-model-datasource id="attributeModelDataSource" mode="self" request="[[requestData]]" r-data-formatter="[[_dataFormatter]]" schema="grid">
        </attribute-model-datasource>
        <liquid-entity-model-get id="getAttributeModels" operation="getbyids" request-id="getAttributeModelsReq" request-data="[[request]]"
            on-response="_onAttributeModelsReceived" on-error="_onAttributeModelsGetFailed"></liquid-entity-model-get>
        <rock-grid id="attributeModelGrid" no-header config="[[config]]" data="[[_gridData]]" page-size="200" max-configured-count="200" selected-items="[[selectedItems]]"></rock-grid>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-bulk-edit-grid",

                prperties: {
                    config: {
                        type: Object,
                        value: function () { 
                            return {}; 
                        }
                    },
                    requestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _dataFormatter: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedItems: {
                        type: Array,
                        value: function () { return[]; }
                    },
                    _gridData: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },
                     _loading: {
                        type: Boolean,
                        value: false
                    },
                    editRelationshipAttributesOnly: {
                        type: Boolean,
                        value: false
                    },
                    editAttributesOnly: {
                        type: Boolean,
                        value: false
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_getAttributeModels(contextData)'
                ],
                ready: function () {
                    this._dataFormatter = this._getAttributeFormattedData.bind(this);
                    this.logInfo("AttributeModelReady","id",this.idField,"requestData",JSON.stringify(this.requestData));
                },
                _getAttributeModelGrid: function () {
                    return ElementHelper.getElement(this, "#attributeModelGrid");
                },
                _getAttributeModelDataSource: function () {
                    return this.shadowRoot.querySelector('#attributeModelDataSource');
                },
                _getAttributeModels: function (contextData) {
                    if (!_.isEmpty(this.contextData)) {
                        this._loading = true;

                        var attributeModelDataSource = this._getAttributeModelDataSource();
                        var contextData = DataHelper.cloneObject(this.contextData);
                        if (this.contextData.ItemContexts) {

                            var index = 0;
                            for(var i=0; i < contextData.ItemContexts.length; i++){
                                if(contextData.ItemContexts[i].type){
                                    index++;
                                }
                            }
                            this._currentIndex = index;
                            this._currentItems = [];
                            this._notFoundEntityTypes = [];
                        }

                        if (contextData && contextData.ItemContexts) {
                            for (var i = 0; i < this.contextData.ItemContexts.length; i++) {

                                contextData.ItemContexts = [this.contextData.ItemContexts[i]];
                                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
                                    contextData);
                                
                                if(this.editAttributesOnly) {
                                    compositeModelGetRequest.params.fields.attributes = compositeModelGetRequest.params.fields.attributes ? compositeModelGetRequest.params.fields.attributes : ["_ALL"]
                                    compositeModelGetRequest.params.fields.relationships = undefined;
                                    compositeModelGetRequest.params.fields.relationshipAttributes = undefined;
                                }

                                if(this.editRelationshipAttributesOnly) {
                                    compositeModelGetRequest.params.fields.attributes = undefined;
                                    compositeModelGetRequest.params.fields.relationships = compositeModelGetRequest.params.fields.relationships ? compositeModelGetRequest.params.fields.relationships : ["_ALL"];
                                    compositeModelGetRequest.params.fields.relationshipAttributes = compositeModelGetRequest.params.fields.relationshipAttributes ? compositeModelGetRequest.params.fields.relationshipAttributes : ["_ALL"];
                                }
                                
                                this.set('requestData', compositeModelGetRequest);

                                if(attributeModelDataSource) {
                                    attributeModelDataSource.reTriggerRequest();
                                }
                            }
                        }
                    }

                },
                _getAttributeFormattedData: function (data, requestData) {
                    if (data && data.content && data.content.entityModels) {
                        var attributeModels = DataTransformHelper.transformAttributeModels(data.content.entityModels[0], this.contextData);
                        var relationshipModels = DataTransformHelper.transformRelationshipModels(data.content.entityModels[0], this.contextData);
                        var relationshipAttributeModels = {};
                        if (!_.isEmpty(attributeModels)) {
                            if (this._currentIndex == 1) {
                                this._currentItems = [];
                            }
                            this.push('_currentItems', attributeModels);
                        }

                        if (!_.isEmpty(relationshipModels)) {
                            var relType = requestData.params.fields.relationships[0];
                            var rel = relationshipModels[relType] && relationshipModels[relType].length ? relationshipModels[relType][0] : undefined;
                            relationshipAttributeModels = DataTransformHelper.transformRelationshipAttributeModels(rel, this.contextData, true);
                            if (this._currentIndex == 1) {
                                this._currentItems = [];
                            }
                            this.push('_currentItems', relationshipAttributeModels);
                        }

                        if ((!attributeModels || _.isEmpty(attributeModels)) && (!relationshipAttributeModels || _.isEmpty(relationshipAttributeModels)) && DataHelper.isValidObjectPath(requestData, "params.query.name")) {
                            this._notFoundEntityTypes.push(requestData.params.query.name);
                        }

                        var responseLength = this._currentItems.length + this._notFoundEntityTypes.length;

                        if (responseLength == this._currentIndex) {
                            var compositeModels = [];
                            for(var i=0; i<this._currentItems.length; i++) {
                                var currentItem = this._currentItems[i];
                                var keys = Object.keys(currentItem);
                                if(keys && keys.length > 0) {
                                    for(var j=0; j<keys.length; j++) {
                                        var key = keys[j];
                                        if(!(compositeModels.find(obj => obj.name === key))) {
                                            compositeModels.push(currentItem[key]);
                                        }
                                    }
                                }
                            }

                            this.set("_gridData", compositeModels);
                            this._loading = false;
                            if (this._notFoundEntityTypes && this._notFoundEntityTypes.length) {
                                var messageContent = this._notFoundEntityTypes.join(", ");
                                this.logError("rock-bulk-edit-grid - Attribute models not found for entity type(s) " + messageContent);
                                this.showErrorToast("Attribute models not found for entity type(s) " + messageContent + ". Please contact administrator.");
                            }
                        }
                    }
                },
                
                getSelectedItems: function () {
                    var grid = this._getAttributeModelGrid();
                    return grid.getSelectedItems();
                },

                reRenderGrid: function() {
                    var grid = this._getAttributeModelGrid();
                    grid.reRenderGrid();
                },
                
                clearSelection: function() {
                    var grid = this._getAttributeModelGrid();
                    grid.clearSelection();
                },
                getData: function() {
                    return this._gridData;
                },
                deselectItem: function(item) {
                    var grid = this._getAttributeModelGrid();
                    grid.deselectItem(item);
                },
                selectItems: function(items) {
                    if(!_.isEmpty(items)) {
                        for(var i=0; i<items.length; i++) {
                            this.selectItem(items[i]);
                        }
                    }
                },
                selectItem: function(item) {
                    var grid = this._getAttributeModelGrid();
                    grid.selectItem(item);
                }
            });
        })();
    </script>
</dom-module>