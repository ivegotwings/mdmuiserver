<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>

<link rel="import" href="../rock-wizard/rock-wizard.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">


<!--
`rock-business-function-dialog` Represents a component that 
renders the "rock-wizard" component in a dialog along with the functionalities of 
business function framework.

@demo demo/index.html
-->

<dom-module id="rock-business-function-dialog">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            pebble-dialog {
                @apply --dialog-component;
                --pebble-grid-container:{
                    margin-left:0px;
                    margin-right:0px;
                }
                --pebble-grid-container-header:{
                    padding:0px;
                }
                --rock-search-bar:{
                    margin-bottom:10px;
                }
                --dialog-component:{
                    overflow: visible;
                }
            }

            rock-wizard {
                --wizard-container: {
                    margin: 0!important;
                }
                --entity-create-action-button:{
                    position: relative;
                    bottom: 0px;
                    left:0px;
                    text-align: center;
                    z-index: 99;
                    -webkit-transform: translateX(0%);
                    -moz-transform: translateX(0%);
                    -o-transform: translateX(0%);
                    transform: translateX(0%);
                }
            }
        </style>
        <div id="stepProviders"></div>
        <pebble-dialog id="businessFunctionDialog" modal horizontal-align="auto" vertical-align="auto" show-close-icon no-cancel-on-outside-click
            no-cancel-on-esc-key dialog-title="[[title]]">
            <div style="height:85vh;overflow-y: auto;overflow-x:hidden;">
                <template is="dom-if" if="{{isConfigLoaded(config)}}" restamp>
                    <rock-wizard config="{{wizardConfig}}" readonly="[[readonly]]" shared-data="{{sharedData}}" on-first-step-cancelled="_onFirstStepCancelled" on-next-step="_onNextStep" on-cancel-event = "_onCancel" hide-stepper="[[hideStepper]]" no-steps="[[noSteps]]" no-data-message="[[noDataMessage]]"></rock-wizard>
                </template>
            </div>
        </pebble-dialog>
        <bedrock-pubsub on-bedrock-event-business-dialog-opened="_onOpenBusinessFunctionDialog" name="bedrock-event-business-dialog-opened"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-business-function-dialog',
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.BusinessFunctionBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],
                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    config: {
                        type: Object,
                        value: function () { return {}; },
                        observer: '_setLabelAsTitle'
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false		
                    },
                    title: {
                        type: String,
                        value: function () { return ""; }
                    },
                    dialog: {
                        type: Object
                    },
                    subName: {
                        type: String
                    },
                    contextData: {
                        type:Object
                    },
                    hideStepper: {
                        type: Boolean
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                attached: function () {
                    RUFUtilities.activeBusinessFunctionDialog = this;
                    this.dialog = this.shadowRoot.querySelector("#businessFunctionDialog");
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                open: function () {
                    this.config = {};
                    if(!_.isEmpty(this.contextData)) {
                        var context = DataHelper.cloneObject(this.contextData);
                          //App specific
                          var appName = ComponentHelper.getCurrentActiveAppName();
                          if(appName) {
                              context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                  "app": appName
                              }];
                          }
                          this.requestConfig(this.name, context);
                    }
                    
                },
                onConfigLoaded: function (componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        var config = componentConfig.config;
                        this.set("noSteps", false);
                        if(config.hideStepper){
                            this.hideStepper = config.hideStepper;
                        }
                        
                        if(this.subName){
                            if(config[this.subName]){
                                config = config[this.subName];
                            }
                        }
                        if(config.wizardConfig){
                            var steps = DataHelper.convertObjectToArray(config.wizardConfig.steps);
                            config.wizardConfig.steps = steps;
                            config=config.wizardConfig;
                        }
                        else if(config.steps){ 
                            var steps = DataHelper.convertObjectToArray(config.steps);
                            config.steps = steps;
                        } else {
                            this.set("noSteps", true);
                        }
                        this.config = config;
                        this.dialog.open();
                    }
                },
                isConfigLoaded:function(){
                    if(this.config && !_.isEmpty(this.config)){
                        return true;
                    }else{
                        return false;
                    }
                },
                _closeDialog:function(){
                    this.config = {};
                    this.dialog.close();
                },
                _onFirstStepCancelled: function () {
                    this._closeDialog(); 
                },
                _onCancel: function () {
                    this._closeDialog(); 
                },
                _onNextStep: function (e, detail) {
                    if (detail) {
                        if (detail.dataRoute && detail.dataRoute != "") {
                            this._closeDialog(); 
                            var mainApp = RUFUtilities.mainApp;
                            if (!detail.queryParams) {
                                detail.queryParams = {};
                            }
                            ComponentHelper.setQueryParamsWithoutEncode(detail.queryParams);
                            mainApp.changePageRoutePath(detail.dataRoute, detail.action);
                        } else {
                            if (detail.action) {
                                ComponentHelper.fireBedrockEvent(detail.action.name, detail.action, { ignoreId: true });
                            }
                            if (detail.closeBusinessFunction) {
                                this._closeDialog(); 
                            }
                        }
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                getTitle: function () {
                    return this.config.label;
                },

                getControlIsDirty: function () {
                    var dialog = this.$$('#businessFunctionDialog');
                    if (dialog && dialog.getControlIsDirty) {
                        return dialog.getControlIsDirty();
                    }
                },

                _setLabelAsTitle: function () {
                    if(this.sharedData && this.sharedData.title){
                        this.setTitle(this.sharedData.title);
                    }
                    else{
                        if (this.config && this.config.label) {
                            this.setTitle(this.config.label);
                        }
                    }

                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                setTitle: function (title) {
                    this.set("title", title);
                },

                _onOpenBusinessFunctionDialog(e) {
                    if(!e || !e.detail) return;
    
                    const { 
                        name, 
                        title, 
                        subName,
                        configName, 
                        mergeTitle,
                        sharedData,
                        contextData,
                        noDataMessage
                    } = e.detail;
                    
                    this.name = name;
                    this.configName = configName;
                    this.subName = subName;
                    this.contextData = contextData;
                    this.sharedData = sharedData;
                    this.noDataMessage = noDataMessage || "";
                    
                    if(title) {
                        const _title = mergeTitle ? `${this.getTitle()} - ${title}` : title;
    
                        this.setTitle(_title);
                    }
    
                    this.open();
                }
            });
        })();
    </script>
</dom-module>