<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>

<link rel="import" href="../rock-wizard/rock-wizard.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">


<!--
`rock-business-function-dialog` Represents a component that 
renders the "rock-wizard" component in a dialog along with the functionalities of 
business function framework.

@demo demo/index.html
-->

<dom-module id="rock-business-function-dialog">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            pebble-dialog {
                @apply --dialog-component;
                --pebble-grid-container:{
                    margin-left:0px;
                    margin-right:0px;
                }
                --pebble-grid-container-header:{
                    padding:0px;
                }
                --rock-search-bar:{
                    margin-bottom:10px;
                }
            }

            rock-wizard {
                --wizard-container: {
                    margin: 0!important;
                }

                --rock-attribute-list-content: {
                    max-height: calc(85vh - 170px);
                }
            }
        </style>
        <div id="stepProviders"></div>
        <pebble-dialog id="businessFunctionDialog" modal horizontal-align="auto" vertical-align="auto" show-close-icon no-cancel-on-outside-click
            no-cancel-on-esc-key dialog-title="[[title]]" o>
            <div style="max-height:85vh;overflow-y: auto;overflow-x:hidden">
                <rock-wizard config="{{wizardConfig}}" readonly$="[[readonly]]" shared-data="{{sharedData}}" on-first-step-cancelled="_onFirstStepCancelled" on-next-step="_onNextStep" on-cancel-event = "_onCancel"></rock-wizard>
            </div>
        </pebble-dialog>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-business-function-dialog',
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.BusinessFunctionBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],
                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    config: {
                        type: Object,
                        value: function () { return {}; },
                        observer: '_setLabelAsTitle'
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false		
                    },
                    title: {
                        type: String,
                        value: function () { return ""; }
                    },
                    dialog: {
                        type: Object
                    },
                    configName: {
                        type: String
                    },
                    contextData: {
                        type:Object
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                attached: function () {
                    this.dialog = this.shadowRoot.querySelector("#businessFunctionDialog");
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                open: function () {
                    this.config = {};
                    //only name will be there
                    //this.config = this.configName ? this.getParentAppConfig(this.name, '', this.configName) : this.getParentAppConfig(this.name);
                    if(!_.isEmpty(this.contextData)) {
                        var context = DataHelper.cloneObject(this.contextData);
                          //App specific
                          var appName = ComponentHelper.getCurrentActiveAppName();
                          if(appName) {
                              context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                  "app": appName
                              }];
                          }
                          this.requestConfig(this.name, context);
                    }
                    
                },
                onConfigLoaded: function (componentConfig) {
                    if(componentConfig && componentConfig.config) {
                        var config = componentConfig.config;
                        if(this.configName){
                            if(config[this.configName]){
                                config = config[this.configName];
                            }
                            
                        }
                        if(config.steps){
                            var steps = DataHelper.convertObjectToArray(config.steps);
                            config.steps = steps;
                        }
                        this.config = config;
                        this.dialog.open();
                    }
                },
                _onFirstStepCancelled: function () {
                    this.dialog.close();
                },
                _onCancel: function () {
                    this.dialog.close();
                },
                _onNextStep: function (e, detail) {
                    if (detail) {
                        if (detail.dataRoute && detail.dataRoute != "") {
                            this.dialog.close();
                            var mainApp = document.querySelector("main-app");
                            if (!detail.queryParams) {
                                detail.queryParams = {};
                            }
                            ComponentHelper.setQueryParamsWithoutEncode(detail.queryParams);
                            mainApp.changePageRoutePath(detail.dataRoute, detail.action);
                        } else {
                            if (detail.action) {
                                this.fireBedrockEvent(detail.action.name, detail.action);
                            }
                            if (detail.closeBusinessFunction) {
                                this.dialog.close();
                            }
                        }
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                getTitle: function () {
                    return this.config.label;
                },

                getControlIsDirty: function () {
                    var dialog = this.$$('#businessFunctionDialog');
                    if (dialog && dialog.getControlIsDirty) {
                        return dialog.getControlIsDirty();
                    }
                },

                _setLabelAsTitle: function () {
                    if (this.config && this.config.label) {
                        this.setTitle(this.config.label);
                    }

                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                setTitle: function (title) {
                    this.set("title", title);
                }
            });
        })();
    </script>
</dom-module>