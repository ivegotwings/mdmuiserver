<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-base-behavior/liquid-base-behavior.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<!--
`liquid-dataobject-preload`

@demo demo/index.html 
-->
<dom-module id="liquid-dataobject-preload">
    <template>
        <liquid-config-get id="liquidConfigGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onResponse"
            on-error="_onError"></liquid-config-get>
        <liquid-entity-model-composite-get id="liquidEntityModelCompositeGet" $verbose="[[verbose]]" operation="getbyids" on-entity-model-composite-get-response="_onResponse"
            on-error="_onError"></liquid-entity-model-composite-get>
        <liquid-entity-model-get id="liquidEntityModelGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onResponse"
            on-error="_onError"></liquid-entity-model-get>
        <liquid-entity-data-get id="liquidEntityDataGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onResponse"
            on-error="_onError"></liquid-entity-data-get>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-dataobject-preload',
                behaviors: [RUFBehaviors.LiquidBaseBehavior],
                attached: function () {
                },
                ready: function () {
                },
                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    preLoadConfig: {
                        type: Object,
                        value: function () {
                            return {
                                "preLoadConfig": {
                                    "aggregateConfig": {
                                        "byContext": [
                                            {"appName": "main-app", "contextData": {'ItemContexts': []}},
                                            {"appName": "app-dashboard", "contextData": {'ItemContexts': []}},
                                            {"appName": "app-entity-discovery", "contextData": {'ItemContexts': []}},
                                            {"appName": "app-entity-manage", "contextData": {'ItemContexts': [{'entityType': 'sku'}]}},
                                            {"appName": "app-business-function", "contextData": {'ItemContexts': [{'entityType': 'sku'}]}}
                                        ]
                                    },
                                    "entityCompositeModel": {
                                         "byNames": ["sku", "lot"]
                                    } //,
                                    // "config": {
                                    //     "bySearch": ["savedsearch", "workflowSavedSearch"]
                                    // },
                                    // "entityModel": {
                                    //     "bySearch": ["businessCondition", "businessRule", "workflowDefinition", "workflowDefinitionMappings", "ruleContextMappings"]
                                    // },
                                    // "entity": {
                                    //     "bySearch": ["classification", "color", "size"]
                                    // }
                                }
                            };
                        }
                    },
                    requestTrackerTemplate: {
                        "type": Object,
                        "value": function () {
                            return {
                                "all": {
                                    "startTime": "",
                                    "total": 0,
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0,
                                    "timeTaken": 0,
                                    "progress": 0
                                },
                                "aggregateConfig": {
                                    "startTime": "",
                                    "total": 0,
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0,
                                    "timeTaken": 0,
                                    "progress": 0
                                },
                                "config": {
                                    "startTime": "",
                                    "total": 0,
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0,
                                    "timeTaken": 0,
                                    "progress": 0
                                },
                                "entityCompositeModel": {
                                    "startTime": "",
                                    "total": 0,
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0,
                                    "timeTaken": 0,
                                    "progress": 0
                                },
                                "entityModel": {
                                    "startTime": "",
                                    "total": 0,
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0,
                                    "timeTaken": 0,
                                    "progress": 0
                                },
                                "entity": {
                                    "startTime": "",
                                    "total": 0,
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0,
                                    "timeTaken": 0,
                                    "progress": 0
                                }
                            };
                        }
                    },
                    requestTracker: {
                        "type": Object,
                        "value": function () {
                            return {};
                        }
                    }
                },
                generateRequest: function () {
                    if (!this._validate(this.requestData)) {
                        return;
                    }

                    this.requestTracker = DataHelper.cloneObject(this.requestTrackerTemplate);

                    var requests = this.prepareRequests();
                    
                    var liquidConfigGet = this.$$('#liquidConfigGet');
                    var liquidEntityModelCompositeGet = this.$$('#liquidEntityModelCompositeGet');
                    var liquidEntityModelGet = this.$$('#liquidEntityModelGet');
                    var liquidEntityDataGet = this.$$('liquidEntityDataGet');

                    for (var requestId in requests) {
                        var request = requests[requestId];

                        var operation = request.operation;
                        var requestData = request.requestData;
                        var contextData = request.contextData;
                                
                        switch (request.type) {
                            case "aggregateConfig": {
                                var liquidConfigAggregateGet = document.createElement("liquid-config-aggregate-get");
                                liquidConfigAggregateGet.name = requestData.appName + DataHelper.getRandomString();
                                liquidConfigAggregateGet.addEventListener("config-get-response", this._onResponse.bind(this));
                                liquidConfigAggregateGet.addEventListener("error", this._onError.bind(this));
                                liquidConfigAggregateGet.appName = requestData.appName;
                                liquidConfigAggregateGet.contextData = contextData;
                                liquidConfigAggregateGet.refresh();
                                break;
                            }
                            case "configGet": {
                                liquidConfigGet.operation = operation;
                                liquidConfigGet.requestData = requestData;
                                liquidConfigGet.contextData = contextData;
                                liquidConfigGet.generateRequest();
                                break;
                            }
                            case "entityCompositeModel": {
                                liquidEntityModelCompositeGet.operation = operation;
                                liquidEntityModelCompositeGet.requestData = requestData;
                                liquidEntityModelCompositeGet.generateRequest();
                                break;
                            }
                            case "entityModel": {
                                liquidEntityModelGet.operation = operation;
                                liquidEntityModelGet.requestData = requestData;
                                liquidEntityModelGet.contextData = contextData;
                                liquidEntityModelGet.generateRequest();
                                break;
                            }
                            case "entity": {
                                liquidEntityDataGet.operation = operation;
                                liquidEntityDataGet.requestData = requestData;
                                liquidEntityDataGet.contextData = contextData;
                                liquidEntityDataGet.generateRequest();
                                break;
                            }
                        }

                        var reqTrackerItem = this.requestTracker[request.type];
                        var overallReqTrackerItem = this.requestTracker.all;

                        if(overallReqTrackerItem.sent == 0) {
                            overallReqTrackerItem.startTime = Date.now();
                        }

                        if(reqTrackerItem.sent == 0) {
                            reqTrackerItem.startTime = Date.now();
                        }

                        overallReqTrackerItem.sent++;
                        reqTrackerItem.sent++;
                    }
                },
                prepareRequests: function () {
                    var preLoadConfig = this.preLoadConfig.preLoadConfig;
                    var allRequests = [];
                    for (var objTypeIdx in preLoadConfig) {
                        var objTypeJson = preLoadConfig[objTypeIdx];
                        switch (objTypeIdx) {
                            case "aggregateConfig": {
                                allRequests.push.apply(allRequests, this.prepareAggregrateConfigGetRequests(objTypeJson));
                                break;
                            }
                            case "config": {
                                allRequests.push.apply(allRequests, this.prepareConfigGetRequests(objTypeJson));
                                break;
                            }
                            case "entityCompositeModel": {
                                allRequests.push.apply(allRequests, this.prepareEntityCompositeModelGetRequests(objTypeJson));
                                break;
                            }
                            case "entityModel": {
                                allRequests.push.apply(allRequests, this.prepareEntityModelGetRequests(objTypeJson));
                                break;
                            }
                            case "entity": {
                                allRequests.push.apply(allRequests, this.prepareEntityGetRequests(objTypeJson));
                                break;
                            }
                        }
                    }

                    this.requestTracker.all.total = allRequests.length;

                    return allRequests;
                },
                _validate: function (reqData) {
                    return true;
                },
                prepareAggregrateConfigGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.byContext) {
                        for (var i in preLoadConfig.byContext) {
                            var config = preLoadConfig.byContext[i];
                            var appName = config.appName;
                            var contextData = config.contextData;
                            contextData[ContextHelper.CONTEXT_TYPE_USER] = this.contextData[ContextHelper.CONTEXT_TYPE_USER];
                            
                            var request = {
                                "type": "aggregateConfig",
                                "operation": "getbyids",
                                "requestData": {
                                    "appName": appName
                                },
                                "contextData": contextData
                            };
                            requests.push(request);
                        }
                    }

                    this.requestTracker.aggregateConfig.total = requests.length;

                    return requests;
                },
                prepareConfigGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.bySearch) {
                        for (var i in preLoadConfig.bySearch) {
                            var type = preLoadConfig.bySearch[i];
                            var contextData = {};
                            contextData[ContextHelper.CONTEXT_TYPE_USER] = this.contextData[ContextHelper.CONTEXT_TYPE_USER];

                            var request = {
                                "type": "config",
                                "operation": "searchandget",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "typesCriterion": [type]
                                        },
                                        "fields": {
                                            "jsonData": true
                                        }
                                    }
                                },
                                "contextData": contextData
                            };

                            requests.push(request);
                        }
                    }

                    this.requestTracker.config.total = requests.length;

                    return requests;
                },
                prepareEntityCompositeModelGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.byNames) {
                        for (var i in preLoadConfig.byNames) {
                            var name = preLoadConfig.byNames[i];
                            
                            var request = {
                                "type": "entityCompositeModel",
                                "operation": "getbyids",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "name": name,
                                            "locale": "en-US"
                                        },
                                        "fields": {
                                            "attributes": ["_ALL"],
                                            "relationships": ["_ALL"]
                                        }
                                    }
                                }
                            };

                            requests.push(request);
                        }
                    }

                    this.requestTracker.entityCompositeModel.total = requests.length;

                    return requests;
                },
                prepareEntityModelGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.bySearch) {
                        for (var i in preLoadConfig.bySearch) {
                            var type = preLoadConfig.bySearch[i];

                            var request = {
                                "type": "entityModel",
                                "operation": "searchandget",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "filters": {
                                                "typesCriterion": [type]
                                            }
                                        },
                                        "fields": {
                                            "attributes": ["_ALL"],
                                            "relationships": ["_ALL"]
                                        }
                                    }
                                }
                            };

                            requests.push(request);
                        }
                    }

                    this.requestTracker.entityModel.total = requests.length;

                    return requests;
                },
                prepareEntityGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.bySearch) {
                        for (var i in preLoadConfig.bySearch) {
                            var type = preLoadConfig.bySearch[i];

                            var request = {
                                "type": "entity",
                                "operation": "searchandget",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "filters": {
                                                "typesCriterion": [type]
                                            }
                                        },
                                        "fields": {
                                            "attributes": ["_ALL"],
                                            "relationships": ["_ALL"]
                                        }
                                    }
                                }
                            };

                            requests.push(request);
                        }
                    }

                    this.requestTracker.entity.total = requests.length;
                    return requests;
                },
                _onResponse: function(e) {
                    
                    var reqType = this._getRequestTypeByTarget(e.target);

                    var overallReqTrackerItem = this.requestTracker.all;
                    var reqTrackerItem = this.requestTracker[reqType];

                    overallReqTrackerItem.received++;
                    reqTrackerItem.received++;

                    this._verifyCompletion(reqTrackerItem);
                },
                _onError: function(e) {
                    var reqType = this._getRequestTypeByTarget(e.target);

                    var overallReqTrackerItem = this.requestTracker.all;
                    var reqTrackerItem = this.requestTracker[reqType];

                    overallReqTrackerItem.errored++;
                    reqTrackerItem.errored++;

                    this._verifyCompletion(reqTrackerItem);
                },
                _verifyCompletion: function (reqTrackerItem) {
                    var overallReqTrackerItem = this.requestTracker.all;

                    if(overallReqTrackerItem.total > 0) {
                        overallReqTrackerItem.progress = ((overallReqTrackerItem.received + overallReqTrackerItem.errored) * 100) / overallReqTrackerItem.total;
                    }

                    if(reqTrackerItem.total > 0) {
                        reqTrackerItem.progress = ((reqTrackerItem.received + reqTrackerItem.errored) * 100) / reqTrackerItem.total;
                    }
                    
                    if((reqTrackerItem.total == reqTrackerItem.sent)
                        && (reqTrackerItem.total == (reqTrackerItem.received + reqTrackerItem.errored))) {

                        var startTime = reqTrackerItem.startTime;
                        var endTime = Date.now();
                        var timeTaken = endTime - startTime;
                        reqTrackerItem.timeTaken = timeTaken;
                    }

                    if((overallReqTrackerItem.total == overallReqTrackerItem.sent)
                        && (overallReqTrackerItem.total == (overallReqTrackerItem.received + overallReqTrackerItem.errored))) {

                        var startTime = overallReqTrackerItem.startTime;
                        var endTime = Date.now();
                        var timeTaken = endTime - startTime;
                        overallReqTrackerItem.timeTaken = timeTaken;

                        var eventDetail = {
                            'timeTaken': overallReqTrackerItem.timeTaken,
                            'requestTracker': this.requestTracker
                        }

                        this.fire('dataobject-preload-completed', eventDetail, {'bubbles': false});
                        this.fire('liquid-dataobject-preload-completed', eventDetail, {'bubbles': false});
                    }
                },
                _getRequestTypeByTarget: function (target) {
                    var reqType = 'unknown';
                    var tagName = target ? target.tagName.toLowerCase() : "unknown";

                    switch(tagName) {
                        case "liquid-config-get": {
                            reqType = "config";
                             break;
                        }
                        case "liquid-config-aggregate-get": {
                            reqType = "aggregateConfig";
                             break;
                        }
                        case "liquid-entity-model-composite-get": {
                            reqType = "entityCompositeModel";
                             break;
                        }
                        case "liquid-entity-model-get": {
                            reqType = "entityModel";
                             break;
                        }
                        case "liquid-entity-data-get": {
                            reqType = "entity";
                             break;
                        }
                    }

                    return reqType;
                }
            });
        })();
    </script>
</dom-module>