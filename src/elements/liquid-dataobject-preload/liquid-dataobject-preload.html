<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-base-behavior/liquid-base-behavior.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<!--
`liquid-dataobject-preload`

@demo demo/index.html 
-->
<dom-module id="liquid-dataobject-preload">
    <template>
        <liquid-config-get id="liquidConfigGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onResponse"
            on-error="_onError"></liquid-config-get>
        <liquid-entity-model-composite-get id="liquidEntityModelCompositeGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onEntityCompositeModelGetResponse"
            on-error="_onEntityCompositeModelGetError"></liquid-entity-model-composite-get>
        <liquid-entity-model-get id="liquidEntityModelGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onResponse"
            on-error="_onError"></liquid-entity-model-get>
        <liquid-entity-data-get id="liquidEntityDataGet" $verbose="[[verbose]]" operation="getbyids" on-response="_onResponse"
            on-error="_onError"></liquid-entity-data-get>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-dataobject-preload',
                behaviors: [RUFBehaviors.LiquidBaseBehavior],
                attached: function () {
                },
                ready: function () {
                },
                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    preLoadConfig: {
                        type: Object,
                        value: function () {
                            return {
                                "preLoadConfig": {
                                    "aggregateConfig": {
                                        "byContext": [
                                            {"appName": "main-app", "contextData": {'ItemContexts': []}},
                                            {"appName": "app-dashboard", "contextData": {'ItemContexts': []}},
                                            {"appName": "app-entity-discovery", "contextData": {'ItemContexts': []}},
                                            {"appName": "app-entity-manage", "contextData": {'ItemContexts': [{'entityType': 'sku'}]}},
                                            {"appName": "app-business-function", "contextData": {'ItemContexts': [{'entityType': 'sku'}]}}
                                        ]
                                     }//,
                                    // "entityCompositeModel": {
                                    //     "byNames": ["sku", "lot"]
                                    // }//,
                                    // "config": {
                                    //     "bySearch": ["savedsearch", "workflowSavedSearch"]
                                    // },
                                    // "entityModel": {
                                    //     "bySearch": ["businessCondition", "businessRule", "workflowDefinition", "workflowDefinitionMappings", "ruleContextMappings"]
                                    // },
                                    // "entity": {
                                    //     "bySearch": ["classification", "color", "size"]
                                    // }
                                }
                            };
                        }
                    },
                    requestTracker: {
                        "type": Object,
                        "value": function () {
                            return {
                                "aggregateConfig": {
                                    'startTime': '',
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0
                                },
                                "config": {
                                    'startTime': '',
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0
                                },
                                "entityCompositeModel": {
                                    'startTime': '',
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0
                                },
                                "entityModel": {
                                    'startTime': '',
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0
                                },
                                "entityData": {
                                    'startTime': '',
                                    "sent": 0,
                                    "received": 0,
                                    "errored": 0
                                }
                            };
                        }
                    }
                },
                generateRequest: function () {
                    if (!this._validate(this.requestData)) {
                        return;
                    }

                    var requests = this.prepareRequests();
                    
                    var liquidConfigGet = this.$$('#liquidConfigGet');
                    var liquidEntityModelCompositeGet = this.$$('#liquidEntityModelCompositeGet');
                    var liquidEntityModelGet = this.$$('#liquidEntityModelGet');
                    var liquidEntityDataGet = this.$$('liquidEntityDataGet');

                    for (var requestId in requests) {
                        var request = requests[requestId];

                        var operation = request.operation;
                        var requestData = request.requestData;
                        var contextData = request.contextData;
                                
                        switch (request.type) {
                            case "aggregateConfig": {
                                var liquidConfigAggregateGet = document.createElement("liquid-config-aggregate-get");
                                liquidConfigAggregateGet.name = requestData.appName + DataHelper.getRandomString();
                                liquidConfigAggregateGet.addEventListener("config-get-response", this._onApplicationConfigGetResponse.bind(this));
                                liquidConfigAggregateGet.addEventListener("error", this._onApplicationConfigError.bind(this));
                                liquidConfigAggregateGet.appName = requestData.appName;
                                liquidConfigAggregateGet.contextData = contextData;

                                if(this.requestTracker.aggregateConfig.sent == 0) {
                                    this.requestTracker.aggregateConfig.startTime = Date.now();
                                }
                                this.requestTracker[request.type].sent++;
                                
                                liquidConfigAggregateGet.refresh();
                                break;
                            }
                            case "configGet": {
                                liquidConfigGet.operation = operation;
                                liquidConfigGet.requestData = requestData;
                                liquidConfigGet.contextData = contextData;
                                counter++;
                                liquidConfigGet.generateRequest();
                                break;
                            }
                            case "entityCompositeModel": {
                                liquidEntityModelCompositeGet.operation = operation;
                                liquidEntityModelCompositeGet.requestData = requestData;
                                
                                if(this.requestTracker[request.type].sent == 0) {
                                    this.requestTracker[request.type].startTime = Date.now();
                                }

                                this.requestTracker[request.type].sent++;
                                
                                liquidEntityModelCompositeGet.generateRequest();
                                break;
                            }
                            case "entityModel": {
                                liquidEntityModelGet.operation = operation;
                                liquidEntityModelGet.requestData = requestData;
                                liquidEntityModelGet.contextData = contextData;
                                counter++;
                                liquidEntityModelGet.generateRequest();
                                break;
                            }
                            case "entity": {
                                liquidEntityDataGet.operation = operation;
                                liquidEntityDataGet.requestData = requestData;
                                liquidEntityDataGet.contextData = contextData;
                                counter++;
                                liquidEntityDataGet.generateRequest();
                                break;
                            }
                        }
                    }
                },
                prepareRequests: function () {
                    var preLoadConfig = this.preLoadConfig.preLoadConfig;
                    var allRequests = [];
                    for (var objTypeIdx in preLoadConfig) {
                        var objTypeJson = preLoadConfig[objTypeIdx];
                        switch (objTypeIdx) {
                            case "aggregateConfig": {
                                allRequests.push.apply(allRequests, this.prepareAggregrateConfigGetRequests(objTypeJson));
                                break;
                            }
                            case "config": {
                                allRequests.push.apply(allRequests, this.prepareConfigGetRequests(objTypeJson));
                                break;
                            }
                            case "entityCompositeModel": {
                                allRequests.push.apply(allRequests, this.prepareEntityCompositeModelGetRequests(objTypeJson));
                                break;
                            }
                            case "entityModel": {
                                allRequests.push.apply(allRequests, this.prepareEntityModelGetRequests(objTypeJson));
                                break;
                            }
                            case "entity": {
                                allRequests.push.apply(allRequests, this.prepareEntityGetRequests(objTypeJson));
                                break;
                            }
                        }
                    }

                    return allRequests;
                },
                _validate: function (reqData) {
                    return true;
                },
                prepareAggregrateConfigGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.byContext) {
                        for (var i in preLoadConfig.byContext) {
                            var config = preLoadConfig.byContext[i];
                            var appName = config.appName;
                            var contextData = config.contextData;
                            contextData[ContextHelper.CONTEXT_TYPE_USER] = this.contextData[ContextHelper.CONTEXT_TYPE_USER];
                            
                            var request = {
                                "type": "aggregateConfig",
                                "operation": "getbyids",
                                "requestData": {
                                    "appName": appName
                                },
                                "contextData": contextData
                            };
                            requests.push(request);
                        }
                    }

                    return requests;
                },
                prepareConfigGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.bySearch) {
                        for (var i in preLoadConfig.bySearch) {
                            var type = preLoadConfig.bySearch[i];
                            var contextData = {};
                            contextData[ContextHelper.CONTEXT_TYPE_USER] = this.contextData[ContextHelper.CONTEXT_TYPE_USER];

                            var request = {
                                "type": "config",
                                "operation": "searchandget",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "typesCriterion": [type]
                                        },
                                        "fields": {
                                            "jsonData": true
                                        }
                                    }
                                },
                                "contextData": contextData
                            };

                            requests.push(request);
                        }
                    }

                    return requests;
                },
                prepareEntityCompositeModelGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.byNames) {
                        for (var i in preLoadConfig.byNames) {
                            var name = preLoadConfig.byNames[i];
                            
                            var request = {
                                "type": "entityCompositeModel",
                                "operation": "getbyids",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "name": name,
                                            "locale": "en-US"
                                        },
                                        "fields": {
                                            "attributes": ["_ALL"],
                                            "relationships": ["_ALL"]
                                        }
                                    }
                                }
                            };

                            requests.push(request);
                        }
                    }

                    return requests;
                },
                prepareEntityModelGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.bySearch) {
                        for (var i in preLoadConfig.bySearch) {
                            var type = preLoadConfig.bySearch[i];

                            var request = {
                                "type": "entityModel",
                                "operation": "searchandget",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "filters": {
                                                "typesCriterion": [type]
                                            }
                                        },
                                        "fields": {
                                            "attributes": ["_ALL"],
                                            "relationships": ["_ALL"]
                                        }
                                    }
                                }
                            };

                            requests.push(request);
                        }
                    }

                    return requests;
                },
                prepareEntityGetRequests: function (preLoadConfig) {
                    var requests = [];
                    if(preLoadConfig.bySearch) {
                        for (var i in preLoadConfig.bySearch) {
                            var type = preLoadConfig.bySearch[i];

                            var request = {
                                "type": "entity",
                                "operation": "searchandget",
                                "requestData": {
                                    "params": {
                                        "query": {
                                            "filters": {
                                                "typesCriterion": [type]
                                            }
                                        },
                                        "fields": {
                                            "attributes": ["_ALL"],
                                            "relationships": ["_ALL"]
                                        }
                                    }
                                }
                            };

                            requests.push(request);
                        }
                    }

                    return requests;
                },
                _onApplicationConfigGetResponse: function(e) {
                    var reqTrackerItem = this.requestTracker.aggregateConfig;

                    reqTrackerItem.received++;
                    if(reqTrackerItem.sent == reqTrackerItem.received) {
                        var startTime = reqTrackerItem.startTime;
                        var endTime = Date.now();
                        var taken = endTime - startTime;

                        console.log('application configs load completed in ' + taken + ' ms');
                        var eventDetail = {
                            'totalRecordsLoaded': reqTrackerItem.received,
                            'timeTaken': taken
                        }

                        this.fire('dataobject-preload-completed', eventDetail, {'bubbles': false});
                        this.fire('liquid-dataobject-preload-completed', eventDetail, {'bubbles': false});
                    }
                },
                _onApplicationConfigError: function(e) {
                    this.requestTracker.aggregateConfig.errored++;
                },
                _onEntityCompositeModelGetResponse: function(e) {
                    var reqTrackerItem = this.requestTracker.entityCompositeModel;

                    reqTrackerItem.received++;
                    if(reqTrackerItem.sent == reqTrackerItem.received) {
                        var startTime = reqTrackerItem.startTime;
                        var endTime = Date.now();
                        var taken = endTime - startTime;
                        console.log('entity composite model load completed in ' + taken + ' ms');
                        var eventDetail = {
                            'totalRecordsLoaded': reqTrackerItem.received
                        }

                        this.fire('response', eventDetail, {'bubbles': false});
                        this.fire('liquid-response', eventDetail, {'bubbles': false});
                    }
                },
                _onEntityCompositeModelGetError: function(e) {
                    this.requestTracker.entityCompositeModel.errored++;
                },
                _onResponse: function (e) {
                    var eventDetail = e.detail;
                    this.fire('entity-dataobject-preload-response', eventDetail, { bubbles: this.bubbles });
                    this.fire('liquid-dataobject-preload-response', eventDetail, { bubbles: this.bubbles });
                },
                _onError: function (e) {
                    var eventDetail = e.detail;
                    this.fire('error', eventDetail, { bubbles: this.bubbles });
                    this.fire('liquid-error', eventDetail, { bubbles: this.bubbles });
                }
            });
        })();
    </script>
</dom-module>