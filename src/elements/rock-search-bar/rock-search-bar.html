<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-button/pebble-button.html">


<!--
`rock-search-bar`
Represents a single-line textbox to enter the search text.

@demo demo/index.html
-->

<dom-module id="rock-search-bar">
    <template>
        <style include="pebble-styles-shared"></style>
        <style>
             :host {
                @apply(--layout-horizontal);
                @apply(--layout-center);
                display: inline-flex;
                display: -webkit-inline-flex;
                width: 100%;
                height: 30px;
                border: 0;
                overflow: inherit!important;
                margin-bottom: 6px;
            }

            .input-panel {
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-center);
                position: relative;
            }

            #input {
                outline: 0;
                cursor: text;
                font-family: var(--default-font-family, 'Roboto', Helvetica, Arial, sans-serif);
                background: transparent;
                color: var(--search-text-color, #75808b);
                font-size: var(--font-size-sm, 12px);
                width: calc(100% - 35px);
                border: 1px solid var(--default-border-color, #c1cad4);
                border-radius: 3px;
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
                padding: 5px;
                height: 30px;
                border-right: 0;
            }

            pebble-button.toolbarsearch {
                border-top-left-radius: 0!important;
                border-bottom-left-radius: 0!important;
                width: 36px;
                height: 30px;
                background-color: var(--primary-button-color, #139ee7)!important;
                border-color: var(--primary-button-color, #139ee7)!important;
            }

            pebble-button.toolbarsearch {
                --pebble-button-iron-icon: {
                    width: 16px!important;
                    height: 16px !important;
                    text-align: center;
                    padding: 0;
                }
            }

            pebble-button {
                --paper-button: {
                    min-width: auto !important;
                    padding: 0;
                    height: 28px;
                    margin: 0!important;
                }
            }
        </style>

        <div class="input-panel">
            <input is="iron-input" id="input" bind-value="{{query}}" placeholder="[[placeholder]]" on-keyup="searchOnEnter" on-paste='_onPaste'></input>
            <pebble-button icon="pebble-md-icons:ToolbarSearch-wt" class="btn btn-primary toolbarsearch" on-tap="search"></pebble-button>
            <!--<div class="resetsearch" hidden$="[[!query]]"><pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="clear" button-text="Reset Search"></pebble-button></div> -->
        </div>

    </template>
</dom-module>

<script>
    (function () {

        Polymer({
            is: 'rock-search-bar',
            /**
             * The `pub-sub` event named `rock-search` is fired when the user requests to search for a query. 
             * The data passed in the event is in the following format:  
             * {'name':'rock-search', 'data':this.query}
             *
             * @event bedrock-event
             */
            properties: {
                /**
                 * Indicates the text for the user search.
                 */
                query: {
                    type: String,
                    notify: true,
                    value: '',
                    observer: '_queryUpdated'
                },
                /**
                 * Indicates an icon which is shown on the search textbox.
                 */
                icon: {
                    type: String,
                    value: 'search'
                },
                /**
                 * Indicates the text shown in the search box if the user does not enter any query.
                 */
                placeholder: {
                    type: String,
                    value: 'Search'
                },
                /**
                 * Indicates that the text is passed as a JSON object for the search input. This usually comes from the filter query.
                 */
                searchInput: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return [];
                    },
                    observer: "searchQueryFromInput"
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            /**
             * Can be used to clear the search query.
             */
            clear: function () {
                this.query = "";
                this.$.input.focus();
                this.fireBedrockEvent('rock-search-clear', null);
            },
            /**
             * Can be used to invoke the search functionality.
             */
            search: function () {
                this.fireBedrockEvent('rock-search', this.query);
            },
            /**
             * Can be used to invoke the search functionality on the press of an `enter` key.
             */
            searchOnEnter: function (e) {
                if (e.keyCode === 13) {
                    this.search();
                }
            },
            /**
             * Can be used to observe the `searchInput` JSON array. It creates the search query 
             * using the `searchInput`.
             */
            searchQueryFromInput: function () {
                var length = this.searchInput.length;
                for (var i = 0; i < length; i++) {
                    this.query += this.searchInput[i].name + " = " + this.searchInput[i].value;
                    if (i < length - 1) {
                        this.query += " and ";
                    }
                }
            },

            _queryUpdated: function () {
                this.fireBedrockEvent('rock-search-update', this.query);
            },

            /* Formating the pasted query */
            _onPaste: function (e) {
                var pastedQuery = "";
                var formattedQuery = "";

                e.preventDefault();

                if (e.clipboardData) {
                    pastedQuery = e.clipboardData.getData('text/plain');
                } else if (window.clipboardData) { //IE
                    pastedQuery = window.clipboardData.getData("text");
                }

                if (DataHelper.isTextSelected(this.$.input)) {
                    // What if user select spaces and there are multiple spaces?
                    formattedQuery = this._getFormatedQuery(pastedQuery);
                    this.query = this.query.replace(DataHelper.getSelectedText(this.$.input), formattedQuery);
                } else {
                    formattedQuery = this._getFormatedQuery(pastedQuery);
                    this.query = DataHelper.replaceAt(this.query, this.$.input.selectionStart, formattedQuery);
                }
            },

            _getFormatedQuery: function (queryToFormat) {
                var seperator = " or ";
                var tempPastedQueryArray = queryToFormat.trim().split(/\n|\r/);
                var tempformatedQueryString = "";
                if (tempPastedQueryArray.length > 1) { //formating copied xls rows
                    for (var i = 0; i < tempPastedQueryArray.length; i++) {
                        if (tempPastedQueryArray[i].length == 1 || tempPastedQueryArray[i] == "") {
                            continue; // empty cell
                        }
                        tempformatedQueryString = tempformatedQueryString + "\'" + tempPastedQueryArray[
                            i] + "\'" + seperator;
                    }
                    return tempformatedQueryString.substr(0, tempformatedQueryString.lastIndexOf(
                        seperator));
                } else {
                    return queryToFormat;
                }
            }
        });

    })();
</script>