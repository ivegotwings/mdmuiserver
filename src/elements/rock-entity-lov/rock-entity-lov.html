<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="entity-lov-datasource.html">

<!--
`rock-entity-lov` component is used to render entities in lov, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-lov">
    <template>
        <entity-lov-datasource id="entityLovDataSource" request="{{_request}}" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
            attributes-criterion-builder={{_attributesCriterionBuilder}}>
        </entity-lov-datasource>
        <pebble-lov id="entityLov" data-source="{{dataSource}}" page-size="8" external-data-source></pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-lov',
            properties: {
                _attributes: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _lovAttributeMap: {
                    type: Object,
                    value: function () {
                        return {
                            "id": "id"
                        };
                    }
                },
                /*
                 * Indicates the attribute of an entity which will be used as title for the item
                 */
                titleField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as subtitle for the item
                 */
                subTitleField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as image for the item
                 */
                imageField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as color for the item
                 */
                colorField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the context for which the entities are requested
                 */
                context: {
                    type: Array,
                    value: function () {
                        return [{
                            "list": "productMaster",
                            "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                        }];
                    }
                },
                /*
                 * Indicates the valueContext for which the attributes are requested
                 */
                valueContext: {
                    type: Array,
                    value: function () {
                        return [{
                            "source": "SAP",
                            "locale": "en-US"
                        }];
                    }
                },
                /*
                 * Indicates the type of an entity request
                 */
                entityTypes: {
                    type: Array,
                    value: function () {
                        return ["nart"];
                    }
                },
                /**
                 * Indicates liquid request object for data to be rendered in grid.
                 */
                _request: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {
                                    "ctx": [],
                                    "valCtx": [],
                                    "filters": {
                                        "attributesCriterion": [],
                                        "typesCriterion": []
                                    }
                                },
                                "fields": {
                                    "ctxTypes": [],
                                    "attributes": []
                                },
                                "options": {
                                    "from": 0,
                                    "to": 0
                                }
                            }
                        }
                    }
                },
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return this._getAttributeFormattedData.bind(this);
                    }
                },
                _attributesCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return this._prepareAttributeCriteria.bind(this);
                    }
                }
            },

            observers: [
                '_prepareAttributeModels(titleField, subTitleField, imageField, colorField)'
            ],

            ready: function () {
                this.set("_request.params.query.ctx", this.context);
                this.set("_request.params.query.valCtx", this.valueContext);
                this.set("_request.params.query.filters.typesCriterion", this.entityTypes);

                if (this._attributes.length > 0) {
                    this.set("_request.params.fields.attributes", this._attributes);
                }
            },

            _prepareAttributeModels: function (titleField, subTitleField, imageField, colorField) {
                if (this.titleField) {
                    this.push('_attributes', this.titleField);
                    this._lovAttributeMap.title = this.titleField;
                }

                if (this.subTitleField) {
                    this.push('_attributes', this.subTitleField);
                    this._lovAttributeMap.subtitle = this.subTitleField;
                }

                if (this.imageField) {
                    this.push('_attributes', this.imageField);
                    this._lovAttributeMap.image = this.imageField;
                }

                if (this.colorField) {
                    this.push('_attributes', this.colorField);
                    this._lovAttributeMap.color = this.colorField;
                }
            },

            _getAttributeFormattedData: function (data) {
                var entities = data.content.entities;
                if (data && data.content) {
                    if (entities) {
                        entities = DataHelper.transformEntitySchemaForLov(entities, this._lovAttributeMap);
                    }
                }
                return entities;
            },

            _prepareAttributeCriteria: function (searchText) {
                if (searchText) {
                    var attributesCriterion = [];
                    var searchKey = new Object();
                    var searchValue = new Object();
                    searchValue.eq = searchText ? searchText : '';

                    searchKey[this.titleField] = searchValue;
                    attributesCriterion.push(searchKey);
                    return attributesCriterion
                }
            },
        });
    </script>
</dom-module>