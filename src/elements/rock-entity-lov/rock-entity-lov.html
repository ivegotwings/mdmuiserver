<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="entity-lov-datasource.html">

<!--
`rock-entity-lov` component is used to render entities in lov, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-lov">
    <template>
        <!--<template is="dom-if" if="[[!manual]]">
            <entity-lov-datasource id="entityLovDataSource" request="{{_request}}" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
                keywords-criterion-builder="{{_keywordsCriterionBuilder}}">
            </entity-lov-datasource>
            <pebble-lov id="entityLov" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]" show-color="[[showColor]]"
                no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" data-source="{{dataSource}}" items="{{items}}"
                selected-item="{{selectedItem}}" selected-items="{{selectedItems}}">
            </pebble-lov>
        </template>-->
        <template is="dom-if" if="[[manual]]">
            <entity-lov-datasource id="entityLovDataSource" request="{{_request}}" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
                keywords-criterion-builder="{{_keywordsCriterionBuilder}}">
            </entity-lov-datasource>
            <pebble-lov id="entityLov" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]" show-color="[[showColor]]"
                no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" data-source="{{dataSource}}" items="{{items}}"
                selected-item="{{selectedItem}}" selected-items="{{selectedItems}}">
            </pebble-lov>
        </template>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-lov',
            properties: {
                /**
                 * If true, manually loads data from dataSource
                 */
                manual: {
                    type: Boolean,
                    value: true
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],

            // listeners: {
            //     'entityLov.selection-changed': 'lovSelectionChanged'
            // },

            ready: function () {
                this._currentLovElement = this.$$("#entityLov");
                this._currentDataSourceElement = this.$$("#entityLovDataSource");
                this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);

                this._attributesCriterionBuilder = this._prepareAttributesCriteria.bind(this);
                this._dataFormatter = this._getAttributeFormattedData.bind(this);
            },

            isManualLoad: function () {
                if (this.manual) {
                    return true
                } else {
                    return false;
                }
            },

            lovSelectionChanged: function (event) {
                var eventDetail = {
                    data: event.detail.item
                }

                this.fireBedrockEvent("entity-lov-selection-changed", eventDetail);
            },

            _getAttributeFormattedData: function (data) {
                var entities = data.content.entities;
                if (data && data.content) {
                    if (entities) {
                        entities = DataHelper.transformEntitySchemaForLov(entities, this._lovAttributeMap);
                    }
                }
                return entities;
            },

            _prepareAttributesCriteria: function (searchText) {
                if (searchText) {
                    var attributesCriterion = [];
                    var searchKey = new Object();
                    var searchValue = new Object();
                    searchValue.eq = searchText ? searchText : '';

                    searchKey[this.itemTitle] = searchValue;
                    attributesCriterion.push(searchKey);
                    return attributesCriterion;
                }
            },

            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = searchText;
                    keywordsCriterion.operator = "and";

                    return keywordsCriterion;
                }
            }
        });
    </script>
</dom-module>