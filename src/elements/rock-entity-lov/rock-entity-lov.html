<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="entity-lov-datasource.html">

<!--
`rock-entity-lov` component is used to render entities in lov, it filters data as per filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-lov">
    <template>
        <entity-lov-datasource id="entityLovDataSource" request="{{request}}" data-source="{{dataSource}}" data-formatter="{{_dataFormatter}}"
            keywords-criterion-builder="{{_keywordsCriterionBuilder}}">
        </entity-lov-datasource>
        <pebble-lov id="entityLov" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[showImage]]" show-color="[[showColor]]"
            no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" data-source="{{dataSource}}" items="[[items]]"
            selected-item="{{selectedItem}}" selected-items="{{selectedItems}}">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-lov',
            properties: {
                _request: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {},
                                "fields": {},
                                "options": {
                                    "from": 0,
                                    "to": 0
                                }
                            }
                        }
                    }
                },
                /**
                 * Specifies whether or not to generate console logs.
                 */
                verbose: {
                    type: Boolean,
                    value: false
                },
                /**
                 * If true, manually loads data from dataSource
                 */
                manual: {
                    type: Boolean,
                    value: true
                },
                /*
                 * Indicates the attribute of an entity which will be used as id for the item
                 */
                idField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as title for the item
                 */
                titlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as subtitle for the item
                 */
                subTitlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as image for the item
                 */
                imageField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as color for the item
                 */
                colorField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the attribute of an entity which will be used as value for the item
                 */
                valueField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the context for which the entities are requested
                 */
                context: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                /*
                 * Indicates the valueContext for which the attributes are requested
                 */
                valueContext: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                /*
                 * Indicates the type of an entity request
                 */
                typesCriterion: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _attributes: {
                    type: Array,
                    value: function () {
                        return ['_ALL'];
                    }
                },
                _lovColumnNameValueCollection: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _attributesCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _keywordsCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],

            // listeners: {
            //     'entityLov.selection-changed': '_lovSelectionChanged'
            // },

            observers: [
                '_prepareRequestContext(context, valueContext, typesCriterion)',
                '_prepareAttributes(idField, titlePattern, subTitlePattern, imageField, colorField, valueField)'
            ],

            ready: function () {
                this._currentLovElement = this.$$("#entityLov");
                this._currentDataSourceElement = this.$$("#entityLovDataSource");

                this._prepareAttributeMaps();

                this._attributesCriterionBuilder = this._prepareAttributesCriteria.bind(this);
                this._keywordsCriterionBuilder = this._prepareKeywordsCriteria.bind(this);
                this._dataFormatter = this._getAttributeFormattedData.bind(this);

                if (this.verbose) {
                    // Todo..  Id may not be available every time
                    console.log("Request Object for the Element: " + this.id + "is" + JSON.stringify(this._request));
                }
            },

            _prepareAttributes: function (idField, titlePattern, subTitlePattern, imageField, colorField,
                valueField) {
                var defaultAttributes = this._attributes;
                this._attributes = [];
                var attributes = [];

                if (typeof (this.idField) !== 'undefined' && this.idField !== "") {
                    attributes.push(this.idField);
                }

                if (typeof (this.titlePattern) !== 'undefined' && this.titlePattern !== "") {
                    if (!attributes.includes(this.titlePattern)) {
                        attributes.push(this.titlePattern);
                    }
                }

                if (typeof (this.subTitlePattern) !== 'undefined' && this.subTitlePattern !== "") {
                    if (!attributes.includes(this.subTitlePattern)) {
                        attributes.push(this.subTitlePattern);
                    }
                }

                if (typeof (this.imageField) !== 'undefined' && this.imageField !== "") {
                    if (!attributes.includes(this.imageField)) {
                        attributes.push(this.imageField);
                    }
                }

                if (typeof (this.colorField) !== 'undefined' && this.colorField !== "") {
                    if (!attributes.includes(this.colorField)) {
                        attributes.push(this.colorField);
                    }
                }

                if (typeof (this.valueField) == 'undefined' && this.valueField !== "") {
                    if (!attributes.includes(this.valueField)) {
                        attributes.push(this.valueField);
                    }
                }

                if (attributes.length == 0) {
                    this._attributes = defaultAttributes;
                } else {
                    this.set('_request.params.fields.attributes', attributes);
                }

                // if (this._request) {
                //     console.log("Attributes: " + JSON.stringify(this._request));
                // }
            },

            _prepareRequestContext: function (context, valueContext, typesCriterion) {
                // Todo.. What if user wants to provide Empty Array
                if (typeof (this.context) !== "undefined" && this.context.length > 0) {
                    this.set("_request.params.query.ctx", this.context);
                }

                if (typeof (this.valueContext) !== "undefined" && this.valueContext.length > 0) {
                    this.set("_request.params.query.valCtx", this.valueContext);
                }

                if (typeof (this.typesCriterion) !== "undefined" && this.typesCriterion.length > 0) {
                    if (typeof (this._request.params.query.filters) === "undefined") {
                        this.set("_request.params.query.filters", {});
                    }
                    this.set("_request.params.query.filters.typesCriterion", this.typesCriterion);
                }

                // console.log("RequestContext: " + JSON.stringify(this._request));
            },

            _prepareAttributeMaps: function () {
                this._lovColumnNameValueCollection.id = this.idField;
                this._lovColumnNameValueCollection.title = this.titlePattern;
                this._lovColumnNameValueCollection.subtitle = this.subTitlePattern;
                this._lovColumnNameValueCollection.image = this.imageField;
                this._lovColumnNameValueCollection.color = this.colorField;
                this._lovColumnNameValueCollection.value = this.valueField;
            },

            _getAttributeFormattedData: function (data) {
                var entities = data.content.entities;
                if (data && data.content) {
                    if (entities) {
                        entities = DataHelper.transformEntitySchemaToLovSchema(entities, this._lovColumnNameValueCollection);
                    }
                }
                return entities;
            },

            _prepareAttributesCriteria: function (searchText) {
                if (searchText) {
                    var attributesCriterion = [];
                    var searchKey = new Object();
                    var searchValue = new Object();
                    searchValue.eq = searchText ? searchText : '';

                    // Todo.. When Pattern comes into picture this one is effected
                    searchKey[this.titlePattern] = searchValue;
                    attributesCriterion.push(searchKey);
                    return attributesCriterion;
                }
            },

            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = searchText;
                    keywordsCriterion.operator = "and";

                    return keywordsCriterion;
                }
            },

            _lovSelectionChanged: function (event) {
                var eventDetail = {
                    data: event.detail.item
                }

                this.fireBedrockEvent("entity-lov-selection-changed", eventDetail);
            }
        });
    </script>
</dom-module>