<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../rock-image-source-provider/rock-image-source-provider.html">

<link rel="import" href="entity-lov-datasource.html">

<!--
`rock-entity-lov` Represents a component that renders the entities in the list of values control.
It filters the data as per the filter criteria.

@demo demo/index.html
-->

<dom-module id="rock-entity-lov">
   
    <template>
        <style include="bedrock-style-common">
            pebble-lov{
                @apply --pebble-lov;
            }
        </style>
        <entity-lov-datasource id="entityLovDataSource" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" base-request="[[requestData]]" r-data-source="{{rDataSource}}" r-data-formatter="{{_dataFormatter}}"
            keywords-criterion-builder="{{_keywordsCriterionBuilder}}" sort-criterion-builder="{{_sortCriterionBuilder}}" attributes-criterion-builder="{{_attributesCriterionBuilder}}"
            is-attribute-filter="{{_isAttributeFilter}}">
        </entity-lov-datasource>
        <rock-image-source-provider image-source="{{imageSource}}"></rock-image-source-provider>
        <pebble-lov id="entityLov" readonly=[[readonly]] image-source="{{imageSource}}" page-size="[[pageSize]]" multi-select="[[multiSelect]]" show-image="[[_showImage(imageField,imageIdField)]]" show-color="[[showColor]]"
            no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" r-data-source="{{rDataSource}}" items="[[items]]"
            selected-item="{{selectedItem}}" selected-items="{{selectedItems}}"  allow-search-query-format on-selection-changed="_onLovSelectionChanged" 
            on-lov-confirm-button-tap="_onLovConfirmButtonTapped" on-lov-close-button-tap="_onLovCloseButtonTapped"  >
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-lov',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * If set as true , it indicates the component is in read only mode
                 */
                readonly: {
                    type: Boolean,
                    value: false               	
                },
                configDataItemId: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                rDataSource: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                _lovColumnNameValueCollection: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /*
                 * Indicates an identifier for the item.
                 */
                idField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the title for the item.
                 */
                titlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the sub-title for the item.
                 */
                subTitlePattern: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates an image for the item.
                 */
                imageField: {
                    type: String,
                    value: ""
                },
                imageIdField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the color for the item.
                 */
                colorField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the value for the item.
                 */
                valueField: {
                    type: String,
                    value: ""
                },
                /*
                 * Indicates the "type" for the item.
                 */
                typeField: {
                    type: Array,
                    value: []
                },                
                _attributesCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _keywordsCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _sortCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                selectedItem: {
                    type:Object,
                    notify: true,
                    value: function(){
                        return {};
                    }
                },
                selectedItems: {
                    type:Array,
                    notify: true,
                    value: function(){
                        return [];
                    }
                },
                imageSource:{
                    type:Object
                },
                externalDataFormatter: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                sortField : {
                    type: String,
                    value: ""
                },
                applyLocaleCoalescedStyle: {
                    type: Boolean,
                    value: false
                },
                applyContextCoalescedStyle: {
                    type: Boolean,
                    value: false
                },
                _isAttributeFilter: {
                    type: Boolean,
                    value: false
                },
                excludedIds: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                dataIndex: {
                    type: String,
                    value: "entityData"
                },
                dataSubIndex: {
                    type: String,
                    value: "data"
                },
                multiSelect: {
                    type: Boolean,
                    value: true
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],
            observers: [
                '_prepareAttributes(idField, titlePattern, subTitlePattern, imageField,imageIdField, colorField, valueField, typeField, sortField, requestData)'
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._attributesCriterionBuilder = this._prepareAttributesCriteria.bind(this);
                this._keywordsCriterionBuilder = DataHelper.getSearchCriteria.bind(this);
                this._sortCriterionBuilder = this._prepareSortCriterion.bind(this);
                this._dataFormatter = this._getAttributeFormattedData.bind(this);

                // Todo..  Id may not be available every time
                this.logInfo("AttributeModelReady","id",this.idField,"requestData",JSON.stringify(this.requestData));
            },

            _prepareAttributes: function (idField, titlePattern, subTitlePattern, imageField,imageIdField, colorField,
                valueField, requestData) {
                var defaultAttributes = this._attributes;
                this._attributes = [];
                var attributes = [];

                if (typeof (this.idField) !== 'undefined' && this.idField !== "") {
                    attributes.push(this.idField);
                }

                if (typeof (this.titlePattern) !== 'undefined' && this.titlePattern !== "") {
                    if (!attributes.includes(this.titlePattern)) {
                        var titleFields = DataHelper.getAttributesBetweenCurlies(this.titlePattern);
                        if (titleFields && titleFields instanceof Array) {
                            attributes.push(...titleFields);
                            this._isAttributeFilter = true;
                        }
                    }
                }

                if (typeof (this.subTitlePattern) !== 'undefined' && this.subTitlePattern !== "") {
                    if (!attributes.includes(this.subTitlePattern)) {
                        var subtitleFields = DataHelper.getAttributesBetweenCurlies(this.subTitlePattern);
                        if (subtitleFields && subtitleFields instanceof Array) {
                            attributes.push(...subtitleFields);
                        }
                    }
                }

                if (typeof (this.sortField) !== 'undefined' && this.sortField !== "") {
                    if (!attributes.includes(this.sortField)) {
                        var sortFields = DataHelper.getAttributesBetweenCurlies(this.sortField);
                        if (sortFields && sortFields instanceof Array) {
                            this._sortField = sortFields.length > 0 ? sortFields[0] : "";
                        }
                    }
                }

                if (typeof (this.imageField) !== 'undefined' && this.imageField !== "") {
                    if (!attributes.includes(this.imageField)) {
                        attributes.push(this.imageField);
                    }
                }
                if (typeof (this.imageIdField) !== 'undefined' && this.imageIdField !== "") {
                    if (!attributes.includes(this.imageIdField)) {
                        attributes.push(this.imageIdField);
                    }
                }

                if (typeof (this.colorField) !== 'undefined' && this.colorField !== "") {
                    if (!attributes.includes(this.colorField)) {
                        attributes.push(this.colorField);
                    }
                }

                if (typeof (this.valueField) == 'undefined' && this.valueField !== "") {
                    if (!attributes.includes(this.valueField)) {
                        attributes.push(this.valueField);
                    }
                }

                DataHelper.arrayRemove(attributes, "id");
                DataHelper.arrayRemove(attributes, "name");

                if (attributes.length == 0) {
                    this._attributes = defaultAttributes;
                } else {
                    // Todo.. This will not work in a scenario where request object is not initialized
                    if (!DataHelper.isEmptyObject(this.requestData) && typeof (this.requestData.params.fields) === "undefined") {
                        this.set('requestData.params.fields', {});
                    }
                    //this.set('requestData.params.fields.attributes', attributes);
                    this._attributes = attributes;
                }


                if(this.requestData && !DataHelper.isEmptyObject(this.requestData) && this.requestData.params.fields) {
                    this.requestData.params.fields.attributes = this._attributes;
                }


                this._prepareAttributeMaps();
            },
            _prepareSortCriterion: function () {
                if (!DataHelper.isEmptyObject(this._sortField) && this._sortField !== "name") {
                    var sortAttributes = [];

                    var sortAttribute = {};
                    sortAttribute[this._sortField] = "_ASCE";
                    sortAttribute["sortType"] = "_STRING"; // How to determine this?
                    sortAttributes.push(sortAttribute);

                    var sort = {};
                    sort.attributes = sortAttributes;
                    return sort;
                }
                return undefined;
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            reTriggerRequest: function() {
                this.shadowRoot.querySelector('#entityLovDataSource').reTriggerRequest();
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            resetLOV: function() {
                this.shadowRoot.querySelector('#entityLov').items = [];
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            refreshLOVData: function() {
                this.shadowRoot.querySelector('#entityLov').refreshData();
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            reset: function() {
                this.resetLOV();
                this.shadowRoot.querySelector('#entityLov').reset();                
            },
            _prepareAttributeMaps: function () {
                this._lovColumnNameValueCollection.id = this.idField;
                this._lovColumnNameValueCollection.title = this.titlePattern;
                this._lovColumnNameValueCollection.subtitle = this.subTitlePattern;
                this._lovColumnNameValueCollection.image = this.imageField;
                this._lovColumnNameValueCollection.imageId = this.imageIdField;
                this._lovColumnNameValueCollection.color = this.colorField;
                this._lovColumnNameValueCollection.value = this.valueField;
                this._lovColumnNameValueCollection.type = this.typeField;

                if(this.applyLocaleCoalescedStyle) {
                    this._lovColumnNameValueCollection.textColor = this.titlePattern;
                }
                
                if(this.applyContextCoalescedStyle) {
                    this._lovColumnNameValueCollection.fontStyle = this.titlePattern;
                }
            },

            _getAttributeFormattedData: function (data) {
                if (data && data.content.entities) {
                    var entities = data.content.entities;

                    if (entities) {
                        entities = DataTransformHelper.transformEntitySchemaToLovSchema(entities, this._lovColumnNameValueCollection);
                    }

                    if(entities && this.externalDataFormatter && typeof this.externalDataFormatter == "function") {
                        entities = this.externalDataFormatter(entities);
                    }
                }
                if(this.excludedIds && this.excludedIds.length > 0){
                    entities = entities.filter(entity => {
                        return this.excludedIds.indexOf(entity.id) == -1;
                    });
                };
                return entities;
            },

            _prepareAttributesCriteria: function (searchText) {
                return DataRequestHelper.createAttributesCriteria(searchText, this.titlePattern, this.subTitlePattern);
            },

            _onLovSelectionChanged: function (event) {
                var eventDetail = {
                    data: event.detail.item
                }

                this.fireBedrockEvent("entity-lov-selection-changed", eventDetail);
            },

            _onLovConfirmButtonTapped: function (event) {
                var eventDetail = {
                    data: {
                        id: this.id
                    },
                    name: "entity-lov-confirm-button-tap"
                }

                this.fireBedrockEvent("entity-lov-confirm-button-tap", eventDetail);
            },

            _onLovCloseButtonTapped: function (event) {
                var eventDetail = {
                    data: {
                        id: this.id
                    },
                    name: "entity-lov-close-button-tap"
                }

                this.fireBedrockEvent("entity-lov-close-button-tap", eventDetail);
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            refershTemplate: function () {
                this.shadowRoot.querySelector("#entityLov").refereshTemplate();
            },
            _showImage:function () {
                return (this.imageField || this.imageIdField);
            }
        });
    </script>
</dom-module>