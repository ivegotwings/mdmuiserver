<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-lov-datasource-behavior/bedrock-lov-datasource-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="entity-lov-datasource">
    <template>
        <liquid-entity-data-get id="initGetEntitySearch" operation="initiatesearch" request-data="{{request}}" last-response="{{_initGetEntitySearchResponse}}"
            on-error="_onGetSearchError" exclude-in-progress></liquid-entity-data-get>
        <liquid-entity-data-get id="getEntitySearchResults" operation="getsearchresultdetail" request-data="{{request}}" request-id="[[_initGetEntitySearchResponse.content.requestId]]"
            last-response="{{getEntitySearchResultsResponse}}" on-error="_onGetSearchError" exclude-in-progress></liquid-entity-data-get>
    </template>
    <script>
        Polymer({
            is: 'entity-lov-datasource',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                isAttributeFilter: {
                    type: Boolean,
                    value: false
                },
                _liquidInitSearchElement: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },

                _liquidGetSearchElement: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                rDataSource: {
                    type: Object,
                    notify: true,
                    reflectToAttribute :true
                },
                rDataFormatter: {
                    type: Function,
                    notify: true
                }
            },

            behaviors: [
                RUFBehaviors.LOVDataSourceBehavior
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            ready: function () {
                this._liquidInitSearchElement = Polymer.dom(this).node.shadowRoot.querySelector(
                    "liquid-entity-data-get[id='initGetEntitySearch']");
                this._liquidGetSearchElement = Polymer.dom(this).node.shadowRoot.querySelector(
                    "liquid-entity-data-get[id='getEntitySearchResults']");

                this.rDataSource = this._dataSource.bind(this);
            },

            _dataSource: function (data, success, error) {

                if (_.isEmpty(this.request)) {
                    return;
                }

                // Bind Reponse
                if (!this.isResponseAttached) {
                    this._liquidInitSearchElement.addEventListener('response', this._onInitSearchResponse.bind(this));
                    this._liquidGetSearchElement.addEventListener('response', this._onGetSearchResponse.bind(this, success, error));

                    this._error = error;
                    this.isResponseAttached = true;
                }

                // Filter
                //temporary code because RDF doesnt support OR search in attributesCriterion
                //so if there are more than one attrs to search in, then use keyword search
                var attributesCriterion;
                delete this.request.params.query.filters.attributesCriterion;
                delete this.request.params.query.filters.keywordsCriterion;

                if (this.attributesCriterionBuilder && this.attributesCriterionBuilder instanceof Function) {
                    attributesCriterion = this.attributesCriterionBuilder(data.filter);
                }
                if (this.isAttributeFilter) {
                    //Single attribute, go for attribute criterion
                    if (attributesCriterion && attributesCriterion.length == 1) {
                        this.set("request.params.query.filters.attributesCriterion", attributesCriterion);
                    }

                    // More attributes, go for keyword criterion for OR condition
                    if(attributesCriterion && attributesCriterion.length > 1) {
                        this._setKeywordCriterion(data.filter);
                    }
                } else {
                    this._setKeywordCriterion(data.filter);
                }

                this._setSortCriterion(data.sort);

                if (this.checkIfRequestChanged()) {
                    this.isRequestInitiated = false;
                    data.page = 1;
                }

                // Set Range
                var from = data.page > 0 ? (data.page - 1) * data.pageSize : 0;
                var to = data.page > 0 ? data.page * data.pageSize - 1 : 0;

                var options = {
                    "from": from,
                    "to": to
                };
                this.set("request.params.options", options);

                // Initiate Request only for First Time.
                if (!this.isRequestInitiated) {
                    this._liquidInitSearchElement.generateRequest();
                } else {
                    this._liquidGetSearchElement.generateRequest();
                }
            },

            _setKeywordCriterion: function(filter) {
                var keywordsCriterion;
                if (this.keywordsCriterionBuilder && this.keywordsCriterionBuilder instanceof Function) {
                    keywordsCriterion = this.keywordsCriterionBuilder(filter);
                }

                delete this.request.params.query.filters.keywordsCriterion;
                delete this.request.params.query.ids;
                if (keywordsCriterion) {
                    if(keywordsCriterion.isIdSearch) {
                        this.set("request.params.query.ids", keywordsCriterion.ids);
                    } else {
                        this.set("request.params.query.filters.keywordsCriterion", keywordsCriterion);
                    }
                }
            },
            _setSortCriterion:function (sort) {
               var sortCriterion;
               delete this.request.params.sort;
//             sorting only done for cases where we have filter criterion because of 30k sort limit
               if(this.request.params.query.filters.keywordsCriterion || this.request.params.query.ids) {
                   if (this.sortCriterionBuilder && this.sortCriterionBuilder instanceof Function) {
                       sortCriterion = this.sortCriterionBuilder(sort);
                   }
                   if (sortCriterion) {
                       this.set("request.params.sort", sortCriterion);
                   }
               }
            },

          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            reTriggerRequest: function () {
                // Initiate Request only for First Time.
                if (!this.isRequestInitiated) {
                    this._liquidInitSearchElement.generateRequest();
                } else {
                    this._liquidGetSearchElement.generateRequest();
                }
            },

            _onInitSearchResponse: function () {
                this._lastRequest = DataHelper.cloneObject(this.request);
                this._liquidGetSearchElement.generateRequest();
                this.isRequestInitiated = true;
            },

            _onGetSearchResponse: function (success, error) {
                if (typeof (this.rDataFormatter) == 'function') {
                    if (this.getEntitySearchResultsResponse.status === "success") {
                        success(this.rDataFormatter(this.getEntitySearchResultsResponse));
                    } else {
                        error();
                    }
                }
            },

            _onGetSearchError: function (e) {
                var response = e.detail.response; //need to check why this is response.response
                if (response && response.status && response.status.toLowerCase() == "error") {
                    this._error();
                }
            }
        });
    </script>
</dom-module>