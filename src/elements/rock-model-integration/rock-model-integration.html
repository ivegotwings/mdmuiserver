<link rel="import" href="../../../bower_components/polymer/polymer-elements.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/mutable-data.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">
<link rel="import" href="../bedrock-logger-behavior/bedrock-logger-behavior.html">
<link rel="import" href="../bedrock-toast-behavior/bedrock-toast-behavior.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html" />
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">

<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-model-download/rock-model-download.html">
<link rel="import" href="../rock-wizard/rock-wizard.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<dom-module id="rock-model-integration">
  <template>
    <style include="bedrock-style-common bedrock-style-gridsystem">
      :host {
        display: block;
        height: 100%;
      }

      .downloadButton {
        float: right;
        margin-bottom: 10px;
      }

      rock-wizard {
        --stepper: {
          margin: 0 !important;
          padding: 0 !important;
        }
      }
    </style>
    <div class="base-grid-structure">
      <div class="base-grid-structure-child-1">
        <div class="row-wrap align-items-center">
          <div class="col-4">
            <template is="dom-if" if="[[showDomain]]">
              <pebble-dropdown id="domainDropdown" class="dropdown" label="Domain" items="[[domains]]" selected-value="{{selectedDomain}}"></pebble-dropdown>
            </template>
          </div>
          <div class="col-8">
            <pebble-button class="btn dropdown-success downloadButton tooltip-bottom" icon="pebble-icon:download-asset" button-text="Download"
              data-tooltip="Download Model" on-click="_onModelDownloadClick"></pebble-button>
            <rock-model-download id="modelDownload" context-data="[[contextData]]" enable-async-download="[[enableAsyncDownload]]"></rock-model-download>
          </div>
        </div>
      </div>
      <div class="base-grid-structure-child-2">
        <rock-wizard id="rockwizard" config="{{wizardConfig}}" shared-data="[[sharedData]]" hide-stepper="true"></rock-wizard>
      </div>
    </div>
    <pebble-dialog id="downloadTaskDialog" dialog-title="Download" modal alert-box show-cancel show-ok no-cancel-on-outside-click
      no-cancel-on-esc-key button-ok-text="Show me the task details">
      <p>Download process is started, you can review the progress of the task [[_downloadTaskId]] in task details</p>
    </pebble-dialog>
    <bedrock-pubsub event-name="on-buttonok-clicked" handler="_onShowTaskDetailsTap" target-id="downloadTaskDialog"></bedrock-pubsub>
    <bedrock-pubsub event-name="onNext" handler="_onModelUploadSuccess"></bedrock-pubsub>
    <bedrock-pubsub event-name="onDownloadSuccess" handler="_onModelDownloadSuccess"></bedrock-pubsub>
    <liquid-rest id="liquidGetDomains" url="/data/pass-through/entitymodelservice/get" method="POST" on-liquid-response="_onDomainsReceived"
      on-liquid-error="_onDomiansGetFailed"></liquid-rest>
  </template>

  <script>
    class RockModelIntegration
      extends Polymer.mixinBehaviors([
        RUFBehaviors.AppBehavior,
        RUFBehaviors.BusinessFunctionBehavior,
        RUFBehaviors.ComponentConfigBehavior,
        RUFBehaviors.ToastBehavior,
        RUFBehaviors.LoggerBehavior
      ], Polymer.Element) {
      static get is() { return 'rock-model-integration' }

      static get properties() {
        return {
          contextData: {
            type: Object,
            value: function () {
              return {};
            }
          },
          config: {
            type: Object,
            value: function () { return {}; }
          },
          entityType: {
            type: String,
            value: null
          },
          appName: {
            type: String,
            value: "rock-model-integration"
          },
          channel: {
            type: String,
            value: ""
          },
          profiles: {
            type: String,
            value: ""
          },
          showDomain: {
            type: Boolean,
            value: false
          },
          domains: {
            type: Array,
            value: []
          },
          selectedDomain: {
            type: String,
            value: ""
          },
          fileName: {
            type: String,
            value: ""
          },
          modelDomain: {
            type: String
          },
          _downloadTaskId: {
            type: String,
            value: ""
          },
          enableAsyncDownload: {
            type: Boolean,
            value: true
          }
        }
      }

      constructor() {
        super();
        this.entityType = DataHelper.getParamValue('type');

        if (this.entityType) {
          var itemContext = {
            'type': this.entityType
          };

          this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
        }

        var userContext = {
          "roles": this.roles,
          "user": this.userId,
          "tenant": this.tenantId,
          "defaultRole": this.defaultRole
        };

        this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];
        var valueContext = DataHelper.getDefaultValContext();
        if (valueContext) {
          this.contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [valueContext];
        }
      }
      disconnectedCallback() {
        super.disconnectedCallback();
      }
      connectedCallback() {
        super.connectedCallback();

        Polymer.Async.timeOut.after(100).run(() => {
          var pebbleDropDown = this.shadowRoot.querySelector("#domainDropdown");
          if (pebbleDropDown) {
            pebbleDropDown.addEventListener('change', this._onDropdownChange.bind(this));
          }
        });
        //Setting context information to loading component
        if (_.isEmpty(this.sharedData) || _.isEmpty(this.sharedData["context-data"])) {
          this.sharedData = { "context-data": this.contextData };
        }

        this._searchTimeStamp = new Date().toLocaleString();
        this.requestConfig(this.name, this.contextData);

        //Fetch the available domains 
        if (this.showDomain) {
          this.getDomains();
        }
      }


      _onDropdownChange(e, detail) {
        var selectedDomain = e.detail.newValue;
        this.selectedDomain = selectedDomain.replace("_domain", "");
      }
      /**
      * Function to read the config info
      */
      onConfigLoaded(componentConfig) {
        if (!componentConfig || !componentConfig.config) {
          this.logError("Component configuration is missing, contact administrator.");
          this._onCancel();
          return;
        }

        var downloadConfig = componentConfig.config.download;
        if (downloadConfig && typeof downloadConfig.enableAsyncDownload === "boolean") {
          this.enableAsyncDownload = downloadConfig.enableAsyncDownload;
        }

        var config = componentConfig.config.upload;
        //Update the channel for the model to be uploaded
        if (config.steps) {
          config.steps = DataHelper.convertObjectToArray(config.steps);
          config.steps[0].component.properties["cop-context"].channel = this.channel;
        }
        this.set('config', config); //set the configuration
      }

      /**
      * Function to generate a request for fetching available domains 
      */
      getDomains() {
        var req = {
          "params": {
            "query": {
              "filters": {
                "typesCriterion": ["domain"]
              }
            },
            "fields": {
              "properties": ["_ALL"]
            }
          }
        };

        var domainsGet = this.shadowRoot.querySelector("#liquidGetDomains");
        if (domainsGet) {
          domainsGet.requestData = req;
          domainsGet.generateRequest();
        }

      }

      /**
      * Function to handle liquidGetDomains call success
      * Populating the received domains in the dropdown
      */
      _onDomainsReceived(e) {
        if (e.detail && e.detail.response && e.detail.response.response) {
          var response = e.detail.response.response;
          var domainList = response.entityModels;
          var domains = [];
          for (var i = 0; i < domainList.length; i++) {
            let item = {};
            item.title = domainList[i].properties.externalName;
            item.value = domainList[i].id;
            //item.id = domainList[i].name;
            domains.push(item);
          }
          this.set('domains', domains);
        }
      }

      /**
      * Function to handle liquidGetDomains call failure 
      */
      _onDomiansGetFailed(e) {
        this.logError("Unable to perform the action now. Contact administrator.", e.detail);
      }

      /**
      * Function to handle successful model upload 
      */
      _onModelUploadSuccess() {
        this.showSuccessToast("File uploaded successfully");
        this.fireBedrockEvent("onRefreshWidget", "", { ignoreId: true });
      }

      /**
      * Function to handle download model button click
      */
      _onModelDownloadClick(e, detail) {

        var modelDomain;
        if (this.showDomain) {
          modelDomain = this.selectedDomain;
        }
        else {
          modelDomain = this.modelDomain;
        }
        this.$.modelDownload.onDownload(this.profiles, this.fileName, modelDomain);
      }

      /**
      * Function to handle successful model download 
      */
      _onModelDownloadSuccess(e, detail) {
        if (this.enableAsyncDownload) {
          this._downloadTaskId = detail.workAutomationId;
          if (this.$.downloadTaskDialog) {
            this.$.downloadTaskDialog.open();
          }
        } else {
          this.showSuccessToast("Data Model downloaded successfully");
        }
      }

      _onShowTaskDetailsTap() {
        var mainApp = RUFUtilities.mainApp;
        if (mainApp && this._downloadTaskId) {
          var queryParams = {
            "id": this._downloadTaskId
          }
          ComponentHelper.setQueryParamsWithoutEncode(queryParams);
          mainApp.changePageRoutePath("task-detail");
        }
      }
    }
    customElements.define(RockModelIntegration.is, RockModelIntegration)
  </script>
</dom-module>