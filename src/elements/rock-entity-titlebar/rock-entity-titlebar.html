<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<!--
@group rock Elements
@element rock-entity-titlebar
@demo demo/index.html
-->
<dom-module id="rock-entity-titlebar">
    <template>
        <style include="bedrock-style-common">
            rock-titlebar {
                color: var(--pagetitle-text-color, #034c89);
                font-weight: var(--font-bold, bold);
            }

            rock-dimension-selector {
                margin-right: 10px;
                --dimesion-selector-container-popover: {
                    width: 70px;
                }
                ;
                --dimesion-selector-source-popover: {
                    width: 55px;
                }
                ;
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                }
                ;
                --dimesion-selector-locale-popover: {
                    width: 65px;
                }
                ;
            }

            #dimensionContainer {
                align-self: center;
                -webkit-align-self: center;
                width: 100%;
            }
        </style>
        <style>
        </style>
        <rock-titlebar icon="pebble-icon:view-dashboard" main-title="[[mainTitle]]" sub-title="[[subTitle]]" config="[[_titlebarConfig]]"
            non-minimizable="[[appConfig.nonMinimizable]]" non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right" class="full-width">
                    <rock-dimension-selector id="dimensionSelector" entity-id="[[_entityId]]" entity-type="[[_entityType]]" app-name="[[appName]]"
                        domain="[[domain]]" context-data="[[contextData]]"></rock-dimension-selector>
                </div>
        </rock-titlebar>
        <liquid-entity-data-get name="attributeGetDataServiceForTitleBar" operation="getbyids" data-index="[[dataIndex]]" data-sub-index="[[dataSubIndex]]"
            on-response="_onTitleAttributesGetResponse" on-error="_onTitleAttributesGetError"></liquid-entity-data-get>
        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="dimensionSelector"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            class RockEntityTitlebar
                extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior, RUFBehaviors.ComponentConfigBehavior], Polymer.Element) {
                static get is() { return 'rock-entity-titlebar' }
                ready() {
                    super.ready();
                }
                static get properties() {
                    return {
                        contextData: {
                            type: Object,
                            value: function () {
                                return {};
                            },
                            observer: '_onContextDataChange'
                        },
                        appConfig: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        appName: {
                            type: String,
                            value: null
                        },
                        domain: {
                            type: String,
                            value: null
                        },
                        _entityId: {
                            type: String,
                            value: null
                        },
                        _entityType: {
                            type: String,
                            value: null
                        },
                        mainTitle: {
                            type: String,
                            value: null
                        },
                        subTitle: {
                            type: String,
                            value: null
                        },
                        _titlebarConfig: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        titleAttributeRequest: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        dataIndex: {
                            type: String,
                            value: "entityData"
                        },
                        dataSubIndex: {
                            type: String,
                            value: "data"
                        }
                    }
                }
                /**
                *
                */
                connectedCallback() {
                    super.connectedCallback();
                }

                get attributeGetDataServiceForTitleBarLiq() {
                    this._attributeGetDataServiceForTitleBar = this._attributeGetDataServiceForTitleBar || this.shadowRoot.querySelector("[name=attributeGetDataServiceForTitleBar]");
                    return this._attributeGetDataServiceForTitleBar;
                }
                /**
                *
                */
                disconnectedCallback() {
                    super.disconnectedCallback();
                }
                _onContextDataChange() {
                    if (!_.isEmpty(this.contextData)) {
                        var context = DataHelper.cloneObject(this.contextData);
                        //App specific
                        var appName = ComponentHelper.getCurrentActiveAppName();
                        if (appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }

                        this.requestConfig('rock-entity-titlebar', context);
                    }
                }
                onConfigLoaded(componentConfig) {
                    if (componentConfig && componentConfig.config) {
                        this._titlebarConfig = componentConfig.config;

                        //Set the data-index and data-sub-index for liquid-entity-model-get call using liquid-entity-data-get
                        if (componentConfig.config["dataIndex"] && componentConfig.config["dataSubIndex"]) {
                            this.dataIndex = componentConfig.config["dataIndex"];
                            this.dataSubIndex = componentConfig.config["dataSubIndex"];
                            this.refreshTitleBar();
                        }
                        if (this.contextData && this.contextData.ItemContexts && this.contextData.ItemContexts.length) {
                            var entity = this.contextData.ItemContexts[0];
                            this._entityId = entity.id;
                            this._entityType = entity.type;
                        }
                    }
                }

                refreshTitleBar() {
                    var config = this._titlebarConfig;
                    if (!config || !this.attributeGetDataServiceForTitleBarLiq) return;

                    var attributeNames = [];
                    if (config.titleAttribute != "") {
                        attributeNames.push(config.titleAttribute);
                    }
                    if (config.subtitleAttribute != "") {
                        attributeNames.push(config.subtitleAttribute);
                    }
                    if (attributeNames.length > 0) {
                        if (this.contextData && this.contextData.ItemContexts && this.contextData.ItemContexts.length > 0) {
                            var itemContext = this.contextData.ItemContexts[0];
                            //add attribute names in item context
                            itemContext.attributeNames = attributeNames;
                            var req ;
                            if(config.applyLocaleCoalesce == undefined){
                                req = DataRequestHelper.createEntityGetRequest(this.contextData, true, true);
                            }
                            else if(!config.applyLocaleCoalesce){
                                req = DataRequestHelper.createEntityGetRequest(this.contextData, true, false);
                            }
                            this.attributeGetDataServiceForTitleBarLiq.requestData = req;
                            this.attributeGetDataServiceForTitleBarLiq.generateRequest();
                        }
                    }
                }

                _onTitleAttributesGetResponse(e) {
                    var titleAttributeResponse = e.detail.response;
                    this.logInfo("EntityTitleAttributeResponse", "response", JSON.stringify(titleAttributeResponse, null, 2));

                    var attributesData = [];
                    if (DataHelper.validateGetEntitiesResponse(titleAttributeResponse)) {

                        var entity = titleAttributeResponse.content.entities[0];

                        if (entity) {
                            this.setTitleBar(entity);
                        }
                    } else {
                        this.set("mainTitle", "Title could not be loaded");
                        this.logError("rock-entity-titlebar - Title attribute get response error", e.detail);
                    }
                }

                _onTitleAttributesGetError(e) {
                    this.set("mainTitle", "Title could not be loaded");
                    this.logError("rock-entity-titlebar - Title attribute get response error", e.detail);
                }

                async setTitleBar(entity) {
                    var config = this._titlebarConfig;

                    let titleAttribute = !_.isEmpty(config.titleAttribute) ? EntityHelper.getAttribute(entity, config.titleAttribute) : undefined;
                    let subtitleAttribute = !_.isEmpty(config.subtitleAttribute) ? EntityHelper.getAttribute(entity, config.subtitleAttribute) : undefined;

                    let mainTitle = this._getTitlebarValueFromAttribute(titleAttribute);
                    let subTitle = this._getTitlebarValueFromAttribute(subtitleAttribute);

                    //Check for the entity property 
                    if(!mainTitle && entity[config.titleAttribute]){
                        mainTitle = entity[config.titleAttribute];  
                    }
                    
                    mainTitle = mainTitle ? mainTitle : entity.id;

                    if (!subTitle) {
                        subTitle = await EntityTypeManager.getInstance().getTypeExternalNameByIdAsync(entity.type);
                    }

                    if (!mainTitle || mainTitle == "") {
                        mainTitle = "No Title";
                    }
                    if (!subTitle || subTitle == "") {
                        subTitle = "No Sub-Title";
                    }

                    this.mainTitle = mainTitle;
                    this.subTitle = subTitle;

                    //after setting the title raise an event
                    this.fireBedrockEvent('on-set-titlebar', { "mainTitle": this.mainTitle });
                }

                _getTitlebarValueFromAttribute(attribute) {
                    var firstValueContext = ContextHelper.getFirstValueContext(this.contextData);
                    var defaultValCtx = DataHelper.getDefaultValContext();
                    var value = undefined;

                    if (attribute && attribute.values) {
                        var currentValues = AttributeHelper.getAttributeValues(attribute.values, firstValueContext);
                        if (_.isEmpty(currentValues)) {
                            currentValues = AttributeHelper.getAttributeValues(attribute.values, defaultValCtx);
                        }
                        if (!_.isEmpty(currentValues)) {
                            value = currentValues[0];
                        }
                    }

                    return value;
                }

                _onDimensionsChanged(e) {
                    this.fireBedrockEvent('dimension-selector-data-changed', e.detail);
                }

                get dimensionSelector() {
                    this._dimensionSelector = this._dimensionSelector || this.shadowRoot.querySelector("#dimensionSelector");

                    return this._dimensionSelector;
                }

                getDimensionSelectorConfig() {
                    return this.dimensionSelector ? this.dimensionSelector.getDimensionSelectorConfig() : null;
                }

                getSelectedDimensions() {
                    return this.dimensionSelector ? this.dimensionSelector.getSelectedDimensions() : null;
                }
            }
            customElements.define(RockEntityTitlebar.is, RockEntityTitlebar);
        })()
    </script>
</dom-module>