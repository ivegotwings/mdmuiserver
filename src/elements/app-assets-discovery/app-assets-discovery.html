<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-query-builder-behavior/bedrock-query-builder-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../rock-assets-search-grid/rock-assets-search-grid.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html" />
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html" />
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">
<link rel="import" href="../rock-entity-type-model-lov/rock-entity-type-model-lov.html">
<link rel="import" href="../rock-search-query-parser/rock-search-query-parser.html" />
<link rel="import" href="../rock-query-builder/rock-query-builder.html" />

<dom-module id="app-assets-discovery">
    <template>
        <style include="bedrock-style-common"></style>
        <style include="iron-flex"></style>
        <custom-style>
            <style>
                #dimensionContainer {
                    align-self: center;
                    -webkit-align-self: center;
                }

                :host {
                    --item-length-overflow: {
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                }

                pebble-popover {
                    --pebble-popover-width: 260px;
                    --pebble-popover-max-width: 100%;
                }

                pebble-popover paper-item {
                    cursor: pointer;
                    font-size: var(--default-font-size, 14px);
                    padding: 0 0 0 0;
                    min-height: 40px;
                }

                pebble-popover paper-item iron-icon {
                    --iron-icon-width: 18px;
                    --iron-icon-height: 18px;
                    color: var(--palette-white, #fff);
                }

                pebble-button {
                    --pebble-icon: {
                        color: var(--palette-white, #fff) !important;
                    }
                }

                .badge {
                    font-weight: normal;
                    border-radius: 50%;
                    margin-right: 10px;
                    width: 25px;
                    height: 25px;
                    background-color: var(--default-notification-color, #ed204c);
                    opacity: 1.0;
                    color: var(--default-notification-text-color, #ffffff);
                    @apply --layout;
                    @apply --layout-center-center;
                    @apply --paper-font-common-base;
                }

                rock-header {
                    padding: 20px 20px 0 20px;
                }

                pebble-actions {
                    --pebble-icon: {
                        color: var(--white, #fff);
                    }
                }

                .quick-manage-container {
                    height: auto;
                    width: 31%;
                    display: block;
                    position: relative;
                }

                .grid-quick-manage-container {
                    width: 70%;
                }

                pebble-vertical-divider {
                    --pebble-vertical-divider-color: #c1cad4;
                    height: 100%;
                    border: 0px;
                    min-height: 0px;
                    width: 2px;
                    margin-top: 0px;
                    margin-right: 0px;
                    margin-bottom: 0px;
                    margin-left: 0px;
                }

                .container {
                    width: 100%;
                }

                .contentContainer {
                    height: calc(100% - 30px);
                }

                pebble-actions {
                    --pebble-manual-actions: {
                        margin-top: 0;
                    }
                }

                #entityTypeFilterContainer {
                    padding-right: 10px;
                }

                /* Search */

                .search-container .resetsearch {
                    position: absolute;
                    right: 0;
                    bottom: -14px;
                    font-size: var(--font-size-xs, 10px);
                    color: var(--link-text-color);
                }

                .search-container .resetsearch pebble-button {
                    height: auto;
                    --pebble-button: {
                        font-size: var(--font-size-xs, 10px)!important;
                        height: auto;
                        padding-bottom: 0;
                    }

                    --pebble-button-left-icon: {
                        width: 14px !important;
                        height: 14px!important;
                        margin-right: 2px;
                        margin-top: 3px;
                        bottom: -1px;
                    }
                }

                .search-container {
                    position: relative;
                    display: inline-block;
                    width: 100%;
                }

                .advancedsearch {
                    position: relative;
                }

                .underline {
                    height: 16px;
                    --pebble-button: {
                        text-decoration: underline;
                        padding-top: 0;
                        padding-right: 0;
                        padding-bottom: 0;
                        padding-left: 0;
                    }
                }

                #entityTypeFilterButton {
                    letter-spacing: 0.5px;
                }

                .queryBuilderContainer {
                    position: absolute;
                    z-index: 3;
                    width: 560px;
                    top: 32px;
                    right: 0;
                    border-radius: 3px;
                    box-shadow: 0 0 var(--popup-box-shadow-size, 8px) 0 var(--popup-box-shadow, #8A98A3);
                }

                .queryBuilderContainer paper-card {
                    width: 100%;
                    max-height: 490px;
                    box-shadow: none;
                }

                #assetGridComponents {
                    width: 100%;
                    display: inline-flex;
                }

                #assetGridInfo {
                    position: absolute;
                    top: 0;
                    left: 20px;
                    right: 20px;
                    bottom: auto;
                    display: none;
                }
            </style>
        </custom-style>

        <rock-layout>
            <liquid-config-aggregate-get id="getAssetsDiscoveryAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-assets-discovery"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <rock-titlebar slot="rock-titlebar" icon="pebble-md-icons:Advancesearch" main-title="Assets Search & Refine" non-minimizable="[[appConfig.nonMinimizable]]"
                non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="[[getConfig('rock-dimension-selector')]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <rock-header slot="rock-header">
                <div class="fixed-content" slot="fixed-content">
                    <div class="layout horizontal">
                        <div id="entityTypeFilterContainer">
                            <pebble-button id="entityTypeFilterButton" icon="pebble-sm-icons:Filter-wt" button-text="Entity Type" dropdown-icon noink
                                class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger" on-tap="_openEntityTypeFilterLov"></pebble-button>
                            <pebble-popover id="entityTypeFilterPopover" for="entityTypeFilterButton" no-overlap auto-fit-on-attach vertical-align="auto"
                                horizontal-align="auto">
                                <rock-entity-type-model-lov id="entityTypeModelLov" select-all="true" domain="[[domain]]" allowed-entity-types="[[_allowedEntityTypes]]"
                                    selected-items="{{selectedEntityTypes}}" show-action-buttons></rock-entity-type-model-lov>
                            </pebble-popover>
                            <bedrock-pubsub event-name="entity-type-model-lov-confirm-button-tap" handler="_onSelectedEntityTypesChange" target-id="entityTypeModelLov"></bedrock-pubsub>
                            <bedrock-pubsub event-name="entity-type-model-lov-close-button-tap" handler="_onEntityTypePopoverClose" target-id="entityTypeModelLov"></bedrock-pubsub>
                        </div>

                        <div class="flex">
                            <!-- search bar-->
                            <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                            <div class="search-container">
                                <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                                <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                                    <pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                                </div>
                            </div>
                        </div>
                        <template is="dom-if" if="[[_getVisibility('rock-query-builder')]]">
                            <div class="advancedsearch m-l-10">
                                <pebble-button class="btn-link underline" on-tap="_showQueryBuilder" button-text="Advanced"></pebble-button>
                                <template is="dom-if" if="[[_queryBuilderEnabled]]">
                                    <div class="queryBuilderContainer">
                                        <paper-card>
                                            <div class="card-content">
                                                <rock-query-builder id="queryBuilder" domain="[[domain]]" allowed-entity-types="{{_allowedEntityTypes}}" selected-entity-types="{{_currentEntityTypes}}"
                                                    input-query-string="{{inputQueryString}}" attribute-grid-data="{{attributeGridData}}"
                                                    context-data="{{contextData}}" workflow-name="[[workflowName]]" search-query="[[_searchQuery]]"></rock-query-builder>
                                            </div>
                                        </paper-card>
                                    </div>
                                </template>
                            </div>

                            <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="hide-query-builder" handler="_hideQueryBuilder" target-id="queryBuilder"></bedrock-pubsub>
                            <bedrock-pubsub event-name="on-query-build" handler="_onQueryBuild" target-id="queryBuilder"></bedrock-pubsub>
                        </template>
                    </div>
                    <div class="layout horizontal p-t-10">
                        <div class="flex searchFilterTag">
                            <!-- Search Filter Tags -->
                            <rock-entity-search-filter id="searchFilter" selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                types-criterion="[[_typesCriterion]]" tags="{{tags}}" filters-config="[[getConfig('rock-assets-search-discovery', '', 'attributesFilterSortDetails')]]"></rock-entity-search-filter>
                            <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="build-query" handler="_buildQueryString"></bedrock-pubsub>
                        </div>
                        <div class="action-buttons">
                            <!-- Actions buttons and its popover -->
                            <pebble-actions id="workflowActions" hidden button-icon="pebble-md-icons:assignedactions" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
                                button-text="Workflow Actions" actions-data="[[getConfig('workflow-actions')]]"></pebble-actions>
                            <pebble-button class="btn btn-primary" button-text="Quick Manage" on-tap="_onTapQuickManage"></pebble-button>
                            <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                            <rock-business-function-dialog id="rollupDialog"></rock-business-function-dialog>
                            <rock-business-function-dialog id="wfTransitionDialog"></rock-business-function-dialog>
                            <rock-business-function-dialog id="wfAssignmentDialog"></rock-business-function-dialog>
                        </div>
                    </div>
                </div>
            </rock-header>
            <div class="layout horizontal contentContainer p-relative">
                <div id="assetGridInfo" class="default-message"> No results found for the given criteria </div>
                <div id="assetGridComponents">
                    <div id="entityGridContainer" class$="[[_applyClass(_quickManageEnabled)]]">
                        <rock-assets-search-grid id="assetsSearchGrid" context-data="[[contextData]]" types-criterion="[[_typesCriterion]]" grid-config="[[getConfig('rock-assets-search-grid')]]"
                            search-filters="{{_selectedSearchFilters}}" search-query="[[_searchQuery]]" workflow-criterion="[[_workflowCriterion]]"
                            govern-data-criterion="[[_governDataCriterion]]" result-record-size="{{_gridFullLength}}"></rock-assets-search-grid>
                        <bedrock-pubsub event-name="empty-grid" handler="_onAssetGridEmpty" target-id="assetsSearchGrid"></bedrock-pubsub>
                        <bedrock-pubsub event-name="grid-with-data" handler="_onAssetGridFull" target-id="assetsSearchGrid"></bedrock-pubsub>
                        <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
                    </div>
                    <template is="dom-if" if="[[_quickManageEnabled]]">
                        <div>
                            <pebble-vertical-divider></pebble-vertical-divider>
                        </div>
                        <div class="quick-manage-container p-15">
                            <rock-entity-quick-manage id="entityQuickManage" no-header context-data="[[contextData]]" current-index="{{_currentIndex}}"
                                current-record-size="[[_gridFullLength]]" selected-entity="[[_selectedEntity]]" tab-config="{{getConfig('rock-entity-quick-manage', '', 'rock-tabs')}}"
                                toolbar-config="{{getConfig('rock-entity-quick-manage', '', 'pebble-toolbar')}}"></rock-entity-quick-manage>
                            <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                            <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                            <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                        </div>
                    </template>
                </div>
            </div>
            <rock-search-query-parser id="queryParser"></rock-search-query-parser>
            <bedrock-pubsub event-name="on-search-filters" handler="_onSearchFiltersChange" target-id="queryParser"></bedrock-pubsub>
        </rock-layout>
        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="dimensionSelector"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-assets-discovery',
                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () { return {}; },
                        computed: 'getConfig("rock-assets-search-grid")',
                        observer: '_onGridConfigChange'
                    },
                    _componentConfig: {
                        type: Object,
                        value: function () { return {}; },
                        computed: 'getConfig("rock-assets-search-discovery","","componentsVisibility")'
                    },
                    _typesCriterion: {
                        type: Array,
                        value: function () { return []; }
                    },
                    domain: {
                        type: String,
                        value: "digitalAsset"
                    },
                    _quickManageEnabled: {
                        type: Boolean,
                        value: false,
                        observer: '_onQuickManageChanged'
                    },
                    _currentIndex: {
                        type: Number,
                        value: -1
                    },
                    _gridFullLength: {
                        type: Number,
                        value: 0
                    },
                    /**
                     * Indicates selected item
                     */
                    _selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _searchQuery: {
                        type: String,
                        value: ''
                    },
                    _workflowCriterion: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _governDataCriterion: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _rockEntitySearchFilter: {
                        type: Object
                    },
                    _rockSearchFilter: {
                        type: Object
                    },
                    _currentWorkflowAction: {
                        type: String
                    },
                    _currentEntityIndex: {
                        type: Number,
                        value: 0
                    },
                    _wfAssignmentRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _selectedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    selectedEntityIds: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _selectedSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _resetSearchEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _failedEntityType: {
                        type: String,
                    },
                    failedEntityIds: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    tags: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    successEntityIds: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _allowedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    workflowName: {
                        type: String,
                        value: ""
                    },
                    _currentEntityTypes: {
                        type: Array,
                        computed: "_getActiveEntityTypes(_typesCriterion)"
                    },
                    _queryBuilderEnabled: {
                        type: Boolean,
                        value: false
                    },
                    inputQueryString: {
                        type: String,
                        value: ""
                    },
                    attributeGridData: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },
                    _relationshipSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    queryParams:{
                        type:String,
                        value:""
                    }

                },

                behaviors: [
                    RUFBehaviors.AppBehavior,
                    RUFBehaviors.QueryBuilderBehavior
                ],

                ready: function () {
                    this.shadowRoot.querySelector("#searchBar").searchInput = [];
                    this._allowedEntityTypes = this.appSetting('allowedEntityTypes');
                    this.workflowName = DataHelper.getParamValue('wfName');
                    var workflowName = this.workflowName;
                    if (!_.isEmpty(workflowName)) {
                        var workflowShortName = DataHelper.getParamValue('wfShortName');
                        var workflowActivityName = DataHelper.getParamValue('wfActivityName');
                        var workflowActivityExternalName = DataHelper.getParamValue('wfActivityExternalName');
                        var businessConditionName = DataHelper.getParamValue('bcId');
                        var businessConditionExternalName = DataHelper.getParamValue('bcExternalName');
                        var user = DataHelper.getParamValue('user');
                        var status = DataHelper.getParamValue('status');
                        var userId = "";
                        var mappedEntityTypes = DataHelper.getParamValue('mappedEntityTypesString');
                        if (mappedEntityTypes && mappedEntityTypes !== "") {
                            this._mappedEntityTypes = mappedEntityTypes.split("#@#");
                        }

                        if (user.toLowerCase() == "all") {
                            userId = "";
                        } else if (user.toLowerCase() == "currentuser") {
                            userId = DataHelper.getUserId();
                        } else if (user.toLowerCase() == "unassigned") {
                            userId = "_UNASSIGNED";
                        }


                        var workflowCriterion = {
                            "workflowName": workflowName,
                            "workflowShortName": workflowShortName,
                            "workflowActivityName": workflowActivityName,
                            "workflowActivityExternalName": workflowActivityExternalName,
                        };

                        var governDataCriterion = {
                            "userId": userId,
                            "businessConditionExternalName": businessConditionExternalName,
                            "status": status
                        }
                        if (businessConditionName) {
                            var businessConditionNames = businessConditionName.split("#@#");
                            if (businessConditionNames.length > 1) {
                                governDataCriterion.businessConditionNames = businessConditionNames;
                            } else {
                                governDataCriterion.businessConditionName = businessConditionName;
                            }
                        }

                        if (!_.isEmpty(workflowCriterion)) {
                            this._workflowCriterion = workflowCriterion;
                            this.shadowRoot.querySelector("#workflowActions").hidden = false;
                            if (!_.isEmpty(governDataCriterion)) {
                                this._governDataCriterion = governDataCriterion;
                            }
                        }
                    }

                    this._searchQuery = DataHelper.getParamValue('searchtext') || "";
                },

                created: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };

                    this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];
                },
                attached: function () {
                    this._searchTimeStamp = new Date().toLocaleString();
                    this._setGridHeight();
                },

                /**
                 * Function to display the left nav info
                 */ 
                getAppCurrentStatus: function (customArgs) {
                    if(customArgs && customArgs.queryParams){
                        this.queryParams = customArgs.queryParams;
                    }
                    return {
                        title:"Assets Search & Refine",
                        subTitle: "Last Opened",
                        subTitleValue: this._searchTimeStamp ? this._searchTimeStamp : new Date().toLocaleString(),
                        queryParams: this.queryParams
                    };
                },

                /**
                 *  After the page has loaded, update the title to display on the left nav
                 */ 
                updateAppCurrentStatus: function() {
                    if(this.inputQueryString) {
                        var appStatus = this.getAppCurrentStatus();
                        appStatus.title = this.inputQueryString;
                        this.fireBedrockEvent('app-status-updated', appStatus, { appId: "main-app", ignoreId: true });
                    }                   
                },

                _onApplicationConfigReceived: function (e) {
                    this.set('applicationConfig', e.detail);
                },
                // Refine Filter
                //Capture typesCriterion for Refine Filter
                _onGridConfigChange: function () {
                    if (!_.isEmpty(this._gridConfig)) {
                        if (this._mappedEntityTypes && this._mappedEntityTypes.length > 0) {
                            this._typesCriterion = this._mappedEntityTypes;
                        } else if (this._gridConfig.dataRequest) {
                            this._typesCriterion = this._gridConfig.dataRequest.typesCriterion;
                        }
                        this.selectedEntityTypes = this._getSelectedEntityTypes(this._typesCriterion);
                        this.domain = this._gridConfig.dataRequest
                            && this._gridConfig.dataRequest.domains
                            && this._gridConfig.dataRequest.domains.length > 0 ?
                            this._gridConfig.dataRequest.domains[0] : "digitalAsset";

                        this._buildQueryString();
                    }
                },

                /**
                *  Returns an array of selected entity titles
                */
                _getSelectedEntityTypeTitles: function (selectedEntities) {
                    var selectedEntityTypeTitles = selectedEntities.map(function (selectedEntity) {
                        return selectedEntity['title'];
                    });
                    return selectedEntityTypeTitles;
                },
                _getSelectedEntityTypes: function (entityTypes) {
                    var selectedEntityTypesForLOV = [];
                    for (var i in entityTypes) {
                        var itemObj = {
                            "title": entityTypes[i],
                            "id": entityTypes[i]
                        };
                        if (!this._isItemPresent(selectedEntityTypesForLOV, entityTypes[i])) {
                            selectedEntityTypesForLOV.push(itemObj);
                        }
                    }
                    return selectedEntityTypesForLOV;
                },
                _isItemPresent: function (items, id) {
                    var presentItem = items.find(function (item) {
                        return item.id == id;
                    });
                    return !!presentItem;
                },

                //Rock search
                _onSearch: function (e, detail, sender) {
                    if (!_.isEmpty(detail)) {
                        this._searchQuery = detail.query;
                    }
                    this._searchTimeStamp = new Date().toLocaleString();
                    this._buildQueryString();
                },

                _showQueryBuilder: function (e) {
                    /*
                    //TODO : Handling the user input query
                    var inputQueryString = this._searchBarElement.query.toLowerCase();
                    if(inputQueryString && (inputQueryString.substring(0, 4) == "show"){
                        this.inputQueryString = this._searchBarElement.query;
                    } */

                    var queryBuilder = this.shadowRoot.querySelector("#queryBuilder");
                    if (queryBuilder) {
                        queryBuilder.onOpenQueryBuilder();
                    }
                    this._queryBuilderEnabled = true;
                },

                _hideQueryBuilder: function (e) {
                    this._queryBuilderEnabled = false;
                },
                //Rock search clear
                _resetSearch: function () {
                    this._searchQuery = '';
                    this.tags = [];

                    var rockSearchBar = this.shadowRoot.querySelector('#searchBar');
                    if (rockSearchBar) {
                        rockSearchBar.query = "";
                    }

                    //Reset the entityTypes according to the gridConfig 
                    this.selectedEntityTypes = this._getSelectedEntityTypes(this._gridConfig.dataRequest.typesCriterion);
                    var detail = {
                        data: this.selectedEntityTypes
                    }

                    this._selectedSearchFilters = [];
                    this.$.searchFilter.clearSearchFilters();
                    this._resetSearchEnabled = false;

                    //Clear the advanced search options
                    this.inputQueryString = "";
                    this.attributeGridData = new Array();
                    this.set("_workflowCriterion", new Object());
                    this.set("_governDataCriterion", new Object());

                    var queryBuilder = this.shadowRoot.querySelector("#queryBuilder");
                    if (queryBuilder) {
                        queryBuilder.resetQueryBuilder();
                    }

                    this._buildQueryString();
                },

                // Grid
                _getSearchGrid: function () {
                    return ElementHelper.getElement(this, "#assetsSearchGrid");
                },
                _onSelectingGridItem: function (e, detail, sender) {
                    if (this._quickManageEnabled) {
                        this._getSearchGrid().clearSelection();
                        this._selectedEntity = detail.item;
                        if (!_.isEmpty(this._selectedEntity)) {
                            var itemContext = {
                                'id': this._selectedEntity.id,
                                'type': this._selectedEntity.type
                            };
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                            Polymer.Async.microTask.run(() => {
                                this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                                if (this.shadowRoot.querySelector("#entityQuickManage")) {
                                    this.shadowRoot.querySelector("#entityQuickManage").reload();
                                }
                            });
                        }
                    }
                },
                _applyClass: function () {
                    if (this._quickManageEnabled) {
                        return "grid-quick-manage-container";
                    }

                    return "container";
                },
                _onTapQuickManage: function () {

                    this._quickManageEnabled = !this._quickManageEnabled;
                },
                _onQuickManageChanged: function () {
                    var grid = this._getSearchGrid();
                    if (this._quickManageEnabled) {
                        var selectedCount = grid.getSelectedItems();
                        if (selectedCount.length > 1) {
                            this.showWarningToast("Cannot use multiple assets for Quick Manage");
                        }
                        var selectedItem = selectedCount[selectedCount.length - 1];
                        this._selectedEntity = selectedItem;
                        if (!_.isEmpty(selectedItem)) {
                            var itemContext = {
                                'id': selectedItem.id,
                                'type': selectedItem.type
                            };
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                            grid.clearSelection(); //Clear current selection
                            grid.selectItem(selectedItem); //
                            this._currentIndex = grid.getSelectedItemIndex();
                            grid.scrollToIndex(this._currentIndex);
                            if (this.shadowRoot.querySelector("#entityQuickManage")) {
                                this.shadowRoot.querySelector("#entityQuickManage").reload();
                            }
                        }
                    } else {
                        this._currentIndex = -1;
                    }
                },
                _onClickPrevious: function (e, detail, sender) {
                    if (this._currentIndex > 0) {
                        this._selectEntity(this._currentIndex - 1, 'previous');
                    }
                },
                _onClickNext: function (e, detail, sender) {
                    if (this._currentIndex < this._gridFullLength) {
                        this._selectEntity(this._currentIndex + 1);
                    }
                },
                _selectEntity: function (index, nav) {
                    if (!(index < 0)) {
                        var grid = this._getSearchGrid();
                        var gridData = grid.getData();

                        if (gridData.length > 0 && index < this._gridFullLength) {
                            if (gridData[index]) {
                                this._selectedEntity = gridData[index];
                                grid.selectItem(gridData[index]);
                                var itemContext = {
                                    'id': this._selectedEntity.id,
                                    'type': this._selectedEntity.type
                                };
                                this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                                this._currentIndex = index;
                                grid.clearSelection();
                                grid.selectItem(gridData[index]);
                                grid.scrollToIndex(this._currentIndex);
                            } else {
                                grid.scrollToIndex(this._currentIndex - 1);
                                setTimeout(() => {
                                    this._selectEntity(index);
                                }, 10);
                            }
                        }
                    }
                },

                _getElement: function (element) {
                    if (element == "rockEntitySearchFilter") {
                        if (!this._rockEntitySearchFilter) {
                            this._rockEntitySearchFilter = this.shadowRoot.querySelector("#searchFilter");
                        }

                        return this._rockEntitySearchFilter
                    }
                    else if (element == "rockSearchFilter") {
                        var entitySearchFilter = this._getElement("rockEntitySearchFilter");
                        if (entitySearchFilter && entitySearchFilter.shadowRoot) {
                            this._rockSearchFilter = entitySearchFilter.shadowRoot.querySelector("rock-search-filter");
                        }

                        return this._rockSearchFilter
                    }
                },
                _openEntityTypeFilterLov: function () {
                    this.shadowRoot.querySelector("#entityTypeFilterPopover").open();
                },
                _onSelectedEntityTypesChange: function (e, detail) {
                    this._buildQueryString();
                },
                /*_updateSearchEntityTypeTag: function(selectedItems){
                    var rockSearchFilter = this._getElement("rockSearchFilter");
                    if (rockSearchFilter) {
                        rockSearchFilter.onEntityTypeChange(selectedItems);
                    }
                },*/
                _onEntityTypePopoverClose: function (e, detail) {
                    this.shadowRoot.querySelector("#entityTypeFilterPopover").close();
                },
                _onActionItemTap: function (e, detail, sender) {
                    var selectedItems = [];
                    var selectionMode, selectionQuery, eventName;
                    var searchGrid = this.shadowRoot.querySelector("#assetsSearchGrid");

                    if (searchGrid) {
                        selectedItems = searchGrid.getSelectedItems();
                        selectionMode = searchGrid.getSelectionMode();
                        selectionQuery = searchGrid.getSelectedItemsAsQuery();
                    }

                    if (detail && detail.data) {
                        eventName = detail.data.eventName;
                    }

                    if (!eventName) {
                        this.showErrorToast("Unknown action triggered, system cannot do the process.");
                        return;
                    }

                    var asyncAvailable = false;
                    if (eventName == "action-takeTask" ||
                        eventName == "action-releaseTask" ||
                        eventName == "action-wfTransitions") {
                        asyncAvailable = true;
                    }

                    if (!asyncAvailable || (asyncAvailable && selectionMode == "count")) {
                        if (_.isEmpty(selectedItems)) {
                            this.showErrorToast("Select atleast one entity for which you want to perform this action.");
                            return;
                        }
                    }

                    if (asyncAvailable) {
                        if (selectionMode == "query" && _.isEmpty(selectionQuery)) {
                            this.showErrorToast("Selection query should be available for which you want to perform this action.");
                            return;
                        }
                    } else { //Check needed when async not available
                        if (selectedItems.length > 20) {
                            this.showErrorToast("Maximum 20 entities can be selected.");
                            return;
                        }
                    }

                    if (eventName == "action-takeTask") {
                        this._showAssignmentDialog(detail, "take", selectionMode, selectionQuery, selectedItems);
                    }
                    else if (eventName == "action-releaseTask") {
                        this._showAssignmentDialog(detail, "release", selectionMode, selectionQuery, selectedItems);
                    }
                    else if (eventName == "action-wfTransitions") {
                        this._showTransitionDialog(detail, selectionMode, selectionQuery, selectedItems);
                    }
                    else if (eventName == "action-rollup") {
                        this._showRollupDialog(detail, selectedItems);
                    }
                },
                _showAssignmentDialog: function (detail, action, selectionMode, selectionQuery, selectedItems) {
                    var assignmentDialog = this.$$("#wfAssignmentDialog");
                    assignmentDialog.name = detail.data.componentName;
                    assignmentDialog.sharedData = { "selection-mode": selectionMode, "selection-query": selectionQuery, "selected-entities": selectedItems, "context-data": this.contextData, "assignment-Action": action, "workflow-external-name": this._workflowCriterion.workflowName, "workflow-activity-external-name": this._workflowCriterion.workflowActivityExternalName, "workflow-name": this._workflowCriterion.workflowShortName, "workflow-activity-name": this._workflowCriterion.workflowActivityName };
                    assignmentDialog.open();
                },
                _showTransitionDialog: function (detail, selectionMode, selectionQuery, selectedItems) {
                    var currentWorkflow = {
                        "name": this._workflowCriterion.workflowName,
                        "activityName": this._workflowCriterion.workflowActivityName,
                        "activityExternalName": this._workflowCriterion.workflowActivityExternalName
                    }

                    var transitionDialog = this.$$("#wfTransitionDialog");
                    transitionDialog.name = detail.data.componentName;
                    transitionDialog.sharedData = { "selection-mode": selectionMode, "selection-query": selectionQuery, "selected-entities": selectedItems, "context-data": this.contextData, "current-workflow": currentWorkflow };
                    transitionDialog.open();
                    var existingTitle = transitionDialog.getTitle();
                    transitionDialog.setTitle(existingTitle + " - " + this._workflowCriterion.workflowActivityExternalName);
                },
                _showRollupDialog: function (detail, selectedItems) {
                    var rollupDialog = this.$$("#rollupDialog");
                    rollupDialog.name = detail.data.componentName;
                    rollupDialog.configName = detail.data.componentConfigName;
                    rollupDialog.sharedData = { "context-data": this.contextData, "selected-entities": selectedItems };
                    rollupDialog.open();
                },
                _showResetSearch: function (e) {
                    var rockSearchBar = this.shadowRoot.querySelector('#searchBar');
                    var rockSearchFilter = this._getElement('rockSearchFilter');
                    var query = '';
                    var tags = [];

                    if (rockSearchBar) {
                        query = rockSearchBar.query;
                    }

                    if (rockSearchFilter) {
                        tags = rockSearchFilter.tags;
                    }

                    if (!_.isEmpty(query) || tags.length > 0 || this.inputQueryString != "") {
                        this._resetSearchEnabled = true;
                    } else {
                        this._resetSearchEnabled = false;
                    }
                },
                _showToastMessage: function (msgObject) {
                    if (msgObject) {
                        if (msgObject.type == "error") {
                            this.showErrorToast(msgObject.message, 10000);
                        } else if (msgObject.type == "success") {
                            this.showSuccessToast(msgObject.message, 10000);
                        }
                    }
                },
                _setGridHeight: function () {
                    var rockLayout = this.shadowRoot.querySelector('rock-layout');
                    if (rockLayout) {
                        var layout = rockLayout.shadowRoot.querySelector('#rockLayoutContainer');
                        var rockGridHeight = 0;
                        if (layout) {
                            var footer = layout.querySelector('rock-footer');
                            rockGridHeight = layout.offsetHeight;
                            if (footer) {
                                rockGridHeight = rockGridHeight - footer.offsetHeight;
                            }
                        }
                        var rockGrid = this.shadowRoot.querySelector('rock-assets-search-grid');
                        if (rockGrid && rockGridHeight > 0) {
                            rockGrid.style["--rock-grid-height"] = rockGridHeight - 110 + 'px';
                        }
                    }
                },

                /**
                * When the grid data is empty, hide the grid,action buttons and show the "no data" info
                **/
                _onAssetGridEmpty: function () {
                    var gridComponents = this.shadowRoot.querySelector("#assetGridComponents");
                    gridComponents.style['visibility'] = "hidden";
                    var actionBtns = this.shadowRoot.querySelector(".action-buttons");
                    actionBtns.style['visibility'] = "hidden";

                    var gridInfo = this.shadowRoot.querySelector("#assetGridInfo");
                    gridInfo.style['display'] = "block";

                    this._quickManageEnabled = false;
                },

                /**
                * When the grid data is not empty, show the grid,action buttons and hide the "no data" info
                **/
                _onAssetGridFull: function () {
                    var gridInfo = this.shadowRoot.querySelector("#assetGridInfo");
                    gridInfo.style['display'] = "none";

                    var gridComponents = this.shadowRoot.querySelector("#assetGridComponents");
                    gridComponents.style['visibility'] = "visible";
                    var actionBtns = this.shadowRoot.querySelector(".action-buttons");
                    actionBtns.style['visibility'] = "visible";
                },

                /**
                 * Check if the component is visible according to the config 
                 */
                _getVisibility: function (componentName) {
                    if (typeof (this._componentConfig) == "object") {
                        var componentsVisibility = this._componentConfig;
                        for (var i = 0; i < componentsVisibility.length; i++) {
                            if (componentsVisibility[i].name === componentName) {
                                return componentsVisibility[i].visible;
                            }
                        }
                    }
                },

                /**
                * Getting the active selected entities when typescriterion changes
                **/
                _getActiveEntityTypes: function (activeEntities) {
                    var selectedEntityTypes = new Array();
                    if (activeEntities) {
                        selectedEntityTypes = this._getSelectedEntityTypes(activeEntities);
                    }
                    return selectedEntityTypes;
                },
                /**
                * When Refine more tags get added/updated, search query needs to be built and advanced search options need to be incorporated
                */
                _buildQueryString: function (e, detail) {
                    //Closing the quick manage to enable search if it is opened when search query is built
                    if (this._quickManageEnabled) {
                        this._onTapQuickManage();
                    }
                    var workflowListArray = "";
                    if (!_.isEmpty(this._workflowCriterion)) {
                        workflowListArray = [];
                        var workflowData = {
                            "workflowShortName": this._workflowCriterion.workflowShortName,
                            "workflowExternalName": this._workflowCriterion.workflowName,
                            "workflowActivityShortName": this._workflowCriterion.workflowActivityName,
                            "workflowActivityExternalName": this._workflowCriterion.workflowActivityExternalName
                        };
                        workflowListArray.push(workflowData);
                    }

                    //Handling a case where query is already been built inside the query builder                 
                    var queryBuilder = this.shadowRoot.querySelector("#queryBuilder");
                    if (queryBuilder) {
                        var queryBuilderData = queryBuilder.getQueryBuilderData();
                        if (!queryBuilderData.workflowGridData) {
                            if (!_.isEmpty(workflowListArray)) {
                                queryBuilderData.workflowGridData = workflowListArray;
                            }
                        }
                    }

                    //User has input some keyword search criteria
                    var keywordSearchStr = "";
                    if (this._searchQuery) {
                        keywordSearchStr = this._searchQuery;
                    }
                    var entityTypes = this.getSelectedEntityTypes(this.selectedEntityTypes);
                    var attributeListArray = new Array();

                    if (detail) {
                        var attributeList = detail;
                        for (var i = 0; i < attributeList.length; i++) {
                            let newItem = {
                                name: attributeList[i].longName,
                                value: attributeList[i].displayValue,
                                attributeModel: attributeList[i].options
                            }
                            attributeListArray.push(newItem);
                        }
                        this.attributeGridData = attributeListArray;
                    } else if (this.attributeGridData) {
                        attributeListArray = this.attributeGridData;
                    }

                    var queryString = this.buildQuery(entityTypes, attributeListArray, queryBuilderData, false, keywordSearchStr);

                    var parsableString = this.buildQuery(entityTypes, attributeListArray, queryBuilderData, true, keywordSearchStr);

                    this._displayQuery(queryString);
                    this._parseQuery(parsableString);

                },

                /**
                * When search query is built from the query-builder, display query on the search bar
                */
                _onQueryBuild: function (e, detail) {
                    var displayQuery = detail.displayQuery;
                    var prasableQuery = detail.parsableQuery;
                    this._displayQuery(displayQuery);
                    this._parseQuery(prasableQuery);
                },

                /**
                * Function to display the query on the search bar
                */
                _displayQuery: function (queryStr) {
                    this.inputQueryString = queryStr;
                    var searchBar = this.shadowRoot.querySelector('#searchBar')
                    searchBar.searchInput = [];
                    if (queryStr) {
                        searchBar.query = this._searchQuery;
                        searchBar.searchText = this._searchQuery;
                        searchBar.setAttribute("placeholder", "");
                        searchBar.setAttribute("placeholder", queryStr);
                    }
                    this._showResetSearch();
                    //update the nav menu contents
                    this.updateAppCurrentStatus();
                },

                /**
                * Function to parse the query
                */
                _parseQuery: function (query) {
                    var queryParser = this.shadowRoot.querySelector("[id=queryParser]");
                    if (queryParser) {
                        queryParser.parseQueryToFilters(query);
                    }
                },

                _onSearchFiltersChange: function (e, detail) {
                    var typesCriterion = detail.typesCriterion;
                    var selectedSearchFilters = detail.attributesCriterion;
                    var relationshipSearchFilters = detail.relationshipsCriterion;
                    var workflowCriterion = detail.workflowCriterion ? detail.workflowCriterion : undefined;
                    var searchQuery = detail.searchQuery ? detail.searchQuery : "";
                    this.set("_typesCriterion", typesCriterion);
                    this.set("_selectedSearchFilters", selectedSearchFilters);
                    this.set("_relationshipSearchFilters", relationshipSearchFilters);
                    if (workflowCriterion) {
                        this._workflowCriterion.workflowShortName = workflowCriterion.workflowShortName;
                        this._workflowCriterion.workflowActivityName = workflowCriterion.workflowActivityName;
                        this.set("_workflowCriterion", this._workflowCriterion);
                    }
                    this.set("_searchQuery", searchQuery);
                    this.set("_selectedEntityTypes", "");
                    var selectedEntityTypes = this._getSelectedEntityTypes(typesCriterion);
                    this.set("_selectedEntityTypes", selectedEntityTypes);
                    this.shadowRoot.querySelector("#assetsSearchGrid").refresh();
                },

                _onContextChanged: function (e) {

                    //this.$$("#getEntityDiscoveryAppConfig").refresh();
                    if (this.shadowRoot.querySelector("#entitySearchDiscoveryGrid")) {
                        //this.shadowRoot.querySelector("#entitySearchDiscoveryGrid").refresh();
                    }

                    var contextData = this.contextData;
                    this.contextData = {}; // To notify
                    this.contextData = contextData;

                    //this.shadowRoot.querySelector("#getAssetsDiscoveryAppConfig").refresh();

                    if (this._quickManageEnabled) {
                        if (this.shadowRoot.querySelector("#entityQuickManage")) {
                            this.shadowRoot.querySelector("#entityQuickManage").reload();
                        }
                    } else {
                        this.shadowRoot.querySelector("#assetsSearchGrid").refresh();
                    }
                },

                _onDimensionsChanged: function (e) {
                    var newDimensions = e.detail.dimensions;
                    ContextHelper.updateContextData(this.contextData, newDimensions);
                    this._onContextChanged();
                }
            });
        })();
    </script>
</dom-module>