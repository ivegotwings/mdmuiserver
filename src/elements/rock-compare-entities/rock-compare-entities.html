<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html" />
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">


<link rel="import" href="../rock-grid/rock-grid.html">

<dom-module id="rock-compare-entities">
    <template>
        <style include="bedrock-style-common">

            :host {
                display: block;
                height: calc(100% - 50px);
                --rock-entity-compare-dialog: {
                    height: 30vh !important;
                    /* temp fix need to rework on nested grid with alert box*/
                }
            }
            :host(.one-accordion){
                height:100%;
            }

            .pebble-dropdown-wrapper {
                display: flex;
                justify-content: flex-end;
            }
           
            .compare-container {
                position: relative;
                height: 100%;
                --pebble-grid-container: {
                    margin-left: 10px;
                    margin-right: 10px;
                }
                --pebble-grid-container-header: {
                    padding-right: 10px;
                    padding-left: 10px;
                }
            }
        </style>
        <div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <div class="pebble-dropdown-wrapper">
                        <pebble-dropdown class="w-20" id="actionsButton" label="Filter By" selected-value="{{_selectedValue}}" items="[[_dropDownItems]]"></pebble-dropdown>
                </div>
            </div>
        
            <div class="base-grid-structure-child-2">
        
        
                <!-- Attributes compare Accordian -->
                <pebble-accordion header-text="Attributes" show-accordion="true">
                    <div class="compare-container" slot="accordion-content">
                        <div class="rock-compare-entities full-height">
                            <pebble-spinner active="[[_loading]]"></pebble-spinner>
                            <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                            <div class$="[[_getButtonSiblingsClass(showActionButtons)]]">
                                <rock-grid id="compareRelationshipsGrid" data="{{_gridData}}" attribute-models="{{_attributeModels}}" config="{{_gridConfig}}"
                                    page-size="5" enable-column-select=[[enableColumnSelect]] context-data="[[contextData]]" nested-attribute-message="{noOfValues} values"
                                    hide-view-selector hide-toolbar grid-item-view></rock-grid>
                            </div>
                        </div>
                    </div>
                </pebble-accordion>
        
                <!-- Relationship Compare Accordian -->
                <template is="dom-if" if="[[_getRelationshipVisibilityStatus(enableRelationshipsCompare, enableRelationshipsMatchMerge)]]">
                    <pebble-accordion header-text="Relationships" show-accordion="true" is-collapsed="true">
                        <div class="compare-container" slot="accordion-content">
                            <div class="rock-compare-entities full-height">
                                <pebble-spinner active="[[_loading]]"></pebble-spinner>
                                <!-- <pebble-dropdown id="actionsButtonRelationships" label="Filter By" selected-value="{{_selectedValueRel}}" items="[[_dropDownItems]]"></pebble-dropdown> -->
                                <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                                <div class$="[[_getButtonSiblingsClass(showActionButtons)]]">
                                    <rock-grid id="compareEntitiesGrid" data="{{_gridDataRelationships}}" attribute-models="{{_relationshipModels}}" config="{{_gridConfigRelationships}}"
                                        page-size="5" context-data="[[contextData]]" nested-attribute-message="{noOfValues} Relationships"
                                        hide-view-selector hide-toolbar grid-item-view></rock-grid>
                                </div>
                            </div>
                        </div>
                    </pebble-accordion>
                </template>
            </div>
        </div>
            <template is="dom-if" if="[[showActionButtons]]">
                <div id="content-actions" class="buttonContainer-fixed" align="center">
                    <pebble-button class="action-button btn btn-secondary m-r-5" id="back" button-text="Back" raised on-tap="_onBackTap"></pebble-button>
                    <template is="dom-if" if="[[_allowCreate(compareEntitiesContext, showCreateButton)]]">
                        <pebble-button class="action-button btn btn-primary m-r-5" id="create" button-text="Create" raised on-tap="_onCreateTap"></pebble-button>
                    </template>
                    <template is="dom-if" if="[[showMergeButton]]">
                        <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="merge" button-text="Merge" raised on-tap="_onMergeTap"></pebble-button>
                    </template>
                </div>
            </template>

            <pebble-dialog id="attributeDialog" dialog-title="Confirmation" modal medium vertical-offset=1 50 horizontal-align="auto"
                vertical-align="auto" no-cancel-on-outside-click no-cancel-on-esc-key show-ok show-cancel show-close-icon alert-box>
                <div id="attrDialogContainer" style="overflow-y: auto;overflow-x: auto;"></div>
            </pebble-dialog>

            <liquid-entity-data-get operation="getbyids" id="entityDataGet" request-data="{{_entityGetRequest}}" on-response="_onEntityDataGetSuccess"
                on-error="_onEntityDataGetFailure">
            </liquid-entity-data-get>
            <liquid-rest id="snapshotDataGet" url="/data/pass-through/snapshotManageService/get" method="POST" request-data="{{_snapshotGetRequest}}"
                on-liquid-response="_onEntityDataGetSuccess">
            </liquid-rest>
            <bedrock-pubsub event-name="refresh-grid" handler="_onRefreshGrid" target-id="compareEntitiesGrid"></bedrock-pubsub>

    </template>
    <script>
        class RockCompareEntities extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior],
            Polymer.Element) {
            static get is() {
                return 'rock-compare-entities';
            }
            static get properties() {
                return {
                    compareEntitiesContext: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: "_onCompareEntitiesContextChange"
                    },
                    attributeNames: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    entityTitle: {
                        type: String,
                        value: 'id'
                    },
                    frozenAttributes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _entityGetRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _liquidDataGetCompleted: {
                        type: Boolean,
                        value: false
                    },
                    _liquidDataSnapshotGetCompleted: {
                        type: Boolean,
                        value: false
                    },
                    _isLiquidDataGetInitiated: {
                        type: Boolean,
                        value: false
                    },
                    _isAdditionalContextPresent: {
                        type: Boolean,
                        value: false
                    },
                    _applicableContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _isLiquidDataSnapshotGetInitiated: {
                        type: Boolean,
                        value: false
                    },
                    _combinedEntitySetForRender: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _snapshotGetRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relationships: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _isRelationshipsPresent: {
                        type: Boolean,
                        value: false
                    },
                    _snapshotRollbackRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _gridConfigRelationships: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridDataRelationships: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _rowsModel: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _rowsModelRelationships: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    isSnapshot: {
                        type: Boolean,
                        value: false
                    },
                    _entityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _modelGetTracker: {
                        type: Number,
                        value: 0
                    },
                    _entityModels: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _contexts: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _contextsObj: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _data: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    showCreateButton: {
                        type: Boolean,
                        value: true
                    },
                    showMergeButton: {
                        type: Boolean,
                        value: true
                    },
                    _dataRelationships: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _dropDownItems: {
                        type: Array,
                        value: [{
                            "value": "None",
                            "title": "None"
                        },
                        {
                            "value": "Has Values",
                            "title": "Has Values"
                        },
                        {
                            "value": "Has Partial Values",
                            "title": "Has Partial Values"
                        },
                        {
                            "value": "Has Same Values",
                            "title": "Has Same Values"
                        },
                        {
                            "value": "Is Empty",
                            "title": "Is Empty"
                        },
                        {
                            "value": "Has Different Values",
                            "title": "Has Different Values"
                        }
                        ]
                    },
                    _selectedValue: {
                        type: String,
                        value: 'None'
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _relationshipModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    enableRelationshipsCompare: {
                        type: Boolean,
                        value: false
                    },
                    enableRelationshipsMatchMerge: {
                        type: Boolean,
                        value: false
                    },
                    showActionButtons: {
                        type: Boolean,
                        value: false
                    },
                    enableColumnSelect: {
                        type: Boolean,
                        value: false
                    },
                    selectedEntityId: {
                        type: String,
                        value: null
                    }
                };
            }
            constructor() {
                super();
                this._onCompositeModelGetResponse = this._onCompositeModelGetResponse.bind(this);
                this.addEventListener('column-selection-changed', this._onColumnSelectionChanged);
            }
            connectedCallback() {
                super.connectedCallback();
                var pebbleDropDown = this.$$("#actionsButton");
                if (pebbleDropDown) {
                    pebbleDropDown.addEventListener('change', this._onDropdownChange.bind(this));
                }
                if (_.isEmpty(this.compareEntitiesContext)) {
                    this._triggerCompareEntitiesContextChange();
                }
            }
            _onCompareEntitiesContextChange() {
                if (!_.isEmpty(this.compareEntitiesContext)) {
                    this._combinedEntitySetForRender = [];
                    this._entityModels = [];
                    this._triggerCompareEntitiesContextChange(false); //Not from session
                }
            }
            _triggerCompareEntitiesContextChange(fromSession = true) {
                this._prepareContext(fromSession);
                this._attributeModelGet();
            }
            _attributeModelGet() {
                if (this._contextData) {
                    this._loading = true;
                    if (this._entityTypes && this._entityTypes.length) {
                        this._entityTypes.forEach(function (entityType) {
                            var modelCompositeGet = this.shadowRoot.querySelector('#attr_' + entityType);
                            if (modelCompositeGet && this._modelGetTracker) {
                                liquidElement.generateRequest();
                                this._modelGetTracker++;
                            } else {
                                var firstItemContext = this._contextData[ContextHelper.CONTEXT_TYPE_ITEM] &&
                                    this._contextData[ContextHelper.CONTEXT_TYPE_ITEM].length ? this._contextData[
                                    ContextHelper.CONTEXT_TYPE_ITEM][0] : undefined;
                                if (firstItemContext) {
                                    firstItemContext.type = entityType;
                                }
                                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
                                    this._contextData);
                                //for relationships 
                                compositeModelGetRequest.params.fields.relationships = ["_ALL"];
                                var liquidCustomElement = customElements.get(
                                    "liquid-entity-model-composite-get");
                                var liquidElement = new liquidCustomElement();
                                liquidElement.name = entityType;
                                liquidElement.id = "attr_" + entityType;
                                liquidElement.requestData = compositeModelGetRequest;
                                liquidElement.addEventListener("entity-model-composite-get-response",
                                    this._onCompositeModelGetResponse);

                                this.shadowRoot.appendChild(liquidElement);
                                setTimeout(() => {
                                    liquidElement.generateRequest();
                                }, 10);
                                this._modelGetTracker++;
                            }
                        }, this);
                    }
                }
            }
            _onCompositeModelGetResponse(e) {
                var rows = [];
                var rowsRelationships = [];
                var entityModels = e.detail.response.content.entityModels;
                if (entityModels && entityModels.length) {
                    this._entityModels.push(entityModels[0]);
                    if (!this.isSnapshot) {
                        // to get value of attribute tagged with "isExternalName" flag to show as entity title
                        var entityTitle = DataHelper.getExternalNameAttributeFromModel(entityModels[0]);
                        if (entityTitle) {
                            this.set("entityTitle", entityTitle);
                        }
                    }

                }
                this._modelGetTracker--;
                if (this._modelGetTracker == 0) {
                    this._prepareGridRowsModel(this._entityModels, rows, rowsRelationships);
                    this._rowsModel = rows;
                    this._rowsModelRelationships = rowsRelationships;
                    this._dataGet();
                }
            }
            _getButtonSiblingsClass(showActionButtons) {
                return showActionButtons == true ? "button-siblings" : "full-height";
            }
            _prepareGridRowsModel(entityModels, rows, rowsRelationships) {
                var frozenRowModels = [];
                var normalRowModels = [];

                var frozenRowModelsRelationshipGrid = [];
                var normalRowModelsRelationshipGrid = [];
                entityModels.forEach(function (entityModel) {
                    if (entityModel && entityModel.data && entityModel.data.attributes) {
                        var attributes = DataHelper.isValidObjectPath(entityModel,
                            'data.contexts.0.attributes') ? entityModel.data.contexts[0].attributes :
                            entityModel.data.attributes;
                        //relationships model
                        this._isRelationshipsPresent = DataHelper.isValidObjectPath(entityModel,
                            'data.relationships') && !_.isEmpty(entityModel.data.relationships);
                            if (this._isRelationshipsPresent){
                                var relationships = DataHelper.isValidObjectPath(entityModel,
                                'data.contexts.0.relationships') ? entityModel.data.contexts[0].relationships :
                                entityModel.data.relationships;
                            }

                            //looping through attributes to form attribute Model for row
                        Object.keys(attributes).forEach(function (key, index) {
                            if (attributes[key]) {
                                var attribute = attributes[key];
                                if (this.frozenAttributes.indexOf(key) >= 0) {
                                    if (index == 0) {
                                        frozenRowModels.push({
                                            "header": attribute.properties.externalName,
                                            "name": key,
                                            "isFrozen": true
                                        });
                                        this._attributeModels[key] = attribute;
                                    } else {
                                        if (!this._rowNameExist(key, frozenRowModels)) {
                                            frozenRowModels.push({
                                                "header": attribute.properties.externalName,
                                                "name": key,
                                                "isFrozen": true
                                            });
                                            this._attributeModels[key] = attribute;
                                        }
                                    }
                                } else {
                                    if (index == 0) {
                                        normalRowModels.push({
                                            "header": attribute.properties.externalName,
                                            "name": key
                                        });
                                        this._attributeModels[key] = attribute;
                                    } else {
                                        if (!this._rowNameExist(key, normalRowModels)) {
                                            normalRowModels.push({
                                                "header": attribute.properties.externalName,
                                                "name": key
                                            });
                                            this._attributeModels[key] = attribute;
                                        }
                                    }
                                }
                            }
                        }, this);

                        //looping over relationships
                        if (this._isRelationshipsPresent) {
                            Object.keys(relationships).forEach(function (key, index) {
                                //Second condition is to skip the where-used scenario...will be handled in future
                                if (relationships[key] && relationships[key][0].properties.relationshipOwnership == 'owned') {
                                    var relationship = relationships[key];
                                    if (relationship.length > 0) {
                                        if (this.frozenAttributes.indexOf(key) >= 0) {
                                            if (index == 0) {
                                                frozenRowModelsRelationshipGrid.push({
                                                    "header": relationship[0]? relationship[0].properties.externalName: key,
                                                    "name": key,
                                                    "isFrozen": true
                                                });
                                                this._relationshipModels[key] = relationship;
                                            } else {
                                                if (!this._rowNameExist(key, frozenRowModels)) {
                                                    frozenRowModelsRelationshipGrid.push({
                                                        "header": relationship[0]? relationship[0].properties.externalName: key,
                                                        "name": key,
                                                        "isFrozen": true
                                                    });
                                                    this._relationshipModels[key] = relationship;
                                                }
                                            }
                                        } else {
                                            if (index == 0) {
                                                normalRowModelsRelationshipGrid.push({
                                                    "header":relationship[0]? relationship[0].properties.externalName: key,
                                                    "name": key,
                                                    "isRelationship": true
                                                });
                                                this._relationshipModels[key] = relationship;
                                            } else {
                                                if (!this._rowNameExist(key, normalRowModelsRelationshipGrid)) {
                                                    normalRowModelsRelationshipGrid.push({
                                                        "header": relationship[0]? relationship[0].properties.externalName: key,
                                                        "name": key,
                                                        "isRelationship": true
                                                    });
                                                    this._relationshipModels[key] = relationship;
                                                }
                                            }
                                        }
                                    }
                                }
                            }, this);
                        }

                    }
                }, this);

                //attributes
                frozenRowModels.forEach(function (rowModel) {
                    rows.push(rowModel);
                }, this);
                normalRowModels.forEach(function (rowModel) {
                    rows.push(rowModel);
                }, this);

                //relationships
                frozenRowModelsRelationshipGrid.forEach(function (rowModel) {
                    rowsRelationships.push(rowModel);
                }, this);
                normalRowModelsRelationshipGrid.forEach(function (rowModel) {
                    rowsRelationships.push(rowModel);
                }, this);

                //for relationships adding listener to the dropdown
                // var pebbleDropDownRelationship = this.$$("#actionsButtonRelationships");
                // if (pebbleDropDownRelationship) {
                //     pebbleDropDownRelationship.addEventListener('change', this._onDropdownChangeRelationships.bind(this));
                // }

            }
            _rowNameExist(rowName, rows) {
                var existingRows = [];
                if (rowName && rows && rows.length) {
                    existingRows = rows.filter(function (row) {
                        return row.name == rowName
                    });
                }
                if (existingRows) {
                    if (existingRows.length) {
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return false;
                }
            }

            async _onEntityDataGetSuccess(e) {
                var columns = [];
                var items = [];

                var columnsRelationships = [];
                var itemsRelationships = [];
                if (e.detail.response.hasOwnProperty("response")) {
                    this.entities = e.detail.response.response.entities;
                    this._liquidDataSnapshotGetCompleted = true;
                } else {
                    this.entities = e.detail.response.content.entities;
                    this._liquidDataGetCompleted = true;
                }
                var allowPrepareGrid = false;
                if (this._isLiquidDataGetInitiated && this._isLiquidDataSnapshotGetInitiated) {
                    if (!this._liquidDataGetCompleted || !this._liquidDataSnapshotGetCompleted) {
                        allowPrepareGrid = false;
                    } else {
                        allowPrepareGrid = true;
                    }
                } else {
                    allowPrepareGrid = true;
                }
                var ent = this.entities;
                this._combinedEntitySetForRender.push(...ent);
                this.entities = this._combinedEntitySetForRender;
                if (this.entities && this.entities.length && allowPrepareGrid) {
                    await this._prepareGridColumnsModelAndData(this.entities, columns, items);
                    if(this._isRelationshipsPresent) {
                        await this._prepareGridColumnsModelAndDataRelationshipGrid(this.entities, columnsRelationships, itemsRelationships);
                    }
                }
                //attributes grid
                var gridConfig = this._getBaseGridConfig();
                gridConfig.itemConfig.fields = _.extend({}, columns);
                gridConfig.itemConfig.rows = this._rowsModel;
                this._gridConfig = this._getConfigWithUpdatedTitle(gridConfig, this.entities);
                this._gridData = this._data = items;

                //relationship grid _rowsModelRelationships
                var gridConfigRelationships = this._getBaseGridConfig();
                gridConfigRelationships.itemConfig.fields = _.extend({}, columnsRelationships);
                gridConfigRelationships.itemConfig.rows = this._rowsModelRelationships;
                this._gridConfigRelationships = this._getConfigWithUpdatedTitle(gridConfigRelationships, this.entities);
                this._gridDataRelationships = this._dataRelationships = itemsRelationships;

                if (allowPrepareGrid) {
                    this._loading = false;
                }
            }
            _getRelationshipVisibilityStatus() {
                if(this.enableRelationshipsCompare || this.enableRelationshipsMatchMerge) {
                    return true;
                }
                return false;
            }
            _getConfigWithUpdatedTitle(gridConfig, entities) {
                if (!_.isEmpty(this.compareEntitiesContext) && this.compareEntitiesContext.matchConfig) {
                    var title = this.compareEntitiesContext.matchConfig["compare-title"];
                    if (title) {
                        title = title.replace("{noOfEntities}", entities.length - 1);
                         if (entities && entities.length == 0) {
                            title = "No details available for matched entities. Please contact administrator.";
                            this.showCreateButton = false;
                            this.showMergeButton = false;
                        } else {
                            title = title.replace("{noOfEntities}", entities.length - 1);
                        }
                        gridConfig.titleTemplates.compareEntitiesTitle = title;
                        gridConfig.titleTemplates.compareEntitiesTitle = title;
                    }
                }
                return gridConfig;
            }

            async _getPrimaryAndAdditionalContexts() {
                if (!_.isEmpty(this.contextData)) {
                    if( DataHelper.isValidObjectPath(this.contextData, 'ItemContexts.0')) {
                        var entityType = this.contextData.ItemContexts[0].type;
                    }
                    if(DataHelper.isValidObjectPath(this.contextData, 'Contexts.0') && entityType) {
                        var contextModel = await ContextModelManager.getContextModelByEntityTypeAndDataContext(
                        entityType, this.contextData.Contexts[0]);
                    }
                    if (contextModel) {
                        var additionalContexts = contextModel.properties ? contextModel.properties.additionalcontexts :
                            undefined;
                        var primaryContexts = DataTransformHelper.getPrimaryContextKeysFromContextModel(
                            contextModel, additionalContexts);
                    }
                    var mergedContexts = {
                        "additionalContexts": additionalContexts,
                        "primaryContexts": primaryContexts
                    }
                    return mergedContexts;
                }
            }

            async snapshotTransformAttributes(entity, attributeModels, contextData, outputSchema, applySort) {
                var firstDataContext = ContextHelper.getFirstDataContext(contextData);
                var firstValueContext = ContextHelper.getFirstValueContext(contextData);
                var firstItemContext = ContextHelper.getFirstItemContext(contextData);
                var activeAdditionalCtx;
                var activePrimaryCtx;

                var mergedAttributes = {};

                var sortedAttributeModels = attributeModels;
                if (applySort) {
                    sortedAttributeModels = this.sortAttributeModels(attributeModels);
                }

                if (firstDataContext) {
                    let dataContexts = [];

                    if (this._isAdditionalContextPresent && this._contextsObj && this._contextsObj.primaryContexts) {
                        let primaryContext = _.pick(firstDataContext, this._contextsObj.primaryContexts);
                        dataContexts.push(primaryContext);
                    }
                    dataContexts.push(firstDataContext);


                    for (let dataContext of dataContexts) {
                        if (dataContext) {
                                var ctxAttributes = SharedUtils.DataObjectFalcorUtil.getAttributesByCtx(
                                    entity, dataContext);

                                if (!_.isEmpty(ctxAttributes)) {
                                    Object.keys(ctxAttributes).forEach((attrName) => {
                                        mergedAttributes[attrName] = DataHelper.cloneObject(
                                            ctxAttributes[attrName]);
                                    });
                                }

                        }
                    }
                } else {
                    //taking self
                    mergedAttributes = entity.data.attributes;
                }


                var transformedAttributes;
                if (!_.isEmpty(attributeModels)) {
                    transformedAttributes = await DataTransformHelper._transformAttributes(
                        mergedAttributes, sortedAttributeModels, firstValueContext,
                        firstDataContext, firstItemContext);
                } else {
                    transformedAttributes = DataTransformHelper._transformAttributesWithoutModels(
                        mergedAttributes, firstValueContext);
                }

                var outputData = undefined;

                if (outputSchema == "array") {
                    //manage returns output as array...instead of keyed attributes
                    outputData = _.map(transformedAttributes, function (value, index) {
                        return value;
                    });
                } else {
                    outputData = transformedAttributes;
                }

                return outputData;
            };

            async snapshotTransformRelationships(entity, relationshipModels, contextData, outputSchema, applySort) {
                var firstDataContext = ContextHelper.getFirstDataContext(contextData);
                var firstValueContext = ContextHelper.getFirstValueContext(contextData);
                var activeAdditionalCtx;
                var activePrimaryCtx;

                var mergedRelationships = {};

                var sortedAttributeModels = relationshipModels;
                if (applySort) {
                    sortedAttributeModels = this.sortAttributeModels(relationshipModels);
                }

                //second condition added to check for a normal entity.
                if (firstDataContext) {
                    let dataContexts = [];

                    if (this._isAdditionalContextPresent && this._contextsObj && this._contextsObj.primaryContexts) {
                        let primaryContext = _.pick(firstDataContext, this._contextsObj.primaryContexts);
                        dataContexts.push(primaryContext);
                    } else if (!_.isEmpty(this._contextsObj.primaryContexts) && this._contextsObj.primaryContexts[0]=="self") {
                        mergedRelationships = entity.data.relationships; 
                    }
                    dataContexts.push(firstDataContext);


                    for (let dataContext of dataContexts) {
                        if (dataContext) {
                            for (let dataContext of dataContexts) {
                                var ctxRelationships = SharedUtils.DataObjectFalcorUtil.getRelationshipsByCtx(
                                    entity, dataContext);

                                if (!_.isEmpty(ctxRelationships)) {
                                    Object.keys(ctxRelationships).forEach((relName) => {
                                        mergedRelationships[relName] = DataHelper.cloneObject(
                                            ctxRelationships[relName]);
                                    });
                                }
                            }

                        }
                    }
                
                } else {
                    //taking self
                    mergedRelationships = entity.data.relationships;
                }
                var outputData = undefined;

                if (outputSchema == "array") {
                    //manage returns output as array...instead of keyed attributes
                    outputData = _.map(mergedRelationships, function (value, index) {
                        return value;
                    });
                } else {
                    outputData = mergedRelationships;
                }

                return outputData;
            };
            //relationships grid column prepare
            async _prepareGridColumnsModelAndDataRelationshipGrid(entities, columnRelationships, itemsRelationships) {
                if (this._rowsModelRelationships) {
                    var rowHeader = {
                        "header": "",
                        "name": "Relationships",
                        "sortable": false,
                        "filterable": true,
                        "filterBy": "Relationships",
                        "readFrom": "properties",
                        "isRowHeader": true,
                        "visible": true
                    }
                    columnRelationships.push(rowHeader);
                    var compositeModel = {
                        "data": {
                            "relationships": this._relationshipModels
                        }
                    };

                    //getting primary and additional contexts to know which context related attributes should be displayed
                    if (this.isSnapshot) {
                        if (this._entityModels && this._entityModels.length) {
                            compositeModel = DataHelper.cloneObject(this._entityModels[0]);
                        }
                        this._contextsObj = await this._getPrimaryAndAdditionalContexts();
                        if (this._contextsObj) {
                            if (!_.isEmpty(this._contextsObj.primaryContexts) && this._contextsObj.primaryContexts
                                .indexOf('self') !== -1) {
                                this._isAdditionalContextPresent = false;
                            } else if (!_.isEmpty(this._contextsObj.additionalContexts)) {
                                this._isAdditionalContextPresent = true;
                            }
                        }
                    }
                    var transformedRelModels = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);
                    // var transformedRelModels = DataTransformHelper.transformRelationshipAttributeModels(relationshipModels, this._contextData);
                    //Add column for new entity - if compare triggered from entity create.
                    // if (!_.isEmpty(this.compareEntitiesContext) && this.compareEntitiesContext.newEntity) {
                    //     entities.unshift(this.compareEntitiesContext.newEntity);
                    // }
                    for (let i = 0; i < this._rowsModelRelationships.length; i++) {
                        var item = {};
                        var nonSortedColumns = [];
                        var row = this._rowsModelRelationships[i];
                        for (let entity of entities) {
                            var entityHeader = this._getEntityHeader(entity);
                            if (i == 0) {
                                var colDetails = {
                                    "header": this._updateEntityHeader(entity.id, entityHeader),
                                    "name": entity.id,
                                    "sortable": false,
                                    "filterable": false,
                                    "readFrom": "properties",
                                    "visible": true,
                                    "type": entity.type,
                                    "version": this._getSnapshotMetadata(entity).snapVersion
                                }
                                nonSortedColumns.push(colDetails);
                            }
                            var relationships = await this.snapshotTransformRelationships(entity,
                            transformedRelModels, this._contextData, this._contextsObj);
                            var rels = relationships;
                            // this._entities.forEach(function (currentModel) {

                            //check to see if the context is self because snapshot get call cannot do context filtering as data is saved iin h-base
                            // if (_.isEmpty(this.contextData.Contexts) &&
                            //     (DataHelper.isValidObjectPath(entity, 'data.relationships'))) {
                            //     rels = entity.data.relationships;

                            // } else if ((DataHelper.isValidObjectPath(entity,
                            //     'data.contexts.0.relationships'))) {
                            //     rels = entity.data.contexts[0].relationships;
                            // }
                            if (rels && rels[row.name]) {
                                item[entity.id] = rels[row.name];
                                item.relationshipModel = this._relationshipModels;
                            } else {
                                item[entity.id] = "";
                            }
                            rels = [];
                        }

                        if (!_.isEmpty(nonSortedColumns)) {
                            nonSortedColumns = nonSortedColumns.sort(function (a, b) {
                                return b.version - a.version;
                            });
                            var currentEnt = nonSortedColumns[nonSortedColumns.length - 1];
                            if (currentEnt.type && currentEnt.type.indexOf('snapshot') == -1) {
                                var currentEnt = nonSortedColumns.pop();
                                nonSortedColumns.unshift(currentEnt);
                            }
                            columnRelationships.push(...nonSortedColumns);
                        }
                        var isEmpty = false;
                        var hasPartialValues = false;
                        var hasValues = false;
                        var sameValues = false;
                        var diffValues = false;

                        //using itemFilter as an intermediate thing to set the correct filter values.
                        var itemFilter = DataHelper.cloneObject(item);
                        for(prop in itemFilter) {
                            itemFilter[prop] = itemFilter[prop].length + " Relationships";
                        }
                        Object.keys(itemFilter).forEach(function (key) {
                            if (!hasPartialValues) {
                                if (itemFilter[key] == "") {
                                    if (hasValues) {
                                        hasPartialValues = true;
                                        hasValues = false;
                                    } else {
                                        isEmpty = true;
                                    }
                                } else {
                                    if (isEmpty) {
                                        hasPartialValues = true;
                                        isEmpty = false;
                                    } else {
                                        hasValues = true;
                                    }
                                }
                            }
                        }, this);
                        if (hasValues) {
                            var uniqueValues = _.uniq(_.values(itemFilter));
                            if (uniqueValues && uniqueValues.length == 1) {
                                sameValues = true;
                            } else {
                                diffValues = true;
                            }
                        }

                        //adding nested flag to relationship Item
                        if(row.hasOwnProperty('isRelationship')) {
                            item.isRelationshipType = true;
                        }
                        //adding snapshot flag
                        item.isSnapshot = this.isSnapshot;
                        item["Attributes"] = row.header;
                        item["attributeName"] = row.name;
                        item["isEmpty"] = isEmpty;
                        item["hasPartialValues"] = hasPartialValues;
                        item["hasValues"] = hasValues;
                        item["sameValues"] = sameValues;
                        item["diffValues"] = diffValues;
                        itemsRelationships.push(item);
                    }
                }

            }


            //attributes grid column prepare
            async _prepareGridColumnsModelAndData(entities, columns, items) {
                if (this._rowsModel) {
                    var rowHeader = {
                        "header": "",
                        "name": "Attributes",
                        "sortable": false,
                        "filterable": true,
                        "filterBy": "Attributes",
                        "readFrom": "properties",
                        "isRowHeader": true,
                        "visible": true
                    }
                    //Normal Scenario
                    if (this.enableColumnSelect && !this.isSnapshot) {
                        rowHeader["selectable"] = {
                            "isAction": false,
                            "text": "Select for merge"
                        }
                    }
                    //Snapshot Scenario
                    if (this.enableColumnSelect && this.isSnapshot) {
                        rowHeader["selectable"] = {
                            "isAction": false,
                            "text": "Select for rollback"
                        }
                    }
                    columns.push(rowHeader);
                    var compositeModel = {
                        "data": {
                            "attributes": this._attributeModels
                        }
                    };

                    //getting primary and additional contexts to know which context related attributes should be displayed
                    if (this.isSnapshot) {
                        if (this._entityModels && this._entityModels.length) {
                            compositeModel = DataHelper.cloneObject(this._entityModels[0]);
                        }
                        this._contextsObj = await this._getPrimaryAndAdditionalContexts();
                        if (this._contextsObj) {
                            if (!_.isEmpty(this._contextsObj.primaryContexts) && this._contextsObj.primaryContexts
                                .indexOf('self') !== -1) {
                                this._isAdditionalContextPresent = false;
                            } else if (!_.isEmpty(this._contextsObj.additionalContexts)) {
                                this._isAdditionalContextPresent = true;
                            }
                        }
                    }
                    var transformedAttrModels = DataTransformHelper.transformAttributeModels(compositeModel, this._contextData);
                    //Add column for new entity - if compare triggered from entity create
                    if (!_.isEmpty(this.compareEntitiesContext) && this.compareEntitiesContext.newEntity) {
                        entities.unshift(this.compareEntitiesContext.newEntity);
                    }
                    for (let i = 0; i < this._rowsModel.length; i++) {
                        var item = {};
                        var nonSortedColumns = [];
                        var row = this._rowsModel[i];
                        for (let entity of entities) {
                            var entityHeader = this._getEntityHeader(entity);
                            if (i == 0) {
                                var colDetails = {
                                    "header": this._updateEntityHeader(entity.id, entityHeader),
                                    "name": entity.id,
                                    "sortable": false,
                                    "filterable": false,
                                    "readFrom": "properties",
                                    "visible": true,
                                    "type": entity.type,
                                    "version": this._getSnapshotMetadata(entity).snapVersion
                                }
                                if (!_.isEmpty(this.compareEntitiesContext)) {
                                    if (this.compareEntitiesContext.newEntity) {
                                        colDetails["selectable"] = {
                                            "isAction": true,
                                            "disable": this.compareEntitiesContext.newEntity.id ==
                                                entity.id
                                        };
                                    }
                                    if (this.enableColumnSelect) {
                                        colDetails["selectable"] = {
                                            "isAction": true,
                                            "disable": this.contextData.ItemContexts[0].id ==
                                                entity.id
                                        };
                                    }
                                }
                                nonSortedColumns.push(colDetails);
                            }
                            var attributes = await this.snapshotTransformAttributes(entity,
                                transformedAttrModels, this._contextData, this._contextsObj);
                            var _isAttributeMapped = false;
                            this._entityModels.forEach(function (currentModel) {

                                var attrs = (DataHelper.isValidObjectPath(currentModel,
                                    'data.contexts.0.attributes')) ? currentModel.data.contexts[
                                        0].attributes : currentModel.data.attributes;
                                if (attrs[row.name]) {
                                    _isAttributeMapped = true;

                                };
                            }, this);
                            var currAttrDatatype;
                            if (this._entityModels && this._entityModels[0].data.attributes && this._entityModels[0].data.attributes[row.name]
                                && this._entityModels[0].data.attributes[row.name].properties) {
                                currAttrDatatype = this._entityModels[0].data.attributes[row.name].properties.dataType;
                            }
                            if (!_isAttributeMapped) {
                                item[entity.id] = "NA";
                            } else if (currAttrDatatype == "datetime") {
                                item[entity.id] = FormatHelper.convertFromISODateTime(this._getAttributeValue(
                                    attributes[row.name]), 'datetime');
                            } else if (attributes && attributes[row.name]) {
                                item[entity.id] = this._getAttributeValue(attributes[row.name]);
                            } else {
                                item[entity.id] = "";
                            }
                        }

                        if (!_.isEmpty(nonSortedColumns)) {
                            nonSortedColumns = nonSortedColumns.sort(function (a, b) {
                                return b.version - a.version;
                            });
                            var currentEnt = nonSortedColumns[nonSortedColumns.length - 1];
                            if (this.isSnapshot && currentEnt.type && currentEnt.type.indexOf('snapshot') == -1) {
                                var currentEnt = nonSortedColumns.pop();
                                nonSortedColumns.unshift(currentEnt);
                            }
                            columns.push(...nonSortedColumns);
                        }
                        var isEmpty = false;
                        var hasPartialValues = false;
                        var hasValues = false;
                        var sameValues = false;
                        var diffValues = false;
                        Object.keys(item).forEach(function (key) {
                            if (!hasPartialValues) {
                                if (item[key] == "") {
                                    if (hasValues) {
                                        hasPartialValues = true;
                                        hasValues = false;
                                    } else {
                                        isEmpty = true;
                                    }
                                } else {
                                    if (isEmpty) {
                                        hasPartialValues = true;
                                        isEmpty = false;
                                    } else {
                                        hasValues = true;
                                    }
                                }
                            }
                        }, this);
                        if (hasValues) {
                            var uniqueValues = _.uniq(_.values(item));
                            if (uniqueValues && uniqueValues.length == 1) {
                                sameValues = true;
                            } else {
                                diffValues = true;
                            }
                        }

                        item["Attributes"] = row.header;
                        item["attributeName"] = row.name;
                        item["isEmpty"] = isEmpty;
                        item["hasPartialValues"] = hasPartialValues;
                        item["hasValues"] = hasValues;
                        item["sameValues"] = sameValues;
                        item["diffValues"] = diffValues;
                        items.push(item);
                    }
                }
            }
            _getSnapshotMetadata(entity) {
                var snapData = {};
                if (entity && entity.type && entity.type.indexOf("_snapshot") !== -1) {

                    var contextArr = entity.data.contexts;
                    for (var contextIndex = 0; contextIndex < contextArr.length; contextIndex++) {
                        var currContext = contextArr[contextIndex];
                        if (currContext.context && currContext.context.hasOwnProperty('snapshot')) {

                            //Snap Label
                            if (DataHelper.isValidObjectPath(currContext,
                                'attributes.snapshotLabel.values')) {
                                var value = currContext.attributes.snapshotLabel.values[0];
                                if (value.hasOwnProperty('value')) {
                                    snapData.snapLabel = value.value;
                                }
                            }

                            //Snap version
                            if (DataHelper.isValidObjectPath(currContext,
                                'attributes.version.values')) {
                                var value = currContext.attributes.version.values[0];
                                if (value.hasOwnProperty('value')) {
                                    snapData.snapVersion = parseInt(value.value);
                                }
                            }

                        }
                    }
                } else {
                    snapData.snapVersion = 0;
                }
                return snapData;
            }
            _getAttributeValue(attribute) {
                if (attribute && !_.isEmpty(attribute.value) &&
                    this._attributeModels &&
                    this._attributeModels[attribute.name] &&
                    this._attributeModels[attribute.name].dataType == "nested") {
                    if (this._attributeModels[attribute.name].group && this._attributeModels[
                        attribute.name].group.length > 0) {
                        for (var nestedIdx = 0; nestedIdx < attribute.value.length; nestedIdx++) {
                            for (var key in this._attributeModels[attribute.name].group[0]) {
                                var value = attribute.value[nestedIdx][key]
                                if (value.referenceDataId && value.referenceEntityType) {
                                    var referenceData = value.referenceEntityType + "/" + value.referenceDataId;
                                    value.properties = value.properties || {};
                                    value.properties["referenceData"] = referenceData;
                                    delete value.referenceDataId;
                                    delete value.referenceEntityType;
                                }
                                attribute.value[nestedIdx][key] = {
                                    "values": [value]
                                }
                            }
                        }
                    }
                }
                return attribute ? attribute.value : "";
            }
            _onEntityDataGetFailure(e) {
                this._loading = false;
                var reason = e.detail.response.reason;
                this.showErrorToast("Entity get failed due to following reason: ", reason);
            }
            _getEntitySnapshotRequest() {
                var contextData = DataHelper.cloneObject(this.contextData);
                var req = DataRequestHelper.createEntityGetRequest(contextData)

                req.params.fields.attributes = ["_ALL"]
                return req;
            }

            async _getPrimaryAndFullContexts() {
                let dataContexts = [];
                this._contextsObj = await this._getPrimaryAndAdditionalContexts();

                if (this._contextsObj) {
                    if (!_.isEmpty(this._contextsObj.primaryContexts) && this._contextsObj.primaryContexts
                        .indexOf('self') !== -1) {
                            this._isAdditionalContextPresent = false;
                    } else if (!_.isEmpty(this._contextsObj.additionalContexts)) {
                                this._isAdditionalContextPresent = true;
                    }
                }

                var firstDataContext = ContextHelper.getFirstDataContext(this.contextData);
                    if (this._isAdditionalContextPresent && this._contextsObj && this._contextsObj.primaryContexts) {
                        let primaryContext = _.pick(firstDataContext, this._contextsObj.primaryContexts);
                        dataContexts.push(primaryContext);
                    }

                    if(!_.isEmpty(dataContexts)) {
                        dataContexts.push(firstDataContext);
                        return dataContexts;
                    }
                        return null;
            }

            async _dataGet() {
                if (this._contextData) {
                    var onlySnapshotsSelected = true;
                    var firstItemContext = this._contextData[ContextHelper.CONTEXT_TYPE_ITEM] &&
                        this._contextData[ContextHelper.CONTEXT_TYPE_ITEM].length ? this._contextData[
                        ContextHelper.CONTEXT_TYPE_ITEM][0] : undefined;
                    if (firstItemContext) {
                        firstItemContext.type = this._entityTypes;
                    }
                    ContextHelper.addDefaultValContext(this.contextData);
                    ContextHelper.addDefaultValContext(this._contextData);
                    var req = DataRequestHelper.createEntityGetRequest(this._contextData);

                    //getting primary and fullContext
                    this._contexts = await this._getPrimaryAndFullContexts();

                    if (!this._isAdditionalContextPresent) {
                        this._contexts = this.contextData.Contexts;
                    }
                    //adding params to get relationship related data
                    req.params.fields.relationships = ["_ALL"];

                    if (this.isSnapshot) {
                        var reqEntity = datahelpers.clone(req);
                        var reqSnapshot = datahelpers.clone(req);
                        var liquidDataSnapshotGet = this.shadowRoot.querySelector(
                            "#snapshotDataGet");
                        req.params.query.ids.forEach((element, index) => {
                            if (element.hasOwnProperty("notSnapshot")) {
                                reqEntity.params.query.ids = reqSnapshot.params.query.ids.splice(
                                    index, 1);
                                reqEntity.params.query.ids = [reqEntity.params.query.ids[0]
                                    .id
                                ];
                                req.params.query.ids[index] = req.params.query.ids[index].id;
                                onlySnapshotsSelected = false;
                            }
                        });
                        reqSnapshot.params.query.filters.typesCriterion[0] = reqSnapshot.params.query
                            .filters.typesCriterion[0] + "_snapshot";
                        reqSnapshot.params.fields.attributes = ["_ALL"];
                        reqEntity.params.fields.attributes = ["_ALL"];

                        //adding custom context 
                        reqEntity.params.query.contexts = this._contexts;
                        this.set("_snapshotGetRequest", reqSnapshot);
                        this.set("_entityGetRequest", reqEntity);
                    } else {
                        this.set("_entityGetRequest", req);
                    }
                    var liquidDataGet = this.shadowRoot.querySelector("#entityDataGet");
                    //Call segregation for snapshot scenario
                    if (this.isSnapshot) {
                        if (liquidDataGet && !onlySnapshotsSelected) {
                            liquidDataGet.generateRequest();
                            this._isLiquidDataGetInitiated = true;
                        }
                        if (liquidDataSnapshotGet && (reqSnapshot.params.query.id || reqSnapshot.params
                            .query.ids)) {
                            liquidDataSnapshotGet.generateRequest();
                            this._isLiquidDataSnapshotGetInitiated = true;
                        }
                    } else {
                        liquidDataGet.generateRequest();
                    }
                }
            }
            _getBaseGridConfig() {
                return {
                    "viewMode": "Tabular",
                    "readOnly": true,
                    "schemaType": "colModel",
                    "itemConfig": {
                        "settings": {
                            "isMultiSelect": false,
                            "disableSelectAll": true
                        },
                        "fields": [],
                        "rows": []
                    },
                    "viewConfig": {
                        "tabular": {
                            "visible": true
                        }
                    },
                    "titleTemplates": {
                        "compareEntitiesTitle": "Comparing {noOfEntities} entities for {noOfAttributes} attributes."
                    },
                    "toolbarConfig": {
                        "buttonItems": [
                            {
                                "buttons": [
                                    {
                                        "name": "pageRange",
                                        "icon": "",
                                        "text": "0 - 0 / 0",
                                        "visible": false,
                                        "tooltip": "Page Range"
                                    },
                                    {
                                        "name": "refresh",
                                        "icon": "pebble-icon:refresh",
                                        "text": "",
                                        "visible": true,
                                        "tooltip": "Refresh"
                                    }
                                ]
                            }
                        ]
                    }
                };
            }
            _prepareContext(fromSession = true) {
                var compareEntitiesContext = {};
                if (fromSession) {
                    var contextId = DataHelper.getParamValue('compareEntitiesContextId');
                    compareEntitiesContext = JSON.parse(sessionStorage.getItem(contextId));
                } else {
                    compareEntitiesContext = this.compareEntitiesContext;
                }
                if (compareEntitiesContext) {
                    var clonedContext = {};
                    var entityIds = compareEntitiesContext["entityIds"];
                    var entityTypes = this._entityTypes = compareEntitiesContext["entityTypes"];
                    this.contextData = compareEntitiesContext["contextData"];
                    if (this.contextData) {
                        var itemContext = {
                            'id': entityIds,
                            'type': entityTypes,
                            'attributeNames': this.attributeNames && this.attributeNames.length >
                                0 ? this.attributeNames : ["_ALL"]
                        };
                        clonedContext[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                        clonedContext[ContextHelper.CONTEXT_TYPE_VALUE] = DataHelper.cloneObject(
                            this.contextData[ContextHelper.CONTEXT_TYPE_VALUE]);
                        this._contextData = clonedContext;
                        this._contextData[ContextHelper.CONTEXT_TYPE_DATA] = DataHelper.cloneObject(
                            this.contextData[ContextHelper.CONTEXT_TYPE_DATA]);
                    }
                }
            }
            _getActionData() {
                return [
                    {
                        "actions": [
                            {
                                "name": "Has Values",
                                "text": "Has Values",
                                "visible": true,
                                "eventName": "has-values"
                            },
                            {
                                "name": "Is Empty",
                                "text": "Is Empty",
                                "visible": true,
                                "eventName": "is-empty"
                            },
                            {
                                "name": "Has Partial Values",
                                "text": "Has Partial Values",
                                "visible": true,
                                "eventName": "has-partial-values"
                            },
                            {
                                "name": "Has Same Values",
                                "text": "Has Same Values",
                                "visible": true,
                                "eventName": "has-same-values"
                            },
                            {
                                "name": "Has Different Values",
                                "text": "Has Different Values",
                                "visible": true,
                                "eventName": "has-different-values"
                            }
                        ]
                    }
                ]
            }
            _onRefreshGrid() {
                this._dataGet();
            }
            _onDropdownChange(e, detail) {
                var filter = this.shadowRoot.querySelector("#actionsButton");
                var filteredData = this._data;
                var filteredDataRelationships = this._dataRelationships;
                if (filter) {
                    var filterBy = filter.selectedValue;
                    if (filterBy == "Has Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.hasValues) {
                                return item;
                            }
                        });
                        filteredDataRelationships = this._dataRelationships.filter(function (item) {
                            if (item.hasValues) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Has Partial Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.hasPartialValues) {
                                return item;
                            }
                        });
                        filteredDataRelationships = this._dataRelationships.filter(function (item) {
                            if (item.hasPartialValues) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Is Empty") {
                        filteredData = this._data.filter(function (item) {
                            if (item.isEmpty) {
                                return item;
                            }
                        });
                        filteredDataRelationships = this._dataRelationships.filter(function (item) {
                            if (item.isEmpty) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Has Same Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.sameValues) {
                                return item;
                            }
                        });
                        filteredDataRelationships = this._dataRelationships.filter(function (item) {
                            if (item.sameValues) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Has Different Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.diffValues) {
                                return item;
                            }
                        });
                        filteredDataRelationships = this._dataRelationships.filter(function (item) {
                            if (item.diffValues) {
                                return item;
                            }
                        });
                    }
                }
                this._gridData = undefined;
                this._gridData = filteredData;
                this._gridDataRelationships = filteredDataRelationships;
            }
            _getEntityHeader(entity) {


                var header = "";
                var preparedEntities = this.compareEntitiesContext ? this.compareEntitiesContext["entities-data"] : undefined;
                if (entity) {
                    if (!this.isSnapshot) {
                        var preparedEntity = !_.isEmpty(preparedEntities) ? preparedEntities.find(obj => obj.id === entity.id) : undefined;
                        if (entity[this.entityTitle]) {
                            header = entity[this.entityTitle];
                        } else {
                            var attributes = entity.data.attributes;
                            if (attributes && attributes[this.entityTitle]) {
                                header = attributes[this.entityTitle].values ? attributes[this.entityTitle].values[0].value : "";
                            }
                        }
                        if (header === "" || header === "_EMPTY") {
                            header = entity.id;
                        }
                        if (preparedEntity && preparedEntity.score) {
                            header = header + " - Score " + preparedEntity.score + "%";
                        }
                    } else {
                        //For Snapshot Scenario
                        if (entity.type.indexOf("_snapshot") == -1) {
                            header = "Current Entity: " + entity.name
                        } else {
                            var snapLabel = this._getSnapshotMetadata(entity).snapLabel;
                            if (snapLabel == "") {
                                snapLabel = "No Label";
                            }
                            header = snapLabel;
                            if (DataHelper.isValidObjectPath(entity, "properties.createdDate")) {
                                var createdDate = FormatHelper.convertFromISODateTime(entity.properties.createdDate, 'datetime');
                                header = header + ": " + createdDate;
                            }


                        }
                    }
                }

                if (header == "") {
                    return "<No Name>";
                } else {
                    return header;
                }
            }
            _updateEntityHeader(entityId, entityHeader) {
                if (_.isEmpty(this.compareEntitiesContext)) {
                    return entityHeader;
                }
                if (!this.isSnapshot) {
                    return entityId == this.compareEntitiesContext.newEntity.id ? "New - " + entityHeader : "Matched - " + entityHeader;
                } else {
                    return entityHeader;
                }
            }
            _onColumnSelectionChanged(e) {
                if (e.detail.checked) {
                    this.selectedEntityId = e.detail.value;
                } else {
                    this.selectedEntityId = "";
                }
            }
            _onBackTap(e) {
                this._reset();
                var eventName = "compare-entities-back";
                this.fireBedrockEvent(eventName, null);
            }
            _onCreateTap(e) {
                //Already new entity details available, so just trigger the event
                var eventName = "compare-entities-create";
                this.fireBedrockEvent(eventName, null);
            }
            _onMergeTap(e) {
                if (!this.selectedEntityId) {
                    this.showErrorToast("Please select an entity for merge.");
                    return;
                }
                var matchedEntity = {};
                for (var i = 0; i < this.entities.length; i++) {
                    if (this.entities[i].id == this.selectedEntityId) {
                        matchedEntity = this.entities[i];
                        break;
                    }
                }
                var eventName = "compare-entities-merge";
                this.fireBedrockEvent(eventName, {
                    "matchedEntity": matchedEntity
                });
            }
 
            _allowCreate(compareEntitiesContext, showCreateButton) {
                var allowCreate = false;
                if (compareEntitiesContext && compareEntitiesContext.matchConfig &&
                    showCreateButton) {
                    allowCreate = compareEntitiesContext.matchConfig["allow-create"];
                }
                return allowCreate;
            }
            _reset() {
                this._modelGetTracker = 0;
                this.selectedEntities = [];
                this._gridConfig = {};
                this._gridData = this._data = [];

                this._gridConfigRelationships = {};
                this._gridDataRelationships = this._dataRelationships = [];
            }
        }
        customElements.define(RockCompareEntities.is, RockCompareEntities);
    </script>
</dom-module>