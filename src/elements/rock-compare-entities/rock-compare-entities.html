<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html" />
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="../rock-grid/rock-grid.html">

<dom-module id="rock-compare-entities">
    <template>
        <style include="bedrock-style-common">
            #actionsButton {
                position: absolute;
                right: 20px;
                top: -12px;
            }

            :host{
                display:block;
                height:100%;
                --rock-entity-compare-dialog:{
                    height:30vh !important;/* temp fix need to rework on nested grid with alert box*/
                }
            }
            .compare-container {
                position: relative;
                height: 100%;
                --pebble-grid-container: {
                    margin-left: 10px;
                    margin-right: 10px;
                }
                --pebble-grid-container-header: {
                    padding-right: 10px;
                    padding-left: 10px;
                }
            }
        </style>
        <div class="compare-container">
            <div class="rock-compare-entities full-height">
                <pebble-spinner active="[[_loading]]"></pebble-spinner>
                <pebble-dropdown id="actionsButton" label="Filter By" selected-value="{{_selectedValue}}" items="[[_dropDownItems]]"></pebble-dropdown>
                <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                <rock-grid id="compareEntitiesGrid" data="{{_gridData}}" attribute-models="{{_attributeModels}}" config="{{_gridConfig}}"
                    page-size="5" enable-column-select=[[enableColumnSelect]] context-data="[[contextData]]" nested-attribute-message="{noOfValues} values" hide-view-selector hide-toolbar grid-item-view></rock-grid>
                <template is="dom-if" if="[[showActionButtons]]">
                    <div id="content-actions" class="p-t-10 p-b-10" align="center">
                        <pebble-button class="action-button btn btn-secondary m-r-5" id="back" button-text="Back" raised on-tap="_onBackTap"></pebble-button>
                        <template is="dom-if" if="[[_allowCreate(compareEntitiesContext)]]">
                            <pebble-button class="action-button btn btn-primary m-r-5" id="create" button-text="Create" raised on-tap="_onCreateTap"></pebble-button>
                        </template>
                        <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="merge" button-text="Merge" raised on-tap="_onMergeTap"></pebble-button>
                    </div>
                </template>
                <liquid-entity-data-get operation="getbyids" id="entityDataGet" request-data="{{_entityGetRequest}}" on-response="_onEntityDataGetSuccess"
                    on-error="_onEntityDataGetFailure">
                </liquid-entity-data-get>
                <liquid-rest id="snapshotDataGet" url="/data/pass-through/snapshotManageService/get" method="POST" request-data="{{_snapshotGetRequest}}" on-liquid-response="_onEntityDataGetSuccess">
                </liquid-rest>        
                <bedrock-pubsub event-name="refresh-grid" handler="_onRefreshGrid" target-id="compareEntitiesGrid"></bedrock-pubsub>
            </div>
        </div>
    </template>
    <script>
        class RockCompareEntities extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior], Polymer.Element) {
            static get is() {
                return 'rock-compare-entities';
            }

            static get properties() {
                return {
                    compareEntitiesContext: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: "_onCompareEntitiesContextChange"
                    },
                    attributeNames: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    entityTitle: {
                        type: String,
                        value: 'id'
                    },
                    frozenAttributes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _entityGetRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },                  
                    
                    _liquidDataGetCompleted: {
                        type: Boolean,
                        value: false
                    },
                    _liquidDataSnapshotGetCompleted: {
                        type: Boolean,
                        value: false
                    },
                    _isLiquidDataGetInitiated: {
                        type: Boolean,
                        value: false
                    },  
                    _isLiquidDataSnapshotGetInitiated: {
                        type: Boolean,
                        value: false
                    },
                    _combinedEntitySetForRender: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    },              
                    _snapshotGetRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _snapshotRollbackRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _girdConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _rowsModel: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    isSnapshot: {
                        type: Boolean,
                        value: false
                    },
                    _entityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _modelGetTracker: {
                        type: Number,
                        value: 0
                    },
                    _entityModels: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _data: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _dropDownItems: {
                        type: Array,
                        value: [
                            {
                                "value": "None",
                                "title": "None"
                            },
                            {
                                "value": "Has Values",
                                "title": "Has Values"
                            },
                            {
                                "value": "Has Partial Values",
                                "title": "Has Partial Values"
                            },
                            {
                                "value": "Has Same Values",
                                "title": "Has Same Values"
                            },
                            {
                                "value": "Is Empty",
                                "title": "Is Empty"
                            },
                            {
                                "value": "Has Different Values",
                                "title": "Has Different Values"
                            }
                        ]
                    },
                    _selectedValue: {
                        type: String,
                        value: 'None'
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    showActionButtons: {
                        type: Boolean,
                        value: false
                    },
                    enableColumnSelect: {
                        type: Boolean,
                        value: false
                    },
                    selectedEntityId: {
                        type: String,
                        value: null
                    }
                };
            }

            constructor() {
                super();

                this._onCompositeModelGetResponse = this._onCompositeModelGetResponse.bind(this);
                this.addEventListener('column-selection-changed', this._onColumnSelectionChanged);
            }

            connectedCallback() {
                super.connectedCallback();

                var pebbleDropDown = this.$$("#actionsButton");
                if (pebbleDropDown) {
                    pebbleDropDown.addEventListener('change', this._onDropdownChange.bind(this));
                }
                if(_.isEmpty(this.compareEntitiesContext)) { 
                this._triggerCompareEntitiesContextChange();
                }
            }

            _onCompareEntitiesContextChange() {
                if(!_.isEmpty(this.compareEntitiesContext)) {
                    this._triggerCompareEntitiesContextChange(false); //Not from session
                }
            }

            _triggerCompareEntitiesContextChange(fromSession = true) {
                this._prepareContext(fromSession);
                this._attributeModelGet();
            }

            _attributeModelGet() {
                if (this._contextData) {
                    this._loading = true;
                    if (this._entityTypes && this._entityTypes.length) {
                        this._entityTypes.forEach(function (entityType) {
                            var modelCompositeGet = this.shadowRoot.querySelector('#attr_' + entityType);
                            if (modelCompositeGet && this._modelGetTracker) {
                                liquidElement.generateRequest();
                                this._modelGetTracker++;
                            } else {
                                var firstItemContext = this._contextData[ContextHelper.CONTEXT_TYPE_ITEM] && this._contextData[ContextHelper.CONTEXT_TYPE_ITEM].length ? this._contextData[ContextHelper.CONTEXT_TYPE_ITEM][0] : undefined;
                                if (firstItemContext) {
                                    firstItemContext.type = entityType;
                                }

                                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this._contextData);
                                var liquidCustomElement = customElements.get("liquid-entity-model-composite-get");
                                var liquidElement = new liquidCustomElement();

                                liquidElement.name = entityType;
                                liquidElement.id = "attr_" + entityType;
                                liquidElement.requestData = compositeModelGetRequest;
                                liquidElement.addEventListener("entity-model-composite-get-response", this._onCompositeModelGetResponse);
                                
                                this.shadowRoot.appendChild(liquidElement);

                                setTimeout(() => {
                        liquidElement.generateRequest();
                    }, 10);
                                this._modelGetTracker++;
                            }
                        }, this);
                    }
                }
            }

            _onCompositeModelGetResponse(e) {
                var rows = [];
                var entityModels = e.detail.response.content.entityModels;

                if (entityModels && entityModels.length) {
                    this._entityModels.push(entityModels[0]);
                }

                this._modelGetTracker--;

                if (this._modelGetTracker == 0) {
                    this._prepareGridRowsModel(this._entityModels, rows);
                    this._rowsModel = rows;
                    this._dataGet();
                }
            }

            _prepareGridRowsModel(entityModels, rows) {
                var frozenRowModels = [];
                var normalRowModels = [];

                entityModels.forEach(function (entityModel) {
                    if (entityModel && entityModel.data && entityModel.data.attributes) {
                        var attributes = entityModel.data.attributes;

                        Object.keys(attributes).forEach(function (key, index) {
                            if (attributes[key]) {
                                var attribute = attributes[key];

                                if (this.frozenAttributes.indexOf(key) >= 0) {
                                    if (index == 0) {
                                        frozenRowModels.push({
                                            "header": attribute.properties.externalName,
                                            "name": key,
                                            "isFrozen": true

                                        });
                                        this._attributeModels[key] = attribute;
                                    } else {
                                        if (!this._rowNameExist(key, frozenRowModels)) {
                                            frozenRowModels.push({
                                                "header": attribute.properties.externalName,
                                                "name": key,
                                                "isFrozen": true
                                            });
                                            this._attributeModels[key] = attribute;
                                        }
                                    }
                                } else {
                                    if (index == 0) {
                                        normalRowModels.push({
                                            "header": attribute.properties.externalName,
                                            "name": key
                                        });
                                        this._attributeModels[key] = attribute;
                                    } else {
                                        if (!this._rowNameExist(key, normalRowModels)) {
                                            normalRowModels.push({
                                                "header": attribute.properties.externalName,
                                                "name": key
                                            });
                                            this._attributeModels[key] = attribute;
                                        }
                                    }
                                }
                            }
                        }, this);
                    }
                }, this);

                frozenRowModels.forEach(function (rowModel) {
                    rows.push(rowModel);
                }, this);

                normalRowModels.forEach(function (rowModel) {
                    rows.push(rowModel);
                }, this);
            }

            _rowNameExist(rowName, rows) {
                var existingRows = [];
                if (rowName && rows && rows.length) {
                    existingRows = rows.filter(function (row) {
                        return row.name == rowName
                    });
                }

                if (existingRows) {
                    if (existingRows.length) {
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return false;
                }
            }

            async _onEntityDataGetSuccess(e) {
                var columns = [];
                var items = [];

                if(e.detail.response.hasOwnProperty("response") ) {
                    this.entities = e.detail.response.response.entities;
                    this._liquidDataSnapshotGetCompleted =true;
                } else {  
                    this.entities = e.detail.response.content.entities;                    
                    this._liquidDataGetCompleted =true;
                }
                var allowPrepareGrid = false;
                if (this._isLiquidDataGetInitiated && this._isLiquidDataSnapshotGetInitiated) {
                    if (!this._liquidDataGetCompleted || !this._liquidDataSnapshotGetCompleted) {
                        allowPrepareGrid = false;
                    } else {
                        allowPrepareGrid = true;
                    }
                } else {
                    allowPrepareGrid = true;
                }

                var ent = this.entities;
                this._combinedEntitySetForRender.push(...ent);
                this.entities = this._combinedEntitySetForRender;
                if (this.entities && this.entities.length && allowPrepareGrid) {
                    await this._prepareGridColumnsModelAndData(this.entities, columns, items);
                }

                var gridConfig = this._getBaseGridConfig();
                gridConfig.itemConfig.fields = _.extend({}, columns);
                gridConfig.itemConfig.rows = this._rowsModel;

                this._gridConfig = this._getConfigWithUpdatedTitle(gridConfig, this.entities);
                this._gridData = this._data = items;
                if(this.isSnapshot && allowPrepareGrid) {
                    this._loading = false;
                } else {this._loading = false;}
                
            }

            _getConfigWithUpdatedTitle(gridConfig, entities) {
                if(!_.isEmpty(this.compareEntitiesContext) && this.compareEntitiesContext.matchConfig) {
                    var title = this.compareEntitiesContext.matchConfig["compare-title"];
                    if(title) {
                        title = title.replace("{noOfEntities}", entities.length - 1);
                        gridConfig.titleTemplates.compareEntitiesTitle = title;
                    }
                }

                return gridConfig;
            }

            async _prepareGridColumnsModelAndData(entities, columns, items) {
                if (this._rowsModel && this._rowsModel) {
                    var rowHeader = {
                        "header": "attributes",
                        "name": "Attributes",
                        "sortable": false,
                        "filterable": true,
                        "filterBy": "Attributes",
                        "readFrom": "properties",
                        "isRowHeader": true,
                        "visible": true
                    }
                    //Normal Scenario
                    if(this.enableColumnSelect && !this.isSnapshot) {
                        rowHeader["selectable"] = {
                            "isAction": false,
                            "text": "Select for merge"
                        }
                    }

                    //Snapshot Scenario
                    if(this.enableColumnSelect && this.isSnapshot) {
                        rowHeader["selectable"] = {
                            "isAction": false,
                            "text": "Select for rollback"
                        }
                    }
                    columns.push(rowHeader);

                    var compositeModel = {
                        "data": {
                            "attributes": this._attributeModels
                        }
                    };

                    var transformedAttrModels = DataTransformHelper.transformAttributeModels(compositeModel, this._contextData);

                    //Add column for new entity - if compare triggered from entity create
                    if(!_.isEmpty(this.compareEntitiesContext) && this.compareEntitiesContext.newEntity) {
                        entities.unshift(this.compareEntitiesContext.newEntity);
                    }

                    for(let i=0; i < this._rowsModel.length; i++) {
                        var item = {};
                        var nonSortedColumns = [];
                        var row = this._rowsModel[i];
                        for (let entity of entities) {                            
                            var entityHeader = this._getEntityHeader(entity);
                            if (i == 0) {
                                var colDetails = {
                                    "header": this._updateEntityHeader(entity.id, entityHeader),
                                    "name": entity.id,
                                    "sortable": false,
                                    "filterable": false,
                                    "readFrom": "properties",
                                    "visible": true,
                                    "type": entity.type,
                                    "version": this._getVersionNumber(entity)
                                }

                                if(!_.isEmpty(this.compareEntitiesContext) && this.compareEntitiesContext.newEntity) {
                                    colDetails["selectable"] = {
                                        "isAction": true,
                                        "disable": this.compareEntitiesContext.newEntity.id == entity.id
                                    };
                                }
                                if(this.enableColumnSelect && !_.isEmpty(this.compareEntitiesContext)) {
                                    colDetails["selectable"] = {
                                        "isAction": true,
                                        "disable": this.contextData.ItemContexts[0].id == entity.id
                                    };
                                }
                                nonSortedColumns.push(colDetails);
                            }
                            var attributes = await DataTransformHelper.transformAttributes(entity, transformedAttrModels, this._contextData);

                            var _isAttributeMapped = false;
                            this._entityModels.forEach(function (currentModel) {
                                if ( (currentModel.name == entity.type || entity.type.indexOf(currentModel.name) !== -1) && currentModel.data && currentModel.data.attributes) {
                                    if (currentModel.data.attributes[row.name]) {
                                        _isAttributeMapped = true;
                                    };
                                };
                            }, this);

                            if (!_isAttributeMapped) {
                                item[entity.id] = "NA";
                            } else if (attributes && attributes[row.name]) {
                                item[entity.id] = this._getAttributeValue(attributes[row.name]);
                            } else {
                                item[entity.id] = "";
                            }
                        }

                        if(!_.isEmpty(nonSortedColumns)) {
                            nonSortedColumns = nonSortedColumns.sort(function(a, b) {
                            return a.version-b.version;
                            });
                            columns.push(...nonSortedColumns);
                        }

                        var isEmpty = false;
                        var hasPartialValues = false;
                        var hasValues = false;
                        var sameValues = false;
                        var diffValues = false;

                        Object.keys(item).forEach(function (key) {
                            if (!hasPartialValues) {
                                if (item[key] == "") {
                                    if (hasValues) {
                                        hasPartialValues = true;
                                        hasValues = false;
                                    } else {
                                        isEmpty = true;
                                    }
                                } else {
                                    if (isEmpty) {
                                        hasPartialValues = true;
                                        isEmpty = false;
                                    } else {
                                        hasValues = true;
                                    }
                                }
                            }
                        }, this);

                        if (hasValues) {
                            var uniqueValues = _.uniq(_.values(item));
                            if (uniqueValues && uniqueValues.length == 1) {
                                sameValues = true;
                            } else { diffValues = true;}
                        }

                        item["Attributes"] = row.header;
                        item["attributeName"] = row.name;
                        item["isEmpty"] = isEmpty;
                        item["hasPartialValues"] = hasPartialValues;
                        item["hasValues"] = hasValues;
                        item["sameValues"] = sameValues;
                        item["diffValues"] = diffValues;

                        items.push(item);
                    }
                }
            }

            _getVersionNumber(entity) {
                if(entity && entity.type && entity.type.indexOf("_snapshot") ==-1) {
                    return 0;
                } else {
                    return parseInt(entity.data.contexts[0].attributes.version.values[0].value);
                }

            }

            _getAttributeValue(attribute) {
                if (!_.isEmpty(attribute.value) &&
                 this._attributeModels &&
                 this._attributeModels[attribute.name] &&
                 this._attributeModels[attribute.name].dataType == "nested") {
                 if (this._attributeModels[attribute.name].group && this._attributeModels[attribute.name].group.length > 0) {
                  for (var nestedIdx = 0; nestedIdx < attribute.value.length; nestedIdx++) {
                   for (var key in this._attributeModels[attribute.name].group[0]) {
                    var value = attribute.value[nestedIdx][key]
                    if(value.referenceDataId && value.referenceEntityType) {
                     var referenceData = value.referenceEntityType + "/" + value.referenceDataId;
                     value.properties = value.properties || {};
                     value.properties["referenceData"] = referenceData;
                     delete value.referenceDataId;
                     delete value.referenceEntityType;
                    }
                    attribute.value[nestedIdx][key] = {
                     "values": [value]
                    }
                   }
                  }
                 }
                }
               
                return attribute.value;
               }

            _onEntityDataGetFailure(e) {
                this._loading = false;
                var reason = e.detail.response.reason;
                this.showErrorToast("Entity get failed due to following reason: ", reason);
            }

            _getEntitySnapshotRequest(){
                var contextData = DataHelper.cloneObject(this.contextData);
                var req = DataRequestHelper.createEntityGetRequest(contextData)
                
                req.params.fields.attributes = ["_ALL"]
                return req;
            }
            _dataGet() {
                if (this._contextData) {
                    var onlySnapshotsSelected = true;

                    var firstItemContext = this._contextData[ContextHelper.CONTEXT_TYPE_ITEM] && this._contextData[ContextHelper.CONTEXT_TYPE_ITEM].length ? this._contextData[ContextHelper.CONTEXT_TYPE_ITEM][0] : undefined;
                    if (firstItemContext) {
                        firstItemContext.type = this._entityTypes;
                    }
                    ContextHelper.addDefaultValContext(this.contextData);
                    ContextHelper.addDefaultValContext(this._contextData);
                    var req = DataRequestHelper.createEntityGetRequest(this._contextData);


                    
                    if (this.isSnapshot) {
                        var reqEntity = datahelpers.clone(req);
                        var reqSnapshot = datahelpers.clone(req);
                        var liquidDataSnapshotGet = this.shadowRoot.querySelector("#snapshotDataGet");

                        req.params.query.ids.forEach((element, index) => {
                            if (element.hasOwnProperty("notSnapshot")) {
                                reqEntity.params.query.ids = reqSnapshot.params.query.ids.splice(index, 1);
                                reqEntity.params.query.ids = [reqEntity.params.query.ids[0].id];
                                req.params.query.ids[index] = req.params.query.ids[index].id;
                                onlySnapshotsSelected = false;
                            }
                        });

                        reqSnapshot.params.query.filters.typesCriterion[0] = reqSnapshot.params.query.filters.typesCriterion[0] + "_snapshot"
                        reqSnapshot.params.fields.attributes = ["_ALL"];
                        reqEntity.params.fields.attributes = ["_ALL"];
                        this.set("_snapshotGetRequest", reqSnapshot);
                        this.set("_entityGetRequest", reqEntity);
                    } else {
                        var liquidDataGet = this.shadowRoot.querySelector("#entityDataGet");
                        this.set("_entityGetRequest", req);
                    }

                        //Call segregation for snapshot scenario
                    if (this.isSnapshot) {
                        if (liquidDataGet && !onlySnapshotsSelected) {
                            liquidDataGet.generateRequest();
                            this._isLiquidDataGetInitiated = true;
                        }
                        if (liquidDataSnapshotGet && (reqSnapshot.params.query.id || reqSnapshot.params.query.ids)) {
                            liquidDataSnapshotGet.generateRequest();
                            this._isLiquidDataSnapshotGetInitiated = true;
                        }

                    } else {
                        liquidDataGet.generateRequest();
                    }
                }
            }

            _getBaseGridConfig() {
                return {
                    "viewMode": "Tabular",
                    "readOnly": true,
                    "schemaType": "colModel",
                    "itemConfig": {
                        "settings": {
                            "isMultiSelect": false,
                            "disableSelectAll": true
                        },
                        "fields": [
                        ],
                        "rows": [
                        ]
                    },
                    "viewConfig": {
                        "tabular": {
                            "visible": true
                        }
                    },
                    "titleTemplates": {
                        "compareEntitiesTitle": "Comparing {noOfEntities} entities for {noOfAttributes} attributes."
                    },
                    "toolbarConfig": {
                        "buttonItems": [
                            {
                                "buttons": [
                                    {
                                        "name": "pageRange",
                                        "icon": "",
                                        "text": "0 - 0 / 0",
                                        "visible": false,
                                        "tooltip": "Page Range"
                                    },
                                    {
                                        "name": "refresh",
                                        "icon": "pebble-icon:refresh",
                                        "text": "",
                                        "visible": true,
                                        "tooltip": "Refresh"
                                    }
                                ]
                            }
                        ]
                    }
                };
            }

            _prepareContext(fromSession = true) {
                var compareEntitiesContext = {};

                if(fromSession) {
                    var contextId = DataHelper.getParamValue('compareEntitiesContextId');
                    compareEntitiesContext = JSON.parse(sessionStorage.getItem(contextId));
                } else {
                    compareEntitiesContext = this.compareEntitiesContext;
                }

                if (compareEntitiesContext) {
                    var clonedContext = {};
                    var entityIds = compareEntitiesContext["entityIds"];
                    var entityTypes = this._entityTypes = compareEntitiesContext["entityTypes"];
                    this.contextData = compareEntitiesContext["contextData"];

                    if (this.contextData) {

                        var itemContext = {
                            'id': entityIds,
                            'type': entityTypes,
                            'attributeNames': this.attributeNames && this.attributeNames.length > 0 ? this.attributeNames : ["_ALL"]
                        };

                        clonedContext[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                        clonedContext[ContextHelper.CONTEXT_TYPE_VALUE] = DataHelper.cloneObject(this.contextData[ContextHelper.CONTEXT_TYPE_VALUE]);

                        this._contextData = clonedContext;
                    }

                }
            }

            _getActionData() {
                return [
                    {
                        "actions": [
                            {
                                "name": "Has Values",
                                "text": "Has Values",
                                "visible": true,
                                "eventName": "has-values"
                            },
                            {
                                "name": "Is Empty",
                                "text": "Is Empty",
                                "visible": true,
                                "eventName": "is-empty"
                            },
                            {
                                "name": "Has Partial Values",
                                "text": "Has Partial Values",
                                "visible": true,
                                "eventName": "has-partial-values"
                            },
                            {
                                "name": "Has Same Values",
                                "text": "Has Same Values",
                                "visible": true,
                                "eventName": "has-same-values"
                            },
                            {
                                "name": "Has Different Values",
                                "text": "Has Different Values",
                                "visible": true,
                                "eventName": "has-different-values"
                            }

                        ]
                    }
                ]
            }

            _onRefreshGrid() {
                this._dataGet();
            }

            _onDropdownChange(e, detail) {
                var filter = this.shadowRoot.querySelector("#actionsButton");
                var filteredData = this._data;

                if (filter) {
                    var filterBy = filter.selectedValue;

                    if (filterBy == "Has Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.hasValues) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Has Partial Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.hasPartialValues) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Is Empty") {
                        filteredData = this._data.filter(function (item) {
                            if (item.isEmpty) {
                                return item;
                            }
                        });
                    } else if (filterBy == "Has Same Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.sameValues) {
                                return item;
                            }
                        });
                    }
                    else if (filterBy == "Has Different Values") {
                        filteredData = this._data.filter(function (item) {
                            if (item.diffValues) {
                                return item;
                            }
                        });
                    }
                }

                this._gridData = undefined;
                this._gridData = filteredData;
            }

            _getEntityHeader(entity) {
                if (entity && this.entityTitle) {
                    //For Normal Scenario
                    if (entity[this.entityTitle] && !this.isSnapshot) {
                        return entity[this.entityTitle];
                    } else {
                        var attributes = entity.data.attributes;

                        if (attributes && attributes[this.entityTitle]) {
                            return attributes[this.entityTitle].values ? attributes[this.entityTitle].values[0].value : "";
                        }
                    }

                    //For Snapshot Scenario
                    if (entity[this.entityTitle] && this.isSnapshot) {
                        if(entity.type.indexOf("_snapshot")==-1) {
                            return "Current Entity:- " + entity.name
                        } else if (entity.data && entity.data.contexts[0] && DataHelper.isValidObjectPath(entity.data.contexts[0], "attributes.snapshotLabel.values")) {
                            var snapLabel = entity.data.contexts[0].attributes.snapshotLabel.values[0].value;
                        }
                        if(DataHelper.isValidObjectPath(entity, "properties.createdDate")) {
                            var createdDate = FormatHelper.convertFromISODateTime (entity.properties.createdDate, 'datetime');
                        }
                        return snapLabel + ":- " + createdDate;
                    } else {
                        var attributes = entity.data.attributes;

                        if (attributes && attributes[this.entityTitle]) {
                            return attributes[this.entityTitle].values ? attributes[this.entityTitle].values[0].value : "";
                        }
                    }
                }
                return "<No Name>";
            }

            _updateEntityHeader(entityId, entityHeader) {
                if(_.isEmpty(this.compareEntitiesContext)) {
                    return entityHeader;
                }
                if(!this.isSnapshot) {
                    return entityId == this.compareEntitiesContext.newEntity.id ? "New "+ entityHeader : "Matched "+ entityHeader;
                } else {
                    return entityHeader;
                }
            }

            _onColumnSelectionChanged(e) {
                if (e.detail.checked) {
                    this.selectedEntityId = e.detail.value;
                } else {
                    this.selectedEntityId = "";
                }
            }

            _onBackTap(e) {
                this._reset();
                var eventName = "compare-entities-back";
                this.fireBedrockEvent(eventName, null);
            }

            _onCreateTap(e) {
                //Already new entity details available, so just trigger the event
                var eventName = "compare-entities-create";
                this.fireBedrockEvent(eventName, null);
            }

            _onMergeTap(e) {
                if(!this.selectedEntityId) {
                    this.showErrorToast("Please select an entity for merge.");
                    return;
                }

                var matchedEntity = {};
                for(var i = 0; i < this.entities.length; i++) {
                    if(this.entities[i].id == this.selectedEntityId) {
                        matchedEntity = this.entities[i];
                        break;
                    }
                }
                var eventName = "compare-entities-merge";
                this.fireBedrockEvent(eventName, {
                    "matchedEntity": matchedEntity
                });
            }

            _allowCreate(compareEntitiesContext) {
                var allowCreate = false;
                if(compareEntitiesContext && compareEntitiesContext.matchConfig) {
                    allowCreate = compareEntitiesContext.matchConfig["allow-create"];
                }
                return allowCreate;
            }

            _reset() {
                this._modelGetTracker = 0;
                this.selectedEntities = [];
                this._gridConfig = {};
                this._gridData = this._data = [];
            }
        }

        customElements.define(RockCompareEntities.is, RockCompareEntities);
    </script>
</dom-module>