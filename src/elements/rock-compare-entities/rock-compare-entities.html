<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<dom-module id="rock-compare-entities">
    <template>
        <style>

        </style>

        <div>
            <rock-grid data="{{_gridData}}" config="{{_gridConfig}}" page-size="5"></rock-grid>
            <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_attributeModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse">
            </liquid-entity-model-composite-get>
            <liquid-entity-data-get operation="getbyids" id="entityDataGet" request-data="{{_entityGetRequest}}" on-response="_onEntityDataGetSuccess"
                on-error="_onEntityDataGetFailure">
            </liquid-entity-data-get>
        </div>
    </template>

    <script>
        class RockCompareEnities extends Polymer.Element {
            static get is() {
                return 'rock-compare-entities';
            }

            static get properties() {
                return {
                    _attributeModelRequest: {
                        type: Object,
                        value: ""
                    },
                    _entityGetRequest: {
                        type: Object,
                        value: ""
                    },
                    _girdConfig: {
                        type: Object,
                        value: ""
                    },
                    _gridData: {
                        type: Array,
                        value: ""
                    },
                    _rowsModel: {
                        type: Array,
                        value: ""
                    }
                };
            }

            static get observers() {
                return [

                ];
            }

            constructor() {
                super();

            }

            connectedCallback() {
                super.connectedCallback();
                this._attributeModelGet();
                console.log('rock-compare-entities created!');
            }

            _attributeModelGet() {
                var contextData = {
                    "ItemContexts": [
                        {
                            "type": "enart",
                            "attributeNames": ["_ALL"]
                        }
                    ],
                    "ValContexts": [
                        {
                            "source": "internal",
                            "locale": "en-US"
                        }
                    ]
                };

                var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(contextData);

                this.set("_attributeModelRequest", compositeModelGetRequest);
                var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                if (liquidModelGet && compositeModelGetRequest) {
                    liquidModelGet.generateRequest();
                }
            }

            _onCompositeModelGetResponse(e) {
                var rows = [];
                var entityModels = e.detail.response.content.entityModels;

                if (entityModels && entityModels.length) {
                    this._prepareGridRowsModel(entityModels, rows);
                    this._rowsModel = rows;

                    this._dataGet();
                }
            }

            _prepareGridRowsModel(entityModels, rows) {
                entityModels.forEach(function (entityModel) {
                    if (entityModel && entityModel.data && entityModel.data.attributes) {
                        var attributes = entityModel.data.attributes;

                        Object.keys(attributes).forEach(function (key, index) {
                            if (attributes[key]) {
                                var attribute = attributes[key];

                                if (index == 0) {
                                    rows.push({
                                        "header": attribute.properties.externalName,
                                        "name": key
                                    });
                                } else {
                                    if (!this._rowNameExist(key, rows)) {
                                        rows.push({
                                            "header": attribute.properties.externalName,
                                            "name": key
                                        });
                                    }
                                }
                            }
                        }, this);
                    }
                }, this);
            }

            _rowNameExist(rowName, rows) {
                var existingRows = [];
                if (rowName && rows && rows.length) {
                    existingRows = rows.filter(function (row) {
                        return row.name == rowName
                    });
                }

                if (existingRows) {
                    if (existingRows.length) {
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return false;
                }
            }

            _onEntityDataGetSuccess(e) {
                var columns = [];
                var items = [];

                var entities = e.detail.response.content.entities;

                if (entities && entities.length) {
                    this._prepareGridColumnsModelAndData(entities, columns, items);
                }

                var gridConfig = this._getBaseGridConfig();
                gridConfig.tabular.columns = columns;
                gridConfig.tabular.rows = this._rowsModel;

                this._gridConfig = gridConfig;
                this._gridData = items;
            }

            _prepareGridColumnsModelAndData(entities, columns, items) {
                if (this._rowsModel && this._rowsModel) {
                    this._rowsModel.forEach(function (row, index) {
                        var item = {};
                        entities.forEach(function (entity) {
                            var attributes = entity.data.attributes;

                            if (index == 0) {
                                columns.push({
                                    "header": entity.id,
                                    "name": entity.id,
                                    "sortable": true,
                                    "filterable": false,
                                    "readFrom": "properties"
                                });
                            }

                            if (attributes && attributes[row.name]) {
                                item[entity.id] = attributes[row.name].values ?  attributes[row.name].values[0].value : "";
                            } else {
                                item[entity.id] = "";
                            }

                        }, this);

                        items.push(item);
                    }, this);
                }
            }

            _onEntityDataGetFailure(e) {
                alert("entity data get failed. . .");
            }

            _dataGet() {
                var contextData = {
                    "ItemContexts": [
                        {
                            "id": ["en55qbpxf0c2t", "eq7hpkjthnei0"],
                            "type": ["enart", "eproductversion"],
                            "attributeNames": ["_ALL"]
                        }
                    ],
                    "ValContexts": [
                        {
                            "source": "internal",
                            "locale": "en-US"
                        }
                    ]
                }

                var req = DataRequestHelper.createEntityGetRequest(contextData);
                this.set("_entityGetRequest", req);

                var liquidDataGet = this.shadowRoot.querySelector("[id=entityDataGet]");
                if (liquidDataGet) {
                    liquidDataGet.generateRequest();
                }
            }

            _getBaseGridConfig() {
                return {
                    "viewMode": "Tabular",
                    "readOnly": true,
                    "schemaType": "simple",
                    "tabular": {
                        "settings": {
                            "isMultiSelect": false,
                            "disableSelectAll": true
                        },
                        "columns": [
                        ],
                        "rows": [
                        ]
                    }
                };
            }
        }

        customElements.define(RockCompareEnities.is, RockCompareEnities);
    </script>
</dom-module>