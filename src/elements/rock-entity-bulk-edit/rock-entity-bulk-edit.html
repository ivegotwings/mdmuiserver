<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--<link rel="import" href="../rock-attribute-model-grid/rock-attribute-model-grid.html">-->
<link rel="import" href="../rock-self-attribute-model-grid/rock-self-attribute-model-grid.html">
<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">
<link rel="import" href="../rock-scope-selector/rock-scope-selector.html">


<dom-module id="rock-entity-bulk-edit">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">
            #container {
                @apply(--layout-horizontal);
            }

            #left-container,
            #right-container {
                width: 50%;
            }

            .message {
                text-align: center;
            }

            #card {
                height: 100%;
                padding-bottom: 20px;
            }

            #attributes-card {
                height: 480px;
                padding-bottom: 20px;
                padding-left: 20px;
            }

            pebble-card {
                --pebble-card-widget-box: {
                    height: 100%;
                    padding-bottom: 10px;
                    margin: 0 0 0 0;
                    min-width: auto;
                    overflow: scroll;
                }
            }

            .card-content {
                height: 100%;
                overflow: hidden;
            }

            pebble-dialog {
                --dialog-component: {
                    width: 400px;
                    top: 20% !important;
                }
            }

            pebble-dialog::shadow ::content>ul {
                padding-left: 50px !important;
            }

            pebble-dialog>ul>li {
                list-style-type: disc;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>
        <liquid-rest id="bulkEntityEdit" url="/data/pass-through/bulkentityservice/createtask" method="POST" request-data={{_bulkEntityEditRequest}}
            on-liquid-response="_onBulkEntityEditSuccess" on-liquid-error="_onBulkEntityEditFailure"></liquid-rest>
        <pebble-card id="card" no-header>
            <rock-scope-selector id="scopeSelector" selected-scope="[[_selectedItems]]" context-data="[[contextData]]" show-title allow-manage-scope
                show-settings>
            </rock-scope-selector>
            <bedrock-pubsub event-name="rock-scope-click" handler="_onScopeTagClicked"></bedrock-pubsub>
        </pebble-card>
        <div id="container">
            <div id="left-container">
                <pebble-card id="card" no-header>
                    <rock-self-attribute-model-grid id="attributesGrid" context-data="[[contextData]]" selected-items="[[_selectedItems]]" config="[[_gridConfig]]"></rock-self-attribute-model-grid>
                </pebble-card>
                <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="attributeModelGrid"></bedrock-pubsub>
                <bedrock-pubsub event-name="grid-deselecting-item" handler="_onDeSelectingGridItem" target-id="attributeModelGrid"></bedrock-pubsub>
            </div>
            <div id="right-container">
                <pebble-card id="attributes-card" no-header>
                    <pebble-accordion header-text="[[groupName]]" default-icon="expand-less" open-icon="expand-more">
                        <rock-attribute-list id="attributeList" group-name="" context-data="[[contextData]]" no-of-columns="1" mode="edit" attribute-values="{{_attributeValues}}"
                            attribute-models="[[_attributeModels]]" show-delete-icon></rock-attribute-list>
                    </pebble-accordion>
                </pebble-card>
                <bedrock-pubsub event-name="attribute-control-delete" handler="_onAttributeControlDelete" target-id=""></bedrock-pubsub>
            </div>
        </div>
        <div id="buttonContainer" align="center">
            <pebble-button id="cancel" class="btn btn-secondary m-r-10" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
            <pebble-button id="reset" class="btn btn-primary m-r-5" button-text="Reset" on-tap="_onResetTap" elevation=1 raised></pebble-button>
            <pebble-button id="save" class="focus btn btn-success" button-text="Save" on-tap="_onSaveTap" elevation=1 raised></pebble-button>
        </div>
        <pebble-dialog id="cancelDialog" dialog-title="Confirmation" show-cancel show-ok no-cancel-on-outside-click no-cancel-on-esc-key
            small>
            <p>Are you sure you want to discard the unsaved changes.</p>
        </pebble-dialog>
        <bedrock-pubsub event-name="on-buttonok-clicked" handler="_revertAll" target-id="cancelDialog"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-entity-bulk-edit",

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    workflowCriterion: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _selectedItems: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _attributeModels: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectionMode: {
                        type: String,
                        value: "count"
                    },
                    selectionQuery: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _bulkEntityEditRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () {
                            return this.getParentAppConfig("rock-entity-bulk-edit", '', "gridConfig");
                        }
                    },
                    _request: {
                        type: Object,
                        value: function () {
                            return this.getParentAppConfig("rock-entity-bulk-edit", '', "requestData");
                        }
                    },
                    groupName: {
                        type: String,
                        value: "Selected Attributes"
                    },
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                _onSelectingGridItem: function (e, detail) {
                    var selectedItem = detail.item;
                    if (!(this._selectedItems.find(obj => obj.name === selectedItem.name))) {
                        this._selectedItems.push(selectedItem);
                    }
                    selectedItem["hasWritePermission"] = true;
                    if (!this._attributeModels[selectedItem.name]) {
                        this._attributeModels[selectedItem.name] = selectedItem;
                        var values = DataTransformHelper.transformAttributes({}, this._attributeModels, this.contextData, "array", true);
                        var value = values.find(obj => obj.name === selectedItem.name);
                        if (value) {
                            this.push("_attributeValues", value);
                        }
                    }
                },
                _onDeSelectingGridItem: function (e, detail) {
                    var deSelectedItem = detail.item;
                    if (this._selectedItems.find(obj => obj.name === deSelectedItem.name)) {
                        var index = this._selectedItems.indexOf(deSelectedItem);
                        this._selectedItems.splice(index, 1);
                    }
                    if (this._attributeModels[deSelectedItem.name]) {
                        delete this._attributeModels[deSelectedItem.name];
                    }
                    var attr = this._attributeValues.find(obj => obj.name === deSelectedItem.name);
                    if (attr) {
                        var index = this._attributeValues.indexOf(attr);
                        if (index !== -1) {
                            this.splice("_attributeValues", index, 1);
                        }
                    }
                },
                _onScopeTagClicked: function (e, detail) {
                    if (detail && detail.data) {
                        var attributesGrid = this.$$("#attributesGrid");
                        attributesGrid.clearSelection();
                        this._selectedItems = [];
                        var scopeItems = detail.data.scope;
                        var gridItems = attributesGrid.getData();
                        //scope may have contextual attributes as well. 
                        //Need to filter inorder to get only self context attributes for edit.
                        for (var i = 0; i < scopeItems.length; i++) {
                            var scopeItem = scopeItems[i];
                            var gridItem = gridItems.find(obj => obj.name === scopeItem.name);
                            if (gridItem) {
                                this.push("_selectedItems", gridItem);
                            }
                        }
                        attributesGrid.selectItems(this._selectedItems);
                        this._attributeModels = {};
                        for (var i = 0; i < this._selectedItems.length; i++) {
                            var selectedItem = this._selectedItems[i];
                            selectedItem["hasWritePermission"] = true;
                            if (!this._attributeModels[selectedItem.name]) {
                                this._attributeModels[selectedItem.name] = selectedItem;
                            }
                        }
                        var values = DataTransformHelper.transformAttributes({}, this._attributeModels, this.contextData, "array", true);
                        this._resetListGroupName(detail.data.name);
                        this._attributeValues = values;
                    }
                },
                _onCancelTap: function (e) {
                    var attributeList = this.$$("#attributeList");
                    if (attributeList.getIsDirty()) {
                        this.$$("#cancelDialog").open();
                    } else {
                        this._revertAll();
                    }
                },

                _revertAll: function () {
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },

                _onSaveTap: function (e) {
                    if (!_.isEmpty(this.selectionQuery)) {
                        this._loading = true;

                        var attributeList = this.$$("#attributeList");
                        var changedAttributeElements = attributeList.getChangedAttributeElements();
                        if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                            this.showInformationToast("No changes to save.");
                            this._loading = false;
                            return;
                        }

                        var attributesJSON = [];
                        for (var i = 0; i < changedAttributeElements.length; i++) {
                            var attributeElement = changedAttributeElements[i];
                            var attributeJSON;
                            if (attributeElement.attributeObject.action == "delete") {
                                attributeJSON = DataHelper.cloneObject(attributeElement.originalAttributeObject);
                                attributeJSON.action = "delete";
                            } else {
                                attributeJSON = attributeElement.attributeObject;
                            }
                            attributesJSON.push(attributeJSON);
                        }

                        var newEntity = DataTransformHelper.prepareEntityForAttributesSave({}, attributesJSON, this.contextData);
                        var data = newEntity.data;
                        var req = {
                            "params": {
                                "operationType": "inboundService",
                                "data": data
                            }
                        };

                        //Add hotline flag if hotline is enabled
                        if(DataHelper.isHotlineChecked()) {
                            if(!req.clientState) {
                                req.clientState = {};
                            }
                            req.clientState.hotline = true;
                        }

                        if (this.selectionQuery.ids) {
                            req.params.taskType = "process-query";
                            req.params.query = this.selectionQuery;
                        } else {
                            if (_.isEmpty(this.workflowCriterion)) {
                                req.params.taskType = "process-query";
                                req.params.query = this.selectionQuery.params ? this.selectionQuery.params.query : this.selectionQuery;
                            } else {
                                this.$$("#bulkEntityEdit").url = "/data/pass-through-combined-query/bulkentityservice/createtask";
                                req.params.taskType = "process-multi-query";
                                req.entities = [this.selectionQuery.entity];
                            }
                        }

                        var bulkEditLiquid = this.$$("#bulkEntityEdit");
                        if (bulkEditLiquid) {
                            this.set("_bulkEntityEditRequest", req);
                            bulkEditLiquid.generateRequest();
                        }
                    }
                },
                _onBulkEntityEditSuccess: function (e) {
                    var response = e.detail.response && e.detail.response.response ? e.detail.response.response : e.detail.response;
                    var request = e.detail.response ? e.detail.response.request : undefined;

                    if ((!response || _.isEmpty(response)) ||
                        (DataHelper.isValidObjectPath(response, "dataObjectOperationResponse.status") && response.dataObjectOperationResponse.status.toLowerCase() == "error") ||
                        (response.status && response.status.toLowerCase() == "error")) {
                        this._message = "Bulk edit request failed";
                        this._loading = false;
                        return;
                    } else {
                        if (response.status && response.status.toLowerCase() == "success") {
                            if (request && request.taskId) {
                                this._taskId = request.taskId;
                            }
                        }

                        this._message = "Bulk Edit request triggered successfully";
                        this._triggerFinishStep();
                    }
                },
                _onBulkEntityEditFailure: function (e) {
                    this._loading = false;
                    this._message = "Failed to perform the Bulk entity edit. Please contact administrator.";
                    this.logError("bulkEntityProcessFailure", "response", JSON.stringify(e.detail));
                },
                _triggerFinishStep: function () {
                    var message = "Entity process is started, you can review the progress of the task " + this._taskId + " in task details.";
                    var messages = [
                        {
                            "message": message
                        }
                    ]
                    var actions = [
                        {
                            "name": "goBack",
                            "text": "Take me back to where I started",
                            "isNotApp": true
                        },
                        {
                            "name": "gotoJobDetails",
                            "text": "Show me the task details",
                            "isNotApp": true,
                            "dataRoute": "task-detail",
                            "queryParams": {
                                "id": this._taskId
                            }
                        }
                    ];

                    var data = {
                        "messages": messages,
                        "noGrid": true,
                        "actions": actions,
                    };

                    this.businessFunctionData = data;
                    var eventName = "onComplete";
                    var eventDetail = {
                        name: eventName
                    }

                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _resetListGroupName: function (groupName) {
                    if (groupName) {
                        this.set("groupName", groupName);
                    } else {
                        this.set("groupName", "Selected Attributes");
                    }
                },
                _onResetTap: function (e) {
                    this._selectedItems = [];
                    this._attributeModels = {};
                    this.$$("#attributesGrid").clearSelection();
                    this._resetListGroupName();
                    this._attributeValues = [];
                },
                _onAttributeControlDelete: function (e, detail) {
                    var attribute = detail.data;
                    var grid = this.$$("#attributesGrid");
                    var selectedItems = grid.getSelectedItems();
                    var item = selectedItems.find(obj => obj.name === attribute.name);
                    delete this._attributeModels[item.name];
                    var selectedItem = this._selectedItems.find(obj => obj.name === item.name);
                    if (selectedItem) {
                        var index = this._selectedItems.indexOf(selectedItem);
                        this._selectedItems.splice(index, 1);
                    }
                    grid.deselectItem(item);
                }
            })
        })();
    </script>
</dom-module>