<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-behavior/liquid-behavior.html">
<!--
`liquid-config-getdata`
Boolean control

@demo demo/index.html 
-->
<dom-module id="liquid-config-getdata">
    <template>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-config-getdata',
                behaviors: [RUFBehaviors.LiquidBehavior],
                attached: function () {
                },
                ready: function () {
                },
                properties: {
                    _dataChannelName: {
                        type: String,
                        value: "configDataChannel",
                        readonly: true
                    }
                },
                _executeRequest: function (model, request) {
                    var op = request.operation,
                        reqId = request.requestId === undefined ? '' : request.requestId,
                        reqData = request.requestData;

                    if (op === 'getconfigs') {
                        return this._callGetConfigs(model, request);
                    }
                    else {
                        throw 'exception: operation ' + op + ' is not supported in ' + this.is + ' element.';
                    }
                },
                _formatResponse: function (request, rawResponsePkg) {
                    var op = request.operation;

                    if (op === 'getconfigs') {
                        var pathRootKey = "configs";
                        var configs = rawResponsePkg.json[pathRootKey];
                        var formattedConfigs = this._formatconfigData(configs);
                        return { 'configs': formattedConfigs };
                    }
                },
                _formatconfigData: function (configs) {
                    return configs;
                },
                _callGetConfigs: function (model, request) {
                    if (request === undefined) {
                        console.log("Could not find request object");
                        return;
                    }
                    var reqData = request.requestData;
                    if (reqData === undefined || reqData.apps === undefined) {
                        console.log("Could not find apps for config get... returning");
                        return;
                    }

                    if (this.verbose) {
                        console.log('Request for get configs call...request: ', reqData);
                    }

                    var pathRootKey = "configs";
                    var appNames = reqData.apps;

                    //making two calls like this because, all component configs will be maintained in a master list and 
                    //then every context specific config object will internlly refer the master list object - similar to relTo objects 
                    var componentNamesPath = ["configs", "apps", appNames, "componentNames"];
                    var configPathPart1 = ["configs", "tenants", ["t1"], "roles", ["buyer"], "users", ["john"], "apps"];
                    var configPathPart2 = ["components"]
                    var configPathPart3 = ["ctx", ["ctxKey1"], "config"];
                    //var configPath = ["configs", "tenants", ["t1"], "roles", ["buyer"], "users", ["john"], "apps", ["app-entity-discovery"], "components", "all-components"];

                    var self = this;
                    model.get(componentNamesPath).then(function (responsePkg) {
                        //console.log("response from component list call: ", JSON.stringify(responsePkg, null, 2));
                        var configPaths = [];
                        if (responsePkg && responsePkg.json.configs && responsePkg.json.configs.apps) {
                            var appsWithComponentNames = responsePkg.json.configs.apps;
                            appNames.forEach(function (appName) {
                                //console.log('appName: ', appName, ' ', appName in appsWithComponentNames);
                                if (appName in appsWithComponentNames && appsWithComponentNames[appName].componentNames) {
                                    var appComponentNames = appsWithComponentNames[appName].componentNames;
                                    if (appComponentNames.length > 0) {
                                        var appConfigPath = configPathPart1.concat([[appName]]).concat(configPathPart2).concat([appComponentNames]).concat(configPathPart3);
                                        //console.log("appConfigPath: ", appConfigPath);
                                        configPaths.push(appConfigPath);
                                    }
                                }
                            });
                        }
                        //console.log('making config get call with paths: ', configPaths);
                        model.get.apply(model, configPaths).then(function (configGetResponse) {
                            //console.log('response from config get call: ', configGetResponse);
                            self._handleResponse(request, configGetResponse);
                        });
                    });
                }
            });
        })();
    </script>
</dom-module>