<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-data-table/grid-selection-popover.html">
<link rel="import" href="../pebble-info-icon/pebble-info-icon.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html" />

<link rel="import" href="../rock-image-viewer/rock-image-viewer.html">
<link rel="import" href="./grid-item-view-behavior.html">

<!--
`grid-tile-view` Represents an element that displays the items in the `grid-tile-view`.

@demo demo/index.html
-->

<dom-module id="grid-tile-view">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            :host{
                display: grid;	
                display: -ms-grid;	
                -ms-grid-rows: max-content 1fr;	
                grid-template-rows: max-content 1fr;	
                -ms-grid-columns: 1fr;	
                grid-template-columns:1fr;		
                height:100%;
            }
            iron-list {
                height: auto;
                display: block;
                min-height: 0px;            
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
                overflow-x: hidden;
                width: 100%;
                --iron-list-items-container: {
                    width: 100%;
                }
            }

            :host {
                @apply --paper-font-common-base;
                width: 100%;
            }

            pebble-spinner {
                --pebble-spinner-position: {
                    top: 150px;
                }
            }

            .trim {
                display: block;
                width: 100%;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .title {
                font-weight: var(--font-bold, bold);
                max-width: 100%;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
            }
            
            .key-title {
                max-width: 60%;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
            }

            .value-title {
                font-weight: var(--font-bold, bold);
                max-width: 100%;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                min-width: 0;
            }
            .subtitle {
                margin-bottom: 5px;
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-steel-grey, #75808b);
                display: inline-block;
                max-width: 100%;
            }

            .block-text {
                font-weight: var(--font-medium, 500);
            }

            .button-container {
                position: relative;
                float: left;
                margin: 20px 0 0 20px;
            }

            .photoContent {
                position: relative;
                width: 100%;
                background-color: var(--white, #fff);
                border: solid 1px var(--default-border-color, #c1cad4);
                border-radius: var(--default-border-radius, 3px);
                box-shadow: 0 0 3px 0 rgba(193, 202, 212, 0.7);
            }

            .photoContent .right {
                float: right;
            }

            #image-container {
                width: calc(100% - 20px);
                height: 120px;
                margin: 10px;
                text-align: center;
                border-radius: var(--default-border-radius, 3px);
                float: left;
            }

            .text {
                margin: 10px 20px 20px 20px;
            }

            .item-container {
                display: -webkit-inline-flex;
                display: inline-flex;
                min-height: 302px;
                border-radius: var(--default-border-radius, 3px);
                padding: 0 10px 20px 10px;
                width: calc(20% - 20px);
            }

            @media (min-width: 1600px) {
                .item-container {
                    width: calc(99.9% / 6);
                }
            }

            @media (max-width: 1600px) {
                .item-container {
                    width: calc(99.9% / 4);
                }
            }

            @media (max-width: 1024px) {
                .item-container {
                    width: calc(99.9% / 3);
                }
            }

            @media (max-width: 768px) {
                .item-container {
                    width: calc(99.9% / 2);
                }
            }

            @media (max-width: 480px) {
                .item-container {
                    width: 99.9%;
                }
            }

            .photoContent:hover {
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);
            }

            .right {
                float: right;
            }

            .center {
                text-align: center;
                color: var( --palette-water-blue, #139de6);
            }

            .top {
                display: inline-flex;
                display: -webkit-inline-flex;
                width: 100%;
                text-align: center;
                box-sizing: border-box;
                padding: 0px 7px 7px 0px;
            }

            .top grid-selection-popover {
                float: left;
                margin-top: -3px;
            }

            .header-button-container {
                position: relative;
                float: left;
            }


            .actions {
                margin-left: 2%;
            }

            .actionsPopover {
                @apply --pebble-actions-popover;
                --default-popup-t-p: 5px;
                --default-popup-b-p: 5px;
            }

            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-steel-grey, #75808b);
                text-align: left;
                transition: all 0.3s;
                -webkit-transition: all 0.3s;
                @apply --popup-item;
            }

            pebble-popover paper-item[disabled] {
                cursor: no-drop;
                pointer-events: visible!important;
                --pebble-icon-container: {
                    opacity: 0.5;
                }
            }

            pebble-popover paper-item[disabled] .action-container {
                pointer-events: none;
            }

            pebble-popover paper-item:hover {
                background-color: var(--bgColor-hover, #e8f4f9);
                color: var(--focused-line, #026bc3);
            }

            pebble-popover paper-item:focus {
                color: var(--primary-button-color, #036bc3);
                background-color: var(--bgColor-hover, #e8f4f9);
            }

            pebble-icon {
                padding: 0;
                margin-top: 8px;
                margin-right: 5px;
                color: var(--primary-icon-color, #75808b);
            }

            .listContent {
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -ms-flex: 1 0 auto;
                -webkit-flex: 1 0 auto;
                flex: 1 0 auto;
                font-size: var(--default-font-size, 14px);
                color: var(--palette-steel-grey, #75808b);
                max-width:100%;
            }

            #gridSelectionPopover {
                cursor: pointer;
                width: 20px;
                --popover-position: {
                    margin-top: -3px;
                    margin-left: 3px;
                }
                ;
            }

            .isPrimary {
                background-color: #e8ecf1;
            }

            .coalesced-value {
                font-style: italic;
            }

            .view-source-information-popover {
                font-weight: normal;
                text-transform: initial;
                text-align: left;
                margin-left: -12px;
                margin-top: 7px;
                --default-popup-b-p: 5px;
                --default-popup-t-p: 5px;
                --default-font-size: 12px;
                width: 180px;
            }

            .view-source-information-popover::after,
            .view-source-information-popover::before {
                bottom: 100%;
                left: 20px;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            .view-source-information-popover::after {
                border-color: rgba(255, 255, 255, 0);
                border-bottom-color: #ffffff;
                border-width: 6px;
                margin-left: -6px;
            }

            .view-source-information-popover::before {
                border-color: rgba(194, 225, 245, 0);
                border-bottom-color: rgb(216, 221, 228);
                border-width: 7px;
                margin-left: -7px;
            }

            .source-information-header,
            .source-information-description,
            .source-information-path {
                padding-left: 10px;
                padding-right: 10px;
            }

            .source-information-header {
                font-weight: bold;
                border-bottom: thin solid rgb(216, 221, 228);
                padding-bottom: 3px;
            }

            .source-information-path {
                margin-top: 10px;
                margin-bottom: 0px;
            }

            .source-information-path .path-item {
                color: var(--link-text-color, #139ee7);
                display: inline-block;
            }

            .source-information-path .path-item::after {
                content: " >>";
                color: var(--default-text-color, #444444);
            }

            .source-information-path .path-item:last-of-type::after {
                content: "";
            }

            li {
                text-align: inherit;
            }
                  
        </style>

        <div class="top" hidden="[[!enableMultiSelection]]" class="base-grid-structure-child-1">
            <pebble-checkbox class="header-button-container" header on-tap="_toggleSelectAll" checked="[[_isSelectAllChecked(selectedItems.length, selectedItems.inverted, items.length)]]"
                indeterminate="[[_isSelectAllIndeterminate(selectedItems.length, items.length)]]"></pebble-checkbox>
            <template is="dom-if" if="[[advanceSelectionEnabled]]">
                <grid-selection-popover selection-options="[[advanceSelectionOptions]]" id="gridSelectionPopover" on-selection-changed="_onPopoverSelectionChange"></grid-selection-popover>
            </template>
        </div>
        <template is="dom-if" if="{{loading}}">
            <pebble-spinner active="[[loading]]"></pebble-spinner>
        </template>
        <iron-list id="list" as="item" items="[[items]]" grid class="base-grid-structure-child-2">
            <template>
                <div class="item-container" id$="gridItem[[index]]">
                    <div class$="{{_computePrimaryClass(item)}}" tabindex$="[[tabIndex]]">
                        <pebble-checkbox on-tap="_tapEvent" class="button-container" checked="[[_isSelected(item,selectedItems, selectedItems.*)]]"
                            noink disabled$="[[_disableGridCheckBox]]"></pebble-checkbox>
                        <div class="right">
                            <pebble-icon id="actions_container_{{item.id}}" class="dropdown-trigger pebble-icon-size-16 tooltip-bottom" name="more" icon="pebble-icon:actions-more-vertical"
                                data-tooltip="More options" on-tap="_onActionsTap" noink></pebble-icon>
                            <pebble-popover id$="action_list_{{item.id}}" class="actionsPopover" for="actions_container_{{item.id}}" no-overlap horizontal-align="right">
                                <template is="dom-repeat" items="[[_getActions(item)]]" as="action">
                                    <paper-item id="action_[[item.id]]_[[action.name]]" class="tooltip-bottom" data-tooltip$="[[action.tooltip]]" item="[[item]]"
                                        disabled$="[[action.disabled]]">
                                        <div class="action-container" action="[[action]]" on-tap="_onActionItemTap">
                                            <div>
                                                <template is="dom-if" if="[[action.icon]]">
                                                    <pebble-icon icon="[[action.icon]]"></pebble-icon>
                                                </template>
                                            </div>
                                            <div>
                                                <template is="dom-if" if="[[action.text]]">
                                                    [[action.text]]
                                                </template>
                                            </div>
                                        </div>
                                    </paper-item>
                                </template>
                            </pebble-popover>

                            <template is="dom-if" if="[[_hasContextCoalescedValue(item)]]">
                                <pebble-popover class="view-source-information-popover" id="action_[[item.id]]_sourceInfo-popover" for="action_[[item.id]]_sourceInfo">
                                    <div class="attributes-description">
                                        <div class="source-information-header">Source Information</div>
                                        <div class="source-information-description">This value was sourced from the following path</div>
                                        <ul class="source-information-path">
                                            Context:
                                            </br>
                                            <template is="dom-repeat" items="[[item.contextCoalescePaths]]" as="coalescePath">
                                                <li class="path-item">[[coalescePath]]</li>
                                            </template>
                                        </ul>
                                    </div>
                                </pebble-popover>
                            </template>
                        </div>
                        <rock-image-viewer alt="Product image." id="image-container" sizing="contain" src="{{_computeImage(item,tileItems.image)}}"
                            thumbnail-id="{{_computeValue(item,tileItems.thumbnailId)}}" asset-details="[[item]]">
                        </rock-image-viewer>
                        <div class="clearfix"></div>
                        <div class="text">
                            <div class="title block-text tooltip-bottom" data-tooltip$="[[_computeTitle(item,tileItems.title)]]">
                                <div class$="text-ellipsis [[_getStyleClass(item)]]">[[_computeTitle(item,tileItems.title)]]</div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="subtitle tooltip-bottom" data-tooltip$="[[_computeTitle(item,tileItems.subtitle)]]">
                                <div class$="text-ellipsis [[_getStyleClass(item)]]">[[_computeTitle(item,tileItems.subtitle)]]</div>
                            </div>
                            <template is="dom-repeat" items="{{_getArrayFromObject(tileItems.fields)}}" as="field">
                                <template is="dom-if" if="[[_isItemFieldEnabled(item,field)]]">
                                <div class="listContent">
                                    <div class="key-title tooltip-bottom" data-tooltip$="[[_getDisplayName(field.header)]]">
                                        <div class$="text-ellipsis {{_computeClass(field)}}">[[_getDisplayName(field.header)]]</div>
                                    </div>
                                    <div class="clearfix"></div>
                                    <template is="dom-if" if="[[_getAttributeModel(field)]]">
                                        <pebble-info-icon description-object="[[_getAttributeModel(field)]]" icon-size="small"></pebble-info-icon>
                                    </template>
                                    <div class="value-title tooltip-bottom" data-tooltip$="[[_computeValue(item,field.name)]]">
                                        <div class$="text-ellipsis block-text [[_getStyleClass(item)]]">&nbsp;[[_computeValue(item,field.name)]]</div>
                                    </div>
                                </div>
                                </template>
                                </template>
                        </div>
                    </div>
                </div>
            </template>
        </iron-list>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'grid-tile-view',
                properties: {
                    resultRecordSize: {
                        type: Number,
                        value: 0
                    },

                    /**
                     * Indicates the config of the `grid-tile-view`.
                     */
                    tileItems: {
                        type: Object
                    },

                    _disableGridCheckBox: {
                        type: Boolean,
                        value: false
                    },

                    _viewMode: {
                        type: String,
                        value: 'Tile'
                    }
                },

                behaviors: [
                    RUFBehaviors.GridItemViewBehavior
                ],

                created() {
                    this.notifyResize = _.debounce(this._notifyResize.bind(this), 500);
                },

                attached() {
                    Polymer.RenderStatus.afterNextRender(this, this._loadMoreData.bind(this));
                },

                _notifyResize(e) {
                    this.$.list.notifyResize();
                },

                _onPopoverSelectionChange: function (e) {
                    this._disableGridCheckBox = false;
                    if (RUFBehaviors.GridItemViewBehavior._onPopoverSelectionChange.call(this, e)) {
                        this._disableGridCheckBox = true;
                    }
                },
                _loadMoreData: function () {
                    //load more data only when - items are more than current page can hold
                    if (this.items && ((this.items.length < this.page * this.pageSize) || (this.resultRecordSize && this.items.length == this.resultRecordSize))) {
                        return;
                    }
                    this.page++;
                },
                /**
                 * <b><i>Content development is under progress... </b></i>
                 */
                reloadData: function () {
                    if (!this.loading) {
                        this.page = -1;
                        this.items = [];
                        this.page = 1;
                    }

                },

                _resetAdvanceSelection: function () {
                    const successReset = RUFBehaviors.GridItemViewBehavior._resetAdvanceSelection.call(this);

                    if (successReset) {
                        this._disableGridCheckBox = false;
                    }
                },
                /**
                 * This is an internal function to handle the tap event. It fires event 'deselecting-item' if an item was already selected.
                 *  It fires event 'selecting-item' if an item was not selected. The data of the event fired is the data of the item.
                 */
                _tapEvent: function (e) {
                    if (this.selectionInfo && this.selectionInfo.mode == "query") {
                        return;
                    }
                    RUFBehaviors.GridItemViewBehavior._tapEvent.call(this, e);
                },
                /**
                 * This is an internal function, used to compute the image url based on the config.
                 */
                _computeImage: function (item, image) {
                    if (item) {
                        return item[image];
                    }
                },
                /**
                 * This is an internal function, used to compute the title based on the config.
                 */
                _computeTitle: function (item, title) {
                    if (item) {
                        return item[title];
                    }
                },

                /**
                 * Check for the field type and display the item details accordingly
                 */
                _isItemFieldEnabled: function (item, field) {
                    if(this.tileItems.title == field.name) return '';
                    if (field.type && item) {
                        var fieldTypes = field.type.toString();
                        return (field.type == "All" || fieldTypes.indexOf(item.type) > -1);
                    }
                    return true;
                },

                /**
                 * This is an internal function, used to compute the value of the attribute to be displayed.
                 */
                _computeValue: function (item, field) {
                    if (item) {
                        return item[field];
                    }
                },

                /*
                 * Can be used to select all the items in the list.
                 */
                selectAll: function () {
                    this.set('selectedItems', []);
                    this.set('selectedItems.inverted', true);
                },
                /**
                 * Can be used to clear the current selection state.
                 */
                clearSelection: function () {
                    this.set('selectedItems', []);
                    RUFBehaviors.GridItemViewBehavior._clearSelection.call(this);
                },

                _computePrimaryClass: function (item) {
                    if (item.isprimary) {
                        if (item.isprimary == "true") {
                            return "photoContent isPrimary"
                        }
                    }
                    return "photoContent";
                },

                _getActions: function (item) {
                    var actions = DataHelper.cloneObject(this.actions);
                    if (this._addSourceInfoAction(actions, item)) {
                        actions.forEach(function (item) {
                            if (item.eventName == "delete-item") {
                                item.disabled = true;
                                item.tooltip = "Sourced relationship can not be deleted";
                            }
                        });
                    }

                    return actions;
                }
            });
        })();
    </script>
</dom-module>