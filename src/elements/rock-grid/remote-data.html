<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<dom-module id="remote-data">
    <template>
        <style include="pebble-shared-styles"></style>
        <template is="dom-if" if="{{_isEntitySearchGrid(operation)}}">
            <liquid-entity-data-get id="initiateSearchResult" operation="initiatesearch" request-data="{{request}}" last-response="{{_searchResponse}}"
                exclude-in-progress></liquid-entity-data-get>
            <liquid-entity-data-get id="getsearchresultdetail" operation="getsearchresultdetail" request-data="{{request}}" request-id="[[_searchResponse.content.requestId]]"
                last-response="{{remoteData}}" exclude-in-progress></liquid-entity-data-get>
        </template>
        <template is="dom-if" if="{{!_isEntitySearchGrid(operation)}}">
            <liquid-entity-data-get id="getRemoteData" operation="[[operation]]" request-data="[[request]]" last-response="{{remoteData}}"
                exclude-in-progress>
            </liquid-entity-data-get>
        </template>
    </template>
    <script>
        Polymer({
            is: 'remote-data',

            properties: {
                /**
                 * Indicates an external data source which is binded to the `rock-grid` for loading the data.
                 * The format for external data source and how to pass it is given in the above description.
                 **/
                dataSource: {
                    notify: true,
                    value: function () {
                        return this._dataSource.bind(this);
                    }
                },

                /**
                 * Indicates the liquid request object for data to be rendered in the grid.
                 */
                request: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                /**
                 * Indicates an operation name for the provided liquid request object.
                 */
                operation: {
                    type: String,
                    value: ""
                },

                /**
                 * Indicates call back function where if user has given any liquid operation and request object to load the data,then
                 * user has to transform the data based on their grid config and return an array of records.
                 */
                dataFormatter: {
                    notify: true
                },

                /**
                 * 
                 * Indicates an incremental data size for each page in the grid while use of "dataSource" for virtualization.
                 * This is auto calculated.
                 **/
                currentRecordSize: {
                    type: Number,
                    notify: true,
                    value: 0
                },

                /**
                 * 
                 * Indicates the total record size of the grid.
                 * This is auto calculated.
                 */
                totalRecords: {
                    type: Number,
                    notify: true,
                    value: 0
                },

                _data: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                }
            },
            _lastPage: -1,
            _dataSource: function (opts, cb) {

                var onResponseData = function () {
                    if (this._lastPage < opts.page) {
                        var data = [];
                        if (this.dataFormatter) {
                            data = this.dataFormatter(this.remoteData);
                        }

                        if (opts.pageSize <= data.length) {
                            if (this.currentRecordSize / opts.pageSize >= opts.page) {
                                this.currentRecordSize += this.currentRecordSize == 0 ? opts.pageSize *
                                    2 : opts.pageSize;
                            }
                        } else {
                            if (this.currentRecordSize == 0) {
                                this.currentRecordSize = data.length;
                            } else {
                                this.currentRecordSize -= opts.pageSize;
                            }
                        }

                        cb(data);
                        this._lastPage = opts.page;
                        this.totalRecords += data.length;
                    }
                };

                var options = {
                    "from": opts.page * opts.pageSize,
                    "to": ((opts.page * opts.pageSize) + opts.pageSize) - 1
                };
                this.set("request.params.options", options);

                if (this.operation == "entitySearch") {
                    var liquidInitSearch = Polymer.dom(this).node.$$(
                        "liquid-entity-data-get[id='initiateSearchResult']");
                    var liquidgetSearch = Polymer.dom(this).node.$$(
                        "liquid-entity-data-get[id='getsearchresultdetail']");

                    if (liquidInitSearch && liquidgetSearch) {

                        var onIniteSearchResponse = function () {
                            liquidgetSearch.generateRequest();
                        };

                        this._oneTimeEvent(liquidgetSearch, 'response', onResponseData.bind(this));
                        this._oneTimeEvent(liquidInitSearch, 'response', onIniteSearchResponse.bind(this));

                        liquidInitSearch.generateRequest();
                    }
                } else {
                    var liquidGet = Polymer.dom(this).node.$$("liquid-entity-data-get[id='getRemoteData']");

                    if (liquidGet) {
                        this._oneTimeEvent(liquidGet, 'response', onResponseData.bind(this));
                        liquidGet.generateRequest();
                    }
                }
            },

            _isEntitySearchGrid: function (operation) {
                if (operation == "entitySearch") {
                    return true;
                } else {
                    return false;
                }
            },

            _resetDataSource: function () {
                this.currentRecordSize = 0;
                this._lastPage = -1;
                this.totalRecords = 0;
            },

            _oneTimeEvent: function (element, type, callback) {
                element.addEventListener(type, function (e) {
                    e.target.removeEventListener(e.type, arguments.callee);
                    return callback(e);
                });
            }
        });
    </script>
</dom-module>