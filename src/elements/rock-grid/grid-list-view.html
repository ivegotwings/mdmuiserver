<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-data-table/grid-selection-popover.html">

<link rel="import" href="../rock-image-viewer/rock-image-viewer.html">

<link rel="import" href="check-box-with-indeterminate-state.html">

<!--
`grid-list-view` Represents an element that displays the items in the `grid-list-view`.

@demo demo/index.html
-->

<dom-module id="grid-list-view">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <custom-style>
            <style>
                .loadingIndicator {
                    position: relative;
                    text-align: center;
                    width: 100%;
                    height: 100%;
                }

                #scrollingRegion {
                    height: var(--rock-grid-height, 400px);
                    overflow: auto;
                    -webkit-overflow-scrolling: touch;
                    border-radius: 3px;
                    @apply --grid-list-view-scrollingRegion;
                }

                .left {
                    width: 3%;
                    text-align: center;
                }

                .button-container {
                    position: relative;
                    top: 50%;
                    left: 20%;
                    float: left;
                    margin-top: -7px;
                }

                .container {
                    width: 100%;
                    display: inline-flex;
                    display: -webkit-inline-flex;
                    padding: 10px;
                    align-items: center;
                    box-sizing: border-box;
                    border-bottom: 1px solid var(--divider-color, #c1cad4);
                }

                #image-container {
                    width: var(--default-thumb-size, 40px);
                    height: var(--default-thumb-size, 40px);
                }

                .trim {
                    display: block;
                    width: 100%;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    white-space: nowrap;
                }

                .default {
                    margin-right: 5%;
                    width: 95%;
                }
                /*.actions {*/
                /*margin-left: 2%;*/
                /*}*/

                .top {
                    display: inline-flex;
                    display: -webkit-inline-flex;
                    width: 100%;
                    text-align: center;
                    box-sizing: border-box;
                    /*border-bottom: 1px solid var(--divider-color, #c1cad4);*/
                    padding: var(--list-padding, 7px);
                    margin-top: -15px;
                }

                .top grid-selection-popover {
                    float: left;
                    margin-top: -3px;
                    margin-left: -3px;
                }

                .header-button-container {
                    position: relative;
                    float: left;
                }

                paper-checkbox::shadow #checkboxContainer {
                    height: var(--paper-checkbox-size, var(--default-checkbox-size));
                    width: var(--paper-checkbox-size, var(--default-checkbox-size));
                    min-width: var(--paper-checkbox-size, var(--default-checkbox-size));
                }

                paper-checkbox::shadow #checkbox {
                    border: solid 1px;
                    border-color: var(--paper-checkbox-unchecked-color, var(--palette-cloudy-blue));
                    border-radius: var(--default-border-radius);
                    height: var(--paper-checkbox-size, var(--default-checkbox-size));
                    width: var(--paper-checkbox-size, var(--default-checkbox-size));
                }

                paper-checkbox[checked]::shadow #checkbox {
                    background-color: var(--paper-checkbox-checked-color, var(--palette-cerulean-two));
                    border-color: var(--paper-checkbox-checked-color, var(--palette-white));
                }

                paper-checkbox[checked]::shadow #checkmark {
                    width: 20%;
                    height: 50%;
                    -webkit-transform-origin: 60% 110%;
                    -ms-transform-origin: 60% 110%;
                    transform-origin: 60% 110%;
                }

                .actionsPopover {
                    @apply --pebble-actions-popover;
                    --default-popup-t-p: 5px;
                    --default-popup-b-p: 5px;
                }

                pebble-popover paper-item {
                    cursor: pointer;
                    font-size: var(--default-font-size, 14px);
                    min-height: 40px;
                }

                pebble-popover paper-item iron-icon {
                    --iron-icon-width: 18px;
                    --iron-icon-height: 18px;
                }

                pebble-popover paper-item:hover {
                    background-color: #eee;
                    color: var(--palette-cerulean);
                }

                .dropdown-trigger {
                    --pebble-button-iron-icon: {
                        height: 20px;
                        width: 20px;
                        padding: 0 3px 0 3px;
                        color: #7d8690;
                        @apply --pebble-actions-button-icon;
                    }
                    --pebble-button-dropdown-icon: {
                        height: 20px;
                        width: 20px;
                        color: #7d8690;
                        @apply --pebble-actions-button-drop-down-icon;
                    }
                }

                #scrollingRegion {
                    border: 1px solid var(--divider-color, #c1cad4);
                }

                rock-image-viewer {
                    margin-right: 10px;
                }

                .title {
                    font-size: var(--default-font-size, 14px);
                    color: var(--dark-title-color, #1a2028);
                    margin: 3px 0;
                }

                .subtitle {
                    font-size: var(--font-size-sm, 12px);
                    color: var(--secondary-text-color, #727272);
                }

                .details-wrap {
                    width: 30%;
                    margin-right: 15px;
                }

                .status-wrap {
                    width: 30%;
                    margin-right: 15px;
                    color: var(--secondary-text-color, #727272);
                }

                .result-wrap {
                    width: 30%;
                    text-align: right;
                    color: var(--secondary-text-color, #727272);
                }

                .completed {
                    color: var(--success-button-color, #09c021);
                }

                .inprogress {
                    color: var(--warning-button-color, #f78e1e);
                }

                .completed,
                .inprogress,
                .error {
                    font-weight: 500;
                }

                .result-wrap .error {
                    color: var(--error-button-color, #f30440);
                    font-weight: bold;
                }

                .list-content {
                    margin: 3px 0;
                }

                .list-content span {
                    margin: 0;
                }

                a {
                    text-decoration: none;
                }

                iron-list {
                    will-change: normal;
                    --iron-list-items-container: {
                        width: inherit;
                    }
                }

                .text-ellipsis {
                    width: 100%;
                }

                #gridSelectionPopover {
                    cursor: pointer;
                    --popover-position: {
                        margin-top: -3px;
                        margin-left: 3px;
                    }
                }
            </style>
        </custom-style>
        <div class="top">
            <check-box-with-indeterminate-state hidden="[[!multiSelection]]" header class="header-button-container" on-tap="_toggleSelectAll"
                checked="[[_isSelectAllChecked(selectedItems.length, selectedItems.inverted, items.length)]]" indeterminate="[[_isSelectAllIndeterminate(selectedItems.length, items.length)]]"></check-box-with-indeterminate-state>
            <!--<span class="actions">Actions</span>-->
            <template is="dom-if" if="[[advanceSelectionEnabled]]">
                <grid-selection-popover selection-options="[[advanceSelectionOptions]]" id="gridSelectionPopover" on-selection-changed="_onPopoverSelectionChange"></grid-selection-popover>
            </template>
        </div>
        <div id="scrollingRegion">
            <iron-list id="list" items="{{items}}" as="item" scroll-target="html" selection-enabled>
                <template>
                    <div class="container" on-tap="_tapEvent">
                        <div class="left" hidden="![[multiSelection]]">
                            <paper-checkbox class="button-container" checked="[[_isSelected(item, selectedItems, selectedItems.*)]]"></paper-checkbox>
                        </div>
                        <rock-image-viewer alt="Product image." id="image-container" sizing="contain" src="{{_computeImage(item,listItems.image)}}"
                            thumbnail-id="{{_computeValue(item,listItems.thumbnailId)}}">
                        </rock-image-viewer>
                        <div class="details-wrap">
                            <div class="title text-ellipsis">
                                <template is="dom-if" if="[[_hasLinkTemplate(listItems)]]">
                                    <a href$="[[_getLink(item)]]" title="[[_computeTitle(item,listItems.title)]]">[[_computeTitle(item,listItems.title)]]</a>
                                </template>
                                <template is="dom-if" if="[[!_hasLinkTemplate(listItems)]]">
                                    <span title="[[_computeTitle(item,listItems.title)]]">[[_computeTitle(item,listItems.title)]]</span>
                                </template>
                            </div>
                            <div class="list-content subtitle">[[_computeSubtitle(item,listItems.subtitle)]]</div>

                            <template is="dom-repeat" items="{{_firstColFields}}" as="field">
                                <div class="list-content">
                                    <span class$="{{_computeClass(field.noTrim)}}">{{_getDisplayName(field.label)}}
                                        <template is="dom-if" if="[[_hasLinkTemplate(field)]]">
                                            <a class="block-text firstCol{{index}}" href$="[[_getLink(item,field.linkTemplate)]]">[[_computeValue(item,field.name)]]</a>
                                        </template>
                                        <template is="dom-if" if="[[!_hasLinkTemplate(field)]]">
                                             <span class="block-text firstCol{{index}}">[[_computeValue(item,field.name)]]</span>
                            </template>
                            </span>
                            </div>
                </template>
                </div>
                <div class="status-wrap">
                    <template is="dom-repeat" items="{{_secColFields}}" as="field">
                        <div class="list-content">
                            <span class$="{{_computeClass(field.noTrim)}}">{{_getDisplayName(field.label)}}
                                        <template is="dom-if" if="[[_hasLinkTemplate(field)]]">
                                            <a class$="subtitle secondCol{{index}}" href$="[[_getLink(item,field.linkTemplate)]]">[[_computeValue(item,field.name)]]</a>
                                        </template>
                                        <template is="dom-if" if="[[!_hasLinkTemplate(field)]]">
                                            <span class$="subtitle secondCol{{index}}">[[_computeValue(item,field.name)]]</span>
                    </template>
                    </span>
                    </div>
    </template>
    </div>
    <div class="result-wrap">
        <template is="dom-repeat" items="{{_thirdColFields}}" as="field">
            <div class="list-content text-ellipsis">
                <span class$="{{_computeClass(field.noTrim)}}" title="{{_getDisplayName(field.label)}}">{{_getDisplayName(field.label)}}
                                        <template is="dom-if" if="[[_hasLinkTemplate(field)]]">
                                            <a class$="block-text thirdCol{{index}}" href$="[[_getLink(item,field.linkTemplate)]]" title="[[_computeValue(item,field.name)]]">[[_computeValue(item,field.name)]]</a>
                                        </template>
                                        <template is="dom-if" if="[[!_hasLinkTemplate(field)]]">
                                            <span class$="block-text thirdCol{{index}}" title="[[_computeValue(item,field.name)]]">[[_computeValue(item,field.name)]]</span>
        </template>
        </span>
        </div>

        </template>
    </div>
    <template is="dom-if" if="[[_actionsPresent]]">
        <div class="right">
            <paper-icon-button id="actions_container_{{item.id}}" class="dropdown-trigger tooltip-bottom pebble-md-icons" name="more"
                icon="pebble-md-icons:MoreVert" data-tooltip="More options" on-tap="_onActionsTap"></paper-icon-button>
            <pebble-popover id$="action_list_{{item.id}}" class="actionsPopover" for="actions_container_{{item.id}}" auto-fit-on-attach
                no-overlap horizontal-align="right">
                <template is="dom-repeat" items="[[actions]]" as="action">
                    <paper-item on-tap="_onActionItemTap" action="[[action]]" item="[[item]]" class="tooltip-bottom" data-tooltip$="[[action.tooltip]]">
                        <div>
                            <template is="dom-if" if="[[action.icon]]">
                                <iron-icon icon="[[action.icon]]"></iron-icon>
                            </template>
                        </div>
                        <div>
                            <template is="dom-if" if="[[action.text]]">
                                [[action.text]]
                            </template>
                        </div>
                    </paper-item>
                </template>
            </pebble-popover>
        </div>
    </template>
    </div>
    </template>
    </iron-list>
    <div class="loadingIndicator">
        <pebble-spinner active="[[loading]]"></pebble-spinner>
    </div>
    <iron-scroll-threshold id="scrollTheshold" on-lower-threshold="_loadMoreData" scroll-target="scrollingRegion">
    </iron-scroll-threshold>
    </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'grid-list-view',
                properties: {
                    /**
                     * Indicates an array of items that needs the display in the `grid-list-view`.
                     */
                    items: {
                        type: Array,
                        value: [],
                        notify: true,
                        observer: '_itemsChanged'
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i>
                      */
                    dataSource: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },

                    /**
                     * Indicates the current page in the `grid-list-view`.
                     */
                    page: {
                        type: Number,
                        value: 0,
                        notify: true
                    },

                    /**
                     * Indicates the page size in the `grid-list-view`.
                     */
                    pageSize: {
                        type: Number,
                        value: 10,
                        notify: true
                    },

                    /**
                     * Specifies whether or not to load the data. Set it to <b>true</b> to load the data
                     * Otherwise, set it to <b>false</b>.
                     */
                    loading: {
                        type: Boolean,
                        value: false
                    },

                    advanceSelectionEnabled: {
                        type: Boolean,
                        value: true
                    },
                    advanceSelectionOptions: {
                        type: Array,
                        value: function () {
                            return [];
                        }

                    },
                    /**
                     * Specifies whether or not multiple items are selected at once. When it is <b>true</b>, multiple items are selected at once.
                     * Otherwise, only one item is selected at a time.
                     */
                    multiSelection: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    /**
                     * Specifies whether or not it contains the selected items. When it is <b>true</b>, this array contains the selected items. 
                     * If `selectedItems.inverted` is <b>true</b>, the array contains deselected items.
                     */
                    selectedItems: {
                        type: Array,
                        value: [],
                        notify: true
                    },

                    /**
                     * Indicates the currently selected item if the `multiSelection` is set to <b>false</b>. 
                     * It is set to "null" when no items are selected.
                     */
                    selectedItem: {
                        type: Object,
                        //value : {},
                        notify: true,
                        reflectToAttribute: true
                    },

                    /**
                     * Specifies whether or not the tapping a row selects the item.
                     * The selection of the item places its data model in the set of selected items. 
                     * This is retrievable via the selection property.
                     */
                    selectionEnabled: {
                        type: Boolean,
                        value: false,
                        notify: true,
                        reflectToAttribute: true
                    },

                    /**
                     * Indicates the list items of the `grid-list-view`.
                     */
                    listItems: {
                        type: Object,
                        observer: '_splitIntoCols'
                    },

                    /**
                     * This is an internal property, represents fields to be displayed in first column of grid-list-view.
                     */
                    _firstColFields: {
                        type: Array,
                        value: []
                    },
                    /**
                     * This is an internal property, represents fields to be displayed in second column of grid-list-view.
                     */
                    _secColFields: {
                        type: Array,
                        value: []
                    },

                    /**
                     * This is an internal property, represents fields to be displayed in third column of grid-list-view.
                     */
                    _thirdColFields: {
                        type: Array,
                        value: []
                    },

                    /**
                     *  Indicates the supported actions in the `grid-list-view`.
                     * */
                    actions: {
                        type: Array,
                        value: []
                    },
                    _actionsPresent: {
                        type: Boolean,
                        computed: '_hasActions(actions)'
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i>
                      */
                    schemaType: {
                        type: String,
                        value: ""
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                observers: [
                    '_pageChanged(dataSource, page)'
                ],
                _scrollToTop: function () {
                    if (this.shadowRoot.querySelector('#scrollingRegion')) {
                        this.shadowRoot.querySelector('#scrollingRegion').scrollTop = 0;
                    }
                },
                _onPopoverSelectionChange: function (e) {
                    this.clearSelection();
                    this._scrollToTop();
                    if (e.detail) {
                        if (e.detail.mode == "count") {
                            var selectionCount = e.detail.itemCount;
                            var items = this.items;
                            var searchSelectedItems
                            if (items.length >= selectionCount) {
                                searchSelectedItems = items.slice(0, selectionCount);
                                searchSelectedItems.forEach(function (value, key) {
                                    if (value) {
                                        this._selectItem(value);
                                    }
                                }.bind(this));
                            } else {
                                this.selectAll();
                            }
                        }
                        if (e.detail.mode == "query") {
                            this.selectAll();
                        }
                        this.set('selectionInfo', e.detail);
                    }
                },
                _loadMoreData: function () {
                    this.page++;
                },
                _hasLinkTemplate: function (field) {
                    return !!field.linkTemplate;
                },
                _getLink: function (item, linkTemplate) {
                    if (!linkTemplate) {
                        linkTemplate = this.listItems.linkTemplate;
                    }
                    return "/" + DataHelper.getTenantId() + "/" + linkTemplate.replace(/\{\S+?\}/g,
                        function (match) {
                            var attrName = match.replace("{", "").replace("}", "");
                            return item[attrName];
                        });
                },
                /**
                  * <b><i>Content development is under progress... </b></i>
                  */
                reloadData: function () {
                    this.items = [];
                    this.page = 0;
                    this.page = 1;
                },
                _hasActions: function (actions) {
                    return actions && actions.length;
                },
                _selectedItemsChanged: function () {
                    this.logInfo("Constants", "value", this.selectedItems);
                },

                /**
                 * This is an internal function, used to split the fields into three columns.
                 */
                _splitIntoCols: function () {
                    if (this.listItems && this.listItems.fields && this.listItems.fields.length > 0) {
                        var totalFields = this.listItems.fields.length;
                        var n = totalFields / 3 + 1;
                        if (totalFields < 3) {
                            this._secColFields = this.listItems.fields.slice(0, 1);
                            this._thirdColFields = this.listItems.fields.slice(1, totalFields);
                        } else if (totalFields == 3) {
                            this._secColFields = this.listItems.fields.slice(0, 2);
                            this._thirdColFields = this.listItems.fields.slice(2, totalFields);
                        } else {
                            if (totalFields % 3 == 0) {
                                this._firstColFields = this.listItems.fields.slice(0, n - 3);
                                this._secColFields = this.listItems.fields.slice(n - 3, 2 * n - 3);
                                this._thirdColFields = this.listItems.fields.slice(2 * n - 3,
                                    totalFields);
                            } else {
                                this._firstColFields = this.listItems.fields.slice(0, n - 2);
                                this._secColFields = this.listItems.fields.slice(n - 2, 2 * n - 2);
                                this._thirdColFields = this.listItems.fields.slice(2 * n - 2,
                                    totalFields);
                            }
                        }
                    }
                },

                /**
                 * This is an internal function, used to calculate the display name of an attribute.
                 */
                _getDisplayName: function (label) {
                    if (label) {
                        return label + ": ";
                    }
                },

                /**
                 * This is an internal function, used to calculate the class to apply trim or not.
                 */
                _computeClass: function (noTrim) {
                    if (noTrim) {
                        return 'default';
                    }
                    return 'default trim';
                },

                /**
                 * This is an internal function, returns true if number of fields to display is greater than 4.
                 */
                _areFieldsGreaterThan4: function (fields) {
                    if (fields && fields.length > 4) {
                        return true;
                    }
                    return false;
                },
                resetAdvanceSelection: function () {
                    this._resetAdvanceSelection();
                },
                _resetAdvanceSelection: function () {
                    var getGridSelectionPopover = this.shadowRoot.querySelector("#gridSelectionPopover");
                    if (getGridSelectionPopover && getGridSelectionPopover.resetSelection) {
                        getGridSelectionPopover.resetSelection();
                        this.set('selectionInfo','{}');
                    }
                },

                /**
                 * This is an internal function to handle the tap event. It fires event 'deselecting-item' if an item was already selected.
                 *  It fires event 'selecting-item' if an item was not selected. The data of the event fired is the data of the item.
                 */
                _tapEvent: function (e) {
                    this._resetAdvanceSelection();
                    if (this._isSelected(e.model.item, this.selectedItems)) {
                        this._fireEvent('deselecting-item', e.model.item, this.deselectItem);
                    } else {
                        this._fireEvent('selecting-item', e.model.item, this.selectItem);
                    }
                },

                /**
                 * This is an internal function, used to compute the image url based on the config.
                 */
                _computeImage: function (item, image) {
                    return item[image];
                },

                /**
                 * This is an internal function, used to compute the title based on the config.
                 */
                _computeTitle: function (item, title) {
                    if (this.schemaType == "attribute") {
                        if (item.attributes && item.attributes.hasOwnProperty(title)) {
                            return item.attributes[title].value;
                        }
                    }
                    return item[title];
                },
                /**
                 * This is an internal function, used to compute the id based on the config.
                 */
                _computeSubtitle: function (item, subtitle) {
                    if (this.schemaType == "attribute") {
                        if (item.attributes && item.attributes.hasOwnProperty(subtitle)) {
                            return item.attributes[subtitle].value;
                        }
                    }
                    return item[subtitle];
                },

                /**
                 * This is an internal function, used to compute the value of the attribute to be displayed.
                 */
                _computeValue: function (item, field) {
                    if (this.schemaType == "attribute") {
                        if (item.attributes && item.attributes.hasOwnProperty(field)) {
                            return item.attributes[field].value;
                        }
                    }
                    return item[field];
                },


                _setSelectedItem: function (item) {
                    this.set('selectedItem', item);
                },

                _setSelectedItems: function (items) {
                    this.set('selectedItems', items);
                },

                /**
                 * Can be used to select the list item at the given index.
                 *
                 * @method selectItem
                 * @param {(Object|number)} item The item object or its index
                 */
                selectItem: function (item) {
                    if (this.advanceSelectionEnabled == true) {
                        this._resetAdvanceSelection();
                    }
                    if (typeof item === 'number' && item >= 0 && this.items && this.items.length > item) {
                        this._selectItem(this.items[item]);
                    } else {
                        this._selectItem(item);
                    }
                },
                _selectItem: function (item) {
                    this._setSelectedItem(item);
                    if (this.multiSelection) {
                        if (this.selectedItems.inverted) {
                            var index;
                            if ((index = this.selectedItems.indexOf(item)) > -1) {
                                this.splice('selectedItems', index, 1);
                            }
                        } else {
                            this.push('selectedItems', item);
                        }
                    } else {
                        this.splice('selectedItems', 0, this.selectedItems.length, item);
                    }
                },
                /**
                 * Can be used to deselect the given item list if it is already selected.
                 *
                 * @method deselect
                 * @param {(Object|number)} item The item object or its index
                 */
                deselectItem: function (item) {
                    if (this.advanceSelectionEnabled == true) {
                        this._resetAdvanceSelection();
                    }
                    if (typeof item === 'number' && item >= 0 && this.items && this.items.length > item) {
                        this._deselectItem(this.items[item]);
                    } else {
                        this._deselectItem(item);
                    }
                },
                _deselectItem: function (item) {
                    this._setSelectedItem(null);
                    var index = this.selectedItems.indexOf(item);
                    if (this.selectedItems.inverted) {
                        if (index === -1) {
                            this.push('selectedItems', item);
                        }
                    } else {
                        if (index > -1) {
                            this.splice('selectedItems', index, 1);
                        }
                    }
                },
                _isSelected: function (item, selectedItems) {
                    var selected = selectedItems.indexOf(item) > -1;
                    return selectedItems.inverted ? !selected : selected;
                },
                /*
                 * Can be used to select all the items in the list.
                 */
                selectAll: function () {
                    var length = this.selectedItems.length;
                    this.splice('selectedItems', 0, length);
                    this.set('selectedItems.inverted', true);
                },
                /**
                 * Can be used to clear the current selection state.
                 */
                clearSelection: function () {
                    var length = this.selectedItems.length;
                    this.splice('selectedItems', 0, length);
                    this.set('selectedItems.inverted', false);
                    if (this.selectedItem !== undefined) {
                        this._setSelectedItem(null);
                    }
                },

                _fireEvent: function (eventName, item, defaultAction) {
                    var e = this.dispatchEvent(new CustomEvent(eventName, {
                        item: item
                    }, {
                            cancelable: true,
                            composed:true
                        }));
                    if (!e.defaultPrevented) {
                        defaultAction.call(this, item);
                    }
                },

                _toggleSelectAll: function () {
                    this._resetAdvanceSelection();
                    if (this._isSelectAllChecked(this.selectedItems.length, this.selectedItems.inverted,
                        this.items.length)) {
                        this._fireEvent("deselecting-all-items", {
                            items: this.selectedItems
                        }, this.clearSelection);
                    } else {
                        this._fireEvent("selecting-all-items", {
                            items: this.selectedItems
                        }, this.selectAll);
                    }
                },
                _isSelectAllChecked: function (selectedItemsLength, inverted, size) {
                    return size > 0 && selectedItemsLength === (inverted ? 0 : size);
                },
                _isSelectAllIndeterminate: function (length, size) {
                    return size > 0 && length > 0 && length < size;
                },
                _onActionsTap: function (e) {
                    var id = 'action_list_' + e.model.item.id;
                    this.shadowRoot.querySelector('#' + id).show();
                },
                _onActionItemTap: function (e) {
                    var action = e.model.action;
                    var eventName = action.eventName;
                    if (!eventName) {
                        if (action.name == 'delete') {
                            eventName = "grid-delete-item";
                        } else if (action.name == 'edit') {
                            eventName = "grid-edit-item";
                        }
                    }
                    ComponentHelper.getComponentContainer(this).fireBedrockEvent(eventName, e.model.item);
                    var id = 'action_list_' + e.model.item.id;
                    this.shadowRoot.querySelector('#' + id).hide();
                },
                _visibleItemsCount: function () {
                    var firstItemIndex = this.$.list._physicalStart;
                    var firstItemHeight = this.$.list._physicalSizes[firstItemIndex];
                    var viewportHeight = this.$.list._viewportHeight || this.$.list._viewportSize;
                    if (firstItemHeight && viewportHeight) {
                        var visibleItems = (viewportHeight - this._viewportTotalPadding) /
                            firstItemHeight;
                        return Math.floor(visibleItems);
                    }
                },
                _lastVisibleIndex: function () {
                    if (this._visibleItemsCount()) {
                        return this.$.list.firstVisibleIndex + this._visibleItemsCount() - 1;
                    }
                },
                _pageChanged: function (dataSource, currentPage) {
                    if (typeof (dataSource) == 'function' && currentPage > 0) {
                        this.loading = true;
                        var success = this._success.bind(this);
                        var error = this._error.bind(this);
                        dataSource({
                            page: this.page,
                            pageSize: this.pageSize,
                            sortOrder: this.sortOrder,
                            "viewMode": "List"
                        }, success, error);
                    }
                },
                _success: function (data) {
                    if (data.length > 0) {
                        var lastVisibleIndex = this._lastVisibleIndex();
                        for (var i = 0; i < data.length; i++) {
                            this.push('items', data[i]);
                        }
                        this.$.list.scrollToIndex(lastVisibleIndex);
                        this.$.scrollTheshold.clearTriggers();
                    } else {
                        this.page = -1; // Future Enhancement
                    }
                    this.loading = false;
                },
                _error: function () {
                    this.loading = false;
                },
                /**
                  * <b><i>Content development is under progress... </b></i>
                  */
                notifyResize: function () {
                    var list = this.shadowRoot.querySelector("iron-list");
                    if (list) {
                        list.notifyResize();
                    }
                },
                _itemsChanged: function (items) {
                    if (items && items.length) {
                        setTimeout(() =>{
                            this.notifyResize();
                        }, 3000);
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i>
                  */
                scrollToIndex: function (index) {
                    var list = this.$.list;
                    if (list) {
                        list.scrollToIndex(index);
                    }
                }
            });
        })();
    </script>
</dom-module>