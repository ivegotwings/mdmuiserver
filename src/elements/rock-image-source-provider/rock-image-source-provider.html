<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">
<!--
`rock-image-source-provider` Represents an element that provides src for an image.


@group rock Elements
@element rock-image-source-provider
-->

<dom-module id="rock-image-source-provider">
    <template>
        <!--<liquid-rest id="getThumbnail" url="/data/pass-through/binaryobjectservice/get" method="POST">-->
        <!--</liquid-rest>-->
    </template>

    <script>
        Polymer({
            is: 'rock-image-source-provider',

            properties: {
                noThumbnailImagePath:{
                    type:String,
                    value:"/src/images/no-thumbnail.svg"
                },
                loadingThumbnailPath: {
                    type: String,
                    value: "/src/images/loading-thumbnail.svg"
                },
                imageSource:{
                    type:Object,
                    value: function () {
                        return {}
                    },
                    notify: true
                }
            },
            ready:function () {
                this.imageSource=this._imageSource.bind(this);
            },
            _imageSource:function (data) {
                if(data && data.target) {
                   if (data.imageId) {
                        this._generateGetThumbnailRequest(data);
                    } else {
                       data.target.set("src",this.noThumbnailImagePath);
                   }
                }
            },
            _generateGetThumbnailRequest:function (data) {
                var target=data.target;
                var imageId=data.imageId;
                var liquidElement = document.createElement("liquid-rest");
                liquidElement.url="/data/pass-through/binaryobjectservice/get";
                liquidElement.method="POST";
                liquidElement.id="liquid"+target.id;
                DataHelper.oneTimeEvent(liquidElement, 'liquid-response', this._onGetThumbnailResponse.bind(
                    this,target));
                if(imageId) {
                    target.set("src",this.loadingThumbnailPath);
                    var req = {
                        "params": {
                            "query": {
                                "id": imageId,
                                "filters": {}
                            },
                            "fields": {}
                        }
                    };
                    req.params.query.filters.typesCriterion = ["imagerendition"];
                    req.params.fields.attributes = ["blob"];
                    liquidElement.requestData = req;
                    this.shadowRoot.appendChild(liquidElement);
                    liquidElement.generateRequest();

                } else {
                    target.set("src",this.noThumbnailImagePath);
                }
            },
            _onGetThumbnailResponse:function (target,e) {
                var thumbnail;
                if (e.detail && e.detail.response && e.detail.response.response) {
                    var response = e.detail.response.response;
                    if (response.status.toLowerCase() == "success") {
                        var binaryObjects=response.binaryObjects;
                        if(binaryObjects) {
                            var binaryObject=binaryObjects[0];
                            if (binaryObject.data) {
                                thumbnail= binaryObject.data.blob;
                                if(target.imageId != binaryObject.id){
                                    return;
                                }
                            }
                        }
                    }
                    if(thumbnail) {
                        // decode the base64 and find the mime type. This is needed to display image/svg+xml images
                        var c = Base64.decode(thumbnail);

                        if (63039 == c.charCodeAt(0)) {
                            e = "image/jpeg";
                        }
                        else if (37902 == c.charCodeAt(0)) {
                            e = "image/png";
                        }
                        else if (0 == c.indexOf("GIF")) {
                            e = "image/gif";
                        }
                        else if (0 == c.indexOf("BM")) {
                            e = "image/bmp", a = ".bmp";
                        }
                        else if (0 < c.indexOf("\x3csvg")) {
                            e = "image/svg+xml";
                        }
                        else {
                            e = "image";
                        }

                        var imgSrc = "data:" + e + ";base64," + thumbnail;
                        target.set("src", imgSrc);
                    } else {
                        target.set("src",this.noThumbnailImagePath);
                    }
                }
            }
        });
    </script>
</dom-module>
