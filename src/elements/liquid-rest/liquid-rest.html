<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../liquid-base-behavior/liquid-base-behavior.html">

<dom-module id="liquid-rest">
    <template>
        <iron-ajax url="[[url]]" params="[[params]]" method="[[method]]" headers="[[headers]]" content-type="[[contentType]]" body=[[requestData]]
            handle-as="json" auto="[[auto]]" verbose="[[verbose]]" last-request="{{lastRequest}}" loading="{{loading}}" last-response="{{lastResponse}}"
            last-error="{{lastError}}" active-requests="{{activeRequests}}" debounce-duration="{{debounceDuration}}"
            on-request="_onRequest" on-response="_onResponse" on-error="_onError"></iron-ajax>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-rest',
                behaviors: [RUFBehaviors.LiquidBaseBehavior],
                attached: function () {
                },
                ready: function () {
                },
                properties: {
                    /**
                     * Indicates the URL target of the request.
                     */
                    url: {
                        type: String
                    },

                    /**
                     * Indicates an object that contains query parameters which are appended to the
                     * specified `url` when generating a request. If you wish to set the body
                     * content when making a POST request, you must use the `request-data` property
                     * instead.
                     */
                    params: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * Indicates the HTTP method to use such as 'GET', 'POST', 'PUT', or 'DELETE'.
                     * Default is 'GET'.
                     */
                    method: {
                        type: String,
                        value: 'GET'
                    },

                    /**
                     * Indicates the HTTP request headers to send.
                     *
                     * Example:
                     *
                     *     <iron-ajax
                     *         auto
                     *         url="http://somesite.com"
                     *         headers='{"X-Requested-With": "XMLHttpRequest"}'
                     *         handle-as="json"></iron-ajax>
                     *
                     * Note: setting a `Content-Type` header here will override the value
                     * specified by the `contentType` property of this element.
                     */
                    headers: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the content type to use when sending the data. If the `contentType` property
                     * is set and a `Content-Type` header is specified in the `headers`
                     * property, the `headers` property value takes precedence.
                     *
                     * It varies the handling of the `body` param.
                     */
                    contentType: {
                        type: String,
                        value: "application/json"
                    }
                },
                /**
                 * Can be used to generate the requests.
                 * 
                 */
                generateRequest: function () {
                    //console.log('generateRequest requestData', this.requestData);

                    if(this.$$('iron-ajax').headers) {
                        this.$$('iron-ajax').headers['tid'] = DataHelper.getTenantId();
                    } else {
                        this.$$('iron-ajax').headers = {'tid': DataHelper.getTenantId()};
                    }
                    this.$$('iron-ajax').generateRequest();
                },
                _onRequest: function (e) {
                    var eventDetail = {
                        "request": { "requestData": this.requestData }
                    };
                    //console.log('_onRequest request', request);
                    this.fire('request', eventDetail, { bubbles: this.bubbles });
                    this.fire('liquid-request', eventDetail, { bubbles: this.bubbles });
                    this.cancelBubble = true;
                },
                _onResponse: function (e) {
                    var eventDetail = {
                        "request": {
                            "requestData": this.requestData
                        },
                        "response": e.detail.response
                    };
                    this.fire('liquid-response', eventDetail, { bubbles: this.bubbles });
                    this.fire('response', eventDetail, { bubbles: this.bubbles });
                    this.cancelBubble = true;
                },
                _onError: function (e) {
                    this.fire('liquid-error', e, { bubbles: this.bubbles });
                    this.fire('error', e, { bubbles: this.bubbles });
                    this.cancelBubble = true;
                }
            });
        })();
    </script>
</dom-module>