<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../pebble-grid/demo/demo-grid-element.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html" />
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../rock-search-filter/rock-search-filter.html" />
<link rel="import" href="../rock-saved-searches/rock-saved-searches.html" />

<dom-module id="app-entity-discovery">
  <template>
    <style include="pebble-styles-shared"></style>
    <style include="iron-flex"></style>
    <style is="custom-style">
      #savedSearch {
        --pebble-button: {
          height: 40px;
          padding: 1em 0em 1em 0.3em;
          color: #2068BD;
          border: 1px solid #2068BD;
          font-size: small;
          top: -7px;
        }
        --pebble-button-iron-icon: {
          height: 24px;
          width: 24px;
          top: 5px;
        }
        --pebble-button-dropdown-icon: {
          height: 20px;
          width: 20px;
        }
      }
      
      #actions {
        --pebble-button: {
          height: 40px;
          padding: 1em 0em 1em 0.2em;
          top: -5px;
          color: #212121;
          border: 1px solid #C1CAD4;
          font-size: small;
          margin-left: -3px;
        }
        --pebble-button-iron-icon: {
          height: 20px;
          width: 20px ;
          top: 5px;
          padding:0 3px 0 3px;
          color: #7d8690;
        }
        --pebble-button-dropdown-icon: {
          height: 20px;
          width: 20px;
          color: #7d8690;
        }
      }
      
      rock-search-bar {
        display: inline-flex;
        width: 75%;
        padding: 0 3px 0 8px;
      }
      
      rock-search-filter::shadow paper-menu-button {
        padding: 4px;
      }
      rock-dimension-selector {
        --dimesion-selector-catalog-dropdown: {
          width: 80px;
        }
        ;
        --dimesion-selector-source-dropdown: {
          width: 55px;
        }
        ;
        --dimesion-selector-date-dropdown: {
          width: 60px;
        }
        ;
        --dimesion-selector-locale-dropdown: {
          width: 65px;
        }
        ;
      }
      #dimensionContainer {
        align-self: center;
        margin-bottom: 20px;
        width: 100%;
        /*line-height: 20px;*/
      }
      
      pebble-vertical-divider {
        --pebble-vertical-divider-color: var(--divider-color);
        min-width: 0px;
        margin: 10px 5px;
        min-height: 18px;
      }
      
      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: #ccc;
      }

      #savedSearchPopover {
        margin-top: -3px;
        width: 500px;
      }

      #actionsPopover {
        margin-top: 3px;
      }
      
      rock-search-filter::shadow paper-menu-button paper-menu {
        background: #ffffff;
      }

      rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
        font-weight: normal;
      }

      :root {
        --pebble-popover-max-width: 100%;
      }
      
      pebble-popover paper-item {
        cursor: pointer;
        font-size: 14px;
        padding: 0 0 0 0;
        min-height: 40px;
      }

      pebble-popover paper-item iron-icon {
        --iron-icon-width: 18px;
        --iron-icon-height: 18px;
          color: #ffffff;
      }

       #newSavedSearch {
        color: #036BC3;
        font-size: 16px;
      }

      .addSavedSearchIcon {
        color: #036BC3;
        height: 20px;
        width: 20px;
        top: -2px;
      }
      
      .badge {
        @apply(--layout);
        @apply(--layout-center-center);
        @apply(--paper-font-common-base);
        font-weight: normal;
        font-size: 11px;
        */ border-radius: 50%;
        margin-right: 10px;
        width: 25px;
        height: 25px;
        background-color: #36B44A;
        opacity: 1.0;
        color: white;
      }

      .marginTop1 {
        margin-top: 1px;
      }

      .marginTop12 {
        margin-top: 12px;
      }

      .marginBottom5 {
        margin-bottom: 5px;
      }

      .marginLeft-9 {
        margin-left: -9px;
      }

      .searchFilterTag {
        margin: -9px 0 0 3px;
        padding-top: 1px;
      }

      .savedSearchLabel {
        color: black;
        font-weight: bold;
        font-size: 16px;
      }
      
      pebble-popover pebble-button::shadow paper-button{
          font-size: 14px;
          color: #036BC3;
      } 

      pebble-popover pebble-button::shadow paper-button iron-icon{
          height: 16px !important;
          width: 16px !important;
          color: #036BC3 !important;
      }

      #createSavedSearchPopover {
        min-width: 30%;
      }
    </style>
<rock-layout>
  <rock-titlebar icon="search" title="Entity Search & Discovery" closable minimizable>
    <div id="dimensionContainer" align="right">
      <iron-ajax auto url="../../data/EntitySearchApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
      <rock-dimension-selector config-data="{{dimensionData}}"></rock-dimension-selector>
      <bedrock-pubsub on-bedrock-event-dimension-selector-catalog="onCatalogChange"></bedrock-pubsub>
      <bedrock-pubsub on-bedrock-event-dimension-selector-source="onSourceChange"></bedrock-pubsub>
      <bedrock-pubsub on-bedrock-event-dimension-selector-locale="onLocaleChange"></bedrock-pubsub>
    </div>
    <pebble-vertical-divider></pebble-vertical-divider>
  </rock-titlebar>
  <rock-header>
    <div class="fixed-content">
      <div class="layout horizontal marginBottom5">
        <div class="flex">
          <!-- search bar-->
          <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
        </div>
        <div class="marginTop12">
          <!-- Saved Search button & its popover-->
          <pebble-button id="savedSearch" icon="pebble-icons:SavedSearch" button-text="Load Saved Search" noink raised elevation="2"
            dropdown-icon on-tap="_onSavedSearchTap"></pebble-button>
          <pebble-popover id="savedSearchPopover" for="savedSearch" auto-fit-on-attach no-overlap horizontal-align="right">
            <div id="newSavedSearch">
                <div class="savedSearchLabel">Saved Searches</div>                  
                <pebble-button id="createEditSavedSearch" icon="icons:add" button-text="Create or Edit Saved Search" noink 
                  class="marginLeft-9" on-tap="_onCreateEditSavedSearchTap"></pebble-button>
                <pebble-horizontal-divider></pebble-horizontal-divider>
            </div>
            <div id="rockSavedSearch">
                <rock-saved-searches></rock-saved-searches>
                <bedrock-pubsub on-bedrock-event-rock-saved-search="_loadSavedSearch"></bedrock-pubsub>
            </div>
          </pebble-popover>
          <pebble-popover id="createEditSavedSearchPopover" for="createEditSavedSearch" auto-fit-on-attach no-overlap horizontal-align="right">
              <div>
                <rock-saved-searches id="rockNewSavedSearch" edit-mode></rock-saved-searches>
              </div>
          </pebble-popover>
          <bedrock-pubsub on-bedrock-event-create-savedsearch-save="onCreateEditSavedSearch"></bedrock-pubsub>
        </div>
      </div>
      <div class="layout horizontal marginBottom5">
        <div class="flex searchFilterTag">
          <!-- Search Filter Tags -->
          <iron-ajax auto url="../../data/EntitySearchApp/searchFilters.json" handle-as="json" last-response="{{searchFilters}}"></iron-ajax>
          <rock-search-filter id="search-filter" icon="pebble-icons:FilterList" text="Refine More" filters="{{searchFilters}}" hide-search-trigger></rock-search-filter>
          <bedrock-pubsub on-bedrock-event-tag-value-change="onSearchTagValueChange"></bedrock-pubsub>
        </div>

        <div>
          <!-- Actions buttons and its popover -->
          <iron-ajax auto url="../../data/EntitySearchApp/actionsData.json" handle-as="json" last-response="{{actionsData}}"></iron-ajax>
          <pebble-button id="actions" icon="pebble-icons:Done" button-text="Actions" noink raised elevation="2" dropdown-icon on-tap="_onActionsTap"></pebble-button>
          <pebble-popover id="actionsPopover" for="actions" auto-fit-on-attach no-overlap horizontal-align="right">
            <template is="dom-repeat" items="[[actionsData]]" as="action">
              <paper-item data="[[action]]" on-tap="_onActionItemTap">
                <div class="badge">
                  <template is="dom-if" if="[[action.icon]]">
                    <iron-icon icon="[[action.icon]]"></iron-icon>
                  </template>
                </div>
                <div id="actionItem">
                  <template is="dom-if" if="[[action.text]]">
                    [[action.text]]
                  </template>
                </div>
              </paper-item>
            </template>
          </pebble-popover>
        </div>
      </div>

    </div>
    <div class="shrunk-content">
    </div>
  </rock-header>
  <iron-ajax auto url="../../data/EntitySearchApp/gridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
  <liquid-entity-get name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
  <liquid-entity-getdata id="initiateSearchResult" log-internal-detail operation="initiatesearch" request="{{request}}" response="{{searchResponse}}"></liquid-entity-getdata>
  <liquid-entity-getdata id="searchResultGetDataService" log-internal-detail operation="getsearchresultdetail" request="{{request}}"
    request-id="[[searchResponse.content.requestId]]" response="{{searchResultResponse}}"></liquid-entity-getdata>

  <pebble-grid id="entityGrid" config="{{gridConfig}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}"
    page-size="100" data="{{searchResultResponse.content.entities}}"></pebble-grid>
  <bedrock-pubsub on-bedrock-event-grid-selecting-item="onSelectingGridItem"></bedrock-pubsub>
</rock-layout>
</template>
attributeModels
<script>
  (function () {
    'use strict';

    Polymer({
      is: 'app-entity-discovery',
      properties: {


        /**
        * Indicates the request object that is passed to the data element to retrive attribute model data.
          Sample: { 
                    action: "getAttributeModels" 
                  }
        */
        attributeModelRequest: {
          type: Object,
          value: function () {
            return { action: "getAttributeModels" };
          }
        },

        request: {
          type: Object,
          value: function () {
            return {
              "data": {
                "query": {
                  "ctx": [
                    {
                      "list": "productMaster",
                      "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                    }
                  ],
                  "valCtx": [
                    {
                      "source": "SAP",
                      "locale": "en-US"
                    }
                  ],
                  "filters": {
                    "attributesCriterion": [],
                    "typesCriterion": ["nart"]
                  }
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": [
                    "cpimProductName",
                    "csapDescriptionOfNart",
                    "csapMaterialStatusGlobal",
                    "cpimSkinType"
                  ],
                  "relationships": ["ALL"]
                }
              }
            };
          }
        },

        /**
        * Indicates the response object that is received from liquid element.
        */
        searchResponse: {
          type: Object,
          value: undefined,
          notify: true
        },

        context: {
          type: Object,
          value: function () {
            return {};
          }
        }

      },
      listeners: {
        'tag-item-remove': '_onTagItemRemove'
      },
      ready: function () {
        this.$$("#searchBar").searchInput = [];

      },
      onCatalogChange: function (e, detail, sender) {
        if (detail != undefined) {
          //alert("event triggered for catalog Changed and current object is: " + JSON.stringify(detail));
        }
      },
      onSourceChange: function (e, detail, sender) {
        if (detail != undefined) {
          //alert("event triggered for source Changed and current object is: " + JSON.stringify(detail));
        }
      },
      onLocaleChange: function (e, detail, sender) {
        if (detail != undefined && detail.text != "en-US") {
          //alert("event triggered for locale Changed and current object is: " + JSON.stringify(detail));
        }
      },
      _onSavedSearchTap: function (e) {
        this.$$('#savedSearchPopover').show();
      },
      _onActionsTap: function (e) {
        this.$$('#actionsPopover').show();
      },
      _onActionItemTap: function (e) {
        var eventDetail = {
          name: e.currentTarget.data.eventName,
          data: e.currentTarget.data
        }
        this.fire('bedrock-event', eventDetail);
        //alert('clicked on: ' + e.currentTarget.data.text);
      },
      _onTagItemRemove: function (e) {
        this.pop('request.data.query.filters.attributesCriterion');
        var req = this.request;
        this.request = undefined;
        this.request = req;
      },
      onSearchTagValueChange: function (e, detail, sender) {
        if (detail != undefined) {

          var condition = { "eq": detail.value };
          var attrCond = {};
          attrCond[detail.name] = condition;
          this.push('request.data.query.filters.attributesCriterion', attrCond);
          var req = this.request;
          this.request = undefined;
          this.request = req;

        }
      },
      onSelectingGridItem: function (e, detail, sender) {
        if (detail) {
          console.log(detail);
          document.querySelector("main-app").set('route.__queryParams', { "id": detail.item.id });
          document.querySelector("main-app").set('route.path', "/entity-manage");

        }
      },
      _onCreateEditSavedSearchTap: function(e) {
          this.$$('#createEditSavedSearchPopover').show();
      },
      onCreateEditSavedSearch: function(e, detail,sender) {
          if(detail){
            alert("data: " + JSON.stringify(detail));
          }
      },
      _loadSavedSearch: function(e, detail, sender){
        if(detail){
          alert("data: " + JSON.stringify(detail));
        }
      }
    });
  })();
</script>

</dom-module>