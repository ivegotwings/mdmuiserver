<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html" />
<link rel="import" href="../rock-layout/rock-layout.html" />
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html" />
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html" />
<link rel="import" href="../rock-layout/rock-header/rock-header.html" />
<link rel="import" href="../rock-entity-search-discovery/rock-entity-search-discovery.html" />
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<dom-module id="app-entity-discovery">
    <template>
        <style include="bedrock-style-common"></style>
        <style include="iron-flex"></style>
        <style>
            :host {
                display: block;
                height: 100%;
            }

            .search-discovery-container {
                padding-top: 20px;
                height: 100%;
            }

            rock-layout {
                --scroller: {
                    overflow-x: hidden;
                    overflow-y: hidden;
                }
            }

            .container-wrapper {
                height: 100%;
            }
        </style>
        <rock-layout>
            <rock-titlebar slot="rock-titlebar" icon="pebble-icon:search-entity" main-title="[[titlebarHeader]]" non-minimizable="[[appConfig.nonMinimizable]]"
                non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" context-data="[[contextData]]" app-name="app-entity-discovery" domain="[[domain]]"
                        all-single-select classification-taxonomy="[[classificationTaxonomy]]" disable-child-node="[[disableChildNode]]"
                        selected-dimensions-detail="{{_selectedDimensions}}"></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <template is="dom-if" if="{{isElementLoaded}}">
                <div class="container-wrapper">
                    <div class="search-discovery-container">
                        <rock-entity-search-discovery domain="[[domain]]" model-domain="[[modelDomain]]" id="entitySearchDiscoveryGrid" context-data="[[contextData]]" selected-dimensions="{{_selectedDimensions}}"
                            allowed-entity-types=[[_allowedEntityTypes]] search-query="[[_searchQuery]]" saved-search-id="[[_savedSearchId]]"
                            workflow-name="[[_workflowName]]" workflow-short-name="[[_workflowShortName]]" workflow-activity-name="[[_workflowActivityName]]"
                            workflow-activity-external-name="[[_workflowActivityExternalName]]" business-condition-name="[[_businessConditionName]]"
                            business-condition-external-name="[[_businessConditionExternalName]]" user="[[_user]]" status="[[_status]]"
                            requested-entity-types="[[_scopedEntityTypes]]" on-load="updateAppCurrentStatus">
                        </rock-entity-search-discovery>
                    </div>
            </template>
        </rock-layout>
        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="dimensionSelector"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-discovery',
                properties: {
                    _selectedDimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    isElementLoaded: {
                        type: Boolean,
                        value: false
                    },
                    domain: {
                        type: String,
                        value: "thing"
                    },
                    modelDomain: {
                        type: String,
                        value: ""
                    },
                    queryParams: {
                        type: String,
                        value: ""
                    },
                    _scopedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    titlebarHeader: {
                        type: String,
                        value: ""
                    },
                    classificationTaxonomy: {
                        type: String,
                        value: ""
                    },
                    disableChildNode: {
                        type: Boolean,
                        value: true
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],

                observers: [
                    "_onContextDataChange(contextData,domain)"
                ],
                ready: function () {
                    var domain = this.getProp('domain');
                    //var domain = DataHelper.getParamValue('domain');
                    if (domain) {
                        this.set("domain", domain);
                    }
                    this._allowedEntityTypes = this.appSetting('dataDefaults').entityTypes[this.domain];
                    // Read query string values
                    var stateData = DataHelper.getStateFromQueryParams(true);
                    this._searchQuery = DataHelper.getParamValue('searchtext');
                    this._savedSearchId = DataHelper.getParamValue('_savedSearchId');
                    this._workflowName = (stateData && stateData.wfName) ? stateData.wfName : DataHelper.getParamValue('wfName');
                    this._workflowShortName = (stateData && stateData.wfShortName) ? stateData.wfShortName : DataHelper.getParamValue('wfShortName');
                    this._workflowActivityName = (stateData && stateData.wfActivityName) ? stateData.wfActivityName : DataHelper.getParamValue('wfActivityName'); 
                    this._workflowActivityExternalName = (stateData && stateData.wfActivityExternalName) ? stateData.wfActivityExternalName : DataHelper.getParamValue('wfActivityExternalName');
                    this._businessConditionName = DataHelper.getParamValue('bcId');
                    this._businessConditionExternalName = DataHelper.getParamValue('bcExternalName');
                    this._user = (stateData && stateData.user) ? stateData.user : DataHelper.getParamValue('user');
                    this._status = DataHelper.getParamValue('status');
                    var mappedEntityTypes = (stateData && stateData.mappedEntityTypesString) ? stateData.mappedEntityTypesString : DataHelper.getParamValue('mappedEntityTypesString');
                    if (stateData) {
                        if(stateData.type){
                            this.push('_scopedEntityTypes', stateData.type);
                        }
                        if(stateData.modelDomain){
                            this.set("modelDomain", stateData.modelDomain);
                        }
                    }
                    if (mappedEntityTypes && mappedEntityTypes !== "") {
                        this._scopedEntityTypes = mappedEntityTypes.split("#@#");
                    }
                },

                _onContextDataChange: function () {
                    if (!_.isEmpty(this.contextData) && this.domain) {
                        var context = DataHelper.cloneObject(this.contextData);
                        //App specific
                        var appName = ComponentHelper.getCurrentActiveAppName();
                        if (appName) {
                            context[ContextHelper.CONTEXT_TYPE_APP] = [{
                                "app": appName
                            }];
                        }
                        context[ContextHelper.CONTEXT_TYPE_DOMAIN] = [{
                            "domain": this.domain
                        }];
                        this.requestConfig('rock-entity-discovery-titlebar', context);
                    }
                },

                get dimensionSelector() {
                    this._dimensionSelector = this._dimensionSelector || this.shadowRoot.querySelector(
                        "#dimensionSelector");
                    return this._dimensionSelector;
                },

                onConfigLoaded: function (componentConfig) {
                    if (componentConfig && componentConfig.config) {
                        this.titlebarHeader = componentConfig.config.title;
                    }
                },
                created: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "ownershipData": this.ownershipData,
                        "tenant": this.tenantId
                    };

                    this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];

                    this.preloadEntityManage();
                },

                preloadEntityManage() {
                    Polymer.RenderStatus.afterNextRender(this, () => {
                        this.importHref(this.resolveUrl(
                                '../app-entity-manage/app-entity-manage.html'), null, null,
                            true)
                    });
                },

                attached: function () {
                    this._searchTimeStamp = new Date().toLocaleString();
                },

                /**
                 * Function to display the left nav info
                 */
                getAppCurrentStatus: function (customArgs) {
                    if (customArgs && customArgs.queryParams) {
                        this.queryParams = customArgs.queryParams;
                    }
                    return {
                        title: "Search & Refine",
                        subTitle: "Last Opened",
                        subTitleValue: this._searchTimeStamp ? this._searchTimeStamp : new Date().toLocaleString(),
                        queryParams: this.queryParams
                    };
                },

                /**
                 *  After the page has loaded, update the title to display on the left nav
                 */
                updateAppCurrentStatus: function (e, customArgs) {
                    var appStatus = this.getAppCurrentStatus();
                    appStatus.title = customArgs.title;
                    var eventData = {
                        name: "appstatusupdated",
                        data: appStatus
                    };
                    this.dispatchEvent(new CustomEvent('bedrock-event', {
                        detail: eventData,
                        bubbles: true,
                        composed: true
                    }));
                },
                _onContextChanged: function (e) {
                    /***TODO: Discuss why we had to reset the whole context data here?
                        In contextData change obesrver, we have only config get request which is solely
                        dependent on app and domain. On dimensions change we don't need to request for config.
                        Hence commenting out.**/
                    // var contextData = this.contextData;
                    // this.contextData = {}; // To notify
                    // this.contextData = contextData;

                    this._searchDiscoveryEl = this._searchDiscoveryEl || this.shadowRoot.querySelector(
                        "#entitySearchDiscoveryGrid");

                    if (this.isElementLoaded && this._searchDiscoveryEl) {
                        this._searchDiscoveryEl.reload();
                    }

                    this.isElementLoaded = true
                },
                _onDimensionsChanged: function (e) {
                    var newDimensions = e.detail.dimensions;
                    newDimensions["app"] = ["app-entity-discovery"];

                    if (this.domain) {
                        newDimensions["domain"] = [this.domain];
                    }
                    if (e.detail.isPrimaryContext != undefined) {
                        this.contextData["isPrimaryContext"] = e.detail.isPrimaryContext;
                    }

                    if (!newDimensions.classification || _.isEmpty(newDimensions.classification[0]) ||
                        !newDimensions.taxonomy || _.isEmpty(newDimensions.taxonomy[0])) {
                        newDimensions["taxonomy"] = [];
                        newDimensions["classification"] = [];
                    } else if (e.detail.taxonomyTitle) {
                        newDimensions["taxonomy"] = [e.detail.taxonomyTitle];
                    }

                    ContextHelper.updateContextData(this.contextData, newDimensions);
                    this._onContextChanged();
                }
            });
        })();
    </script>
</dom-module>