<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../pebble-grid/demo/demo-grid-element.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-search-filter/rock-search-filter.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html" />
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<dom-module id="app-entity-discovery">
  <template>
    <style include="pebble-shared-styles"></style>
    <style include="iron-flex"></style>
    <style is="custom-style">
      #savedSearch {
        --pebble-button: {
          height: 40px;
          padding: 1em 0em 1em 0.3em;
          color: #2068BD;
          border: 1px solid #2068BD;
          font-size: small;
          top: -7px;
        }
        --pebble-button-iron-icon: {
          height: 24px;
          width: 24px;
          top: 5px;
        }
        --pebble-button-dropdown-icon: {
          height: 20px;
          width: 20px;
        }
      }
      
      #actions {
        --pebble-button: {
          height: 40px;
          padding: 1em 0em 1em 0.2em;
          top: -5px;
          color: #212121;
          border: 1px solid #C1CAD4;
          font-size: small;
          margin-left: -3px;
        }
        --pebble-button-iron-icon: {
          height: 20px;
          width: 20px ;
          padding-right: 3px;
          color: #7d8690;
        }
        --pebble-button-dropdown-icon: {
          height: 20px;
          width: 20px;
          color: #7d8690;
        }
      }
      
      rock-search-bar {
        display: inline-flex;
        width: 98%;
        padding: 0 3px 0 8px;
      }
      
      rock-search-filter::shadow paper-menu-button {
        padding: 4px;
      }
      
      #dimensionContainer {
        align-self: center;
        margin-bottom: 17px;
        width: 100%;
      }
      
      pebble-vertical-divider {
        --pebble-vertical-divider-color: black;
        min-width: 0px;
        margin: 5px 0px;
      }
      
      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: #ccc;
      }
      
      #savedSearchPopover {
        margin-top: -3px;
        width: 500px;
      }
      
      #actionsPopover {
        margin-top: 3px;
      }
      
      rock-search-filter::shadow paper-menu-button paper-menu {
        background: #ffffff;
      }
      
      rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
        font-weight: normal;
      }
      
      :root {
        --pebble-popover-max-width: 100%;
      }
      
      pebble-popover paper-item {
        cursor: pointer;
        font-size: 14px;
        padding: 0 0 0 0;
        min-height: 40px;
      }
      
      pebble-popover paper-item iron-icon {
        --iron-icon-width: 18px;
        --iron-icon-height: 18px;
        color: #ffffff;
      }
      
      #newSavedSearch {
        text-align: center;
        color: #036BC3;
        font-size: 20px;
        cursor: pointer;
      }
      
      .addSavedSearchIcon {
        color: #036BC3;
        height: 26px;
        width: 26px;
        top: -2px;
      }
      
      .filterbutton {
        --pebble-button: {
          height: 40px;
          border: 1px solid #D2D7DD;
          border-radius: 3px;
          color: #212121;
          font-weight: normal;
          font-size: small;
          margin: 0px;
          padding: 0 0 0 3px;
          top: -8px;
        }
        --pebble-button-iron-icon: {
          height: 18px !important;
          width: 18px !important;
          color: #7d8690;
          padding: 0 3px 0 0;
        }
        --pebble-button-dropdown-icon: {
          height: 20px;
          width: 20px;
          color: #7d8690;
        }
      }
      
      paper-menu-button {
        padding: 0px 0px 0px 3px;
        top: 8px;
      }
      
      paper-menu-button paper-menu {
        background: #ffffff;
      }
      
      .badge {
        @apply(--layout);
        @apply(--layout-center-center);
        @apply(--paper-font-common-base);
        font-weight: normal;
        font-size: 11px;
        */ border-radius: 50%;
        margin-right: 10px;
        width: 25px;
        height: 25px;
        background-color: #36B44A;
        opacity: 1.0;
        color: white;
      }
      
      .marginTop5 {
        margin-top: 5px;
      }
      
      .marginTop12 {
        margin-top: 12px;
      }
      
      .marginBottom5 {
        margin-bottom: 5px;
      }
      
      .marginLeft3 {
        margin-left: 3px;
      }
    </style>
    <rock-layout>
      <rock-titlebar icon="search" title="Entity Search & Discovery" closable minimizable>
        <div id="dimensionContainer" align="right">
          <iron-ajax auto url="../../data/EntitySearchApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
          <rock-dimension-selector config-data="{{dimensionData}}"></rock-dimension-selector>
          <bedrock-pubsub on-bedrock-event-dimension-selector-catalog="onCatalogChange"></bedrock-pubsub>
          <bedrock-pubsub on-bedrock-event-dimension-selector-source="onSourceChange"></bedrock-pubsub>
          <bedrock-pubsub on-bedrock-event-dimension-selector-locale="onLocaleChange"></bedrock-pubsub>
        </div>
        <pebble-vertical-divider></pebble-vertical-divider>
      </rock-titlebar>
      <rock-header>
        <div class="fixed-content">
          <div class="layout horizontal marginBottom5">
            <div class="marginTop5">
              <!-- Search filter menu -->
              <iron-ajax auto url="../../data/EntitySearchApp/searchFilters.json" handle-as="json" last-response="{{searchFilters}}"></iron-ajax>
              <paper-menu-button horizontal-align="right">
                <pebble-button icon="pebble-icons:filter-list" class="filterbutton dropdown-trigger" button-text="Refine More" dropdown-icon
                  noink raised elevation="2" on-tap="refreshFilter"></pebble-button>
                <paper-menu class="dropdown-content" on-iron-select="_dropdownValueChanged">
                  <template id="filterList" is="dom-repeat" items="{{searchFilters}}" filter="_alreadyAdded">
                    <paper-item>[[item]]</paper-item>
                  </template>
                </paper-menu>
              </paper-menu-button>
            </div>

            <div class="flex">
              <!-- search bar-->
              <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
            </div>

            <div class="marginTop12">
              <!-- Saved Search button & its popover-->
              <pebble-button id="savedSearch" icon="pebble-icons:Icons/SavedSearch" button-text="Load Saved Search" noink raised elevation="2"
                dropdown-icon on-tap="_onSavedSearchTap"></pebble-button>
              <pebble-popover id="savedSearchPopover" for="savedSearch" auto-fit-on-attach no-overlap horizontal-align="right">
                <div id="newSavedSearch">
                  <iron-icon class="addSavedSearchIcon" icon="icons:add"></iron-icon>
                  <span>Create New Saved Search</span>
                  <pebble-horizontal-divider></pebble-horizontal-divider>
                </div>
                <div id="rockSavedSearch">
                  <rock-saved-searches id="rockSavedSearches"></rock-saved-searches>
                </div>
              </pebble-popover>
            </div>
          </div>
          <div class="layout horizontal marginBottom5">
            <div class="flex marginLeft3">
              <!-- Search Filter Tags -->
              <rock-tags id="filterTags" tags="{{tags}}"></rock-tags>
              <bedrock-pubsub on-bedrock-event-tag-value-change="onSearchTagValueChange"></bedrock-pubsub>
            </div>

            <div>
              <!-- Actions buttons and its popover -->
              <iron-ajax auto url="../../data/EntitySearchApp/actionsData.json" handle-as="json" last-response="{{actionsData}}"></iron-ajax>
              <pebble-button id="actions" icon="pebble-icons:Done" button-text="Actions" noink raised elevation="2" dropdown-icon on-tap="_onActionsTap"></pebble-button>
              <pebble-popover id="actionsPopover" for="actions" auto-fit-on-attach no-overlap horizontal-align="right">
                <template is="dom-repeat" items="[[actionsData]]" as="action">
                  <paper-item data="[[action]]" on-tap="_onActionItemTap">
                    <div class="badge">
                      <template is="dom-if" if="[[action.icon]]">
                        <iron-icon icon="[[action.icon]]"></iron-icon>
                      </template>
                    </div>
                    <div id="actionItem">
                      <template is="dom-if" if="[[action.text]]">
                        [[action.text]]
                      </template>
                    </div>
                  </paper-item>
                </template>
              </pebble-popover>
            </div>
          </div>

        </div>
        <div class="shrunk-content">
        </div>
      </rock-header>
      <iron-ajax auto url="../../data/EntitySearchApp/gridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
      <liquid-entity-get name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
      <liquid-entity-getdata id="initiateSearchResult" log-internal-detail operation="initiatesearch" request="{{request}}" response="{{searchResponse}}"></liquid-entity-getdata>
      <liquid-entity-getdata id="searchResultGetDataService" log-internal-detail operation="getsearchresultdetail" request="{{request}}"
        request-id="[[searchResponse.data.requestId]]" response="{{searchResultResponse}}"></liquid-entity-getdata>

      <pebble-grid id="entityGrid" config="{{gridConfig}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}"
        page-size="100" data="{{searchResultResponse.data.entities}}"></pebble-grid>
    </rock-layout>
  </template>
  attributeModels
  <script>
    (function() { 
      'use strict';

      Polymer({
        is: 'app-entity-discovery',
        properties: {

          
          /**
          * Indicates the request object that is passed to the data element to retrive attribute model data.
            Sample: { 
                      action: "getAttributeModels" 
                    }
          */
          attributeModelRequest: {
            type: Object,
            value: function(){
              return { action: "getAttributeModels" };
            }
          },

            request:{
            type: Object,
            value: function(){
              return {
                "data": {
                  "query": {
                    "ctx":[
                      {
                        "list":"fall2016",
                        "classification": "shoes"
                      },
                      {
                        "list":"master",
                        "classification": "shirts"
                      }
                    ],
                    "valCtx":[
                      {
                        "source":"cnet",
                        "locale":"en-US"
                      },
                      {
                        "source":"indix",
                        "locale":"en-US"
                      }
                    ],
                    "id":"e1",
                    "filters":{
                      "attributesCriterion":[],
                      "relationshipsCriterion":[],
                      "typesCriterion":["sku","style"]
                    }
                  },
                  "fields":{
                    "ctxTypes":[
                      "properties"
                    ],
                    "attributes":[
                      "launchDate",
                      "msrp"
                    ],
                    "relationships":["ALL"]
                  },
                  "options":{
                    "totalRecords":10,
                    "includeRequest":false
                  }
                }
              };
            }
          },

          /**
          * Indicates the response object that is received from liquid element.
          */
          searchResponse:{
            type: Object,
            value: undefined,
            notify: true
          },

          context: {
            type: Object,
            value: function(){
              return {};
            }
          }
          
        },
        
        ready: function(){
            this.$$("#searchBar").searchInput = [
            { "name": "Brand", "value": "Levis" },
            { "name": "Color", "value": "Red"   },
            { "name": "Size", "value": "Medium" },
            { "name": "Name", "value": "Extreme"}
            ];

         },
         onCatalogChange: function(e, detail, sender) {
            if(detail != undefined){
              //alert("event triggered for catalog Changed and current object is: " + JSON.stringify(detail));
            }                    
         },
         onSourceChange: function(e, detail, sender) {
            if(detail != undefined){
              //alert("event triggered for source Changed and current object is: " + JSON.stringify(detail));
            }                    
         },
         onLocaleChange: function(e, detail, sender) {
            if(detail != undefined && detail.value != "en_WW"){
              alert("event triggered for locale Changed and current object is: " + JSON.stringify(detail));
            }                    
         },
         _onSavedSearchTap: function(e) {
            this.$$('#savedSearchPopover').show();                   
		     },
         _onActionsTap: function(e) {
            this.$$('#actionsPopover').show();                   
		     },
         _onActionItemTap: function(e){
            var eventDetail= {
              name: e.currentTarget.data.eventName,
              data: e.currentTarget.data
            }      
            this.fire('bedrock-event', eventDetail); 
            alert('clicked on: '+ e.currentTarget.data.text); 
         },
         onSearchTagValueChange: function(e, detail, sender){
            if(detail != undefined){
              alert("event triggered for search tag value changed and current object is: " + JSON.stringify(detail));
            }        
         },
         refreshFilter: function(){
            var list=this.$$("#filterList");
            if(list){
              list.render();
              this.$$('paper-menu').selected=null;
            }
         },
         _dropdownValueChanged: function(e) {
            var attributeName = e.target.selectedItem.innerText;
            var tag = {
              "name": attributeName,
              "value": "",
              "editMode": false
            };
            this.$$("#filterTags").addTag(tag);            
         },
         _alreadyAdded: function(item){
            if (!item){
              return false;
            }
            var tag  = this.tags.filter(function(i){
              return i.name == item;
            });
            if(tag && tag.length>0){
              return false;
            }
            return true;
         }        
      });
    })();
  </script>

</dom-module>