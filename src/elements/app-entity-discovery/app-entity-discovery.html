<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html" />
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html" />
<link rel="import" href="../liquid-rest/liquid-rest.html" />

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html" />

<link rel="import" href="../rock-layout/rock-layout.html" />
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html" />
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html" />
<link rel="import" href="../rock-layout/rock-header/rock-header.html" />
<link rel="import" href="../rock-entity-search-discovery/rock-entity-search-discovery.html" />

<dom-module id="app-entity-discovery">
    <template>
        <style include="bedrock-style-common"></style>
        <style include="iron-flex"></style>
        <style>
            .search-discovery-container {
                margin-top: 20px;
            }

            rock-layout {
                --scroller: {
                    overflow: hidden;
                }
            }
        </style>
        <rock-layout>
            <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-discovery"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <rock-titlebar slot="rock-titlebar" icon="pebble-md-icons:ToolbarSearch" main-title="Entity Search & Refine" non-minimizable="[[appConfig.nonMinimizable]]"
                non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="[[getConfig('rock-dimension-selector')]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <template is="dom-if" if="{{isElementLoaded}}">
                <div class="flex">
                    <div class="flex search-discovery-container">
                        <rock-entity-search-discovery domain="[[domain]]" id="entitySearchDiscoveryGrid" context-data="[[contextData]]" config-data="[[getConfig('rock-entity-search-discovery')]]"
                            selected-dimensions="{{_selectedDimensions}}" allowed-entity-types=[[_allowedEntityTypes]] search-query="[[_searchQuery]]"
                            saved-search-id="[[_savedSearchId]]" workflow-name="[[_workflowName]]" workflow-short-name="[[_workflowShortName]]"
                            workflow-activity-name="[[_workflowActivityName]]" workflow-activity-external-name="[[_workflowActivityExternalName]]"
                            business-condition-name="[[_businessConditionName]]" business-condition-external-name="[[_businessConditionExternalName]]"
                            user="[[_user]]" status="[[_status]]" requested-entity-types="[[_mappedEntityTypes]]">
                        </rock-entity-search-discovery>
                    </div>
                </div>
            </template>
        </rock-layout>
        <bedrock-pubsub event-name="app-context-changed" handler="_onAppContextChanged"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-discovery',
                properties: {
                    _selectedDimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    isElementLoaded: {
                        type: Boolean,
                        value: false
                    },
                    domain: {
                        type: String
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior
                ],

                ready: function () {
                    this._allowedEntityTypes = this.appSetting('allowedEntityTypes');

                    // Read query string values
                    this._searchQuery = DataHelper.getParamValue('searchtext');
                    this._savedSearchId = DataHelper.getParamValue('_savedSearchId');
                    this._workflowName = DataHelper.getParamValue('wfName');
                    this._workflowShortName = DataHelper.getParamValue('wfShortName');
                    this._workflowActivityName = DataHelper.getParamValue('wfActivityName');
                    this._workflowActivityExternalName = DataHelper.getParamValue('wfActivityExternalName');
                    this._businessConditionName = DataHelper.getParamValue('bcId');
                    this._businessConditionExternalName = DataHelper.getParamValue('bcExternalName');
                    this._user = DataHelper.getParamValue('user');
                    this._status = DataHelper.getParamValue('status');
                    var mappedEntityTypes = DataHelper.getParamValue('mappedEntityTypesString');
                    if (mappedEntityTypes && mappedEntityTypes !== "") {
                        this._mappedEntityTypes = mappedEntityTypes.split("#@#");
                    }

                    var dimensionSelector = this.shadowRoot.querySelector("#dimensionSelector");
                    if (dimensionSelector) {
                        this._selectedDimensions = dimensionSelector.selectedDimensions;
                    }
                },

                created: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "ownershipData": this.ownershipData
                    };

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
                },

                attached: function () {
                    var eventName = 'rock-dimension-selector-data-changed-' + this.id;
                    var dimensionSelectors = this.shadowRoot.querySelector("rock-dimension-selector");
                    if (dimensionSelectors) {
                        if (dimensionSelectors.length) {
                            for (var i = 0; i < dimensionSelectors.length; i++) {
                                this.listen(dimensionSelectors[i], eventName, '_onDimensionsChanged');
                            }
                        } else {
                            this.listen(dimensionSelectors, eventName, '_onDimensionsChanged');
                        }
                    }

                    this._searchTimeStamp = new Date().toLocaleString();
                },

                getAppCurrentStatus: function () {
                    var tooltipParams = [];
                    tooltipParams.push({
                        name: "Search Query",
                        value: this._searchQuery
                    });
                    tooltipParams.push({
                        name: "Saved Search",
                        value: this._savedSearchId
                    });
                    return {
                        title: "Search & Refine",
                        subTitle: "Last Searched",
                        subTitleValue: this._searchTimeStamp ? this._searchTimeStamp : new Date().toLocaleString(),
                        tooltipParams: tooltipParams
                    };
                },

                _onApplicationConfigReceived: function (e) {
                    // this.logInfo("ConfigReceived","response",JSON.stringify(e, null, 2));
                    this.set('applicationConfig', e.detail);

                },
                _onAppContextChanged: function (e) {
                    this.logInfo("AppContextChanged", "contextData", JSON.stringify(e.detail.contextData));

                    this.contextData = {}; // To notify
                    this.contextData = e.detail.contextData;

                    this.isElementLoaded = true

                    //this.$$("#getEntityDiscoveryAppConfig").refresh();
                    if (this.shadowRoot.querySelector("#entitySearchDiscoveryGrid")) {
                        //this.shadowRoot.querySelector("#entitySearchDiscoveryGrid").refresh();
                    }
                },
                _onDimensionsChanged: function (e) {
                    var newDimensions = e.detail.dimensions;
                    this._updateFromDimensionSelector(newDimensions);
                }
            });
        })();
    </script>
</dom-module>