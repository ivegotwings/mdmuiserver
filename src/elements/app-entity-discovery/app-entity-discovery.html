<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../pebble-grid/demo/demo-grid-element.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../rock-search-filter/rock-search-filter.html" />
<link rel="import" href="../rock-saved-searches/rock-saved-searches.html" />
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<dom-module id="app-entity-discovery">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">            
            #actions {
                --pebble-button: {
                height: 34px;
                padding: 1em 0em 1em 0.2em;
                top: -5px;
                color: #212121;
                border: 1px solid #C1CAD4;
                font-size: small;
                margin-left: -3px;
                }
                --pebble-button-iron-icon: {
                height: 20px;
                width: 20px ;
                padding:0 3px 0 3px;
                color: #7d8690;
                }
                --pebble-button-dropdown-icon: {
                height: 20px;
                width: 20px;
                color: #7d8690;
                }
            }
            
            rock-search-bar {
                display: inline-flex;
                width: 98%;
                height:30px;
                border:1px solid var(--cloudy-blue-color);
            }
            
            rock-search-filter::shadow paper-menu-button {
                padding: 4px;
            }
            rock-dimension-selector {
                --dimesion-selector-catalog-dropdown: {
                width: 80px;
                }
                ;
                --dimesion-selector-source-dropdown: {
                width: 55px;
                }
                ;
                --dimesion-selector-date-dropdown: {
                width: 60px;
                }
                ;
                --dimesion-selector-locale-dropdown: {
                width: 65px;
                }
                ;
            }
            #dimensionContainer {
                align-self: center;
                width: 100%;
                /*line-height: 20px;*/
            }
            
            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color);
                min-width: 0px;
                margin: 10px 5px;
                min-height: 18px;
            }

            #actionsPopover {
                margin-top: 3px;
            }
            
            rock-search-filter::shadow paper-menu-button paper-menu {
                background: #ffffff;
            }

            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
                font-weight: normal;
            }

            :root {
                --pebble-popover-max-width: 100%;
            }
            
            pebble-popover paper-item {
                cursor: pointer;
                font-size: 14px;
                padding: 0 0 0 0;
                min-height: 40px;
            }

            pebble-popover paper-item iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                color: #ffffff;
            }
            
            .badge {
                @apply(--layout);
                @apply(--layout-center-center);
                @apply(--paper-font-common-base);
                font-weight: normal;
                font-size: 11px;
                */ border-radius: 50%;
                margin-right: 10px;
                width: 25px;
                height: 25px;
                background-color: #36B44A;
                opacity: 1.0;
                color: white;
            }

            .marginTop1 {
                margin-top: 1px;
            }

            .marginTop12 {
                margin-top: 12px;
            }

            .marginBottom5 {
                margin-bottom: 5px;
            }

            .searchFilterTag {
                margin: -9px 0 0 3px;
                padding-top: 1px;
            }
    </style>
<rock-layout>
    <rock-titlebar icon="pebble-icons:ToolbarSearch" title="Entity Search & Discovery" closable minimizable>
        <div id="dimensionContainer" align="right">
            <iron-ajax auto url="../../data/EntitySearchApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
            <rock-dimension-selector id="dimensionSelector" config-data="{{dimensionData}}"></rock-dimension-selector>
            <bedrock-pubsub event-name="dimension-selector-catalog" handler="onCatalogChange" target-id="dimensionSelector"></bedrock-pubsub>
            <bedrock-pubsub event-name="dimension-selector-source" handler="onSourceChange" target-id="dimensionSelector"></bedrock-pubsub>
            <bedrock-pubsub event-name="dimension-selector-locale" handler="onLocaleChange" target-id="dimensionSelector"></bedrock-pubsub>
        </div>
        <pebble-vertical-divider></pebble-vertical-divider>
    </rock-titlebar>
    <rock-header>
        <div class="fixed-content">
            <div class="layout horizontal marginBottom5">

                <div class="flex">
                    <!-- search bar-->
                    <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                    <bedrock-pubsub on-bedrock-event-rock-search="onSearchQueryChange"></bedrock-pubsub>
                </div>
                <div class="marginTop12">
                    <!-- Saved Search button & its popover-->
                    <rock-saved-searches id="rockSavedSearch" icon="pebble-icons:SavedSearch" button-text="Load Saved Search"
                    dropdown-icon></rock-saved-searches>
                    <iron-ajax auto url="../../data/saved-searches.json" handle-as="json" last-response="{{_savedSearches}}"></iron-ajax>
                     <bedrock-pubsub on-bedrock-event-saved-search-save="onCreateEditSavedSearch"></bedrock-pubsub>
                    <bedrock-pubsub event-name="actions-parent-button-tap" handler="_loadSavedSearch" target-id=""></bedrock-pubsub>
                    <bedrock-pubsub event-name="favourite-saved-search" handler="_markSavedSearchAsFavourite" target-id=""></bedrock-pubsub>
                    <bedrock-pubsub event-name="delete-saved-search" handler="_markSavedSearchAsDelete" target-id=""></bedrock-pubsub>
                 </div>
            </div>
            <div class="layout horizontal marginBottom5">
                <div class="flex searchFilterTag">
                    <!-- Search Filter Tags -->
                    <iron-ajax auto url="../../data/EntitySearchApp/searchFilters.json" handle-as="json" last-response="{{searchFilters}}"></iron-ajax>
                    <rock-search-filter id="search-filter" icon="pebble-icons:Filter" text="Refine More" filters="{{searchFilters}}" hide-search-trigger></rock-search-filter>
                    <bedrock-pubsub on-bedrock-event-tag-value-change="onSearchTagValueChange"></bedrock-pubsub>
                </div>

                <div>
                    <!-- Actions buttons and its popover -->
                    <iron-ajax auto url="../../data/EntitySearchApp/actionsData.json" handle-as="json" last-response="{{actionsData}}"></iron-ajax>
                    <pebble-button id="actions" icon="pebble-icons:Done" button-text="Actions" noink raised dropdown-icon on-tap="_onActionsTap"></pebble-button>
                    <pebble-popover id="actionsPopover" for="actions" auto-fit-on-attach no-overlap horizontal-align="right">
                        <template is="dom-repeat" items="[[actionsData]]" as="action">
                            <paper-item data="[[action]]" on-tap="_onActionItemTap">
                                <div class="badge">
                                    <template is="dom-if" if="[[action.icon]]">
                                        <iron-icon icon="[[action.icon]]"></iron-icon>
                                    </template>
                                </div>
                                <div id="actionItem">
                                    <template is="dom-if" if="[[action.text]]">
                                        [[action.text]]
                                    </template>
                                </div>
                            </paper-item>
                        </template>
                    </pebble-popover>
                </div>
            </div>

        </div>
        <div class="shrunk-content">
        </div>
    </rock-header>
    <iron-ajax auto url="../../data/EntitySearchApp/gridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
    <liquid-entity-get auto name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
    <liquid-entity-getdata auto id="initiateSearchResult" log-internal-detail operation="initiatesearch" request="{{request}}" response="{{searchResponse}}"></liquid-entity-getdata>
    <liquid-entity-getdata auto id="searchResultGetDataService" log-internal-detail operation="getsearchresultdetail" request="{{request}}"
        request-id="[[searchResponse.content.requestId]]" response="{{searchResultResponse}}"></liquid-entity-getdata>

    <pebble-grid id="entityGrid" config="{{gridConfig}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}"
        page-size="100" data="{{searchResultResponse.content.entities}}"></pebble-grid>
    <bedrock-pubsub event-name="grid-selecting-item" handler="onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
</rock-layout>
</template>
<script>
    (function () {
        'use strict';

        Polymer({
            is: 'app-entity-discovery',
            properties: {


                /**
                * Indicates the request object that is passed to the data element to retrive attribute model data.
                  Sample: { 
                            action: "getAttributeModels" 
                          }
                */
                attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return { action: "getAttributeModels" };
                    }
                },

                request: {
                    type: Object,
                    value: function () {
                        return {
                            "data": {
                                "query": {
                                    "ctx": [
                                        {
                                            "list": "productMaster",
                                            "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                                        }
                                    ],
                                    "valCtx": [
                                        {
                                            "source": "SAP",
                                            "locale": "en-US"
                                        }
                                    ],
                                    "filters": {
                                        "attributesCriterion": [],
                                        "typesCriterion": ["nart"]
                                    }
                                },
                                "fields": {
                                    "ctxTypes": [
                                        "properties"
                                    ],
                                    "attributes": [
                                        "cpimProductName",
                                        "csapDescriptionOfNart",
                                        "csapMaterialStatusGlobal",
                                        "cpimSkinType"
                                    ],
                                    "relationships": ["ALL"]
                                }
                            }
                        };
                    }
                },

                /**
                * Indicates the response object that is received from liquid element.
                */
                searchResponse: {
                    type: Object,
                    value: undefined,
                    notify: true
                },

                context: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                savedSearchId: {
                    type: Number
                },
                _savedSearches: {
                    type: Object,
                    observer: '_savedSeachesChanged'
                }

            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            listeners: {
                'tag-item-remove': '_onTagItemRemove'
            },
            ready: function () {
                this.$$("#searchBar").searchInput = [];

                //get saved search id from query string
                var savedSearchId = this._getSavedSearchId();
                if (savedSearchId && savedSearchId != this.savedSearchId) {
                    this.savedSearchId = savedSearchId;
                }                
            },
            onCatalogChange: function (e, detail, sender) {
                
            },
            onSourceChange: function (e, detail, sender) {
          
            },
            onLocaleChange: function (e, detail, sender) {
          
            },
            _onActionsTap: function (e) {
                this.$$('#actionsPopover').show();
            },
            _onActionItemTap: function (e) {
                var eventDetail = {
                    name: e.currentTarget.data.eventName,
                    data: e.currentTarget.data
                }
                this.fireBedrockEvent(e.currentTarget.data.eventName, e.currentTarget.data);
            },
            _onTagItemRemove: function (e) {
                this.pop('request.data.query.filters.attributesCriterion');
                var req = this.request;
                this.request = undefined;
                this.request = req;
            },
            onSearchTagValueChange: function (e, detail, sender) {
                if (detail != undefined) {
                    var attrCond = {};
                    attrCond[detail.name] = detail.value;
                    this.push('request.data.query.filters.attributesCriterion', attrCond);
                    var req = this.request;
                    this.request = undefined;
                    this.request = req;

                }
            },
            onSearchQueryChange: function (e,detail,sender) {
                if(detail !=undefined){
                    if(!this.request.data.fields.all) {
                        this.request.data.fields.all = {};
                    }
                    this.request.data.fields.all.exists=detail;
                    var req = this.request;
                    this.request = undefined;
                    this.request = req;
                }
            },
            onSelectingGridItem: function (e, detail, sender) {
                if (detail) {
                    document.querySelector("main-app").set('route.__queryParams', { "id": detail.item.id });
                    document.querySelector("main-app").set('route.path', "/entity-manage");
                }
            },
            onCreateEditSavedSearch: function (e, detail, sender) {
                if(detail){
                    // create or edit form info
                    var savedSearchInfo = detail;

                    // dimension selectors info
                    var dimensionsInfo = {};
                    var dimensionsObject = this._getDimensions();
                    if(dimensionsObject){
                        if(dimensionsObject.catalog) {
                            dimensionsInfo.catalog = dimensionsObject.catalog.selectedItem.value;
                        }
                        if(dimensionsObject.source) {
                            dimensionsInfo.source = dimensionsObject.source.selectedItem.value;
                        }
                        if(dimensionsObject.locale) {
                            dimensionsInfo.locale = dimensionsObject.locale.selectedItem.value;
                        }
                    }

                    // search input info
                    var searchQuery = this.$$("#searchBar").query;

                    //search filters
                    var searchFilters = this.$$("#search-filter").filters;
                    var searchTags = this.$$("#search-filter").tags;

                    var savedSearchObject = { "savedSearch": savedSearchInfo, "dimensions": dimensionsInfo, "searchQuery": searchQuery, "searchFilters": searchFilters, "searchTags": searchTags };
                }
            },
            _loadSavedSearch: function (e, detail, sender) {
                if (detail) {
                    this.savedSearchId = detail.id;
                    document.querySelector("main-app").set('route.__queryParams', { "savedSearchId": detail.id.toString() });
                    var savedSearch = this._getSavedSearches(this._savedSearches, this.savedSearchId);
                    this._populateHeaderControls(savedSearch);
                }
            },
            _markSavedSearchAsFavourite: function(e, detail, sender){
                if(detail){
                    // detail object has info of the favorite action button, its parent button and tab info.
                }
            },
            _markSavedSearchAsDelete: function(e, detail, sender){
                if(detail){
                    // detail object has info of the delete action button, its parent button and tab info.
                }
            },
            _getSavedSearchId: function() {
                var mainApp = document.querySelector('main-app');
                if (mainApp && mainApp.route && mainApp.route.__queryParams && "savedSearchId" in mainApp.route.__queryParams) {
                    return mainApp.route.__queryParams['savedSearchId'];
                }
            },
            _savedSeachesChanged: function(newValue, oldValue) {
                if(newValue != oldValue){
                    var savedSearch = this._getSavedSearches(this._savedSearches, this.savedSearchId);
                    this._populateHeaderControls(savedSearch);
                }
            },
            _getSavedSearches: function(savedSearches,savedSearchId) {
                var savedSearch;
                if(savedSearches) {
                for(var category in savedSearches) {
                    var categorySavedSearches = savedSearches[category];
                    if(categorySavedSearches && categorySavedSearches.length >0){
                        for(var i=0; i<categorySavedSearches.length; i++) {
                            if(categorySavedSearches[i].id == savedSearchId) {
                                savedSearch = categorySavedSearches[i];
                                break; 
                            }
                        }
                        if(savedSearch){
                            break;
                        }
                    }
                  }
                }
                return savedSearch;
            },
            _populateHeaderControls: function(savedSearch) {
                if(savedSearch) {            
                    var searchBarElement =  this.$$("#searchBar");
                    if(searchBarElement){
                        searchBarElement.query= savedSearch.searchQuery;
                    }   

                    var dimensionsObject = this._getDimensions();
                    if(dimensionsObject){
                            if(dimensionsObject.catalog) {
                                dimensionsObject.catalog.querySelector('paper-listbox').selected = savedSearch.dimensions.catalog;
                            }
                            if(dimensionsObject.source) {
                                dimensionsObject.source.querySelector('paper-listbox').selected = savedSearch.dimensions.Source;
                            }
                            if(dimensionsObject.locale) {
                                dimensionsObject.locale.querySelector('paper-listbox').selected = savedSearch.dimensions.Locale;
                            }
                    }

                    var searchFilter = this.$$("#search-filter");
                    if(searchFilter){
                        searchFilter.filters = savedSearch.searchFilters;
                        searchFilter.tags = savedSearch.searchTags;
                    }  

                    var rockSavedSearchElement = this.$$("#rockSavedSearch");
                    if(rockSavedSearchElement){
                        rockSavedSearchElement.buttonText = savedSearch.name;
                    }

                this._invokeSearch(savedSearch.searchTags,savedSearch.dimensions.catalog,savedSearch.dimensions.Source,savedSearch.dimensions.Locale,savedSearch.searchQuery);
                }
            },
            _invokeSearch: function(searchTags,list,source,locale,searchQuery) {
                var attrCond = {};
                if(searchTags && searchTags.length>0) {
                    for(var i=0; i<searchTags.length; i++ ) {
                        var attrCond = {};
                        attrCond[searchTags[i].name] =searchTags[i].value;
                        this.push('request.data.query.filters.attributesCriterion', attrCond);
                    }
                }
                if(searchQuery) {
                    if (!this.request.data.fields.all) {
                        this.request.data.fields.all = {};
                    }
                    this.request.data.fields.all.exists = searchQuery;
                }
                this.request.data.query.ctx[0].list = list;
                this.request.data.query.valCtx[0].source = source;
                this.request.data.query.valCtx[0].loclae = locale;
                var req = this.request;
                this.request = undefined;
                this.request = req;
            },
            _getDimensions: function(){
                // dimension selectors info
                    var dimensionsObject = {};
                    var catalogDropdown = this.$$("#dimensionSelector").$$("#catalogDropdown");
                    var sourceDropdown = this.$$("#dimensionSelector").$$("#sourceDropdown");
                    //var timeDropdown = this.$$("#dimensionSelector").$$("#catalogDropdown");
                    var localeDropdown = this.$$("#dimensionSelector").$$("#localeDropdown");

                    dimensionsObject.catalog = catalogDropdown;
                    dimensionsObject.source = sourceDropdown;
                    //dimensionsObject.time = timeDropdown;
                    dimensionsObject.locale = localeDropdown;  

                    return  dimensionsObject;
            }
        });
    })();

</script>

</dom-module>