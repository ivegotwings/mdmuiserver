<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../pebble-grid/demo/demo-grid-element.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../rock-search-filter/rock-search-filter.html" />
<link rel="import" href="../rock-saved-searches/rock-saved-searches.html" />
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<dom-module id="app-entity-discovery">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">            
            #actions {
                --pebble-button: {
                    height: 32px;
                    color: #212121;
                    border: 1px solid #C1CAD4;
                    font-size: small;
                }
                --pebble-button-iron-icon: {
                    height: 20px;
                    width: 20px ;
                    padding:0 3px 0 3px;
                    color: #7d8690;
                }
                --pebble-button-dropdown-icon: {
                    height: 20px;
                    width: 20px;
                    color: #7d8690;
                }
            }
            
            rock-search-bar {
                display: inline-flex;
                width: calc( 100% - 10px );
                height:32px;
                border:1px solid var(--cloudy-blue-color);
            }
           
            rock-search-filter::shadow paper-menu-button {
                padding: 0;
            }
            rock-dimension-selector {
                --dimesion-selector-catalog-dropdown: {
                    width: 70px;
                }
                ;
                --dimesion-selector-source-dropdown: {
                    width: 55px;
                }
                ;
                --dimesion-selector-date-dropdown: {
                    width: 60px;
                }
                ;
                --dimesion-selector-locale-dropdown: {
                width: 65px;
                }
                ;
            }
            
            #dimensionContainer {
                align-self: center;
                width: 100%;
                /*line-height: 20px;*/
            }
            
            pebble-vertical-divider {
                --pebble-vertical-divider-color: var(--divider-color);
                min-width: 2px;
                margin: 10px 5px;
                min-height: 18px;
            }

            #actionsPopover {
                margin-top: 3px;
            }
            
            rock-search-filter::shadow paper-menu-button paper-menu {
                background: #ffffff;
            }

            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
                font-weight: normal;
            }

            :root {
                --pebble-popover-max-width: 100%;
            }
            
            pebble-popover paper-item {
                cursor: pointer;
                font-size: 14px;
                padding: 0 0 0 0;
                min-height: 40px;
            }
            pebble-button::shadow paper-button::shadow iron-icon{
                color:#fff !important;
            }
            pebble-popover paper-item iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                color: #ffffff;
            }
            
            .badge {
                @apply(--layout);
                @apply(--layout-center-center);
                @apply(--paper-font-common-base);
                font-weight: normal;
                font-size: 11px;
                border-radius: 50%;
                margin-right: 10px;
                width: 25px;
                height: 25px;
                background-color: #36B44A;
                opacity: 1.0;
                color: white;
            }
            
            rock-header{
                padding: 0 10px;
            }
            pebble-actions::shadow pebble-button::shadow iron-icon{
			    color:#fff !important;
			}
            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button iron-icon{
                color:#fff !important;
            }
            
        </style>
<rock-layout>
    <rock-titlebar icon="pebble-md-icons:Advancesearch" title="Entity Search & Discovery" closable minimizable>
        <div id="dimensionContainer" align="right">
            <iron-ajax auto url="../../data/EntitySearchApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
            <rock-dimension-selector id="dimensionSelector" config-data="{{dimensionData}}"></rock-dimension-selector>
            <bedrock-pubsub event-name="dimension-selector-catalog" handler="onCatalogChange" target-id="dimensionSelector"></bedrock-pubsub>
            <bedrock-pubsub event-name="dimension-selector-source" handler="onSourceChange" target-id="dimensionSelector"></bedrock-pubsub>
            <bedrock-pubsub event-name="dimension-selector-locale" handler="onLocaleChange" target-id="dimensionSelector"></bedrock-pubsub>
        </div>
        <pebble-vertical-divider></pebble-vertical-divider>
    </rock-titlebar>
    <rock-header>
        <div class="fixed-content">
            <div class="layout horizontal">
                <div class="flex">
                    <!-- search bar-->
                    <rock-search-bar id="searchBar" class="p-5" placeholder="Enter Search text"></rock-search-bar>
                    <bedrock-pubsub event-name="rock-search" handler="onSearchQueryChange" target-id="searchBar"></bedrock-pubsub>
                </div>
                <div>
                    <!-- Saved Search button & its popover-->
                    <rock-saved-searches id="rockSavedSearch" icon="pebble-md-icons:SavedSearch" button-text="Load Saved Search"
                    dropdown-icon></rock-saved-searches>
                    <iron-ajax auto url="../../data/saved-searches.json" handle-as="json" last-response="{{_savedSearches}}"></iron-ajax>
                    <bedrock-pubsub event-name="saved-search-save" handler="onCreateEditSavedSearch" ></bedrock-pubsub>
                    <bedrock-pubsub event-name="actions-parent-button-tap" handler="_loadSavedSearch" target-id=""></bedrock-pubsub>
                    <bedrock-pubsub event-name="favourite-saved-search" handler="_markSavedSearchAsFavourite" target-id=""></bedrock-pubsub>
                    <bedrock-pubsub event-name="delete-saved-search" handler="_markSavedSearchAsDelete" target-id=""></bedrock-pubsub>
                 </div>
            </div>
            <div class="layout horizontal p-t-7">
                <div class="flex searchFilterTag">
                    <!-- Search Filter Tags -->
                    <iron-ajax auto url="../../data/EntitySearchApp/searchFilters.json" handle-as="json" last-response="{{searchFilters}}"></iron-ajax>
                    <rock-search-filter id="search-filter" icon="pebble-icons:Filter" text="Refine More" filters="{{searchFilters}}" hide-search-trigger></rock-search-filter>
                    <bedrock-pubsub event-name="tag-value-change" handler="onSearchTagValueChange"></bedrock-pubsub>

                </div>

                <div>
                    <!-- Actions buttons and its popover -->
                    <iron-ajax auto url="../../data/EntitySearchApp/actionsData.json" handle-as="json" last-response="{{actionsData}}"></iron-ajax>
                    <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                    <pebble-actions id="actionsButton" button-icon="pebble-icons:Done" button-text="Actions" actions-data="[[actionsData]]"></pebble-actions>
                </div>
            </div>
        </div>
        <div class="shrunk-content">
        </div>
    </rock-header>
    <iron-ajax auto url="../../data/EntitySearchApp/gridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
    <liquid-entity-get auto name="attributeModelGetService" request="{{attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
    <liquid-entity-getdata auto  verbose id="initiateSearchResult" operation="initiatesearch" 
        request-data="{{request}}" last-response="{{searchResponse}}"></liquid-entity-getdata>
    <liquid-entity-getdata auto verbose id="searchResultGetDataService" operation="getsearchresultdetail" 
        request-data="{{request}}" request-id="[[searchResponse.content.requestId]]" last-response="{{searchResultResponse}}"></liquid-entity-getdata>

    <pebble-grid id="entityGrid" config="{{gridConfig}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}"
        page-size="100" data="{{searchResultResponse.content.entities}}"></pebble-grid>
    <bedrock-pubsub event-name="grid-selecting-item" handler="onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
</rock-layout>
</template>
<script>
    (function () {
        'use strict';

        Polymer({
            is: 'app-entity-discovery',
            properties: {


                /**
                * Indicates the request object that is passed to the data element to retrive attribute model data.
                  Sample: { 
                            action: "getAttributeModels" 
                          }
                */
                attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return { action: "getAttributeModels" };
                    }
                },

                request: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {
                                    "ctx": [
                                        {
                                            "list": "productMaster",
                                            "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                                        }
                                    ],
                                    "valCtx": [
                                        {
                                            "source": "SAP",
                                            "locale": "en-US"
                                        }
                                    ],
                                    "filters": {
                                        "attributesCriterion": [],
                                        "typesCriterion": ["nart"]
                                    }
                                },
                                "fields": {
                                    "ctxTypes": [
                                        "properties"
                                    ],
                                    "attributes": [
                                        "cpimProductName",
                                        "csapDescriptionOfNart",
                                        "csapMaterialStatusGlobal",
                                        "cpimSkinType"
                                    ],
                                    "relationships": ["ALL"]
                                }
                            }
                        };
                    }
                },

                /**
                * Indicates the response object that is received from liquid element.
                */
                searchResponse: {
                    type: Object,
                    value: undefined,
                    notify: true,
                    observer:'_searchResponseChanged'
                },
                searchResultResponse: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    notify: true
                },
                context: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                savedSearchId: {
                    type: Number
                },
                _savedSearches: {
                    type: Object,
                    observer: '_savedSeachesChanged'
                }

            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            listeners: {
                'tag-item-remove': '_onTagItemRemove'
            },
            ready: function () {
                this.$$("#searchBar").searchInput = [];

                //get saved search id from query string
                var savedSearchId = this._getSavedSearchId();
                if (savedSearchId && savedSearchId != this.savedSearchId) {
                    this.savedSearchId = savedSearchId;
                }                
            },
            onCatalogChange: function (e, detail, sender) {
                
            },
            onSourceChange: function (e, detail, sender) {
          
            },
            onLocaleChange: function (e, detail, sender) {
          
            },
            _onActionsTap: function (e) {
                this.$$('#actionsPopover').show();
            },
            _onActionItemTap: function (e, detail, sender) {
                alert("event triggered: " + JSON.stringify(detail));
            },
            _removeFilterWIthName: function (name) {
                var attributesCriterion=this.request.params.query.filters.attributesCriterion;
                for(var i=0;i<attributesCriterion.length;i++){
                    if(attributesCriterion[i][name]){
                        this.splice('request.params.query.filters.attributesCriterion',i,1);
                    }
                }
            },
            _onTagItemRemove: function (e,detail) {
                if(detail !=undefined) {
                    this._removeFilterWIthName(detail.name);
                    var req = this.request;
                    this.request = undefined;
                    this.request = req;
                }
            },
            onSearchTagValueChange: function (e, detail, sender) {
                if (detail != undefined) {
                    var attrCond = {};
                    attrCond[detail.name] = detail.value;
                    this._removeFilterWIthName(detail.name);
                    this.push('request.params.query.filters.attributesCriterion', attrCond);
                    var req = this.request;
                    this.request = undefined;
                    this.request = req;

                }
            },
            onSearchQueryChange: function (e,detail,sender) {
                if(detail !=undefined){
                    if(!this.request.params.fields.all) {
                        this.request.params.fields.all = {};
                    }
                    this.request.params.fields.all.exists=detail;
                    var req = this.request;
                    this.request = undefined;
                    this.request = req;
                }
            },
            onSelectingGridItem: function (e, detail, sender) {
                if (detail) {
                    document.querySelector("main-app").set('route.__queryParams', { "id": detail.item.id });
                    document.querySelector("main-app").set('route.path', "/entity-manage");
                }
            },
            onCreateEditSavedSearch: function (e, detail, sender) {
                if(detail){
                    // create or edit form info
                    var savedSearchInfo = detail;

                    // dimension selectors info
                    var dimensionsInfo = {};
                    var dimensionsObject = this._getDimensions();
                    if(dimensionsObject){
                        if(dimensionsObject.catalog) {
                            dimensionsInfo.catalog = dimensionsObject.catalog.selectedItem.value;
                        }
                        if(dimensionsObject.source) {
                            dimensionsInfo.source = dimensionsObject.source.selectedItem.value;
                        }
                        if(dimensionsObject.locale) {
                            dimensionsInfo.locale = dimensionsObject.locale.selectedItem.value;
                        }
                    }

                    // search input info
                    var searchQuery = this.$$("#searchBar").query;

                    //search filters
                    var searchFilters = this.$$("#search-filter").filters;
                    var searchTags = this.$$("#search-filter").tags;

                    var savedSearchObject = { "savedSearch": savedSearchInfo, "dimensions": dimensionsInfo, "searchQuery": searchQuery, "searchFilters": searchFilters, "searchTags": searchTags };
                }
            },
            _loadSavedSearch: function (e, detail, sender) {
                if (detail) {
                    this.savedSearchId = detail.id;
                    document.querySelector("main-app").set('route.__queryParams', { "savedSearchId": detail.id.toString() });
                    var savedSearch = this._getSavedSearches(this._savedSearches, this.savedSearchId);
                    this._populateHeaderControls(savedSearch);
                }
            },
            _markSavedSearchAsFavourite: function(e, detail, sender){
                if(detail){
                    // detail object has info of the favorite action button, its parent button and tab info.
                }
            },
            _markSavedSearchAsDelete: function(e, detail, sender){
                if(detail){
                    // detail object has info of the delete action button, its parent button and tab info.
                }
            },
            _getSavedSearchId: function() {
                var mainApp = document.querySelector('main-app');
                if (mainApp && mainApp.route && mainApp.route.__queryParams && "savedSearchId" in mainApp.route.__queryParams) {
                    return mainApp.route.__queryParams['savedSearchId'];
                }
            },
            _savedSeachesChanged: function(newValue, oldValue) {
                if(newValue != oldValue){
                    var savedSearch = this._getSavedSearches(this._savedSearches, this.savedSearchId);
                    this._populateHeaderControls(savedSearch);
                }
            },
            _getSavedSearches: function(savedSearches,savedSearchId) {
                var savedSearch;
                if(savedSearches) {
                for(var category in savedSearches) {
                    var categorySavedSearches = savedSearches[category];
                    if(categorySavedSearches && categorySavedSearches.length >0){
                        for(var i=0; i<categorySavedSearches.length; i++) {
                            if(categorySavedSearches[i].id == savedSearchId) {
                                savedSearch = categorySavedSearches[i];
                                break; 
                            }
                        }
                        if(savedSearch){
                            break;
                        }
                    }
                  }
                }
                return savedSearch;
            },
            _populateHeaderControls: function(savedSearch) {
                if(savedSearch) {            
                    var searchBarElement =  this.$$("#searchBar");
                    if(searchBarElement){
                        searchBarElement.query= savedSearch.searchQuery;
                    }   

                    var dimensionsObject = this._getDimensions();
                    if(dimensionsObject){
                            if(dimensionsObject.catalog) {
                                dimensionsObject.catalog.querySelector('paper-listbox').selected = savedSearch.dimensions.catalog;
                            }
                            if(dimensionsObject.source) {
                                dimensionsObject.source.querySelector('paper-listbox').selected = savedSearch.dimensions.Source;
                            }
                            if(dimensionsObject.locale) {
                                dimensionsObject.locale.querySelector('paper-listbox').selected = savedSearch.dimensions.Locale;
                            }
                    }

                    var searchFilter = this.$$("#search-filter");
                    if(searchFilter){
                        searchFilter.filters = savedSearch.searchFilters;
                        searchFilter.tags = savedSearch.searchTags;
                    }  

                    var rockSavedSearchElement = this.$$("#rockSavedSearch");
                    if(rockSavedSearchElement){
                        rockSavedSearchElement.buttonText = savedSearch.name;
                    }

                this._invokeSearch(savedSearch);
                }
            },
            _invokeSearch: function(savedSearch) {
                var searchTags=savedSearch.searchTags;
                var attrCond = {};
                if(searchTags && searchTags.length>0) {
                    for(var i=0; i<searchTags.length; i++ ) {
                        var attrCond = {};
                        attrCond[searchTags[i].name] = searchTags[i].value;
                        this.push('request.params.query.filters.attributesCriterion', attrCond);
                    }
                }
                if(savedSearch.searchQuery) {
                    if (!this.request.params.fields.all) {
                        this.request.params.fields.all = {};
                    }
                    this.request.params.fields.all.exists = savedSearch.searchQuery;
                }
                this.request.params.query.ctx[0].list = savedSearch.dimensions.catalog;
                this.request.params.query.valCtx[0].source = savedSearch.dimensions.Source;
                this.request.params.query.valCtx[0].loclae = savedSearch.dimensions.Locale;
                var req = this.request;
                this.request = undefined;
                this.request = req;
            },
            _getDimensions: function(){
                // dimension selectors info
                    var dimensionsObject = {};
                    var catalogDropdown = this.$$("#dimensionSelector").$$("#catalogDropdown");
                    var sourceDropdown = this.$$("#dimensionSelector").$$("#sourceDropdown");
                    //var timeDropdown = this.$$("#dimensionSelector").$$("#catalogDropdown");
                    var localeDropdown = this.$$("#dimensionSelector").$$("#localeDropdown");

                    dimensionsObject.catalog = catalogDropdown;
                    dimensionsObject.source = sourceDropdown;
                    //dimensionsObject.time = timeDropdown;
                    dimensionsObject.locale = localeDropdown;  

                    return  dimensionsObject;
            },
            _searchResponseChanged: function (searchResponse) {
                if(!searchResponse || !searchResponse.content || searchResponse.content.totalRecords==0)   {
                    this.searchResultResponse={
                        "content":{
                            "entities":{}
                        }
                    };
                }
            }
        });
    })();

</script>

</dom-module>