<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-search-filter/rock-search-filter.html" />
<link rel="import" href="../rock-saved-searches/rock-saved-searches.html" />

<dom-module id="app-entity-discovery">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
            #actions::shadow {
                --pebble-button: {
                    height: 32px;
                    color: var(--primary-text-color);
                    border: 1px solid var(--cloudy-blue-color);
                    font-size: small;
                }
                --pebble-button-iron-icon: {
                    height: 16px;
                    width: 16px;
                    padding: 0 3px 0 3px;
                    color: var(--icon-color);
                }
                --pebble-button-dropdown-icon: {
                    height: 20px;
                    width: 20px;
                    color: var(--icon-color);
                }
            }
            pebble-actions::shadow pebble-button::shadow paper-button iron-icon#leftIcon{
                width: 16px!important;
                height: 16px!important;
                margin: 0 10px;
            }
            rock-search-bar {
                display: inline-flex;
                width: calc( 100% - 10px);
                height: 32px;
                border: 1px solid var(--cloudy-blue-color);
            }
            
            rock-search-filter::shadow paper-menu-button {
                padding: 0;
            }
            
            rock-dimension-selector {
                --dimesion-selector-container-popover: {
                    width: auto;
                }
                --dimesion-selector-source-popover: {
                    width: auto;
                }
                --dimesion-selector-date-dropdown: {
                    width: auto;
                }
                --dimesion-selector-locale-popover: {
                    width: auto;
                }
            }
            
            #dimensionContainer {
                align-self: center;
                width: 100%;
                /*line-height: 20px;*/
            }
            
            #actionsPopover {
                margin-top: 3px;
            }
            
            rock-search-filter::shadow paper-menu-button paper-menu {
                background: var(--white);
            }
            
            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
                font-weight: normal;
            }
            
             :root {
                --pebble-popover-max-width: 100%;
            }
            
            pebble-popover paper-item {
                cursor: pointer;
                font-size: 14px;
                padding: 0 0 0 0;
                min-height: 40px;
            }
            
            pebble-button::shadow paper-button::shadow iron-icon {
                color: var(--white) !important;
            }
            
            pebble-popover paper-item iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                color: var(--white);
            }
            
            .badge {
                font-weight: normal;
                font-size: 11px;
                border-radius: 50%;
                margin-right: 10px;
                width: 25px;
                height: 25px;
                background-color: var(--palette-medium-green);
                opacity: 1.0;
                color: var(--white);
                @apply(--layout);
                @apply(--layout-center-center);
                @apply(--paper-font-common-base);
            }
            rock-header{
                padding: 10px;
            }
            
            pebble-actions::shadow pebble-button::shadow iron-icon {
                color: var(--white) !important;
                margin: 0 5px;
            }
            
            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button iron-icon {
                color: var(--white) !important;
            }
        </style>
        <rock-layout>
            <rock-titlebar icon="pebble-md-icons:Advancesearch" title="Entity Search & Discovery" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <iron-ajax auto url="../../data/EntitySearchApp/dimensionData.json" handle-as="json" last-response="{{dimensionData}}"></iron-ajax>
                    <rock-dimension-selector id="dimensionSelector" config-data="{{dimensionData}}" all-multi-select></rock-dimension-selector>
                    <bedrock-pubsub on-bedrock-event-dimension-selector-list="_onCatalogChange" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-dimension-selector-source="_onSourceChange" target-id="dimensionSelector"></bedrock-pubsub>
                    <bedrock-pubsub on-bedrock-event-dimension-selector-locale="_onLocaleChange" target-id="dimensionSelector"></bedrock-pubsub>
                </div>
                </rock-titlebar>
            <rock-header>
                <div class="fixed-content">
                    <div class="layout horizontal">
                        <div class="flex">
                            <!-- search bar-->
                            <rock-search-bar id="searchBar" class="p-5" placeholder="Enter Search text"></rock-search-bar>
                            <bedrock-pubsub event-name="rock-search" handler="_onSearchQueryChange" target-id="searchBar"></bedrock-pubsub>
                        </div>
                        <div>
                            <!-- Saved Search button & its popover-->
                            <rock-saved-searches id="rockSavedSearch" saved-searches="{{_savedSearches}}" saved-search-id="{{savedSearchId}}" icon="pebble-md-icons:SavedSearch"
                                button-text="Load Saved Search" dropdown-icon></rock-saved-searches>
                                <iron-ajax auto url="../../data/saved-searches.json" handle-as="json" last-response="{{_savedSearches}}"></iron-ajax>
                                <bedrock-pubsub event-name="saved-search-save" handler="_onCreateEditSavedSearch"></bedrock-pubsub>
                                <bedrock-pubsub event-name="actions-parent-button-tap" handler="_loadSavedSearch" target-id=""></bedrock-pubsub>
                                <bedrock-pubsub event-name="favourite-saved-search" handler="_markSavedSearchAsFavourite" target-id=""></bedrock-pubsub>
                                <bedrock-pubsub event-name="delete-saved-search" handler="_markSavedSearchAsDelete" target-id=""></bedrock-pubsub>
                        </div>
                    </div>
                    <div class="layout horizontal p-t-10">
                        <div class="flex searchFilterTag">
                            <!-- Search Filter Tags -->
                            <iron-ajax auto url="../../data/EntitySearchApp/searchFilters.json" handle-as="json" last-response="{{searchFilters}}"></iron-ajax>
                            <rock-search-filter id="search-filter" icon="pebble-sm-icons:Filter-wt" text="Refine More" filters="{{searchFilters}}" hide-search-trigger></rock-search-filter>
                            <bedrock-pubsub event-name="tag-value-change" handler="_onSearchTagValueChange"></bedrock-pubsub>
                        </div>
                        <div>
                            <!-- Actions buttons and its popover -->
                            <iron-ajax auto url="../../data/EntitySearchApp/actionsData.json" handle-as="json" last-response="{{actionsData}}"></iron-ajax>
                            <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                            <pebble-actions id="actionsButton" button-icon="pebble-md-icons:actions" button-text="Actions" actions-data="[[actionsData]]"></pebble-actions>
                        </div>
                    </div>
                </div>
                <div class="shrunk-content">
                </div>
            </rock-header>
            <iron-ajax auto url="../../data/EntitySearchApp/gridConfig.json" handle-as="json" last-response="{{gridConfig}}"></iron-ajax>
            <liquid-entity-get auto name="attributeModelGetService" request="{{_attributeModelRequest}}" response="{{attributeModelResponse}}"></liquid-entity-get>
            <liquid-entity-getdata auto verbose id="initiateSearchResult" operation="initiatesearch" request-data="{{_request}}" last-response="{{_searchResponse}}"></liquid-entity-getdata>
            <liquid-entity-getdata auto verbose id="getsearchresultdetail" operation="getsearchresultdetail" request-data="{{_request}}"
                    request-id="[[_searchResponse.content.requestId]]" last-response="{{_searchResultResponse}}"></liquid-entity-getdata>
            <pebble-grid id="entityGrid" config="{{gridConfig}}" attribute-models="{{attributeModelResponse.returnValue.attributeModels}}"
                    page-size="10" current-page="{{_currentPage}}" record-size="{{_searchResponse.content.totalRecords}}" data="{{_searchResultResponse.content.entities}}"></pebble-grid>
            <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
        </rock-layout>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-discovery',
                properties: {
                    context: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {
                                action: "getAttributeModels"
                            };
                        }
                    },
                    _request: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "ctx": [],
                                        "valCtx": [{
                                            "source": '',
                                            "locale": ''
                                        }],
                                        "filters": {
                                            "attributesCriterion": [],
                                            "typesCriterion": ["nart"]
                                        }
                                    },
                                    "fields": {
                                        "ctxTypes": [
                                            "properties"
                                        ],
                                        "attributes": [
                                            "cpimProductName",
                                            "csapDescriptionOfNart",
                                            "csapMaterialStatusGlobal",
                                            "cpimSkinType"
                                        ],
                                        "relationships": ["ALL"]
                                    },
                                    "options": {
                                        "from": 0,
                                        "to": 9
                                    }
                                }
                            };
                        }
                    },
                    _searchResponse: {
                        type: Object,
                        value: undefined,
                        notify: true,
                        observer: '_searchResponseChanged'
                    },
                    _searchResultResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    _savedSearchId: {
                        type: Number
                    },
                    _savedSearches: {
                        type: Object,
                        notify: true,
                        observer: '_savedSeachesChanged'
                    },
                    _currentPage: {
                        type: Number,
                        value: 0,
                        observer: "_currentPageChanged"
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                listeners: {
                    'tag-item-remove': '_onTagItemRemove',
                    'dimension-selector-initialized': '_onDimensionSelectorInitialized'
                },

                ready: function () {
                    this.$$("#searchBar").searchInput = [];

                    //get saved search id from query string
                    var _savedSearchId = this._getSavedSearchId();
                    if (_savedSearchId && _savedSearchId != this._savedSearchId) {
                        this._savedSearchId = _savedSearchId;
                    }
                },

                // Refine Filter
                _onTagItemRemove: function (e, detail) {
                    if (detail != undefined) {
                        this._removeFilterWithName(detail.name);
                        var req = this._request;
                        this._request = undefined;
                        this._request = req;
                    }
                },
                _onSearchTagValueChange: function (e, detail, sender) {
                    if (detail != undefined) {
                        var attrCond = {};
                        attrCond[detail.name] = detail.value;
                        this._removeFilterWithName(detail.name);
                        this.push('_request.params.query.filters.attributesCriterion', attrCond);
                        var req = this._request;
                        this._request = undefined;
                        this._request = req;
                    }
                },
                _removeFilterWithName: function (name) {
                    var attributesCriterion = this._request.params.query.filters.attributesCriterion;
                    for (var i = 0; i < attributesCriterion.length; i++) {
                        if (attributesCriterion[i][name]) {
                            this.splice('_request.params.query.filters.attributesCriterion', i, 1);
                        }
                    }
                },
                // Refine Filter

                // Full Text Search
                _onSearchQueryChange: function (e, detail, sender) {
                    if (detail != undefined) {
                        if (!this._request.params.fields.all) {
                            this._request.params.fields.all = {};
                        }
                        this._request.params.fields.all.exists = detail;
                        var req = this._request;
                        this._request = undefined;
                        this._request = req;
                    }
                },
                // Full Text Search

                // Grid
                _onSelectingGridItem: function (e, detail, sender) {
                    if (detail) {
                        document.querySelector("main-app").set('route.__queryParams', {
                            "id": detail.item.id
                        });
                        document.querySelector("main-app").set('route.path', "/entity-manage");
                    }
                },
                _currentPageChanged: function (currentPage) {
                    if (currentPage > 0) {
                        var from = (currentPage * 9) + currentPage;
                        var to = currentPage + (currentPage * 9 + 9);
                        var options = {
                            "from": from,
                            "to": to
                        };
                        this.set("request.params.options", options);
                    }
                },
                // Grid

                // Dimension Selector
                _onDimensionSelectorInitialized: function () {
                    this._loadSearchResults();
                },
                _onCatalogChange: function (event) {
                    this._loadSearchResults();
                },
                _onSourceChange: function (event) {
                    this._loadSearchResults();
                },
                _onLocaleChange: function (event) {
                    this._loadSearchResults();
                },
                _prepareContextGroups: function (lists) {
                    if (lists && lists instanceof Array) {
                        var ctxGroup = [];

                        for (var i = 0; i < lists.length; i++) {
                            var ctxInfoObject = new Object();
                            ctxInfoObject.list = lists[i].value;
                            ctxInfoObject.classification =
                                "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry";
                            ctxGroup.push(ctxInfoObject);
                        }

                        return ctxGroup;
                    }
                },
                _prepareValueContextGroups: function (sources, locales) {
                    var valueCtxGroup = [];

                    if (sources && locales && sources instanceof Array && locales instanceof Array) {
                        for (var i = 0; i < sources.length; i++) {
                            for (var j = 0; j < locales.length; j++) {

                                var valueCtxInfoObject = new Object();
                                valueCtxInfoObject.source = sources[i].value;
                                valueCtxInfoObject.locale = locales[j].value;
                                valueCtxGroup.push(valueCtxInfoObject);
                            }
                        }

                        return valueCtxGroup;
                    }
                },
                // Dimension Selector

                // Saved Search
                _loadSavedSearch: function (e, detail, sender) {
                    if (detail) {
                        this._savedSearchId = detail.id;
                        document.querySelector("main-app").set('route.__queryParams', {
                            "_savedSearchId": detail.id.toString()
                        });
                        var savedSearch = this._getSavedSearches(this._savedSearches, this._savedSearchId);
                        this._populateHeaderControls(savedSearch);
                    }
                },
                _onCreateEditSavedSearch: function (e, detail, sender) {
                    if (detail) {
                        // create or edit form info
                        var savedSearchInfo = detail;

                        // search input info
                        var searchQuery = this.$$("#searchBar").query;

                        //search filters
                        var searchFilters = this.$$("#search-filter").filters;
                        var searchTags = this.$$("#search-filter").tags;

                        // dimension selectors info
                        var dimensionsInfo = {};
                        var dimensionSelector = this.$.dimensionSelector;
                        if (dimensionSelector) {
                            dimensionsInfo.selectedLists = dimensionSelector.listSelector.selectedItems;
                            dimensionsInfo.selectedSources = dimensionSelector.sourceSelector.selectedItems;
                            dimensionsInfo.selectedLocales = dimensionSelector.localeSelector.selectedItems;
                        }

                        var savedSearchObject = {
                            "savedSearch": savedSearchInfo,
                            "dimensions": dimensionsInfo,
                            "searchQuery": searchQuery,
                            "searchFilters": searchFilters,
                            "searchTags": searchTags
                        };
                    }
                },
                // Note - this will be modified based on liquid integration
                _markSavedSearchAsFavourite: function (e, detail, sender) {
                    if (detail) {
                        var searchId = detail.parentButton.id;
                        var searchItem = this._getSearchListNameBySearchId(searchId);

                        if (searchItem) {
                            if (searchItem.name == 'my-searches') {
                                this.push('_savedSearches.favourites', this._savedSearches[
                                    "my-searches"][searchItem.index]);
                                this.splice('_savedSearches.my-searches', searchItem.index, 1);
                            } else if (searchItem.name == 'favourites') {
                                this.push('_savedSearches.my-searches', this._savedSearches.favourites[
                                    searchItem.index]);
                                this.splice('_savedSearches.favourites', searchItem.index, 1);
                            } else // shared-searches
                            {
                                // Nothing as of now.
                            }
                        }

                        var tmpSaverSearches = this._savedSearches;
                        this._savedSearches = {};
                        this._savedSearches = tmpSaverSearches;

                        var favTab = this.$$('#rockSavedSearch').$$('rock-tabs').$$(
                            'rock-saved-searches-tags[saved-search-category="favourites"]');
                        var mySearchTab = this.$$('#rockSavedSearch').$$('rock-tabs').$$(
                            'rock-saved-searches-tags[saved-search-category="my-searches"]');
                        var sharedSearchTab = this.$$('#rockSavedSearch').$$('rock-tabs').$$(
                            'rock-saved-searches-tags[saved-search-category="shared-searches"]');

                        this._updateTabSearches(favTab);
                        this._updateTabSearches(mySearchTab);
                        this._updateTabSearches(sharedSearchTab);
                    }
                },
                // Note - this will be removed once we integrated with liquid
                _updateTabSearches: function (tab) {
                    if (tab) {
                        tab.savedSearches = {};
                        tab.savedSearches = this._savedSearches;
                    }
                },
                // Get search list name & item index
                // Note - this will be removed once we integrated with liquid
                _getSearchListNameBySearchId: function (searchId) {
                    var _mySearch = 'my-searches',
                        _favSearch = 'favourites',
                        _sharedSearch = 'shared-searches';

                    if (this._savedSearches[_mySearch]) {
                        for (var idx = 0; idx < this._savedSearches[_mySearch].length; idx++) {
                            if (this._savedSearches[_mySearch][idx].id == searchId) {
                                return {
                                    "name": _mySearch,
                                    "index": idx
                                };
                            }
                        }
                    }

                    if (this._savedSearches.favourites) {
                        for (var idx = 0; idx < this._savedSearches.favourites.length; idx++) {
                            if (this._savedSearches.favourites[idx].id == searchId) {
                                return {
                                    "name": _favSearch,
                                    "index": idx
                                };
                            }
                        }
                    }

                    if (this._savedSearches[_sharedSearch]) {
                        for (var idx = 0; idx < this._savedSearches[_sharedSearch].length; idx++) {
                            if (this._savedSearches[_sharedSearch][idx].id == searchId) {
                                return {
                                    "name": _sharedSearch,
                                    "index": idx
                                };
                            }
                        }
                    }
                },
                _markSavedSearchAsDelete: function (e, detail, sender) {
                    if (detail) {
                        // detail object has info of the delete action button, its parent button and tab info.
                    }
                },
                _getSavedSearchId: function () {
                    var mainApp = document.querySelector('main-app');
                    if (mainApp && mainApp.route && mainApp.route.__queryParams && "_savedSearchId" in
                        mainApp.route.__queryParams) {
                        return mainApp.route.__queryParams['_savedSearchId'];
                    }
                },
                _savedSeachesChanged: function (newValue, oldValue) {
                    if (newValue != oldValue) {
                        var savedSearch = this._getSavedSearches(this._savedSearches, this._savedSearchId);
                        this._populateHeaderControls(savedSearch);
                    }
                },
                _getSavedSearches: function (savedSearches, _savedSearchId) {
                    var savedSearch;
                    if (savedSearches) {
                        for (var category in savedSearches) {
                            var categorySavedSearches = savedSearches[category];
                            if (categorySavedSearches && categorySavedSearches.length > 0) {
                                for (var i = 0; i < categorySavedSearches.length; i++) {
                                    if (categorySavedSearches[i].id == _savedSearchId) {
                                        savedSearch = categorySavedSearches[i];
                                        break;
                                    }
                                }
                                if (savedSearch) {
                                    break;
                                }
                            }
                        }
                    }
                    return savedSearch;
                },
                _populateHeaderControls: function (savedSearch) {
                    if (savedSearch) {
                        // search input info
                        var searchBarElement = this.$$("#searchBar");
                        if (searchBarElement) {
                            searchBarElement.query = savedSearch.searchQuery;
                        }

                        // search filter info
                        var searchFilter = this.$$("#search-filter");
                        if (searchFilter) {
                            searchFilter.filters = savedSearch.searchFilters;
                            searchFilter.tags = savedSearch.searchTags;
                        }

                        // dimensionselector info
                        var dimensionSelector = this.$.dimensionSelector;
                        if (dimensionSelector) {
                            if (dimensionSelector.listSelector) {
                                dimensionSelector.selectedLists = savedSearch.dimensions.selectedLists;
                            }
                            if (dimensionSelector.sourceSelector) {
                                dimensionSelector.selectedSources = savedSearch.dimensions.selectedSources;
                            }
                            if (dimensionSelector.localeSelector) {
                                dimensionSelector.selectedLocales = savedSearch.dimensions.selectedLocales;
                            }
                        }

                        var rockSavedSearchElement = this.$$("#rockSavedSearch");
                        if (rockSavedSearchElement) {
                            rockSavedSearchElement.buttonText = savedSearch.name;
                        }

                        this._loadSearchResults();
                    }
                },
                _loadSearchResults: function (savedSearch) {
                    // search input info
                    var searchQuery = this.$$("#searchBar").query;
                    if (searchQuery) {
                        if (!this._request.params.fields.all) {
                            this._request.params.fields.all = {};
                        }
                        this._request.params.fields.all.exists = searchQuery;
                    }

                    // search filter info
                    var searchTags = this.$$("#search-filter").tags;
                    var attrCond = {};
                    if (searchTags && searchTags.length > 0) {
                        for (var i = 0; i < searchTags.length; i++) {
                            var attrCond = {};
                            attrCond[searchTags[i].name] = searchTags[i].value;
                            this.push('_request.params.query.filters.attributesCriterion', attrCond);
                        }
                    }

                    // dimensionselector info
                    var dimensionSelector = this.$.dimensionSelector;
                    this._request.params.query.ctx = this._prepareContextGroups(dimensionSelector.listSelector
                        .selectedItems)
                    this._request.params.query.valCtx = this._prepareValueContextGroups(
                        dimensionSelector.sourceSelector.selectedItems, dimensionSelector.localeSelector
                        .selectedItems);

                    var req = this._request;
                    this._request = undefined;
                    this._request = req;
                },
                _searchResponseChanged: function (_searchResponse) {
                    if (!_searchResponse || !_searchResponse.content || _searchResponse.content.totalRecords ==
                        0) {
                        this._searchResultResponse = {
                            "content": {
                                "entities": {}
                            }
                        };
                    }
                },
                // Saved Search

                // Action Button
                _onActionsTap: function (e) {
                    this.$$('#actionsPopover').show();
                },
                _onActionItemTap: function (e, detail, sender) {
                    alert("event triggered: " + JSON.stringify(detail));
                },
                // Action Button
            });
        })();
    </script>
</dom-module>