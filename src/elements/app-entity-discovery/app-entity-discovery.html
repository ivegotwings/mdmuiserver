<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-entity-search-grid/rock-entity-search-grid.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html" />
<link rel="import" href="../rock-saved-searches/rock-saved-searches.html" />
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html" />

<dom-module id="app-entity-discovery">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
            rock-search-bar {
                display: inline-flex;
                display: -webkit-inline-flex;
                width: calc( 100% - 10px);
                height: 30px;
                border: 0;
                overflow: inherit!important;
                margin-bottom: 6px;
            }
            
            rock-search-bar::shadow .input-panel iron-icon {
                fill: #fff;
            }
            
            rock-search-filter::shadow paper-menu-button {
                padding: 0;
            }
            
            #dimensionContainer {
                align-self: center;
                -webkit-align-self: center;
                /* Safari 7.0+ */
            }
            
            rock-search-filter::shadow paper-menu-button paper-menu {
                background: var(--palette-white, #fff);
            }
            
            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
                font-weight: normal;
            }
            
             :host {
                --pebble-popover-max-width: 100%;
            }
            
            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--default-font-size, 14px);
                padding: 0 0 0 0;
                min-height: 40px;
            }
            
            #savedSearchPopover {
                width: 360px;
                max-height: none!important;
                --pebble-popover-max-width: 100%;
                --pebble-popover-max-height: 360px;
                overflow: auto;
            }
            
            #savedSearchPopover::shadow>.arrow_box {
                padding: 5px 10px 10px 10px;
            }
            
            #savedSearchPopover::shadow .arrow_box .popover {
                overflow: inherit;
            }
            
            #rockSavedSearch {
                --saved-search-tab-content: {
                    max-height: 250px;
                    overflow: auto;
                }
            }
            
            pebble-button::shadow paper-button::shadow iron-icon {
                color: var(--palette-white, #fff) !important;
            }
            
            pebble-popover paper-item iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                color: var(--palette-white, #fff);
            }
            
            .badge {
                font-weight: normal;
                border-radius: 50%;
                margin-right: 10px;
                width: 25px;
                height: 25px;
                background-color: var(--default-notification-color, #ed204c);
                opacity: 1.0;
                color: var(--default-notification-text-color, #ffffff);
                @apply(--layout);
                @apply(--layout-center-center);
                @apply(--paper-font-common-base);
            }
            
            rock-header {
                padding: 20px 20px 0 20px;
            }
            
            pebble-actions::shadow pebble-button::shadow iron-icon {
                color: var(--white, #fff) !important;
                margin: 0 5px;
            }
            
            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button iron-icon {
                color: var(--white, #fff) !important;
            }
            
            .quick-manage-container {
                height: auto;
                width: 50%;
                display: block;
            }
            
            pebble-vertical-divider {
                --pebble-vertical-divider-color: #c1cad4;
                height: 100%;
                border: 0px;
                min-height: 0px;
                width: 2px;
                margin: 20px 0;
            }
            
            .container {
                width: 100%;
            }
            
            pebble-actions::shadow pebble-popover paper-item {
                /*display: block;*/
                padding: 5px 10px;
                text-align: left;
            }
            
            pebble-actions::shadow pebble-popover {
                color: var(--palette-white, #fff);
            }
            
            pebble-actions::shadow pebble-popover paper-item #actionItem {
                /*display: inline-block;*/
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-steel-grey);
            }
            
            pebble-actions::shadow pebble-popover paper-item #actionItem:hover {
                color: var(--focused-line, #026bc3);
                background-color: var(--bgColor-hover, #e8f4f9);
            }
            
            pebble-actions::shadow pebble-popover paper-item #actionItem:focus {
                color: var(--primary-button-color, #036bc3);
            }
            
            pebble-actions::shadow #actionsPopover {
                margin-top: 3px;
            }
            
            .resetsearch {
                position: absolute;
                right: 205px;
                top: 140px;
                font-size: var(--font-size-xs);
                color: var(--link-text-color);
            }
            
            .resetsearch pebble-button::shadow paper-button {
                font-size: var(--font-size-xs);
            }
            
            .resetsearch pebble-button::shadow iron-icon {
                width: 14px !important;
                height: 14px!important;
                margin-right: 2px;
                margin-top: 3px;
            }
        </style>
        <rock-layout>
            <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-discovery"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <rock-titlebar icon="pebble-md-icons:Advancesearch" title="Entity Search & Discovery" closable minimizable>
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="[[getConfig('rock-dimension-selector')]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <rock-header>
                <div class="fixed-content">
                    <div class="layout horizontal">
                        <div class="flex">
                            <!-- search bar-->
                            <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                            <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                            <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                                <pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                            </div>
                        </div>
                        <div>
                            <!-- Saved Search button & its popover-->
                            <pebble-button id="savedSearchButton" icon="pebble-md-icons:SavedSearch" button-text="Load Saved Search" noink raised dropdown-icon
                                on-tap="_onSavedSearchTap" class="dropdownIcon dropdownText btn dropdown-outline-primary"></pebble-button>
                            <pebble-popover id="savedSearchPopover" for="savedSearchButton" auto-fit-on-attach no-overlap horizontal-align="right" allow-multiple>
                                <rock-saved-searches id="rockSavedSearch" saved-searches="{{_savedSearches}}" saved-search-id="{{_savedSearchId}}" show-title
                                    allow-create-edit-search show-settings></rock-saved-searches>
                            </pebble-popover>
                            <bedrock-pubsub event-name="saved-search-save" handler="_onCreateEditSavedSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="saved-search-cancel" handler="_onCancelSavedSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="actions-parent-button-tap" handler="_loadSavedSearch" target-id=""></bedrock-pubsub>
                        </div>
                    </div>
                    <div class="layout horizontal p-t-10">
                        <div class="flex searchFilterTag">
                            <!-- Search Filter Tags -->
                            <rock-entity-search-filter id="searchFilter" _selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                types-criterion="[[_typesCriterion]]" tags="{{tags}}"></rock-entity-search-filter>
                            <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
                        </div>
                        <div class="action-buttons">
                            <!-- Actions buttons and its popover -->
                            <pebble-actions id="assignmentActions" hidden button-icon="pebble-md-icons:assignedactions" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
                                button-text="Assignment Actions" actions-data="[[getConfig('assignment-actions')]]"></pebble-actions>
                            <pebble-button class="btn btn-primary m-r-5" button-text="Quick Manage" on-tap="_onTapQuickManage"></pebble-button>
                            <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                            <pebble-actions id="actionsButton" button-icon="pebble-md-icons:actions" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
                                button-text="Actions" actions-data="[[getConfig('pebble-actions')]]"></pebble-actions>
                        </div>
                    </div>
                </div>
                <div class="shrunk-content">
                </div>
            </rock-header>
            <div class="layout horizontal">
                <div id="entityGridContainer" class$="[[_applyClass(_quickManageEnabled)]]">
                    <rock-entity-search-grid id="entitySearchGrid" context-data="[[contextData]]" grid-config="[[getConfig('rock-entity-search-grid')]]"
                        search-filters="[[_selectedSearchFilters]]" search-query="[[_searchQuery]]" workflow-criterion="[[_workflowCriterion]]"
                        total-records="{{_gridFullLength}}" saved-search-id="[[_savedSearchId]]"></rock-entity-search-grid>
                    <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
                </div>
                <template is="dom-if" if="[[_quickManageEnabled]]">
                    <div>
                        <pebble-vertical-divider></pebble-vertical-divider>
                    </div>
                    <div class="quick-manage-container p-20">
                        <rock-entity-quick-manage id="entityQuickManage" context-data="[[contextData]]" current-index="{{_currentIndex}}" total-records="[[_gridFullLength]]"
                            selected-entity="[[_selectedEntity]]" tab-config="{{getConfig('rock-entity-quick-manage', '', 'rock-tabs')}}"
                            toolbar-config="{{getConfig('rock-entity-quick-manage', '', 'pebble-toolbar')}}" fixes="{{getConfig('rock-entity-quick-manage', '', 'rock-entity-tofix')}}"></rock-entity-quick-manage>
                        <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                        <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                        <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                    </div>
                </template>
            </div>
        </rock-layout>
        <bedrock-pubsub event-name="app-context-changed" handler="_onAppContextChanged"></bedrock-pubsub>
        <liquid-rest id="entityWfAssignment" url="/pass-through/entitygovernservice/workflowChangeAssignment" method="POST" request-data={{_wfAssignmentRequest}}
            on-liquid-response="_onAssignmentSuccess" on-liquid-error="_onAssignmentFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-entity-discovery',
                properties: {
                    _searchResponse: {
                        type: Object,
                        value: undefined,
                        notify: true,
                        observer: '_searchResponseChanged'
                    },
                    _searchResultResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    _savedSearchId: {
                        type: String
                    },
                    _savedSearches: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_savedSeachesChanged'
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () { return {}; },
                        computed: 'getConfig("rock-entity-search-grid")',
                        observer: '_onGridConfigChange'
                    },
                    _typesCriterion: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _quickManageEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _currentIndex: {
                        type: Number,
                        value: -1
                    },
                    _gridFullLength: {
                        type: Number,
                        value: 0
                    },
                    /**
                     * Indicates selected item
                     */
                    _selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _searchQuery: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    _workflowCriterion: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _rockEntitySearchFilter: {
                        type: Object
                    },
                    _rockSearchFilter: {
                        type: Object
                    },
                    _rockSavedSearch: {
                        type: Object
                    },
                    _currentWorkflowAction: {
                        type: String
                    },
                    _currentEntityIndex: {
                        type: Number,
                        value: 0
                    },
                    _wfAssignmentRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _selectedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    selectedEntityIds:{
                        type:Array,
                        value:function(){
                            return [];
                        }
                    },
                    _selectedSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _resetSearchEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _failedEntityType: {
                        type:String,
                    },
                    failedEntityIds: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    successEntityIds: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior
                ],

                ready: function () {
                    this.$$("#searchBar").searchInput = [];

                    //get saved search id from query string
                    var _savedSearchId = DataHelper.getParamValue('_savedSearchId');
                    var workflowName = DataHelper.getParamValue('wfName');
                    if (_savedSearchId && _savedSearchId != this._savedSearchId) {
                        this._savedSearchId = _savedSearchId;
                    } else if (!_.isEmpty(workflowName)) {
                        var workflowActivityName = DataHelper.getParamValue('wfActivityName');
                        var businessConditionName = DataHelper.getParamValue('bcId');
                        var user = DataHelper.getParamValue('user');
                        var userId = "";

                        if(user.toLowerCase() == "all") {
                            userId = "";
                        } else if(user.toLowerCase() == "currentuser") {
                            userId = DataHelper.getUserId();
                        } else if (user.toLowerCase() == "unassigned") {
                            userId = "_UNASSIGNED";
                        }

                        var workflowCriterion = {
                            "workflowName": workflowName,
                            "workflowActivityName": workflowActivityName,
                            "businessConditionName": businessConditionName,
                            "userId": userId
                        };

                        if (!_.isEmpty(workflowCriterion)) {
                            this._workflowCriterion = workflowCriterion;
                            this.$$("#assignmentActions").hidden = false;
                        }
                    }

                    this._searchQuery = DataHelper.getParamValue('searchtext');
                },
                attached: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];

                    if (DataHelper.getParamValue('searchtext')) {
                        this.$$('#searchBar').query = this._searchQuery;
                    }
                },
                _onApplicationConfigReceived: function (e) {
                    //console.log('Received configs ', JSON.stringify(e, null, 2));
                    this.set('applicationConfig', e.detail);
                },
                // Refine Filter
                //Capture typesCriterion for Refine Filter
                _onGridConfigChange: function () {
                    if (this._gridConfig && !_.isEmpty(this._gridConfig)) {
                        this._typesCriterion = this._gridConfig.dataRequest.typesCriterion;
                    }
                },

                //Rock search
                _onSearch: function (e, detail, sender) {
                    this._searchQuery = detail;
                },

                //Rock search clear
                _resetSearch: function () {
                    var defaultButtonText = "Saved Search";

                    this._searchQuery = '';
                    this.tags = [];

                    var rockSavedSearchElement = this.$$("#rockSavedSearch");
                    if (rockSavedSearchElement) {
                        rockSavedSearchElement.buttonText = defaultButtonText;
                    }

                    var rockSearchBar = this.$$('#searchBar');
                    if (rockSearchBar) {
                        rockSearchBar.query = "";
                    }

                    this._selectedSearchFilters = [];
                    this.$.searchFilter.clearSearchFilters();

                    this._resetSearchEnabled = false;
                },

                // Grid
                _getSearchGrid: function () {
                    return ElementHelper.getElement(this, "#entitySearchGrid");
                },
                _onSelectingGridItem: function (e, detail, sender) {
                    if (this._quickManageEnabled) {
                        this._selectedEntity = detail.item;

                        if (!_.isEmpty(this._selectedEntity)) {
                            var itemContext = {
                                'id': this._selectedEntity.id,
                                'type': this._selectedEntity.type
                            };
                            this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                            this._getSearchGrid().clearSelection();
                            this.async(function () {
                                this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                            });
                        }
                    }
                },
                _onAttributeSave: function (e, detail, sender) {
                    //Changing the row style of the updated record
                    var selectedRow = this._getSearchGrid().getSelectedGridRow();
                    selectedRow.style['font-style'] = 'italic';
                },
                _applyClass: function () {
                    if (this._quickManageEnabled) {
                        return "quick-manage-container";
                    }

                    return "container";
                },
                _onTapQuickManage: function () {
                    this._quickManageEnabled = !this._quickManageEnabled;
                    var grid = this._getSearchGrid();

                    if (this._quickManageEnabled) {
                        var selectedItem = grid.selectedItem;
                        this._selectedEntity = selectedItem;

                        if (!_.isEmpty(selectedItem)) {

                            var itemContext = {
                                'id': selectedItem.id,
                                'type': selectedItem.type
                            };
                            this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                            grid.clearSelection(); //Clear current selection
                            grid.selectItem(selectedItem); //Select item
                            this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                            grid.scrollToIndex(this._currentIndex);
                        }
                    } else {
                        this._currentIndex = -1;
                    }

                    grid.notifyResize();
                },
                _onClickPrevious: function (e, detail, sender) {
                    if (this._currentIndex > 0) {
                        this._selectEntity(this._currentIndex - 1, 'previous');
                    }
                },
                _onClickNext: function (e, detail, sender) {
                    if (this._currentIndex < this._gridFullLength) {
                        this._selectEntity(this._currentIndex + 1);
                    }
                },
                _selectEntity: function (index, nav) {
                    if (!(index < 0)) {
                        var grid = this._getSearchGrid();
                        var gridData = grid.getData();

                        if (gridData.length > 0 && index < this._gridFullLength) {
                            if (gridData[index].attributes) {
                                this._selectedEntity = gridData[index];

                                var itemContext = {
                                    'id': this._selectedEntity.id,
                                    'type': this._selectedEntity.type
                                };
                                this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                                this._currentIndex = index;
                                grid.clearSelection();
                                grid.selectItem(gridData[index]);

                                //On previous click already data got loaded, so directly we can set scroll index
                                //but for next, data will loaded as per page size, so scroll as per allow scroll
                                if (nav == 'previous' || this._isAllowedToScroll()) {
                                    grid.scrollToIndex(this._currentIndex);
                                }
                            } else {
                                var nextScrollIndex = grid.totalRecords + grid.pageSize;
                                // Todo: nextScrollIndex will be based on the grid total count
                                grid.scrollToIndex(nextScrollIndex);

                                this.async(function () {
                                    this._selectEntity(index);
                                }, 10);
                            }
                        }
                    }
                },
                _isAllowedToScroll: function () {
                    var grid = this._getSearchGrid();

                    if (((this._currentIndex) % grid.pageSize) == 0) {
                        return true;
                    }

                    return false;
                },

                // Saved Search
                _loadSavedSearch: function (e, detail, sender) {
                    if (detail) {
                        this._savedSearchId = detail.id;
                        document.querySelector("main-app").set('pageRoute.__queryParams', {
                            "_savedSearchId": detail.id.toString()
                        });
                    }
                },

                _onCancelSavedSearch: function (e, detail, sender) {
                    this.$$('#rockSavedSearch').$$('rock-tabs').$$('pebble-tab-group').notifyResize(); //To load tabs properly
                },

                _onCreateEditSavedSearch: function (e, detail, sender) {
                    if (detail) {

                        var _isUpdate = false;

                        //Check for permission to Update
                        if (!_.isEmpty(detail.selectedSearch)) {
                            var _currentUser = ContextHelper.getFirstUserContext(this.contextData);
                            _isUpdate = true;

                            if (_currentUser &&
                                _currentUser.user != detail.selectedSearch.user &&
                                _currentUser.role != "admin") //Todo: admin role may changed
                            {
                                this.showErrorToast("You do not have permissions to update the saved search, please contact administrator.");
                                return;
                            }
                        }

                        //Check duplicate for Create/Update
                        var _isSearchNameAlreadyExists = true;
                        if (this._getElement('rockSavedSearch')) {
                            _isSearchNameAlreadyExists = this._getElement('rockSavedSearch').isSearchNameAlreadyExists(detail, _isUpdate);
                        }
                        if (_isSearchNameAlreadyExists) {
                            this.showErrorToast("Search name is already exists, please create search with different name.");
                            return;
                        }

                        //Initiate
                        var _savedSearchDetails = {
                            "saved-search-info": "",
                            "search-query": "",
                            "workflowCriterion": this._workflowCriterion,
                            "search-tags": [],
                            "dimensions": {}
                        }

                        // create or edit form info
                        _savedSearchDetails["saved-search-info"] = detail;

                        // search input info
                        if (this.$$("#searchBar")) {
                            _savedSearchDetails["search-query"] = this.$$("#searchBar").query;
                        }

                        //search filters
                        if (this._getElement('rockEntitySearchFilter') && this._getElement('rockSearchFilter')) {
                            _savedSearchDetails["search-tags"] = this._getElement('rockSearchFilter').tags;
                        }

                        // dimension selectors info
                        var dimensionSelector = this.$.dimensionSelector;
                        if (dimensionSelector) {
                            _savedSearchDetails["dimensions"] = dimensionSelector.selectedDimensions;
                        }

                        if (detail.selectedSearch && !_.isEmpty(detail.selectedSearch)) {
                            if (this._getElement('rockSavedSearch')) {
                                this._getElement('rockSavedSearch').createUpdateSavedSearch(_savedSearchDetails, "update");
                                this.showSuccessToast([[detail.name]] + " is updated");
                        }

                            return;
                        }

                        //Use rock-saved-searches to create new search
                        if (this._getElement('rockSavedSearch')) {
                            this._getElement('rockSavedSearch').createUpdateSavedSearch(_savedSearchDetails, "create");
                            this.showSuccessToast([[detail.name]] + " is saved successfully");
                    }
                    }
                },

                _getElement: function (element) {
                    if (element == "rockEntitySearchFilter") {
                        if (!this._rockEntitySearchFilter) {
                            this._rockEntitySearchFilter = this.$$("#searchFilter");
                        }

                        return this._rockEntitySearchFilter
                    }
                    else if (element == "rockSearchFilter") {
                        if (!this._rockSearchFilter) {
                            this._rockSearchFilter = this._getElement("rockEntitySearchFilter").$$("rock-search-filter");
                        }

                        return this._rockSearchFilter
                    }
                    else if (element == "rockSavedSearch") {
                        if (!this._rockSavedSearch) {
                            this._rockSavedSearch = this.$$("rock-saved-searches");
                        }

                        return this._rockSavedSearch
                    }
                },

                // Get search list name & item index
                // Note - this will be removed once we integrated with liquid
                _getSearchListNameBySearchId: function (searchId) {
                    var _mySearch = 'my-searches',
                        _favSearch = 'favourites',
                        _sharedSearch = 'shared-searches';

                    if (this._savedSearches[_mySearch]) {
                        for (var idx = 0; idx < this._savedSearches[_mySearch].length; idx++) {
                            if (this._savedSearches[_mySearch][idx].id == searchId) {
                                return {
                                    "name": _mySearch,
                                    "index": idx
                                };
                            }
                        }
                    }

                    if (this._savedSearches.favourites) {
                        for (var idx = 0; idx < this._savedSearches.favourites.length; idx++) {
                            if (this._savedSearches.favourites[idx].id == searchId) {
                                return {
                                    "name": _favSearch,
                                    "index": idx
                                };
                            }
                        }
                    }

                    if (this._savedSearches[_sharedSearch]) {
                        for (var idx = 0; idx < this._savedSearches[_sharedSearch].length; idx++) {
                            if (this._savedSearches[_sharedSearch][idx].id == searchId) {
                                return {
                                    "name": _sharedSearch,
                                    "index": idx
                                };
                            }
                        }
                    }
                },
                _savedSeachesChanged: function (newValue, oldValue) {
                    if (newValue != oldValue) {
                        if (this._savedSearchId && this._savedSearches) {
                            var savedSearch = this._getSavedSearches(this._savedSearches, this._savedSearchId);
                            this._populateHeaderControls(savedSearch);
                            this.$$('rock-entity-search-grid').savedSearchCriterion = savedSearch;
                        }
                    }
                },
                _getSavedSearches: function (savedSearches, _savedSearchId) {
                    var savedSearch;
                    if (savedSearches) {
                        for (var category in savedSearches) {
                            var categorySavedSearches = savedSearches[category];
                            if (categorySavedSearches && categorySavedSearches.length > 0) {
                                for (var i = 0; i < categorySavedSearches.length; i++) {
                                    if (categorySavedSearches[i].id == _savedSearchId) {
                                        savedSearch = categorySavedSearches[i];
                                        break;
                                    }
                                }
                                if (savedSearch) {
                                    break;
                                }
                            }
                        }
                    }
                    return savedSearch;
                },
                _populateHeaderControls: function (savedSearch) {
                    if (savedSearch) {
                        // search input info
                        var searchBarElement = this.$$("#searchBar");
                        if (searchBarElement) {
                            searchBarElement.query = savedSearch.searchQuery;
                        }

                        // search filter info
                        var searchFilter = this.$$("#searchFilter");
                        if (searchFilter) {
                            searchFilter.tags = savedSearch.searchTags ? savedSearch.searchTags : [];

                            this._selectedSearchFilters = [];
                            if (!_.isEmpty(searchFilter.tags)) {
                                for (var i = 0; i < searchFilter.tags.length; i++) {
                                    var attr = {};
                                    attr[searchFilter.tags[i].name] = searchFilter.tags[i].value;
                                    this.push('_selectedSearchFilters', attr);
                                }
                            }
                        }

                        // dimensionselector info
                        var dimensionSelector = this.$.dimensionSelector;
                        if (dimensionSelector) {
                            dimensionSelector.selectedDimensions = savedSearch.dimensions;
                            dimensionSelector.$$('rock-entity-lov').refershTemplate();
                        }

                        var _savedSearchButton = this.$$("#savedSearchButton");
                        if (_savedSearchButton) {
                            _savedSearchButton.buttonText = savedSearch.name;
                        }
                        this._searchQuery = savedSearch.searchQuery;

                        if (!_.isEmpty(savedSearch.workflowCriterion)) {
                            this._workflowCriterion = savedSearch.workflowCriterion;
                        }
                    }
                },
                _searchResponseChanged: function (_searchResponse) {
                    if (!_searchResponse || !_searchResponse.content || _searchResponse.content.totalRecords ==
                        0) {
                        this._searchResultResponse = {
                            "content": {
                                "entities": {}
                            }
                        };
                    }
                },
                // Saved Search

                // Action Button
                _onActionsTap: function (e) {
                    this.$$('#actionsPopover').show();
                },
                _onActionItemTap: function (e, detail, sender) {
                    this.successEntityIds = [];
                    this.failedEntityIds = [];
                    this.selectedEntityIds = [];
                    this._currentEntityIndex = 0;
                    var searchGrid = this.$$("#entitySearchGrid");
                    if (searchGrid && searchGrid.selectedItems && searchGrid.selectedItems.length > 0) {
                        if (searchGrid.selectedItems.length > 5) {
                            this.showErrorToast("Maximum 5 entities can be selected.");
                            return;
                        } else {
                            this._selectedEntities = searchGrid.selectedItems;
                            var selectedEntityIds = [];
                            for (var i in searchGrid.selectedItems) {
                                if (searchGrid.selectedItems[i].id) {
                                    selectedEntityIds.push(searchGrid.selectedItems[i].id);
                                }
                            }
                            this.set('selectedEntityIds', selectedEntityIds)
                        }
                    } else {
                        this.showErrorToast("Select atleast one entity for which you want to perform this action.");
                        return;
                    }
                    if (detail) {
                        if (detail.data.eventName == "action-takeTask") {
                            this._currentWorkflowAction = "take";
                        }
                        if (detail.data.eventName == "action-releaseTask") {
                            this._currentWorkflowAction = "release";
                        }
                        this._generateAssignmentRequest();
                    }
                },
                _onAppContextChanged: function (e) {
                    if (this.verbose) {
                        console.log("AppContext:- " + JSON.stringify(e.detail.contextData));
                    }

                    this.contextData = {}; // To notify
                    this.contextData = e.detail.contextData;

                    //this.$$("#getEntityDiscoveryAppConfig").refresh();

                    if (this._quickManageEnabled) {
                        if (this.$$("#entityQuickManage")) {
                            this.$$("#entityQuickManage").reload();
                        }
                    } else {
                        this.$$("#entitySearchGrid").refresh();
                    }
                },
                _onSavedSearchTap: function (e) {
                    this.$$('#rockSavedSearch').contextData = this.contextData;
                    this.$$('#savedSearchPopover').show();
                },
                _generateAssignmentRequest: function () {
                    var req = DataRequestHelper.createWfChangeAssignmentRequest(this._selectedEntities[this._currentEntityIndex], this._workflowCriterion, this.contextData, this._currentWorkflowAction);
                    this.set("_wfAssignmentRequest", req);
                    var liquidWfAssign = this.$$("#entityWfAssignment");
                    if (liquidWfAssign) {
                        liquidWfAssign.generateRequest();
                    }
                },
                 _onAssignmentSuccess: function (e) {
                    var response = e.detail.response;
                    var failedEntityIds = this.failedEntityIds;
                    var successEntityIds = this.successEntityIds;
                    var requestId;
                    if (e.detail.request && e.detail.request.requestData && e.detail.request.requestData.entity && e.detail.request.requestData.entity.id) {
                        requestId = e.detail.request.requestData.entity.id;
                    }
                    if (requestId && response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                        var statusDetail = response.response.statusDetail;
                        if (failedEntityIds.indexOf(requestId)<0 && statusDetail.messages && statusDetail.messages.length > 0) {
                            this._failedEntityType = this._selectedEntities[this._currentEntityIndex].type;
                            this.push('failedEntityIds',requestId);
                        } else if(successEntityIds.indexOf(requestId) < 0 && statusDetail.message) {
                            this._successEntityType = this._selectedEntities[this._currentEntityIndex].type;
                            this.push('successEntityIds',requestId);
                        }
                    this._currentEntityIndex++;
                    }
                    if (this._currentEntityIndex < this._selectedEntities.length) {
                        this._generateAssignmentRequest();
                    } else if(response && response.response && response.response.status && response.response.status.toLowerCase() == "success" && response.response.statusDetail) {
                            var messageObject = this._getMessageObject();
                            this._showToastMessage(messageObject);                 
                        }
                        else{
                            this.showErrorToast("There is some problem with the server.Please try again after some time");
                        }
                },
                _onAssignmentFailure: function (e) {
                    console.warn("Failed to perform the workflow assignment with error: ", e.detail);
                    this.showErrorToast("Failed to perform the workflow assignment. Please contact administrator.");
                },
                _showResetSearch: function (e) {
                    var rockSearchBar = this.$$('#searchBar');
                    var rockSearchFilter = this._getElement('rockSearchFilter');
                    var query = '';
                    var tags = [];

                    if (rockSearchBar) {
                        query = rockSearchBar.query;
                    }

                    if (rockSearchFilter) {
                        tags = rockSearchFilter.tags;
                    }

                    if (!_.isEmpty(query) || tags.length > 0) {
                        this._resetSearchEnabled = true;
                    } else {
                        this._resetSearchEnabled = false;
                    }
                },
                _showToastMessage: function(msgObject) {
                    if(msgObject) {
                        if(msgObject.type == "error") {
                            this.showErrorToast(msgObject.message, 10000);
                        } else if(msgObject.type == "success") {
                            this.showSuccessToast(msgObject.message, 10000);
                        }
                    }
                },
                _getMessageObject: function() {
                    var stringifiedSelectedEntityIds = JSON.stringify(this.selectedEntityIds);
                    var stringifiedsuccessEntityIds;
                    var stringifiedfailedEntityIds;
                    var messageObject = {
                        "message": "",
                        "type": ""
                    };
                    if(this.successEntityIds){
                        stringifiedsuccessEntityIds = JSON.stringify(this.successEntityIds)
                    }
                    if(this.failedEntityIds){
                        stringifiedfailedEntityIds  =  JSON.stringify(this.failedEntityIds) 
                    }
                    if(this._currentWorkflowAction == "take") {
                        if(this.successEntityIds.length == this.selectedEntityIds.length && this.selectedEntityIds.length == 1) {
                            messageObject.message = "The {0} of type {1} selected is in {1} as part of the {2} business process has been assigned to you. ".format(this.successEntityIds[0], this._successEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                            messageObject.type = "success";
                        }
                        if(this.failedEntityIds.length == this.selectedEntityIds.length && this.selectedEntityIds.length == 1) {
                            messageObject.message = "The {0} of type {1} selected is in {2} as part of the {3} business process. You do not have permissions as part of this workflow step to take the workflow step for assignment. /nPlease contact your business administrator if you need to be assigned to this role.".format(this.successEntityIds[0],this._failedEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                            messageObject.type = "error";
                        }
                        if (stringifiedSelectedEntityIds == stringifiedsuccessEntityIds) {
                            messageObject.message = "The {0} of type {1} selected is in {2} as part of the {3} business process has been assigned to you.".format(stringifiedsuccessEntityIds, this._successEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                            messageObject.type = "success";
                        } else if(stringifiedSelectedEntityIds == stringifiedfailedEntityIds) {
                                messageObject.message = "The {0} of {1} selected is in {2} as part of the {3} business process. You do not have permissions as part of this workflow step to take the entities for assignment. /nPlease contact your business administrator if you need to be assigned to this role.".format(stringifiedSelectedEntityIds, this._failedEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                                messageObject.type = "error";
                        }
                    } else if(this._currentWorkflowAction == "release") {
                        if(this.successEntityIds.length == this.selectedEntityIds.length == 1) {
                            messageObject.message = "The {0} of type {1} selected is in {1} as part of the {2} business process has been released from you. ".format(this.successEntityIds[0], this._successEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                            messageObject.type = "success";
                        }
                        if(this.failedEntityIds.length == this.selectedEntityIds.length == 1) {
                            messageObject.message = "The {0} of type {1} selected is in {2} as part of the {3} business process. You do not have permissions as part of this workflow step to release the workflow step from assignment. /nPlease contact your business administrator if you need to be released from this role.".format(this.successEntityIds[0],this._failedEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                            messageObject.type = "error";
                        }
                        if (stringifiedSelectedEntityIds == stringifiedsuccessEntityIds) {
                            messageObject.message = "The {0} of type {1} selected are in {2} as part of the {3} business process have been released from you.".format(stringifiedsuccessEntityIds, this._successEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                            messageObject.type = "success";
                        } else if(stringifiedSelectedEntityIds == stringifiedfailedEntityIds) {
                                messageObject.message = "The {0} of {1} selected is in {2} as part of the {3} business process. You do not have permissions as part of this workflow step to release the entities from assignment. /nPlease contact your business administrator if you need to be released from this role.".format(stringifiedSelectedEntityIds, this._failedEntityType, this._workflowCriterion.workflowActivityName, this._workflowCriterion.workflowName);
                                messageObject.type = "error";
                        }
                    }
                    return messageObject;
                }
            });
        })();
    </script>
</dom-module>