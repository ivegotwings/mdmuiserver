<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/paper-button/paper-button.html" />
<link rel="import" href="../../../bower_components/paper-item/paper-item.html" />
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html" />
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html" />
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html"/>
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html" />

<!--
`<pebble-button>` Represents a button with Material Design styling. It exhibits bahaviour of a simple button as well a button with dropdown menu. 
 
 In simple button mode, a ripple effect emanates from the point of contact when the user touches the button. It may be flat or raised. A raised button is styled with a shadow.
  
 Dropdown menu mode allows the user to compose a designated "trigger" element with another element. 
 This represents "content" to create a dropdown menu that displays the "content" when the "trigger" is clicked.
 The child element with the class dropdown-trigger is used as the "trigger" element. The child element with the class dropdown-content is used as the "content" element.
 The pebble-button is sensitive to its content's iron-select events. If the "content" element triggers an iron-select event, the pebble-button will close automatically.

###Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--pebble-button-background-color`       | Menu background color                      | `--primary-background-color`
`--pebble-button-foreground-color`       | Menu foreground color                      | `--primary-text-color`
`--pebble-button`                        | Mixin applied to the pebble button         | `{}`
`--pebble-button-hover`                  | Mixin applied to hover                     | `{}`
`--pebble-button-iron-icon`              | Mixin applied to the icon                  | `{}`
`--pebble-menu-button`                   | Mixin applied to the paper menu button     | `{}`
`--pebble-button-paper-menu`             | Mixin applied to the paper menu            | `{}`
`--pebble-button-paper-menu-item`        | Mixin applied to the paper menu item       | `{}`
`--pebble-button-menu-item-icon`         | Mixin applied to the paper menu item icon  | `{}`

###Accessibility

`<pebble-button>` by default behaves as a simple button. When button-menu attribute is specified in the markup, button will have dropdown menu.  
 
 Use the icon property to display an icon.
 
 Use the button-text property to display text.
 
 Use available mixins for mouse over, color, ripple, elevation and any other css properties.

@group Pebble Elements
@element pebble-button
@demo demo/index.html
-->

<dom-module id="pebble-button">
  <template>
      <style>

        paper-button{            
            background: var(--pebble-button-background-color);
            color: var(--pebble-button-foreground-color);
            text-transform: none;
            @apply(--pebble-button);          
        }

        paper-button:hover{      
            @apply(--pebble-button-hover);                                 
        }

        paper-button iron-icon{
            @apply(--pebble-button-iron-icon);
        }

        paper-menu-button{
            @apply(--pebble-menu-button);
        }

        paper-menu-button paper-menu{            
            @apply(--pebble-button-paper-menu);
        }

        paper-menu-button paper-menu paper-item {
            @apply(--pebble-button-paper-menu-item);
        }

        paper-menu-button paper-menu paper-item iron-icon{
            @apply(--pebble-button-menu-item-icon);
        }

        paper-menu-button paper-button{
            background: var(--pebble-button-background-color);
            color: var(--pebble-button-foreground-color);
            text-transform: none;
            @apply(--pebble-button);
        }

        paper-menu-button paper-button iron-icon{
            @apply(--pebble-button-iron-icon);
        }

      </style>
        	<template is="dom-if" if="[[!menuButton]]" >
                <paper-button id="simpleButton"                   
                    raised$="[[raised]]" 
                    elevation$="[[elevation]]"
                    noink$= "[[noink]]"
                    toggles$= "[[toggles]]"
                    disabled$= "[[disabled]]"
                >
                    <template is="dom-if" if="[[icon]]" >
                        <iron-icon icon$="[[icon]]"></iron-icon>   
                    </template>
                    <template is="dom-if" if="[[buttonText]]" >
                       [[buttonText]]  
                    </template>
                </paper-button>
            </template>
            <template is="dom-if" if="[[menuButton]]">
                <paper-menu-button id="menuButton"
                        allow-outside-scroll$="[[allowOutsideScroll]]"
                        dynamic-align$="[[dynamicAlign]]"
                        horizontal-align$="[[horizontalAlign]]"
                        vertical-align$="[[verticalAlign]]"
                        horizontal-offset$="[[horizontalOffset]]"
                        vertical-offset$="[[verticalOffset]]"                        
                        no-animations$="[[noAnimations]]"
                        no-overlap$="[[noOverlap]]"       
                    >
                    <paper-button id="button"
                        class="dropdown-trigger"
                        raised$="[[raised]]" 
                        elevation$="[[elevation]]"
                        noink$= "[[noink]]"
                        toggles$= "[[toggles]]" 
                        disabled$= "[[disabled]]"                                   
                    >
                        <template is="dom-if" if="[[icon]]" >
                            <iron-icon id="pebbleIcon" icon$="[[icon]]"></iron-icon>   
                        </template>
                        <template is="dom-if" if="[[buttonText]]" >
                            [[buttonText]]
                        </template>
                        <template is="dom-if" if="[[dropdownIcon]]" >                        
                            <iron-icon icon="arrow-drop-down"></iron-icon>
                        </template>
                    </paper-button>

                    <paper-menu id="paperMenu" class="dropdown-content" selected="{{selectedIndex}}">
                        <template is="dom-if" if="{{itemData}}">
                            <template is="dom-repeat" items="{{itemData}}" as="button" selected="{{selectedIndex}}" >
                                <paper-item data="[[button]]" on-tap="_onTap">
                                    <template is="dom-if" if="{{button.icon}}" >                        
                                        <iron-icon icon$={{button.icon}}></iron-icon>
                                    </template> 
                                    <span>{{button.text}}</span>
                                </paper-item>
                            </template>
                        </template>
                        <template is="dom-if" if="[[_ItemsExist()]]">
                            <template is="dom-repeat" items="{{itemsArray}}" selected="{{selectedIndex}}">
                                <paper-item><span>{{item}}</span></paper-item>
                            </template>
                        </template>
                        
                    </paper-menu>
                </paper-menu-button>
            </template>
  </template>
</dom-module>

<script>   
      Polymer({
        is: 'pebble-button',        
        properties: {
            /**
             * Indicates that the button is styled with a shadow if the value is <b>true</b>.
             */
            raised: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates the z-depth of this element from 0-5. Setting to 0 will remove the shadow, and 
             * each increasing number greater than 0 will be "deeper" than the last.
             */
            elevation: {
                type: Number,
                value: 0,
               notify: true
            },
            /**
             * Indicates that the button toggles the active state with each tap or press of the spacebar if the value is <b>true</b>.
             */
            toggles: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that the element does not produce a ripple effect when interacted via the pointer if the value is <b>true</b>.
             */
            noink: {
                type: Boolean,
                value : false,
                notify: true
            },
            /**
             * Indicates that an element opens a menu on a button click, if the value is set to <b>true</b>.
             */
            menuButton: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates icon if the value is set.
             */          
            icon: {
                type: String,
                value: function() { return null; }  

            },
            /**
             * Indicates the button text if the value is set.
             */
            buttonText: {
                type: String,
                value: function() { return null; },
                reflectToAttribute: true,
                notify: true
            },
            /**
             * Indicates the list of items from which a selection can be made.
             */
            items: {
                type: String,
                value: function() { return null; }
            },
            /**
             * Indicates the list of items which are bound to menu.
             */
            itemsArray: {
                type: Array,
                value: function() { return null; },                
                computed: "_splitItems(items)",
                observer: "_itemsChanged"
            },
            /**
             * Indicates the currently selecetd index.
             */
            selectedIndex: {
                type: Number,
                value: -1,
                observer: "_selectedIndexChanged"
            },
            /**
             * Indicates the currently selected value.
             */
            selectedValue: {
                type: String,                
                notify: true,
                observer: "_selectedValueChanged"
            },
            /**
             * Indicates that the dropdown constrains scroll on the page to itself when opened by default. 
             * Set it to <b>true</b> to prevent this constraint on scroll.
             */
            allowOutsideScroll: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that instead of "strict requirements", `horizontalAlign` and `verticalAlign` properties 
             * are considered when the dropdown is positioned. If the valus is set to <b>true<\b>, it reduces
             * the area of the dropdown falling outside of `fitInto`.
             */
            dynamicAlign: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates the orientation to align the menu dropdown horizontally relative to the dropdown trigger.
             */
            horizontalAlign: {
                type: String,
                value: "right",
                notify: true
            },
            /**
             * Indicates the orientation to align the menu dropdown vertically relative to the dropdown trigger.
             */
            verticalAlign: {
                type: String,
                value: "bottom",
                notify: true
            },
           /**
            * Indicates the pixel value. This is added to the calculated position value for the
            * given `horizontalAlign` property. You can use a negative value to offset to the
            * left, or a positive value to offset to the right.
            */
            horizontalOffset: {
                type: Number,
                value: 0,
                notify: true
            },
           /**
            * Indicates the pixel value. This is added to the calculated position value for the
            * given `verticalAlign` property. You can use a negative value to offset towards the
            * top, or a positive value to offset towards the bottom.
            */
            verticalOffset: {
                type: Number,
                value: 0,
                notify: true
            },
            /**
             * Indicates that animations are disabled when opening and closing the
             * dropdown if the value is set to true.
             */
            noAnimations: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that the dropdown is positioned so that it doesn't overlap
             * the button if the value is set to true.
             */
            noOverlap: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that the menu button will have the dropdown arrow icon
             * if the value is set to true.
             */
            dropdownIcon: {
                type: Boolean,
                value: false
            },
            /**
             * Returns the array of objects which are ready to be bound to menu.
             */
            itemData: {
                type: Array,
                value: function(){ return []; }
            }
        },
        ready: function(){   
         if(this.menuButton){
            if(this.itemsArray != null){
                for(var i=0; i < this.itemsArray.length; i++){
                        if(this.itemsArray[i] == this.selectedValue){
                        this.selectedIndex = i;
                        break;
                    }
                }
            }
         }
        },
        _ItemsExist: function(){
            var flag = true;
            if( this.itemData != null && this.itemData.length > 0 ){
                flag = false;
            }
            return flag; 
        },
        _splitItems: function(i) {
            if(i != undefined){
                return i.split(",");
            }else{
                return null;
            }
        },
        _selectedIndexChanged: function(newValue, oldValue){
         if(newValue !== undefined && this.itemsArray) {
            if(this.selectedValue != this.itemsArray[newValue]) {
              this.selectedValue = this.itemsArray[newValue];
              this.fire('change', {"newValue": newValue, "oldValue": oldValue});
            }
          }
        },
        _selectedValueChanged: function(newValue, oldValue){
            this._setNewIndex(this.itemsArray, newValue);
        },
        _itemsChanged: function(newValue, oldValue){
           this._setNewIndex(newValue, this.selectedValue);
        },
        _setNewIndex(newItemsArray, newSelectedValue) {
          var newIndex = -1;
          if(newItemsArray !== undefined && newSelectedValue !== undefined) {
            for(var i=0;i<newItemsArray.length;i++) {
              if(newItemsArray[i] == newSelectedValue) {
                newIndex = i;
                break;
              }  
            }            
            if(this.selectedIndex != newIndex) {
              this.selectedIndex = newIndex;
            }
          }
        },
        _onTap: function(e) {                                              
            var eventDetail= {
		      name: e.currentTarget.data.eventName,
		      data: e.currentTarget.data
		    }      
            this.fire('bedrock-event', eventDetail);               
        }
    });
  </script>
