<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/paper-button/paper-button.html" />
<link rel="import" href="../../../bower_components/paper-item/paper-item.html" />
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html" />
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html" />
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html" />
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">

<!--
`<pebble-button>` Represents a button with material design styling. It exhibits the bahaviour of a 
simple button as well as a button with a drop-down menu. 
 
 In a simple button mode, a ripple effect emanates from the point of contact when the user touches the button. 
 It may be flat or raised. A raised button is styled with a shadow.
  
 The drop-down menu mode allows the user to compose a designated "trigger element" with another element. 
 This indicates the content to be created in a drop-down menu that displays the content when the 
 "trigger" is clicked. The child element with the class drop-down trigger is used as the trigger element. 
 The child element with the class drop-down content is used as the content element.
 The pebble-button is sensitive to its content's iron-select events. If the content element triggers an iron-select event, the pebble-button gets closed automatically.

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--pebble-button-background-color`       | Menu background color                      | `--primary-background-color`
`--pebble-button-foreground-color`       | Menu foreground color                      | `--primary-text-color`
`--pebble-button`                        | Mixin applied to the pebble button         | `{}`
`--pebble-button-hover`                  | Mixin applied to hover                     | `{}`
`--pebble-button-notraised`              | Mixin applied to pebble button (not raised)| `{}`
`--pebble-button-iron-icon`              | Mixin applied to the main icon             | `{}`
`--pebble-button-dropdown-icon`          | Mixin applied to the dropdown icon         | `{}`
`--pebble-menu-button`                   | Mixin applied to the paper menu button     | `{}`
`--pebble-button-paper-menu`             | Mixin applied to the paper menu            | `{}`
`--pebble-button-paper-menu-item`        | Mixin applied to the paper menu item       | `{}`
`--pebble-button-menu-item-icon`         | Mixin applied to the paper menu item icon  | `{}`
`--actions-icon-button`                  | Mixin applied to actions paper icon button | `{}`

### Accessibility

`<pebble-button>` by default behaves as a simple button. When the button-menu attribute is specified in the markup, the button will be a drop-down menu.  
 
 Use the icon property to display an icon.
 
 Use the button-text property to display text.
 
 Use available mixins for mouse over, color, ripple, elevation and any other css properties.

@group Pebble Elements
@element pebble-button
@demo demo/index.html
-->

<dom-module id="pebble-button">
    <template>
        <style include="pebble-styles-shared">
            :host {               
                --paper-button-raised-keyboard-focus: {
                    font-weight: normal;
                }
                --paper-button-flat-keyboard-focus: {
                    font-weight: normal;
                }          
            }

            paper-button:hover {
                box-shadow: none;
                transition: none;
                -webkit-transition: none;
            }   

            paper-button {
                text-transform: none;
                border-radius: 3px;
                @apply(--pebble-button);
                box-shadow: none!important;
                transition: none!important;
                -webkit-transition: none!important;
                /* Safari 3.1 to 6.0 */
            }

            paper-button:not([raised]) {
                font-size: var(--default-font-size, 14px);
                @apply(--pebble-button-notraised);
            }         

            #leftIcon {
                margin-right:5px;
                width: 16px;
                height: 16px;
                @apply (--pebble-button-left-icon);  
            }

            #rightIcon {
                width: 20px;
                height: 20px;
                margin-left: 5px;
                @apply(--pebble-button-right-icon);
            } 

            paper-menu-button {
                @apply(--pebble-menu-button);
                padding: 0;
            }

            paper-menu-button paper-menu {
                padding: 10px 0;
                @apply(--pebble-button-paper-menu);
            }

            paper-menu-button paper-menu paper-item {
                cursor: pointer;
                font-size: var(--default-font-size, 14px);
                @apply(--pebble-button-paper-menu-item);
            }

            paper-menu-button paper-menu paper-item iron-icon {
                @apply(--pebble-button-menu-item-icon);
            }

            paper-menu-button paper-button {
                /*background: var(--pebble-button-background-color);
                color: var(--pebble-button-foreground-color);*/
                text-transform: none;
                @apply(--pebble-button);
            }

            paper-menu-button paper-button iron-icon {
                @apply(--pebble-button-iron-icon);
            }

            paper-icon-button {
                @apply(--actions-icon-button);
            } 
            paper-icon-button:not([direction]) {
                @apply(--attribute-mapping-grid);
            }   

            #actionParentButton {
                border-top-right-radius: 0px;
                border-bottom-right-radius: 0px;
                margin:0;
                font-weight: 400;
                padding:0px 0px 0px 10px;
            }

            #actionButton { 
                border-top-right-radius: 3px;
                border-bottom-right-radius: 3px;
                padding: 0px;
                height: 28px;
                display: inline-block;
                vertical-align: top;
                margin: 2px 4px 0px 0px;
            }

            #actionButton::shadow #trigger {
                margin-top: 2px;
            }

            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--default-font-size);
                min-height: 24px;
            }

            pebble-popover paper-item iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                /*color: var(--favorite-icon-border-color, #F6D40C);*/
                color: var(--toast-font-color, #4b4e51) !important;
            }

            #customIcon {
                @apply(--pebble-custom-icon-height);
            }
            #buttonTextBox {
                  @apply(--paper-button-text);
                  line-height: 14px;
              }
            paper-button{
                @apply(--pebble-button-paper-style);
            }
            /* IE11 specific stying */
              @media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {   
                  #leftIcon {
                     margin:0;           
                 }
              }
            /* IE11 specific stying for paper-item center aligned*/
            .list{
                color: var(--focused-line, #026bc3);
                @apply(--layout-vertical);
            }
        </style>
        <template is="dom-if" if="[[!menuButton]]">
            <template is="dom-if" if="[[!actionMenu]]">
                <paper-button id="simpleButton" tabindex$="[[tabindex]]" elevation$="[[elevation]]" noink$="[[noink]]" toggles$="[[toggles]]"
                    disabled$="[[disabled]]">
                    <template is="dom-if" if="[[iconUrl]]">
                        <img id="customIcon" src="[[iconUrl]]"></img>
                    </template>
                    <template is="dom-if" if="[[icon]]">
                        <iron-icon id="leftIcon" icon$="[[icon]]"></iron-icon>
                    </template>
                    <template is="dom-if" if="[[buttonText]]">
                        [[buttonText]]
                    </template>
                    <template is="dom-if" if="[[dropdownIcon]]">
                        <pebble-icon id="rightIcon" icon="arrow-drop-down"></pebble-icon>
                    </template>
                </paper-button>
            </template>
            <template is="dom-if" if="[[actionMenu]]">
                <paper-button id="actionParentButton" tabindex$="[[tabindex]]" elevation$="[[elevation]]" noink$="[[noink]]" toggles$="[[toggles]]"
                    disabled$="[[disabled]]" on-tap="_onActionParentTap">
                    <template is="dom-if" if="[[iconUrl]]">
                        <img id="customIcon" src="[[iconUrl]]"></img>
                    </template>
                    <template is="dom-if" if="[[icon]]">
                        <pebble-icon icon="pebble-md-icons:SavedSearch" class="pebble-md-icons m-r-10"></pebble-icon>
                    </template>
                    <template is="dom-if" if="[[buttonText]]">
                        <div id="buttonTextBox" class$="[[_computeEllipsis()]]">[[buttonText]]</div>
                    </template>
                </paper-button> 
                <paper-icon-button id="actionButton" tabindex="-1" on-tap="_onActionsButtonTap" icon="pebble-md-icons:MoreVert" class="dropdown-trigger"
                    noink>
                </paper-icon-button>
                    
                
                <pebble-popover id="actionsPopover" for="actionButton" auto-fit-on-attach no-overlap horizontal-align="right" allow-multiple>
                    <template is="dom-repeat" items="{{actionsData}}" as="action"> 
                        <paper-item data="[[action]]" on-tap="_onActionTap">
                            <template is="dom-if" if="{{action.icon}}">
                                <iron-icon icon={{action.icon}}></iron-icon>
                            </template>
                            <span>{{action.text}}</span>
                        </paper-item>
                    </template>
                </pebble-popover>
            </template>
        </template>
        <template is="dom-if" if="[[menuButton]]">
            <paper-menu-button id="menuButton" tabindex$="[[tabindex]]" allow-outside-scroll$="[[allowOutsideScroll]]" dynamic-align$="[[dynamicAlign]]"
                horizontal-align$="[[horizontalAlign]]" vertical-align$="[[verticalAlign]]" horizontal-offset$="[[horizontalOffset]]"
                vertical-offset$="[[verticalOffset]]" no-animations$="[[noAnimations]]" no-overlap$="[[noOverlap]]">
                <paper-button id="button" tabindex="-1" class="dropdown-trigger" elevation$="[[elevation]]" noink$="[[noink]]" toggles$="[[toggles]]"
                    disabled$="[[disabled]]">
                    <template is="dom-if" if="[[icon]]">
                        <iron-icon id="leftIcon" icon$="[[icon]]"></iron-icon>
                    </template>
                    <template is="dom-if" if="[[buttonText]]">
                        [[buttonText]]
                    </template>
                    <template is="dom-if" if="[[dropdownIcon]]">
                        <pebble-icon id="rightIcon" icon="pebble-lg-icons:arrow-down"></pebble-icon>
                    </template>
                </paper-button>

                <paper-menu id="paperMenu" class="dropdown-content">
                    <template is="dom-repeat" items="{{itemData}}" as="button">
                        <div class="list">
                        <paper-item data="[[button]]" on-tap="_onTap">
                            <template is="dom-if" if="{{button.icon}}">
                                <iron-icon icon={{button.icon}}></iron-icon>
                            </template>
                            <span>{{button.text}}</span>
                        </paper-item>
                        </div>
                    </template>
                </paper-menu>
            </paper-menu-button>
        </template>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'pebble-button',
        /**
		* Fired when user taps/clicks on any item in the dropdown menu of the button.
		*
		* @event bedrock-event
		* @param {Object} detail
        * @param {Object} detail.name gives the event name  
        * @param {Object} detail.data gives the button object			
		*/
        properties: {
            /**
             * Indicates that the button is styled with a shadow if the value is <b>true</b>.
             */
            raised: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates the z-depth of this element from 0 to 5. Setting to 0 removes the shadow, and 
             * each increasing number greater than 0 is <b>deeper</b> than the last.
             */
            elevation: {
                type: Number,
                value: 0,
                notify: true
            },
            /**
             * Indicates that the button toggles the active state with each tap or press of the spacebar if the value is <b>true</b>.
             */
            toggles: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that the element does not produce a ripple effect when interacted via the pointer if the value is <b>true</b>.
             */
            noink: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that an element opens a menu on a button click, if the value is <b>true</b>.
             */
            menuButton: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
              * Indicates that an ellipsis is displayed or not.
              */
             enableEllipsis: {
                 type: Boolean,
                 value: false
             },
 
            /**
             * Indicates icon if the value is set.
             */
            icon: {
                type: String,
                value: function () { return null; }

            },
            /**
             * Indicates the button text if the value is set.
             */
            buttonText: {
                type: String,
                value: function () { return null; },
                reflectToAttribute: true,
                notify: true
            },
            /**
             * Indicates that the button has actions menu, if the value is <b>true</b>.
             */
            actionMenu: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
                notify: true
            },
            /**
             * Indicates that the drop-down constraints scrolls on the page to itself when its opened by default. 
             * Set it to <b>true</b> to prevent this constraint on the scroll.
             */
            allowOutsideScroll: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that instead of strict requirements, `horizontalAlign` and `verticalAlign` properties 
             * are considered when the drop-down is positioned. If the value is <b>true</b>, it reduces
             * the area of the drop-down falling outside of `fitInto`.
             */
            dynamicAlign: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates the orientation to align the menu dropdown horizontally relative to the drop-down trigger.
             */
            horizontalAlign: {
                type: String,
                value: "right",
                notify: true
            },
            /**
             * Indicates the orientation to align the menu dropdown vertically relative to the dropdown trigger.
             */
            verticalAlign: {
                type: String,
                value: "bottom",
                notify: true
            },
            /**
             * Indicates the pixel value. This is added to the calculated position value for the
             * given `horizontalAlign` property. You can use a negative value to offset to the
             * left, or a positive value to offset to the right.
             */
            horizontalOffset: {
                type: Number,
                value: 0,
                notify: true
            },
            /**
             * Indicates the pixel value. This is added to the calculated position value for the
             * given `verticalAlign` property. You can use a negative value to offset towards the
             * top, or a positive value to offset towards the bottom.
             */
            verticalOffset: {
                type: Number,
                value: 0,
                notify: true
            },
            /**
             * Indicates that animations are disabled when opening and closing the
             * drop-down if the value is <b>true</b>.
             */
            noAnimations: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that the drop-down is positioned so that it doesn't overlap
             * the button if the value is <b>true</b>.
             */
            noOverlap: {
                type: Boolean,
                value: false,
                notify: true
            },
            /**
             * Indicates that the menu button will have the dropdown arrow icon
             * if the value is set to <b>true</b>.
             */
            dropdownIcon: {
                type: Boolean,
                value: false
            },
            /**
             * Indicates the array of objects which are ready to bound to menu.
             */
            itemData: {
                type: Array,
                value: function () { return []; }
            },
            /**
             * Indicates the array of action buttons which are ready to bound to menu.
             */
            actionsData: {
                type: Array,
                value: function () { return []; }
            },
            /**
             * Specifies whether or not you can interact with this element. If is set to "true", you cannot interact with this element.
             */
            disabled: {
                type: Boolean,
                value: false,
                notify: true,
                reflectToAttribute: true
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            tabindex: {
                type: Number
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            iconUrl: {
                type: String,
                value: ''
            }
        },
        behaviors: [
            RUFBehaviors.UIBehavior
        ],
        _onTap: function (e) {
            var eventDetail = {
                name: e.currentTarget.data.eventName,
                data: e.currentTarget.data
            }
            this.fire('bedrock-event', eventDetail);
        },
        _computeEllipsis: function () {
             return this.enableEllipsis ? "text-ellipsis" : "" ;
         },

        // Action Button
        _onActionsButtonTap: function (e) {
            this.$$('#actionsPopover').show();
        },
        _onActionTap: function (e) {
            // Get the parent pebble button to get the parent button data object.
            var parentElement;
            var selectedTabElement;
            var path = ElementHelper.getElementPath(e);

            if (path && path.length > 0) {
                for (var i = 0; i < path.length; i++) {
                    if (path[i].nodeName == "PEBBLE-BUTTON") {
                        parentElement = path[i];
                    }
                    if (path[i].nodeName == "ROCK-TABS") {
                        selectedTabElement = path[i];
                        break;
                    }
                }
            }
            if (parentElement != undefined && selectedTabElement != undefined) {
                var parentButtonData = parentElement.data;
                var selectedTabIndex = selectedTabElement.selectedTabIndex;
                if (selectedTabElement.config != undefined && selectedTabElement.config.tabItems != undefined
                    && selectedTabElement.config.tabItems != null && selectedTabIndex != undefined) {

                    var selectedTabObject = selectedTabElement.config.tabItems[selectedTabIndex];
                    var eventDetail = {
                        name: e.currentTarget.data.eventName,
                        data: { actionData: e.currentTarget.data, parentButton: parentButtonData, currentTab: selectedTabObject }
                    }
                    this.fireBedrockEvent(e.currentTarget.data.eventName, eventDetail.data, { ignoreId: true });
                }
            }
        },
        _onActionParentTap: function (e) {
            var parentElement;;
            var path = ElementHelper.getElementPath(e);
            if (path && path.length > 0) {
                for (var i = 0; i < path.length; i++) {
                    if (path[i].nodeName == "PEBBLE-BUTTON") {
                        parentElement = path[i];
                        break;
                    }
                }
            }
            if (parentElement != undefined) {
                var parentButtonData = parentElement.data;
                this.fireBedrockEvent("actions-parent-button-tap", parentButtonData, { ignoreId: true });
            }
        }
    });

</script>