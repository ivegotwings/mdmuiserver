<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid-data-sources/entity-relationship-grid-datasource.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<!--

`rock-relationship-grid` Represents an association relationship grid for an entity.
The following JSON objects depicts the entity that loads the relationship grid.
Based on the configuration, relationship grid gets loaded with the defined attributes from the given data object.

```json
{
  "crossSell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}
```
The following JSON object is a sample of data which binds the grid.
```json
{
  "id": "e2",
  "type": "product",
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "contexts": [
      {
        "context": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crossSell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relTo": {
                "id": "e5",
                "type": "product"
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relTo": {
                "id": "e6",
                "type": "product"
              }
            }
          ]
        }
      }
    ]
  }
}
```
@demo demo/index.html
-->
<dom-module id="rock-relationship-grid">
  <template>

    <style include="pebble-styles-shared"></style>
    <style>
      pebble-button.icon-text-button {
        --pebble-button: {
          height: 30px;
          padding: 0.5em 0em 0.5em 0em;
          border: 1px solid var(--primary-color);
        }
        --pebble-button-iron-icon: {
          height: 18px;
          width: 18px;
          padding-bottom: 2px;
        }
      }

      .relation-name {
        font-weight: var(--font-medium, 500);
        font-family: var(--default-font-family);
        clear: both;
        padding-top: 10px;
        margin: 0px;
        font-size: var(--font-size-md);
      }

      .relation-name-container {
        clear: left;
        @apply(--layout-horizontal);
        padding: 10px 0 0;
        flex-direction: row-reverse !important;
        border-radius: 3px;
        margin: 2px 0px 0 0px;
        flex-direction: row-reverse !important;
        -webkit-flex-direction: row-reverse !important;
      }

      .relation-line-box {
        margin-top: 16px;
        margin-left: 8px;
        margin-right: 8px;
        @apply(--layout-flex);
      }

      .relation-name-box {
        display: block;
        width: calc( 100% - 50px);
      }

      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: var(--tooltip-bg-color);
      }

      pebble-lov {
        width: 300px !important;
        max-height: 350px !important;
      }

      rock-grid {
        --rock-grid-height: 200px;
      }

      .relation-name-container pebble-button::shadow paper-button {
        color: var(--white);
        min-width: 50px;
        color: var(--white);
        border-radius: 3px;
        min-width: 50px;
        padding: 0 8px;
        height: 28px;
      }
      /* Accordian styles */

      pebble-accordion::shadow .header {
        background-color: var(--palette-pale-grey-four);
        border: 0;
        margin-top: 1px;
      }

      pebble-accordion::shadow .header-items-space {
        float: left !important;
      }

      .button {
        --pebble-button: {
          height: 30px;
          width: 100px;
          border: 1px solid #bbc1d2;
          font-size: 15px;
        }
      }

      .focus {
        --pebble-button: {
          height: 30px;
          width: 100px;
          font-size: 15px;
          background: #09c021;
          color: white;
        }
      }

      #buttonContainer {
        height: 50px;
        background: #fff;
        position: relative;
        bottom: 0px;
        width: 100%;
      }

      pebble-dialog::shadow #dialog {
        width: 400px;
        top: 20% !important;
      }

      #errorsDialog {
        --popup-header-color: red;
      }

      pebble-dialog::shadow ::content>ul {
        padding-left: 50px !important;
      }

      pebble-dialog>ul>li {
        list-style-type: disc;
      }

      #messageCard {
        text-align: center;
      }
    </style>

    <template is="dom-if" if="[[!_isMessageAvailable]]">
      <template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex" notify-dom-change>
        <div id="relContainer_[[relationship]]">
          <pebble-accordion header-text="[[_getRelationshipTypeTitle(relationship)]]" default-icon="expand-less" open-icon="expand-more">
            <div class="relation-name-container">
              <pebble-button icon="pebble-sm-icons:Add" id="[[relationship]]" class="btn btn-primary m-r-20" button-text="Add"
                on-click="_onAddPopoverClick"></pebble-button>
              <pebble-popover for$="[[relationship]]" auto-fit-on-attach vertical-align="auto" horizontal-align="auto" no-overlap>
                <rock-entity-lov id="[[relationship]]" request-data="[[_requestForAddRelationshipList(relationship)]]" id-field="[[_getIdField(relationship)]]"
                  title-pattern="[[_getTitlePattern(relationship)]]" multi-select no-sub-title show-action-buttons></rock-entity-lov>
              </pebble-popover>
              <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLovConfirmButtonTapped" target-id="[[relationship]]"></bedrock-pubsub>
              <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLovCloseButtonTapped" target-id="[[relationship]]"></bedrock-pubsub>
            </div>
            <entity-relationship-grid-datasource id="datasource_[[relationship]]" request="[[_getRelationshipGridRequest(relationship)]]"
              data-formatter="{{dataFormatter}}"></entity-relationship-grid-datasource>
            <rock-grid id$="[[relationship]]" data-source-id="datasource_[[relationship]]" config="{{_getRelationshipGridConfig(relationship)}}"
              attribute-models="[[_getRelationshipAttributeModels(relationship)]]" page-size="10"></rock-grid>
            <bedrock-pubsub target-id="[[relationship]]" event-name="on-grid-msg-dialog-ok" handler="_onDialogOk"></bedrock-pubsub>
            <div id="buttonContainer" align="center" hidden>
              <pebble-button id="cancel" class="button" button-text="Cancel" on-tap="_revertAll" elevation=1 raised></pebble-button>
              <pebble-button id="save" class="focus" button-text="Save" on-tap="_save" elevation=1 raised></pebble-button>
            </div>
          </pebble-accordion>
        </div>
      </template>

      <liquid-entity-data-get id="entityGetData" name="entityGet" operation="getbyids" request-data="{{_entityGetRequest}}" last-response="{{entitiesResponse}}"></liquid-entity-data-get>
      <liquid-entity-data-get id="entityGetAddData" name="entityGet" operation="getbyids" request-data="{{_entityGetAddRequest}}"
        last-response="{{relEntitiesResponse}}"></liquid-entity-data-get>

      <liquid-entity-data-save name="attributeSaveDataService" operation="update" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
        on-response="_onSaveResponse"></liquid-entity-data-save>
      <liquid-rest id="entityGovernService" url="/pass-through/entitygovernservice/validate" method="POST" request-data={{_entityGovernRequest}}
        on-liquid-response="_onEntityGovernResponse" on-liquid-error="_onEntityGovernFailed">
      </liquid-rest>
      <pebble-dialog id="errorsDialog" dialog-title="Errors on page">
        <p>Found below errors in entity details: </p>
        <ul>
          <template is="dom-repeat" items="[[_errorMessages]]">
            <li>[[item.attributeName]] with error: [[item.message]]</li>
          </template>
        </ul>
        <p>Do you want to fix the errors or continue?</p>
        <div class="buttons">
          <paper-button dialog-confirm class="btn btn-success">Fix</paper-button>
          <paper-button dialog-confirm class="btn btn-secondary" on-tap="_skipErrors">Skip & Continue</paper-button>
        </div>
      </pebble-dialog>
    </template>

    <div id="messageCard">
    </div>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-relationship-grid',

        properties: {
          /**
           * Indicates the data which is wrapped in the data-source that is used as a grid data.
           * The format for the JSON object is given in the above description.
           */
          data: {
            type: Object,
            notify: true
          },
          /*
           *	Indicates the transformed relationship data for the grid.
           */
          relationshipGridData: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },
          /*
           *	Indicates the transformed relationship grid configuration for the grid.
           */
          relationshipGridConfigs: {
            type: Object,
            notify: true
          },
          /**
           * Indicates the attribute models.
           */
          attributeModels: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /*
           * Indicates the currently selected relationship type.
           */
          relationshipType: {
            type: String,
            notify: true
          },
          /*
          * Indicates the title for the selected relationship type.
          */
          relationshipTitle: {
            type: String,
            notify: true
          },
          /*
           * Indicates the list of relationships.
           */
          relationshipTypeList: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            },
            observer: '_relationshipEnabled'
          },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
          dataFormatter: {
            notify: true,
            value: function () {
              return this._populateDataForGrid.bind(this);
            }
          },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
          dataObject: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
          relReq: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
          contextData: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
          doSyncValidation: {
            type: Boolean,
            value: true
          },
          /*
           */
          _entityGetRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _entityGetAddRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _currentRelationshipItem: {
            type: String,
            notify: true
          },
          _selectedDimensions: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _relationshipTypeAndAttributes: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _relationships: {
            type: Array,
            value: function () {
              return [];
            }
          },
          _relationshipModelRequest: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _isMessageAvailable: {
            type: Boolean,
            value: false
          }
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        messageCodeMapping: {
          type: Object,
          value: function () { return {}; }
        },

        behaviors: [
          RUFBehaviors.UIBehavior,
          RUFBehaviors.ComponentContextBehavior
        ],

        observers: [
          '_initiateRelationshipGrid(relationshipGridConfigs)',
          '_convertIntoEntityLovList(searchResultResponse)',
          '_addRelationship(relEntitiesResponse)'
        ],

        listeners: {
          'editMode': '_onEditMode'
        },

        _currentSelectedLov: null,
        _currentLovItems: null,

        _relationshipEnabled: function () {
          if (this.relationshipTypeList && this.relationshipTypeList.length) {
            this._setRelGridDataSource();
          }
        },
        _getAttributeList: function (relationshipTypeName) {
          if (this._relationshipTypeAndAttributes && relationshipTypeName) {
            return this._relationshipTypeAndAttributes[relationshipTypeName];
          }
        },
        _getRelatedEntityAttributeList: function (relationshipTypeName) {
          var attributes = this._getAttributeList(relationshipTypeName);
          var relatedEntityAttributes = [];

          if (attributes && attributes.relatedEntityAttributes) {
            relatedEntityAttributes = attributes.relatedEntityAttributes;
          }

          return relatedEntityAttributes;
        },
        _initiateRelationshipGrid: function () {
          var relTypeAndAttributes = {};
          if (this.relationshipGridConfigs && Object.keys(this.relationshipGridConfigs).length) {
            this._relationships = Object.keys(this.relationshipGridConfigs);

            if (this._relationships) {
              this._relationships.forEach(function (item) {
                if (item) {
                  var relatedEntityAttributes = [];
                  var relationshipAttributes = [];

                  var columns = this.relationshipGridConfigs[item].gridConfig.tabular.columns;
                  if (columns) {
                    columns.forEach(function (col) {
                      if (col && col.name != "Related Entity") {
                        if (col.isRelatedEntityAttribute) {
                          relatedEntityAttributes.push(col.name);
                        } else {
                          relationshipAttributes.push(col.name);
                        }
                      }
                    }, this);
                  }
                  relTypeAndAttributes[item] = {
                    'relationshipAttributes': relationshipAttributes,
                    'relatedEntityAttributes': relatedEntityAttributes
                  }
                }
              }, this);
            }

            this._relationshipTypeAndAttributes = relTypeAndAttributes;

            this.relationshipTypeList = undefined;
            if (this.relationshipType == "Relationships") {
              this.relationshipTypeList = this._relationships;
            } else {
              this.relationshipTypeList = [this.relationshipType];
            }
          }
        },
        _getRelationshipTypeTitle: function (relationship) {
          if (relationship) {
            var config = this._getRelationshipGridConfig(relationship);
            if (config && config.title && config.title != "") {
              return config.title;
            }
          }

          return relationship;
        },
        _isRelationshipType: function (relationshipType) {
          if (relationshipType && relationshipType != '' && this.relationshipType != "Relationships") {
            return true;
          } else {
            return false;
          }
        },
        _getRelationshipGridConfig: function (relationshipTypeName) {
          var gridConfig = undefined;
          if (this.relationshipGridConfigs[relationshipTypeName]) {
            gridConfig = this.relationshipGridConfigs[relationshipTypeName].gridConfig
            if (gridConfig) {
              gridConfig.mode = "read";
            }
          }
          return gridConfig;
        },
        _getRelationshipAddRelLovConfig: function (relationshipTypeName) {
          var relationshipGridConfig = this.relationshipGridConfigs[relationshipTypeName];
          return relationshipGridConfig ? relationshipGridConfig.addRelLovConfig : undefined;
        },
        _getRelationshipGridRequest: function (relationshipTypeName) {
          var req = DataHelper.cloneObject(this.relReq);

          if (req && relationshipTypeName) {
            var relConfig = this.relationshipGridConfigs[relationshipTypeName];
            var relAttr = this._getAttributeList(relationshipTypeName);

            if (relAttr) {
              req.params.fields.relationshipAttributes = relAttr.relationshipAttributes;
              req.params.fields.relatedEntityAttributes = relAttr.relatedEntityAttributes;
            }

            req.params.fields.relationships = [relationshipTypeName];
          }
          return req;
        },
        _getRelationshipAttributeModels: function (relationshipTypeName) {
          var config = this.relationshipGridConfigs[relationshipTypeName];
          var attrModels = {};

          if (config) {
            attrModels = config.relationshipAttributeModels;
            var relEntityAttrModels = config.relatedEntityModel.relatedEntityAttributeModels;

            for (var key in relEntityAttrModels) {
              attrModels[key] = relEntityAttrModels[key];
            }
          }

          return attrModels;
        },
        _getRelatedEntityContexts: function (relationshipTypeName) {
          var config = this.relationshipGridConfigs[relationshipTypeName];
          var relatedEntityContexts;

          if (config) {
            relatedEntityContexts = config.relatedEntityModel.relatedEntityContexts;
          }

          return relatedEntityContexts;
        },
        _populateDataForGrid: function (respData) {
          var data = [];
          if (respData) {

            if (respData.content && respData.content.entities) {
              var entities = respData.content.entities;
              if (entities && entities.length > 0) {
                var entityId = entities[0].id;

                if (entityId) {
                  var entity = entities[0];
                  if (this.dataObject && !this.dataObject["blankEntity"]) {
                    this.dataObject["blankEntity"] = entity;
                  }

                  var currentRel = "";
                  var isSelfContext = false;
                  if (event.detail.request) {
                    currentRel = event.detail.request.requestData.params.fields.relationships[0];
                  }

                  var relConfig = this.relationshipGridConfigs[currentRel];
                  if (relConfig) {
                    isSelfContext = relConfig.selfContext;
                  }

                  var relationships = EntityHelper.getRelationshipsBasedOnContext(entity, this.getFirstDataContext(), isSelfContext);
                  if (!_.isEmpty(relationships)) {
                    var relatedEntities = relationships[currentRel];

                    if (this.dataObject) {
                      if (!this.dataObject[currentRel]) {
                        this.dataObject[currentRel] = entity;
                      }
                    }

                    relatedEntities.forEach(function (relItem) {
                      if (relItem) {
                        var record = {};
                        if (relItem.attributes) {
                          Object.keys(relItem.attributes).forEach(function (item) {
                            if (item && relItem.attributes[item]) {
                              record[item] = relItem.attributes[item].values[0].value;
                            }
                          }, this);
                        }
                        if (relItem.relTo) {
                          record["Related Entity"] = record["id"] = relItem.relTo.id;
                          record["type"] = relItem.relTo.type;

                          if (relItem.relTo.data) {
                            //var relCtxList = relContexts[item];
                            var relatedAttributes = EntityHelper.getAllAttributes(relItem.relTo);
                            if (relatedAttributes) {
                              Object.keys(relatedAttributes).forEach(function (
                                attrItem) {
                                if (attrItem && relatedAttributes[attrItem]) {
                                  record[attrItem] = relatedAttributes[attrItem].values[
                                    0].value;
                                }
                              }, this);
                            }
                          }
                        }
                        data.push(record);
                      }
                    }, this);
                  }
                }
              }
            }
          }
          return data;
        },
        _onAddPopoverClick: function (e) {
          var popover = Polymer.dom(this).node.$$("pebble-popover[for=" + e.currentTarget.id + "]");
          this._currentSelectedLov = Polymer.dom(this).node.$$('rock-entity-lov[id=' + e.currentTarget.id + ']');

          popover.show();
        },
        _convertIntoEntityLovList: function (entitiesResponse) {
          if (entitiesResponse) {
            var items = [];
            var selectedItems = [];

            if (entitiesResponse.content && entitiesResponse.content.entities) {
              var entities = entitiesResponse.content.entities;
              entities.forEach(function (item) {
                if (item) {
                  //TODO: this code has to be enhanced for based on config.
                  var attributes = EntityHelper.getAllAttributes(item);
                  items.push({
                    "id": item.id,
                    "title": item.id,
                    "subtitle": item.type,
                    "image": "/src/images/lookup-item.jpg"
                  });
                }
              }, this);
            }

            if (this._currentSelectedLov) {
              var relGrid = Polymer.dom(this).node.$$('rock-grid[id=' + this._currentSelectedLov.id + ']');
              var relGridData = [];
              if (relGrid) {
                relGridData = relGrid.getData();
              }

              this._currentSelectedLov.items = items;
              this._currentSelectedLov.selectedItems = relGridData;
              this._currentLovItems = items;
            }
          }
        },
        _onLovConfirmButtonTapped: function (event) {
          if (event.detail) {

            var lov = this.$$("rock-entity-lov[id=" + event.detail.data.id + "]");

            var oldSelectedItemIds = [];
            var selectedItemIds = [...new Set(lov.selectedItems.map((obj) => obj.id))];
            var newItemIds = [];

            // TO-DO Pebble-LOV has to handle this filteration.
            var currentRelGrid = Polymer.dom(this).node.$$('rock-grid[id=' + event.detail.data.id + ']');
            if (currentRelGrid) {
              var data = currentRelGrid.getData();
              data.forEach(function (item) {
                if (item) {
                  oldSelectedItemIds.push(item.id);
                }
              }, this);
            }

            selectedItemIds.forEach(function (item) {
              if (item && oldSelectedItemIds.indexOf(item) < 0) {
                newItemIds.push(item);
              }
            }, this);

            this._addRelatedEntity(event.detail.data.id, newItemIds);
          }
        },
        _onLovCloseButtonTapped: function (event) {
          if (event.detail) {
            var currentLovPopover = Polymer.dom(this).node.$$('pebble-popover[for=' + event.detail.data.id + ']');

            if (currentLovPopover) {
              currentLovPopover.hide();
            }
          }
        },
        _addRelatedEntity: function (relationshipType, entityIds) {
          if (entityIds && entityIds.length > 0) {
            var popover = Polymer.dom(this).node.$$("pebble-popover[for=" + relationshipType + "]");
            this._currentRelationshipItem = relationshipType;

            var relatedEntityContexts = this._getRelatedEntityContexts(this._currentRelationshipItem);
            var typesCriterion = [];
            var contexts = [];
            var attributes = this._getRelatedEntityAttributeList(this._currentRelationshipItem);

            if (relatedEntityContexts) {
              relatedEntityContexts.forEach(function (relContexts) {
                if (relContexts) {
                  typesCriterion.push(relContexts.relEntityType);
                  if (relContexts.relContexts) {
                    relContexts.relContexts.forEach(function (ctxItem) {
                      contexts.push(ctxItem);
                    }, this);
                  }
                }
              }, this);
            }

            var valueContext = this.getFirstValueContext();

            //TODO-dimensions has to be set in req. same like did in relationship-manage          
            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": [valueContext],
                  "ids": entityIds,
                  "filters": {
                    "typesCriterion": typesCriterion
                  }
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": attributes
                },
                "options": {
                  "maxRecords": 10
                }
              }
            };

            this.set('_entityGetAddRequest', req);
            var relAddLiquid = Polymer.dom(this).node.$$('liquid-entity-data-get[id="entityGetAddData"]');
            if (relAddLiquid) {
              relAddLiquid.generateRequest();
            }
            popover.hide();
          }
        },
        _addRelationship: function () {
          if (this.relEntitiesResponse) {
            var relGrid = Polymer.dom(this).node.$$('rock-grid[id=' + this._currentRelationshipItem + ']');

            if (relGrid) {
              var relData = [];
              if (this.relEntitiesResponse.content && this.relEntitiesResponse.content.entities) {
                var entities = this.relEntitiesResponse.content.entities;
                var relGridData = relGrid.getData();
                entities.forEach(function (relItem) {
                  if (relItem) {
                    var attributes = EntityHelper.getAllAttributes(relItem);
                    var record = {};
                    if (attributes) {
                      Object.keys(attributes).forEach(function (attrItem) {
                        if (attrItem && attributes[attrItem]) {
                          record[attrItem] = attributes[attrItem].values[0].value;
                        }
                      }, this);
                    }
                    record['Related Entity'] = record['id'] = relItem.id;
                    record['type'] = relItem.type;
                    record['properties'] = relItem.properties;
                    record['relationshipType'] = this._currentRelationshipItem;
                    relData.push(record);
                  }
                }, this);
              }
              relGrid.addNewRecords(relData);
            }
          }
        },
        _onEditMode: function (e) {
          this._hideAllRelationshipGrid(true);

          this._currentRelationshipItem = e.path ? e.path[0].id : e.target.id;
          var relDiv = Polymer.dom(this).node.$$('div[id=relContainer_' + this._currentRelationshipItem + ']');

          if (relDiv) {
            relDiv.hidden = false;

            var buttonContainer = Polymer.dom(relDiv).node.querySelector("div[id='buttonContainer']");
            buttonContainer.hidden = false;
          }
        },
        _save: function (e) {
          var currentRel = e.model.relationship;
          var currentRelGrid = Polymer.dom(this).node.$$('rock-grid[id=' + currentRel + ']');
          var entityId = DataHelper.getParamValue('id');
          var relConfig = this.relationshipGridConfigs[currentRel];
          var utils = SharedUtils.DataObjectFalcorUtil;

          if (currentRelGrid && relConfig) {
            var gridData = currentRelGrid.getData();
            var originalEntity;

            if (this.dataObject) {
              if (this.dataObject[currentRel]) {
                originalEntity = this.dataObject[currentRel];
              } else if (this.dataObject['blankEntity']) {
                originalEntity = this.dataObject['blankEntity'];
              }
            }

            if (originalEntity) {
              var relationships = EntityHelper.getRelationshipByType(originalEntity, this.getFirstDataContext(), currentRel, relConfig.selfContext);
              var modifiedRelData = gridData;
              var relAndRelEntityAttributes = this._getAttributeList(currentRel);
              var valueContext = this.getFirstValueContext();

              if (!_.isEmpty(modifiedRelData)) {
                var totalRel = relationships.length;
                modifiedRelData.forEach(function (modItem) {
                  var key = "";
                  var relObject;

                  if (relationships) {
                    relationships.forEach(function (relItem) {
                      if (relItem.id.indexOf(modItem["Related Entity"]) >= 0) {
                        relObject = relItem;
                      }
                    }, this);
                  } else {
                    relationships = {};
                    relationships[currentRel] = [];
                  }

                  if (relObject) {

                    var relAttributes = relObject.attributes ? relObject.attributes : relObject.attributes = {};

                    relAndRelEntityAttributes.relationshipAttributes.forEach(function (relAttr) {
                      if (relAttr) {
                        var relAttribute = relAttributes ? relAttributes[relAttr] : undefined;
                        if (relAttribute) {
                          relAttribute.values[0].value = modItem[relAttr];
                        } else {
                          if (modItem[relAttr]) {
                            relAttributes[relAttr] = {};
                            relAttributes[relAttr].values = [{
                              "value": modItem[relAttr],
                              "source": valueContext.source,
                              "locale": valueContext.locale
                            }];
                          }
                        }
                      }
                    }, this);
                  } else {

                    var relId = modItem["Related Entity"];
                    var relationship = {};
                    var relType = modItem["relationshipType"];

                    relationship.direction = "both";
                    relationship.operation = "association";

                    relationship.attributes = {};

                    if (relAndRelEntityAttributes) {
                      relAndRelEntityAttributes.relationshipAttributes.forEach(function (
                        relAttr) {
                        if (relAttr) {
                          relationship.attributes[relAttr] = {};
                          relationship.attributes[relAttr].values = [{
                            "value": modItem[relAttr],
                            "source": valueContext.source,
                            "locale": valueContext.locale
                          }];
                        }
                      }, this);
                    }

                    relationship.relTo = {};
                    relationship.relTo.id = relId;
                    relationship.relTo.type = modItem['type'];
                    relationship.relTo.properties = modItem['properties'];

                    relationship.id = utils.createRelUniqueId(relType, relationship, totalRel++);
                    relationships.push(relationship);
                  }
                }, this);
              }
            }

            this._saveRequest = {
              "entities": [originalEntity]
            };
            if (this.doSyncValidation) {
              var req = DataRequestHelper.createSyncValidationRequest(originalEntity.id, originalEntity.type, originalEntity.data);
              this.set('_entityGovernRequest', req);
              delete this._entityGovernRequest.entity.name;
              var liquidGovernGet = this.$$('#entityGovernService');
              if (liquidGovernGet) {
                liquidGovernGet.generateRequest();
              }
            } else {
              this._saveEntity();
            }
          }
        },
        _onEntityGovernResponse: function (e) {
          if (e && e.detail && e.detail.response && e.detail.response.response && e.detail.response.response.status == "success") {
            var res = e.detail.response.response;
            var itemContext = this.getFirstItemContext();
            var entityId;
            if (itemContext) {
              entityId = itemContext.id;
            }

            var entity = DataHelper.findEntityById(res.entities, entityId);

            if (entity && entity.data && entity.data.relationships) {
              var relationships = entity.data.relationships;
              var relMessages = {};
              for (var i in relationships) {
                var relationshipType = i;
                var relTitle = this._getRelationshipTypeTitle(relationshipType);
                var relationshipMessages = MessageHelper.getRelationshipMessages(relationships[i], this.messageCodeMapping, this.localize);
                var relAttributes = relationships[i][0].attributes;
                var attrModels = this._getRelationshipAttributeModels(relationshipType);
                var relationshipObj = {
                  "relTitle": relTitle,
                  "relMessage": relationshipMessages[0],
                  "relAttributes": relAttributes,
                  "attrModels": attrModels
                };
                relMessages[relationshipType] = relationshipObj;
              }
            }
            if (!_.isEmpty(relMessages)) {
              var errorMessages = MessageHelper.getErrorsFromRelMessages(relMessages);
              this.set("_errorMessages", errorMessages);
              this.$$('#errorsDialog').open();
              return;
            } else {
              this._saveEntity();
            }
          } else {
            this.logWarning("AttributeManageValidationFail","response",JSON.Stringify(e.detail));
            this.showErrorToast("There is a problem in validation service. Please contact administrator.");
          }
        },
        _onEntityGovernFailed: function (e) {
          this.logWarning("AttributeManageValidationFail","response",JSON.Stringify(e));
          this.showErrorToast("There is a problem in validation service. Please contact administrator.");
        },
        _skipErrors: function () {
          this._saveEntity();
        },
        _saveEntity: function () {
          var liquidSave = this.$$("[name=attributeSaveDataService]");
          if (liquidSave) {
            liquidSave.generateRequest();
          }
        },
        _onSaveResponse: function () {
          //TO-DO will get changed
          var mainApp = document.querySelector('#app');
          mainApp.toastText = "Relationships saved successfully.";
          var toastElement = mainApp.$$("#pebbleAppToast");
          toastElement.toastType = "success";
          toastElement.heading = "Success";
          toastElement.autoClose = true;

          toastElement.show();

          var currentRelGrid = Polymer.dom(this).node.$$('rock-grid[id=' + this._currentRelationshipItem + ']');

          if (currentRelGrid) {
            this._changeRelationshipToReadMode();
            currentRelGrid.changeToReadMode();
          }
        },
        _revertAll: function (e) {
          var currentRel = e.model.relationship;
          var currentRelGrid = Polymer.dom(this).node.$$('rock-grid[id=' + currentRel + ']');

          if (currentRelGrid) {
            if (currentRelGrid.isDirty()) {
              currentRelGrid.openGridMsgDialog(currentRel +
                " relationship has unsaved changes. Do you wants to revert those ?");
            } else {
              currentRelGrid.changeToReadMode();
              this._changeRelationshipToReadMode();
            }
          }
        },
        _hideAllRelationshipGrid: function (boolVal) {
          if (this._relationships) {
            this._relationships.forEach(function (item) {
              if (item) {
                var relDiv = Polymer.dom(this).node.$$('div[id=relContainer_' + item + ']');
                if (relDiv) {
                  relDiv.hidden = boolVal;
                }
              }
            }, this);
          }
        },
        _setRelGridDataSource: function () {
          var repeat = Polymer.dom(this).node.$$('template[is="dom-repeat"]');

          if (repeat) {
            repeat.addEventListener("dom-change", function (event) {
              var relDivs = this.parentNode.querySelectorAll('div[id^=relContainer_]');

              if (relDivs && relDivs.length > 0) {
                for (var i in relDivs) {
                  var item = relDivs[i];
                  if (typeof item === 'object') {
                    var relGrid = item.querySelector('rock-grid');
                    var dataSourceElement = item.querySelector('entity-relationship-grid-datasource');

                    if (relGrid && dataSourceElement) {
                      relGrid.dataSource = dataSourceElement.dataSource;

                      dataSourceElement.addEventListener('current-record-size-changed', function (e) {
                        this.gridDataSize = e.currentTarget.currentRecordSize;
                      }.bind(relGrid));

                      dataSourceElement.addEventListener('total-records-changed', function (e) {
                        this.recordSize = e.currentTarget.totalRecords;
                      }.bind(relGrid));
                    }
                  }
                }
              }
            });
          }
        },
        _onDialogOk: function (e) {
          if (this._currentRelationshipItem) {
            var relGrid = Polymer.dom(this).node.$$('rock-grid[id=' + this._currentRelationshipItem + ']');

            if (relGrid) {
              this._changeRelationshipToReadMode();
              relGrid.revertData();
            }
          }
        },
        _changeRelationshipToReadMode: function () {
          if (this._currentRelationshipItem) {
            var relDiv = Polymer.dom(this).node.$$('div[id=relContainer_' + this._currentRelationshipItem + ']');

            if (relDiv) {
              var buttonContainer = Polymer.dom(relDiv).node.querySelector("div[id='buttonContainer']");
              buttonContainer.hidden = true;
            }

            this._hideAllRelationshipGrid(false);
          }
        },
        _requestForAddRelationshipList: function (relationship) {
          var relatedEntityContexts = this._getRelatedEntityContexts(relationship);
          var attributes = this._getRelatedEntityAttributeList(relationship);

          var typesCriterion = [];
          var contexts = [];

          if (relatedEntityContexts) {
            relatedEntityContexts.forEach(function (relContext) {
              if (relContext) {
                typesCriterion.push(relContext.relEntityType);
                if (relContext.relContexts) {
                  relContext.relContexts.forEach(function (ctxItem) {
                    contexts.push(ctxItem);
                  }, this);
                }
              }
            }, this);

            var valueContext = this.getFirstValueContext();

            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": [valueContext],
                  "filters": {
                    "attributesCriterion": [],
                    "typesCriterion": typesCriterion
                  }
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": attributes,
                  "relationships": []
                },
                "options": {
                  "from": 0,
                  "to": 0
                }
              }
            };

            return req;
          } else {
            var messageDiv = this.$.messageCard;
            if (messageDiv) {
              messageDiv.textContent = "Relationships are not configured for current entity type: " + this.relationshipTitle;
              this._isMessageAvailable = true;
            }
          }
        },
        _getIdField: function (relationship) {
          var idField = "";
          var addRelLovConfig = this._getRelationshipAddRelLovConfig(relationship);
          if (addRelLovConfig) {
            idField = addRelLovConfig.idField;
          }
          return idField;
        },
        _getTitlePattern: function (relationship) {
          var titlePattern = "";
          var addRelLovConfig = this._getRelationshipAddRelLovConfig(relationship);
          if (addRelLovConfig) {
            titlePattern = addRelLovConfig.titlePattern;
          }
          return titlePattern;
        }
      });
    })();
  </script>
</dom-module>