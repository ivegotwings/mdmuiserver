<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">

<!--
`rock-relationship-grid` Represents assosiation relationship grid for the entity.

The following JSON objects are a sample of entity used for loading relationship grid.

Based on config relationship grid will get loaded with defined attributes from given data object.

```json [Config]
{
  "crosssell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}

```json [Data]
{
  "id": "e2",
  "entityInfo": {
    "entityType": "product",
    "entityDomain": "thing"
  },
  "systemInfo": {
    "tenantId": "t1"
  },
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "ctxInfo": [
      {
        "ctxGroup": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crosssell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relToObject": {
                "id": "e5",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relToObject": {
                "id": "e6",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ]
        }
      }
    ]
  }
}
```

@demo demo/index.html
-->

<dom-module id="rock-relationship-grid">
	<template>
		<style include="pebble-styles-shared"></style>
		      <style>
             pebble-button.icon-text-button {
                --pebble-button: {
                    height: 30px;
                    padding: 0.5em 0em 0.5em 0em;
                    border: 1px solid #036BC3;
                }
                --pebble-button-iron-icon: {
                    height: 18px;
                    width: 18px;
                    padding-bottom: 2px;
                }
            }

            .relation-name {
                font-weight: 500;
                font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
                clear: both;
                padding-top: 10px;
                margin: 0px;
                font-size: var(--font-size-medium);
            }
            
            .relation-name-container {
                clear: left;
                @apply(--layout-horizontal);
                margin:18px 0 0 0;
            }

            .relation-line-box {
                margin-top:16px;
                margin-left:8px;
                margin-right:8px;
                @apply(--layout-flex);
            }

            .relation-name-box {
              display: inline-block;
            }

            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: black;
            }

            pebble-lov {
                  width: 300px !important;
                  max-height: 350px !important;
            }

            ::shadow iron-data-table {
              height: 200px !important;
            }

        </style>

    <template is="dom-if" if="{{_dataIsNotNull(data)}}">
			<template is="dom-if" if="{{_isRelationshipType(relationshipType)}}">
				<div class="relation-name-container">
					<div class="relation-name-box">
            <span class="relation-name">[[relationshipType]]</span>
          </div>
					<div class="relation-line-box">
						<pebble-horizontal-divider></pebble-horizontal-divider>
					</div>
          <!--<iron-ajax auto url="demo/data.json" handle-as="json" last-response="{{items}}"></iron-ajax>-->
          <pebble-button icon="pebble-icons:Create" id="[[relationshipType]]" class="icon-text-button" button-text="Add" on-click="onPopoverClick"></pebble-button>
          <pebble-popover for$="[[relationshipType]]" auto-fit-on-attach no-overlap>
              <pebble-lov id="[[relationshipType]]" items="{{items}}" multi-selection="false" show-image="true" on-selection-changed="addRelatedEntity" show-sub-title></pebble-lov>
          </pebble-popover>
				</div>
        </br>
				<pebble-grid id="[[relationshipType]]" config="[[_getRelationshipGridConfig(relationshipType)]]" page-size="10" 
            attribute-models="{{attributeModels}}" data="[[_getRelationshipGridData(relationshipType)]]"></pebble-grid>					
			</template>
			
      <template is="dom-if" if="{{!_isRelationshipType(relationshipType)}}">
				<template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex">
					<div class="relation-name-container">
						<div class="relation-name-box">
              <span class="relation-name">[[relationship]]</span>
            </div>
						<div class="relation-line-box">
							<pebble-horizontal-divider></pebble-horizontal-divider>
						</div>
            <!--<iron-ajax auto url="demo/data.json" handle-as="json" last-response="{{items}}"></iron-ajax>-->
            <pebble-button icon="pebble-icons:Create" id="[[relationship]]" class="icon-text-button" button-text="Add" on-click="onPopoverClick"></pebble-button>
            <pebble-popover for$="[[relationship]]" auto-fit-on-attach no-overlap>
                <pebble-lov id="[[relationship]]" items="{{items}}" multi-select show-image="true" on-selection-changed="addRelatedEntity" show-sub-title></pebble-lov>
            </pebble-popover>
					</div>
          </br>          
					<pebble-grid id="[[relationship]]" config="{{_getRelationshipGridConfig(relationship)}}" page-size="10" 
              attribute-models="{{attributeModels}}" data="{{_getRelationshipGridData(relationship)}}"></pebble-grid>
				</template>
			</template>
		</template>
    
    <liquid-entity-getdata auto  verbose id="initiateSearchResult" operation="initiatesearch" 
        request-data="{{request}}" last-response="{{searchResponse}}"></liquid-entity-getdata>
    <liquid-entity-getdata auto verbose id="searchResultGetDataService" operation="getsearchresultdetail" 
        request-data="{{request}}" request-id="[[searchResponse.content.requestId]]" last-response="{{searchResultResponse}}"></liquid-entity-getdata>

    <liquid-entity-getdata auto log-internal-detail id="entityGetData" name="entityGet" operation="getentities" request-data="{{entityGetRequest}}" 
      last-response="{{entitiesResponse}}"></liquid-entity-getdata>

	</template>
<script>
	(function () {
		'use strict';

		Polymer({
			is: 'rock-relationship-grid',
			properties: {
				/**
				 * Indicates a data which is wrapped in a data-source that is used as a grid data.
				 * The format for the JSON object is given in the above description.
				 */
				data: {
					type: Object,
					notify: true,
					observer : '_prepareRelationshipGridData'
				},
				/*
				*	Indicates transformed relationship data for grid.
				*/	
				relationshipGridData: {
					type: Array,
					notify: true,
					value : function() {
						return [];
					}
				},

				/*
				*	Indicates transformed relationship grid config for grid.
				*/
				relationshipGridConfig: {
					type : Object,
					notify: true,
					value : function() {
            return {};
					}
				},

				/**
				 * Indicates an attribute models to be used.
				 */
				attributeModels: {
					type: Object,
					notify: true,
					value: function () {
						return {};
					}
				},

        /*
        * Indicates current or selected relationship type.
        */
				relationshipType: {
					type : String,
					notify: true
				},

        /*
        * Indicates list of relationships.
        */
				relationshipTypeList: {
					type : Array,
					notify : true,
					value : function() {
						return [];
					}
				},

        /*
        */
        entityGetRequest: {
            type: Object,
            notify: true,
            value: function () {
                return {};
            }
        },

        request: {
          type: Object,
          notify: true,
          value: function () {
              return {};
          }
        }
			},

      observers: [
          '_convertIntoEntityLovList(searchResultResponse)'
      ],
      _currentSelectedLov: null,
      _currentLovItems: null,
			onPopoverClick: function(e) {
          var popover =  Polymer.dom(this).node.$$("pebble-popover[for=" + e.currentTarget.id + "]");
          var lov = Polymer.dom(this).node.$$("pebble-lov[id=" + e.currentTarget.id + "]");
          this._currentSelectedLov =  Polymer.dom(this).node.$$('pebble-lov[id=' + e.currentTarget.id + ']');

          var req = {
              "params": {
                    "query": {
                        "ctx": [
                            {
                                "list": "productMaster",
                                "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                            }
                        ],
                        "valCtx": [
                            {
                                "source": "SAP",
                                "locale": "en-US"
                            }
                        ],
                        "filters": {
                            "attributesCriterion": [],
                            "typesCriterion": ["nart"]
                        }
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": [
                            "cpimProductName",
                            "csapDescriptionOfNart",
                            "csapMaterialStatusGlobal",
                            "cpimSkinType"
                        ],
                        "relationships": ["ALL"]
                    }
                }
          };

          this.set("request", req);
          
          popover.show();
          lov.activate();
          this._currentSelectedLov.items = this._currentLovItems;
      },

      addRelatedEntity: function(e) {
          var relGrid =  Polymer.dom(this).node.$$('pebble-grid[id='+ e.currentTarget.id +']');
          var popover =   Polymer.dom(this).node.$$("pebble-popover[for=" + e.currentTarget.id + "]");
          var selectedItem = e.currentTarget.selectedItem.id;
          
          // Call of liquid for selected entity based on config
          
          if(relGrid) {
            var relGridData = relGrid.data;
            var relConfig = relGrid.config;

            if(relConfig && relConfig.tabular)
            {
              var columns = relConfig.tabular.columns;

              if(columns && columns.length > 0)
              {
                var record = {};
                columns.forEach(function(column) {
                  if(column.name == "Related Entity")
                  {
                       record[column.name] = selectedItem;
                  }
                }, this);
                record.isEditable = true;
                record.status = 'new';
                relGridData.push(record);
              }
            }

            relGrid.data = relGridData;
            var oldsize = relGrid.data.length;
            relGrid._getIronDataTable()._sizeChanged(oldsize+1,oldsize);
            relGrid.reRenderGrid();
          }

          popover.hide();
      },

      _dataIsNotNull: function(data){
				if(data) {
					return true;
				}
			},
			
      _isRelationshipType: function(relationshipType){
				if(relationshipType && relationshipType != '' && this.relationshipType != "Relationships") {
					return true;
				}
				else{
					return false;
				}
			},
			
      _getRelationshipGridConfig: function(relationshipTypeName) {
				return this.relationshipGridConfig[relationshipTypeName];
			},
			
      _getRelationshipGridData: function(relationshipTypeName) {
				return this.relationshipGridData[relationshipTypeName];
			},
			
      _prepareRelationshipGridData: function() {
				if(this.data) 
				{
					if(this.data.data && this.data.data.ctxInfo)
					{
						var contextInfo = this.data.data.ctxInfo[0];
						if(contextInfo && contextInfo.relationships)
						{
							if(this.relationshipType == undefined || this.relationshipType == '' || this.relationshipType == "Relationships")
							{
								Object.keys(contextInfo.relationships).forEach(function(element){
									this._populateData(element, contextInfo.relationships);
									this.relationshipTypeList.push(element.toLowerCase().replace(" ", ""));
								}, this);
							}
							else
							{
								this._populateData(this.relationshipType.toLowerCase().replace(" ", ""), contextInfo.relationships);
							}
						}
					}
				}
			},
			
      _populateData: function(relationshipTypeName, relationships){
          
          var data = [];
          var relatedEntities = relationships[relationshipTypeName];

          if(this.relationshipCustomGridConfig && this.relationshipCustomGridConfig.attributes)
          {
            relationshipAttributes = this.relationshipCustomGridConfig.attributes;
          }

          // Once object structre is getting change from array ot object needs to change this.
          relatedEntities.forEach(function(relElement){
            var record = {};

            if(relElement.attributes) {

              Object.keys(relElement.attributes).forEach(function(item){

                if(relElement.attributes[item]) {
                  record[item] = relElement.attributes[item].values[0].value;
                }
              }, this);
            }

            if(relElement.relToObject)
            {
              record["Related Entity"] = relElement.relToObject.id;

              if(relElement.relToObject.attributes) {

                  Object.keys(relElement.relToObject.attributes).forEach(function(item){

                    if(relElement.relToObject.attributes[item]) {
                      record[item] = relElement.relToObject.attributes[item].values[0].value;
                    }
                  }, this);
              }
            }
            data.push(record);
          }, this);
          
          this.relationshipGridData[relationshipTypeName] = data;
			},

      _convertIntoEntityLovList: function(entitiesResponse) {
        if(entitiesResponse) {
          var items = [];          
          if(entitiesResponse.content && entitiesResponse.content.entities) {
            var entities = entitiesResponse.content.entities;

            Object.keys(entities).forEach(function(item) {
              var entity = entities[item];
              if(entity && entity.data && entity.data.ctxInfo) {
                var ctxInfo = entity.data.ctxInfo;
                
                Object.keys(ctxInfo).forEach(function(dataItem) {
                  var data = ctxInfo[dataItem];
                  if(data) {
                    if(data.attributes) {
                      items.push({
                        "id":entity.id,
                        "title": data.attributes["csapDescriptionOfNart"].values[0].value,
                        "subtitle":data.attributes["cpimProductName"].values[0].value,
                        "image":"/src/images/lookup-item.jpg"});
                    }
                  }
                }, this);
              }
            }, this);
          }
          if(this._currentSelectedLov){
            this._currentSelectedLov.items = items;
            this._currentLovItems = items;
          }
        }
      }
		});
	})();
</script>
</dom-module>