<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">

<!--
`rock-relationship-grid` Represents assosiation relationship grid for the entity.

The following JSON objects are a sample of entity used for loading relationship grid.

Based on config relationship grid will get loaded with defined attributes from given data object.

```json [Config]
{
  "crosssell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}

```json [Data]
{
  "id": "e2",
  "dataObjectInfo": {
    "dataObjectType": "product",
    "dataObjectDomain": "thing"
  },
  "systemInfo": {
    "tenantId": "t1"
  },
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "ctxInfo": [
      {
        "ctxGroup": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crosssell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relToObject": {
                "id": "e5",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relToObject": {
                "id": "e6",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ]
        }
      }
    ]
  }
}
```

@demo demo/index.html
-->

<dom-module id="rock-relationship-grid">
	<template>
		<style include="pebble-styles-shared"></style>
		      <style>
        
            .relation-name {
                font-weight: 500;
                font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
                clear: both;
                padding-top: 10px;
                margin: 0px;
                font-size: var(--font-size-medium);
            }
            
            .relation-name-container {
                clear: left;
                @apply(--layout-horizontal);
                margin:18px 0 0 0;
            }

            .relation-line-box {
                margin-top:16px;
                margin-left:8px;
                margin-right:8px;
                @apply(--layout-flex);
            }

            .relation-name-box {
              display: inline-block;
            }

            pebble-horizontal-divider {
                --pebble-horizontal-divider-color: black;
            }

        </style>
		<template is="dom-if" if="{{_dataIsNotNull(data)}}">
			<template is="dom-if" if="{{_isRelationshipType(relationshipType)}}">
				<div class="relation-name-container">
					<div class="relation-name-box">
            <span class="relation-name">[[relationshipType]]</span>
          </div>
					<div class="relation-line-box">
						<pebble-horizontal-divider></pebble-horizontal-divider>
					</div>
				</div>
        </br>
				<pebble-grid id="entityRelationshipGrid" config="[[_getRelationshipGridConfig(relationshipType)]]" page-size="5" 
            attribute-models="{{attributeModels}}" data="[[_getRelationshipGridData(relationshipType)]]"></pebble-grid>					
			</template>
			<template is="dom-if" if="{{!_isRelationshipType(relationshipType)}}">
				<template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex">
					<div class="relation-name-container">
						<div class="relation-name-box">
              <span class="relation-name">[[relationship]]</span>
            </div>
						<div class="relation-line-box">
							<pebble-horizontal-divider></pebble-horizontal-divider>
						</div>
					</div>
          </br>          
					<pebble-grid id="entityRelationshipGrid" config="{{_getRelationshipGridConfig(relationship)}}" page-size="5" 
              attribute-models="{{attributeModels}}" data="{{_getRelationshipGridData(relationship)}}"></pebble-grid>
				</template>
			</template>
		</template>
	</template>
<script> 
	(function () {
		'use strict';

		Polymer({
			is: 'rock-relationship-grid',
			properties: {
				/**
				 * Indicates a data which is wrapped in a data-source that is used as a grid data.
				 * The format for the JSON object is given in the above description.
				 */
				data: {
					type: Object,
					notify: true,
					observer : '_prepareRelationshipGridData'
				},
				/*
				*	Indicates transformed relationship data for grid.
				*/	
				relationshipGridData: {
					type: Array,
					notify: true,
					value : function() {
						return [];
					}
				},

				/*
				*	Indicates transformed relationship grid config for grid.
				*/
				relationshipGridConfig : {
					type : Object,
					notify: true,
					value : function() {
            return {};
					}
				},

				/**
				 * Indicates an attribute models to be used.
				 */
				attributeModels: {
					type: Object,
					notify: true,
					value: function () {
						return {};
					}
				},

        /*
        * Indicates current or selected relationship type.
        */
				relationshipType: {
					type : String,
					notify: true
				},

        /*
        * Indicates list of relationships.
        */
				relationshipTypeList : {
					type : Array,
					notify : true,
					value : function() {
						return [];
					}
				}
			},
			
      _dataIsNotNull: function(data){
				if(data) {
					return true;
				}
			},
			
      _isRelationshipType: function(relationshipType){
				if(relationshipType && relationshipType != '' && this.relationshipType != "Relationships") {
					return true;
				}
				else{
					return false;
				}
			},
			
      _getRelationshipGridConfig: function(relationshipTypeName) {
				return this.relationshipGridConfig[relationshipTypeName];
			},
			
      _getRelationshipGridData: function(relationshipTypeName) {
				return this.relationshipGridData[relationshipTypeName];
			},
			
      _prepareRelationshipGridData: function() {
				if(this.data) 
				{
					if(this.data.data && this.data.data.ctxInfo)
					{
						var contextInfo = this.data.data.ctxInfo[0];
						if(contextInfo && contextInfo.relationships)
						{
							if(this.relationshipType == undefined || this.relationshipType == '' || this.relationshipType == "Relationships")
							{
								Object.keys(contextInfo.relationships).forEach(function(element){
									this._populateData(element, contextInfo.relationships);
									this.relationshipTypeList.push(element.toLowerCase().replace(" ", ""));
								}, this);
							}
							else
							{
								this._populateData(this.relationshipType[0].toLowerCase().replace(" ", ""), contextInfo.relationships);
							}
						}
					}
				}
			},
			
      _populateData: function(relationshipTypeName, relationships){
          
          var data = [];
          var relatedEntities = relationships[relationshipTypeName];

          if(this.relationshipCustomGridConfig && this.relationshipCustomGridConfig.attributes)
          {
            relationshipAttributes = this.relationshipCustomGridConfig.attributes;
          }

          relatedEntities.forEach(function(relElement){
            var record = {};

            if(relElement.attributes) {

              Object.keys(relElement.attributes).forEach(function(item){

                if(relElement.attributes[item]) {
                  record[item] = relElement.attributes[item].values[0].value;
                }
              }, this);
            }

            if(relElement.relToObject)
            {
              record["Related Entity"] = relElement.relToObject.id;

              if(relElement.relToObject.attributes) {

                  Object.keys(relElement.relToObject.attributes).forEach(function(item){

                    if(relElement.relToObject.attributes[item]) {
                      record[item] = relElement.relToObject.attributes[item].values[0].value;
                    }
                  }, this);
              }
            }
            data.push(record);
          }, this);
          
          this.relationshipGridData[relationshipTypeName] = data;
			}
		});
	})();
</script>
</dom-module>