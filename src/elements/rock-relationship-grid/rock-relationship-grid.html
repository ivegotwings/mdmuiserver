<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../pebble-grid/pebble-grid.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../liquid-entity-get/liquid-entity-get.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<!--
<<<<<<< HEAD
`rock-relationship-grid` Represents an assosiation relationship grid for an entity.
The following JSON objects depicts the entity that is used for loading the relationship grid.
Based on the config, relationship grid gets loaded with the defined attributes from the given data object.
=======
`rock-relationship-grid` Represents an assosiation relationship grid for an entity. The following JSON objects depicts the entity that 
is used for loading the relationship grid. Based on the config, relationship grid gets loaded with the defined attributes from the given data object.

>>>>>>> gb-review-set1
```json
{
  "crosssell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}
```
The following JSON object is a sample of data which can be used to bind the grid.
```json
{
  "id": "e2",
  "entityInfo": {
    "entityType": "product",
    "entityDomain": "thing"
  },
  "systemInfo": {
    "tenantId": "t1"
  },
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "ctxInfo": [
      {
        "ctxGroup": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crosssell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relToObject": {
                "id": "e5",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relToObject": {
                "id": "e6",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ]
        }
      }
    ]
  }
}
```
@demo demo/index.html
-->
<dom-module id="rock-relationship-grid">
  <template>
    <style include="pebble-styles-shared"></style>
    <style>
      pebble-button.icon-text-button {
        --pebble-button: {
          height: 30px;
          padding: 0.5em 0em 0.5em 0em;
          border: 1px solid #036BC3;
        }
        --pebble-button-iron-icon: {
          height: 18px;
          width: 18px;
          padding-bottom: 2px;
        }
      }
      
      .relation-name {
        font-weight: 500;
        font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        clear: both;
        padding-top: 10px;
        margin: 0px;
        font-size: var(--font-size-medium);
      }
      
      .relation-name-container {
        clear: left;
        @apply(--layout-horizontal);
        margin: 18px 0 0 0;
      }
      
      .relation-line-box {
        margin-top: 16px;
        margin-left: 8px;
        margin-right: 8px;
        @apply(--layout-flex);
      }
      
      .relation-name-box {
        display: inline-block;
      }
      
      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: black;
      }
      
      pebble-lov {
        width: 300px !important;
        max-height: 350px !important;
      }
      
       ::shadow iron-data-table {
        height: 200px !important;
      }
    </style>
    <template is="dom-if" if="{{_dataIsNotNull(data)}}">
				<template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex">
					<div class="relation-name-container">
						<div class="relation-name-box">
              <span class="relation-name">[[relationship]]</span>
            </div>
						<div class="relation-line-box">
							<pebble-horizontal-divider></pebble-horizontal-divider>
						</div>
            <pebble-button icon="pebble-icons:Create" id="[[relationship]]" class="icon-text-button" button-text="Add" on-click="onPopoverClick"></pebble-button>
            <pebble-popover for$="[[relationship]]" auto-fit-on-attach no-overlap>
                <pebble-lov id="[[relationship]]" items="{{items}}" show-image on-selection-changed="addRelatedEntity"></pebble-lov>
            </pebble-popover>
					</div>
          </br>          
					<pebble-grid id="[[relationship]]" config="{{_getRelationshipGridConfig(relationship)}}" page-size="10" 
              attribute-models="{{attributeModels}}" data="{{_getRelationshipGridData(relationship)}}"></pebble-grid>
				</template>
			</template>
    
    <liquid-entity-getdata auto id="initiateSearchResult" operation="initiatesearch" 
        request-data="{{_requestRelLOV}}" last-response="{{searchResponse}}"></liquid-entity-getdata>
    <liquid-entity-getdata auto id="searchResultGetDataService" operation="getsearchresultdetail" 
        request-data="{{_requestRelLOV}}" request-id="[[searchResponse.content.requestId]]" last-response="{{searchResultResponse}}"></liquid-entity-getdata>

    <liquid-entity-getdata id="entityGetData" name="entityGet" operation="getentities" request-data="{{_entityGetRequest}}" 
      last-response="{{entitiesResponse}}"></liquid-entity-getdata>
    
    <liquid-entity-getdata id="entityGetAddData" name="entityGet" operation="getentities" request-data="{{_entityGetAddRequest}}" 
      last-response="{{relEntitiesResponse}}"></liquid-entity-getdata>

	</template>
<script>
	(function () {
		'use strict';

		Polymer({
			is: 'rock-relationship-grid',
			properties: {
				/**
				 * Indicates a data which is wrapped in a data-source that is used as a grid data.
				 * The format for the JSON object is given in the above description.
				 */
        data: {
          type: Object,
          notify: true,
          observer : '_prepareRelationshipGridData'
        },
        /*
        *	Indicates transformed relationship data for grid.
        */	
        relationshipGridData: {
          type: Array,
          notify: true,
          value : function() {
            return [];
          }
        },

        /*
        *	Indicates transformed relationship grid config for grid.
        */
        relationshipGridConfig: {
          type : Object,
          notify: true,
          value : function() {
            return {};
          }
        },

        /**
         * Indicates an attribute models to be used.
         */
        attributeModels: {
          type: Object,
          notify: true,
          value: function () {
            return {};
          }
        },

        /*
        * Indicates current or selected relationship type.
        */
        relationshipType: {
          type : String,
          notify: true
        },

        /*
        * Indicates list of relationships.
        */
        relationshipTypeList: {
          type : Array,
          notify : true,
          value : function() {
            return [];
          }
        },

        /*
        */
        _entityGetRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },

        _entityGetAddRequest: {
            type:Object,
            notify: true,
            value: function() {
              return {};
            }
        },

        _currentRelationshipItem: {
          type: String,
          notify: true
        }
			},

      observers: [
          '_convertIntoEntityLovList(searchResultResponse)',
          '_addRelationship(relEntitiesResponse)'
      ],

      _currentSelectedLov: null,
      _currentLovItems: null,
			onPopoverClick: function(e) {
          var popover =  Polymer.dom(this).node.$$("pebble-popover[for=" + e.currentTarget.id + "]");
          var lov = Polymer.dom(this).node.$$("pebble-lov[id=" + e.currentTarget.id + "]");
          this._currentSelectedLov = Polymer.dom(this).node.$$('pebble-lov[id=' + e.currentTarget.id + ']');

          //TODO-dimensions has to be set in req. same like did in relationship-manage
          var req = {
            "params": {
              "query": {
                "ctx": [{
                  "list": "productMaster",
                  "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                }],
                "valCtx": [{
                  "source": "SAP",
                  "locale": "en-US"
                }],
                "filters": {
                  "attributesCriterion": [],
                  "typesCriterion": ["nart"]
                }
              },
              "fields": {
                "ctxTypes": [
                  "properties"
                ],
                "attributes": [
                  "cpimProductName",
                  "csapDescriptionOfNart",
                  "csapMaterialStatusGlobal",
                  "cpimSkinType"
                ],
                "relationships": ["ALL"]
              }
            }
          };

          this.set("_requestRelLOV", req);
          
          popover.show();
          lov.activate();
          this._currentSelectedLov.items = this._currentLovItems;
      },

      addRelatedEntity: function(e) {
        if(e.currentTarget.selectedItem){

          var popover =  Polymer.dom(this).node.$$("pebble-popover[for=" + e.currentTarget.id + "]");
          this._currentRelationshipItem = e.currentTarget.id;
          var selectedItem = e.currentTarget.selectedItem.id;
          
          var attributes = [];

          if(this.relationshipGridConfig && this.relationshipGridConfig[this._currentRelationshipItem]){
            var columns = this.relationshipGridConfig[this._currentRelationshipItem].tabular.columns;
            if(columns) {
                columns.forEach(function(col) {
                    if(col.isRelatedEntityAttribute) {
                        attributes.push(col.name);
                    }
                }, this);
            }
          }

          //TODO-dimensions has to be set in req. same like did in relationship-manage          
          var req = {
          "params": {
                  "query": {
                      "ctx": [
                          {
                              "list": "productMaster",
                              "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                          }
                      ],
                      "valCtx": [
                          {
                              "source": "SAP",
                              "locale": "en-US"
                          }
                      ],
                      "id": selectedItem,
                      "filters": {
                          "attributesCriterion": [],
                          "typesCriterion": [
                              "nart"
                          ]
                      }
                  },
                  "fields": {
                      "ctxTypes": [
                          "properties"
                      ],
                      "attributes": attributes
                  },
                  "options":{
                      "from": 0,
                      "to": 0
                  }
              }
          };

          this.set('_entityGetAddRequest', req);

          var relAddLiquid = Polymer.dom(this).node.$$('liquid-entity-getdata[id="entityGetAddData"]');
          if(relAddLiquid) {
            relAddLiquid.generateRequest();
          }

          popover.hide();
        }
      },

      _addRelationship: function() {
        if(this.relEntitiesResponse) {
          var relGrid =  Polymer.dom(this).node.$$('pebble-grid[id='+ this._currentRelationshipItem +']');

          if(relGrid) {
            if(this.relEntitiesResponse.content && this.relEntitiesResponse.content.entities)
            {
              var entities = this.relEntitiesResponse.content.entities;
              var relGridData = relGrid.data;

              Object.keys(entities).forEach(function(relitem) {
                var entity = entities[relitem];
                var record = {};
                if(entity && entity.data && entity.data.ctxInfo){
                  record["Related Entity"] = entity.id;
                  Object.keys(entity.data.ctxInfo).forEach(function(item) {
                    
                    if(entity.data.ctxInfo[item]) {
                      var attributes = entity.data.ctxInfo[item].attributes;
                      if(attributes) {
                        Object.keys(attributes).forEach(function(attrItem){
                          
                          if(attributes[attrItem]) {
                            record[attrItem] = attributes[attrItem].values[0].value;
                          }
                        }, this);
                      }
                    }
                  }, this);
                }
                record['entityInfo'] = entity.entityInfo;
                record['systemInfo'] = entity.systemInfo;
                record['properties'] = entity.properties;
                record['relationshipType'] = this._currentRelationshipItem;
                record.isEditable = true
                relGridData.push(record);
              }, this);
            }

            relGrid.data = relGridData;
            var oldsize = relGrid.data.length;
            relGrid._getIronDataTable()._sizeChanged(oldsize + 1, oldsize);
            relGrid.reRenderGrid();
            this.fire("editMode");
          }
        }
      },

      _dataIsNotNull: function(data){
				if(data) {
					return true;
				}
			},
			
      _isRelationshipType: function(relationshipType){
				if(relationshipType && relationshipType != '' && this.relationshipType != "Relationships") {
					return true;
				}
				else{
					return false;
				}
			},
			
      _getRelationshipGridConfig: function(relationshipTypeName) {
				return this.relationshipGridConfig[relationshipTypeName];
			},
			
      _getRelationshipGridData: function(relationshipTypeName) {
				return this.relationshipGridData[relationshipTypeName];
			},
			
      _prepareRelationshipGridData: function() {
				if(this.data) 
				{
					if(this.data.content && this.data.content.entities)
					{
            var entities = this.data.content.entities;
            var entityId = Object.keys(entities)[0];

            if(entityId){
              var entity = entities[entityId];
              if(entity && entity.data && entity.data.ctxInfo){
                  Object.keys(entity.data.ctxInfo).forEach(function(item) {
                    if(entity.data.ctxInfo[item]) {
                      var relationships = entity.data.ctxInfo[item].relationships;
                      var relationshipTyleList = [];

                      if(relationships) {
                        if(this.relationshipType == undefined || this.relationshipType == '' || this.relationshipType == "Relationships")
                        {
                          Object.keys(relationships).forEach(function(element){
                            this._populateData(element, relationships);
                            relationshipTyleList.push(element);
                          }, this);
                        }
                        else
                        {
                          this._populateData(this.relationshipType, relationships);
                        }

                        this.relationshipTypeList = undefined;
                        this.relationshipTypeList = relationshipTyleList;
                      }
                    }
                  }, this);
              }
            }
					}
				}
			},
			
      _populateData: function(relationshipTypeName, relationships){
          
          var data = [];
          var relatedEntities = relationships[relationshipTypeName];
          if (this.relationshipCustomGridConfig && this.relationshipCustomGridConfig.attributes) {
            relationshipAttributes = this.relationshipCustomGridConfig.attributes;
          }

          Object.keys(relatedEntities.rels).forEach(function(relItem){
            var record = {};
            var relElement = relatedEntities.rels[relItem];
            if(relElement.attributes) {
              Object.keys(relElement.attributes).forEach(function(item){
                if(relElement.attributes[item]) {
                  record[item] = relElement.attributes[item].values[0].value;
                }
              }, this);
            }
            if (relElement.relToObject) {
              record["Related Entity"] = relElement.relToObject.id;

              if(relElement.relToObject.data){
                var relCtxInfo = relElement.relToObject.data.ctxInfo;
                
                if(relCtxInfo) {
                  Object.keys(relCtxInfo).forEach(function(item) {
                    var relCtxList = relCtxInfo[item];
                    
                    if(relCtxList && relCtxList.attributes){
                      Object.keys(relCtxList.attributes).forEach(function(attrItem){
                        
                        if(relCtxList.attributes[attrItem]) {
                          record[attrItem] = relCtxList.attributes[attrItem].values[0].value;
                        }
                      }, this);
                    }
                  }, this);
                }
              }
            }
            data.push(record);
          }, this);
          this.relationshipGridData[relationshipTypeName] = data;
        },
        _convertIntoEntityLovList: function (entitiesResponse) {
          if (entitiesResponse) {
            var items = [];
            if (entitiesResponse.content && entitiesResponse.content.entities) {
              var entities = entitiesResponse.content.entities;
              Object.keys(entities).forEach(function (item) {
                var entity = entities[item];
                if (entity && entity.data && entity.data.ctxInfo) {
                  var ctxInfo = entity.data.ctxInfo;
                  Object.keys(ctxInfo).forEach(function (dataItem) {
                    var data = ctxInfo[dataItem];
                    if (data) {
                      if (data.attributes) {
                        items.push({
                          "id": entity.id,
                          "title": data.attributes["csapDescriptionOfNart"].values[0].value,
                          "subtitle": data.attributes["cpimProductName"].values[0].value,
                          "image": "/src/images/lookup-item.jpg"
                        });
                      }
                    }
                  }, this);
                }
              }, this);
            }
            if (this._currentSelectedLov) {
              this._currentSelectedLov.items = items;
              this._currentLovItems = items;
            }
          }
        }
      });
    })();
  </script>
</dom-module>
