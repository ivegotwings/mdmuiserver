<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-helpers/liquid-response-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-info-icon/pebble-info-icon.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">


<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html">
<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid-data-sources/entity-relationship-grid-datasource.html">
<link rel="import" href="../rock-entity-relationship-search-result-actions/rock-entity-relationship-search-result-actions.html">



<!--

`rock-relationship-grid` Represents an association relationship grid for an entity.
The following JSON objects depicts the entity that loads the relationship grid.
Based on the configuration, relationship grid gets loaded with the defined attributes from the given data object.

```json
{
  "crossSell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:action-delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:action-delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}
```
The following JSON object is a sample of data which binds the grid.
```json
{
  "id": "e2",
  "type": "product",
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "contexts": [
      {
        "context": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crossSell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relTo": {
                "id": "e5",
                "type": "product"
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relTo": {
                "id": "e6",
                "type": "product"
              }
            }
          ]
        }
      }
    ]
  }
}
```
@demo demo/index.html
-->
<dom-module id="rock-relationship-grid">
  <template>

    <style include="bedrock-style-common"></style>
    <style include="iron-flex">
      :host {
        display: block;
        height: 100%;
      }

      pebble-button.icon-text-button {
        --pebble-button: {
          height: 30px;
          padding-top: 0.5em;
          padding-right: 0em;
          padding-bottom: 0.5em;
          padding-left: 0em;
          border: 1px solid var(--primary-color);
        }
      }

      .accordion-grid-container {
        height: 100%;
        @apply --accordion-grid-container;
      }

      .relation-name-container {
        display:flex;
        flex-direction: row-reverse;
        padding:10px;
      }

      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: var(--tooltip-bg-color, rgba(25, 32, 39, 1));
      }

      pebble-lov {
        width: 300px !important;
        max-height: 350px !important;
      }

      #errorsDialog {
        --popup-header-color: var(--palette-pinkish-red, #ee204c);
      }

      #messageCard {
        text-align: center;
      }

      .quick-manage-container {
        width: 100%;
        position: relative;
      }

      .container {
        width: 100%;
        height: 100%;
      }

      pebble-vertical-divider {
        --pebble-vertical-divider-color: #c1cad4;
        height: 100%;
        border-top: 0px;
        border-right: 0px;
        border-bottom: 0px;
        border-left: 0px;
        min-height: 0px;
        width: 2px;
        margin-top: 0px;
        margin-right: 0px;
        margin-bottom: 0px;
        margin-left: 0px;
      }
      pebble-popover {
        --pebble-popover-max-width: 100%;
        --pebble-popover-width: 260px;
      }

      .relContainer {
        display: block;
        height: 100%;
        @apply --relationship-container-height;
      }

      .relation-name-container pebble-button {
        @apply --grid-actions;
      }

      .grid-wrap-container {
        height: 100%;
      }

      .quick-manage {
        @apply --grid-quick-manage;
      }
    </style>

    <template is="dom-if" if="[[!_isMessageAvailable]]">
      <div id="relContainer_[[relationship]]" class="relContainer">
        <pebble-accordion header-text="[[relationshipGridConfig.gridConfig.title]]"  
            show-accordion="[[showAccordion]]">
          <span slot="header-actions">
            <template is="dom-if" if="[[relationshipGridConfig.gridConfig]]">
              <pebble-info-icon description-object="[[relationshipGridConfig.gridConfig]]"></pebble-info-icon>
            </template>
          </span>
          <div slot="accordion-content" class="accordion-grid-container base-grid-structure">
            <div class="base-grid-structure-child-1">
            </div>
            <div class="contentContainer accordion-grid-content-row-item base-grid-structure-child-2">
              <div class$="grid-wrap-container [[_applyClass(_quickManageEnabled)]]">
                <div class="container col-8-4-grid-child-1">
                  <entity-relationship-grid-datasource id="datasource_[[relationship]]" request="[[_getRelationshipGridRequest(relationship)]]"
                    r-data-source="{{rDataSource}}" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" r-data-formatter="{{rDataFormatter}}"
                    buffer-record-size="{{size}}" current-record-size="{{currentRecordSize}}" data-object-type="[[relationshipGridConfig.gridConfig.dataObjectType]]"
                    result-record-size="{{resultRecordSize}}" total-count="{{totalCount}}" apply-context-coalesce="[[relationshipGridConfig.gridConfig.applyContextCoalesce]]"></entity-relationship-grid-datasource>
                  <div class="base-grid-structure">
                    <div class="relation-name-container accordion-grid-header-row-item base-grid-structure-child-1">
                      <template is="dom-if" if="[[relationshipGridConfig.gridConfig.hasWritePermission]]">
                        <template is="dom-if" if="[[relationshipGridConfig.copyActionConfig]]">
                          <pebble-button class="btn btn-primary tooltip-bottom" id="copy_btn" data-tooltip$="[[_clipboardTooltip]]" button-text="Copy ID(s)"
                            on-tap="_onTapCopyAction" on-mouseout="_onMouseoutCopyAction"></pebble-button>
                        </template>
                        <pebble-button icon="pebble-icon:action-add" disabled="[[readonly]]" id="button_[[relationship]]" relationship="[[relationship]]"
                          class="btn btn-primary m-r-10 auto-width addbutton" button-text="Add" on-tap="_onAddRelClick"></pebble-button>
                        <template is="dom-if" if="[[_displayAddNewRelationship(relationshipGridConfig)]]">
                          <pebble-button icon="pebble-icon:action-add" disabled="[[readonly]]" id="addnewbutton_[[relationship]]" relationship="[[relationship]]"
                            class="btn btn-primary m-r-10 auto-width addbutton" button-text="Add New" on-tap="_onAddNewRelClick"></pebble-button>
                          <bedrock-pubsub event-name="entity-created" handler="_onEntityCreated"></bedrock-pubsub>
                        </template>
                      </template>
                      <pebble-popover for$="button_[[relationship]]" vertical-align="auto" horizontal-align="auto" no-overlap>
                        <rock-entity-lov on-lov-confirm-button-tap="_onLovConfirmButtonTapped" id="lov_[[relationship]]" data-index$="[[dataIndex]]"
                          data-sub-index$="[[dataSubIndex]]" request-data="[[_requestForAddRelationshipList(relationship)]]"
                          id-field="[[_getIdField()]]" image-id-field="[[_getImageIdField()]]" title-pattern="[[_getTitlePattern()]]"
                          selected-items="[[_getSavedRelationshipItems( relationship, _savedRelationshipItemsToLov)]]" excluded-ids=[[excludedIds]]
                          multi-select no-sub-title show-action-buttons></rock-entity-lov>
                      </pebble-popover>
                      <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLovConfirmButtonTapped" target-id="lov_[[relationship]]"></bedrock-pubsub>
                      <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLovCloseButtonTapped" target-id="lov_[[relationship]]"></bedrock-pubsub>
                    </div>
                    <div class="base-grid-structure-child-2">
                      <rock-grid id$="[[relationship]]" class$="[[getwrapClass]]" readonly="[[readonly]]" context-data="[[contextData]]" r-data-source="{{rDataSource}}"
                        r-data-source-id="datasource_[[relationship]]" config="{{relationshipGridConfig.gridConfig}}" attribute-models="[[_getRelationshipAttributeModels(relationship)]]"
                        grid-data-size="{{size}}" current-record-size="{{currentRecordSize}}" max-configured-count="[[maxConfiguredCount]]"
                        row-drag-drop-enabled="[[_getRowDragDropEnabled()]]" on-row-drop-event-raised="_onRowDropEventRaised"
                        result-record-size="{{resultRecordSize}}" total-count="{{totalCount}}" page-size="[[pageSize]]" apply-context-coalesce="[[relationshipGridConfig.gridConfig.applyContextCoalesce]]">
                        <rock-entity-relationship-search-result-actions slot="toolbar" id="gridActions" context-data="[[contextData]]" has-write-permissions="[[_hasWritePermissions(relationshipGridConfig.gridConfig)]]"></rock-entity-relationship-search-result-actions>
                      </rock-grid>
                      <template is="dom-if" if="[[showActionButtons]]">
                        <div id="buttonContainer" align="center" class="buttonContainer-static">
                          <pebble-button id="cancel" class="button btn btn-secondary m-r-5" button-text="Cancel" on-tap="_revertAll" elevation=1 raised></pebble-button>
                          <pebble-button id="save" class="focus btn btn-success" disabled="[[readonly]]" button-text="Save" on-tap="_save" elevation=1
                            raised></pebble-button>
                        </div>
                      </template>
                    </div>
                  </div>
                  <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub event-name="grid-deselecting-item" handler="_onDeSelectingGridItem" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub event-name="download-original-asset" handler="_onOriginalAssetDownloadAction" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub event-name="delete-item" handler="_onDeleteEntityRelationshipAction" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub target-id="[[relationship]]" event-name="on-grid-msg-dialog-ok" handler="_onRevertDialogOk"></bedrock-pubsub>
                  <bedrock-pubsub event-name="grid-bulk-edit-items" handler="_onBulkEdit" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub event-name="grid-bulk-relationship-edit-items" handler="_onBulkRelationshipEdit" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub event-name="grid-custom-toolbar-event" handler="_onCustomToolbarEvent" target-id="[[relationship]]"></bedrock-pubsub>

                </div>
                <template is="dom-if" if="[[_quickManageEnabled]]">

                  <div class="quick-manage-container col-8-4-grid-child-2">
                    <div class="divider-wrapper">
                      <pebble-vertical-divider></pebble-vertical-divider>
                    </div>
                    <rock-entity-quick-manage id="entityQuickManage" readonly="[[readonly]]" data-object-type="relationship" no-header context-data="[[contextData]]"
                      current-index="{{_currentIndex}}" current-record-size="[[currentRecordSize]]" selected-entity="[[_selectedEntity]]"
                      relationship="[[relationship]]"></rock-entity-quick-manage>
                    <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                    <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                    <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                  </div>
                </template>
              </div>
            </div>

          </div>
        </pebble-accordion>
      </div>

      <liquid-entity-data-get id="entityGetData" name="entityGet" operation="getbyids" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]"
        request-data="{{_entityGetRequest}}" last-response="{{entitiesResponse}}"></liquid-entity-data-get>
      <liquid-entity-data-get id="entityGetAddData" name="entityGet" operation="getbyids" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]"
        request-data="{{_entityGetAddRequest}}" last-response="{{relEntitiesResponse}}"></liquid-entity-data-get>
      <liquid-entity-data-save name="attributeSaveDataService" operation="update" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]"
        request-data="{{_saveRequest}}" last-response="{{_saveResponse}}" on-response="_onSaveResponse"></liquid-entity-data-save>
      <liquid-rest id="entityGovernService" url="/data/pass-through/entitygovernservice/validate" method="POST" request-data={{_entityGovernRequest}}
        on-liquid-response="_onEntityGovernResponse" on-liquid-error="_onEntityGovernFailed">
      </liquid-rest>
      <liquid-entity-data-save id="entityRelationsSaveService" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" request-data="[[_saveRelationsRequest]]"
        last-response="{{_saveRelationsResponse}}" on-response="_onRelationsSaveResponse" on-error="_onRelationsSaveError">
      </liquid-entity-data-save>
      <liquid-entity-data-save id="entityRelationsDeleteService" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]"
        on-response="_onRelationsDeleteResponse" on-error="_onRelationsSaveError">
      </liquid-entity-data-save>
      <pebble-dialog id="errorsDialog" dialog-title="Errors on page" modal small>
        <p>Found below errors in entity details: </p>
        <ul>
          <template is="dom-repeat" items="[[_errorMessages]]">
            <li>[[item.relationshipRelToId]] with error:[[item.message]]</li>
          </template>
        </ul>
        <p>Do you want to fix the errors or continue?</p>
        <div class="buttons">
          <pebble-button dialog-confirm class="btn btn-success" button-text="Fix" on-tap="_fixErrors"></pebble-button>
          <pebble-button dialog-confirm class="btn btn-secondary" on-tap="_skipErrors" button-text="Skip & Continue"></pebble-button>
        </div>
      </pebble-dialog>

    </template>
    <bedrock-pubsub on-bedrock-event-gridsaveinsplit="refresh" name="bedrock-event-gridsaveinsplit"></bedrock-pubsub>
    <bedrock-pubsub event-name="refresh-relationship-grid" handler="_onRefreshRelationshipGridEvent"></bedrock-pubsub>
    <liquid-rest id="getDownloadUrl" url="/data/binarystreamobjectservice/prepareDownload" method="POST" on-liquid-response="_onGetDownloadUrlResponse">
    </liquid-rest>
    <div id="messageCard">
    </div>
    <pebble-dialog id="gridMsgDialog" dialog-title="Confirmation" show-ok show-cancel show-close-icon alert-box modal>
      <p id="msgDialog"></p>
    </pebble-dialog>
    <bedrock-pubsub target-id="gridMsgDialog" event-name="on-buttonok-clicked" handler="_onDialogOk"></bedrock-pubsub>
    <bedrock-pubsub event-name="global-edit" handler="_onGlobalEdit"></bedrock-pubsub>
    <bedrock-pubsub event-name="quick-manage-event" handler="_onTapQuickManage"></bedrock-pubsub>
    <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_relationshipModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse">
    </liquid-entity-model-composite-get>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-relationship-grid',

        properties: {
          /**
           * Indicates the data which is wrapped in the data-source that is used as a grid data.
           * The format for the JSON object is given in the above description.
           */
          data: {
            type: Object,
            notify: true
          },
          /**
           * If set as true , it indicates the component is in read only mode
           */
          readonly: {
            type: Boolean,
            value: false
          },
          /*
           *	Indicates the transformed relationship data for the grid.
           */
          relationshipGridData: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },

          getwrapClass: {
            type: String,
            value: ""
          },

          showActionButtons: {
            type: Boolean,
            value: false
          },
          /*
           *	Indicates the transformed relationship grid configuration for the grid.
           */
          relationshipGridConfig: {
            type: Object,
            notify: true
          },
          /**
           * Indicates the attribute models.
           */
          attributeModels: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /*
           * Indicates the currently selected relationship type.
           */
          relationshipType: {
            type: String,
            notify: true
          },
          /*
           * Indicates the title for the selected relationship type.
           */
          relationshipTitle: {
            type: String,
            notify: true
          },
          /*
           * Indicates the list of relationships.
           */
          relationship: {
            type: String,
            value: ""
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          rDataFormatter: {
            notify: true,
            value: function () {
              return this._populateDataForGrid.bind(this);
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          dataObject: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          relReq: {
            type: Object,
            value: function () {
              return {};
            }
          },
          maxConfiguredCount: {
            type: Number,
            value: function () {
              return DataObjectFalcorUtil.getPathKeys().dataIndexInfo.entityData.dataSubIndexInfo.data.maxRecordsToReturn;
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          contextData: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          doSyncValidation: {
            type: Boolean,
            value: true
          },
          _savedRelationshipItemsToLov: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /*
           */
          _entityGetRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _entityGetAddRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _selectedDimensions: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _relationshipModelRequest: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _isMessageAvailable: {
            type: Boolean,
            value: false
          },
          _quickManageEnabled: {
            type: Boolean,
            value: false
          },
          showAccordion: {
            type: Boolean,
            value: true
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          messageCodeMapping: {
            type: Object,
            value: function () { return {}; }
          },
          functionalMode: {
            type: "String",
            value: "default"
          },
          _entityRelations: {
            type: Array,
            value: function () {
              return [];
            }
          },
          _deleteItemRelationshipType: {
            type: String,
            value: null
          },
          _modifiedEntityRelationship: {
            type: Object
          },
          _clipboardTooltip: {
            type: String,
            value: "Copy to clipboard."
          },
          globalEdit: {
            type: Boolean,
            notify: true
          },
          _originalEntity: {
            type: Object
          },
          addRelationshipGridConfig: {
            type: Object,
            value: function () {
              return {};
            }
          },
          excludedIds: {
            type: Array,
            value: function () {
              return [];
            }
          },
          dataIndex: {
            type: String,
            value: "entityData"
          },
          dataSubIndex: {
            type: String,
            value: "data"
          },
          loadGovernData: {
            type: Boolean,
            value: true
          },
          _relationshipModels: {
            type: Object,
            value: function () { return {}; }
          },
          _relationshipDeleteItems: {
            type: Object,
            value: function () {
              return {};
            }
          },
          domain: {
            type: String,
            value: "generic"
          },
          entityName: {
            type: String,
            value: ""
          }
        },

        behaviors: [
          RUFBehaviors.AppBehavior,
          RUFBehaviors.ComponentContextBehavior
        ],

        observers: [
          '_convertIntoEntityLovList(searchResultResponse)',
          '_addRelationship(relEntitiesResponse)',
          '_getGridClass(showActionButtons)',
          '_preparePrimaryContexts(contextData.*)'
        ],

        listeners: {
          'editMode': '_onEditMode'
        },

        _currentSelectedLov: null,
        _currentLovItems: null,

        get getDownloadUrlLiq() {
          this._getDownloadUrl = this._getDownloadUrl || this.shadowRoot.querySelector("#getDownloadUrl");
          return this._getDownloadUrl;
        },

        _preparePrimaryContexts: async function () {
          this._primaryContexts = await ContextHelper.getPrimaryContexts(this.contextData);
        },

        _applyClass: function () {
          if (this._quickManageEnabled) {
            return "grid-quick-manage-container col-8-4-grid";
          }
          return "";
        },
        ready: function () {
          this._getGridClass();
          var firstItemContext = ContextHelper.getFirstItemContext(this.contextData);
          if (!_.isEmpty(firstItemContext)) {
            this.excludedIds.push(firstItemContext.id);
          }

          var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
          this.set("_relationshipModelRequest", compositeModelGetRequest);
          var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
          if (liquidModelGet && compositeModelGetRequest) {
            liquidModelGet.generateRequest();
          }
        },
        _hasWritePermissions: function (gridConfig) {
          return gridConfig["hasWritePermission"];
        },
        _getRelationshipGrid: function () {
          return this.shadowRoot.querySelector("rock-grid");
        },
        _getRowDragDropEnabled: function () {
          var isOrderAvailable = false;
          var isRowDragDropEnabled = false;
          var dragDropEnable = false;
          var isOrderAvailableInColumns = false;
          if (DataHelper.isValidObjectPath(this.relationshipGridConfig, "gridConfig.itemConfig.fields")) {
            var columns = this.relationshipGridConfig.gridConfig.itemConfig.fields;
            var columnsList = DataHelper.convertObjectToArray(columns)
            if (columnsList) {
              for (var i = 0; i < columnsList.length; i++) {
                if (columnsList[i].name == "order") {
                  isOrderAvailableInColumns = true;
                  break;
                }
              }
            }
          }
          if (isOrderAvailableInColumns && DataHelper.isValidObjectPath(this.relationshipGridConfig, "gridConfig.itemConfig.sort.default")) {
            var defaultSortList = this.relationshipGridConfig.gridConfig.itemConfig.sort.default;
            if (defaultSortList) {
              for (var i = 0; i < defaultSortList.length; i++) {
                if (defaultSortList[i].field == "order") {
                  isOrderAvailable = true;
                  break;
                }
              }
            }
          }
          if (DataHelper.isValidObjectPath(this.relationshipGridConfig, "gridConfig.rowDragDropEnabled")) {
            isRowDragDropEnabled = this.relationshipGridConfig.gridConfig.rowDragDropEnabled;
          }
          if (isOrderAvailable && isRowDragDropEnabled) {
            dragDropEnable = true;
          }
          return dragDropEnable;
        },
        _onSelectingGridItem: function (e, detail, sender) {
          if (this._quickManageEnabled) {
            var grid = this._getRelationshipGrid();
            this._selectedEntity = detail.item;
            if (!_.isEmpty(this._selectedEntity)) {
              var itemContext = ContextHelper.getFirstItemContext(this.contextData);
              itemContext.relationshipId = this._selectedEntity.relationshipId;
              itemContext.relatedEntityType = this._selectedEntity.type;
              itemContext.relationships = [this.relationship];
              grid.clearSelection();
              Polymer.Async.microTask.run(() => {
                this._currentIndex = grid.getSelectedItemIndex();
              });
            }
          }
          this._reloadQuickManage();
        },
        _reloadQuickManage() {
          const entityQuickManage = this.shadowRoot.querySelector("#entityQuickManage");
          if (entityQuickManage) {
            entityQuickManage.reload();
          }
        },
        _onDeSelectingGridItem: function (e, detail, sender) {
          if (this._quickManageEnabled) {
            this._selectedEntity = {};
          }
        },
        _onClickPrevious: function (e, detail, sender) {
          if (this._currentIndex > 0) {
            this._selectRelationship(this._currentIndex - 1);
          }
        },
        _onClickNext: function (e, detail, sender) {
          if (this._currentIndex < this.currentRecordSize) {
            this._selectRelationship(this._currentIndex + 1);
          }
        },
        _selectRelationship: function (index, nav) {
          if (!(index < 0)) {
            var grid = this._getRelationshipGrid();
            var gridData = grid.getData();
            var selectedItem = gridData[index];
            this._selectedEntity = selectedItem;
            var itemContext = ContextHelper.getFirstItemContext(this.contextData);
            if (!_.isEmpty(selectedItem)) {
              itemContext.relationshipId = selectedItem.relationshipId;
              itemContext.relationships = [this.relationship];
              grid.clearSelection(); //Clear current selection
              grid.selectItem(selectedItem); //
              this._currentIndex = grid.getSelectedItemIndex();
              grid.scrollToIndex(this._currentIndex);
            }
            this._reloadQuickManage();
          }
        },

        _onTapQuickManage: function (e) {
          var relationship = this.relationship;
          if(e && e.detail && e.detail.enableQuickManage){
            if(!this._quickManageEnabled){
              this._quickManageEnabled = e.detail.enableQuickManage;
            }
          }else{
            this._quickManageEnabled = !this._quickManageEnabled;
          }
          var grid = this._getRelationshipGrid();
          if (this._quickManageEnabled) {
            var selectedItem = grid.selectedItem;
            if (!selectedItem) {
              var selectedItems = grid.getSelectedItems();
              if (selectedItems.length) {
                selectedItem = selectedItems[selectedItems.length - 1];
              }
            }
            this._selectedEntity = selectedItem;
            var itemContext = ContextHelper.getFirstItemContext(this.contextData);
            if (!_.isEmpty(selectedItem)) {
              itemContext.relationshipId = selectedItem.relationshipId;
              itemContext.relatedEntityType = selectedItem.type;
              itemContext.relationships = [relationship];
              grid.clearSelection(); //Clear current selection
              grid.selectItem(selectedItem); //
              this._currentIndex = grid.getSelectedItemIndex();
              grid.scrollToIndex(this._currentIndex);
            }
          } else {
            this._currentIndex = -1;
          }
          this._reloadQuickManage();
        },
        _getAttributeList: function () {
          if (this.relationshipGridConfig) {
            return this.relationshipGridConfig.relationshipTypeAndAttributes;
          }
        },
        _getRelatedEntityAttributeList: function () {
          var attributes = this._getAttributeList();
          var relatedEntityAttributes = [];
          if (attributes && attributes.relatedEntityAttributes) {
            relatedEntityAttributes = attributes.relatedEntityAttributes;
          }
          return relatedEntityAttributes;
        },
        _getRelationshipTypeTitle: function () {
          if (this.relationshipGridConfig) {
            var config = this.relationshipGridConfig.gridConfig;
            if (config && config.title && config.title != "") {
              return config.title;
            }
          }
          return this.relationship;
        },
        _getQuickManageConfig: function (configName) {
          return this.relationshipGridConfig.quickManageConfig[configName];
        },
        _getRelationshipGridRequest: function (relationshipTypeName) {
          var req = DataHelper.cloneObject(this.relReq);
          if (req && relationshipTypeName) {
            var relAttr = this._getAttributeList();
            if (relAttr) {
              req.params.fields.relationshipAttributes = relAttr.relationshipAttributes;
              req.params.fields.relatedEntityAttributes = relAttr.relatedEntityAttributes;
            }
            req.params.fields.relationships = [relationshipTypeName];
          }
          return req;
        },
        _getRelationshipAttributeModels: function () {
          var config = this.relationshipGridConfig;
          var attrModels = {};
          if (config) {
            attrModels = config.relationshipAttributeModels;
            var relEntityAttrModels = config.relatedEntityModel.relatedEntityAttributeModels;
            for (var key in relEntityAttrModels) {
              attrModels[key] = relEntityAttrModels[key];
            }
          }
          return attrModels;
        },
        _getRelationshipModel: function () {
          var config = this.relationshipGridConfig;
          var relModel = {};
          if (config && "relationshipModel" in config) {
            relModel = config.relationshipModel;
          }
          return relModel;
        },
        _getRelatedEntityContexts: function () {
          var config = this.relationshipGridConfig;
          var relatedEntityContexts;
          if (config) {
            relatedEntityContexts = config.relatedEntityModel.relatedEntityContexts;
          }
          return relatedEntityContexts;
        },
        _populateDataForGrid: async function (respData, event) {
          var data = [];
          if (respData) {

            if (respData.content && respData.content.entities) {
              var entities = respData.content.entities;
              if (entities && entities.length > 0) {

                var entity = entities[0];
                //Need to check why is this required?
                if (this.dataObject && !this.dataObject["blankEntity"]) {
                  this.dataObject["blankEntity"] = entity;
                }

                var currentRel = "";
                var isSelfContext = false;
                if (event.detail.request) {
                  currentRel = event.detail.request.requestData.params.fields.relationships[0];
                  if (currentRel) {
                    var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
                    if (currentRelGrid && currentRelGrid.config && currentRelGrid.config.mode && currentRelGrid.config.mode == "edit") {
                      currentRelGrid.changeToEditMode();
                    }
                  }
                }

                var relConfig = this.relationshipGridConfig;

                var relationships = EntityHelper.getCoalescedRelationshipByType(entity, this.contextData, currentRel);
                if (!_.isEmpty(relationships)) {

                  var additionalContexts = [];
                  var primaryContexts = [];

                  var firstItemContext = ContextHelper.getFirstItemContext(this.contextData);
                  var firstDataContext = ContextHelper.getFirstDataContext(this.contextData);

                  if (!_.isEmpty(firstDataContext)) {
                    var contextModel = await ContextModelManager.getContextModelByEntityTypeAndDataContext(firstItemContext.type, firstDataContext);
                    if (contextModel) {
                      additionalContexts = contextModel.properties ? contextModel.properties.additionalcontexts : undefined;
                      primaryContexts = DataTransformHelper.getPrimaryContextKeysFromContextModel(contextModel, additionalContexts);

                      if (!_.isEmpty(primaryContexts)) {
                        DataTransformHelper.removeCoalescePropertiesFromRelationshipBasedOnAdditionalContext(relationships, this._getRelationshipModel(), additionalContexts, primaryContexts);
                      }
                    }
                  }

                  //Need to check why is this required?
                  this._entityRelations = this._entityRelations.concat(relationships);

                  if (this.dataObject) {
                    if (!this.dataObject[currentRel]) {
                      this.dataObject[currentRel] = entity;
                    }
                  }

                  var relationshipAttributeModels = this._getRelationshipAttributeModels();
                  var savedItemsToLov = [];
                  var entityTypeManager = EntityTypeManager.getInstance();
                  relationships.forEach(function (relItem) {
                    if (relItem) {
                      var record = {};
                      var lovItem = {};
                      if (relItem.attributes) {
                        Object.keys(relItem.attributes).forEach(function (item) {
                          if (item && relItem.attributes[item]) {
                            var valueObjs = relItem.attributes[item].values;
                            var model = relationshipAttributeModels[item];
                            var refEntityType = model && model.referenceEntityTypes && model.referenceEntityTypes.length > 0 ? model.referenceEntityTypes[0] : "";
                            if(!_.isEmpty(valueObjs)) {
                              if(valueObjs.length > 1) {
                                var values = [];
                                var referenceDataId = [];
                                for(var valueIndex = 0;valueIndex < valueObjs.length;valueIndex++){
                                  values.push(valueObjs[valueIndex].value);
                                  if(valueObjs[valueIndex].properties && valueObjs[valueIndex].properties.referenceData) {
                                    var referenceData = valueObjs[valueIndex].properties.referenceData;
                                    var referenceDataId = referenceData.replace(refEntityType + "/", "");
                                    referenceDataId.push(referenceDataId);
                                  }
                                }
                                record[item] = values;
                                if(!_.isEmpty(referenceDataId)) {
                                  record[item + "_referenceDataId"] = referenceDataId;
                                }
                              } else {
                                record[item] = valueObjs[0].value;
                                if(valueObjs[0].properties && valueObjs[0].properties.referenceData) {
                                  var referenceData = valueObjs[0].properties.referenceData;
                                  var referenceDataId = referenceData.replace(refEntityType + "/", "");
                                  record[item + "_referenceDataId"] = referenceDataId;
                                }
                              }
                            }
                          }
                        }, this);
                      }

                      if (relItem.properties) {
                        if (!_.isEmpty(relItem.properties.contextCoalesce) || !_.isEmpty(relItem.properties.instanceCoalesce)) {
                          record["contextCoalescePaths"] = DataTransformHelper.getContextCoalescePaths(relItem.properties, this.getFirstDataContext());
                        }
                      }

                      if (relItem.relTo) {
                        record["relationshipId"] = relItem.relTo.id;
                        record["Relationship Id"] = relItem.relTo.id;
                        record["Related Entity"] = record["id"] = relItem.relTo.id;
                        record["type"] = relItem.relTo.type;
                        lovItem["id"] = relItem.relTo.id;
                        lovItem["title"] = relItem.relTo.id;
                        record["typeExternalName"] = entityTypeManager.getTypeExternalNameById(relItem.relTo.type);
                        savedItemsToLov.push(lovItem);

                        //It will required in case of default sorting.
                        if (relItem.relTo.properties) {
                          var properties = relItem.relTo.properties;
                          Object.keys(properties).forEach(function (property) {
                            if (property && properties[property]) {
                              record[property.toLocaleLowerCase()] = properties[property];
                            }
                          }, this);
                        }

                        if (relItem.relTo.data) {
                          //var relCtxList = relContexts[item];
                          var relatedAttributes = EntityHelper.getAllAttributes(relItem.relTo);
                          if (relatedAttributes) {
                            Object.keys(relatedAttributes).forEach(function (
                              attrItem) {
                              if (attrItem && relatedAttributes[attrItem]) {
                                var valueObjs = relatedAttributes[attrItem].values;
                                var model = relationshipAttributeModels[attrItem];
                                var refEntityType = model && model.referenceEntityTypes && model.referenceEntityTypes.length > 0 ? model.referenceEntityTypes[0] : "";
                                  if(!_.isEmpty(valueObjs)) {
                                    if(valueObjs.length > 1) {
                                      var values = [];
                                      var referenceDataId = [];
                                      for(var valueIndex = 0;valueIndex < valueObjs.length;valueIndex++){
                                        values.push(valueObjs[valueIndex].value);
                                        if(valueObjs[valueIndex].properties && valueObjs[valueIndex].properties.referenceData) {
                                          var referenceData = valueObjs[valueIndex].properties.referenceData;
                                          var referenceDataId = referenceData.replace(refEntityType + "/", "");
                                          referenceDataId.push(referenceDataId);
                                        }
                                      }
                                      record[attrItem] = values;
                                      if(!_.isEmpty(referenceDataId)) {
                                        record[attrItem + "_referenceDataId"] = referenceDataId;
                                      }
                                    } else {
                                      record[attrItem] = valueObjs[0].value;
                                      if(valueObjs[0].properties && valueObjs[0].properties.referenceData) {
                                        var referenceData = valueObjs[0].properties.referenceData;
                                        var referenceDataId = referenceData.replace(refEntityType + "/", "");
                                        record[attrItem + "_referenceDataId"] = referenceDataId;
                                      }
                                    }
                                  }
                              }
                            }, this);
                          }
                        }
                      }
                      if (!record.thumbnailid) {
                        record.thumbnailid = "";
                        if (this.typeThumbnailMapping && this.typeThumbnailMapping[record.type]) {
                          record.thumbnailid = this.typeThumbnailMapping[record.type];
                        }
                      }
                      data.push(record);
                    }
                  }, this);


                  //Need to check why is this required?
                  var savedRelationships = this._savedRelationshipItemsToLov;
                  if (savedRelationships[currentRel]) {
                    savedRelationships[currentRel] = savedRelationships[currentRel].concat(savedItemsToLov);
                  }
                  else {
                    savedRelationships[currentRel] = savedItemsToLov;
                  }

                  this._savedRelationshipItemsToLov = {};
                  this._savedRelationshipItemsToLov = savedRelationships;

                  var defaultSort;
                  if (DataHelper.isValidObjectPath(relConfig, "gridConfig.itemConfig.sort.default")) {
                    defaultSort = relConfig.gridConfig.itemConfig.sort.default;
                  }
                  if (!_.isEmpty(defaultSort)) {
                    data = this._sortRelationshipRecords(data, defaultSort);
                  }
                }
              }
            }
          }

          return data;
        },

        _sortRelationshipRecords: function (data, defaultSort) {
          var resultData = DataHelper.cloneObject(data);
          if (data && defaultSort && defaultSort.length) {
            resultData = this._setDefaultValue(resultData, defaultSort);
            if(defaultSort.length > 1){  // multiple column sort              
                var firstSortItem = defaultSort.slice(0,1)[0];
                var addtionalSortItems = defaultSort.slice(1);
                for(var i = 0; i < addtionalSortItems.length; i++){
                    var field = addtionalSortItems[i].field;
                    addtionalSortItems[i].name = field;
                    addtionalSortItems[i].dataType = this._getDataTypeByName(field);
                }
                var dataType = this._getDataTypeByName(firstSortItem.field);
                resultData = DataHelper.sort(resultData, firstSortItem.field, dataType, firstSortItem.sortType, addtionalSortItems);
                
            }else if(defaultSort.length == 1){ // one column sort              
              var sortItem = defaultSort[0];
              var dataType = this._getDataTypeByName(sortItem.field);
              resultData = DataHelper.sort(resultData, sortItem.field, dataType, sortItem.sortType);
            }           
          }
          return resultData;
        },
        //Set null field with default value if any
        _setDefaultValue: function (resultData, defaultSort) {
          for (var i = 0; i < defaultSort.length; i++) {
            if (defaultSort[i].defaultValue) {
              for (j = 0; j < resultData.length; j++) {
                if (!resultData[j][defaultSort[i].field]) {
                  resultData[j][defaultSort[i].field] = defaultSort[i].defaultValue;
                }
              }
            }
          }

          return resultData;
        },
        _getDataTypeByName: function (attrName) {
          var dataType = "string";
          if (attrName) {
            dataType = AttributeHelper.getPropertyTypeByName(attrName);
            if (_.isEmpty(dataType)) {
              var attrModels = this._getRelationshipAttributeModels();
              if (attrModels && attrModels[attrName]) {
                dataType = attrModels[attrName].properties.dataType;
              }
            }
          }
          return dataType;
        },
        _onMouseoutCopyAction: function () {
          this.set("_clipboardTooltip", "Copy to clipboard.");
        },
        _onTapCopyAction: function (ev) {
          var grid = this._getRelationshipGrid();
          if (grid) {
            var selectedItems = grid.getSelectedItems();
            if (selectedItems && selectedItems.length) {

              var delimeter = ",";
              if (this.relationshipGridConfig.copyActionConfig.delimeter) {
                delimeter = this.relationshipGridConfig.copyActionConfig.delimeter;
              }
              var _attr = "";
              if (this.relationshipGridConfig.copyActionConfig.attributeField) {
                _attr = this.relationshipGridConfig.copyActionConfig.attributeField;
              }
              var copyString = "";
              selectedItems.forEach(element => {
                if (element && element.id) {
                  if (_attr && element[_attr]) {
                    copyString += element[_attr] + delimeter;
                  }
                }
              });
              if (copyString) {
                var finalCopyString = copyString.substr(0, copyString.length - delimeter.length);
                DataHelper.copyToClipboard(finalCopyString);
                this.set("_clipboardTooltip", "Copied!");
              }

            } else {
              this.showInformationToast("Please select at least one relationship from grid to copy.");
            }
          }
        },
        _onAddRelClick: function (e) {
          if (e.currentTarget.disabled == true) {
            return;
          }
          if (this.addRelationshipMode == "lov") {
            var popover = this.shadowRoot.querySelector("pebble-popover[for=" + e.currentTarget.id + "]");
            this._currentSelectedLov = this.shadowRoot.querySelector('rock-entity-lov[id=lov_' + this.relationship + ']');
            popover.show();
          } else {
            var rel = e.currentTarget.relationship;
            const { relatedEntityTypes, selfContext } = this.relationshipGridConfig;
            const { id, type } = ContextHelper.getFirstItemContext(this.contextData);
            var mode = this.domain == "digitalAsset" ? "asset" : "relationship";
            const sharedData = {
              "mode": mode,
              "types-criterion": relatedEntityTypes,
              "relationship-type": rel,
              "heading": this._getRelationshipTypeTitle(rel),
              "selected-entities": [{ id, type }],
              "self-context": selfContext,
              "add-relationship-grid-config": this.addRelationshipGridConfig,
              "dataIndex": this.dataIndex,
              "dataSubIndex": this.dataSubIndex
            };

            this.openBusinessFunctionDialog({ 
              name: 'rock-wizard-entity-relationship-add',
              mergeTitle: true,
              title: this.entityName
            }, sharedData);
          }
        },
        _convertIntoEntityLovList: function (entitiesResponse) {
          if (entitiesResponse) {
            var items = [];
            var selectedItems = [];

            if (entitiesResponse.content && entitiesResponse.content.entities) {
              var entities = entitiesResponse.content.entities;
              entities.forEach(function (item) {
                if (item) {
                  //TODO: this code has to be enhanced for based on config.
                  var attributes = EntityHelper.getAllAttributes(item);
                  items.push({
                    "id": item.id,
                    "title": item.id,
                    "subtitle": item.type,
                    "image": "/src/images/lookup-item.jpg"
                  });
                }
              }, this);
            }

            if (this._currentSelectedLov) {
              var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this._currentSelectedLov.id + ']');
              var relGridData = [];
              if (relGrid) {
                relGridData = relGrid.getData();
              }

              this._currentSelectedLov.items = items;
              this._currentSelectedLov.selectedItems = relGridData;
              this._currentLovItems = items;
            }
          }
        },
        _onLovConfirmButtonTapped: function (event) {
          if (event.detail) {

            var lov = this.shadowRoot.querySelector("rock-entity-lov[id=" + event.detail.data.id + "]");

            var oldSelectedItemIds = [];
            var selectedItemIds = [];
            if (lov) {
              selectedItemIds = [...new Set(lov.selectedItems.map((obj) => obj.id))];
            }
            var newItemIds = [];
            var relType = event.detail.data.id.replace("lov_", "");
            // TO-DO Pebble-LOV has to handle this filteration.
            var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + relType + ']');
            if (currentRelGrid) {
              var data = currentRelGrid.getData();
              data.forEach(function (item) {
                if (item) {
                  oldSelectedItemIds.push(item.id);
                }
              }, this);
            }

            selectedItemIds.forEach(function (item) {
              if (item && oldSelectedItemIds.indexOf(item) < 0) {
                newItemIds.push(item);
              }
            }, this);

            this._addRelatedEntity(relType, newItemIds);
          }
        },
        _onLovCloseButtonTapped: function (event) {
          if (event.detail) {
            var id = event.detail.data.id.replace("lov_", "");
            var currentLovPopover = this.shadowRoot.querySelector('pebble-popover[for=button_' + id + ']');

            if (currentLovPopover) {
              currentLovPopover.hide();
            }
          }
        },
        _addRelatedEntity: function (relationshipType, entityIds) {
          if (entityIds && entityIds.length > 0) {
            var popover = this.shadowRoot.querySelector("pebble-popover[for=button_" + relationshipType + "]");

            var relatedEntityContexts = this._getRelatedEntityContexts();
            var typesCriterion = [];
            var contexts = [];
            var attributes = this._getRelatedEntityAttributeList();

            if (relatedEntityContexts) {
              relatedEntityContexts.forEach(function (relContexts) {
                if (relContexts) {
                  typesCriterion.push(relContexts.relEntityType);
                  if (relContexts.relContexts) {
                    relContexts.relContexts.forEach(function (ctxItem) {
                      contexts.push(ctxItem);
                    }, this);
                  }
                }
              }, this);
            }

            var valueContext = this.getFirstValueContext();

            //TODO-dimensions has to be set in req. same like did in relationship-manage
            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": [valueContext],
                  "ids": entityIds,
                  "filters": {
                    "typesCriterion": typesCriterion
                  }
                },
                "fields": {
                  "attributes": attributes
                },
                "options": {
                  "maxRecords": 10
                }
              }
            };

            this.set('_entityGetAddRequest', req);
            var relAddLiquid = this.shadowRoot.querySelector('liquid-entity-data-get[id="entityGetAddData"]');
            if (relAddLiquid) {
              relAddLiquid.generateRequest();
            }
            popover.hide();
          }
        },
        _addRelationship: function () {
          if (this.relEntitiesResponse) {
            var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');

            if (relGrid) {
              var relData = [];
              if (this.relEntitiesResponse.content && this.relEntitiesResponse.content.entities) {
                var entities = this.relEntitiesResponse.content.entities;
                var relGridData = relGrid.getData();
                entities.forEach(function (relItem) {
                  if (relItem) {
                    var attributes = EntityHelper.getAllAttributes(relItem);
                    var record = {};
                    if (attributes) {
                      Object.keys(attributes).forEach(function (attrItem) {
                        if (attrItem && attributes[attrItem]) {
                          record[attrItem] = attributes[attrItem].values[0].value;
                        }
                      }, this);
                    }
                    record['Related Entity'] = record['id'] = relItem.id;
                    record['type'] = relItem.type;
                    record['properties'] = relItem.properties;
                    record['relationshipType'] = this.relationship;
                    relData.push(record);
                  }
                }, this);
              }
              relGrid.addNewRecords(relData);
            }
          }
        },
        _onEditMode: function (e) {
          this.showActionButtons = true;
        },
        _save: async function (e) {
          if (e.currentTarget.disabled == true) {
            return;
          }

          var currentRel = e.target.__dataHost.parentModel.relationship; //e.model.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');

          if (currentRelGrid) {
            var modifiedRelData = currentRelGrid.getModifiedData();
            var originalEntity;

            //Check whether any row is modified or not.
            if (!modifiedRelData || (modifiedRelData && modifiedRelData.length == 0)) {
              this.showInformationToast("No changes to save");
              return;
            }

            if (this.dataObject) {
              if (this.dataObject[currentRel]) {
                originalEntity = this.dataObject[currentRel];
              } else if (this.dataObject['blankEntity']) {
                originalEntity = this.dataObject['blankEntity'];
              }
            }

            if (originalEntity) {
              this._originalEntity = DataHelper.cloneObject(originalEntity);

              if (!_.isEmpty(modifiedRelData)) {
                var existingRelationships = EntityHelper.getRelationshipByRelationshipType(originalEntity, this.getFirstDataContext(), currentRel);
                var relObjects = this._getUpdatedRelationshipsFromModifiedGridData(originalEntity, existingRelationships, modifiedRelData, currentRel);

                // Remove all relationships exist in entity's current relationship reference, it may possible that only few relationships are modified.
                if (existingRelationships) {
                  existingRelationships.length = 0;
                }

                // Add all updated relatinships in entity's current relationship reference.
                if (relObjects) {
                  relObjects.forEach(function (relItem) {
                    existingRelationships.push(relItem);
                  }, this);
                }
              }

              // Prepare entity for context save where relationships will be filtered or modified by context model. 
              await DataTransformHelper.prepareEntityForContextSave(originalEntity.data, {}, this._relationshipModels, this.contextData)
            }

            this._saveRequest = {
              "entities": [DataHelper.cloneObject(originalEntity)]
            };

            if (this.doSyncValidation) {
              var req = DataRequestHelper.createSyncValidationRequest(originalEntity.id, originalEntity.type, originalEntity.data);
              this.set('_entityGovernRequest', req);
              delete this._entityGovernRequest.entity.name;
              var liquidGovernGet = this.shadowRoot.querySelector('#entityGovernService');
              if (liquidGovernGet && this.loadGovernData) {
                liquidGovernGet.generateRequest();
              }
            } else {
              this._saveEntity();
            }
          }
        },

        _getUpdatedRelationshipsFromModifiedGridData: function (originalEntity, existingRelationships, modifiedRelData, currentRel) {
          var relObjects = [];

          if (modifiedRelData) {
            var relAndRelEntityAttributes = this._getAttributeList(currentRel);
            var valueContext = this.getFirstValueContext();

            // Get updated relationships by adding or updating exiting relationship data.
            modifiedRelData.forEach(function (modItem) {
              var relObject;
              // Find out if modified relaitionship is exist in current entity data.
              if (!_.isEmpty(existingRelationships)) {
                existingRelationships.forEach(function (relItem) {
                  if (relItem && ("relTo" in relItem) && relItem.relTo.id == modItem["Related Entity"]) {
                    relObject = relItem;
                  }
                }, this);
              }

              // ADD and UPDATE case will be diceded based upon modified relationship is exist in entity.
              if (relObject) {
                // UPDATE
                // Existing relatsionship update.
                var relAttributes = relObject.attributes ? relObject.attributes : relObject.attributes = {};

                if ("relationshipAttributes" in relAndRelEntityAttributes) {
                  relAndRelEntityAttributes.relationshipAttributes.forEach(function (relAttr) {
                    if (relAttr) {
                      var relAttribute = relAttributes ? relAttributes[relAttr] : undefined;
                      if (relAttribute) {
                        relAttribute.values[0].value = modItem[relAttr];
                      } else {
                        if (modItem[relAttr]) {
                          relAttributes[relAttr] = {};
                          relAttributes[relAttr].values = [{
                            "value": modItem[relAttr],
                            "source": valueContext.source,
                            "locale": valueContext.locale
                          }];
                        }
                      }

                      let originalValue = modItem[relAttr + "_originalValue"];
                      if (!_.isEmpty(originalValue) && modItem[relAttr] == "") {
                        relAttributes[relAttr].values[0].value = originalValue;
                        relAttributes[relAttr].values[0].action = "delete";
                      }
                    }
                  }, this);
                }
              } else {
                // ADD
                // Add new relationship.
                var relId = modItem["Related Entity"];
                var relToType = modItem['type'];

                if (relId && relToType) {
                  relObject = {};
                  relObject.direction = "both";
                  relObject.operation = "association";
                  relObject.attributes = {};

                  if (relAndRelEntityAttributes) {
                    relAndRelEntityAttributes.relationshipAttributes.forEach(function (relAttr) {
                      if (relAttr && modItem[relAttr]) {
                        relObject.attributes[relAttr] = {};
                        relObject.attributes[relAttr].values = [{
                          "value": modItem[relAttr],
                          "source": valueContext.source,
                          "locale": valueContext.locale
                        }];
                      }
                    }, this);
                  }

                  relObject.relTo = {};
                  relObject.relTo.id = relId;
                  relObject.relTo.type = relToType;
                  relObject.relTo.properties = modItem['properties'];
                }
              }

              relObjects.push(relObject);
            }, this);
          }

          return relObjects;
        },

        _onEntityGovernResponse: function (e) {
          if (e && e.detail && e.detail.response && e.detail.response.response && e.detail.response.response.status == "success") {
            var res = e.detail.response.response;

            //Verify validation messages to process or not
            var syncValidations = this.relationshipGridConfig.gridConfig.syncValidations;
            var validationMessage;

            if (syncValidations && syncValidations.length > 0) {
              for (var i = 0; i < syncValidations.length; i++) {
                if (DataHelper.isValidObjectPath(res, "entities.0.data.attributes." + syncValidations[i].attribute + ".properties.messages")) {
                  var attrMessages = res.entities[0].data.attributes[syncValidations[i].attribute].properties.messages;
                  if (attrMessages.length > 0 && attrMessages.find(obj => obj.messageCode == syncValidations[i].code)) {
                    validationMessage = validationMessage ? validationMessage + ", " + syncValidations[i].message : syncValidations[i].message;
                  }
                }
              }
            }

            if (validationMessage) {
              this.showErrorToast(validationMessage);
              return;
            }

            var itemContext = this.getFirstItemContext();
            var entityId;
            if (itemContext) {
              entityId = itemContext.id;
            }

            var entity = DataHelper.findEntityById(res.entities, entityId);

            if (entity && entity.data && entity.data.relationships) {
              var relationships = entity.data.relationships;
              var relMessages = {};
              for (var i in relationships) {
                var relationshipType = i;
                var relTitle = this._getRelationshipTypeTitle(relationshipType);
                var relationshipMessages = MessageHelper.getRelationshipsMessages(relationships[i], this.messageCodeMapping, this.localize());
                if (relationshipMessages && relationshipMessages.length > 0) {
                  var relAttributes = relationships[i][0].attributes;
                  var attrModels = this._getRelationshipAttributeModels(relationshipType);
                  var relationshipObj = {
                    "relTitle": relTitle,
                    "relMessage": relationshipMessages,
                    "relAttributes": relAttributes,
                    "attrModels": attrModels,
                    "relationship": relationships[i]
                  };
                  relMessages[relationshipType] = relationshipObj;
                }
              }
            }
            if (!_.isEmpty(relMessages)) {
              var errorMessages = MessageHelper.getErrorsFromRelMessages(relMessages);
              this.set("_errorMessages", errorMessages);
              this.shadowRoot.querySelector('#errorsDialog').open();
              return;
            } else {
              this._saveEntity();
            }
          } else {
            this.logWarning("AttributeManageValidationFail", "response", JSON.stringify(e.detail));
            this.showErrorToast("There is a problem in validation service. Please contact administrator.");
          }
        },
        _onEntityGovernFailed: function (e) {
          this.logWarning("AttributeManageValidationFail", "response", JSON.stringify(e));
          this.showErrorToast("There is a problem in validation service. Please contact administrator.");
        },
        _skipErrors: function () {
          this._fixErrors();

          this._saveEntity();
        },
        _fixErrors: function () {
          var errorDialog = this.shadowRoot.querySelector('#errorsDialog');
          if (errorDialog) {
            errorDialog.close();
            if (this.dataObject) {
              var currentRel = this.relationship;
              if (this.dataObject[currentRel]) {
                this.dataObject[currentRel] = this._originalEntity;
              }
            }
          }
        },
        _saveEntity: function () {
          var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");
          if (liquidSave) {
            liquidSave.generateRequest();
          }
        },
        _onSaveResponse: function () {
          //TO-DO will get changed
          RUFUtilities.appCommon.toastText = "Relationships saved successfully.";

          var eventData = {
            name: "gridsaveinsplit"
          }
          this.dispatchEvent(new CustomEvent('bedrock-event', { detail: eventData, bubbles: true, composed: true }));          

          var toastElement = RUFUtilities.pebbleAppToast;
          toastElement.toastType = "success";
          toastElement.heading = "Success";
          toastElement.autoClose = true;

          toastElement.show();

          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');
          var gridData = currentRelGrid.getData();
          var savedRelationshipItemsToLov = gridData.map(function (item) {
            if (item.id) {
              return { 'id': item.id, 'title': item.id }
            }
          });
          this._savedRelationshipItemsToLov[this.relationship] = DataHelper.cloneObject(savedRelationshipItemsToLov);

          if (this.functionalMode == "dataFunction") {
            var eventName = "onSave";
            var eventDetail = {
              name: eventName,
              "action": {
                "name": "business-condition-save-request"
              }
            };
            this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
          } else if (currentRelGrid) {
            this._changeRelationshipToReadMode();
            currentRelGrid.changeToReadMode();
          }
        },
        _onRevertDialogOk: function (e) {
          var currentRel = e.target.__dataHost.parentModel.relationship; //e.model.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          currentRelGrid.changeToReadMode();
          this._changeRelationshipToReadMode();
        },
        _revertAll: function (e) {
          var currentRel = e.target.__dataHost.parentModel.relationship; //e.model.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          if (this.functionalMode == "dataFunction") {
            var eventName = "onSkip";
            var eventDetail = {
              name: eventName
            };
            this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
          } else if (currentRelGrid) {
            if (currentRelGrid.getIsDirty()) {
              currentRelGrid.openGridMsgDialog(currentRel +
                " relationship has unsaved changes. Do you wants to revert those ?");
            } else {
              currentRelGrid.changeToReadMode();
              this._changeRelationshipToReadMode();
            }
          }
        },

        getIsDirty: function () {
          var relGridContainer = this.$$("div[id^='relContainer_']:not([hidden])");
          if (relGridContainer) {
            var relGridDirty = false;
            var relGrid = relGridContainer.querySelector('rock-grid');
            if (relGrid && relGrid.getIsDirty) {
              relGridDirty = relGrid.getIsDirty();
            }
            var quickManageDirty = false;
            var quickManage = relGridContainer.querySelector('rock-entity-quick-manage');
            if (quickManage && quickManage.getIsDirty) {
              quickManageDirty = quickManage.getIsDirty();
            }

            if (relGridDirty || quickManageDirty) {
              return true;
            }
          }
          return false;
        },
        getControlIsDirty: function () {
          var quickManageControlDirty = false;
          var relGridControlDirty = false;
          var popoverControlDirty = false;
          var dialogControlDirty = false;
          var relGridContainer = this.$$("div[id^='relContainer_']:not([hidden])");
          if (relGridContainer) {
            //Quick manage is edited
            var quickManage = relGridContainer.querySelector('rock-entity-quick-manage');
            if (quickManage && quickManage.getControlIsDirty) {
              quickManageControlDirty = quickManage.getControlIsDirty();
            }

            //Rock grid items are selected or edited
            var relGrid = relGridContainer.querySelector('rock-grid');
            if (relGrid && relGrid.getControlIsDirty) {
              relGridControlDirty = relGrid.getControlIsDirty();
            }

            //popover is opened
            var popoverObj = relGridContainer.querySelector('pebble-popover');
            if (popoverObj && popoverObj.getControlIsDirty) {
              popoverControlDirty = popoverObj.getControlIsDirty();
            }

            //Dialog is opened
            var businessFunctionDialog = RUFUtilities.appCommon.getFunctionDialog();
            if (businessFunctionDialog) {
              dialogControlDirty = businessFunctionDialog.getControlIsDirty();
            }
          }

          return quickManageControlDirty || relGridControlDirty || popoverControlDirty || dialogControlDirty;
        },

        refresh: function (options) {
          if(options && !_.isEmpty(options) && options.partialRefresh){

          }
          var rockGrid = this.$$("rock-grid");
          rockGrid.refresh(options);
          if (this._quickManageEnabled == true) {
            var quickManage = this.$$("rock-entity-quick-manage");
            quickManage.refresh();
          }
        },

        _onDialogOk: async function (e) {
          this.showActionButtons = false;
          if (this._modifiedEntityRelationship && "action" in this._modifiedEntityRelationship) {
            if (this._modifiedEntityRelationship.action == "bulk-delete" || this._modifiedEntityRelationship.action == "delete") {
              if (this.relationship) {
                var selectedItems = this._modifiedEntityRelationship.detail.selectedItems;
                var id = this._modifiedEntityRelationship.detail.id;

                var selectedIds = [];
                var coalescedIds = [];

                if (!_.isEmpty(selectedItems)) {
                  selectedItems.forEach(function (item) {
                    if (this._hasContextCoalescedValue(item)) {
                      coalescedIds.push(item.id);
                    } else {
                      selectedIds.push(item.id);
                    }
                  }, this);
                } else {
                  selectedIds = [id];
                }

                if (!_.isEmpty(selectedIds)) {
                  this._relationshipDeleteItems["relIds"] = selectedIds;
                }

                if (!_.isEmpty(coalescedIds)) {
                  this._relationshipDeleteItems["coalescedRelIds"] = coalescedIds;

                  if (_.isEmpty(selectedIds)) {
                    var message = "Relationship(s) delete request can not be sent for " + this._relationshipDeleteItems["coalescedRelIds"].length + " sourced relationship(s).";
                    this.showWarningToast(message, 10000);
                  }
                }

                this._deleteRelatioshipsByIds(selectedIds);
              }
            }
          }
        },

        _deleteRelatioshipsByIds: async function (selectedIds) {
          if (!_.isEmpty(selectedIds)) {
            var updateRequest = DataRequestHelper.generateRelationshipProcessRequest(this.contextData);
            var relations = this._entityRelations;
            var modifiedRelations = [];

            if (relations) {
              relations.forEach(function (relation) {
                if (selectedIds.indexOf(relation.relTo.id) > -1) {
                  modifiedRelations.push(relation);
                }
              });
            }

            modifiedRelations.forEach(function (rel) {
              rel.action = "delete";
            });

            updateRequest.data.relationships[this.relationship] = modifiedRelations;
            await DataTransformHelper.prepareEntityForContextSave(updateRequest.data, {}, this._relationshipModels, this.contextData);

            var entityDelLiquid = this.shadowRoot.querySelector("#entityRelationsDeleteService");
            if (entityDelLiquid) {
              entityDelLiquid.requestData = {
                "entities": [updateRequest]
              };
              entityDelLiquid.operation = "update";
              entityDelLiquid.generateRequest();
            }
          }
        },

        _onRelationsDeleteResponse: function (e, detail) {
          var message;
          if ("relIds" in this._relationshipDeleteItems && !("coalescedRelIds" in this._relationshipDeleteItems)) {
            message = "Relationship(s) delete request submitted successfully for" + this._relationshipDeleteItems["relIds"].length + " relationship(s).";
            this.showSuccessToast(message, 10000);
          } else if ("coalescedRelIds" in this._relationshipDeleteItems) {
            if ("relIds" in this._relationshipDeleteItems) {
              message = "Relationship(s) delete request submitted successfully for" + this._relationshipDeleteItems["relIds"].length + " relationship(s) and relationship(s) delete request can not be sent for " + this._relationshipDeleteItems["coalescedRelIds"].length + " sourced relationship(s).";
            } else {
              message = "Relationship(s) delete request can not be sent for " + this._relationshipDeleteItems["coalescedRelIds"].length + " sourced relationship(s).";
            }
            this.showWarningToast(message, 10000);
          }

          var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');
          if (relGrid) {
            this._entityRelations = [];
            relGrid.set('config.mode', "read");
            relGrid.reRenderGrid();
          }
          var relationshipLov = Polymer.dom(this).node.shadowRoot.querySelector('rock-entity-lov[id=lov_' + this.relationship + ']');
          if (relationshipLov) {
            var gridData = relGrid.getData();
            var savedRelationshipItemsToLov = gridData.map(function (item) {
              if (item.id) {
                return { 'id': item.id, 'title': item.id }
              }
            });
            this._savedRelationshipItemsToLov[this.relationship] = DataHelper.cloneObject(savedRelationshipItemsToLov);
            relationshipLov.selectedItems = savedRelationshipItemsToLov[this.relationship] || [];
          }
        },

        _changeRelationshipToReadMode: function () {
          if (this.relationship) {
            this.showActionButtons = false;
          }
        },
        _requestForAddRelationshipList: function (relationship) {
          var relatedEntityContexts = this._getRelatedEntityContexts();
          var attributes = this._getRelatedEntityAttributeList();

          var typesCriterion = [];
          var contexts = [];

          if (relatedEntityContexts) {
            relatedEntityContexts.forEach(function (relContext) {
              if (relContext) {
                typesCriterion.push(relContext.relEntityType);
                if (relContext.relContexts) {
                  relContext.relContexts.forEach(function (ctxItem) {
                    contexts.push(ctxItem);
                  }, this);
                }
              }
            }, this);

            var valueContext = this.getFirstValueContext();

            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": [valueContext],
                  "filters": {
                    "attributesCriterion": [],
                    "typesCriterion": typesCriterion
                  }
                },
                "fields": {
                  "attributes": attributes,
                  "relationships": []
                },
                "options": {
                  "from": 0,
                  "to": 0
                }
              }
            };

            DataRequestHelper.addDefaultContext(req);

            return req;
          }
          var messageDiv = this.$.messageCard;
          if (messageDiv) {
            messageDiv.textContent = "Relationships are not configured for current entity type: " + this.relationshipTitle;
            this._isMessageAvailable = true;
          }
        },
        _getIdField: function () {
          var idField = "";
          if (this.relationshipGridConfig) {
            var addRelLovConfig = this.relationshipGridConfig.addRelLovConfig;
            if (addRelLovConfig) {
              idField = addRelLovConfig.idField;
            }
          }
          return idField;
        },
        _getImageIdField: function () {
          var imageIdField = "";
          if (this.relationshipGridConfig) {
            var addRelLovConfig = this.relationshipGridConfig.addRelLovConfig;
            if (addRelLovConfig && addRelLovConfig.imageIdField) {
              imageIdField = addRelLovConfig.imageIdField;
            }
          }
          return imageIdField;
        },
        _getTitlePattern: function () {
          var titlePattern = "";
          if (this.relationshipGridConfig) {
            var addRelLovConfig = this.relationshipGridConfig.addRelLovConfig;
            if (addRelLovConfig) {
              titlePattern = addRelLovConfig.titlePattern;
            }
          }
          return titlePattern;
        },
        _getSavedRelationshipItems: function (relationship, savedRelationshipItemsToLov) {
          var savedRelationshipItems = [];
          var clonedSavedRelationshipItemsToLov = DataHelper.cloneObject(savedRelationshipItemsToLov);
          if (clonedSavedRelationshipItemsToLov[relationship]) {
            savedRelationshipItems = clonedSavedRelationshipItemsToLov[relationship];
          }
          return savedRelationshipItems;
        },
        _onRefreshRelationshipGridEvent: function (e, detail) {
          this.fireBedrockEvent("refresh-entity-thumbnail", {}, { "ignoreId": true });
          var rel = detail.relationshipType;
          var grid = this.shadowRoot.querySelector("#" + rel);
          this._entityRelations = [];
          if (grid) grid.reRenderGrid();
        },
        //Download asset functions
        _onOriginalAssetDownloadAction: function (e, detail) {
          if (!this.getDownloadUrlLiq || !detail) return;

          var fileName = detail.property_objectkey;
          if (fileName) {
            var req = {
              "binaryStreamObject": {
                "id": fileName,
                "type": "binarystreamobject",
                "data": {}
              }
            };
            this.getDownloadUrlLiq.requestData = [req];
            this.getDownloadUrlLiq.generateRequest();
          }
        },
        _onGetDownloadUrlResponse: function (e) {
          LiquidResponseHelper.downloadURLResponseMapper(e, downloadURL => {
            window.open(downloadURL, "_blank");
          });
        },
        openGridMsgDialog: function (msg) {
          this.shadowRoot.querySelector('#msgDialog').innerText = msg;
          this.shadowRoot.querySelector('#gridMsgDialog').open();
        },
        _onDeleteEntityRelationshipAction: function (e, detail) {
          // deleting newly added record and reload reloadRelationshipLov.
          if (detail.isNewlyAddedDataRowDelete) {
            this._reloadRelationshipLov(detail.id);
            return;
          }
          this._modifiedEntityRelationship = { event: e, detail: detail, action: "delete" };
          this.openGridMsgDialog("Are you sure you want to delete?");
        },
        _onRelationsSaveResponse: function (e, detail) {
          var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');
          if (relGrid) {
            this._entityRelations = [];
            relGrid.reRenderGrid();
          }
        },

        _onRelationsSaveError: function (e, detail) {
          this._relationshipDeleteItems = {};
          this.showErrorToast("Unable to delete the entity relationship, please contact administrator.");
        },
        _onCustomToolbarEvent: function (e, detail) {
          if (detail && detail.name == "delete") {
            var grid = this._getRelationshipGrid();
            var selectedItems = grid.getSelectedItems();
            if (selectedItems && selectedItems.length) {
              var savedRecords = [];
              var newRecordsIds = [];
              for (let idx = 0; idx < selectedItems.length; idx++) {
                var item = selectedItems[idx];
                if (DataHelper.isValidObjectPath(item, "_rowStatus.status") && item._rowStatus.status.toLowerCase() == "new") {
                  grid._deleteNewRowById(item.id);
                  newRecordsIds.push(item.id);
                } else {
                  savedRecords.push(item);
                }
              }

              //reload reloadRelationshipLov
              this._reloadRelationshipLov(newRecordsIds);

              // delete already saved records
              if (savedRecords && savedRecords.length) {
                var detail = { "selectedItems": savedRecords };
                this._modifiedEntityRelationship = { event: e, detail: detail, action: "bulk-delete" };
                this.openGridMsgDialog("Are you sure you want to delete?");
              }
            } else {
              this.showInformationToast("Please select at least one relationship from grid to delete.");
            }
          }
        },
        _onRowDropEventRaised: function (e, detail) {
          var gridData = detail && detail.dragDropItems && detail.dragDropItems[0] ? detail.dragDropItems[0] : [];
          var item, updatedId, getOrderPosition, rockAttr;
          if (!_.isEmpty(gridData)) {
            if (DataHelper.isValidObjectPath(this.relationshipGridConfig, "gridConfig.itemConfig.fields")) {
              var columns = this.relationshipGridConfig.gridConfig.itemConfig.fields;
              var columnsList = DataHelper.convertObjectToArray(columns);
              if (columnsList) {
                for (var j = 0; j < columnsList.length; j++) {
                  if (columnsList[j].name == "order") {
                    getOrderPosition = j;
                    break;
                  }
                }
              }
            }
            if (getOrderPosition != undefined) {
              this._updateRelGridData(gridData, detail);
            }
          }
        },

        _updateRelGridData: function (data, detail) {
          var grid = this._getRelationshipGrid();
          var item, updatedId;
          if (grid) {
            for (var i = 0; i < data.length; i++) {
              item = data[i]
              updatedId = (i + 1).toString();
              if (item) {
                item["order"] = updatedId;
                grid.updateRowStatus(item, "update");
              }
            }
            grid.updateGridData(data, detail);
          }
        },
        _onBulkEdit: function (e, detail) {
          var grid = this._getRelationshipGrid();
          var selectedItems = grid.getSelectedItems();
          var selectionMode = grid.getSelectionMode();
          var selectionQuery = grid.getSelectedItemsAsQuery();
          if (!_.isEmpty(selectionQuery) && selectedItems && selectedItems.length && this.contextData) {
            selectionQuery.filters = {};
            var selectedItemTypes = selectedItems.map(item => item.type).filter((value, index, self) => self.indexOf(value) === index);
            selectionQuery.filters["typesCriterion"] = selectedItemTypes;

            var clonedContextData = DataHelper.cloneObject(this.contextData);
            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [{ "type": selectedItemTypes[0] }];
            const sharedData = {
              "context-data": clonedContextData,
              "workflow-criterion": this.workflowCriterion,
              "selection-query": selectionQuery,
              "selection-mode": selectionMode,
              "selected-entities": selectedItems,
              "edit-attributes-only": true,
              "edit-relationship-attributes-only": false
            };

            this.openBusinessFunctionDialog({
              name: 'rock-wizard-entity-bulk-edit',
              configName: 'wizardConfig',
              mergeTitle: true,
              "title": DataHelper.concatValuesFromArray([
                this._primaryContexts,
                this.entityName
              ])
            }, sharedData);
          } else {
            this.showInformationToast("Please select at least one entity from grid to edit.");
          }
        },

        _onBulkRelationshipEdit: function (e, detail) {
          var grid = this._getRelationshipGrid();
          var selectedItems = grid.getSelectedItems();
          var selectionMode = grid.getSelectionMode();
          var selectionQuery = grid.getSelectedItemsAsQuery();
          var currentRel = this.relationship;
          var originalEntity = this.dataObject[currentRel];
          selectionQuery.ids = [originalEntity.id];
          if (selectedItems && selectedItems.length && this.contextData) {
            var originalEntity = this.dataObject[currentRel];
            selectionQuery.ids = [originalEntity.id];
            var itemContexts = [];
            var typesCriterion = [];

            var itemContext = { "type": originalEntity.type };
            var relAndTypeAttributes = this._getAttributeList();
            var relAttributeNames = relAndTypeAttributes && relAndTypeAttributes.relationshipAttributes ? relAndTypeAttributes.relationshipAttributes : [];
            if (_.isEmpty(relAttributeNames)) {
              this.showInformationToast("No relationship attribute configured in the grid for bulk edit.");
              return;
            }
            // var relAttributeNames = ["linkdescription","enabled","status","displayname"];
            itemContext.relationshipAttributes = relAttributeNames;
            itemContext.relationships = [currentRel];
            itemContexts.push(itemContext);
            if (!typesCriterion.find(type => type === entityRelation.relTo.type)) {
              typesCriterion.push(itemContext.type);
            }
            selectionQuery.filters.typesCriterion = typesCriterion; //Based on relationship entityType
            var clonedContextData = DataHelper.cloneObject(this.contextData);
            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
            const sharedData = {
              "context-data": clonedContextData,
              "selection-query": selectionQuery,
              "selection-mode": selectionMode,
              "selected-entities": selectedItems,
              "original-entity": originalEntity,
              "relationship": currentRel,
              "edit-attributes-only": false,
              "edit-relationship-attributes-only": true
            };

            this.openBusinessFunctionDialog({
              name: 'rock-wizard-entity-bulk-edit',
              configName: 'wizardConfig',
              mergeTitle: true,
              "title": DataHelper.concatValuesFromArray([
                this._primaryContexts,
                this.entityName
              ])
            }, sharedData);
          } else {
            this.showInformationToast("Please select at least one entity from grid to edit.");
          }
        },
        _getGridClass() {
          var _gridWithActionButtons;
          var _showAccordion;
          var gridClass
          _showAccordion = !this.showAccordion ? "expanded" : "";
          _gridWithActionButtons = this.showActionButtons ? "button-siblings" : "";
          gridClass = _gridWithActionButtons + " " + _showAccordion;
          this.set("getwrapClass", gridClass);
        },
        _onGlobalEdit(e) {
          const relGrid = this.$$(`rock-grid`);

          relGrid.changeToEditMode();
        },
        _onCompositeModelGetResponse: function (e) {
          var itemContext = this.getFirstItemContext();
          if (e && e.detail && DataHelper.validateGetModelsResponse(e.detail.response)) {
            var compositeModel = e.detail.response.content.entityModels[0];
            if (compositeModel && compositeModel.data) {
              this._relationshipModels = DataTransformHelper.transformRelationshipModels(compositeModel, this.contextData);
            }
          }
        },
        _hasContextCoalescedValue: function (item) {
          return !_.isEmpty(item.contextCoalescePaths);
        },
        _onAddNewRelClick: function (item) {

          const { relatedEntityTypes } = this.relationshipGridConfig;
          var contextData = DataHelper.cloneObject(this.contextData);
          //delete this.contextData.ItemContexts[0];
          contextData.ItemContexts[0] = { "type": relatedEntityTypes[0] };
          const sharedData = {
            "context-data": contextData
          };

          this.openBusinessFunctionDialog({
            name: 'rock-wizard-entity-create',
            "title": DataHelper.concatValuesFromArray([
              "Add New Related Entity",
              this._primaryContexts,
              this.entityName
            ])
          }, sharedData);
        },
        _onEntityCreated: function (e) {
          this._createRelationshipsDown(e.detail);
        },

        _createRelationshipsDown: function (createdEntity) {

          var upRelationshipRequests = [];
          var rel = {
            "direction": "both",
            "relationshipType": this.relationshipGridConfig.relationshipModel.properties.relationshipType,
            "relTo": {
              "id": createdEntity.id,
              "type": createdEntity.type
            }
          };

          var { id: id, type: type } = this.contextData.ItemContexts[0];
          var upRelationshipRequest = { id: id, type: type, "data": { "relationships": {} } }

          upRelationshipRequest.data.relationships[this.relationship] = [rel];
          upRelationshipRequests.push(upRelationshipRequest);

          this._saveRequest = {
            "entities": upRelationshipRequests
          };
          this._addClientStatus();
          this._saveEntity();
          var businessDialog = RUFUtilities.appCommon.shadowRoot.querySelector("rock-business-function-dialog");
          if (businessDialog) {
            var dialog = businessDialog.dialog;
            dialog.close();
          }

        },
        _addClientStatus: function () {
          var clientState = {};
          clientState.notificationInfo = {};
          clientState.notificationInfo.showNotificationToUser = true;
          this._saveRequest["clientState"] = clientState;
        },

        /**
				 * Reload the relationshipLov.
         * {ids} ids used for filter
				 */
        _reloadRelationshipLov: function (ids) {
          var relationshipLov = Polymer.dom(this).node.shadowRoot.querySelector('rock-entity-lov[id=lov_' + this.relationship + ']');
          if (relationshipLov && relationshipLov.selectedItems) {
            var relationshipLovSelectedItems = relationshipLov.selectedItems;
            if (_.isArray(ids)) {
              ids.forEach(function (elValue) {
                var relationshipLovItem = DataHelper._findItemByKeyValue(relationshipLovSelectedItems, "id", elValue);
                if (relationshipLovItem) {
                  // reload the relationshipLov
                  relationshipLovSelectedItems = relationshipLovSelectedItems.filter(function (selectedItem) {
                    return selectedItem.id != elValue;
                  });
                }
              });
            } else {
              // reload the relationshipLov
              relationshipLovSelectedItems = relationshipLovSelectedItems.filter(function (selectedItem) {
                return selectedItem.id != ids;
              });
            }
            relationshipLov.selectedItems = relationshipLovSelectedItems;
          }
        },
        _displayAddNewRelationship  : function (relationshipGridConfig) {
          if(relationshipGridConfig && relationshipGridConfig.addNewRelationConfig){
            if(this.domain && this.domain != "digitalAsset"){
              return true;
            }
          }
          return false;
        }
      });
    })();
  </script>
</dom-module>