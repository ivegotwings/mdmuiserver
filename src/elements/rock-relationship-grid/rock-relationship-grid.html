<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../liquid-entity-getdata/liquid-entity-getdata.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid/remote-data.html">

<!--
<<<<<<< HEAD
`rock-relationship-grid` Represents an assosiation relationship grid for an entity.
The following JSON objects depicts the entity that is used for loading the relationship grid.
Based on the config, relationship grid gets loaded with the defined attributes from the given data object.
=======
`rock-relationship-grid` Represents an assosiation relationship grid for an entity. The following JSON objects depicts the entity that 
is used for loading the relationship grid. Based on the config, relationship grid gets loaded with the defined attributes from the given data object.

>>>>>>> gb-review-set1
```json
{
  "crosssell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}
```
The following JSON object is a sample of data which can be used to bind the grid.
```json
{
  "id": "e2",
  "entityInfo": {
    "entityType": "product",
    "entityDomain": "thing"
  },
  "systemInfo": {
    "tenantId": "t1"
  },
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "ctxInfo": [
      {
        "ctxGroup": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crosssell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relToObject": {
                "id": "e5",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relToObject": {
                "id": "e6",
                "entityInfo": {
                  "entityType": "product",
                  "entityDomain": "thing"
                }
              }
            }
          ]
        }
      }
    ]
  }
}
```
@demo demo/index.html
-->
<dom-module id="rock-relationship-grid">
  <template>
    <style include="pebble-styles-shared"></style>
    <style>
      pebble-button.icon-text-button {
        --pebble-button: {
          height: 30px;
          padding: 0.5em 0em 0.5em 0em;
          border: 1px solid var(--primary-color);
        }
        --pebble-button-iron-icon: {
          height: 18px;
          width: 18px;
          padding-bottom: 2px;
        }
      }
      
      .relation-name {
        font-weight: var(--font-medium, 500);
        font-family: var(--default-font-family);
        clear: both;
        padding-top: 10px;
        margin: 0px;
        font-size: var(--font-size-md);
      }
      
      .relation-name-container {
        clear: left;
        @apply(--layout-horizontal);
        padding: 5px;
        border-radius: 3px;   
        margin: 2px 0px 0 0px;
        flex-direction:row-reverse !important;
      }
      
      .relation-line-box {
        margin-top: 16px;
        margin-left: 8px;
        margin-right: 8px;
        @apply(--layout-flex);
      }
      
      .relation-name-box {
        display: block;
        width: calc( 100% - 50px );        
      }
      
      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: var(--tooltip-bg-color);
      }
      
      pebble-lov {
        width: 300px !important;
        max-height: 350px !important;
      }
      
       ::shadow iron-data-table {
        height: 200px !important;
      }

      .relation-name-container pebble-button::shadow paper-button {
        border: 1px solid var(--palette-azure);
        background-color:var(--palette-azure);
        color:var(--white);
        border-radius: 3px;
        min-width: 50px;
        padding: 0 8px;
        height:28px;
      }
      /* Accordian styles */
     pebble-accordion::shadow .header{
        background-color:var(--palette-pale-grey-four);
        border: 0;
      }
      pebble-accordion::shadow .header-items-space{
        float:left !important;
      }
      
    </style>
    <template is="dom-repeat" items="{{relationshipTypeList}}" as="relationship" index-as="colIndex">
          <div class="header-text">
            <pebble-accordion header-text="[[relationship]]" default-icon="expand-less" open-icon="expand-more">
                <div class="relation-name-container">			
                  <pebble-button icon="pebble-icons:Add" id="[[relationship]]" class="" button-text="Add" on-click="onPopoverClick"></pebble-button>
                  <pebble-popover for$="[[relationship]]" auto-fit-on-attach no-overlap>
                      <pebble-lov id="[[relationship]]" items="{{items}}" show-image multi-select show-action-buttons></pebble-lov>
                  </pebble-popover>
					      </div>
          <remote-data id="[[relationship]]" request="[[_getRelationshipGridRequest(relationship)]]" operation="getbyids" data-formatter="{{dataFormatter}}" 
            current-record-size="{{size}}" total-records="{{totalRecords}}" data-source="{{dataSource}}"></remote-data>
					<rock-grid id="[[relationship]]" data-source="{{dataSource}}" data-source-id="[[relationship]]" config="{{_getRelationshipGridConfig(relationship)}}"
            attribute-models="[[attributeModels]]" record-size="{{totalRecords}}" grid-data-size="{{size}}" page-size="10"></rock-grid>
         </pebble-accordion>
        </div>
		</template>
    <liquid-entity-getdata auto id="initiateSearchResult" operation="initiatesearch" 
        request-data="{{_requestRelLOV}}" last-response="{{searchResponse}}"></liquid-entity-getdata>
    <liquid-entity-getdata auto id="searchResultGetDataService" operation="getsearchresultdetail" 
        request-data="{{_requestRelLOV}}" request-id="[[searchResponse.content.requestId]]" last-response="{{searchResultResponse}}"></liquid-entity-getdata>

    <liquid-entity-getdata id="entityGetData" name="entityGet" operation="getbyids" request-data="{{_entityGetRequest}}" 
      last-response="{{entitiesResponse}}"></liquid-entity-getdata>
    
    <liquid-entity-getdata id="entityGetAddData" name="entityGet" operation="getbyids" request-data="{{_entityGetAddRequest}}" 
      last-response="{{relEntitiesResponse}}"></liquid-entity-getdata>

	</template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-relationship-grid',
        properties: {
          /**
           * Indicates a data which is wrapped in a data-source that is used as a grid data.
           * The format for the JSON object is given in the above description.
           */
          data: {
            type: Object,
            notify: true
          },
          /*
          *	Indicates transformed relationship data for grid.
          */	
          relationshipGridData: {
            type: Array,
            notify: true,
            value : function() {
              return [];
            }
          },

          /*
          *	Indicates transformed relationship grid config for grid.
          */
          relationshipGridConfig: {
            type : Object,
            notify: true
          },

          /**
           * Indicates an attribute models to be used.
           */
          attributeModels: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },

          /*
          * Indicates current or selected relationship type.
          */
          relationshipType: {
            type : String,
            notify: true
          },

          /*
          * Indicates list of relationships.
          */
          relationshipTypeList: {
            type : Array,
            notify : true,
            value : function() {
              return [];
            }
          },

          dataFormatter: {
            notify: true,
            value: function() {
              return this._populateDataForGrid.bind(this);
            }
          },

          dataObject: {
            type: Object,
            notify: true
          },

          /*
          */
          _entityGetRequest: {
              type: Object,
              notify: true,
              value: function () {
                return {};
              }
          },

          _entityGetAddRequest: {
              type:Object,
              notify: true,
              value: function() {
                return {};
              }
          },

          _currentRelationshipItem: {
            type: String,
            notify: true
          },

          _relReq: {
            type: Object,
            value: function() {
              return {};
            }
          },

          _relReqests: {
            type: Array,
            value: function() {
              return [];
            }
          },

          _selectedDimensions: {
            type: Object,
            value: function() {
                return {};
            }
          },

          _relationshipTypeAndAttributes: {
            type: Object,
            value: function() {
              return {};
            }
          }
        },

        observers: [
            '_initiateRelationshipGrid(relationshipGridConfig)',
            '_convertIntoEntityLovList(searchResultResponse)',
            '_addRelationship(relEntitiesResponse)'
        ],

        listeners: {
            'lov-confirm-button-tap': '_onLovConfirmButtonTapped',
            'lov-close-button-tap': '_onLovCloseButtonTapped',
        },

        _currentSelectedLov: null,
        _currentLovItems: null,

        onPopoverClick: function(e) {
            var popover =  Polymer.dom(this).node.$$("pebble-popover[for=" + e.currentTarget.id + "]");
            var lov = Polymer.dom(this).node.$$("pebble-lov[id=" + e.currentTarget.id + "]");
            this._currentSelectedLov = Polymer.dom(this).node.$$('pebble-lov[id=' + e.currentTarget.id + ']');

            //TODO-dimensions has to be set in req. same like did in relationship-manage
            var req = {
              "params": {
                "query": {
                  "ctx": [{
                    "list": "productMaster",
                    "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                  }],
                  "valCtx": [{
                    "source": "SAP",
                    "locale": "en-US"
                  }],
                  "filters": {
                    "attributesCriterion": [],
                    "typesCriterion": ["nart"]
                  }
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": [
                    "cpimProductName",
                    "csapDescriptionOfNart",
                    "csapMaterialStatusGlobal",
                    "cpimSkinType"
                  ],
                  "relationships": ["ALL"]
                }
              }
            };

            this.set("_requestRelLOV", req);
            
            popover.show();
            lov.activate();
            this._currentSelectedLov.items = this._currentLovItems;
        },

        getAttributeList: function(relationshipTypeName) {
          if(this._relationshipTypeAndAttributes) {
            return this._relationshipTypeAndAttributes [relationshipTypeName];
          }
        },

        resetData: function() {
          //TO-DO Needs to enhance
          var rockGrids = Polymer.dom(this).node.shadowRoot.querySelectorAll('rock-grid');
          
          if(rockGrids && rockGrids.length > 0) {
            rockGrids.forEach(function(gridItem){
              gridItem.reRenderGrid();
            }, this);
          }
        },

        _addRelatedEntity: function(relationshipType, entityIds) {
          if(entityIds && entityIds.length > 0) {
            var popover =  Polymer.dom(this).node.$$("pebble-popover[for=" + relationshipType + "]");
            this._currentRelationshipItem = relationshipType;
            
            var attributes = [];

            if(this.relationshipGridConfig && this.relationshipGridConfig[this._currentRelationshipItem]){
              var columns = this.relationshipGridConfig[this._currentRelationshipItem].tabular.columns;
              if(columns) {
                  columns.forEach(function(col) {
                      if(col.isRelatedEntityAttribute) {
                          attributes.push(col.name);
                      }
                  }, this);
              }
            }

            //TODO-dimensions has to be set in req. same like did in relationship-manage          
            var req = {
            "params": {
                    "query": {
                        "ctx": [
                            {
                                "list": "productMaster",
                                "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry"
                            }
                        ],
                        "valCtx": [
                            {
                                "source": "SAP",
                                "locale": "en-US"
                            }
                        ],
                        "ids": entityIds,
                        "filters": {
                            "attributesCriterion": [],
                            "typesCriterion": [
                                "nart"
                            ]
                        }
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributes
                    },
                    "options":{
                        "from": 0,
                        "to": 0
                    }
                }
            };

            this.set('_entityGetAddRequest', req);
            var relAddLiquid = Polymer.dom(this).node.$$('liquid-entity-getdata[id="entityGetAddData"]');
            if(relAddLiquid) {
              relAddLiquid.generateRequest();
            }
            popover.hide();
          }
        },

        _addRelationship: function() {
          if(this.relEntitiesResponse) {
            var relGrid =  Polymer.dom(this).node.$$('rock-grid[id='+ this._currentRelationshipItem +']');

            if(relGrid) {
              if(this.relEntitiesResponse.content && this.relEntitiesResponse.content.entities)
              {
                var entities = this.relEntitiesResponse.content.entities;
                var relGridData = relGrid.getData();
                Object.keys(entities).forEach(function(relitem) {
                  var entity = entities[relitem];
                  var record = {};
                  if(entity && entity.data && entity.data.ctxInfo){
                    record["Related Entity"] = record["id"] = entity.id;
                    Object.keys(entity.data.ctxInfo).forEach(function(item) {
                      
                      if(entity.data.ctxInfo[item]) {
                        var attributes = entity.data.ctxInfo[item].attributes;
                        if(attributes) {
                          Object.keys(attributes).forEach(function(attrItem){
                            
                            if(attributes[attrItem]) {
                              record[attrItem] = attributes[attrItem].values[0].value;
                            }
                          }, this);
                        }
                      }
                    }, this);
                  }
                  record['entityInfo'] = entity.entityInfo;
                  record['systemInfo'] = entity.systemInfo;
                  record['properties'] = entity.properties;
                  record['relationshipType'] = this._currentRelationshipItem;
                  record.isEditable = true
                  relGridData.push(record);
                }, this);
              }

              relGrid.data = relGridData;
              relGrid.reRenderGrid();
              this.fire("editMode");
            }
          }
        },
        
        _isRelationshipType: function(relationshipType){
          if(relationshipType && relationshipType != '' && this.relationshipType != "Relationships") {
            return true;
          }
          else{
            return false;
          }
        },
        
        _getRelationshipGridConfig: function(relationshipTypeName) {
          return this.relationshipGridConfig[relationshipTypeName];
        },
        
        _getRelationshipGridRequest: function(relationshipTypeName) {
          var relAttr = this.getAttributeList(relationshipTypeName);
          
          if(relAttr) {
            this.set('_relReq.params.fields.relationshipAttributes', relAttr.relationshipAttributes);
            this.set('_relReq.params.fields.relatedEntityAttributes', relAttr.relatedEntityAttributes);
          }

          this.set('_relReq.params.fields.relationships', [relationshipTypeName]);
          

          return this._relReq;
        },
        
        _getRelationshipGridDataLength: function(relationshipTypeName) {
          return this.relationshipGridData[relationshipTypeName].length;
        },

        _initiateRelationshipGrid: function() {
          var relTypeandAttributes = {};
          if(this.relationshipGridConfig){
              this._relationships = Object.keys(this.relationshipGridConfig);
              
              if(this._relationships) {
                  this._relationships.forEach(function(item){
                      var relatedEntityAttributes = [];
                      var relationshipAttributes = [];

                      var columns = this.relationshipGridConfig[item].tabular.columns;
                      if(columns) {
                          columns.forEach(function(col) {
                              if(col.name != "Related Entity") {
                                  if(col.isRelatedEntityAttribute) {
                                      relatedEntityAttributes.push(col.name);
                                  }
                                  else
                                  {
                                      relationshipAttributes.push(col.name);
                                  }
                              }
                          }, this);
                      }
                      relTypeandAttributes[item] = {
                        'relationshipAttributes': relationshipAttributes,
                        'relatedEntityAttributes': relatedEntityAttributes
                      }
                  }, this);
              }

              this._relationshipTypeAndAttributes = relTypeandAttributes;
              this.relationshipTypeList = undefined;
              this.relationshipTypeList = this._relationships;

              this._generateRequest();
          }
        },

        _populateDataForGrid: function(respData){
            var data = [];
            if(respData) 
            {
              if(this.dataObject == undefined) {
                this.dataObject = respData;
              }

              if(respData.content && respData.content.entities)
              {
                var entities = respData.content.entities;
                var entityId = Object.keys(entities)[0];

                if(entityId){
                  var entity = entities[entityId];
                  if(entity && entity.data && entity.data.ctxInfo){
                      Object.keys(entity.data.ctxInfo).forEach(function(item) {
                        if(entity.data.ctxInfo[item]) {
                          var relationships = entity.data.ctxInfo[item].relationships;
                          var relationshipTyleList = [];
                          if(relationships) {
                            var relationshipTypeName = Object.keys(relationships)[0];
                            var relatedEntities = relationships[relationshipTypeName];

                            Object.keys(relatedEntities.rels).forEach(function(relItem){
                              var record = {};
                              var relElement = relatedEntities.rels[relItem];
                              if(relElement.attributes) {
                                Object.keys(relElement.attributes).forEach(function(item){
                                  if(relElement.attributes[item]) {
                                    record[item] = relElement.attributes[item].values[0].value;
                                  }
                                }, this);
                              }
                              if (relElement.relToObject) {
                                record["Related Entity"] = record["id"] = relElement.relToObject.id;

                                if(relElement.relToObject.data){
                                  var relCtxInfo = relElement.relToObject.data.ctxInfo;
                                  
                                  if(relCtxInfo) {
                                    Object.keys(relCtxInfo).forEach(function(item) {
                                      var relCtxList = relCtxInfo[item];
                                      
                                      if(relCtxList && relCtxList.attributes){
                                        Object.keys(relCtxList.attributes).forEach(function(attrItem){
                                          
                                          if(relCtxList.attributes[attrItem]) {
                                            record[attrItem] = relCtxList.attributes[attrItem].values[0].value;
                                          }
                                        }, this);
                                      }
                                    }, this);
                                  }
                                }
                              }
                              data.push(record);
                            }, this);
                          }
                        }
                      }, this);
                  }
                }
              }
            }
            return data;
        },

        _convertIntoEntityLovList: function (entitiesResponse) {
            if (entitiesResponse) {
              var items = [];
              var selectedItems = [];

              if (entitiesResponse.content && entitiesResponse.content.entities) {
                var entities = entitiesResponse.content.entities;
                Object.keys(entities).forEach(function (item) {
                  var entity = entities[item];
                  if (entity && entity.data && entity.data.ctxInfo) {
                    var ctxInfo = entity.data.ctxInfo;
                    Object.keys(ctxInfo).forEach(function (dataItem) {
                      var data = ctxInfo[dataItem];
                      if (data) {
                        if (data.attributes) {
                          items.push({
                            "id": entity.id,
                            "title": data.attributes["csapDescriptionOfNart"].values[0].value,
                            "subtitle": data.attributes["cpimProductName"].values[0].value,
                            "image": "/src/images/lookup-item.jpg"
                          });
                        }
                      }
                    }, this);
                  }
                }, this);
              }

              if (this._currentSelectedLov) {
                var relGrid = Polymer.dom(this).node.$$('rock-grid[id='+ this._currentSelectedLov.id +']');
                var relGridData = [];
                if(relGrid) {
                  relGridData = relGrid.getData();
                }

                this._currentSelectedLov.items = items;
                this._currentSelectedLov.selectedItems = relGridData;
                this._currentLovItems = items;
              }
            }
        },

        _generateRequest: function() {
          var valCtx = [];
          var ctx = [];
          var selectedLocales; 
          var selectedSources; 
          var selectedContexts;

          this._setSelectedDimensions();
          if(this._selectedDimensions)
          {
              selectedLocales = this._selectedDimensions.selectedLocales;
              selectedSources = this._selectedDimensions.selectedSources;
              selectedContexts = this._selectedDimensions.selectedContexts;
          }

          if(selectedLocales && selectedSources)
          {
              selectedSources.forEach(function(sourceItem) {
                  selectedLocales.forEach(function(localeItem) {
                      valCtx.push({
                          "source": sourceItem,
                          "locale": localeItem
                      });
                  }, this);
              }, this);
          }

          if(selectedContexts) {
              selectedContexts.forEach(function(contextItem) {
                  ctx.push({
                      "classification": "nivea/niveaBodyCare/niveaBody/nbodyEssential/nbody/ess/nourishingMilkDry",
                      "list": contextItem
                  });
              }, this);
          }

          var entityId = DataHelper._getEntityId();

          var req = {
          "params": {
                  "query": {
                      "ctx": ctx,
                      "valCtx": valCtx,
                      "id": entityId,
                      "filters": {
                          "attributesCriterion": [],
                          "typesCriterion": [
                              "nart"
                          ]
                      }
                  },
                  "fields": {
                      "ctxTypes": [
                          "properties"
                      ],
                      "relationships": [],
                      "relationshipAttributes": [],
                      "relatedEntityAttributes": []
                  },
                  "options":{
                      "from": 0,
                      "to": 0
                  }
              }
          };

          this._relReq = undefined;
          this._relReq = req;
        },

        _setSelectedDimensions: function() {
          var activeComponent = ComponentHelper.getCurrentActiveApp();

          if(activeComponent) {
            var dimensionSelector = activeComponent.$.dimensionSelector;
            if (dimensionSelector) {
                this._selectedDimensions = dimensionSelector.getSelectedDimensions();
            }
          }
        },

        _onLovConfirmButtonTapped: function(e, detail) {
            if(detail) {

              var oldSelectedItemIds = detail.oldSelectedItemIds;
              var selectedItemIds = detail.selectedItemIds;
              var newItemIds = [];

              selectedItemIds.forEach(function(item) {
                if(oldSelectedItemIds.indexOf(item) < 0) {
                  newItemIds.push(item);
                }
              }, this);
              
              this._addRelatedEntity(detail.id, newItemIds);            
            }
        },

        _getIdsFromObject: function(arrayObject) {
          var ids = [];
          if(arrayObject) {
            arrayObject.forEach(function(item){
              ids.push(item.id);
            }, this);
          }
          return ids;
        }

      });
    })();
  </script>
</dom-module>
