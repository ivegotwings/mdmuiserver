<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<!--<link rel="import" href="../pebble-toast/pebble-toast.html">-->
<script src="socket.io.js"></script>

<!--
`bedrock-notification-manager` Represents a component that creates the 
client connection to send or receive the notification message for either all users or a specific user.

It reads the server details of where notification engine is running from the `src/data/config.js` file and generates 
the client's connection for the communication with the server.

After adding this component user has to use the function `window.globalFunctions.getClientSocket();` to get the current running socket 
in the current window tab of the browser.
-->

<dom-module id="bedrock-notification-manager">
  <template>
    <iron-ajax auto url="../../data/config.json" handle-as="json" last-response="{{serverConfig}}"></iron-ajax>
  </template>

  <script>
    (function () {
        'use strict';

        Polymer({
            is: 'bedrock-notification-manager',
            properties: {
                /*
                * Indicates the `serverconfig` object that contains the host and port details where the notification engine is hosted.
                */
                serverConfig: {
                    type : Object,
                    notify : true,
                    value: function(){
                        return {};
                    },
                    observer: '_init'
                }
            },
            _clientSocket: null,
            _init: function() {
                var self = this;
                if(self.serverConfig.notificationManager && self.serverConfig.notificationManager.Host && self.serverConfig.notificationManager.Port) {
                    var path = self.serverConfig.notificationManager.Host + ":" + self.serverConfig.notificationManager.Port;

                    self._clientSocket = io.connect(path);

                    self._clientSocket.on("new message", function(data) {

                        var pebbleToastElement = document.createElement("pebble-toast");
                        pebbleToastElement.setAttribute('id', Date.parse(new Date())); //Just unique id                
                        pebbleToastElement.text = data.msg;
                        pebbleToastElement.toastType = data.type;
                        pebbleToastElement.autoClose = true;
                        pebbleToastElement.toastDuration = 5000; 
                        document.body.appendChild(pebbleToastElement);
                        pebbleToastElement.show();

                        var notificationElement = document.querySelector("main-app").$.notificationsList;
                        var notificationLabelElement = document.querySelector("main-app").$.mdmNotifications;

                        if(notificationElement)
                        {
                            var notifications = notificationElement.notifications;
                            notificationElement.notifications = [];
                            
                            // notification json has to be decided and changed here
                            notifications.push({
                                src: data.src || '',
                                alt: data.alt || '',
                                when: data.when || '',
                                desc: data.msg || ''
                            });

                            notificationElement.notifications = notifications;
                            notificationElement.notifyPath("notifications", notificationElement.notifications.slice());

                            if(notificationLabelElement)
                            {
                                notificationLabelElement.label = notifications.length;
                            }
                        }
                    });

                    window.globalFunctions = window.globalFunctions || {};
                    globalFunctions.getClientSocket = function(){
                        return self._clientSocket;
                    }
                }
            }
        });
    })();
  </script>

</dom-module>