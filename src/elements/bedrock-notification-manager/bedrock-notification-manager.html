<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../pebble-toast/pebble-toast.html">
<script src="../../../node_modules/socket.io-client/socket.io.js"></script>

<!--
`bedrock-notification-manager`
This component will create client connection for sending or receiving notification message for either all user or specific users.

It will read server detail of where notification engine is running from src/data/config.js and generates client for communication with server.

After adding this component user has to use below function to get current running socket in current window tab of browser,
window.globalFunctions.getClientSocket();
-->

<dom-module id="bedrock-notification-manager">
  <template>
    <iron-ajax auto url="../../data/config.json" handle-as="json" last-response="{{serverConfig}}"></iron-ajax>
  </template>

  <script>
    (function () {
        'use strict';

        Polymer({
            is: 'bedrock-notification-manager',
            properties: {
                serverConfig: {
                    type : Object,
                    notify : true,
                    value: function(){
                        return {};
                    },
                    observer: '_init'
                }
            },
            _clientSocket: null,
            _init: function() {
                var self = this;
                if(self.serverConfig.notificationManager && self.serverConfig.notificationManager.Host && self.serverConfig.notificationManager.Port) {
                    var path = self.serverConfig.notificationManager.Host + ":" + self.serverConfig.notificationManager.Port;

                    self._clientSocket = io.connect(path);

                    self._clientSocket.on("new message", function(data) {

                        var pebbleToastElement = document.createElement("pebble-toast");
                        pebbleToastElement.setAttribute('id', Date.parse(new Date())); //Just unique id                
                        pebbleToastElement.text = data.msg;
                        pebbleToastElement.toastType = data.type;
                        pebbleToastElement.autoClose = true;
                        pebbleToastElement.toastDuration = 5000; 
                        document.body.appendChild(pebbleToastElement);
                        pebbleToastElement.show();

                        var notificationElement = document.querySelector("main-app").$.notificationsList;
                        var notificationLabelElement = document.querySelector("main-app").$.mdmNotifications;

                        if(notificationElement)
                        {
                            var notifications = notificationElement.notifications;
                            notificationElement.notifications = [];
                            
                            // notification json has to be decided and changed here
                            notifications.push({
                                src: data.src || '',
                                alt: data.alt || '',
                                when: data.when || '',
                                desc: data.msg || ''
                            });

                            notificationElement.notifications = notifications;
                            notificationElement.notifyPath("notifications", notificationElement.notifications.slice());

                            if(notificationLabelElement)
                            {
                                notificationLabelElement.label = notifications.length;
                            }
                        }
                    });

                    window.globalFunctions = window.globalFunctions || {};
                    globalFunctions.getClientSocket = function(){
                        return self._clientSocket;
                    }
                }
            }
        });
    })();
  </script>

</dom-module>