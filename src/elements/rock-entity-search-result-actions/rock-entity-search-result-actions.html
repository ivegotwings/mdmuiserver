<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/mutable-data.html">
<link rel="import" href="../pebble-toolbar/pebble-toolbar.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<!--
@group rock Elements
@element rock-entity-search-result-actions
@demo demo/index.html
-->
<dom-module id="rock-entity-search-result-actions">
    <template>
        <style include="bedrock-style-common"></style>
        <style>
        </style>
        <pebble-toolbar id="searchResultToolbar" readonly="[[readonly]]" config-data="[[_toolbarConfig]]"></pebble-toolbar>
        <bedrock-pubsub event-name="toolbar-button-event" handler="_onToolbarEvent" target-id="searchResultToolbar"></bedrock-pubsub>
        <bedrock-pubsub event-name="on-toolbar-change" handler="_onToolbarChange" target-id="searchResultToolbar"></bedrock-pubsub>
    </template>
    <script>
        class RockEntitySearchResultActions
            extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior, RUFBehaviors.ComponentConfigBehavior], Polymer.OptionalMutableData(Polymer.Element)) {
            static get is() {
                return "rock-entity-search-result-actions";
            }

            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },

                    readonly: {
                        type: Boolean,
                        value: false
                    },

                    _toolbarConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    isWorkflowCriterion: {
                        type: Boolean,
                        value: false
                    },

                    domain: {
                        type: String
                    }
                }
            }

            static get observers() {
                return [
                    'resetConfigForWorkflow(isWorkflowCriterion)'
                ]
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            connectedCallback() {
                super.connectedCallback();
            }

            disconnectedCallback() {
                super.disconnectedCallback();
            }

            _onContextDataChange() {
                if (!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if (appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }

                    if (this.domain) {
                        context[ContextHelper.CONTEXT_TYPE_DOMAIN] = [{
                            "domain": this.domain
                        }];
                    }

                    this.requestConfig('rock-entity-search-result-actions', context);
                }
            }

            onConfigLoaded(componentConfig) {
                if (componentConfig && componentConfig.config) {
                    var toolbarConfig = componentConfig.config.toolbarConfig;
                    var buttonItems = DataHelper.convertObjectToArray(toolbarConfig.buttonItems);
                    for (var i = 0; i < buttonItems.length; i++) {
                        buttonItems[i].buttons = DataHelper.convertObjectToArray(buttonItems[i].buttons);
                    }
                    this._toolbarConfig = { "buttonItems": buttonItems };
                    if (this.isWorkflowCriterion) {
                        this.resetConfigForWorkflow();
                    }
                }
            }
            
            setPageRange(range) {
                if (!this.shadowRoot) return;

                const toolbarRange = this.shadowRoot.querySelector('pebble-toolbar').shadowRoot.querySelector('pebble-button#pageRange');
                if (toolbarRange) {
                    toolbarRange.buttonText = range;
                }
            }
            
            resetConfigForWorkflow() {
                if (_.isEmpty(this._toolbarConfig)) {
                    return;
                }
                var buttonsToHide = ["bulkdelete"];

                if (this.isWorkflowCriterion) {
                    var toolbarConfig = DataHelper.cloneObject(this._toolbarConfig);
                    //Hide button
                    var buttonItems = toolbarConfig.buttonItems;
                    for (let i = 0; i < buttonItems.length; i++) {
                        var buttons = buttonItems[i].buttons;
                        for (let j = 0; j < buttons.length; j++) {
                            if (buttonsToHide.indexOf(buttons[j].name) != -1) {
                                buttons[j].visible = false;
                            }
                        }
                    }
                    this._toolbarConfig = toolbarConfig;
                }
            }

            setAttributeToToolbarButton(btnName, attribute, addAttr) {
                if (!this.shadowRoot) {
                    return;
                }

                var toolbar = this.shadowRoot.querySelector("#searchResultToolbar");
                if (toolbar) {
                    toolbar.setAttributeToToolbarButton(btnName, attribute, addAttr);
                }
            }

            _onToolbarEvent(e, detail) {
                this.fireBedrockEvent("rock-toolbar-button-event", detail);
            }

            //Event is needed only for pageRange
            _onToolbarChange(e, detail) {
                if (DataHelper.isValidObjectPath(detail, "model.button.name") && detail.model.button.name == "pageRange") {
                    this.fireBedrockEvent("on-page-range-requested", detail);
                }
            }
        }
        customElements.define(RockEntitySearchResultActions.is, RockEntitySearchResultActions);
    </script>
</dom-module>