<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-business-function-behavior/bedrock-business-function-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html" />
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../rock-attribute/rock-attribute.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<dom-module id="rock-variant-configurator">
  <template>
    <style include="bedrock-style-common">

        :host{
            display:block;
            height:100%;
        }
        pebble-data-table{
            width:90%;
            margin:0 auto;
        }
        
        pebble-data-table data-table-row[selected] {
            background-color: var(--table-row-selected-color, #c1cad4) !important;
        } 
        pebble-data-table data-table-row[header] {
            font-weight: var(--font-bold, bold);
            color: var(--palette-cerulean, #036bc3);
            border-bottom: none;
            text-transform: uppercase;
            font-size: var(--table-head-font-size, 11px);
        }

        pebble-data-table data-table-row:not([header]) {
            color: var(--palette-dark, #1a2028);
            font-size: var(--default-font-size, 12px);
            height: 100%;
            background-color: var(--palette-white, #ffffff);
        }

        pebble-data-table data-table-row:not([header]):hover,
        pebble-data-table data-table-row[selected] {
            background-color: var(--table-row-selected-color, #c1cad4) !important;
        }

        pebble-data-table data-table-row:not([header]):hover data-table-checkbox,
        pebble-data-table data-table-row[selected] data-table-checkbox {
            background-color: var(--palette-white, #ffffff) !important;
        }
        pebble-data-table data-table-row[header] {
            --pebble-direction-icon-button: {
                opacity: 0.7 !important;
            }
        }

        pebble-data-table data-table-row data-table-cell {
            padding: 0 30px 0 0px;
        }
        pebble-data-table data-table-row data-table-cell:last-of-type {
            padding: 0 0px 0 0px;
        }
        data-table-cell {
            height: 50px;
            padding-left: 20px;
            padding-right: 0;
            position: relative;
            flex-basis: 0;
        }
        data-table-cell #iconDiv {
            right: 5px;
            bottom: 13px;
        }               
        .add-icon {
            margin-left: 10px;
            margin-top: 10px;
        }
        .title {
            font-size: var(--default-font-size, 14px);
            text-align: center;
            color:var(--palette-steel-grey, #75808b);
        }

        #errorsDialog {
            --popup-header-color: var(--palette-pinkish-red, #ee204c);
        }
    </style>

    <pebble-dialog id="errorsDialog" modal small vertical-offset=1 50 horizontal-align="auto" vertical-align="auto" no-cancel-on-outside-click no-cancel-on-esc-key dialog-title="Errors on page">
        <p>Found below errors in entity details: </p>
        <ul>
            <template is="dom-repeat" items="[[_syncValidationErrors]]">
                <li>[[item.attributeExternalName]] with error: [[item.message]]</li>
            </template>
        </ul>
        <p>Do you want to fix the errors or continue ? </p>
        <div class="buttons">
            <pebble-button id="skip" class="close btn btn-secondary m-r-5" button-text="Skip & Continue" on-tap="_skipServerErrors"></pebble-button>
            <pebble-button id="ok" class="apply btn btn-success" button-text="Fix" on-tap="_closeErrorsDialog"></pebble-button>
        </div>
    </pebble-dialog>

    <pebble-dialog id="confirmationDialog" dialog-title="Confirmation" modal alert-box show-cancel show-ok no-cancel-on-outside-click
    no-cancel-on-esc-key>
        <p>There are unsaved changes.Are you sure you want to continue?</p>
    </pebble-dialog>


    <div class="variantAttributesGridContainer base-grid-structure"> 
        <div class="base-grid-structure-child-1">
            <div id="content-description" align="center">
                <!-- description message here -->
                <div class="title m-0">
                    You can select multiple options to create variants.
                </div>
            </div>
        </div>
        <pebble-spinner active="[[isSpinnerActive]]"></pebble-spinner>           
        <template is="dom-if" if="[[isVariantAttributesGridLoaded]]">
            <div class="base-grid-structure-child-2">
                <div class="button-siblings">
                <pebble-data-table id="variant-attributes-grid" items="[[variantAttributesGridData]]">
                   <!-- <data-table-column slot="column-slot" flex="0">
                    <template>
                        <pebble-icon slot="cell-slot-content" icon="pebble-icon:goveranance-indeterminate" target-id="variant-attributes-grid" on-tap="_onDeleteRowClick"></pebble-icon>                        
                    </template>
                    </data-table-column>!-->
                    <data-table-column slot="column-slot" name="OPTION">
                    <template>
                            <div id="inputDiv" class="full-width" slot="cell-slot-content" on-tap="" index="[[index]]">
                                <pebble-textbox readonly id="variant-text_[[index]]" row-id="[[index]]" value="{{item.externalName}}" no-label-float="true"></pebble-textbox>
                            </div>
                            <!--<div id="iconDiv" slot="cell-slot-content">
                                <pebble-icon class="dropdown-icon pebble-icon-size-10" id="vtxtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-icon:navigation-action-down" on-tap="_openVariantAttributeLov"></pebble-icon>
                            </div>  !-->                    
                    </template>                        
                    </data-table-column>
                    <data-table-column slot="column-slot" name="VALUES">
                        <template>
                            <div slot="cell-slot-content" on-tap="" index="[[index]]" class="full-width">
                                <rock-attribute class="variantAttributes" row-id="[[index]]" attribute-model-object$="[[item]]" attribute-object$="{{_getAttributeObject(item.name)}}" context-data="[[contextData]]" mode="edit" functional-mode="grid"></rock-attribute>
                            </div>                                                   
                        </template> 
                    </data-table-column>
                </pebble-data-table>
                </div>
                <div class="buttonContainer-static" align="center">
                        <pebble-button id="cancelButton" class="close btn btn-secondary m-r-5" button-text="Cancel" noink elevation="2" on-tap="_onCancel"></pebble-button>
                        <pebble-button id="skipButton" class="close btn btn-secondary m-r-5" button-text="Skip & Continue" on-tap="_onSkip"></pebble-button>
                        <pebble-button id="confirmButton" class="apply btn btn-success" button-text="Save" noink elevation="2" on-tap="_onSave"></pebble-button>
                    </div>
            </div> 
           
            <!--pebble-icon slot="cell-slot-content" icon="pebble-icon:action-add-fill" class="pebble-icon-color-success add-icon" target-id="variant-attributes-grid" on-tap="_onAddRowClick"></pebble-icon-->                        
        </template> 
    </div>

    <liquid-rest id="variantModelGet" url="/data/pass-through/entityappmodelservice/getnearestcontext" method="POST" on-liquid-response="_onDimentionAttributeListReceived" on-liquid-error="_onDimentionAttributeListGetFailed"></liquid-rest>
    <liquid-entity-model-composite-get id="entityModelGet" on-entity-model-composite-get-response="_onEntityModelGetResponse" on-error="_onEntityModelGetFailed"></liquid-entity-model-composite-get>
    <liquid-entity-data-get operation="getbyids" id="variantAttributesOptionsGet" on-response="_onVariantAttributesOptionsGetReceived" on-error="_onVariantAttributesOptionsGetFailed" exclude-in-progress></liquid-entity-data-get>
    <liquid-rest id="entityGovernService" url="/data/pass-through/entitygovernservice/validate" method="POST" request-data={{_entityGovernRequest}} on-liquid-response="_onEntityGovernResponse" on-liquid-error="_onEntityGovernFailed"></liquid-rest>
    <liquid-entity-data-save id="variantAttributesOptionsSave" operation="[[_entityDataOperation]]" request-data="{{_saveVariantAttributeOptionsReq}}" on-response="_onSaveVariantAttributeOptions"  data-index="[[dataIndex]]" data-sub-index="[[dataSubIndex]]" on-error="_onSaveVariantAttributeOptionsError"></liquid-entity-data-save>
    <bedrock-pubsub event-name="govern-complete" handler="_onGovernComplete"></bedrock-pubsub>
    <bedrock-pubsub event-name="on-buttonok-clicked" handler="_onSkipConfirm" target-id="confirmationDialog"></bedrock-pubsub>
    
  </template>
<script>

(function(){

    class RockVariantConfigurator
        extends Polymer.mixinBehaviors([
				RUFBehaviors.AppBehavior,
				RUFBehaviors.BusinessFunctionBehavior,
                RUFBehaviors.ComponentConfigBehavior,
                RUFBehaviors.UIBehavior
                ], Polymer.Element) {
        static get is() { return 'rock-variant-configurator' }

        ready() {
            super.ready();
        }
        static get properties() {
            return {
                contextData: {
					type: Object,
					value: function () {
						return {};
                    },
                    observer: '_contextChanged'
                },
                
				config: {
					type: Object,
					value: function () { 
						return {}; 
					}
                },
                
				variantAttributesGridData: {
					type: Array,
					value: function () {
                        return [];
                    }
                },
                _attributeResponse: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _entityDataOperation: {
                    type: String,
                    value: 'update'
                },
                _saveVariantAttributeOptionsReq: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                doSyncValidation: {
                    type: Boolean,
                    value: true
                },
                dataIndex: {
                    type: String,
                    value: "entityData"
                },
                dataSubIndex: {
                    type: String,
                    value: "data"
                },
                loadGovernData:{                    
                    type: Boolean,
                    value: true
                },
                isVariantAttributesGridLoaded:{
                    type: Boolean,
                    value: false
                },
                _attributes:{
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                messageCodeMapping: {
                    type: Object,
                    value: function () { return {}; }
                },
                _syncValidationErrors: {
                    type: Array,
                    value: function () { return []; }
                },
                
                variantModelObj: {
                    type: Object,
                    value: function () { return {}; }
                },
                
                saveNotification: {
                    type: Object,
                    value: function () { return {}; }
                },

                isSpinnerActive:{
                    type: Boolean,
                    value: false
                }
                
            }
        }
               
        /**
         *  Generate a request to get the dimention attributes from the variant model
        */
        _contextChanged() {
            this.isSpinnerActive = true;
            var req = DataRequestHelper.createVariantModelGetRequest(DataHelper.getParamValue('type'),this.contextData.Contexts);           
            if (req) {
                var variantModelGet = this.shadowRoot.querySelector("#variantModelGet");
                if(variantModelGet) {
                    variantModelGet.requestData = req;                    
                    variantModelGet.generateRequest();
                }
            }
         
        }

        /**
         *  Function to handle success of variant model get 
         *  Generate a request to fetch the entity model for the given dimention attributes
        */
        _onDimentionAttributeListReceived(e, detail){
            if (e.detail.response.response.status == "success") { 
                var response = e.detail.response.response.entityModels[0];            
                response = this._mergeAllContextualLevelsIntoSelf(response);
                
                if(response) {
                    this.dimentionAttributesList = this._getDimentionAttributeList(response); 
                    var req = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);           
                    if (req) {                       
                        req.params.fields.attributes = this.dimentionAttributesList; 
                        var entityModelGet = this.shadowRoot.querySelector("#entityModelGet");
                        if(entityModelGet) {
                            entityModelGet.requestData = req;                    
                            entityModelGet.generateRequest();
                        }
                    }  
                }
            } else {
                this.logWarning("Unable to fetch variant model. Please contact administrator.", "response", JSON.stringify(e.detail));
                this.showErrorToast("Unable to fetch variant model. Please contact administrator.");
            }
        }

        /**
         *  Function to handle failure of variant model get
        */
        _onDimentionAttributeListGetFailed(e){
            this.logWarning("Unable to fetch variant attributes list. Please contact administrator.", "response", JSON.stringify(e.detail));
            this.showErrorToast("Unable to fetch variant attributes list. Please contact administrator.");
            this.isSpinnerActive = false;
        }	
        
        /**
         *  Function to get the dimention atrributes from the given list
         *  Update the variantModelObj to be used in the next screen
        */
        _getDimentionAttributeList(response) {                     
            this.variantModelObj.attributeList = [];
            this.variantModelObj.targetEntities = [];            
            var list = response.properties.levels;
            
            for(var listItem=0;listItem<list.length;listItem++){
                let dimentions = list[listItem].dimensionAttributes;
                this.variantModelObj.targetEntities.push({"targetEntity":list[listItem].targetEntityType});
                var tempAttributeList = [];
                for(var dimensionAttributeListItem=0;dimensionAttributeListItem<dimentions.length;dimensionAttributeListItem++) {
                    this.variantModelObj.attributeList.push(dimentions[dimensionAttributeListItem].name);
                    tempAttributeList.push(dimentions[dimensionAttributeListItem].name);
                }
                this.variantModelObj.targetEntities[listItem].attributeNames = tempAttributeList; 
            }

            //Remove duplicate target entities if any
            this.variantModelObj.targetEntities = _.uniq(this.variantModelObj.targetEntities, function(item, key, id) { 
                return item.targetEntity;
            });

            return this.variantModelObj.attributeList;
        }

        /**
         *  Function to handle success of entity model get
         *  Call the function to generate the dimention attributes values
        */
        _onEntityModelGetResponse(e) {
            if(e.detail.response) {
                this._attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);
                if (this._attributeModels && !_.isEmpty(this._attributeModels)) {                    
                    this.getVariantAttributesOptions(this.dimentionAttributesList);
                }           
            }
        }

        /**
         *  Function to handle failure of entity model get
        */
        _onEntityModelGetFailed(e){           
            this.logWarning("variant entity model get failed with error", "response", JSON.stringify(e.detail));
            this.isSpinnerActive = false;
        }
        
        /**
         *  Handles delete row click
        */
        _onDeleteRowClick(e){
            var gridId = e.target.getAttribute("target-id");
            var grid = this.shadowRoot.querySelector("#"+gridId);
            var row = this._getParentRow(e.currentTarget);
            var index = row.index;
            grid.items.splice(index, 1);
            grid.clearCache();
        }

        /**
         *  Handles the add row click
        */
        _onAddRowClick(e) {    
            var gridId = e.target.getAttribute("target-id");
            var grid = this.shadowRoot.querySelector("#"+gridId);
            var newRowItem = 
            {
                "name": "",
                "value": ""    
            }  
            newRowItem.id = grid.items.length;            
            grid.items.push(newRowItem);
            grid.clearCache();
        }

        /**
         *  Get the parent row
        */
        _getParentRow(element) {
            if (element) {
                if (element.is == "data-table-row") {
                    return element;
                } else {
                    return this._getParentRow(element.parentNode);
                }
            }
            return undefined;
        }

        /**
         * Function to generate a request to fetch the entity data for the given attribute options
         */ 
         getVariantAttributesOptions(variantAttrList) {
            var clonedContextData = DataHelper.cloneObject(this.contextData);            
            var itemContexts = [];
            var itemContext = {};
            itemContext.type = DataHelper.getParamValue('type');
            itemContext.id = DataHelper.getParamValue('id');
            itemContexts.push(itemContext);
            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
            var request = DataRequestHelper.createEntityGetRequest(clonedContextData);
            request.params.fields.attributes = variantAttrList;

            let variantAttributesOptionsGet = this.shadowRoot.querySelector("#variantAttributesOptionsGet");
            if (variantAttributesOptionsGet) {
                variantAttributesOptionsGet.requestData = request;
                variantAttributesOptionsGet.generateRequest();
            }
        }

        /**
         *  Handles success of entity get for given variant attribute options
        */
        async _onVariantAttributesOptionsGetReceived(e,detail){
            var response = e.detail.response;
            this.originalEntity = e.detail.response.content.entities[0];
            this.variantModelObj.id = this.originalEntity.id;
            this.variantModelObj.type = this.originalEntity.type;
            this.variantModelObj.name = this.originalEntity.name;
            this._attributes = await DataTransformHelper.transformAttributes(e.detail.response.content.entities[0], this._attributeModels, this.contextData);
            
            var attributes = new Array();
            for(var obj in this._attributeModels){                                     
                attributes.push(this._attributeModels[obj]);
            }
            this.variantAttributesGridData = attributes;
            this.isVariantAttributesGridLoaded = true;
            this.isSpinnerActive = false;            
        }
        
        /**
         *  Handles failure of entity get for given variant attribute options
        */
        _onVariantAttributesOptionsGetFailed(e){
            this.logWarning("variant attribute get failed with error", "response", JSON.stringify(e.detail));
        }
         
        /**
         *  Function to get the attributeObject for the given name
        */
        _getAttributeObject(param){
            return this._attributes[param];
        }

        /**
         *  Close variant options configurator
        */
        _onCancel() {
            var eventName = "onCancel";
            var eventDetail = {
                name: eventName
            }

            this.fireBedrockEvent(eventName, eventDetail, {
                ignoreId: true
            });
        }
    
        /**
         *  Handle save click
         *  Do sync validation 
        */
        async _onSave(e) {              
            var newEntity = {};
            var attributesJSON = this._getAttributesJSON();
            newEntity = await DataTransformHelper.prepareEntityForAttributesSave(this.originalEntity, attributesJSON, this.contextData, this._attributeModels);
            if (!_.isEmpty(newEntity)) {
                //set requestObject for save liquid
                this._saveVariantAttributeOptionsReq = {
                    "entities": [newEntity]
                }; 

                //Update the no. of variants that can be generated
                this._updateVariantCount();
                
                //Add hotline flag                     
                this._saveVariantAttributeOptionsReq["hotline"] = true;

                //Do sync validation
                if (this.doSyncValidation) {
                    var req = DataRequestHelper.createSyncValidationRequest(newEntity.id, newEntity.type, newEntity.data);
                    this.set("_entityGovernRequest", req);
                    var liquidGovernGet = this.$.entityGovernService;
                    if (liquidGovernGet && this.loadGovernData) {
                        liquidGovernGet.generateRequest();
                    }
                } else {
                    this._saveEntity();
                }                  
            }
        }

        /**
         *  Handle skip click
         *  If there are unsaved changes, show the confirmation dialog, else go to next step
        */
        _onSkip(){           
            //If there  is change in the dimention attributes list, then show the message
            var rockAttributeObjList = this.shadowRoot.querySelectorAll(".variantAttributes");
            var isAttributesChanged = _.find(rockAttributeObjList, function(item) {return item.changed == true;});
            if(isAttributesChanged) {
                this._confirmationDialog = this.shadowRoot.querySelector("#confirmationDialog");
                this._confirmationDialog.open();
            } else {
                this._onSkipConfirm();
            }            
        } 

        /**
         * Go to next step
         */ 
        _onSkipConfirm(){
            var isOriginalAttribute = true;
            this._updateVariantCount(isOriginalAttribute);
            this.goToNextStep();     
        } 

        /**
         *  Calculate the total no. of variants that can be generated from the selected dimention attributes 
        */
        _updateVariantCount(isOriginalAttribute){            
            var totalVariantsCount = 1;
            var tempLevelCount = 1;
            var totalLevelCount = 0;
            var rockAttributeObjList = this.shadowRoot.querySelectorAll(".variantAttributes");
            for(var i=0 ;i<this.variantModelObj.targetEntities.length;i++){
                var targetEntity = this.variantModelObj.targetEntities[i]; 
                tempLevelCount = 1;               
                for(var j=0;j<targetEntity.attributeNames.length;j++){
                    var attributeName = targetEntity.attributeNames[j];
                    //Handling the updated dimention attribute list
                    if(!isOriginalAttribute) {
                        for(var k=0;k<rockAttributeObjList.length;k++){
                            if(attributeName == rockAttributeObjList[k].attributeObject.name){
                                var count = rockAttributeObjList[k].attributeObject.value.length;
                                if(count > 0) {
                                    tempLevelCount = tempLevelCount*count;
                                    totalVariantsCount = totalVariantsCount*count;
                                    break;
                                }
                            }
                        }
                    } else {  //Handling the original dimention attribute list
                        if(this._attributes[attributeName]){
                            var count = this._attributes[attributeName].value.length;
                            if(count > 0) {
                                tempLevelCount = tempLevelCount*count;
                                totalVariantsCount = totalVariantsCount*count;  
                            }                          
                        }
                    }
                }            

                if(i>=this.variantModelObj.targetEntities.length-1) { 
                    continue;
                }   
                totalLevelCount = totalLevelCount+tempLevelCount;                
            }

            totalVariantsCount = totalVariantsCount+totalLevelCount;

            this.variantModelObj.totalVariantsCount = totalVariantsCount;
        }

        /**
         *  Generate request to save the variant attributes selection 
        */
        _saveEntity(){           
            var variantAttrOptSave = this.shadowRoot.querySelector("#variantAttributesOptionsSave");
            if (variantAttrOptSave) {
                variantAttrOptSave.generateRequest();
            }

            //Reset the save notification flag
            this.saveNotificationReceived = false;

            //Show the spinner 
            this.isSpinnerActive = true; 

            //If the notification is not received within the given time, go to next screen
            this.saveNotification = setTimeout(() => {
                if(!this.saveNotificationReceived) {                   
                    this.variantModelObj.noNotification = true;
                    this.goToNextStep();
                }
                clearTimeout(this.saveNotification);                              
            }, 5000);
        }
        
        /**
         *  Handles success of variant attribute options save
        */
        _onSaveVariantAttributeOptions(){
            this.showSuccessToast("Variant attributes options saved successfully");                        
        }

        /**
         * After the save, notification is received from server, go to next step
         */ 
        _onGovernComplete(){
            this.saveNotificationReceived = true;
            clearTimeout(this.saveNotification);
            this.goToNextStep();
        }

        /**
         *  Trigger next step
        */
        goToNextStep(){  
            
            this.isSpinnerActive = false; 
            this.businessFunctionData = this.variantModelObj;

            //Move to next step
            var eventName = "onSave";
            var eventDetail = {
                name: eventName
            }

            this.fireBedrockEvent(eventName, eventDetail, {
                ignoreId: true
            });
        }

        /**
         *  Handles failure of variant attribute options save
        */
        _onSaveVariantAttributeOptionsError(e){           
            this.logWarning("variant attributes options save failed with error", "response", JSON.stringify(e.detail));
            var reason = e.detail.response.reason;
            this.showErrorToast(reason, 10000); 
        }

        /**
         *  Function to get the list of attributes from the variant grid  
        */
        _getAttributesJSON() {
            var attributesJSON = [];
            var attributeElements = Polymer.dom(this).node.shadowRoot.querySelectorAll('.variantAttributes');
            for (var i = 0; i < attributeElements.length; i++) {  
                var attributeElement =  attributeElements[i];                              
                var attributeJSON = attributeElement.attributeObject;
                if (attributeElement.attributeModelObject && attributeElement.attributeModelObject.referenceEntityTypes) {
                    var attributeRefEntityTypes = attributeElement.attributeModelObject.referenceEntityTypes;
                    if (attributeRefEntityTypes instanceof Array && attributeRefEntityTypes.length > 0) {
                        attributeJSON.referenceEntityType = attributeRefEntityTypes[0];
                    }
                }
                attributesJSON.push(attributeJSON);
            } 
            return attributesJSON;
        }   

        /**
         *  Handles success of govern get
        */
        _onEntityGovernResponse(e) {
            if (e && e.detail && e.detail.response && e.detail.response.response && e.detail.response.response.status == "success") {
                var res = e.detail.response.response;
                var itemContext = ContextHelper.getFirstItemContext(this.contextData);
                var entityId;
                if (itemContext) {
                    entityId = itemContext.id;
                }
                var entity = DataHelper.findEntityById(res.entities, entityId);
                var attrMessages = this._getAttributeMessages(entity);

                if (!_.isEmpty(attrMessages)) {
                    var errorMessages = MessageHelper.getErrorsFromAttrMessages(attrMessages, this._attributeModels);
                    this.set("_syncValidationErrors", errorMessages);
                    this.$.errorsDialog.open();
                    return;
                } else {
                    this._saveEntity();
                }
            } else {
                this.logWarning("AttributeManageValidationFail", "response", JSON.stringify(e.detail));
                this.showErrorToast("There is a problem in validation service. Please contact administrator.");
            }
        }

        /**
         *  Function to get the attribute messages
        */
        _getAttributeMessages(entity) {
            var attrMessages = {};
            var firstDataContext = ContextHelper.getFirstDataContext(this.contextData);

            var mergedAttributes = {};

            if (entity && entity.data && entity.data.attributes) {
                mergedAttributes = DataMergeHelper.mergeAttributes(mergedAttributes, entity.data.attributes, true);
            }

            if (firstDataContext) {
                var ctxAttributes = SharedUtils.DataObjectFalcorUtil.getAttributesByCtx(entity, firstDataContext);
                if (!_.isEmpty(ctxAttributes)) {
                    mergedAttributes = DataMergeHelper.mergeAttributes(mergedAttributes, ctxAttributes, true);
                }
            }

            attrMessages = MessageHelper.getAttributeMessages(mergedAttributes, this._attributeModels, this.messageCodeMapping, this.localize());

            return attrMessages;
        }

        /**
         *  Handles failure of variant attribute get
        */
        _onEntityGovernFailed(e) {
            this.logWarning("variant attribute manage govern failed with error :", "response", JSON.stringify(e.detail));
            this.showErrorToast("There is a problem in validation service. Please contact administrator.");
        }

        /**
         * Function to close the error dialog
         */ 
         _closeErrorsDialog() {
            this.$.errorsDialog._close();
        }

        /**
         * Function to handle skip click on the error dialog
         */ 
        _skipServerErrors() {
            this._closeErrorsDialog();
            this._saveEntity();
        }

        _mergeAllContextualLevelsIntoSelf(entityModel) {
            if (entityModel) {
                let mergedLevels = [];
                let levels = [];

                if (entityModel.properties && entityModel.properties.levels) {
                    levels = entityModel.properties.levels;
                }

                if (entityModel.data && entityModel.data.contexts) {
                    for (let ctx of entityModel.data.contexts) {
                        if (ctx.properties && ctx.properties.levels) {
                            for (let level of ctx.properties.levels) {
                                levels.push(level);
                            }
                        }
                    }
                }

                if (levels) {
                    for (let i = 1; i < i + 1; i++) {
                        let ilevels = levels.filter(v => v.levelNumber == i);

                        if (!_.isEmpty(ilevels)) {
                            if (ilevels.length == 1) {
                                mergedLevels.push(ilevels[0]);
                            } else {
                                let tempLevel = ilevels[0];
                                for (let ilevel of ilevels) {
                                    if (ilevel.dimensionAttributes) {
                                        for (let dimAttr of ilevel.dimensionAttributes) {
                                            let isExist = tempLevel.dimensionAttributes.find(v => v.name == dimAttr.name);
                                            if (!isExist) {
                                                tempLevel.dimensionAttributes.push(dimAttr);
                                            }
                                        }
                                    }
                                }
                                mergedLevels.push(tempLevel);
                            }
                        } else {
                            break;
                        }
                    }
                }
                
                delete entityModel.data;
                entityModel.properties.levels = mergedLevels;
            }
            return entityModel;
        }
    }

    customElements.define(RockVariantConfigurator.is, RockVariantConfigurator)


})();
</script>
</dom-module>
