<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">


<!--
`pebble-grid`
Grid control for riversand ui framework

The following JSON object is a sample of config used to configure grid

```json
{
    "viewMode": "Tabular",
    "title": "Simple Data Table",
    "tabular": {
        "settings": {
        
            "isMultiSelect": true
        
        },
        "columns": [
            {
                "header": "Short Name",
                "name": "shortName",
                "sortable": true,
                "filterable": false,
                "editType":"text"
            },
            {
                "header": "Long Name",
                "name": "longName",
                "sortable": false,
                "filterable": true,
                "editType":""
            },
            {
                "header": "Product Type",
                "name": "productType",
                "sortable": false,
                "filterable": false,
                "editType":"text"
            }
}
```

The following JSON object is a sample of data to be used to bind grid

```json
[
    {
        "shortName": "web Price",
        "longName": "Web Price",
        "productType": "Electronics",
        "description": "product web price",
        "isNew": false,
        "isApproved": true
    },
    {
        "shortName": "catalog",
        "longName": "Catalog",
        "productType": "Toys",
        "description": "catalog information",
        "isNew": true,
        "isApproved": false
    },
    {
        "shortName": "cost1",
        "longName": "Cost2",
        "productType": "Value",
        "description": "cost of the product1",
        "isNew": false,
        "isApproved": true
    }
]
```

@demo demo/index.html
-->

<dom-module id="pebble-grid">
	<template>
		<style include="shared-styles">
			#viewMode {
				padding: 0 20px 0 0;
				width: 110px;
			}
			
			h1 {
				text-align: center;
				font-family: var(--default-font-family);
			}
			
			div.clearboth {
				clear: both;
			}
			

		</style>
		<style is="custom-style">
			iron-data-table {
				
				--iron-data-table-row: {
					align-items: center;
					
				}
				--iron-data-table-header: {
					background-color: #139DE6;
					height: 45px;
					color: white;
					font-family:var(--default-font-family);
				}
				--iron-data-table-row-odd: {
					background-color: #FFFFFF;
					font-family:var(--default-font-family);
				}
				--iron-data-table-row-even: {
					background-color: #F9FBFD;
					font-family:var(--default-font-family);
				}
			}
			
			#pebbleGridContainer {
				border: 1px solid #D0D7DE;
				font-family: var(--default-font-family);
				font-size: 15px;
			}
			
			#gridHeader {
				border-color: #D0D7DE;
				border-style: solid;
				border-width: 1px 1px 0px 1px;
				font-family: var(--default-font-family);
				font-size: 14px;
			}
			
			#gridHeader > span {
				float: left;
				margin-top: 10px;
				margin-left: 5px;
				font-weight: 900;
			}
			
			pebble-button {
				--pebble-button: {
					height: 30px;
					padding: 0.5em 0em 0.5em 0em;
					min-width: 2.14em;
					margin: 0px;

				}
				--pebble-button-iron-icon: {
					height: 20px;
					width: 20px;
					padding: 0 5px 0 0;
					color:#7d8690;
					
				}
				
				--pebble-button-paper-menu: {
					background: #ffffff;
					color: #000000;
				}		
				--pebble-button-paper-menu-item: {
					background: #ffffff;
					color: #000000;
					font-size: 14px;
				}
			}
			
			pebble-button.pageRange::shadow paper-button {
				padding: 0px 8px 0px 9px;
				vertical-align: text-bottom;
				font-family: var(--default-font-family);
			}
			
			pebble-vertical-divider {
				min-width:1px;
				min-height:24px;
				border-right: 0;
				--pebble-vertical-divider-color: #ccc;
			}
			
			.input-content.paper-input-container .paper-input-label {
				color: white !important;
				font-family: var(--default-font-family);
			}
			
		</style>
		<template is="dom-if" if="{{_dataIsNotNull(data)}}">
			<div id="gridHeader" align="right">
				<span>[[config.title]]</span>
				<pebble-button class="pageRange" button-text="{{_pageRange}}" elevation="1" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<pebble-button icon="refresh" on-tap="_onRefresh" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<pebble-button icon="file-download" on-tap="_onDownload" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<pebble-button icon="file-upload" on-tap="_onUpload" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<pebble-button items="Tabular,Tile,List" class="dropdownIcon" icon="view-list" menu-button button-text="{{config.viewMode}}"
					selected-value="{{config.viewMode}}" noink raised no-overlap vertical-offset="-200" horizontal-offset="10"></pebble-button>
			</div>
			<div id="pebbleGridContainer">
				<template is="dom-if" if="{{_isTabularMode(config.viewMode)}}">
					<iron-data-table page-size="{{pageSize}}" size="{{size}}" selection-enabled multi-selection="{{config.tabular.settings.isMultiSelect}}"
						data-source="{{dataSource}}">
						<template is="dom-repeat" items="[[config.tabular.columns]]" as="col" index-as="colIndex">
							<template is="dom-if" if="[[_isCheckBox(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-checkbox checked$="{{_columnValue(item, column.columnIndex)}}"></paper-checkbox>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isTextArea(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-textarea value="{{_columnValue(item, column.columnIndex)}}"></paper-textarea>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isRadioButton(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-radio-button checked$="{{_columnValue(item, column.columnIndex)}}"></paper-radio-button>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isTextBox(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-input value="{{_columnValue(item, column.columnIndex)}}"></paper-input>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isNotEditable(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>[[_columnValue(item, column.columnIndex)]]</template>
								</data-table-column>
							</template>
						</template>
					</iron-data-table>
				</template>
				<template is="dom-if" if="{{_isTileMode(config.viewMode)}}">
					<h1>Under Design</h1>
				</template>
				<template is="dom-if" if="{{_isListMode(config.viewMode)}}">
					<h1>Under Design</h1>
				</template>
			</div>
		</template>
	</template>
	<script> 
      (function() {
            'use strict';
            
            Polymer( {
                is: 'pebble-grid', 
				/**
				* Fired when user clicks on a item to select it.
				*
				* @event grid-selecting-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be selected
				*/

				/**
				* Fired when user clicks on a item to deselect it.
				*
				* @event grid-deselecting-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be deselected
				*/

				/**
				* Fired when user clicks on the select all checkbox to select items.
				*
				* @event grid-selecting-all-items (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item containing current filters for items
				*/

				/**
				* Fired when user clicks on the select all checkbox to deselect items.
				*
				* @event grid-deselecting-all-items (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item containing current filters for items
				*/

				/**
				* Fired when user clicks on a item to expand it.
				*
				* @event grid-expanding-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be expanded
				*/

				/**
				* Fired when user clicks on a item to collapse it.
				*
				* @event grid-collapsing-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be collapsed
				*/
                properties: {
					/**
					 * It is a data which would be wrapped in data-source to be used as a grid data
					 * The format for the JSON object is given in above description
					 */					
					data: {
						type: Object
					},

					/**
					 * It is a data-source, which will be bound to grid
					 * The format for the JSON object is given in above description
					 */					
					dataSource: {
						notify: true,
						value: function() {
							return this._dataSource.bind(this);
						}
					},

					/**
					 * It is a total size of the data-source
					 */	
					size: {
						notify: true,
						value: function() {
							return this.data ? this.data.length : 0;
						}
					},

					/**
					 * Number of items fetched at a time from the datasource.
					 */
					pageSize: {
						type: Number,
						notify: true,
						value: 15
					},

					/**
					 * It is a config object, which will decide rendering behavior
					 * The format for the JSON object is given in above description
					 */	
					config: {
						type: Object
					},

					_currentPage:{
						notify: true,
						value: 0
					},

					_pageRange: {
						value: ""
					}
                },

				observers: [
					'_calculatePageRange(_currentPage, pageSize, data.length)'
				],

				listeners: {
					'selecting-item': '_onSelectingItem',
					'deselecting-item': '_onDeselectingItem',
					'selecting-all-items': '_onSelectingAllItems',
					'deselecting-all-items':'_onDeselectingAllItems',
					'expanding-item':'_onExpandingItem',
					'collapsing-item':'_onCollapsingItem'
				},

				/**
				* Clears the cached pages and reloads data from datasource when needed.
				*/
				clearCache: function() {
				    var ironDataTable = this._getIronDataTable();
					ironDataTable.clearCache();
				},

				/**
				* Clears the cache for a page and reloads the data from datasource.
				*/
				refreshPage: function(page) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.refreshPage(page);
				},

				/*
				* Selects all the items in the list.
				*/
				selectAll: function(){
					var ironDataTable = this._getIronDataTable();
					ironDataTable.selectAll();
				},

				/**
				* Clears the current selection state.
				*/
				clearSelection: function() {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.clearSelection();
				},

				/**
				* Select the list item at the given index.
				*
				* @method selectItem
				* @param {(Object|number)} item The item object or its index
				*/
				selectItem: function(item) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.selectItem(item);
				},

				/**
				* Deselects the given item list if it is already selected.
				*
				* @method deselect
				* @param {(Object|number)} item The item object or its index
				*/
				deselectItem: function(item){
					var ironDataTable = this._getIronDataTable();
					ironDataTable.deselectItem(item);
				},

				/**
				* Expands the row details for this item, if available.
				*/
				expandItem: function(item) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.expandItem(item);
				},

				/**
				* Collapses the row details for this item, if expanded.
				*/
				collapseItem: function(item) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.collapseItem(item);
				},

				/**
				 * When `multiSelection` is true, this is an array that contains the selected items.
				 * @return {Array<object>} The selectedItems is an array of object and other properties as below.
				 * If `selectedItems.inverted` is `true`, the array contains deselected items instead.
				 * `selectedItems.filters` contains an array of filters that were active when the selection changed.
				 */
				getSelectedItems: function(){
					var ironDataTable = this._getIronDataTable();
					return ironDataTable.selectedItems;
				},

				/**
				 * @return {object} The item object.
				 * It returns currently selected item, or `null`
         		 * if no item is selected.
				 */
				getSelectedItem: function(){
					var ironDataTable = this._getIronDataTable();
					return ironDataTable.selectedItem;
				},

				_dataSource: function(opts, cb) {
                    this._currentPage = opts.page;
					cb(this.data.slice(opts.page * opts.pageSize, (opts.page  * opts.pageSize) + opts.pageSize))
				 },

				_calculatePageRange: function(currentPage, pageSize, size){
					var totalSize = pageSize + currentPage * pageSize;
					if(totalSize > size) {
						totalSize = size;
					}
					this._pageRange = "1 - " + totalSize + " / " + size;
				},

                _columnValue: function(gridData, index) {
                    var cellData = gridData[this.config.tabular.columns[index].name];
                    if(cellData != undefined) {
                       index++;
                    }
                    return cellData;
				},
				_isTabularMode: function(viewMode){
					return viewMode == 'Tabular';
				},
				_isTileMode: function(viewMode){
					return viewMode == 'Tile';
				},
				_isListMode: function(viewMode){
					return viewMode == 'List';
				},
				_isTextBox: function(col){
					return col.editType == 'text';
				},
				_isCheckBox: function(col){
					return col.editType == 'checkbox';
				}, 
				_isTextArea: function(col){
					return col.editType == 'textarea';
				},
				_isRadioButton: function(col){
					return col.editType == 'radio';
				},
				_isNotEditable: function(col){
					return col.editType == '';
				},
				_isFilterEnabled: function(col){
					return col.filterable ? col.name : undefined;
				},
				_isSortable: function(col){
					return col.sortable ? col.name : undefined;
				},
				_dataIsNotNull: function(){
					return typeof(this.data) == "object";
				},

				_onRefresh: function(e) {
					this.clearCache(); 
				},

				_onDownload: function(e) {
					this.selectAll();
				},

				_onUpload: function(e) {
					this.clearSelection();
				},

				_getIronDataTable: function(){
					 return Polymer.dom(this.root).node.querySelector("iron-data-table")
				   || Polymer.dom(this).node.querySelector("iron-data-table");
				},

				_onSelectingItem: function(e){
					this.fire('bedrock-event', { name: "grid-selecting-item", data: e.detail });
				},

				_onDeselectingItem: function(e){
					this.fire('bedrock-event', { name: "grid-deselecting-item", data: e.detail });
				},

				_onSelectingAllItems: function(e){
					this.fire('bedrock-event', { name: "grid-selecting-all-items", data: e.detail });
				},

				_onDeselectingAllItems: function(e){
					this.fire('bedrock-event', { name: "grid-deselecting-all-items", data: e.detail });
				},

				_onExpandingItem: function(e){
					this.fire('bedrock-event', { name: "grid-expanding-item", data: e.detail });
				},

				_onCollapsingItem: function(e){
					this.fire('bedrock-event', { name: "grid-collapsing-item", data: e.detail} );	
				}
            });
        })();
    </script>
</dom-module>