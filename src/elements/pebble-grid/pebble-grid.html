<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="./grid-list-view.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">


<!--
`pebble-grid` Represents grid control of the framework. This grid creates visual consistency between layouts, 
while allowing flexibility across a wide variety of designs.

The following JSON object is a sample of config used to configure grid

```json
{
    "viewMode": "Tabular",
    "title": "Simple Data Table",
    "readOnly":true,
    "tabular": {
        "settings": {
        
            "isMultiSelect": true
        
        },
        "columns": [
            {
                "header": "Short Name",
                "name": "shortName",
                "sortable": true,
                "filterable": false,
                "editType":"text"
            },
            {
                "header": "Long Name",
                "name": "longName",
                "sortable": false,
                "filterable": true,
                "editType":""
            },
            {
                "header": "Product Type",
                "name": "productType",
                "sortable": false,
                "filterable": false,
                "editType":"text"
            }
}
```

The following JSON object is a sample of data to be used to bind grid

```json
[
    {
        "shortName": "web Price",
        "longName": "Web Price",
        "productType": "Electronics",
        "description": "product web price",
        "isNew": false,
        "isApproved": true
    },
    {
        "shortName": "catalog",
        "longName": "Catalog",
        "productType": "Toys",
        "description": "catalog information",
        "isNew": true,
        "isApproved": false
    },
    {
        "shortName": "cost1",
        "longName": "Cost2",
        "productType": "Value",
        "description": "cost of the product1",
        "isNew": false,
        "isApproved": true
    }
]
```

@demo demo/index.html
-->

<dom-module id="pebble-grid">
	<template>
		<style include="pebble-shared-styles">
			#viewMode {
				padding: 0 20px 0 0;
				width: 110px;
			}
			
			h1 {
				text-align: center;
				font-family: var(--default-font-family);
			}
			
			div.clearboth {
				clear: both;
			}
		</style>
		<style is="custom-style">
			iron-data-table {
				--iron-data-table-row: {
					align-items: center;
					border-bottom: 1px solid #e3e3e3;
					font-family: var(--default-font-family);
				}
				--iron-data-table-header: {
					background-color: #FFFFFF;
					height: 45px;
					font-family: var(--default-font-family);
					border-bottom: 1px solid #CCCCCC;
				}
			}
			
			iron-data-table data-table-row[header],
			iron-data-table data-table-row[header] /deep/ label {
				font-weight: 600;
				color: #4692D2 !important;
				border-bottom: none;
			}
			
			iron-data-table data-table-row[header] /deep/ paper-icon-button:not([direction]) {
				opacity: 0.7 !important;
			}
			
			#pebbleGridContainer {
				border: 1px solid #D0D7DE;
				font-family: var(--default-font-family);
				font-size: 15px;
			}
			
			#gridHeader {
				border-color: #CCCCCC;
				border-style: solid;
				border-width: 1px 1px 0px 1px;
				font-family: var(--default-font-family);
				font-size: 14px;
			}
			
			#gridHeader > span {
				float: left;
				margin-top: 10px;
				margin-left: 5px;
				font-weight: 900;
			}
			
			pebble-button {
				vertical-align: -webkit-baseline-middle;
				vertical-align: -moz-baseline-middle;
				vertical-align: baseline-middle;
				--pebble-button: {
					height: 30px;
					padding: 0.5em 0em 0.5em 0em;
					min-width: 2.14em;
					margin: 0px;
				}
				--pebble-button-iron-icon: {
					height: 20px;
					width: 20px;
					color: #7d8690;
				}
			}
			
			pebble-button.pageRange::shadow paper-button {
				padding: 0px 8px 0px 9px;
				vertical-align: text-bottom;
				font-family: var(--default-font-family);
			}
			
			pebble-vertical-divider {
				min-width: 1px;
				min-height: 24px;
				border-right: 0;
				--pebble-vertical-divider-color: #ccc;
			}
			
			.input-content.paper-input-container .paper-input-label {
				color: white !important;
				font-family: var(--default-font-family);
			}
			
			paper-dropdown-menu {
				width: 90px;
				--paper-input-container-underline: {
					display: none;
				}
				;
				--paper-input-container-underline-focus: {
					display: none;
				}
				;
			}
			.actionButton{
				margin-right:20px;
			}
		</style>
		<template is="dom-if" if="{{_dataIsNotNull(data, config, attributeModels)}}">
			<div id="gridHeader" align="right">
				<span>[[config.title]]</span>
				<pebble-button class="pageRange" button-text="{{_pageRange}}" elevation="1" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<pebble-button icon="refresh" on-tap="_onRefresh" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<template is="dom-if" if="[[!config.readOnly]]">
				  <pebble-button icon="pebble-icons:Icons/Edit" on-tap="_changeToEditMode" noink raised></pebble-button>
				  <pebble-vertical-divider></pebble-vertical-divider>
				</template>
				<pebble-button icon="file-download" on-tap="_onDownload" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<pebble-button icon="file-upload" on-tap="_onUpload" noink raised></pebble-button>
				<pebble-vertical-divider></pebble-vertical-divider>
				<paper-dropdown-menu label="{{config.viewMode}}" no-label-float>
					<paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{config.viewMode}}">
						<paper-item value="Tabular">Tabular</paper-item>
						<paper-item value="List">List</paper-item>
						<paper-item value="Tile">Tile</paper-item>
					</paper-listbox>
				</paper-dropdown-menu>
			</div>
			<div id="pebbleGridContainer">
				<template is="dom-if" if="{{_isTabularMode(config.viewMode)}}">
                  <template is="dom-if" if="{{!_isNotEditable(config.mode)}}" >
					<iron-data-table page-size="{{pageSize}}" size="{{_getRecordSize()}}" selection-enabled multi-selection="{{config.tabular.settings.isMultiSelect}}"
						data-source="{{dataSource}}">
							<data-table-column  name="Actions"  hidden$="[[!_hasActions()]]">
								<template>
									<template  is="dom-repeat" items="[[_actions()]]"  as="col" index-as="colIndex" >
										<pebble-button class="actionButton" icon="[[_actionValue(colIndex)]]" on-tap="_fireActionEvent" item="[[item]]" index="[[colIndex]]"></pebble-button>
									</template>
								</template>
							</data-table-column>
						<template is="dom-repeat" items="[[config.tabular.columns]]" as="col" index-as="colIndex">
                            <template is="dom-if" if="[[_isCheckBox(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-checkbox checked$="{{_columnValue(item, column.columnIndex)}}"></paper-checkbox>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isTextArea(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-textarea value="{{_columnValue(item, column.columnIndex)}}"></paper-textarea>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isRadioButton(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-radio-button checked$="{{_columnValue(item, column.columnIndex)}}"></paper-radio-button>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_isTextBox(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>
										<paper-input value="{{_columnValue(item, column.columnIndex)}}"></paper-input>
									</template>
								</data-table-column>
							</template>
							<template is="dom-if" if="[[_hasNoEditType(col)]]">
								<data-table-column name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
									<template>[[_columnValue(item, column.columnIndex)]]</template>
								</data-table-column>
							</template>
						</template>
					</iron-data-table>
					</template>
						<template is="dom-if" if="{{_isNotEditable(config.mode)}}" >
							<iron-data-table page-size="{{pageSize}}" size="{{_getRecordSize()}}" selection-enabled multi-selection="{{config.tabular.settings.isMultiSelect}}"
											 data-source="{{dataSource}}">
							   <data-table-column  name="Actions" hidden$="[[!_hasActions()]]">
								   <template>
									 <template  is="dom-repeat" items="[[_actions()]]"  as="col" index-as="colIndex" >
									   <pebble-button class="actionButton" icon="[[_actionValue(colIndex)]]" on-tap="_fireActionEvent" item="[[item]]" index="[[colIndex]]"></pebble-button>
									 </template>
								   </template>
								</data-table-column>
								<template is="dom-repeat" items="[[config.tabular.columns]]" as="col" index-as="colIndex">
									<data-table-column  name="[[col.header]]" column-index="{{colIndex}}" filter-by$="[[_isFilterEnabled(col)]]" sort-by$="[[_isSortable(col)]]">
										<template>[[_columnValue(item, column.columnIndex)]]</template>
									</data-table-column>
								</template>
							</iron-data-table>
					</template>
				</template>
				<template is="dom-if" if="{{_isTileMode(config.viewMode)}}">
					<h1>Under Design</h1>
				</template>
				<template is="dom-if" if="{{_isListMode(config.viewMode)}}">
					<grid-list-view items = "{{data}}" multi-selection = "{{config.list.settings.isMultiSelect}}"
                		selected-item = "{{selectedItem}}" selected-items = "{{selectedItems}}" items-to-display= "{{config.list.itemsToDisplay}}"
						></grid-list-view>
				</template>
			</div>
		</template>
	</template>
	<script> 
      (function() {
            'use strict';
            
            Polymer( {
                is: 'pebble-grid', 
				/**
				* Fired when user clicks on a item to select it.
				*
				* @event grid-selecting-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be selected
				*/

				/**
				* Fired when user clicks on a item to deselect it.
				*
				* @event grid-deselecting-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be deselected
				*/

				/**
				* Fired when user clicks on the select all checkbox to select items.
				*
				* @event grid-selecting-all-items (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item containing current filters for items
				*/

				/**
				* Fired when user clicks on the select all checkbox to deselect items.
				*
				* @event grid-deselecting-all-items (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item containing current filters for items
				*/

				/**
				* Fired when user clicks on a item to expand it.
				*
				* @event grid-expanding-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be expanded
				*/

				/**
				* Fired when user clicks on a item to collapse it.
				*
				* @event grid-collapsing-item (pub-sub event)
				* @param {Object} detail
				* @param {Object} detail.item item to be collapsed
				*/
                properties: {
					/**
					 * Indicates a data which is wrapped in data-source that is used as a grid data.
					 * The format for the JSON object is given in above description.
					 */
					data: {
						type: Object,
						notify: true
					},

					/**
					 * Indicates a data-source, which is to grid.
					 * The format for the JSON object is given in above description.
					 */					
					dataSource: {
						notify: true,
						value: function() {
							return this._dataSource.bind(this);
						}
					},

					/**
					 * Indicates a total size of the data-source.
					 */	
					size: {
						notify: true,
						type: Number
					},

					/**
					 * Indicates the number of items fetched at a time from the datasource.
					 */
					pageSize: {
						type: Number,
						notify: true,
						value: 15
					},

					/**
					 * Indicates a config object, which decides the rendering behavior.
					 * The format for the JSON object is given in above description.
					 */	
					config: {
						type: Object,
						notify: true
					},

				    /**
					 * Indicates an attribute models to be used if schema type is "attribute".
				     */	
					attributeModels: {
						type: Object,
						notify: true,
						value: function() {
							return {};
						}
					},

					_currentPage:{
						notify: true,
						value: 0
					},

					_pageRange: {
						value: ""
					},

					_attributeModelMap: {
						type: Object
					},

					/**
					 * When multiSelection is true, this is an array that contains the selected items.
					 */
					 selectedItems : {
                         type : Array,
                         //value : [],
                         notify : true,
                         reflectToAttribute : true
                    },
					/**
					 * When multiSelection is false, this is the currently selected item, or null if no item is selected.
					 */
                     selectedItem : {
                         type : Object,
                         //value : {},
                         notify : true,
                         reflectToAttribute : true
                     }

                },

				observers: [
					'_calculatePageRange(_currentPage, pageSize, data)'
				],

				listeners: {
					'selecting-item': '_onSelectingItem',
					'deselecting-item': '_onDeselectingItem',
					'selecting-all-items': '_onSelectingAllItems',
					'deselecting-all-items':'_onDeselectingAllItems',
					'expanding-item':'_onExpandingItem',
					'collapsing-item':'_onCollapsingItem'
				},

				/**
				* Can be used to clear the cached pages and reload data from datasource when needed.
				*/
				clearCache: function() {
				    var ironDataTable = this._getIronDataTable();
					ironDataTable.clearCache();
				},

				/**
				* Can be used to clear the cache for a page and reload the data from datasource.
				*/
				refreshPage: function(page) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.refreshPage(page);
				},

				/*
				* Can be used to select all the items in the list.
				*/
				selectAll: function(){
					var ironDataTable = this._getIronDataTable();
					ironDataTable.selectAll();
				},

				/**
				* Can be used to clear the current selection state.
				*/
				clearSelection: function() {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.clearSelection();
				},

				/**
				* Can be used to select the list item at the given index.
				*
				* @method selectItem
				* @param {(Object|number)} item The item object or its index
				*/
				selectItem: function(item) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.selectItem(item);
				},

				/**
				* Can be used to deselect the given item list if it is already selected.
				*
				* @method deselect
				* @param {(Object|number)} item The item object or its index
				*/
				deselectItem: function(item){
					var ironDataTable = this._getIronDataTable();
					ironDataTable.deselectItem(item);
				},

				/**
				* Can be used to expand the row details for this item, if available.
				*/
				expandItem: function(item) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.expandItem(item);
				},

				/**
				* Can be used to collapse the row details for this item, if expanded.
				*/
				collapseItem: function(item) {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.collapseItem(item);
				},

				/**
				 * When `multiSelection` is true, the array contains the selected items.
				 * @return {Array<object>} The selectedItems is an array of object and other properties as below.
				 * If `selectedItems.inverted` is `true`, the array contains deselected items.
				 * `selectedItems.filters` contains an array of filters that are active when the selection changes.
				 */
				getSelectedItems: function(){
					var ironDataTable = this._getIronDataTable();
					return ironDataTable.selectedItems;
				},

				/**
				 * @return {object} The item object.
				 * It returns currently selected item. If no item is selected, then it returns `null`.
				 */
				getSelectedItem: function(){
					var ironDataTable = this._getIronDataTable();
					return ironDataTable.selectedItem;
				},

				//_computeCachedItems : function() {
				//	return this.data.slice(0, (this._currentPage * this.pageSize) + this.pageSize);
				//},

				_dataSource: function(opts, cb) {
                    this._currentPage = opts.page;
					if(this.config.schemaType == undefined || this.config.schemaType == "Simple"){
						var pagedData = this.data.slice(opts.page * opts.pageSize, (opts.page  * opts.pageSize) + opts.pageSize)
						cb(pagedData);
					}
					else {
						var data = this.data;
						var dataArray = Object.keys(data).map(function(key) { 
							if(data.hasOwnProperty(key)) {
								return data[key];
							}
						});
						
						var pagedData = dataArray.slice(opts.page * opts.pageSize, (opts.page  * opts.pageSize) + opts.pageSize)
						DataHelper.transformEntitySchemaForGrid(pagedData,  this.attributeModels);
						cb(pagedData);
					}
				 },

				_calculatePageRange: function(currentPage, pageSize, data){
					var totalSize = pageSize + currentPage * pageSize;
					if(totalSize > this._getRecordSize()) {
						totalSize = this._getRecordSize();
					}
					this._pageRange = "1 - " + totalSize + " / " + this._getRecordSize();
				},

                _columnValue: function(gridData, index) {
					var cellData;
					var columnName = this.config.tabular.columns[index].name;
					if(this.config.schemaType == undefined || this.config.schemaType == "simple") {
                    	cellData = gridData[columnName];
					}
					else if(this.config.schemaType == "attribute") {
					    for(var key in gridData.attributes) {
							if(gridData.attributes[key].hasOwnProperty(columnName)) {
								cellData = gridData.attributes[key][columnName].value;
								break;
							}
						}
					}
                    if(cellData != undefined) {
                       index++;
                    }
                    return cellData;
				},
				_isTabularMode: function(viewMode){
					return viewMode == 'Tabular';
				},
				_isTileMode: function(viewMode){
					return viewMode == 'Tile';
				},
				_isListMode: function(viewMode){
					return viewMode == 'List';
				},
				_isTextBox: function(col){
					if(this.config.schemaType == undefined || this.config.schemaType == "simple") {
                    	return col.editType == 'textbox';
					}
					else if(this.config.schemaType == "attribute") {
						var displayType = this._getAttributeModelMap(col.name).displayType;
						return  displayType == 'textbox';
					}
				},
				_isCheckBox: function(col){
					if(this.config.schemaType == undefined || this.config.schemaType == "simple") {
                    	return col.editType == 'checkbox';
					}
					else if(this.config.schemaType == "attribute") {
						var displayType = this._getAttributeModelMap(col.name).displayType;
						return displayType == 'boolean';
					}
					
				}, 
				_isTextArea: function(col){
					if(this.config.schemaType == undefined || this.config.schemaType == "simple") {
                    	return col.editType == 'textarea';
					}
					else if(this.config.schemaType == "attribute") {
						var displayType = this._getAttributeModelMap(col.name).displayType;
						return  displayType == 'textarea';
					}
					
				},
				_isRadioButton: function(col){
					if(this.config.schemaType == undefined || this.config.schemaType == "simple") {
                    	return col.editType == 'radio';
					}
					else if(this.config.schemaType == "attribute") {
						var displayType = this._getAttributeModelMap(col.name).displayType;
						return displayType == 'radio';
					}
					
				},
                _hasNoEditType: function (col) {
                    return col.editType == '';
                },
				_isNotEditable: function(mode){
					return mode == "Read";
				},
				_isFilterEnabled: function(col){
					return col.filterable ? col.name : undefined;
				},
				_isSortable: function(col){
					return col.sortable ? col.name : undefined;
				},

				_dataIsNotNull: function(data, config, attributeModels){
					var result = typeof(data) == "object" && typeof(config) == "object";
					if (result && config.schemaType == "attribute" && Object.keys(attributeModels).length == 0){
						result = false;
					}
				    return result;
				},

				_onRefresh: function(e) {
					this.clearCache(); 
				},

				_onDownload: function(e) {
					this.selectAll();
				},

				_onUpload: function(e) {
					this.clearSelection();
				},

				_getIronDataTable: function(){
					 return Polymer.dom(this.root).node.querySelector("iron-data-table")
				   || Polymer.dom(this).node.querySelector("iron-data-table");
				},

				_onSelectingItem: function(e){
					this.fire('bedrock-event', { name: "grid-selecting-item", data: e.detail });
				},

				_onDeselectingItem: function(e){
					this.fire('bedrock-event', { name: "grid-deselecting-item", data: e.detail });
				},

				_onSelectingAllItems: function(e){
					this.fire('bedrock-event', { name: "grid-selecting-all-items", data: e.detail });
				},

				_onDeselectingAllItems: function(e){
					this.fire('bedrock-event', { name: "grid-deselecting-all-items", data: e.detail });
				},

				_onExpandingItem: function(e){
					this.fire('bedrock-event', { name: "grid-expanding-item", data: e.detail });
				},

				_onCollapsingItem: function(e){
					this.fire('bedrock-event', { name: "grid-collapsing-item", data: e.detail} );
				},

				_getAttributeModelMap: function(name){
					if(this.attributeModels) {
						if(this._attributeModelMap == undefined){
							this._attributeModelMap = {};
							for(var key in this.attributeModels) {
								for(var attrKey in this.attributeModels[key]){
									if(attrKey != "name") {
										this._attributeModelMap[attrKey] = this.attributeModels[key][attrKey];
									}
								}
							}
						}
						return this._attributeModelMap[name];
					}
					return {};
				},

				_getRecordSize: function() {
					if(this.size > 0){
						return this.size;
					}
					if(this.data){
						if(this.config && this.config.schemaType == "attribute"){
							return Object.keys(this.data).length;
						}
						else {
							return this.data.length;
						}
				    }
					return 0;
				},
                _changeToEditMode: function () {
                    this.set('config.mode', "Edit");
				},
                _actionValue: function (index) {
					var action=this.config.tabular.settings.actions[index];
					var icon=action.icon;
					if(!icon){
                        if(action.name=='delete'){
                            return 'delete';
                        } else if(action.name=='edit'){
                           return 'pebble-icons:Icons/Edit'
                        } else {
                            return '';
						}
					}
					return icon;
                },
				_fireActionEvent: function (e) {
                    var action=this.config.tabular.settings.actions[e.target.index];
                    var eventName=action.eventName;
                    if(!eventName){
                        if(action.name=='delete'){
                            eventName="grid-delete-item";
						} else if(action.name=='edit'){
                            eventName="grid-edit-item";
						} else {
						    return;
						}
					}
					alert("fired " +eventName);
                    this.fire('bedrock-event', { name: eventName, data: e.target.item });
                },
                _hasActions: function () {
                    if(this.config.tabular.settings.actions && this.config.tabular.settings.actions.length>0){
                        return true;
                    }
                    return false;
                },
				_actions: function () {
                    return this.config.tabular.settings.actions;
                }

            });
        })();
    </script>
</dom-module>