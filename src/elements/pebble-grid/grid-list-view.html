<link rel="import" href="./grid-list-item.html">
<link rel="import" href="/bower_components/iron-list/iron-list.html">
<link rel="import" href="/bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">
<dom-module id="grid-list-view">
    <template>
        <style include="shared-styles">
            .loadingIndicator {
                text-align: center;
                height: 40px;
            }
            
            .loadingIndicator paper-spinner {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
            
            #scrollingRegion {
                top: 10vh;
                left: 25vh;
                right: 25vh;
                height: 100vh;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }
        </style>
        <div id="scrollingRegion">
            <iron-list id="list" items="{{cachedItems}}" as="item" scroll-target="html" multi-selection="{{multiSelection}}" 
                selected-item="{{selectedItem}}" selected-items = "{{selectedItems}}" selection-enabled>
                <template>
                    <grid-list-item item="{{item}}" index = "[[index]]"></grid-list-item>
                </template>
            </iron-list>
            <template is="dom-if" if="{{loading}}">
                <div class="loadingIndicator">
                    <paper-spinner active="{{loading}}"></paper-spinner>
                </div>
            </template>
            <!-- this element will load more data when the user scrolls down and reached the lower threshold -->
            <iron-scroll-threshold id="scrollTheshold" lower-threshold="500" on-lower-threshold="_loadMoreData" scroll-target="scrollingRegion">
            </iron-scroll-threshold>
        </div>
    </template>
    <script> 
      (function() {
            'use strict';
            
            Polymer( {
                is: 'grid-list-view', 
                 properties: {
                     cachedItems : {
                          type : Array,
                         value : [],
                     },
                     items : {
                         type : Array,
                         value : [],
                         observer : '_dataChanged'
                     },
                     currentPage : {
                         type: Number,
                         value : 0,
                         notify : true,
                         reflectToAttribute : true
                     },
                     pageSize : {
                         type : Number,
                         value : 10,
                         notify : true,
                         reflectToAttribute : true
                     },

                     loading : {
                         type : Boolean,
                         value : false
                     },

                     multiSelection : {
                         type : Boolean,
                         value:false,
                         notify : true,
                         reflectToAttribute : true
                     },

                     selectedItems : {
                         type : Array,
                         //value : [],
                         notify : true,
                         reflectToAttribute : true                 
                    },

                     selectedItem : {
                         type : Object,
                         //value : {},
                         notify : true,
                         reflectToAttribute : true
                     },

                     selectionEnabled : {
                         type : Boolean,
                         value:false,
                         notify : true,
                         reflectToAttribute : true 
                     }
                 },

                 observers: [
                    '_selectedItemsChanged(selectedItems.splices)'
                ],

                 _loadMoreData : function() {
                    if(this.items && this.items.length > 0) { 
                        this.loading=true;
                        var newItems = this.items.slice(this.currentPage*this.pageSize,(this.currentPage*this.pageSize)+ this.pageSize);
                        var that = this;
                        newItems.forEach(function(product) {
                            that.push('cachedItems',product);
                        });
                    
                        this.currentPage+=1;
                        this.$.scrollTheshold.clearTriggers();
                        this.loading=false;
                    }
                 },

                 _dataChanged : function() {
                    this.loading=true;
                    this.currentPage = 0;
                    this.cachedItems = [];
                    if(this.items && this.items.length > 0 && this.currentPage && this.pageSize) { 
                        var newItems = this.items.slice(this.currentPage*this.pageSize,(this.currentPage*this.pageSize)+ this.pageSize);
                        var that = this;
                        newItems.forEach(function(product) {
                            that.push('cachedItems',product);
                        });
                        this.currentPage+=1;
                    }
                    this.$.scrollTheshold.clearTriggers();
                    this.loading=false;
                 },

                 _selectedItemsChanged : function() {
                     console.log(this.selectedItems)
                 }
            });
        })();
    </script>
</dom-module>