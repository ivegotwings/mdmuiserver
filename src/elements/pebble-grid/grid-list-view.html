<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="check-box-with-indeterminate-state.html">

<!--
`grid-list-view` Represents an element that displays the items in the grid-list-view.

@demo demo/index.html
-->

<dom-module id="grid-list-view">
    <template>
        <style include="pebble-styles-shared">
            .loadingIndicator {
                text-align: center;
                height: 40px;
            }
            
            .loadingIndicator paper-spinner {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
            
            #scrollingRegion {
                top: 10vh;
                left: 25vh;
                right: 25vh;
                height: 100vh;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            .left {
                width : 3%;
                text-align: center;
            }

            .button-container {
                position:relative;
                top:50%;
                left:20%;
                float: left;
                margin-top: -7px;
            }

            .container {
                width: 100%;
                /*height: 20%;*/
                display: inline-flex;
                box-sizing: border-box;
                border-bottom: 1px solid var(--palette-cloudy-blue);
                padding: var(--list-padding,7px);
            }

            #image-container {
                width: var(--default-thumb-size,80px);
                background: #ddd;
                margin-top: var(--gutter-width);
                margin-bottom:var(--gutter-width);
                margin-right:1%;
                border-radius:var(--default-border-radius);
            }

            .trim {
                display: block;
                width: 100%;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space:nowrap;
            }

            .default {
                margin-right : 5%;
                width : 95%;
            }

            .title {
                font-size:18px;
                font-weight: 500;
            }

            .actions {
                margin-left : 2%;
                /*margin-top: -7px;*/
            }

            .top {
                display: inline-flex;
                width : 100%;
                height: 40px;
                text-align: center;
                box-sizing: border-box;
                border-bottom: 1px solid var(--palette-cloudy-blue);
                padding: var(--list-padding,7px);
            }

            .header-button-container {
                position:relative;
                /*top:50%;*/
                left:0.6%;
                float: left;
                margin-top: -15px;
            }

            paper-checkbox::shadow #checkboxContainer{
                height:var(--paper-checkbox-size, var(--default-checkbox-size));
                width:var(--paper-checkbox-size, var(--default-checkbox-size));
                min-width: var(--paper-checkbox-size, var(--default-checkbox-size));
            }
            paper-checkbox::shadow #checkbox{
                border: solid 1px;
                border-color: var(--paper-checkbox-unchecked-color, var(--palette-cloudy-blue));
                border-radius: var(--default-border-radius);
                height:var(--paper-checkbox-size, var(--default-checkbox-size));
                width:var(--paper-checkbox-size, var(--default-checkbox-size));
            }
            paper-checkbox[checked]::shadow #checkbox {
                background-color: var(--paper-checkbox-checked-color, var(--palette-cerulean-two));
                border-color: var(--paper-checkbox-checked-color, var(--palette-white));
            }
            paper-checkbox[checked]::shadow #checkmark{
                width: 20%;
                height: 50%;
                -webkit-transform-origin: 60% 110%;
                transform-origin: 60% 110%;
            }
        </style>
        <div class="top">
            <check-box-with-indeterminate-state header class="header-button-container" on-tap="_toggleSelectAll" checked="[[_isSelectAllChecked(selectedItems.length, selectedItems.inverted, cachedItems.length)]]" indeterminate="[[_isSelectAllIndeterminate(selectedItems.length, cachedItems.length)]]"></check-box-with-indeterminate-state>
            <span class="actions">Actions</span>
        </div>
        <div id="scrollingRegion">
            <iron-list id="list" items="{{cachedItems}}" as="item" scroll-target="html" selection-enabled>
                <template>
                    <!--<grid-list-item item="{{item}}" index = "[[index]]" list-items="{{listItems}}"></grid-list-item>-->
                    <div class="container" on-tap="_tapEvent">
                        <div class = "left">
                            <paper-checkbox class = "button-container" checked="[[_isSelected(item, selectedItems, selectedItems.*)]]"></paper-checkbox>
                            <!--<paper-radio-button class = "button-container" checked$></paper-radio-button>-->
                        </div>
                        <!--<div >-->
                        <pebble-image-viewer alt="Product image." id = "image-container" sizing="contain" src="{{_computeImage(item,listItems.image)}}"></pebble-image-viewer>
                        <!--</div>-->
                        <div class = "col-35">
                            <div class = "block-text">
                                [[_computeTitle(item,listItems.title)]]
                            </div>
                            <div class="list-content">#[[_computeId(item,listItems.id)]]</div>
                            <template is="dom-if" if="{{_areFieldsGreaterThan4(listItems.fields)}}">
                                <br />
                            </template>

                            <template is="dom-repeat" items="{{_firstColFields}}" as="field">
                                <div class="list-content"><span class$ = "{{_computeClass(field.noTrim)}}">{{_getDisplayName(field.label,field.name)}}: <span class="block-text">&nbsp[[_computeValue(item,field.name)]]</span></span></div>
                            </template>
                        </div>
                        <div class = "col-25">
                            <template is="dom-repeat" items="{{secColFields}}" as="field">
                                <div class="list-content"><span class$ = "{{_computeClass(field.noTrim)}}">{{_getDisplayName(field.label,field.name)}}: <span class="block-text">&nbsp[[_computeValue(item,field.name)]]</span></span></div>
                            </template>
                        </div>
                        <div class = "col-25">
                            <template is="dom-repeat" items="{{thirdColFields}}" as="field">
                                <div class="list-content"><span class$ = "{{_computeClass(field.noTrim)}}">{{_getDisplayName(field.label,field.name)}}: <span class="block-text">&nbsp[[_computeValue(item,field.name)]]</span></span></div>
                            </template>
                        </div>
                        <div class = "right">
                            <paper-icon-button class="dropdown-trigger" name="more" icon="icons:more-vert" title="More options"></paper-icon-button>
                        </div>
                    </div>
                </template>
            </iron-list>
            <template is="dom-if" if="{{loading}}">
                <div class="loadingIndicator">
                    <paper-spinner active="{{loading}}"></paper-spinner>
                </div>
            </template>
            <!-- this element will load more data when the user scrolls down and reached the lower threshold -->
            <iron-scroll-threshold id="scrollTheshold" lower-threshold="500" on-lower-threshold="_loadMoreData" scroll-target="scrollingRegion">
            </iron-scroll-threshold>
        </div>
    </template>
    <script> 
      (function() {
            'use strict';
            
            Polymer( {
                is: 'grid-list-view', 
                 properties: {

                     /**
                      * Indicates the cached items in the list view. It grows in size as you 
                      * scroll in the grid-list-view. 
                      */
                     cachedItems : {
                          type : Array,
                          notify:true,
                          reflectToAttribute:true,
                          value :[]
                        },

                     /**
                      * Indicates an array of items that needs the display in the grid-list-view.
                      */   
                     items : {
                         type : Array,
                         value : [],
                          notify:true,
                          reflectToAttribute:true
                         //observer : '_dataChanged'
                     },

                     /**
                      * Indicates the current page in the grid-list-view.
                      */
                     currentPage : {
                         type: Number,
                         value : 0,
                         notify : true,
                         reflectToAttribute : true
                     },

                     /**
                      * Indicates the page size in the grid-list-view.
                      */
                     pageSize : {
                         type : Number,
                         value : 15,
                         notify : true,
                         reflectToAttribute : true
                     },

                     /**
                      * Specifies whether or not to load the data. Set it to <b>true</b> to load the data
                      * Otherwise, set it to <b>false</b>.
                      */
                     loading : {
                         type : Boolean,
                         value : false
                     },

                     /**
                      * Specifies whether or not multiple items can be selected at once. When it is <b>true</b>, multiple items are selected at once
                      * Otherwise, only one item is selected at a time.
                      */
                     multiSelection : {
                         type : Boolean,
                         value:false,
                         notify : true,
                         reflectToAttribute : true
                     },

                     /**
					 * Specifies whether or not it conatins the selected items. When it is <b>true</b>, this array contains the selected items. 
                     * However, if `selectedItems.inverted` is <b>true</b>, the array contains deselected items.
					 */
                     selectedItems : {
                         type : Array,
                         value : [],
                         notify : true,
                         reflectToAttribute : true                 
                    },

                    /**
					 * Indicates the currently selected item if the `multiSelection` is set to <b>false</b>. 
                     * It is set to null, if no items are selected.
					 */
                     selectedItem : {
                         type : Object,
                         //value : {},
                         notify : true,
                         reflectToAttribute : true
                     },

                     /**
                      * Specifies whether or not the tapping a row selects the item and places its data model in the set of selected items which is retrievable via the selection property.
                      */ 
                     selectionEnabled : {
                         type : Boolean,
                         value:false,
                         notify : true,
                         reflectToAttribute : true 
                     },

                     /**
                      * Indicates the config of grid-list-view.
                      */
                     listItems : {
                         type:Object,
                         observer : '_splitIntoCols'
                     },

                     /**
                      * This is an internal property, represents fields to be displayed in first column of grid-list-view.
                      */
                     _firstColFields : {
                         type:Array,
                         value :[]
                     },
                     /**
                      * This is an internal property, represents fields to be displayed in second column of grid-list-view.
                      */
                     secColFields : {
                         type:Array,
                         value :[]
                     },

                     /**
                      * This is an internal property, represents fields to be displayed in third column of grid-list-view.
                      */
                     thirdColFields : {
                         type : Array,
                         value :[]
                     }
                 },

                 observers: [
                    //'_selectedItemsChanged(selectedItems.splices)'
                ],

                 _loadMoreData : function() {
                      this.loading=true;
                     if(this.items && this.items.length > 0) { 
                        var newItems = this.items.slice(this.currentPage*this.pageSize,(this.currentPage*this.pageSize)+ this.pageSize);
                        var that = this;
                        newItems.forEach(function(product) {
                            that.push('cachedItems',product);
                        });
                    
                        this.currentPage+=1;
                    }
                     this.$.scrollTheshold.clearTriggers();
                    this.loading=false;
                 },

                 /*
                 _dataChanged : function() {
                    this.loading=true;
                    this.currentPage = 0;
                    this.cachedItems = [];
                    if(this.items && this.items.length > 0 && this.currentPage && this.pageSize) { 
                        var newItems = this.items.slice(this.currentPage*this.pageSize,(this.currentPage*this.pageSize)+ this.pageSize);
                        var that = this;
                        newItems.forEach(function(product) {
                            that.push('cachedItems',product);
                        });
                        this.currentPage+=1;
                    }
                    this.$.scrollTheshold.clearTriggers();
                    this.loading=false;
                 },

                 _selectedItemsChanged : function() {
                     console.log(this.selectedItems)
                 }  */

                /**
                 * This is an internal function, used to split the fields into three columns.
                 */
                _splitIntoCols : function() {
                    if(this.listItems && this.listItems.fields && this.listItems.fields.length > 0) {
                        var totalFields = this.listItems.fields.length;
                        var n = totalFields/3+1;
                        if(totalFields < 3) {
                            this.secColFields = this.listItems.fields.slice(0,1);
                            this.thirdColFields = this.listItems.fields.slice(1,totalFields);
                        } else if (totalFields == 3) {
                            this.secColFields = this.listItems.fields.slice(0,2);
                            this.thirdColFields = this.listItems.fields.slice(2,totalFields);
                        } else {
                            if(totalFields % 3 == 0) {
                                this._firstColFields = this.listItems.fields.slice(0,n-3);
                                this.secColFields = this.listItems.fields.slice(n-3,2*n-3);
                                this.thirdColFields = this.listItems.fields.slice(2*n-3,totalFields);
                            } else {
                                this._firstColFields = this.listItems.fields.slice(0,n-2);
                                this.secColFields = this.listItems.fields.slice(n-2,2*n-2);
                                this.thirdColFields = this.listItems.fields.slice(2*n-2,totalFields);
                            }
                        }
                    }
                },

                /**
                 * This is an internal function, used to calculate the display name of an attribute.
                 */
                _getDisplayName: function(label,name) {
                    if(label) {
                        return label;
                    }
                    return name;
                },

                /**
                 * This is an internal function, used to calculate the class to apply trim or not.
                 */
                _computeClass: function(noTrim) {
                    if(noTrim) {
                        return 'default';
                    }
                    return 'default trim';
                },

                /**
                 * This is an internal function, returns true if number of fields to display is greater than 4.
                 */
                _areFieldsGreaterThan4: function(fields) {
                    if(fields && fields.length > 4) {
                        return true;
                    }
                    return false;
                },

                /**
                 * This is an internal function to handle the tap event. It fires event 'deselecting-item' if an item was already selected.
                 *  It fires event 'selecting-item' if an item was not selected. The data of the event fired is the data of the item.
                 */
                _tapEvent : function(e) {
                    if (this._isSelected(e.model.item, this.selectedItems)) {
                        this._fireEvent('deselecting-item', e.model.item, this.deselectItem);
                    } else {
                        this._fireEvent('selecting-item', e.model.item, this.selectItem);
                    }
                },

                /**
                 * This is an internal function, used to compute the image url based on the config.
                 */
                _computeImage : function(item,image) {
                    return item[image];
                },

                /**
                 * This is an internal function, used to compute the title based on the config.
                 */
                _computeTitle : function(item,title) {
                    return item[title];
                },
                /**
                 * This is an internal function, used to compute the id based on the config.
                 */
                _computeId : function(item,id) {
                    return item[id];
                },

                /**
                 * This is an internal function, used to compute the value of the attribute to be displayed.
                 */
                _computeValue : function(item,field) {
                    return item[field];
                },


                _setSelectedItem : function(item) {
                    this.set('selectedItem',item);
                },

                _setSelectedItems :function(items) {
                    this.set('selectedItems',items);
                },

                /**
                 * Select the list item at the given index.
                 *
                 * @method selectItem
                 * @param {(Object|number)} item The item object or its index
                 */
                selectItem: function(item) {
                    if (typeof item === 'number' && item >= 0 && this.items && this.items.length > item) {
                        this._selectItem(this.items[item]);
                    } else {
                        this._selectItem(item);
                    }
                },
                _selectItem: function(item) {
                    this._setSelectedItem(item);
                    if (this.multiSelection) {
                        if (this.selectedItems.inverted) {
                            var index;
                            if ((index = this.selectedItems.indexOf(item)) > -1) {
                                this.splice('selectedItems', index, 1);
                            }
                        } else {
                            this.push('selectedItems', item);
                        }
                    } else {
                        this.splice('selectedItems', 0, this.selectedItems.length, item);
                    }
                },
                /**
                 * Deselects the given item list if it is already selected.
                 *
                 * @method deselect
                 * @param {(Object|number)} item The item object or its index
                 */
                deselectItem: function(item) {
                    if (typeof item === 'number' && item >= 0 && this.items && this.items.length > item) {
                        this._deselectItem(this.items[item]);
                    } else {
                        this._deselectItem(item);
                    }
                },
                _deselectItem: function(item) {
                    this._setSelectedItem(null);
                    var index = this.selectedItems.indexOf(item);
                    if (this.selectedItems.inverted) {
                        if (index === -1) {
                            this.push('selectedItems', item);
                        }
                    } else {
                        if (index > -1) {
                            this.splice('selectedItems', index, 1);
                        }
                    }
                },
                _isSelected: function(item, selectedItems) {
                    var selected = selectedItems.indexOf(item) > -1;
                    return selectedItems.inverted ? !selected : selected;
                },
                /*
                 * Can be used to select all the items in the list.
                 */
                selectAll: function() {
                    var length = this.selectedItems.length;
                    this.splice('selectedItems',0,length);
                    this.set('selectedItems.inverted',true);
                },
                /**
                 * Can be used to clear the current selection state.
                 */
                clearSelection: function() {
                    var length = this.selectedItems.length;
                    this.splice('selectedItems',0,length);
                    this.set('selectedItems.inverted',false);
                    if (this.selectedItem !== undefined) {
                        this._setSelectedItem(null);
                    }
                },

                _fireEvent: function(eventName, item, defaultAction) {
                    var e = this.fire(eventName, {item: item}, {cancelable: true});
                    if (!e.defaultPrevented) {
                        defaultAction.call(this, item);
                    }
                },

                _toggleSelectAll: function() {
                    if (this._isSelectAllChecked(this.selectedItems.length, this.selectedItems.inverted, this.cachedItems.length)) {
                        this._fireEvent("deselecting-all-items", {items: this.selectedItems}, this.clearSelection);
                    } else {
                        this._fireEvent("selecting-all-items", {items: this.selectedItems}, this.selectAll);
                    }
                },
                _isSelectAllChecked: function(selectedItemsLength, inverted, size) {
                    return size > 0 && selectedItemsLength === (inverted ? 0 : size);
                },
                _isSelectAllIndeterminate: function(length, size) {
                    return size > 0 && length > 0 && length < size;
                }
            });
        })();
    </script>
</dom-module>