<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">

<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-widget-panel/rock-widget-panel.html">
<link rel="import" href="../rock-footer/rock-footer.html">
<dom-module id="app-dashboard">
    <template>
        <style>
            pebble-icon::shadow iron-icon {
                margin-right: 10px;
                width: 16px;
                height: 16px;
                color: var(--sub-header-icon-color);
            }
            
            pebble-button::shadow paper-button {
                min-width: 0px;
                color: var(--sub-header-icon-color);
                padding: 5px;
                width: 26px;
            }
            
            rock-layout {
                --rock-footer-background-color: #f5f7f9;
            }
            
            rock-widget-panel::shadow #widget-panel {
                overflow-y: auto;
                min-height: calc(var(--rock-widget-panel-height) + 55px);
            }
        </style>
        <rock-layout>
            <liquid-config-aggregate-get id="getDashboardAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-dashboard"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
            <rock-titlebar icon="pebble-md-icons:UserIcon" class="pebble-md-icons" main-title="User Dashboard">
            </rock-titlebar>
            <rock-widget-panel config="[[getConfig('rock-widget-panel')]]"></rock-widget-panel>
        </rock-layout>
        <bedrock-pubsub event-name="actions-parent-button-tap" handler="_onSavedSearchTap" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="favourite-saved-search" handler="_markSavedSearchAsFavourite" target-id=""></bedrock-pubsub>
        <bedrock-pubsub event-name="delete-saved-search" handler="_markSavedSearchAsDelete" target-id=""></bedrock-pubsub>
        <bedrock-pubsub on-bedrock-event-rock-my-todo-click="_onTapSummaryViewItem"></bedrock-pubsub>
        <bedrock-pubsub on-bedrock-event-rock-my-todo-product-click="_onTapDetailViewItem"></bedrock-pubsub>
        <bedrock-pubsub on-bedrock-event-rock-my-todo-view-all="_onTapDetailViewAll"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-dashboard',
                created: function () {
                    this.contentHeightVariable = "--rock-widget-panel-height";
                },
                attached: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
                },
                properties: {
                },
                behaviors: [
                    RUFBehaviors.AppBehavior
                ],
                listeners:{
                    "refresh-data":"_reloadWidgets"
                },
                _onApplicationConfigReceived: function (e) {
                    //console.log('Received configs ', JSON.stringify(e, null, 2));
                    this.set('applicationConfig', e.detail);
                },
                _markSavedSearchAsFavourite: function (e, detail, sender) {
                    if (detail) {
                        // detail object has info of the favorite action button, its parent button and tab info.
                    }
                },
                _markSavedSearchAsDelete: function (e, detail, sender) {
                    if (detail) {
                        // detail object has info of the delete action button, its parent button and tab info.
                    }
                },
                _onSavedSearchTap: function (e, detail, sender) {
                    if (detail) {
                        if (detail.id) {
                            ComponentHelper.appRoute("entity-discovery", { "_savedSearchId": encodeURIComponent(detail.id) });
                        } else {
                            ComponentHelper.appRoute("entity-discovery", detail);
                        }
                    }
                },
                _onTapSummaryViewItem: function (e, detail, sender) {
                    ComponentHelper.appRoute("entity-discovery", detail);
                },
                _onTapDetailViewItem: function (e, detail, sender) {
                    ComponentHelper.appRoute("entity-discovery", { "mytodoid": e.detail.id.toString() });
                },
                _onTapDetailViewAll: function (e, detail, sender) {
                    ComponentHelper.appRoute("entity-discovery");                    
                },
                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;
                    component.properties["context-data"] = this.contextData;
                },
                _reloadWidgets:function () {
                    var widgetPanel=this.$$("rock-widget-panel");
                    if(widgetPanel) {
                        widgetPanel.reloadWidgets();
                    }
                }
            });
        })();
    </script>
</dom-module>