<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">


<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid-data-sources/entity-search-grid-datasource.html">
<link rel="import" href="../rock-govern-data-grid/rock-govern-data-grid.html">
<link rel="import" href="../rock-entity-relationship-search-result-actions/rock-entity-relationship-search-result-actions.html">
<link rel="import" href="../rock-business-actions/rock-business-actions.html" />

<!--

  `rock-relationship-grid` Represents an association relationship grid for an entity.
The following JSON objects depicts the entity that loads the relationship grid.
Based on the configuration, relationship grid gets loaded with the defined attributes from the given data object.

```json
{
  "crossSell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icon:action-delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icon:action-delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}
```
The following JSON object is a sample of data which binds the grid.
```json
{
  "id": "e2",
  "type": "product",
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "contexts": [
      {
        "context": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crossSell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relTo": {
                "id": "e5",
                "type": "product"
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relTo": {
                "id": "e6",
                "type": "product"
              }
            }
          ]
        }
      }
    ]
  }
}
```
@demo demo/index.html
-->
<dom-module id="rock-where-used-grid">
  <template>

    <style include="bedrock-style-common"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      pebble-button.icon-text-button {
        --pebble-button: {
          height: 30px;
          padding-top: 0.5em;
          padding-right: 0em;
          padding-bottom: 0.5em;
          padding-left: 0em;
          border: 1px solid var(--primary-color);
        }
      }

      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: var(--tooltip-bg-color, rgba(25, 32, 39, 1));
      }

      pebble-lov {
        width: 300px !important;
        max-height: 350px !important;
      }

      #errorsDialog {
        --popup-header-color: var(--palette-pinkish-red, #ee204c);
      }

      #messageCard {
        text-align: center;
      }

      pebble-toggle-button {
        --pebble-toggle-button-checked-bar-color: var(--success-color, #4caf50);
        --pebble-toggle-button-checked-button-color: var(--success-color, #4caf50);
        --pebble-toggle-button-checked-ink-color: var(--success-color, #4caf50);
        --pebble-toggle-button-label-color: var(--secondary-button-text-color, #75808b);
      }

      .toggle-button {
        float: right;
        padding: 20px 20px 0px 0px;
        font-size: var(--font-size-sm, 12px);
        @apply --rock-where-used-grid-govern-toggle;
      }

      .govern-grid-actions {
        float: right;
        margin: 15px 10px 0px 0px;
      }

      .refresh {
        color: var(--icon-color, #757575);
        width: 14px;
        height: 14px;
        padding: 0px;
        float: right;
        margin: 22px 10px 0px 0px;
        cursor: pointer;
      }
      .header-button{
        display: flex;
        justify-content: flex-end;
      }
    </style>
    <pebble-spinner active="[[_loading]]"></pebble-spinner>
    <template is="dom-if" if="[[!_isMessageAvailable]]">
      <div id="relContainer_[[relationship]]" class="full-height">
        <pebble-accordion header-text="[[_getRelationshipTypeTitle(relationship)]]"  
           >
          <!--<div class="relation-name-container">
              <pebble-button icon="pebble-icon:action-add" id="[[relationship]]" class="btn btn-primary m-r-20" button-text="Add" on-click="_onAddPopoverClick"></pebble-button>              
              <pebble-popover for$="[[relationship]]" vertical-align="auto" horizontal-align="auto" no-overlap>
                <rock-entity-lov id="[[relationship]]" request-data="[[_requestForAddRelationshipList(relationship)]]" id-field="[[_getIdField(relationship)]]"
                  title-pattern="[[_getTitlePattern(relationship)]]" multi-select no-sub-title show-action-buttons></rock-entity-lov>
              </pebble-popover>
              <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLovConfirmButtonTapped" target-id="[[relationship]]"></bedrock-pubsub>
              <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLovCloseButtonTapped" target-id="[[relationship]]"></bedrock-pubsub>
            </div> -->
          <span slot="header-actions">
            <template is="dom-if" if="[[relationshipGridConfig.gridConfig]]">
              <pebble-info-icon description-object="[[relationshipGridConfig.gridConfig]]"></pebble-info-icon>
            </template>
          </span>
          <div slot="accordion-content" class="relative full-height">
              <div class="base-grid-structure">
                <div class="base-grid-structure-child-1">
                  <div class="header-button">
                    <template is="dom-if" if="[[relationshipGridConfig.copyActionConfig]]">
                      <div>
                        <pebble-button class="btn btn-primary m-r-10 tooltip-bottom" id="copy_btn" data-tooltip$="[[_clipboardTooltip]]" button-text="Copy ID(s)"
                          on-tap="_onTapCopyAction" on-mouseout="_onMouseoutCopyAction"></pebble-button>
                      </div>
                    </template>
                    <pebble-button icon="pebble-icon:action-add" disabled="[[readonly]]" id="button_[[relationship]]" relationship="[[relationship]]"
                    class="btn btn-primary m-r-10 auto-width addbutton" button-text="Add" on-tap="_onAddRelClick"></pebble-button>
                    <pebble-popover for$="button_[[relationship]]" vertical-align="auto" horizontal-align="auto" no-overlap>
                        <rock-entity-lov on-lov-confirm-button-tap="_onLovConfirmButtonTapped" id="lov_[[relationship]]" data-index$="[[dataIndex]]"
                          data-sub-index$="[[dataSubIndex]]" request-data="[[_requestForAddRelationshipList(relationship)]]"
                          id-field="[[_getIdField()]]" image-id-field="[[_getImageIdField()]]" title-pattern="[[_getTitlePattern()]]"
                          selected-items="[[_getSavedRelationshipItems( relationship, _savedRelationshipItemsToLov)]]" excluded-ids=[[excludedIds]]
                          multi-select no-sub-title show-action-buttons></rock-entity-lov>
                      </pebble-popover>

                    <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLovConfirmButtonTapped" target-id="lov_[[relationship]]"></bedrock-pubsub>
                    <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLovCloseButtonTapped" target-id="lov_[[relationship]]"></bedrock-pubsub>
                    <!-- <pebble-button icon="pebble-icon:action-add" disabled="[[readonly]]" id="button_[[relationship]]" relationship="[[relationship]]"
                    class="btn btn-primary m-r-10 auto-width addbutton" button-text="Add" on-tap="_onAddRelClick"></pebble-button> -->
                    <template is="dom-if" if="[[relationshipGridConfig.gridConfig.hasWritePermission]]">
                      <template is="dom-if" if="[[relationshipGridConfig.addNewRelationConfig]]">
                        <div>
                          <pebble-button icon="pebble-icon:action-add" disabled="[[readonly]]" id="addnewbutton_[[relationship]]" relationship="[[relationship]]"
                            class="btn btn-primary m-r-10 auto-width addbutton" button-text="Add New" on-tap="_onAddNewRelClick"></pebble-button>
                        </div>
                        <bedrock-pubsub event-name="entity-created" handler="_onEntityCreated"></bedrock-pubsub>
                      </template>
                    </template>
                    <template is="dom-if" if="[[_showToggle(relationshipGridConfig.governGridConfig)]]">
                      <pebble-toggle-button class="toggle-button" noink checked="{{_loadGovernData}}">Govern Data</pebble-toggle-button>
                      <template is="dom-if" if="[[_loadActions(_loadGovernData, relationshipGridConfig.governGridConfig)]]">
                        <pebble-icon icon="pebble-icon:refresh" class="refresh pebble-icon-size-16" on-tap="_governGridRefresh"></pebble-icon>
                        <rock-business-actions id="businessActions" context-data="[[contextData]]" button-text="[[relationshipGridConfig.governGridConfig.actionsTitle]]"
                          button-icon="[[relationshipGridConfig.governGridConfig.actionsIcon]]" show-workflow-actions></rock-business-actions>
                        <bedrock-pubsub event-name="business-actions-action-click" handler="_onGovernGridActionTap" target-id="businessActions"></bedrock-pubsub>
                      </template>
                    </template>
                  </div>
                </div>
                <div class="base-grid-structure-child-2">
                    <div class$="grid-wrap-container full-height [[_applyClass(_quickManageEnabled)]]">
                      <div class="container col-8-4-grid-child-1 full-height">
                  <entity-search-grid-datasource id="datasource_[[relationship]]" request="[[_getRelationshipGridRequest(relationship)]]" r-data-source="{{rDataSource}}"
                          r-data-formatter="{{rDataFormatter}}" buffer-record-size="{{size}}" current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}"
                          total-count="{{totalCount}}" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" attribute-models="[[_getRelationshipAttributeModels(relationship)]]"></entity-search-grid-datasource>
                    <div class="button-siblings full-width">
                      <rock-grid hidden$="[[_loadGovernData]]" readonly="[[readonly]]" id$="[[relationship]]" r-data-source="{{rDataSource}}" r-data-source-id="datasource_[[relationship]]"
                            config="{{relationshipGridConfig.gridConfig}}" attribute-models="[[_getRelationshipAttributeModels(relationship)]]"
                            grid-data-size="{{size}}" current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}"
                            max-configured-count="[[maxConfiguredCount]]" total-count="{{totalCount}}" page-size="20">
                            <rock-entity-relationship-search-result-actions slot="toolbar" id="gridActions" context-data="[[contextData]]" has-write-permissions="[[_hasWritePermissions(relationshipGridConfig.gridConfig)]]"
                              relationship="[[relationship]]" direction=[[relationshipGridConfig.direction]]></rock-entity-relationship-search-result-actions>
                      </rock-grid>
                    </div>
                    <div id="buttonContainer" align="center" hidden class="buttonContainer-static">
                      <pebble-button id="cancel" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_revertAll" elevation=1 raised></pebble-button>
                      <pebble-button id="save" class="btn btn-success" button-text="Save" on-tap="_save" elevation=1 raised></pebble-button>
                    </div>
                  <bedrock-pubsub event-name="grid-bulk-relationship-edit-items" handler="_onBulkRelationshipEdit" target-id="[[relationship]]"></bedrock-pubsub>
                  <bedrock-pubsub event-name="grid-bulk-edit-items" handler="_onBulkEdit" target-id="[[relationship]]"></bedrock-pubsub>
                  <template is="dom-if" if="[[_loadGovernData]]">
                    <rock-govern-data-grid id$="[[relationship]]" context-data="[[contextData]]" request="[[_getRelationshipGridRequest(relationship)]]"
                      entity-name-attribute="[[relationshipGridConfig.governGridConfig.entityNameAttribute]]"></rock-govern-data-grid>
                  </template>
                </div>
                      
                        <template is="dom-if" if="[[_quickManageEnabled]]">
                
                          <div class="quick-manage-container col-8-4-grid-child-2">
                            <div class="divider-wrapper">
                              <pebble-vertical-divider></pebble-vertical-divider>
              </div>
                            <rock-entity-quick-manage id="entityQuickManage" readonly="[[readonly]]" data-object-type="relationship" no-header context-data="[[contextData]]"
                              current-index="{{_currentIndex}}" current-record-size="[[currentRecordSize]]" selected-entity="[[_selectedEntity]]"
                              relationship="[[relationship]]"></rock-entity-quick-manage>
                            <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                            <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                            <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                          </div>
                        </template>
                
                    </div>
                </div>
                <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="[[relationship]]"></bedrock-pubsub>
                <bedrock-pubsub event-name="delete-item" handler="_onDeleteEntityRelationshipAction" target-id="[[relationship]]"></bedrock-pubsub>
            <!-- <bedrock-pubsub target-id="[[relationship]]" event-name="on-grid-msg-dialog-ok" handler="_onDialogOk"></bedrock-pubsub> -->
            <bedrock-pubsub event-name="grid-download-item" handler="_onDownload" target-id="[[relationship]]"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-upload-item" handler="_onUpload" target-id="[[relationship]]"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-custom-toolbar-event" handler="_onCustomToolbarEvent" target-id="[[relationship]]"></bedrock-pubsub>
            
          </div>
        </pebble-accordion>
      </div>
      <liquid-entity-data-get id="entityGetData" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" name="entityGet"
        operation="getbyids" request-data="{{_entityGetRequest}}" last-response="{{entitiesResponse}}"></liquid-entity-data-get>
      <liquid-entity-data-get id="entityGetAddData" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" name="entityGet"
        operation="getbyids" request-data="{{_entityGetAddRequest}}" last-response="{{relEntitiesResponse}}"></liquid-entity-data-get>
        <liquid-entity-data-save name="entitySaveService" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}" on-response="_onSaveResponse"
        on-error="_onSaveError">
        <liquid-entity-data-save id="entityRelationsDeleteService" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]"
        on-response="_onRelationsDeleteResponse" on-error="_onRelationsSaveError">
      <liquid-entity-data-save name="attributeSaveDataService" data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" operation="update"
        request-data="{{_saveRequest}}" last-response="{{_saveResponse}}" on-response="_onSaveResponse"></liquid-entity-data-save>
      <!--<pebble-dialog id="errorsDialog" dialog-title="Errors on page" alert-box>
        <p>Found below errors in entity details: </p>
        <template is="dom-repeat" items="[[_errorMessages]]" as="error">
          <p>In entity: [[error.fromEntity]]: </p>
          <ul>
            <template is="dom-repeat" items="[[_getAttrMessages(error)]]">
              <li>[[item.attributeName]] with error: [[item.message]]</li>
            </template>
          </ul>
        </template>
        <p>Do you want to fix the errors or continue?</p>
        <div class="buttons">
          <pebble-button dialog-confirm class="btn btn-success" button-text="Fix"></pebble-button>
          <pebble-button dialog-confirm class="btn btn-secondary" on-tap="_skipErrors" button-text="Skip & Continue"></pebble-button>
        </div>
      </pebble-dialog>-->
     
    </template>
    <pebble-dialog id="gridMsgDialog" dialog-title="Confirmation" show-ok show-cancel show-close-icon alert-box modal>
        <p id="msgDialog"></p>
      </pebble-dialog>
    <div id="messageCard">
    </div>
    <bedrock-pubsub target-id="gridMsgDialog" event-name="on-buttonok-clicked" handler="_onDialogOk"></bedrock-pubsub>
    <bedrock-pubsub event-name="global-edit" handler="_onGlobalEdit"></bedrock-pubsub>
    <bedrock-pubsub event-name="quick-manage-event" handler="_onTapQuickManage"></bedrock-pubsub>
    
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-where-used-grid',

        properties: {
          /**
           * Indicates the data which is wrapped in the data-source that is used as a grid data.
           * The format for the JSON object is given in the above description.
           */
          data: {
            type: Object,
            notify: true
          },
          /**
           * If set as true , it indicates the component is in read only mode
           */
          readonly: {
            type: Boolean,
            value: false
          },
          /*
           *	Indicates the transformed relationship data for the grid.
           */
          relationshipGridData: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },
          /**
           * Indicates the transformed relationship grid configuration for the grid.
           */
          relationshipGridConfig: {
            type: Object,
            notify: true
          },
          /**
           * Indicates the attribute models.
           */
          attributeModels: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /*
           * Indicates the currently selected relationship type.
           */
          relationship: {
            type: String,
            notify: true
          },
          /*
           * Indicates the title for the selected relationship type.
           */
          relationshipTitle: {
            type: String,
            notify: true
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          rDataFormatter: {
            type: Object,
            notify: true,
            value: function () {
              return this._populateDataForGrid.bind(this);
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          dataObjects: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          relReq: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          contextData: {
            type: Object,
            value: function () {
              return {};
            }
          },
          maxConfiguredCount: {
            type: Number,
            value: function () {
              return DataObjectFalcorUtil.getPathKeys().dataIndexInfo.entityData.dataSubIndexInfo.data.maxRecordsToReturn;
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          doSyncValidation: {
            type: Boolean,
            value: true
          },
          /*
           */
          _entityGetRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _entityGetAddRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _isMessageAvailable: {
            type: Boolean,
            value: false
          },
          _liquidTracker: {
            type: Array,
            value: function () {
              return [];
            }
          },
          _loading: {
            type: Boolean,
            value: false
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          messageCodeMapping: {
            type: Object,
            value: function () { return {}; }
          },
          governDataConfig: {
            type: Object,
            computed: '_computeGovernConfig(relationshipGridConfig)'
          },
          _loadGovernData: {
            type: Boolean,
            value: false
          },
          governGridActionsConfig: {
            type: Object
          },
          _clipboardTooltip: {
            type: String,
            value: "Copy to clipboard."
          },
          dataIndex: {
            type: String,
            value: "entityData"
          },
          dataSubIndex: {
            type: String,
            value: "data"
          },
          excludeNonContextual: {
              type: Boolean,
              value: false
          },
          _quickManageEnabled: {
            type: Boolean,
            value: false
          },

          _relationshipDeleteItems: {
            type: Object,
            value: function () {
              return {};
            }
          },
          _entityRelations: {
            type: Array,
            value: function () {
              return [];
            }
          },
        },

        behaviors: [
          RUFBehaviors.AppBehavior,
          RUFBehaviors.ComponentContextBehavior
        ],

        observers: [
          '_convertIntoEntityLovList(searchResultResponse)',
          '_addRelationship(relEntitiesResponse)'

        ],

        listeners: {
          'editMode': '_onEditMode'
        },

        _currentSelectedLov: null,
        _currentLovItems: null,

        _hasWritePermissions: function (gridConfig) {
          if (gridConfig["hasWritePermission"]) {
            return true;
          }

          return false;
        },
        _onBulkRelationshipEdit: function (e, detail) {
          var grid = this._getRelationshipGrid();
          var selectedItems = grid.getSelectedItems();
          var selectionMode = grid.getSelectionMode();
          var selectionQuery = grid.getSelectedItemsAsQuery();
          var currentRel = this.relationship;
          var originalEntity = this.dataObjects[currentRel];
          selectionQuery.ids = [originalEntity.id];
          if (selectedItems && selectedItems.length && this.contextData) {
            var originalEntity = this.dataObjects[currentRel];
            selectionQuery.ids = [originalEntity.id];
            var itemContexts = [];
            var typesCriterion = [];

            var itemContext = { "type": originalEntity.type };
            var relAndTypeAttributes = this._getAttributeList();
            var relAttributeNames = relAndTypeAttributes && relAndTypeAttributes.relationshipAttributes ? relAndTypeAttributes.relationshipAttributes : [];
            if (_.isEmpty(relAttributeNames)) {
              this.showInformationToast("No relationship attribute configured in the grid for bulk edit.");
              return;
            }
            // var relAttributeNames = ["linkdescription","enabled","status","displayname"];
            itemContext.relationshipAttributes = relAttributeNames;
            itemContext.relationships = [currentRel];
            itemContexts.push(itemContext);
            if (!typesCriterion.find(type => type === entityRelation.relTo.type)) {
              typesCriterion.push(itemContext.type);
            }
            selectionQuery.filters.typesCriterion = typesCriterion; //Based on relationship entityType
            var clonedContextData = DataHelper.cloneObject(this.contextData);
            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;

            const sharedData = {
              "context-data": clonedContextData,
              "selection-query": selectionQuery,
              "selection-mode": selectionMode,
              "selected-entities": selectedItems,
              "original-entity": originalEntity,
              "relationship": currentRel,
              "edit-attributes-only": false,
              "edit-relationship-attributes-only": true
            };

            this.openBusinessFunctionDialog({
              name: 'rock-wizard-entity-bulk-edit',
              configName: 'wizardConfig'
            }, sharedData);
          } else {
            this.showInformationToast("Please select at least one entity from grid to edit.");
          }
        },

        _getRelationshipGrid: function () {
          return this.shadowRoot.querySelector("rock-grid");
        },

        _getAttributeList: function () {
          if (this.relationshipGridConfig) {
            return this.relationshipGridConfig.relationshipTypeAndAttributes;
          }
        },
        _getFromEntityAttributeList: function () {
          var attributes = this._getAttributeList();
          var fromEntityAttributes = [];
          if (attributes && attributes.relatedEntityAttributes) {
            fromEntityAttributes = attributes.relatedEntityAttributes;
          }
          return fromEntityAttributes;
        },
        _getRelationshipTypeTitle: function () {
          if (this.relationshipGridConfig) {
            var config = this.relationshipGridConfig.gridConfig;
            if (config && config.title && config.title != "") {
              return config.title;
            }
          }
          return this.relationship;
        },
        _getRelationshipGridConfig: function () {
          var gridConfig = undefined;
          if (this.relationshipGridConfig) {
            gridConfig = this.relationshipGridConfig.gridConfig;
          }
          return gridConfig;
        },
        _getRelationshipAddRelLovConfig: function () {
          return this.relationshipGridConfig ? this.relationshipGridConfig.addRelLovConfig : undefined;
        },
        _getRelationshipGridRequest: function (relationshipTypeName) {
          var req = DataHelper.cloneObject(this.relReq);

          if (req && relationshipTypeName) {
            var relConfig = this.relationshipGridConfig;
            var relAttr = this._getAttributeList();
            if (relAttr) {
              req.params.fields.relationshipAttributes = relAttr.relationshipAttributes;
              req.params.fields.attributes = relAttr.relatedEntityAttributes;
            }
            if (relConfig && relConfig.direction && relConfig.direction == "up") {
              const { id, type } = this.getFirstItemContext();
              req.params.query.filters.typesCriterion = relConfig.fromEntityTypes;

              delete req.params.query.ids;
              delete req.params.query.id;

              var dataContexts = ContextHelper.getDataContexts(this.contextData);
              var relCriterion = {};
              relCriterion[relationshipTypeName] = { relTo: { id, type } };
              if (dataContexts && dataContexts.length && this.excludeNonContextual) {
                relCriterion[relationshipTypeName]["contexts"] = dataContexts,
                relCriterion[relationshipTypeName]["excludeNonContextual"] = !this.excludeNonContextual
                req.params.query.filters.excludeNonContextual = this.excludeNonContextual;
              }
              req.params.query.filters.relationshipsCriterion = [relCriterion];
            }

            req.params.fields.relationships = [relationshipTypeName];
          }
          return req;
        },
        _getRelationshipAttributeModels: function (relationshipTypeName) {
          var config = this.relationshipGridConfig;
          var attrModels = {};
          if (config) {
            attrModels = config.relationshipAttributeModels;
            var relEntityAttrModels = config.relatedEntityModel.relatedEntityAttributeModels;
            for (var key in relEntityAttrModels) {
              attrModels[key] = relEntityAttrModels[key];
            }
          }
          return attrModels;
        },
        _getRelatedEntityContexts: function () {
          var config = this.relationshipGridConfig;
          var relatedEntityContexts;
          if (config) {
            relatedEntityContexts = config.relatedEntityModel.relatedEntityContexts;
          }
          return relatedEntityContexts;
        },
        _populateDataForGrid: function (respData) {
          var data = [];
          var itemContext = this.getFirstItemContext();
          var entityTypeManager = EntityTypeManager.getInstance();
          if (respData && itemContext) {
            var currentEntityId = itemContext.id;
            if (respData.content && respData.content.entities && currentEntityId) {
              var entities = respData.content.entities;
              if (entities && entities.length > 0) {
                entities.forEach(function (entity) {
                  this.dataObjects.push(entity);
                  var record = {};
                  record["From Entity"] = record["id"] = entity.id;
                  record["Entity Type"] = entity.type;
                  record["type"] = entity.type;

                  var currentRel = this.relationship;
                  var isSelfContext = false;

                  var relConfig = this.relationshipGridConfig;
                  if (relConfig) {
                    isSelfContext = relConfig.selfContext;
                  }
                  this._entityRelations = this._entityRelations.concat(entity);

                  var relationships = EntityHelper.getRelationshipsBasedOnContext(entity, this.getFirstDataContext(), isSelfContext);
                  if (!_.isEmpty(relationships)) {
                    var relatedEntities = relationships[currentRel];
                    if (this.dataObjects) {
                      if (!this.dataObjects[currentRel]) {
                        this.dataObjects[currentRel] = entity;
                      }
                    }
                    relatedEntities.forEach(function (relItem) {
                      if (relItem) {
                        record["relationshipId"] = relItem.relTo.id;
                        record["Relationship Id"] = relItem.id;
                        if (relItem.relTo && relItem.relTo.id == currentEntityId) {
                          if (relItem.relTo.type) {
                            record["typeExternalName"] = entityTypeManager.getTypeExternalNameById(relItem.relTo.type);
                          }
                          if (relItem.attributes) {
                            Object.keys(relItem.attributes).forEach(function (item) {
                              if (item && relItem.attributes[item]) {
                                var valueObjs = relItem.attributes[item].values;
                                if(!_.isEmpty(valueObjs)) {
                                  if(valueObjs.length > 1) {
                                    var values = [];
                                    for(var valueIndex = 0;valueIndex < valueObjs.length;valueIndex++){
                                      values.push(valueObjs[valueIndex].value);
                                    }
                                    record[item] = values;
                                  } else {
                                    record[item] = valueObjs[0].value;
                                  }
                                }
                              }
                            }, this);
                          }
                        }
                      }
                    }, this);
                  }

                  var attributes = EntityHelper.getAllAttributes(entity);
                  if (attributes) {
                    Object.keys(attributes).forEach(function (attrItem) {
                      if (attrItem && attributes[attrItem]) {
                        var valueObjs = attributes[attrItem].values;
                        if(!_.isEmpty(valueObjs)) {
                          if(valueObjs.length > 1) {
                            var values = [];
                            for(var valueIndex = 0;valueIndex < valueObjs.length;valueIndex++){
                              values.push(valueObjs[valueIndex].value);
                            }
                            record[attrItem] = values;
                          } else {
                            record[attrItem] = valueObjs[0].value;
                          }
                        }
                      }
                    }, this);
                  }

                  data.push(record);
                }, this);
              }
            }
          }
          return data;
        },
        _onEditMode: function (e) {
          var relDiv = this.shadowRoot.querySelector('div[id=relContainer_' + this.relationship + ']');
          if (relDiv) {
            relDiv.hidden = false;

            var buttonContainer = Polymer.dom(relDiv).node.querySelector("div[id='buttonContainer']");
            buttonContainer.hidden = false;
          }
        },
        _save: function (e) {
          var currentRel = this.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          var entityId = DataHelper.getParamValue('id');
          var entityType = DataHelper.getParamValue('type');
          var relConfig = this.relationshipGridConfig;
          var utils = SharedUtils.DataObjectFalcorUtil;

          if (currentRelGrid && relConfig) {
            var gridData = currentRelGrid.getModifiedData();
            var originalEntities = [];

            if (gridData && gridData.length > 0) {
              gridData.forEach(function (data) {
                var entity = data 

                if (entity) {
                  var relationships = EntityHelper.getRelationshipByType(entity, this.getFirstDataContext(), currentRel, relConfig.selfContext);
                  var relObject = {}

                  relObject.relTo = {};
                  relObject.relTo.id = entityId;
                  relObject.relTo.type = entityType;
                  var existingRelationships = EntityHelper.getRelationshipByRelationshipType(entity, this.getFirstDataContext(), currentRel);
                  if (existingRelationships) {
                      existingRelationships.length = 0;
                    }

                    // Add all updated relatinships in entity's current relationship reference.
                    if (relObject) {
                        existingRelationships.push(relObject);
                    }
                  originalEntities.push(entity);
                }
              }, this);
            }
          }

          this._saveRequest = {
            "entities": originalEntities
          };

          //TODO: Sync validation has been commited for now since ther is no BR on relationship attributes.
          // if (this.doSyncValidation) {
          //   if (originalEntities && originalEntities.length) {

          //     originalEntities.forEach(function (originalEntity) {
          //       var liquidRestElement = document.createElement("liquid-rest");
          //       var req = DataRequestHelper.createSyncValidationRequest(originalEntity.id, originalEntity.type, originalEntity.data);

          //       liquidRestElement.requestData = req;
          //       liquidRestElement.url = "/data/pass-through/entitygovernservice/validate";
          //       liquidRestElement.method = "POST";
          //       liquidRestElement.addEventListener("liquid-response", this._onEntityGovernResponse.bind(this));
          //       liquidRestElement.addEventListener("liquid-error", this._onEntityGovernFailed.bind(this));

          //       this._liquidTracker.push(originalEntity.id);
          //       liquidRestElement.generateRequest();
          //     }, this);
          //   }
          // } else {
          this._saveEntity();

        },
        _onTapQuickManage: function (e) {
          var relationship = this.relationship;
          if(e && e.detail && e.detail.enableQuickManage){
            if(!this._quickManageEnabled){
              this._quickManageEnabled = e.detail.enableQuickManage;
            }
          }else{
            this._quickManageEnabled = !this._quickManageEnabled;
          }
          var grid = this._getRelationshipGrid();
          if (this._quickManageEnabled) {
            var selectedItem = grid.selectedItem;
            if (!selectedItem) {
              var selectedItems = grid.getSelectedItems();
              if (selectedItems.length) {
                selectedItem = selectedItems[selectedItems.length - 1];
              }
            }
            this._selectedEntity = selectedItem;
            var itemContext = ContextHelper.getFirstItemContext(this.contextData);
            if (!_.isEmpty(selectedItem)) {
              itemContext.relationshipId = selectedItem.relationshipId;
              itemContext.relatedEntityType = selectedItem.type;
              itemContext.relationships = [relationship];
              itemContext.id = selectedItem.id;
              var relationshipsCriterion = {};
              relationshipsCriterion[relationship] = { 
              "relTo": {
                  "id": itemContext.id,
                  "type": itemContext.type
                }
              };
              itemContext.type = selectedItem.type;
              itemContext.relationshipsCriterion = [relationshipsCriterion];
              grid.clearSelection(); //Clear current selection
              grid.selectItem(selectedItem); //
              this._currentIndex = grid.getSelectedItemIndex();
              grid.scrollToIndex(this._currentIndex);
            }
          } else {
            this._currentIndex = -1;
          }
          this._reloadQuickManage();
        },
        _applyClass: function () {
          if (this._quickManageEnabled) {
            return "grid-quick-manage-container col-8-4-grid";
          }
          return "";
        },
        _reloadQuickManage() {
          const entityQuickManage = this.shadowRoot.querySelector("#entityQuickManage");
          if (entityQuickManage) {
            entityQuickManage.reload();
          }
        },
        _convertIntoEntityLovList: function (entitiesResponse) {
          if (entitiesResponse) {
            var items = [];
            var selectedItems = [];

            if (entitiesResponse.content && entitiesResponse.content.entities) {
              var entities = entitiesResponse.content.entities;
              entities.forEach(function (item) {
                if (item) {
                  //TODO: this code has to be enhanced for based on config.
                  var attributes = EntityHelper.getAllAttributes(item);
                  items.push({
                    "id": item.id,
                    "title": item.id,
                    "subtitle": item.type,
                    "image": "/src/images/lookup-item.jpg"
                  });
                }
              }, this);
            }

            if (this._currentSelectedLov) {
              var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this._currentSelectedLov.id + ']');
              var relGridData = [];
              if (relGrid) {
                relGridData = relGrid.getData();
              }

              this._currentSelectedLov.items = items;
              this._currentSelectedLov.selectedItems = relGridData;
              this._currentLovItems = items;
            }
          }
        },
        _onLovConfirmButtonTapped: function (event) {
          if (event.detail) {

            var lov = this.shadowRoot.querySelector("rock-entity-lov[id=" + event.detail.data.id + "]");

            var oldSelectedItemIds = [];
            var selectedItemIds = [...new Set(lov.selectedItems.map((obj) => obj.id))];
            var newItemIds = [];
            var relType = event.detail.data.id.replace("lov_", "");
            // TO-DO Pebble-LOV has to handle this filteration.
            var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + relType + ']');
            if (currentRelGrid) {
              var data = currentRelGrid.getData();
              data.forEach(function (item) {
                if (item) {
                  oldSelectedItemIds.push(item.id);
                }
              }, this);
            }

            selectedItemIds.forEach(function (item) {
              if (item && oldSelectedItemIds.indexOf(item) < 0) {
                newItemIds.push(item);
              }
            }, this);

            this._addRelatedEntity(relType, newItemIds);
          }
        },
        _onLovCloseButtonTapped: function (event) {
          if (event.detail) {
            var id = event.detail.data.id.replace("lov_", "");
            var currentLovPopover = this.shadowRoot.querySelector('pebble-popover[for=button_' + id + ']');

            if (currentLovPopover) {
              currentLovPopover.hide();
            }
          }
        },
        _onAddRelClick: function (e) {
          if (e.currentTarget.disabled == true) {
            return;
          }
          var popover = this.shadowRoot.querySelector("pebble-popover[for=" + e.currentTarget.id + "]");
          this._currentSelectedLov = this.shadowRoot.querySelector('rock-entity-lov[id=lov_' + this.relationship + ']');
          popover.show();
        },
        _addRelatedEntity: function (relationshipType, entityIds) {
          if (entityIds && entityIds.length > 0) {
            var popover = this.shadowRoot.querySelector("pebble-popover[for=button_" + relationshipType + "]");

            var typesCriterion = this.relationshipGridConfig.fromEntityTypes
            var relatedEntityContexts = this._getRelatedEntityContexts();
            var contexts = [];
            var attributes = this._getRelatedEntityAttributeList();

            if (relatedEntityContexts) {
              relatedEntityContexts.forEach(function (relContexts) {
                if (relContexts) {
                  if (relContexts.relContexts) {
                    relContexts.relContexts.forEach(function (ctxItem) {
                      contexts.push(ctxItem);
                    }, this);
                  }
                }
              }, this);
            }

            var valueContext = this.getFirstValueContext();

            //TODO-dimensions has to be set in req. same like did in relationship-manage
            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": [valueContext],
                  "ids": entityIds,
                  "filters": {
                    "typesCriterion": typesCriterion
                  }
                },
                "fields": {
                  "attributes": attributes
                },
                "options": {
                  "maxRecords": 10
                }
              }
            };

            this.set('_entityGetAddRequest', req);
            var relAddLiquid = this.shadowRoot.querySelector('liquid-entity-data-get[id="entityGetAddData"]');
            if (relAddLiquid) {
              relAddLiquid.generateRequest();
            }
            popover.hide();
          }
        },
        _addRelationship: function () {
          if (this.relEntitiesResponse) {
            var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');

            if (relGrid) {
              var relData = [];
              if (this.relEntitiesResponse.content && this.relEntitiesResponse.content.entities) {
                var entities = this.relEntitiesResponse.content.entities;
                var relGridData = relGrid.getData();
                entities.forEach(function (relItem) {
                  if (relItem) {
                    var attributes = EntityHelper.getAllAttributes(relItem);
                    var record = {};
                    if (attributes) {
                      Object.keys(attributes).forEach(function (attrItem) {
                        if (attrItem && attributes[attrItem]) {
                          record[attrItem] = attributes[attrItem].values[0].value;
                        }
                      }, this);
                    }
                    record['Related Entity'] = record['id'] = relItem.id;
                    record['type'] = relItem.type;
                    record['properties'] = relItem.properties;
                    record['relationshipType'] = this.relationship;
                    relData.push(record);
                  }
                }, this);
              }
              relGrid.addNewRecords(relData);
            }
          }
        },

        _getRelatedEntityAttributeList: function () {
          var attributes = this._getAttributeList();
          var relatedEntityAttributes = [];
          if (attributes && attributes.relatedEntityAttributes) {
            relatedEntityAttributes = attributes.relatedEntityAttributes;
          }
          return relatedEntityAttributes;
        },
        _onSelectingGridItem: function (e, detail, sender) {
          if (this._quickManageEnabled) {
            var grid = this._getRelationshipGrid();
            this._selectedEntity = detail.item;
            if (!_.isEmpty(this._selectedEntity)) {
              var itemContext = ContextHelper.getFirstItemContext(this.contextData);
              itemContext.relationshipId = this._selectedEntity.relationshipId;
              itemContext.relatedEntityType = this._selectedEntity.type;
              itemContext.relationships = [this.relationship];
              grid.clearSelection();
              Polymer.Async.microTask.run(() => {
                this._currentIndex = grid.getSelectedItemIndex();
              });
            }
          }
          this._reloadQuickManage();
        },
        _onDeleteEntityRelationshipAction: function (e, detail) {
          // deleting newly added record and reload reloadRelationshipLov.
          if (detail.isNewlyAddedDataRowDelete) {
            this._reloadRelationshipLov(detail.id);
            return;
          }
          this._modifiedEntityRelationship = { event: e, detail: detail, action: "delete" };
          this.openGridMsgDialog("Are you sure you want to delete?");
        },
        _onRevertDialogOk: function (e) {
          var currentRel = e.target.__dataHost.parentModel.relationship; //e.model.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          currentRelGrid.changeToReadMode();
          this._changeRelationshipToReadMode();
        },

        _onCustomToolbarEvent: function (e, detail) {
          if (detail && detail.name == "delete") {
            var grid = this._getRelationshipGrid();
            var selectedItems = grid.getSelectedItems();
            if (selectedItems && selectedItems.length) {
              var savedRecords = [];
              var newRecordsIds = [];
              for (let idx = 0; idx < selectedItems.length; idx++) {
                var item = selectedItems[idx];
                if (DataHelper.isValidObjectPath(item, "_rowStatus.status") && item._rowStatus.status.toLowerCase() == "new") {
                  grid._deleteNewRowById(item.id);
                  newRecordsIds.push(item.id);
                } else {
                  savedRecords.push(item);
                }
              }

              //reload reloadRelationshipLov
              this._reloadRelationshipLov(newRecordsIds);

              // delete already saved records
              if (savedRecords && savedRecords.length) {
                var detail = { "selectedItems": savedRecords };
                this._modifiedEntityRelationship = { event: e, detail: detail, action: "bulk-delete" };
                this.openGridMsgDialog("Are you sure you want to delete?");
              }
            } else {
              this.showInformationToast("Please select at least one relationship from grid to delete.");
            }
          }
        },
        _reloadRelationshipLov: function (ids) {
          var relationshipLov = Polymer.dom(this).node.shadowRoot.querySelector('rock-entity-lov[id=lov_' + this.relationship + ']');
          if (relationshipLov && relationshipLov.selectedItems) {
            var relationshipLovSelectedItems = relationshipLov.selectedItems;
            if (_.isArray(ids)) {
              ids.forEach(function (elValue) {
                var relationshipLovItem = DataHelper._findItemByKeyValue(relationshipLovSelectedItems, "id", elValue);
                if (relationshipLovItem) {
                  // reload the relationshipLov
                  relationshipLovSelectedItems = relationshipLovSelectedItems.filter(function (selectedItem) {
                    return selectedItem.id != elValue;
                  });
                }
              });
            } else {
              // reload the relationshipLov
              relationshipLovSelectedItems = relationshipLovSelectedItems.filter(function (selectedItem) {
                return selectedItem.id != ids;
              });
            }
            relationshipLov.selectedItems = relationshipLovSelectedItems;
          }
        },
        openGridMsgDialog: function (msg) {
          this.shadowRoot.querySelector('#msgDialog').innerText = msg;
          this.shadowRoot.querySelector('#gridMsgDialog').open();
        },
        _saveEntity: function () {
          var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");
          if (liquidSave) {
            liquidSave.generateRequest();
          }
        },
        _onSaveResponse: function () {
          this.showSuccessToast('Relationships saved successfully.');

          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');

          if (currentRelGrid) {
            this._changeRelationshipToReadMode();
            currentRelGrid.changeToReadMode();
          }
        },
        _revertAll: function (e) {
          var currentRel = this.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          if (currentRelGrid) {
            if (currentRelGrid.getIsDirty()) {
              currentRelGrid.openGridMsgDialog(currentRel +
                " relationship has unsaved changes. Do you wants to revert those ?");
            } else {
              currentRelGrid.changeToReadMode();
              this._changeRelationshipToReadMode();
            }
          }
        },
        _setRelGridDataSource: function () {
          var repeat = this.shadowRoot.querySelector('template[is="dom-repeat"]');

          if (repeat) {
            repeat.addEventListener("dom-change", function (event) {
              var relDivs = this.parentNode.querySelectorAll('div[id^=relContainer_]');

              if (relDivs && relDivs.length > 0) {
                for (var i in relDivs) {
                  var item = relDivs[i];
                  if (typeof item === 'object') {
                    var relGrid = item.querySelector('rock-grid');
                    var dataSourceElement = item.querySelector('entity-search-grid-datasource');

                    if (relGrid && dataSourceElement) {
                      relGrid.dataSource = dataSourceElement.dataSource;

                      dataSourceElement.addEventListener('current-record-size-changed', function (e) {
                        this.gridDataSize = e.currentTarget.bufferRecordSize;
                      }.bind(relGrid));

                      dataSourceElement.addEventListener('total-records-changed', function (e) {
                        this.currentRecordSize = e.currentTarget.currentRecordSize;
                      }.bind(relGrid));
                    }
                  }
                }
              }
            });
          }
        },
        _onDialogOk: async function (e) {
          if (this._modifiedEntityRelationship && "action" in this._modifiedEntityRelationship) {
            if (this._modifiedEntityRelationship.action == "bulk-delete" || this._modifiedEntityRelationship.action == "delete") {
              if (this.relationship) {
                var selectedItems = this._modifiedEntityRelationship.detail.selectedItems;
                var id = this._modifiedEntityRelationship.detail.id;

                var selectedIds = [];
                var coalescedIds = [];

                if (!_.isEmpty(selectedItems)) {
                  selectedItems.forEach(function (item) {
                    if (this._hasContextCoalescedValue(item)) {
                      coalescedIds.push(item.id);
                    } else {
                      selectedIds.push(item.id);
                    }
                  }, this);
                } else {
                  selectedIds = [id];
                }

                if (!_.isEmpty(selectedIds)) {
                  this._relationshipDeleteItems["relIds"] = selectedIds;
                }

                if (!_.isEmpty(coalescedIds)) {
                  this._relationshipDeleteItems["coalescedRelIds"] = coalescedIds;

                  if (_.isEmpty(selectedIds)) {
                    var message = "Relationship(s) delete request can not be sent for " + this._relationshipDeleteItems["coalescedRelIds"].length + " sourced relationship(s).";
                    this.showWarningToast(message, 10000);
                  }
                }

                this._deleteRelatioshipsByIds(selectedIds);
              }
            }
          }
        },
        _deleteRelatioshipsByIds: async function (selectedIds) {
          if (!_.isEmpty(selectedIds)) {
            var updateRequests = [];
            // var updateRequest = DataRequestHelper.generateRelationshipProcessRequest(this.contextData);
            var relations = this._entityRelations;
            var modifiedRelations = [];
            var selectedEntities = [];
            var modifiedEntities = [];
            var entityId = DataHelper.getParamValue('id');
            if (selectedIds) {
              selectedIds.forEach(selectedId => {
                relations.forEach(relation => {
                  if (selectedId.indexOf(relation.id) > -1) {
                    modifiedEntities.push(relation)
                  }
                })
              })
            }

            var modifiedEntityRelationships;
            var updateRequest;
            if (modifiedEntities) {
              modifiedEntities.forEach(modifiedEntity => {
                modifiedEntityRelationships = modifiedEntity.data.relationships[this.relationship];
                modifiedEntityRelationships.forEach(modifiedEntityRelationship => {
                  if (modifiedEntityRelationship.id.indexOf(entityId) > -1) {
                    var updateRequest = { "data": {
                    "relationships": {}
                }};
                    modifiedEntityRelationship.action = "delete";
                    updateRequest.data.relationships[this.relationship] = [modifiedEntityRelationship];
                    updateRequest["id"] =  modifiedEntity.id;
                    updateRequest["type"] =  modifiedEntity.type
                    updateRequests.push(updateRequest);
                  }
                })
              });
            }

            // await DataTransformHelper.prepareEntityForContextSave(updateRequest.data, {}, this._relationshipModels, this.contextData);

            var entityDelLiquid = this.shadowRoot.querySelector("#entityRelationsDeleteService");
            if (entityDelLiquid) {
              entityDelLiquid.requestData = {
                "entities": updateRequests
              };
              entityDelLiquid.operation = "update";
              entityDelLiquid.generateRequest();
            }
          }
        },

        _hasContextCoalescedValue: function (item) {
          return !_.isEmpty(item.contextCoalescePaths);
        },
        _onRelationsDeleteResponse: function (e, detail) {
          var message;
          if ("relIds" in this._relationshipDeleteItems && !("coalescedRelIds" in this._relationshipDeleteItems)) {
            message = "Relationship(s) delete request submitted successfully for" + this._relationshipDeleteItems["relIds"].length + " relationship(s).";
            this.showSuccessToast(message, 10000);
          } else if ("coalescedRelIds" in this._relationshipDeleteItems) {
            if ("relIds" in this._relationshipDeleteItems) {
              message = "Relationship(s) delete request submitted successfully for" + this._relationshipDeleteItems["relIds"].length + " relationship(s) and relationship(s) delete request can not be sent for " + this._relationshipDeleteItems["coalescedRelIds"].length + " sourced relationship(s).";
            } else {
              message = "Relationship(s) delete request can not be sent for " + this._relationshipDeleteItems["coalescedRelIds"].length + " sourced relationship(s).";
            }
            this.showWarningToast(message, 10000);
          }

          var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');
          if (relGrid) {
            this._entityRelations = [];
            relGrid.set('config.mode', "read");
            relGrid.reRenderGrid();
          }
          var relationshipLov = Polymer.dom(this).node.shadowRoot.querySelector('rock-entity-lov[id=lov_' + this.relationship + ']');
          if (relationshipLov) {
            var gridData = relGrid.getData();
            var savedRelationshipItemsToLov = gridData.map(function (item) {
              if (item.id) {
                return { 'id': item.id, 'title': item.id }
              }
            });
            this._savedRelationshipItemsToLov[this.relationship] = DataHelper.cloneObject(savedRelationshipItemsToLov);
            relationshipLov.selectedItems = savedRelationshipItemsToLov[this.relationship] || [];
          }
        },
        _onRelationsSaveError: function (e, detail) {
          this._relationshipDeleteItems = {};
          this.showErrorToast("Unable to delete the entity relationship, please contact administrator.");
        },
        _changeRelationshipToReadMode: function () {
          if (this.relationship) {
            var relDiv = this.shadowRoot.querySelector('div[id=relContainer_' + this.relationship + ']');

            if (relDiv) {
              var buttonContainer = Polymer.dom(relDiv).node.querySelector("div[id='buttonContainer']");
              buttonContainer.hidden = true;
            }

          }
        },
        _onDownload: function (e) {
          var rockGrid = this.shadowRoot.querySelector('rock-grid');
          var selectedItems = rockGrid.getSelectedItems();

          if (selectedItems && selectedItems.length && this.contextData) {
            const sharedData = {
              "selected-entities": selectedItems
            };

            this.openBusinessFunctionDialog({ name: 'rock-entity-download' }, sharedData);
          } else {
            this.showInformationToast("Please select at least one entity from grid to download.");
          }
        },
        _onCOPDownloadFailure: function (error) {
          this.showErrorToast("Failed to download entity data. Please contact administrator: " + error);
          this._loading = false;
        },
        _onUpload: function (e, detail) {
          this.openBusinessFunctionDialog({ name: 'rock-entity-upload' });
        },
        _computeGovernConfig: function (relationshipGridConfig) {
          if (relationshipGridConfig) {
            return relationshipGridConfig.governDataConfig;
          }
        },
        _showToggle: function (governDataConfig) {
          return governDataConfig && governDataConfig.showGovernDataToggle;
        },
        _onGovernGridActionTap: function (e, detail) {
          detail.data.relationship = this.relationship;
          this.fireBedrockEvent("govern-grid-action-click", detail);
        },
        _loadActions: function (_loadGovernData, governGridActionsConfig) {
          return _loadGovernData && governGridActionsConfig.enableActions;
        },
        _onMouseoutCopyAction: function () {
          this.set("_clipboardTooltip", "Copy to clipboard.");
        },
        _onTapCopyAction: function (ev) {
          var currentRel = this.relationship;
          var grid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          if (grid) {
            var selectedItems = grid.getSelectedItems();
            if (selectedItems && selectedItems.length) {

              var delimeter = ",";
              if (this.relationshipGridConfig.copyActionConfig.delimeter) {
                delimeter = this.relationshipGridConfig.copyActionConfig.delimeter;
              }
              var _attr = "";
              if (this.relationshipGridConfig.copyActionConfig.attributeField) {
                _attr = this.relationshipGridConfig.copyActionConfig.attributeField;
              }
              var copyString = "";
              selectedItems.forEach(element => {
                if (element && element.id) {
                  if (_attr && element[_attr]) {
                    copyString += element[_attr] + delimeter;
                  }
                }
              });
              if (copyString) {
                var finalCopyString = copyString.substr(0, copyString.length - delimeter.length);
                DataHelper.copyToClipboard(finalCopyString);
                this.set("_clipboardTooltip", "Copied!");
              }

            } else {
              this.showInformationToast("Please select at least one relationship from grid to copy.");
            }
          }
        },
        getSelectedItems: function () {
          var grid;
          if (this._loadGovernData) {
            grid = this.shadowRoot.querySelector("rock-govern-data-grid[id=" + this.relationship + "]");
          } else {
            grid = this.shadowRoot.querySelector("rock-grid[id=" + this.relationship + "]");
          }

          if (grid) {
            return grid.getSelectedItems();
          }
        },
        getControlIsDirty: function () {
          var rockGridObj = this.$$("rock-grid");
          var rockGovernGridObj = this.$$("rock-govern-data-grid");
          if (rockGridObj && rockGridObj.getControlIsDirty) {
            return rockGridObj.getControlIsDirty();
          }

          if (rockGovernGridObj && rockGovernGridObj.getControlIsDirty) {
            return rockGovernGridObj.getControlIsDirty();
          }
        },

        refresh: function () {
          var rockGridObj = this.$$("rock-grid");
          var rockGovernGridObj = this.$$("rock-govern-data-grid");
          if (rockGridObj && rockGridObj.refresh) {
            rockGridObj.refresh();
          } else if (rockGovernGridObj && rockGovernGridObj.refresh) {
            rockGovernGridObj.refresh();
          }
        },
        _governGridRefresh: function () {
          var grid = this.shadowRoot.querySelector("rock-govern-data-grid[id=" + this.relationship + "]");

          if (grid && grid.reRenderGrid) {
            grid.reRenderGrid();
          }
        },
        _onBulkEdit: function (e, detail) {
          var grid = this.shadowRoot.querySelector("rock-grid[id=" + this.relationship + "]");
          var selectedItems = grid.getSelectedItems();
          var selectionMode = grid.getSelectionMode();
          var selectionQuery = grid.getSelectedItemsAsQuery();
          if (selectedItems && selectedItems.length && this.contextData) {
            var itemContexts = [];
            var typesCriterion = this.relationshipGridConfig.fromEntityTypes;
            if (typesCriterion && typesCriterion.length) {
              for (var i = 0; i < typesCriterion.length; i++) {
                var type = typesCriterion[i];
                if (!(itemContexts.find(obj => obj.type === type))) {
                  var itemContext = { "type": type };
                  itemContexts.push(itemContext);
                }
              }
            }
            var clonedContextData = DataHelper.cloneObject(this.contextData);
            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;

            const sharedData = {
              "context-data": clonedContextData,
              "selection-query": selectionQuery,
              "selection-mode": selectionMode,
              "selected-entities": selectedItems,
              "edit-attributes-only": true,
              "edit-relationship-attributes-only": false
            };

            this.openBusinessFunctionDialog({
              name: 'rock-wizard-entity-bulk-edit',
              configName: 'wizardConfig'
            }, sharedData);
          } else {
            this.showInformationToast("Please select at least one entity from grid to edit.");
          }
        },

        _onGlobalEdit(e) {
          var relGrid = this.$$(`#${this.relationship}`);

          if (relGrid) {
            relGrid.changeToEditMode();
          }
        },
        _onAddNewRelClick: function (item) {

          const { fromEntityTypes } = this.relationshipGridConfig;
          var contextData = DataHelper.cloneObject(this.contextData);
          //delete this.contextData.ItemContexts[0];
          contextData.ItemContexts[0] = { "type": fromEntityTypes[0] };

          var defaultEntity = {
            "data": {
              "relationships": {}
            }
          }
          var rel = {
            "direction": "both",
            "relationshipType": this.relationshipGridConfig.relationshipModel.properties.relationshipType,
            "relTo": {
              "id": this.contextData.ItemContexts[0].id,
              "type": this.contextData.ItemContexts[0].type
            }
          };
          defaultEntity.data.relationships[this.relationship] = [rel];

          const sharedData = {
            "context-data": contextData,
            "title": "Create New " + EntityTypeManager.getInstance().getTypeExternalNameById(contextData.ItemContexts[0].type),
            "default-entity": defaultEntity
          };

          this.openBusinessFunctionDialog({
            name: 'rock-wizard-entity-create'
          }, sharedData);
        },
        _onEntityCreated: function (e) {
          var businessDialog = RUFUtilities.appCommon.shadowRoot.querySelector("rock-business-function-dialog");
          if (businessDialog) {
            var dialog = businessDialog.dialog;
            dialog.close();
          }
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');
          if (currentRelGrid) {
            this._changeRelationshipToReadMode();
            currentRelGrid.changeToReadMode();
          }
        },
        _addClientStatus: function () {
          var clientState = {};
          clientState.notificationInfo = {};
          clientState.notificationInfo.showNotificationToUser = true;
          this._saveRequest["clientState"] = clientState;

        },

        _requestForAddRelationshipList: function (relationship) {
          var relatedEntityContexts = this._getRelatedEntityContexts(relationship);
          var attributes = this._getFromEntityAttributeList(relationship);

          var typesCriterion = this.relationshipGridConfig.fromEntityTypes;
          var contexts = [];

          if (relatedEntityContexts) {
            relatedEntityContexts.forEach(function (relContext) {
              if (relContext) {
                if (relContext.relContexts) {
                  relContext.relContexts.forEach(function (ctxItem) {
                    contexts.push(ctxItem);
                  }, this);
                }
              }
            }, this);

            var valueContext = this.getFirstValueContext();

            var req = {
              "params": {
                "query": {
                  "contexts": contexts,
                  "valueContexts": [valueContext],
                  "filters": {
                    "attributesCriterion": [],
                    "typesCriterion": typesCriterion
                  }
                },
                "fields": {
                  "ctxTypes": [
                    "properties"
                  ],
                  "attributes": attributes,
                  "relationships": []
                },
                "options": {
                  "from": 0,
                  "to": 0
                }
              }
            };

            return req;
          } else {
            var messageDiv = this.$.messageCard;
            if (messageDiv) {
              messageDiv.textContent = "Relationships are not configured for current entity type: " + this.relationshipTitle;
              this._isMessageAvailable = true;
            }
          }
        },
        _getIdField: function (relationship) {
          var idField = "";
          var addRelLovConfig = this._getRelationshipAddRelLovConfig(relationship);
          if (addRelLovConfig) {
            idField = addRelLovConfig.idField;
          }
          return idField;
        },
        _getTitlePattern: function (relationship) {
          var titlePattern = "";
          var addRelLovConfig = this._getRelationshipAddRelLovConfig(relationship);
          if (addRelLovConfig) {
            titlePattern = addRelLovConfig.titlePattern;
          }
          return titlePattern;
        },
        _getAttrMessages: function(error) {
          return error.attrErrorMessages;
        }
      });
    })();
  </script>
</dom-module>
