<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-grid-data-sources/entity-search-grid-datasource.html">
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">
<link rel="import" href="../rock-govern-data-grid/rock-govern-data-grid.html">
<link rel="import" href="../rock-entity-relationship-search-result-actions/rock-entity-relationship-search-result-actions.html">
<link rel="import" href="../rock-business-actions/rock-business-actions.html" />

<!--

  `rock-relationship-grid` Represents an association relationship grid for an entity.
The following JSON objects depicts the entity that loads the relationship grid.
Based on the configuration, relationship grid gets loaded with the defined attributes from the given data object.

```json
{
  "crossSell": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",    
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        },
        {
          "header": "price in kit",
          "name": "price in kit",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        },
        {
          "header": "quality",
          "name": "quality",
          "sortable": true,
          "filterable": false,
          "editType": "textbox"
        }
      ]
    }
  },
  "accessories": {
    "viewMode": "Tabular",
    "mode": "Read",
    "title": "Related Products",
    "tabular": {
      "settings": {
        "isMultiSelect": true,
        "actions": [
          {
            "name": "delete",
            "icon": "pebble-icons:Delete",
            "eventName": "delete-item"
          }
        ]
      },
      "columns": [
        {
          "header": "Related Entity",
          "name": "Related Entity",
          "sortable": true,
          "filterable": false,
          "editType": ""
        }
      ]
    }
  }
}
```
The following JSON object is a sample of data which binds the grid.
```json
{
  "id": "e2",
  "type": "product",
  "properties": {
    "source": "PLM",
    "createdByService": "entityservice",
    "createdBy": "jim",
    "createdDate": "2016-07-16T18:10:52.412-07:00",
    "modifiedByService": "entityservice",
	"modifiedBy": "user",
    "modifiedDate": "2016-07-16T18:33:52.412-07:00"
  },
  "tags": [
    "Shrug"
  ],
  "data": {
    "contexts": [
      {
        "context": {
          "list": "master"
        },
        "attributes": {
          "productName": {
            "values": [
              {
                "value": "Toggle Shrug",
                "source": "PLM",
                "locale": "en-US"
              }
            ]
          }
        },
        "relationships": {
          "crossSell": [
            {
              "id": "rel1",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "attributes": {
                "status": {
                  "values": [
                    {
                      "value": "Active",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "quantity": {
                  "values": [
                    {
                      "value": "5",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                },
                "price in kit": {
                  "values": [
                    {
                      "value": "1000",
                      "source": "PLM",
                      "locale": "en-US"
                    }
                  ]
                }
              },
              "relTo": {
                "id": "e5",
                "type": "product"
              }
            }
          ],
          "accessories": [
            {
              "id": "rel6",
              "direction": "both",
              "source": "PLM",
              "operation": "association",
              "relTo": {
                "id": "e6",
                "type": "product"
              }
            }
          ]
        }
      }
    ]
  }
}
```
@demo demo/index.html
-->
<dom-module id="rock-where-used-grid">
  <template>

    <style include="bedrock-style-common"></style>
    <style>
      pebble-button.icon-text-button {
        --pebble-button: {
          height: 30px;
          padding-top: 0.5em;
          padding-right: 0em;
          padding-bottom: 0.5em;
          padding-left: 0em;
          border: 1px solid var(--primary-color);
        }
        --pebble-button-iron-icon: {
          height: 18px;
          width: 18px;
          padding-bottom: 2px;
        }
      }

      .relation-name {
        font-weight: var(--font-medium, 500);
        font-family: var(--default-font-family);
        clear: both;
        padding-top: 10px;
        margin: 0px;
        font-size: var(--font-size-md, 16px);
      }

      .relation-name-container {
        clear: left;
        @apply --layout-horizontal;
        padding: 10px 0 0;
        flex-direction: row-reverse !important;
        border-radius: 3px;
        margin: 2px 0px 0 0px;
        flex-direction: row-reverse !important;
        -webkit-flex-direction: row-reverse !important;
      }

      .relation-line-box {
        margin-top: 16px;
        margin-left: 8px;
        margin-right: 8px;
        @apply --layout-flex;
      }

      .relation-name-box {
        display: block;
        width: calc( 100% - 50px);
      }

      pebble-horizontal-divider {
        --pebble-horizontal-divider-color: var(--tooltip-bg-color, rgba(25, 32, 39, 1));
      }

      pebble-lov {
        width: 300px !important;
        max-height: 350px !important;
      }

      rock-grid {
        --rock-grid-height: 200px;
      }

      .relation-name-container pebble-button {
        --pebble-button:{
          color: var(--white, #fff);
          min-width: 50px;
          color: var(--white, #fff);
          border-radius: 3px;
          padding-top: 0px;
          padding-right: 8px;
          padding-bottom: 0px;
          padding-left: 8px;
          height: 28px;
        };
      }

      #buttonContainer {
        height: 50px;
        background: var(--white, #fff);
        position: relative;
        bottom: 15px;
        width: 100%;
      }

      #errorsDialog {
        --popup-header-color: var(--palette-pinkish-red, #ee204c);
      }

      #messageCard {
        text-align: center;
      }

      pebble-toggle-button {
        --pebble-toggle-button-checked-bar-color: var(--success-color, #4caf50);
        --pebble-toggle-button-checked-button-color: var(--success-color, #4caf50);
        --pebble-toggle-button-checked-ink-color: var(--success-color, #4caf50);
        --pebble-toggle-button-label-color: var(--secondary-button-text-color, #75808b);
      }

      .toggle-button {
        float: right;
        padding: 20px 20px 0px 0px;
        font-size: var(--font-size-sm, 12px);
        @apply --rock-where-used-grid-govern-toggle;
      }

      .govern-grid-actions {
        float: right;
        margin: 15px 10px 0px 0px;
      }

      .refresh {
        color: var(--icon-color, #757575);
        width: 14px;
        height: 14px;
        padding: 0px;
        float: right;
        margin: 22px 10px 0px 0px;
        cursor: pointer;
      }
    </style>
    <pebble-spinner active="[[_loading]]"></pebble-spinner>
    <template is="dom-if" if="[[!_isMessageAvailable]]">
      <div id="relContainer_[[relationship]]">
        <pebble-accordion header-text="[[_getRelationshipTypeTitle(relationship)]]" default-icon="pebble-icon:RightArrow" open-icon="pebble-icon:Expand">
          <!--<div class="relation-name-container">
              <pebble-button icon="pebble-sm-icons:Add" id="[[relationship]]" class="btn btn-primary m-r-20" button-text="Add" on-click="_onAddPopoverClick"></pebble-button>              
              <pebble-popover for$="[[relationship]]" vertical-align="auto" horizontal-align="auto" no-overlap>
                <rock-entity-lov id="[[relationship]]" request-data="[[_requestForAddRelationshipList(relationship)]]" id-field="[[_getIdField(relationship)]]"
                  title-pattern="[[_getTitlePattern(relationship)]]" multi-select no-sub-title show-action-buttons></rock-entity-lov>
              </pebble-popover>
              <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLovConfirmButtonTapped" target-id="[[relationship]]"></bedrock-pubsub>
              <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLovCloseButtonTapped" target-id="[[relationship]]"></bedrock-pubsub>
            </div>-->
            <span slot="header-actions">
              <template is="dom-if" if="[[relationshipGridConfig.gridConfig]]">
                <pebble-info-icon description-object="[[relationshipGridConfig.gridConfig]]"></pebble-info-icon>
              </template>
            </span>
          <template is="dom-if" if="[[relationshipGridConfig.copyActionConfig]]">
              <div class="text-right">
                <pebble-button class="btn btn-primary m-r-10 tooltip-bottom" id="copy_btn" data-tooltip$="[[_clipboardTooltip]]"  button-text="Copy ID(s)" on-tap="_onTapCopyAction" on-mouseout="_onMouseoutCopyAction"></pebble-button>
              </div>
          </template>
          <template is="dom-if" if="[[_showToggle(relationshipGridConfig.governGridConfig)]]">
            <pebble-toggle-button class="toggle-button" noink checked="{{_loadGovernData}}">Govern Data</pebble-toggle-button>
            <template is="dom-if" if="[[_loadActions(_loadGovernData, relationshipGridConfig.governGridConfig)]]">
              <pebble-icon icon="pebble-md-icons:ToolbarRefresh" class="refresh pebble-md-icons" on-tap="_governGridRefresh"></pebble-icon>
              <!--<pebble-actions id="governGridActions" button-icon="[[governGridActionsConfig.icon]]" class="dropdownText dropdownIcon btn btn-actions dropdown-success govern-grid-actions"
                              button-text="[[governGridActionsConfig.title]]"
                              actions-data="[[governGridActionsConfig.actionsData]]"></pebble-actions>-->
              <!--<bedrock-pubsub event-name="pebble-actions-action-click" handler="_onGovernGridActionTap" target-id=""></bedrock-pubsub>-->
              <rock-business-actions id="businessActions" context-data="[[contextData]]" button-text="[[relationshipGridConfig.governGridConfig.actionsTitle]]" button-icon="[[relationshipGridConfig.governGridConfig.actionsIcon]]" show-workflow-actions></rock-business-actions>
              <bedrock-pubsub event-name="business-actions-action-click" handler="_onGovernGridActionTap" target-id="businessActions"></bedrock-pubsub>
            </template>
          </template>
          <entity-search-grid-datasource id="datasource_[[relationship]]" request="[[_getRelationshipGridRequest(relationship)]]" r-data-source="{{rDataSource}}"
                                         r-data-formatter="{{rDataFormatter}}" buffer-record-size="{{size}}" current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}"
                                         total-count="{{totalCount}}"></entity-search-grid-datasource>
          <rock-grid hidden$="[[_loadGovernData]]" readonly$="[[readonly]]" id$="[[relationship]]" r-data-source="{{rDataSource}}" r-data-source-id="datasource_[[relationship]]"
                     config="{{relationshipGridConfig.gridConfig}}" attribute-models="[[_getRelationshipAttributeModels(relationship)]]"
                     grid-data-size="{{size}}" current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}" max-configured-count="[[maxConfiguredCount]]"
                     total-count="{{totalCount}}" page-size="20">
                     <rock-entity-relationship-search-result-actions slot="toolbar" id="gridActions" context-data="[[contextData]]" has-write-permissions$="[[_hasWritePermissions(relationshipGridConfig.gridConfig)]]"></rock-entity-relationship-search-result-actions>
          </rock-grid>

          <bedrock-pubsub event-name="grid-bulk-edit-items" handler="_onBulkEdit" target-id="[[relationship]]"></bedrock-pubsub>
          <template is="dom-if" if="[[_loadGovernData]]">
            <rock-govern-data-grid id$="[[relationship]]" context-data="[[contextData]]" request="[[_getRelationshipGridRequest(relationship)]]"
                                   entity-name-attribute="[[relationshipGridConfig.governGridConfig.entityNameAttribute]]"></rock-govern-data-grid>
          </template>
          <bedrock-pubsub target-id="[[relationship]]" event-name="on-grid-msg-dialog-ok" handler="_onDialogOk"></bedrock-pubsub>
          <bedrock-pubsub event-name="grid-download-item" handler="_onDownload" target-id="[[relationship]]"></bedrock-pubsub>
          <bedrock-pubsub event-name="grid-upload-item" handler="_onUpload" target-id="[[relationship]]"></bedrock-pubsub>
          <div id="buttonContainer" align="center" hidden>
            <pebble-button id="cancel" class="btn btn-secondary" button-text="Cancel" on-tap="_revertAll" elevation=1 raised></pebble-button>
            <pebble-button id="save" class="btn btn-success" button-text="Save" on-tap="_save" elevation=1 raised></pebble-button>
          </div>
        </pebble-accordion>
      </div>
      <liquid-entity-data-get id="entityGetData" name="entityGet" operation="getbyids" request-data="{{_entityGetRequest}}" last-response="{{entitiesResponse}}"></liquid-entity-data-get>
      <liquid-entity-data-get id="entityGetAddData" name="entityGet" operation="getbyids" request-data="{{_entityGetAddRequest}}"
                              last-response="{{relEntitiesResponse}}"></liquid-entity-data-get>

      <liquid-entity-data-save name="attributeSaveDataService" operation="update" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
                               on-response="_onSaveResponse"></liquid-entity-data-save>
      <rock-business-function-dialog id="entityUploadDialog" context-data="[[contextData]]"></rock-business-function-dialog>
      <rock-business-function-dialog id="entityDownloadDialog" context-data="[[contextData]]"></rock-business-function-dialog>
      <rock-business-function-dialog id="entityEditDialog" context-data="[[contextData]]"></rock-business-function-dialog>
      <!--<pebble-dialog id="errorsDialog" dialog-title="Errors on page" alert-box>
        <p>Found below errors in entity details: </p>
        <template is="dom-repeat" items="[[_errorMessages]]" as="error">
          <p>In entity: [[error.fromEntity]]: </p>
          <ul>
            <template is="dom-repeat" items="[[_getAttrMessages(error)]]">
              <li>[[item.attributeName]] with error: [[item.message]]</li>
            </template>
          </ul>
        </template>
        <p>Do you want to fix the errors or continue?</p>
        <div class="buttons">
          <pebble-button dialog-confirm class="btn btn-success" button-text="Fix"></pebble-button>
          <pebble-button dialog-confirm class="btn btn-secondary" on-tap="_skipErrors" button-text="Skip & Continue"></pebble-button>
        </div>
      </pebble-dialog>-->
    </template>
    <div id="messageCard">
    </div>
    <bedrock-pubsub event-name="global-edit" handler="_onGlobalEdit"></bedrock-pubsub>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-where-used-grid',

        properties: {
          /**
           * Indicates the data which is wrapped in the data-source that is used as a grid data.
           * The format for the JSON object is given in the above description.
           */
          data: {
            type: Object,
            notify: true
          },
          /**
           * If set as true , it indicates the component is in read only mode
           */
          readonly: {
              type: Boolean,
              value: false
          },
          /*
           *	Indicates the transformed relationship data for the grid.
           */
          relationshipGridData: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },
          /**
           * Indicates the transformed relationship grid configuration for the grid.
           */
          relationshipGridConfig: {
            type: Object,
            notify: true
          },
          /**
           * Indicates the attribute models.
           */
          attributeModels: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /*
           * Indicates the currently selected relationship type.
           */
          relationship: {
            type: String,
            notify: true
          },
          /*
           * Indicates the title for the selected relationship type.
           */
          relationshipTitle: {
            type: String,
            notify: true
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          rDataFormatter: {
            type:Object,
            notify: true,
            value: function () {
              return this._populateDataForGrid.bind(this);
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          dataObjects: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          relReq: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          contextData: {
            type: Object,
            value: function () {
              return {};
            }
          },
          maxConfiguredCount: {
              type: Number,
              value: function () {
                  return DataObjectFalcorUtil.getPathKeys().dataIndexInfo.entityData.dataSubIndexInfo.data.maxRecordsToReturn;
              }
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          doSyncValidation: {
            type: Boolean,
            value: true
          },
          /*
           */
          _entityGetRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _entityGetAddRequest: {
            type: Object,
            notify: true,
            value: function () {
              return {};
            }
          },
          _isMessageAvailable: {
            type: Boolean,
            value: false
          },
          _liquidTracker: {
            type: Array,
            value: function () {
              return [];
            }
          },
          _loading: {
            type: Boolean,
            value: false
          },
          /**
           * <b><i>Content development is under progress... </b></i>
           */
          messageCodeMapping: {
            type: Object,
            value: function () { return {}; }
          },
          governDataConfig: {
            type: Object,
            computed: '_computeGovernConfig(relationshipGridConfig)'
          },
          _loadGovernData: {
            type: Boolean,
            value: false
          },
          governGridActionsConfig:{
            type:Object
          },
          _clipboardTooltip:{
            type:String,
            value:"Copy to clipboard."
          },
        },

        behaviors: [
          RUFBehaviors.UIBehavior,
          RUFBehaviors.ComponentContextBehavior
        ],

        observers: [
          '_convertIntoEntityLovList(searchResultResponse)'
        ],

        listeners: {
          'editMode': '_onEditMode'
        },

        _currentSelectedLov: null,
        _currentLovItems: null,

        _hasWritePermissions: function (gridConfig) {
          if(gridConfig["hasWritePermission"]) {
            return true;
          }

          return false;
        },
        
        _getAttributeList: function () {
          if (this.relationshipGridConfig) {
            return this.relationshipGridConfig.relationshipTypeAndAttributes;
          }
        },
        _getFromEntityAttributeList: function () {
          var attributes = this._getAttributeList();
          var fromEntityAttributes = [];
          if (attributes && attributes.relatedEntityAttributes) {
            fromEntityAttributes = attributes.relatedEntityAttributes;
          }
          return fromEntityAttributes;
        },
        _getRelationshipTypeTitle: function () {
          if (this.relationshipGridConfig) {
            var config = this.relationshipGridConfig.gridConfig;
            if (config && config.title && config.title != "") {
              return config.title;
            }
          }
          return this.relationship;
        },
        _getRelationshipGridConfig: function () {
          var gridConfig = undefined;
          if (this.relationshipGridConfig) {
            gridConfig = this.relationshipGridConfig.gridConfig;
          }
          return gridConfig;
        },
        _getRelationshipAddRelLovConfig: function () {
          return this.relationshipGridConfig ? this.relationshipGridConfig.addRelLovConfig : undefined;
        },
        _getRelationshipGridRequest: function (relationshipTypeName) {
          var req = DataHelper.cloneObject(this.relReq);

          if (req && relationshipTypeName) {
            var relConfig = this.relationshipGridConfig;
            var relAttr = this._getAttributeList();
            if (relAttr) {
              req.params.fields.relationshipAttributes = relAttr.relationshipAttributes;
              req.params.fields.attributes = relAttr.relatedEntityAttributes;
            }
            if (relConfig && relConfig.direction && relConfig.direction == "up") {
              var itemContext = this.getFirstItemContext();
              req.params.query.filters.typesCriterion = relConfig.fromEntityTypes;
              req.params.query.filters.relationshipsCriterion = [];

              delete req.params.query.ids;

              var relCriterion = {};
              relCriterion[relationshipTypeName] = {};
              relCriterion[relationshipTypeName].relTo = {};
              relCriterion[relationshipTypeName].relTo.id = itemContext.id;
              relCriterion[relationshipTypeName].relTo.type = itemContext.type;

              req.params.query.filters.relationshipsCriterion.push(relCriterion);
            }

            req.params.fields.relationships = [relationshipTypeName];
          }
          return req;
        },
        _getRelationshipAttributeModels: function (relationshipTypeName) {
          var config = this.relationshipGridConfig;
          var attrModels = {};
          if (config) {
            attrModels = config.relationshipAttributeModels;
            var relEntityAttrModels = config.relatedEntityModel.relatedEntityAttributeModels;
            for (var key in relEntityAttrModels) {
              attrModels[key] = relEntityAttrModels[key];
            }
          }
          return attrModels;
        },
        _getRelatedEntityContexts: function () {
          var config = this.relationshipGridConfig;
          var relatedEntityContexts;
          if (config) {
            relatedEntityContexts = config.relatedEntityModel.relatedEntityContexts;
          }
          return relatedEntityContexts;
        },
        _populateDataForGrid: function (respData) {
          var data = [];
          var itemContext = this.getFirstItemContext();

          if (respData && itemContext) {
            var currentEntityId = itemContext.id;
            if (respData.content && respData.content.entities && currentEntityId) {
              var entities = respData.content.entities;
              if (entities && entities.length > 0) {
                entities.forEach(function (entity) {
                  this.dataObjects.push(entity);
                  var record = {};
                  record["From Entity"] = record["id"] = entity.id;
                  record["Entity Type"] = entity.type;
                  record["type"] = entity.type;

                  var currentRel = "";
                  var isSelfContext = false;
                  if (event.detail.request) {
                    currentRel = event.detail.request.requestData.params.fields.relationships[0];
                  }

                  var relConfig = this.relationshipGridConfig;
                  if (relConfig) {
                    isSelfContext = relConfig.selfContext;
                  }

                  var relationships = EntityHelper.getRelationshipsBasedOnContext(entity, this.getFirstDataContext(), isSelfContext);
                  if (!_.isEmpty(relationships)) {
                    var relatedEntities = relationships[currentRel];

                    relatedEntities.forEach(function (relItem) {
                      if (relItem) {
                        record["Relationship Id"] = relItem.id;
                        if (relItem.relTo && relItem.relTo.id == currentEntityId) {
                          if (relItem.attributes) {
                            Object.keys(relItem.attributes).forEach(function (item) {
                              if (item && relItem.attributes[item]) {
                                record[item] = relItem.attributes[item].values[0].value;
                              }
                            }, this);
                          }
                        }
                      }
                    }, this);
                  }

                  var attributes = EntityHelper.getAllAttributes(entity);
                  if (attributes) {
                    Object.keys(attributes).forEach(function (attrItem) {
                      if (attrItem && attributes[attrItem]) {
                        record[attrItem] = attributes[attrItem].values[0].value;
                      }
                    }, this);
                  }

                  data.push(record);
                }, this);
              }
            }
          }
          return data;
        },
        //TODO: Add new in where used has not been implemented yet. Need below code to start on that.
        // _onAddPopoverClick: function (e) {
        //   var popover = Polymer.dom(this).node.shadowRoot.querySelector("pebble-popover[for=" + e.currentTarget.id + "]");
        //   this._currentSelectedLov = Polymer.dom(this).node.shadowRoot.querySelector('rock-entity-lov[id=' + e.currentTarget.id + ']');

        //   popover.show();
        // },
        // _convertIntoEntityLovList: function (entitiesResponse) {
        //   if (entitiesResponse) {
        //     var items = [];
        //     var selectedItems = [];

        //     if (entitiesResponse.content && entitiesResponse.content.entities) {
        //       var entities = entitiesResponse.content.entities;
        //       entities.forEach(function (item) {
        //         if (item) {
        //           //TODO: this code has to be enhanced for based on config.
        //           var attributes = EntityHelper.getAllAttributes(item);
        //           items.push({
        //             "id": item.id,
        //             "title": item.id,
        //             "subtitle": item.type,
        //             "image": "/src/images/lookup-item.jpg"
        //           });
        //         }
        //       }, this);
        //     }

        //     if (this._currentSelectedLov) {
        //       var relGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid[id=' + this._currentSelectedLov.id + ']');
        //       var relGridData = [];
        //       if (relGrid) {
        //         relGridData = relGrid.getData();
        //       }

        //       this._currentSelectedLov.items = items;
        //       this._currentSelectedLov.selectedItems = relGridData;
        //       this._currentLovItems = items;
        //     }
        //   }
        // },
        // _onLovConfirmButtonTapped: function (event) {
        //   if (event.detail) {

        //     var lov = this.shadowRoot.querySelector("rock-entity-lov[id=" + event.detail.data.id + "]");

        //     var oldSelectedItemIds = [];
        //     var selectedItemIds = [...new Set(lov.selectedItems.map((obj) => obj.id))];
        //     var newItemIds = [];

        //     // TO-DO Pebble-LOV has to handle this filteration.
        //     var currentRelGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid[id=' + event.detail.data.id + ']');
        //     if (currentRelGrid) {
        //       var data = currentRelGrid.getData();
        //       data.forEach(function (item) {
        //         if (item) {
        //           oldSelectedItemIds.push(item.id);
        //         }
        //       }, this);
        //     }

        //     selectedItemIds.forEach(function (item) {
        //       if (item && oldSelectedItemIds.indexOf(item) < 0) {
        //         newItemIds.push(item);
        //       }
        //     }, this);

        //     this._addRelatedEntity(event.detail.data.id, newItemIds);
        //   }
        // },
        // _onLovCloseButtonTapped: function (event) {
        //   if (event.detail) {
        //     var currentLovPopover = Polymer.dom(this).node.shadowRoot.querySelector('pebble-popover[for=' + event.detail.data.id + ']');

        //     if (currentLovPopover) {
        //       currentLovPopover.hide();
        //     }
        //   }
        // },
        // _addRelatedEntity: function (relationshipType, entityIds) {
        //   if (entityIds && entityIds.length > 0) {
        //     var popover = Polymer.dom(this).node.shadowRoot.querySelector("pebble-popover[for=" + relationshipType + "]");
        //     this._currentRelationshipItem = relationshipType;

        //     var relatedEntityContexts = this._getRelatedEntityContexts(this._currentRelationshipItem);
        //     var typesCriterion = [];
        //     var contexts = [];
        //     var attributes = this._getFromEntityAttributeList(this._currentRelationshipItem);

        //     if (relatedEntityContexts) {
        //       relatedEntityContexts.forEach(function (relContexts) {
        //         if (relContexts) {
        //           typesCriterion.push(relContexts.relEntityType);
        //           if (relContexts.relContexts) {
        //             relContexts.relContexts.forEach(function (ctxItem) {
        //               contexts.push(ctxItem);
        //             }, this);
        //           }
        //         }
        //       }, this);
        //     }

        //     var valueContext = this.getFirstValueContext();

        //     //TODO-dimensions has to be set in req. same like did in relationship-manage
        //     var req = {
        //       "params": {
        //         "query": {
        //           "contexts": contexts,
        //           "valueContexts": [valueContext],
        //           "ids": entityIds,
        //           "filters": {
        //             "typesCriterion": typesCriterion
        //           }
        //         },
        //         "fields": {
        //           "ctxTypes": [
        //             "properties"
        //           ],
        //           "attributes": attributes
        //         },
        //         "options": {
        //           "maxRecords": 10
        //         }
        //       }
        //     };

        //     this.set('_entityGetAddRequest', req);
        //     var relAddLiquid = Polymer.dom(this).node.shadowRoot.querySelector('liquid-entity-data-get[id="entityGetAddData"]');
        //     if (relAddLiquid) {
        //       relAddLiquid.generateRequest();
        //     }
        //     popover.hide();
        //   }
        // },
        // _addRelationship: function () {
        //   if (this.relEntitiesResponse) {
        //     var relGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid[id=' + this._currentRelationshipItem + ']');

        //     if (relGrid) {
        //       var relData = [];
        //       if (this.relEntitiesResponse.content && this.relEntitiesResponse.content.entities) {
        //         var entities = this.relEntitiesResponse.content.entities;
        //         var relGridData = relGrid.getData();
        //         entities.forEach(function (relItem) {
        //           if (relItem) {
        //             var attributes = EntityHelper.getAllAttributes(relItem);
        //             var record = {};
        //             if (attributes) {
        //               Object.keys(attributes).forEach(function (attrItem) {
        //                 if (attrItem && attributes[attrItem]) {
        //                   record[attrItem] = attributes[attrItem].values[0].value;
        //                 }
        //               }, this);
        //             }
        //             record['From Entity'] = record['id'] = relItem.id;
        //             record['type'] = relItem.type;
        //             record['properties'] = relItem.properties;
        //             record['relationshipType'] = this._currentRelationshipItem;
        //             relData.push(record);
        //           }
        //         }, this);
        //       }
        //       relGrid.addNewRecords(relData);
        //     }
        //   }
        // },
        _onEditMode: function (e) {
          var relDiv = this.shadowRoot.querySelector('div[id=relContainer_' + this.relationship + ']');
          if (relDiv) {
            relDiv.hidden = false;

            var buttonContainer = Polymer.dom(relDiv).node.querySelector("div[id='buttonContainer']");
            buttonContainer.hidden = false;
          }
        },
        _save: function (e) {
          var currentRel = this.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          var entityId = DataHelper.getParamValue('id');
          var relConfig = this.relationshipGridConfig;
          var utils = SharedUtils.DataObjectFalcorUtil;

          if (currentRelGrid && relConfig) {
            var gridData = currentRelGrid.getModifiedData();
            var originalEntities = [];

            if (this.dataObjects && this.dataObjects.length > 0) {
              gridData.forEach(function (data) {
                var entities = this.dataObjects.filter(function (element) {
                  if (element != undefined) {
                    if (data["From Entity"] == element.id) {
                      return element;
                    }
                  }
                });

                var entity = entities && entities.length ? entities[0] : undefined;

                if (entity) {
                  var relationships = EntityHelper.getRelationshipByType(entity, this.getFirstDataContext(), currentRel, relConfig.selfContext);
                  var relAndFromEntityAttributes = this._getAttributeList();
                  var valueContext = this.getFirstValueContext();

                  var totalRel = relationships.length;
                  var relObject;

                  if (relationships) {
                    relationships.forEach(function (relItem) {
                      if (relItem.relTo && relItem.relTo.id == entityId) {
                        relObject = relItem;
                      }
                    }, this);
                  }

                  if (relObject) {
                    var relAttributes = relObject.attributes ? relObject.attributes : relObject.attributes = {};

                    relAndFromEntityAttributes.relationshipAttributes.forEach(function (relAttr) {
                      if (relAttr) {
                        var relAttribute = relAttributes ? relAttributes[relAttr] : undefined;
                        if (relAttribute) {
                          relAttribute.values[0].value = data[relAttr];
                        } else {
                          if (data[relAttr]) {
                            relAttributes[relAttr] = {};
                            relAttributes[relAttr].values = [{
                              "value": data[relAttr],
                              "source": valueContext.source,
                              "locale": valueContext.locale
                            }];
                          }
                        }
                      }
                    }, this);
                  }
                  originalEntities.push(entity);
                }
              }, this);
            }
          }

          this._saveRequest = {
            "entities": originalEntities,
            "operation": "whereUsed"
          };

          //TODO: Sync validation has been commited for now since ther is no BR on relationship attributes.
          // if (this.doSyncValidation) {
          //   if (originalEntities && originalEntities.length) {

          //     originalEntities.forEach(function (originalEntity) {
          //       var liquidRestElement = document.createElement("liquid-rest");
          //       var req = DataRequestHelper.createSyncValidationRequest(originalEntity.id, originalEntity.type, originalEntity.data);

          //       liquidRestElement.requestData = req;
          //       liquidRestElement.url = "/data/pass-through/entitygovernservice/validate";
          //       liquidRestElement.method = "POST";
          //       liquidRestElement.addEventListener("liquid-response", this._onEntityGovernResponse.bind(this));
          //       liquidRestElement.addEventListener("liquid-error", this._onEntityGovernFailed.bind(this));

          //       this._liquidTracker.push(originalEntity.id);
          //       liquidRestElement.generateRequest();
          //     }, this);
          //   }
          // } else {
          this._saveEntity();

        },

        _saveEntity: function () {
          var liquidSave = this.shadowRoot.querySelector("[name=attributeSaveDataService]");
          if (liquidSave) {
            liquidSave.generateRequest();
          }
        },
        _onSaveResponse: function () {
          //TO-DO will get changed
          var mainApp = document.querySelector('#app');
          mainApp.toastText = "Relationships saved successfully.";
          var toastElement = mainApp.shadowRoot.querySelector("#pebbleAppToast");
          toastElement.toastType = "success";
          toastElement.heading = "Success";
          toastElement.autoClose = true;

          toastElement.show();

          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');

          if (currentRelGrid) {
            this._changeRelationshipToReadMode();
            currentRelGrid.changeToReadMode();
          }
        },
        _revertAll: function (e) {
          var currentRel = this.relationship;
          var currentRelGrid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
          if (currentRelGrid) {
            if (currentRelGrid.getIsDirty()) {
              currentRelGrid.openGridMsgDialog(currentRel +
                      " relationship has unsaved changes. Do you wants to revert those ?");
            } else {
              currentRelGrid.changeToReadMode();
              this._changeRelationshipToReadMode();
            }
          }
        },
        _setRelGridDataSource: function () {
          var repeat = this.shadowRoot.querySelector('template[is="dom-repeat"]');

          if (repeat) {
            repeat.addEventListener("dom-change", function (event) {
              var relDivs = this.parentNode.querySelectorAll('div[id^=relContainer_]');

              if (relDivs && relDivs.length > 0) {
                for (var i in relDivs) {
                  var item = relDivs[i];
                  if (typeof item === 'object') {
                    var relGrid = item.querySelector('rock-grid');
                    var dataSourceElement = item.querySelector('entity-search-grid-datasource');

                    if (relGrid && dataSourceElement) {
                      relGrid.dataSource = dataSourceElement.dataSource;

                      dataSourceElement.addEventListener('current-record-size-changed', function (e) {
                        this.gridDataSize = e.currentTarget.bufferRecordSize;
                      }.bind(relGrid));

                      dataSourceElement.addEventListener('total-records-changed', function (e) {
                        this.currentRecordSize = e.currentTarget.currentRecordSize;
                      }.bind(relGrid));
                    }
                  }
                }
              }
            });
          }
        },
        _onDialogOk: function (e) {
          if (this.relationship) {
            var relGrid = this.shadowRoot.querySelector('rock-grid[id=' + this.relationship + ']');
            if (relGrid) {
              this._changeRelationshipToReadMode();
              relGrid.revertData();
            }
          }
        },
        _changeRelationshipToReadMode: function () {
          if (this.relationship) {
            var relDiv = this.shadowRoot.querySelector('div[id=relContainer_' + this.relationship + ']');

            if (relDiv) {
              var buttonContainer = Polymer.dom(relDiv).node.querySelector("div[id='buttonContainer']");
              buttonContainer.hidden = true;
            }

          }
        },
        _onDownload: function (e) {
          var rockGrid = this.shadowRoot.querySelector('rock-grid');
          var selectedItems = rockGrid.getSelectedItems();

          if (selectedItems && selectedItems.length && this.contextData) {
            var entityDownloadDialog = this.shadowRoot.querySelector("#entityDownloadDialog");
            entityDownloadDialog.name = "rock-entity-download";
            entityDownloadDialog.sharedData = { "context-data": this.contextData,
              "selected-entities": selectedItems };
            entityDownloadDialog.open();
          } else {
            this.showInformationToast("Please select at least one entity from grid to download.");
          }
        },
        _onCOPDownloadFailure: function (error) {
          this.showErrorToast("Failed to download entity data. Please contact administrator: " + error);
          this._loading = false;
        },
        _onUpload: function (e, detail) {
          var entityUploadDialog = this.shadowRoot.querySelector("#entityUploadDialog");
          if(entityUploadDialog) {
            entityUploadDialog.name = "rock-entity-upload";
            entityUploadDialog.sharedData = { "context-data": this.contextData };
            entityUploadDialog.open();
          }
        },
        _computeGovernConfig: function(relationshipGridConfig) {
          if(relationshipGridConfig) {
            return relationshipGridConfig.governDataConfig;
          }
        },
        _showToggle: function(governDataConfig) {
          if(governDataConfig && governDataConfig.showGovernDataToggle) {
            return true;
          }
          return false;
        },
        _onGovernGridActionTap: function (e, detail) {
          detail.data.relationship = this.relationship;
          this.fireBedrockEvent("govern-grid-action-click", detail);
        },
        _loadActions: function(_loadGovernData, governGridActionsConfig) {
          if(_loadGovernData && governGridActionsConfig.enableActions) {
            return true;
          }
          return false;
        },
        _onMouseoutCopyAction: function(){
          this.set("_clipboardTooltip", "Copy to clipboard.");
        },
        _onTapCopyAction: function(ev){
            var currentRel = this.relationship;
            var grid = this.shadowRoot.querySelector('rock-grid[id=' + currentRel + ']');
            if (grid) {
              var selectedItems = grid.getSelectedItems();
              if (selectedItems && selectedItems.length) {
                
                  var delimeter = ",";
                  if(this.relationshipGridConfig.copyActionConfig.delimeter){
                    delimeter = this.relationshipGridConfig.copyActionConfig.delimeter;
                  }
                  var _attr = "";
                  if(this.relationshipGridConfig.copyActionConfig.attributeField){
                    _attr = this.relationshipGridConfig.copyActionConfig.attributeField;
                  }
                  var copyString = "";
                  selectedItems.forEach(element => {
                    if(element && element.id){
                      if(_attr && element[_attr]){
                        copyString += element[_attr] + delimeter;
                      }
                    }
                  });
                  if(copyString){
                    var tempTextArea = document.createElement("textarea");
                    tempTextArea.id = "clipboard_textarea";
                    var finalCopyString = copyString.substr(0, copyString.length-delimeter.length);
                    tempTextArea.innerText = finalCopyString;
                    tempTextArea.select();
                    document.execCommand("Copy");
                    this.set("_clipboardTooltip", "Copied!");
                  }
                
              } else {
                this.showInformationToast("Please select at least one relationship from grid to copy.");
              }
            }
        },
        getSelectedItems: function() {
          var grid;
          if(this._loadGovernData) {
            grid = this.shadowRoot.querySelector("rock-govern-data-grid[id=" + this.relationship + "]");
          } else {
            grid = this.shadowRoot.querySelector("rock-grid[id=" + this.relationship + "]");
          }

          if (grid) {
            return grid.getSelectedItems();
          }
        },
        getControlIsDirty: function () {
          var rockGridObj = this.$$("rock-grid");
          var rockGovernGridObj = this.$$("rock-govern-data-grid");
          if (rockGridObj && rockGridObj.getControlIsDirty) {
            return rockGridObj.getControlIsDirty();
          } else if (rockGovernGridObj && rockGovernGridObj.getControlIsDirty){
            return rockGovernGridObj.getControlIsDirty();
          }
        },

        refresh: function (){
          var rockGridObj = this.$$("rock-grid");
          var rockGovernGridObj = this.$$("rock-govern-data-grid");
          if (rockGridObj && rockGridObj.refresh) {
            rockGridObj.refresh();
          } else if(rockGovernGridObj && rockGovernGridObj.refresh) {
            rockGovernGridObj.refresh();
          }
        },
        _governGridRefresh: function () {
          var grid = this.shadowRoot.querySelector("rock-govern-data-grid[id=" + this.relationship + "]");

          if (grid && grid.reRenderGrid) {
            grid.reRenderGrid();
          }
        },
        _onBulkEdit: function(e, detail) {
          var grid = this.shadowRoot.querySelector("rock-grid[id=" + this.relationship + "]");
          var selectedItems = grid.getSelectedItems();
          var selectionMode = grid.getSelectionMode();
          var selectionQuery = grid.getSelectedItemsAsQuery();
          if(selectedItems && selectedItems.length && this.contextData) {
            var itemContexts = [];
            var typesCriterion = this.relationshipGridConfig.fromEntityTypes;
            if(typesCriterion && typesCriterion.length) {
              for(var i=0; i<typesCriterion.length; i++) {
                var type = typesCriterion[i];
                if(!(itemContexts.find(obj => obj.type === type))) {
                  var itemContext = { "type": type };
                  itemContexts.push(itemContext);
                }
              }
            }
            var clonedContextData = DataHelper.cloneObject(this.contextData);
            clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
            var entityEditDialog = this.shadowRoot.querySelector("#entityEditDialog");
            entityEditDialog.name = "rock-wizard-entity-bulk-edit";
            entityEditDialog.configName = "wizardConfig";
            entityEditDialog.sharedData = {
              "context-data": clonedContextData,
              "selection-query": selectionQuery,
              "selection-mode": selectionMode,
              "selected-entities": selectedItems,
              "edit-attributes-only": true,
              "edit-relationship-attributes-only": false
            };
            entityEditDialog.open();
          } else {
            this.showInformationToast("Please select at least one entity from grid to edit.");
          }
        },

        _onGlobalEdit(e) {
          var relGrid = this.$$(`#${this.relationship}`);

          if (relGrid) {
              relGrid.changeToEditMode();
          }
        }

        // _requestForAddRelationshipList: function (relationship) {
        //   var relatedEntityContexts = this._getRelatedEntityContexts(relationship);
        //   var attributes = this._getFromEntityAttributeList(relationship);

        //   var typesCriterion = [];
        //   var contexts = [];

        //   if (relatedEntityContexts) {
        //     relatedEntityContexts.forEach(function (relContext) {
        //       if (relContext) {
        //         typesCriterion.push(relContext.relEntityType);
        //         if (relContext.relContexts) {
        //           relContext.relContexts.forEach(function (ctxItem) {
        //             contexts.push(ctxItem);
        //           }, this);
        //         }
        //       }
        //     }, this);

        //     var valueContext = this.getFirstValueContext();

        //     var req = {
        //       "params": {
        //         "query": {
        //           "contexts": contexts,
        //           "valueContexts": [valueContext],
        //           "filters": {
        //             "attributesCriterion": [],
        //             "typesCriterion": typesCriterion
        //           }
        //         },
        //         "fields": {
        //           "ctxTypes": [
        //             "properties"
        //           ],
        //           "attributes": attributes,
        //           "relationships": []
        //         },
        //         "options": {
        //           "from": 0,
        //           "to": 0
        //         }
        //       }
        //     };

        //     return req;
        //   } else {
        //     var messageDiv = this.$.messageCard;
        //     if (messageDiv) {
        //       messageDiv.textContent = "Relationships are not configured for current entity type: " + this.relationshipTitle;
        //       this._isMessageAvailable = true;
        //     }
        //   }
        // },
        // _getIdField: function (relationship) {
        //   var idField = "";
        //   var addRelLovConfig = this._getRelationshipAddRelLovConfig(relationship);
        //   if (addRelLovConfig) {
        //     idField = addRelLovConfig.idField;
        //   }
        //   return idField;
        // },
        // _getTitlePattern: function (relationship) {
        //   var titlePattern = "";
        //   var addRelLovConfig = this._getRelationshipAddRelLovConfig(relationship);
        //   if (addRelLovConfig) {
        //     titlePattern = addRelLovConfig.titlePattern;
        //   }
        //   return titlePattern;
        // },
        // _getAttrMessages: function(error) {
        //   return error.attrErrorMessages;
        // }
      });
    })();
  </script>
</dom-module>