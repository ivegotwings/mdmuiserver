<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../rock-content-view/rock-content-view.html">

<!--
` <rock-content-view-manager> ` Manages content views.

@demo demo/index.html 
-->

<dom-module id="rock-content-view-manager">
  <template>
    <style include="shared-styles">
      :host {
        
      }
      #contentViewManager {
        height: 100%;
        background-color: white;
      }
      [hidden] {
				display: none !important;
			}
    </style>
    <div id="contentViewManager" >
    </div>
    
          <!--_openStack: <span id="openStack1">[[_openStack]]</span><br>
          _activeStack: <span id="activeStack1">[[_activeStack]]</span><br>
          _minimizeStack: <span id="minimizeStack1">[[_minimizeStack]]</span><br>-->
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rock-content-view-manager',
        
        properties: {
          /**
           * Indicates the configuration for the content-view.
           * 
					 */
          views: {
            type: Object,
            value: function(){
              return {};
            },
            observer: '_viewsChanged'
          },

          currentViewName: {
            type: String
          },

          _openStack: {
            type: Array,
            value: function() {
              return [];
            }
          },

          _minimizeStack: {
            type: Array,
            value: function() {
              return [];
            }
          },

          _activeStack: {
            type: Array,
            value: function() {
              return [];
            }
          }
        },

        _viewsChanged: function(){

        },

        openView: function(viewName, config) {
          if(viewName) {
            if(viewName != this.currentViewName) {

              //raise event - TODO: allow cancel?
              this.fire('open', {"viewName": viewName, "contentView": undefined, "config": config});

              var openSuccessful = false;
              //check for existing
              if(this.views[viewName]) {
                var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
                if(contentView) {
                  this.showView(viewName);
                  
                  //manage viewstack
                  if(this._activeStack[this._activeStack.length - 1] != viewName) {
                    this._takeOutFromStack(this._minimizeStack, viewName);
                    this._takeOutFromStack(this._activeStack, viewName);
                    this._activeStack.push(viewName);
                  }
                  
                  openSuccessful = true;
                }
              }
              else {
                //if no existing, create new
                var contentView = document.createElement('rock-content-view');
                contentView.name = viewName;
                contentView.setAttribute("name", viewName);
                contentView.component = config.component;
                contentView.title = config.title;
                contentView.icon = config.icon;
                contentView.manager = this;
                contentView.render();
                this.$.contentViewManager.appendChild(contentView);

                this.views[viewName] = contentView;//TODO: this is not really needed, we will see
                
                //manage viewstack
                this._activeStack.push(viewName);
                this._openStack.push(viewName);

                openSuccessful = true;
              }
              //hide current view
              if(openSuccessful) {
                if(this.currentViewName) {
                  this.hideView(this.currentViewName);
                  //this.minimizeView(this.currentViewName, true /*dontOpenPrevious*/);
                }
                this.currentViewName = viewName;
              }
          
            }
          }
          else {
            //TODO: viewname not given
          }
        },

        closeView: function(viewName) {
          if(viewName) {

            
            var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {
              
              //raise event - TODO: allow cancel?
              this.fire('close', {"viewName": viewName, "contentView": contentView, "config": undefined});
              
              this.$.contentViewManager.removeChild(contentView);
              delete this.views[viewName];

              //manage viewstack
              this._takeOutFromStack(this._activeStack, viewName);
              this._takeOutFromStack(this._openStack, viewName);
              this._takeOutFromStack(this._minimizeStack, viewName);

              //show previous view when the current one is closed
              if(this._activeStack.length > 0 && this.currentViewName == viewName) {
                this.currentViewName = "";
                this.openView(this._activeStack[this._activeStack.length - 1]);
              }
              else {
                //TODO: no views to show, should go back to dashboard
              }
            }
            else {
              //TODO: contentview not found for the given view name
            }
          }
          else {
            //TODO: viewname not given
          }
        },

        minimizeView: function(viewName) {
          if(viewName) {
            var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {

              //raise event - TODO: allow cancel?
              this.fire('minimize', {"viewName": viewName, "contentView": contentView, "config": undefined});              
              
              this.hideView(viewName);

              //manage viewstack
              this._minimizeStack.push(viewName);
              this._takeOutFromStack(this._activeStack, viewName);//ideally a pop, will change soon
              //show previous view when the current one is closed
              if(this._activeStack.length > 0) {
                this.openView(this._activeStack[this._activeStack.length - 1]);
              }
              else {
                //TODO: no views to show, should go back to dashboard
              }
            }
            else {
              //TODO: contentview not found for the given view name
            }
          }
          else {
            //viewname not given
          }
        },

        _takeOutFromStack: function(stack, viewName) {
          var viewIndex;
          for(var i=0; i<stack.length;i++) {
            if(stack[i] == viewName) {
              viewIndex = i;
            }
          }
          stack.splice(viewIndex, 1);
        },

        hideView: function(viewName) {
          if(viewName) {
            var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {
              contentView.setAttribute("hidden", "");
            }
          }
        },

        showView: function(viewName) {
          if(viewName) {
            var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {
              contentView.removeAttribute("hidden");
            }
          }
        }

      });
    })();
  </script>

</dom-module>