<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-content-view/rock-content-view.html">

<!--
` <rock-content-view-manager> ` Represents an element that manages the various content views.

@demo demo/index.html 
-->

<dom-module id="rock-content-view-manager">
  <template>
    <style include="pebble-styles-shared">
      #contentViewManager {
        height: 100%;
        background-color: white;
      }
      [hidden] {
				display: none !important;
			}
    </style>
    <div id="contentViewManager" >
    </div>
    
          <!--_openStack: <span id="openStack1">[[_openStack]]</span><br>
          _activeStack: <span id="activeStack1">[[_activeStack]]</span><br>
          _minimizeStack: <span id="minimizeStack1">[[_minimizeStack]]</span><br>-->
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rock-content-view-manager',
        
        properties: {
          _views: {
            type: Object,
            value: function(){
              return {};
            }
          },
          /**
           * Indicates the name of the view which is currently open.
					 */
          currentViewName: {
            type: String
          },

          _openStack: {
            type: Array,
            value: function() {
              return [];
            }
          },

          _minimizeStack: {
            type: Array,
            value: function() {
              return [];
            }
          },

          _activeStack: {
            type: Array,
            value: function() {
              return [];
            }
          }
        },

          getViewNameWithQueryParams: function (queryParams, viewName) {
              if (queryParams && !isEmpty(queryParams)) {
                  var queryString = JSON.stringify(queryParams).replace(/"|{|}\s*/g, "").replace(/:\s*/g, "-");
                  viewName += queryString;
              }
              return viewName;
          }, /**
        * Can be used to open a view with the given name and configuration.
        * If a view with the same name was already opened, then same view is opened again.
        * @param {string} viewName The name of the view to be opened.
        * @param {string} config The configuration JSON for the new view. 
        * Sample config JSON: 
        * {
        *     "name": "entity-discovery",
        *     "title": "Entity Search & Discovery",
        *     "data_route": "entity-discovery",
        *     "icon": "pebble-icons:search",
        *     "href": "/entity-discovery",
        *     "nonClosable": true,
        *     "nonMinimizable": true,
        *     "component": {
        *         "name": "app-entity-discovery",
        *         "path": "../../src/elements/app-entity-discovery/app-entity-discovery.html",
        *         "properties": {
        *         }
        *     }
        *}
        */
        openView: function(viewName, config,queryParams) {
            var path=viewName;
            viewName = this.getViewNameWithQueryParams(queryParams, viewName);
            if(viewName) {
              if(viewName != this.currentViewName) {

              //raise event - TODO: allow cancel?
              this.fire('open', {"viewName": viewName, "contentView": undefined, "config": config});

              var openSuccessful = false;
              //check for existing
              if(this._views[viewName]) {
                var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
                if(contentView) {
                  this._showView(viewName);
                  
                  //manage viewstack
                  if(this._activeStack[this._activeStack.length - 1] != viewName) {
                    this._takeOutFromStack(this._minimizeStack, viewName);
                    this._takeOutFromStack(this._activeStack, viewName);
                    this._activeStack.push(viewName);
                  }
                  
                  openSuccessful = true;
                }
              }
              else {
                //if no existing, create new
                var contentView = document.createElement('rock-content-view');
                contentView.name = viewName;
                contentView.setAttribute("name", viewName);
                contentView.component = config.component;
                contentView.title = config.title;
                contentView.icon = config.icon;
                contentView.nonClosable = config.nonClosable;
                contentView.nonMinimizable = config.nonMinimizable;
                contentView.manager = this;
                contentView.queryParams=queryParams;
                contentView.path=path;
                contentView.render();
                this.$.contentViewManager.appendChild(contentView);

                this._views[viewName] = contentView;//TODO: this is not really needed, we will see

                //manage viewstack
                this._activeStack.push(viewName);
                this._openStack.push(viewName);

                openSuccessful = true;
              }
              //hide current view
              if(openSuccessful) {
                if(this.currentViewName) {
                  this._hideView(this.currentViewName);
                  //this.minimizeView(this.currentViewName, true /*dontOpenPrevious*/);
                }
                this.currentViewName = viewName;
              }
          
            }
          }
          else {
            //TODO: viewname not given
          }
        },

        /**
        * Can be used to close a view with the given name.
        * @param {string} viewName The name of the view to be opened.
        */
        closeView: function(viewName,queryParams) {
          if(viewName) {
              viewName = this.getViewNameWithQueryParams(queryParams, viewName);
              var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {
              
              //raise event - TODO: allow cancel?
              this.fire('close', {"viewName": viewName, "contentView": contentView, "config": undefined});
              
              this.$.contentViewManager.removeChild(contentView);
              delete this._views[viewName];

              //manage viewstack
              this._takeOutFromStack(this._activeStack, viewName);
              this._takeOutFromStack(this._openStack, viewName);
              this._takeOutFromStack(this._minimizeStack, viewName);

              //show previous view when the current one is closed
               if(this.currentViewName == viewName){
                   this.currentViewName = "";
                   if(this._activeStack.length > 0 ) {
                       this._navigateToLastOpenedContentView();
                   }
                   else {
                       this._changeRoute("");
                   }
               }
            }
            else {
              //TODO: contentview not found for the given view name
            }
          }
          else {
            //TODO: viewname not given
          }
        },

        /**
        * Can be used to minimize a view with the given name.
        * @param {string} viewName The name of the view to be opened.
        */
        minimizeView: function(viewName,queryParams) {
          if(viewName) {
              viewName = this.getViewNameWithQueryParams(queryParams, viewName);
              var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {

              //raise event - TODO: allow cancel?
              this.fire('minimize', {"viewName": viewName, "contentView": contentView, "config": undefined});
              
              this._hideView(viewName);

              //manage viewstack
              this._minimizeStack.push(viewName);
              this._takeOutFromStack(this._activeStack, viewName);//ideally a pop, will change soon
              this.currentViewName = "";
              //show previous view when the current one is closed
              if(this._activeStack.length > 0) {
                  this._navigateToLastOpenedContentView();
              }
              else {
                //TODO: no views to show, should go back to dashboard
                  this._changeRoute("");
              }
            }
            else {
              //TODO: contentview not found for the given view name
            }
          }
          else {
            //viewname not given
          }
        },

        _takeOutFromStack: function(stack, viewName) {
          var viewIndex;
          for(var i=0; i<stack.length;i++) {
            if(stack[i] == viewName) {
              viewIndex = i;
            }
          }
          stack.splice(viewIndex, 1);
        },

        _hideView: function(viewName) {
          if(viewName) {
            var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {
              contentView.setAttribute("hidden", "");
            }
          }
        },

        _showView: function(viewName) {
          if(viewName) {
            var contentView = this.$.contentViewManager.querySelector('rock-content-view[name='+viewName+']');
            if(contentView) {
              contentView.removeAttribute("hidden");
            }
          }
        },
        _changeRoute: function (path,queryParams) {
              if(!queryParams) {
                  queryParams={};
              }
              
              var mainApp = document.querySelector("main-app");

              if(mainApp) {
                  mainApp.set("pageRoute.__queryParams", queryParams);

                  if (path != mainApp.pageRoute.path) {
                      mainApp.changePageRoutePath(path);
                  }
              }
        },
        _navigateToLastOpenedContentView: function () {
            var lastOpenedContentView=this.$.contentViewManager.querySelector('rock-content-view[name='+this._activeStack[this._activeStack.length - 1]+']');
            this._changeRoute(lastOpenedContentView.path,lastOpenedContentView.queryParams);
        },
        /** 
        * Can be used to get if the current content view is dirty.
        */
        getIsDirty: function() {
          if(this.currentViewName) {
            var currenttView = this.$.contentViewManager.querySelector('rock-content-view[name='+this.currentViewName+']');
          }
          if(currenttView){
            var content = currenttView.$.content;
            if (content && content.firstElementChild && content.firstElementChild.getIsDirty) {
                var isDirty = content.firstElementChild.getIsDirty();
                return isDirty;
            }
          }
        },

        /**
         * Fired when a `rock-content-view` is opened.
         *
         * @event 'open'
         * @param {{text: object}} the object has child properties for viewName, config object.
         */

         /**
         * Fired when a `rock-content-view` is closed.
         *
         * @event 'close'
         * @param {{text: object}} the object has child properties for viewName, contentView object.
         */

         /**
         * Fired when a `rock-content-view` is minimized.
         *
         * @event 'minimize'
         * @param {{text: object}} the object has child properties for viewName, contentView object.
         */

      });
    })();
  </script>

</dom-module>