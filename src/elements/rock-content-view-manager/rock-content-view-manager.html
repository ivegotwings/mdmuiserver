<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../rock-content-view/rock-content-view.html">

<!--
` <rock-content-view-manager> ` Represents an element that manages the various content views.

@demo demo/index.html 
-->

<dom-module id="rock-content-view-manager">
  <template>
    <style include="bedrock-style-common">
      #contentViewManager {
        height: 100%;
        background-color:var(--white, #fff);
      }
      
      [hidden] {
        display: none !important;
      }
    </style>
    <div id="contentViewManager">
        <!--<rock-content-view id="contentView"></rock-content-view>-->
    </div>

    <!--_openStack: <span id="openStack1">[[_openStack]]</span><br>
          _activeStack: <span id="activeStack1">[[_activeStack]]</span><br>
          _minimizeStack: <span id="minimizeStack1">[[_minimizeStack]]</span><br>-->
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-content-view-manager',

        properties: {
          _views: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
           * Indicates the name of the view which is currently open.
					 */
          currentViewName: {
            type: String
          },

          _openStack: {
            type: Array,
            value: function () {
              return [];
            }
          },

          _minimizeStack: {
            type: Array,
            value: function () {
              return [];
            }
          },

          _activeStack: {
            type: Array,
            value: function () {
              return [];
            }
          }
        },
        /**
        * Can be used to open a view with the given name and configuration.
        * If a view with the same name is already opened, then same view is opened again.
        * @param {string} viewName The name of the view to be opened.
        * @param {string} config The configuration JSON for the new view. 
        * Sample config JSON: 
        * {
        *     "name": "entity-discovery",
        *     "title": "Entity Search & Refine",
        *     "data_route": "entity-discovery",
        *     "icon": "pebble-icons:search",
        *     "href": "/entity-discovery",
        *     "nonClosable": true,
        *     "nonMinimizable": true,
        *     "component": {
        *         "name": "app-entity-discovery",
        *         "path": "../../src/elements/app-entity-discovery/app-entity-discovery.html",
        *         "properties": {
        *         }
        *     }
        *}
        */
        openView: function (viewName, config,queryParams,action) {
          var path = viewName;
          var contentView;
          viewName = ComponentHelper.getViewNameWithQueryParams(queryParams, viewName);

          if(!viewName) return;
          //Where rendering is going on, there is an issue closing and opening an app. So, we are making sure that it is flushed
          Polymer.dom.flush();

          if(viewName === this.currentViewName) return;

          this._displayView(this.currentViewName, false);
          //raise event - TODO: allow cancel?
          this.dispatchEvent(new CustomEvent('open', {detail:{ "viewName": viewName, "contentView": undefined, "config": config }, bubbles:true,composed:true}));

          var openSuccessful = false;
          //check for existing
          if (this._views[viewName]) {
            contentView = ComponentHelper.getContentViewByName(viewName);
            if (contentView) {
              this._displayView(viewName, true);
                //manage viewstack
              if (this._activeStack[this._activeStack.length - 1] != viewName) {
                this._takeOutFromStacks([
                  this._minimizeStack,
                  this._activeStack
                ], viewName);
                this._activeStack.push(viewName);
              }

              openSuccessful = true;
            }
          }
          else {
            // Polymer.importHref(this.resolveUrl('rock-content-view.html'),
            // () => this._loadContentView(viewName, config,queryParams,action, path),
            // true
            // );
            //if no existing, create new
            var cView = customElements.get('rock-content-view');
            contentView = new cView();//this.create('rock-content-view')//document.createElement('rock-content-view');
            contentView.name = viewName;
            contentView.setAttribute("name", viewName);
            contentView.component = config.component;
            if (!contentView.component.properties) {
              contentView.component.properties={};
            }
            contentView.component.properties["app-config"] = DataHelper.cloneObject(config);
            contentView.viewTitle = config.title;
            contentView.icon = config.icon;
            contentView.nonClosable = config.nonClosable;
            contentView.nonMinimizable = config.nonMinimizable;
            contentView.noShare = config.nonSharable;
            contentView.noSettings = config.noSettings;
            contentView.manager = this;
            contentView.queryParams = queryParams;
            contentView.path = path;
            contentView.renderedCallback = function(renderedElement){
              this.dispatchEvent(new CustomEvent('opened', {detail:{ "contentView": renderedElement }, bubbles:true, composed:true}));
            }.bind(this);
            this.$.contentViewManager.appendChild(contentView);
            contentView.render();

            this._views[viewName] = true;

            //manage viewstack
            this._activeStack.push(viewName);
            this._openStack.push(viewName);

            openSuccessful = true;
          }
          
          var content=contentView.getContent();
          if(content && content.isRufComponent && action && action.name){
              content.fire(action.name,action.data);
          }
          //hide current view
          if (openSuccessful) {
            this.currentViewName = viewName;
          } else {
            this._displayView(this.currentViewName, true);
          }
        },

        /**
        * Can be used to close a view with the given name.
        * @param {string} viewName The name of the view to be opened.
        */
        closeView: function (viewName, queryParams,action) {
          if(!viewName) return;
            
          viewName = ComponentHelper.getViewNameWithQueryParams(queryParams, viewName);
          var contentView = ComponentHelper.getContentViewByName(viewName);

          if(!contentView) return;

          //Where rendering is going on, there is an issue closing and opening next app. So, we are making sure that it is flushed
          Polymer.dom.flush();

          //raise event - TODO: allow cancel?
          this.dispatchEvent(new CustomEvent('close', {detail:{ "viewName": viewName, "contentView": contentView, "config": undefined }, bubbles:true, composed:true}));

          ComponentHelper.removeNode(contentView);
          contentView = null;
          delete this._views[viewName];

          //manage viewstack
          this._takeOutFromStacks([
            this._activeStack,
            this._openStack,
            this._minimizeStack
          ], viewName);

          //show previous view when the current one is closed
          if (this.currentViewName == viewName) {
            this.currentViewName = "";
            if (this._activeStack.length) {
              this._navigateToLastOpenedContentView(action);
            }
            else {
              //no views to show, should go back to dashboard
              this._changeRoute("/dashboard");
            }
          }
        },

        /**
        * Can be used to minimize a view with the given name.
        * @param {string} viewName The name of the view to be opened.
        */
        minimizeView: function (viewName, queryParams) {
          if(!viewName) return;
          
          viewName = ComponentHelper.getViewNameWithQueryParams(queryParams, viewName);
          var contentView = ComponentHelper.getContentViewByName(viewName);

          if(!contentView) return;

          //Where rendering is going on, there is an issue minimizing and opening next app. So, we are making sure that it is flushed
          Polymer.dom.flush();

          //raise event - TODO: allow cancel?
          this.dispatchEvent(new CustomEvent('minimize', {detail:{ "viewName": viewName, "contentView": contentView, "config": undefined }, bubbles:true,composed:true}));

          this._displayView(viewName, false);

          //manage viewstack
          this._minimizeStack.push(viewName);
          this._takeOutFromStacks([this._activeStack], viewName);//ideally a pop, will change soon
          this.currentViewName = "";
          //show previous view when the current one is closed
          if (this._activeStack.length) {
            this._navigateToLastOpenedContentView();
          }
          else {
            //no views to show, should go back to dashboard
            this._changeRoute("/dashboard");
          }
        },

        _takeOutFromStacks(stacks=[], viewName) {
          stacks.forEach(stack => {
            const viewIndex = stack.findIndex(item => item === viewName);

            if(viewIndex >=0) stack.splice(viewIndex, 1);
          });
        },

        /**
        * @method _displayView - handle view display state
        * @param {String} viewName
        * @param {Boolean} display
        */
        _displayView(viewName, display) {
          const contentView = ComponentHelper.getContentViewByName(viewName);

          if(!contentView) return;

          if(display)
            contentView.removeAttribute("hidden");
          else
            contentView.setAttribute("hidden", "");
        },
        
        _changeRoute: function (path, queryParams,action) {
          if (!queryParams) {
            queryParams = {};
          }

          var mainApp = document.querySelector("main-app");

          if(!mainApp) return;

          ComponentHelper.setQueryParamsWithoutEncode(queryParams);

          if (path !== mainApp.pageRoute.path) {
            mainApp.changePageRoutePath(path,action);
          }
        },
        _navigateToLastOpenedContentView: function (action) {
          var lastOpenedContentView = ComponentHelper.getContentViewByName(this._activeStack[this._activeStack.length - 1]);
          this._changeRoute(lastOpenedContentView.path, lastOpenedContentView.queryParams,action);
        },
        /** 
        * Can be used to get the elements if the current content view is dirty.
        */
        getIsDirty: function () {
          if (this.currentViewName) {
            var currenttView = ComponentHelper.getContentViewByName(this.currentViewName);
          }
          if (currenttView) {
            var content = currenttView.$.content;
            if (content && content.firstElementChild && content.firstElementChild.getIsDirty) {
              var isDirty = content.firstElementChild.getIsDirty();
              return isDirty;
            }
          }
        },

        /**
         * Fired when a `rock-content-view` is opened.
         *
         * @event 'open'
         * @param {{text: object}} the object has child properties for viewName, config object.
         */

        /**
        * Fired when a `rock-content-view` is closed.
        *
        * @event 'close'
        * @param {{text: object}} the object has child properties for viewName, contentView object.
        */

        /**
        * Fired when a `rock-content-view` is minimized.
        *
        * @event 'minimize'
        * @param {{text: object}} the object has child properties for viewName, contentView object.
        */

      });
    })();
  </script>

</dom-module>
