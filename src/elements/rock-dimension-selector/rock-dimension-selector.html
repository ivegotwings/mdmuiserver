<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html" />
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html" />
<link rel="import" href="../../../bower_components/paper-item/paper-item.html" />
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="../../../bower_components/iron-icons/device-icons.html" />
<link rel="import" href="../pebble-icons/pebble-icons.html" />
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../pebble-lov/pebble-lov.html" />
<!--
`<rock-dimension-selector>` Represents a component to hold a catalog, source, date, and locale information. 
The elements inside this component can be dyncamically loaded based on a config json.

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--dimesion-selector-catalog-popover` | Mixin applied to catalog selector dropdown  | `{}`
`--dimesion-selector-source-popover`  | Mixin applied to source selector dropdown   | `{}`
`--dimesion-selector-date-dropdown`    | Mixin applied to date selector dropdown     | `{}`
`--dimesion-selector-locale-popover`  | Mixin applied to locale selector dropdown   | `{}`

@group rock Elements
@element rock-dimension-selector
@demo demo/index.html
-->
<dom-module id="rock-dimension-selector">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex"></style>
        <style is="custom-style">
             :host {
                display: inline-block;
            }
            
            #catalogPopover {
                @apply(--dimesion-selector-catalog-popover);
            }
            
            #sourcePopover {
                @apply(--dimesion-selector-source-popover);
            }
            
            #localePopover {
                @apply(--dimesion-selector-locale-popover);
            }
            
            div iron-icon {
                fill: var(--palette-steel-grey);
                height: var(--icon-set-height);
                width: var(--icon-set-height);
                @apply(--dimension-selector-icon);
            }
        </style>
        <div class="horizontal layout container">
            <template is="dom-if" if="{{configData.catalogSelector.visible}}">
                <div>
                    <paper-icon-button id="catalogPopoverToggle" icon="pebble-md-icons:Advancesearch" on-tap="_onDimensionTapped"></paper-icon-button>
                </div>
                <pebble-popover id="catalogPopover" for="catalogPopoverToggle" auto-fit-on-attach no-overlap>
                    <pebble-lov id="catalogLov" items="[[configData.catalogSelector.catalogItems]]" multi-select no-sub-title show-action-buttons></pebble-lov>
                </pebble-popover>
            </template>
            <template is="dom-if" if="{{configData.sourceSelector.visible}}">
                <div>
                    <paper-icon-button id="sourcePopoverToggle" icon="pebble-md-icons:Advancesearch" on-tap="_onDimensionTapped"></paper-icon-button>
                </div>
                <pebble-popover id="sourcePopover" for="sourcePopoverToggle" auto-fit-on-attach no-overlap>
                    <pebble-lov id="sourceLov" items="[[configData.sourceSelector.sourceItems]]" multi-select no-sub-title show-action-buttons></pebble-lov>
                </pebble-popover>
            </template>
            <template is="dom-if" if="{{configData.dateSelector.visible}}">
                <div>
                    <!-- Todo -->
                </div>
            </template>
            <template is="dom-if" if="{{configData.localeSelector.visible}}">
                <div>
                    <paper-icon-button id="localePopoverToggle" icon="pebble-md-icons:Advancesearch" on-tap="_onDimensionTapped"></paper-icon-button>
                </div>
                <pebble-popover id="localePopover" for="localePopoverToggle" auto-fit-on-attach no-overlap>
                    <pebble-lov id="localeLov" items="[[configData.localeSelector.localeItems]]" multi-select no-sub-title show-action-buttons></pebble-lov>
                </pebble-popover>
            </template>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "rock-dimension-selector",
        properties: {
            /**
             * Fired when user changes the catalog selector selection 
             *
             * @event dimension-selector-catalog (pub-sub event)
             * @param {Object} selectedItemsInfo
             */

            /**
             * Fired when user changes the source selector selection 
             *
             * @event dimension-selector-source (pub-sub event)
             * @param {Object} selectedItemsInfo
             */

            /**
             * Fired when user changes the locale selector selection 
             *
             * @event dimension-selector-locale (pub-sub event)
             * @param {Object} selectedItemsInfo
             */

            /**
             * Returns the list of items which you must place in the dimension selector component.
             */
            configData: {
                type: Object,
                value: function () {
                    return {};
                }
            },

            catalogSelector: {
                type: Object,
                value: function () {
                    return {};
                }
            },

            sourceSelector: {
                type: Object,
                value: function () {
                    return {};
                }
            },

            localeSelector: {
                type: Object,
                value: function () {
                    return {};
                }
            },

            isCatalogSelectorMultiSelect: {
                type: Boolean,
                value: true,
                observer: '_catalogSelectorModeChanged'
            },

            isSourceSelectorMultiSelect: {
                type: Boolean,
                value: true,
                observer: '_sourceSelectorModeChanged'
            },

            isLocaleSelectorMultiSelect: {
                type: Boolean,
                value: true,
                observer: '_localeSelectorModeChanged'
            },

            selectedDimensionPopover: {
                type: Object,
                value: function () {
                    return {};
                }
            },

            selectedDimensionLov: {
                type: Object,
                value: function () {
                    return {};
                }
            }
        },

        behaviors: [
            RUFBehaviors.UIBehavior
        ],

        listeners: {
            'on-confirm': '_onConfirm',
            'on-cancel': '_onCancel',
        },

        _onDimensionTapped: function (event) {
            this._initializeObjects();

            if (this.catalogSelector && Polymer.dom(event).path.indexOf(this.catalogSelector.toggleButton) !==
                -1) {
                this.selectedDimensionPopover = this.catalogSelector.popover;
                this.selectedDimensionLov = this.catalogSelector.lov;
            }

            if (this.sourceSelector && Polymer.dom(event).path.indexOf(this.sourceSelector.toggleButton) !==
                -1) {
                this.selectedDimensionPopover = this.sourceSelector.popover;
                this.selectedDimensionLov = this.sourceSelector.lov;
            }

            if (this.localeSelector && Polymer.dom(event).path.indexOf(this.localeSelector.toggleButton) !==
                -1) {
                this.selectedDimensionPopover = this.localeSelector.popover;
                this.selectedDimensionLov = this.localeSelector.lov;
            }

            this._toggleLovPopover(this.selectedDimensionPopover, this.selectedDimensionLov);
        },

        _initializeObjects: function () {
            if (this._isEmptyObject(this.catalogSelector) || this._isEmptyObject(this.sourceSelector) ||
                this._isEmptyObject(this.localeSelector)) {
                this.catalogSelector.toggleButton = this.$$("#catalogPopoverToggle");
                this.catalogSelector.popover = this.$$("#catalogPopover");
                this.catalogSelector.lov = this.$$("#catalogLov");
                this.catalogSelector.selectionChangedHandler = this._catalogSelectionChanged.bind(this);
                this.catalogSelector.selectedItem = null;
                this.set("catalogSelector.selectedItems", []);

                this.sourceSelector.toggleButton = this.$$("#sourcePopoverToggle");
                this.sourceSelector.popover = this.$$("#sourcePopover");
                this.sourceSelector.lov = this.$$("#sourceLov");
                this.sourceSelector.selectionChangedHandler = this._sourceSelectionChanged.bind(this);
                this.sourceSelector.selectedItem = null;
                this.set("sourceSelector.selectedItems", []);

                this.localeSelector.toggleButton = this.$$("#localePopoverToggle");
                this.localeSelector.popover = this.$$("#localePopover");
                this.localeSelector.lov = this.$$("#localeLov");
                this.localeSelector.selectionChangedHandler = this._localeSelectionChanged.bind(this);
                this.localeSelector.selectedItem = null;
                this.set("localeSelector.selectedItems", []);
            }
        },

        _onConfirm: function (event) {
            if (Polymer.dom(event).path.indexOf(this.catalogSelector.popover) !== -1) {
                if (this.catalogSelector.lov.multiSelect) {
                    if (this.catalogSelector.lov.selectedItems.length > 1) {
                        if (this.sourceSelector.lov) {
                            this.sourceSelector.lov.multiSelect = !this.catalogSelector.lov.multiSelect;
                        }

                        if (this.localeSelector.lov) {
                            this.localeSelector.lov.multiSelect = !this.catalogSelector.lov.multiSelect;
                        }
                    } else {
                        if (this.sourceSelector.lov) {
                            this.sourceSelector.lov.multiSelect = this.catalogSelector.lov.multiSelect;
                        }

                        if (this.localeSelector.lov) {
                            this.localeSelector.lov.multiSelect = this.catalogSelector.lov.multiSelect;
                        }
                    }

                    // This can also be listened on multi-select-changed event
                    this.isSourceSelectorMultiSelect = this.sourceSelector.lov.multiSelect;
                    this.isLocaleSelectorMultiSelect = this.localeSelector.lov.multiSelect;
                }

                var selectedItemsInfo = {
                    multiSelect: this.catalogSelector.lov.multiSelect,
                    selectedItem: this.catalogSelector.lov.selectedItem,
                    selectedItems: this.catalogSelector.lov.selectedItems,
                }

                this.fireBedrockEvent("dimension-selector-catalog", selectedItemsInfo);
            }

            if (Polymer.dom(event).path.indexOf(this.sourceSelector.popover) !== -1) {
                if (this.sourceSelector.lov.multiSelect) {
                    if (this.sourceSelector.lov.selectedItems.length > 1) {
                        if (this.catalogSelector.lov) {
                            this.catalogSelector.lov.multiSelect = !this.sourceSelector.lov.multiSelect;
                        }

                        if (this.localeSelector.lov) {
                            this.localeSelector.lov.multiSelect = !this.sourceSelector.lov.multiSelect;
                        }
                    } else {
                        if (this.catalogSelector.lov) {
                            this.catalogSelector.lov.multiSelect = this.sourceSelector.lov.multiSelect;
                        }

                        if (this.localeSelector.lov) {
                            this.localeSelector.lov.multiSelect = this.sourceSelector.lov.multiSelect;
                        }
                    }

                    this.isCatalogSelectorMultiSelect = this.catalogSelector.lov.multiSelect;
                    this.isLocaleSelectorMultiSelect = this.localeSelector.lov.multiSelect;
                }

                var selectedItemsInfo = {
                    multiSelect: this.sourceSelector.lov.multiSelect,
                    selectedItem: this.sourceSelector.lov.selectedItem,
                    selectedItems: this.sourceSelector.lov.selectedItems,
                }

                this.fireBedrockEvent("dimension-selector-source", selectedItemsInfo);
            }

            if (Polymer.dom(event).path.indexOf(this.localeSelector.popover) !== -1) {
                if (this.localeSelector.lov.multiSelect) {
                    if (this.localeSelector.lov.selectedItems.length > 1) {
                        if (this.catalogSelector.lov) {
                            this.catalogSelector.lov.multiSelect = !this.localeSelector.lov.multiSelect;
                        }

                        if (this.sourceSelector.lov) {
                            this.sourceSelector.lov.multiSelect = !this.localeSelector.lov.multiSelect;
                        }
                    } else {
                        if (this.catalogSelector.lov) {
                            this.catalogSelector.lov.multiSelect = this.localeSelector.lov.multiSelect;
                        }

                        if (this.sourceSelector.lov) {
                            this.sourceSelector.lov.multiSelect = this.localeSelector.lov.multiSelect;
                        }
                    }

                    this.isCatalogSelectorMultiSelect = this.catalogSelector.lov.multiSelect;
                    this.isSourceSelectorMultiSelect = this.sourceSelector.lov.multiSelect;
                }

                var selectedItemsInfo = {
                    multiSelect: this.localeSelector.lov.multiSelect,
                    selectedItem: this.localeSelector.lov.selectedItem,
                    selectedItems: this.localeSelector.lov.selectedItems
                }

                this.fireBedrockEvent("dimension-selector-locale", selectedItemsInfo);
            }

            this.catalogSelector.selectedItems = this.catalogSelector.lov.selectedItems;
            this.sourceSelector.selectedItems = this.sourceSelector.lov.selectedItems;
            this.localeSelector.selectedItems = this.localeSelector.lov.selectedItems;

            this._toggleLovPopover(this.selectedDimensionPopover, this.selectedDimensionLov);
        },

        _onCancel: function () {
            if (Polymer.dom(event).path.indexOf(this.catalogSelector.popover) !== -1) {
                if (this.isCatalogSelectorMultiSelect) {
                    if (this.catalogSelector.selectedItems.length !== this.catalogSelector.lov.selectedItems
                        .length) {
                        this.catalogSelector.lov.set("selectedItems", []);
                        this.catalogSelector.lov.set('selectedItems', this.catalogSelector.selectedItems);
                    }
                }
            }

            if (Polymer.dom(event).path.indexOf(this.sourceSelector.popover) !== -1) {
                if (this.isSourceSelectorMultiSelect) {
                    if (this.sourceSelector.selectedItems.length !== this.sourceSelector.lov.selectedItems
                        .length) {
                        this.sourceSelector.lov.set("selectedItems", []);
                        this.sourceSelector.lov.set('selectedItems', this.sourceSelector.selectedItems);
                    }
                }
            }

            if (Polymer.dom(event).path.indexOf(this.localeSelector.popover) !== -1) {
                if (this.isLocaleSelectorMultiSelect) {
                    if (this.localeSelector.selectedItems.length !== this.localeSelector.lov.selectedItems
                        .length) {
                        this.localeSelector.lov.set("selectedItems", []);
                        this.localeSelector.lov.set('selectedItems', this.localeSelector.selectedItems);
                    }
                }
            }

            this._toggleLovPopover(this.selectedDimensionPopover, this.selectedDimensionLov);
        },

        _toggleLovPopover: function () {
            if (!this._isEmptyObject(this.selectedDimensionPopover) && !this._isEmptyObject(this.selectedDimensionLov)) {
                if (!this.selectedDimensionPopover.opened && !this.selectedDimensionLov.isopen) {
                    this.selectedDimensionPopover.show();
                    this.selectedDimensionLov.activate();
                } else {
                    this.selectedDimensionPopover.hide();
                }
            }
        },

        _catalogSelectorModeChanged: function () {
            if (this.catalogSelector.lov) {
                if (!this.catalogSelector.lov.multiSelect) {
                    this.catalogSelector.lov.addEventListener('selection-changed', this.catalogSelector.selectionChangedHandler);

                    if (this.catalogSelector.selectedItems && this.catalogSelector.selectedItems.length ==
                        1) {
                        this.catalogSelector.lov.selectedItem = this.catalogSelector.selectedItems[0];
                        // this.set("catalogSelector.selectedItems", []);
                    }
                } else {
                    this.catalogSelector.lov.removeEventListener('selection-changed', this.catalogSelector.selectionChangedHandler);

                    if (this.catalogSelector.selectedItem) {
                        this.catalogSelector.lov.push('selectedItems', this.catalogSelector.selectedItem);
                        //this.catalogSelector.selectedItem = null;
                    }
                }
            }
        },

        _catalogSelectionChanged: function () {
            if (this.catalogSelector.lov.selectedItem) {
                this.catalogSelector.selectedItem = this.catalogSelector.lov.selectedItem;
            }

            if (this.catalogSelector.popover.isopen) {
                this.catalogSelector.popover.hide();
            }
        },

        _sourceSelectorModeChanged: function () {
            if (this.sourceSelector && this.sourceSelector.lov) {
                if (!this.sourceSelector.lov.multiSelect) {
                    this.sourceSelector.lov.addEventListener('selection-changed', this.sourceSelector.selectionChangedHandler);

                    if (this.sourceSelector.selectedItems && this.sourceSelector.selectedItems.length == 1) {
                        this.sourceSelector.lov.selectedItem = this.sourceSelector.selectedItems[0];
                        // this.set("sourceSelector.selectedItems", []);
                    }
                } else {
                    this.sourceSelector.lov.removeEventListener('selection-changed', this.sourceSelector.selectionChangedHandler);

                    if (this.sourceSelector.selectedItem) {
                        this.sourceSelector.lov.push('selectedItems', this.sourceSelector.selectedItem);
                        // this.sourceSelector.selectedItem = null;
                    }
                }
            }
        },

        _sourceSelectionChanged: function () {
            if (this.sourceSelector && this.sourceSelector.lov) {
                if (this.sourceSelector.lov.selectedItem) {
                    this.sourceSelector.selectedItem = this.sourceSelector.lov.selectedItem;
                }

                if (this.sourceSelector.popover.isopen) {
                    this.sourceSelector.popover.hide();
                }
            }
        },

        _localeSelectorModeChanged: function () {
            if (this.localeSelector && this.localeSelector.lov) {
                if (!this.localeSelector.lov.multiSelect) {
                    this.localeSelector.lov.addEventListener('selection-changed', this.localeSelector.selectionChangedHandler);

                    if (this.localeSelector.selectedItems && this.localeSelector.selectedItems.length == 1) {
                        this.localeSelector.lov.selectedItem = this.localeSelector.selectedItems[0];
                        // this.set("localeSelector.selectedItems", []);
                    }
                } else {
                    this.localeSelector.lov.removeEventListener('selection-changed', this.localeSelector.selectionChangedHandler);

                    if (this.localeSelector.selectedItem) {
                        this.localeSelector.lov.push('selectedItems', this.localeSelector.selectedItem);
                        // this.localeSelector.selectedItem = null;
                    }
                }
            }
        },

        _localeSelectionChanged: function () {
            if (this.localeSelector && this.localeSelector.lov) {
                if (this.localeSelector.lov.selectedItem) {
                    this.localeSelector.selectedItem = this.localeSelector.lov.selectedItem;
                }

                if (this.localeSelector.popover.isopen) {
                    this.localeSelector.popover.hide();
                }
            }
        },

        _isEmptyObject: function (obj) {
            for (var prop in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, prop)) {
                    return false;
                }
            }

            return true;
        }
    });
</script>