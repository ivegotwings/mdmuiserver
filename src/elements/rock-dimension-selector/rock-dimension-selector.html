<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html" />
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<!--
`<rock-dimension-selector>` Represents a component to hold a container, source, date, and locale information. 
The elements inside this component are dyncamically loaded based on the config json.

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--dimesion-selector-container-popover` | Mixin applied to container selector dropdown  | `{}`
`--dimesion-selector-source-popover` | Mixin applied to source selector dropdown   | `{}`
`--dimesion-selector-locale-popover` | Mixin applied to locale selector dropdown   | `{}`

@group rock Elements
@element rock-dimension-selector
@demo demo/index.html
-->
<dom-module id="rock-dimension-selector">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style" include="iron-flex"></style>
        <style is="custom-style">
             :host {
                display: inline-block;
            }

            #listPopover {
                @apply(--dimesion-selector-container-popover);
                --pebble-popover-width: 160px;
            }

            #sourcePopover {
                @apply(--dimesion-selector-source-popover);
                --pebble-popover-width: 160px;
            }

            #localePopover {
                @apply(--dimesion-selector-locale-popover);
                --pebble-popover-width: 160px;
            }

            .btn.dropdownText::shadow paper-button iron-icon#leftIcon {
                width: 20px!important;
                height: 20px!important;
            }

            .btn.dropdownText::shadow paper-button iron-icon,
            .btn.dropdownText::shadow paper-button {
                color: var(--pagetitle-text-color, #034c89) !important;
            }
        </style>
        <div class="horizontal layout container">
            <template is="dom-repeat" items="[[configData]]" as="configDataItem">
                <div id="[[configDataItem.id]]" hidden="[[!configDataItem.visible]]">
                    <div>
                        <pebble-button id="[[configDataItem.id]]-toggle-button" popover="[[configDataItem.id]]-popover" lov="[[configDataItem.id]]-lov" icon="[[configDataItem.icon]]"
                            button-text="[[configDataItem.title]]" class="dropdownText dropdownIcon btn dropdown" noink raised no-overlap
                            vertical-offset="-211" horizontal-offset="11" menu-button dropdown-icon on-tap="_onToggleButtonTap">
                        </pebble-button>
                    </div>
                    <pebble-popover id="[[configDataItem.id]]-popover" for="[[configDataItem.id]]-toggle-button" auto-fit-on-attach no-overlap>
                        <rock-entity-lov id="[[configDataItem.id]]-lov" title-pattern="[[configDataItem.fields.title]]" value-field="[[configDataItem.fields.value]]"
                            context='[[configDataItem.context]]' types-criterion='[[configDataItem.typesCriterion]]' selected-items="[[formatSelectedItems(configDataItem.selectedId)]]"
                            multi-select no-sub-title show-action-buttons></rock-entity-lov>
                    </pebble-popover>
                </div>
            </template>
        </div>
        <!--<bedrock-pubsub event-name="entity-model-lov-confirm-button-tap" handler="_onEntityModelLovConfirmButtonTapped" target-id="listLov"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-model-lov-close-button-tap" handler="_onEntityModelLovCloseButtonTapped" target-id="listLov"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-model-lov-confirm-button-tap" handler="_onEntityModelLovConfirmButtonTapped" target-id="sourceLov"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-model-lov-close-button-tap" handler="_onEntityModelLovCloseButtonTapped" target-id="sourceLov"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-model-lov-confirm-button-tap" handler="_onEntityModelLovConfirmButtonTapped" target-id="localeLov"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-model-lov-close-button-tap" handler="_onEntityModelLovCloseButtonTapped" target-id="localeLov"></bedrock-pubsub>-->
    </template>
</dom-module>
<script>
    Polymer({
        is: "rock-dimension-selector",
        properties: {
            /**
             * Fired when the user changes the list selector selection.
             *
             * @event dimension-selector-list (pub-sub event)
             * @param {Object} selectedItemsInfo
             */

            /**
             * Fired when the user changes the source selector selection. 
             *
             * @event dimension-selector-source (pub-sub event)
             * @param {Object} selectedItemsInfo
             */

            /**
             * Fired when the user changes the locale selector selection. 
             *
             * @event dimension-selector-locale (pub-sub event)
             * @param {Object} selectedItemsInfo
             */

            /**
             * Indicates the list of items which you must place in the dimension selector component.
             */
            configData: {
                type: Array,
                value: function () {
                    return [];
                },
                'observer': '_configDataChanged'
            },
            /**
             * Specifies whether all dimensions allow the multi-selectable feature or not.
             */
            allMultiSelect: {
                type: Boolean,
                value: false
            },
            /**
             * Indicates the selected values of all dimensions in the dimension selector.
             */
            selectedDimensions: {
                type: Array,
                notify: true,
                value: function () {
                    return {};
                }
            },
            /**
             * Indicates the list dimension selector.
             */
            listSelector: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            /**
             * Indicates the source dimension selector.
             */
            sourceSelector: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            /**
             * Indicates the locale dimension selector.
             */
            localeSelector: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            /**
             * Indicates the selected value of the list dimension.
             */
            selectedList: {
                type: String,
                observer: '_selectedListChanged'
            },
            /**
             * Indicates the selected values of the list dimension if multiple list values are selected.
             */
            selectedLists: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            /**
             * Indicates the selected value of the source dimension.
             */
            selectedSource: {
                type: String,
                observer: '_selectedSourceChanged'
            },
            /**
             * Indicates the selected values of the source dimension if multiple source values are selected.
             */
            selectedSources: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            /**
             * Indicates the selected value of the locale dimension.
             */
            selectedLocale: {
                type: String,
                observer: '_selectedLocaleChanged'
            },
            /**
             * Indicates the selected values of locale dimension if multiple locale values are selected.
             */
            selectedLocales: {
                type: Array,
                value: function () {
                    return [];
                }
            },

            _isListSelectorMultiSelect: {
                type: Boolean,
                value: true,
                observer: '_listSelectorModeChanged'
            },

            _isSourceSelectorMultiSelect: {
                type: Boolean,
                value: true,
                observer: '_sourceSelectorModeChanged'
            },

            _isLocaleSelectorMultiSelect: {
                type: Boolean,
                value: true,
                observer: '_localeSelectorModeChanged'
            }
        },

        behaviors: [
            RUFBehaviors.UIBehavior
        ],

        ready: function () {
            this._setSelectedDimensions();
        },

        _onToggleButtonTap: function (event) {
            if (typeof (event.srcElement) !== "undefined") {
                var currentElement = event.srcElement;
                this._toggleLovPopover(currentElement.popover);
            }
        },

        formatSelectedItems: function (selectedItemId) {
            // Todo.. This is not a correct code lov must support selectedid 
            var formattedSelectedItems = [];

            var formattedSelectedItem = {};
            formattedSelectedItem["id"] = selectedItemId;

            formattedSelectedItems.push(formattedSelectedItem);

            return formattedSelectedItems
        },

        _configDataChanged: function () {

            // if (this.configData && this.configData.catalogSelector) {

            //     this.listSelector.lov.loadData();

            //     // FE: This should be based on Ids 
            //     // FE: What if the selecteditems are not avaialable in current items list coz of lazy loading
            //     this.listSelector.lov.selectedItems = this.configData.catalogSelector.selectedCatalogItems;
            //     this.listSelector.lov.selectedItem = this.configData.catalogSelector.selectedCatalogItem;

            //     if (this.listSelector.lov.selectedItems) {
            //         this.listSelector.selectedItems = this.listSelector.lov.selectedItems;
            //         if (this.listSelector.selectedItems && this.listSelector.selectedItems.length > 0) {
            //             this.listSelector.selectedItem = this.listSelector.selectedItems[0];
            //         }
            //     } else {
            //         this.listSelector.selectedItem = this.listSelector.lov.selectedItem;
            //         if (this.listSelector.selectedItem) {
            //             this.listSelector.selectedItems.push(this.listSelector.selectedItem);
            //         }
            //     }

            //     this._displayToggleButtonText(this.listSelector, this._isListSelectorMultiSelect);
            // }

            // if (this.configData && this.configData.sourceSelector) {

            //     this.sourceSelector.lov.loadData();

            //     // Here it is assumed that first time the lov will always be multi-select
            //     this.sourceSelector.lov.selectedItems = this.configData.sourceSelector.selectedSourceItems;
            //     this.sourceSelector.lov.selectedItem = this.configData.sourceSelector.selectedSourceItem;

            //     if (this.sourceSelector.lov.selectedItems) {
            //         this.sourceSelector.selectedItems = this.sourceSelector.lov.selectedItems;
            //         if (this.sourceSelector.selectedItems && this.sourceSelector.selectedItems.length > 0) {
            //             this.sourceSelector.selectedItem = this.sourceSelector.selectedItems[0];
            //         }
            //     } else {
            //         this.sourceSelector.selectedItem = this.sourceSelector.lov.selectedItem;
            //         if (this.sourceSelector.selectedItem) {
            //             this.sourceSelector.selectedItems.push(this.sourceSelector.selectedItem);
            //         }
            //     }

            //     this._displayToggleButtonText(this.sourceSelector, this._isSourceSelectorMultiSelect);
            // }

            // if (this.configData && this.configData.localeSelector) {

            //     this.localeSelector.lov.loadData();

            //     // Here it is assumed that first time the lov will always be multi-select
            //     this.localeSelector.lov.selectedItems = this.configData.localeSelector.selectedLocaleItems;
            //     this.localeSelector.lov.selectedItem = this.configData.localeSelector.selectedLocaleItem;

            //     if (this.localeSelector.lov.selectedItems) {
            //         this.localeSelector.selectedItems = this.localeSelector.lov.selectedItems;
            //         if (this.localeSelector.selectedItems && this.localeSelector.selectedItems.length > 0) {
            //             this.localeSelector.selectedItem = this.localeSelector.selectedItems[0];
            //         }
            //     } else {
            //         this.localeSelector.selectedItem = this.localeSelector.lov.selectedItem;
            //         if (this.localeSelector.selectedItem) {
            //             this.localeSelector.selectedItems.push(this.localeSelector.selectedItem);
            //         }
            //     }

            //     this._displayToggleButtonText(this.localeSelector, this._isLocaleSelectorMultiSelect);
            // }

            // if (this.configData && this.configData.localeSelector) {
            //     this._setSelectedDimension();

            //     this.fire('dimension-selector-initialized', {
            //         item: "value"
            //     });
            // }
        },

        _setSelectedDimensions: function () {
            var selectedDimensions = {};

            if (typeof (this.configData) !== "undefined") {
                for (var i = 0; i < this.configData.length; i++) {
                    var configDataItem = this.configData[i];
                    var currentEntityLov = this.$$("#" + configDataItem.id).querySelector("rock-entity-lov");

                    if (typeof (currentEntityLov) !== "undefined") {
                        if (!currentEntityLov.multiSelect) {
                            selectedDimensions[configDataItem.id] = currentEntityLov.selectedItem;
                        } else {
                            selectedDimensions[configDataItem.id] = currentEntityLov.selectedItems;
                        }
                    }
                }
            }

            this.set("selectedDimensions", selectedDimensions);
        },

        _onEntityModelLovConfirmButtonTapped: function (event) {
            if (Polymer.dom(event).path.indexOf(this.listSelector.popover) !== -1) {
                if (this.listSelector.lov.multiSelect) {

                    if (!this.allMultiSelect) {
                        this._toggleLovSelectionMode(this.listSelector, [this.sourceSelector, this.localeSelector]);

                        // This can also be listened on multi-select-changed event
                        this._isSourceSelectorMultiSelect = this.sourceSelector.lov.multiSelect;
                        this._isLocaleSelectorMultiSelect = this.localeSelector.lov.multiSelect;
                    }

                    this._displayToggleButtonText(this.listSelector, this._isListSelectorMultiSelect);
                }

                this.fireBedrockEvent("dimension-selector-list", this._getSelectedItemsInfo(this.listSelector));
            }

            if (Polymer.dom(event).path.indexOf(this.sourceSelector.popover) !== -1) {
                if (this.sourceSelector.lov.multiSelect) {

                    if (!this.allMultiSelect) {
                        this._toggleLovSelectionMode(this.sourceSelector, [this.listSelector, this.localeSelector]);

                        this._isListSelectorMultiSelect = this.listSelector.lov.multiSelect;
                        this._isLocaleSelectorMultiSelect = this.localeSelector.lov.multiSelect;
                    }

                    this._displayToggleButtonText(this.sourceSelector, this._isSourceSelectorMultiSelect);
                }

                this.fireBedrockEvent("dimension-selector-source", this._getSelectedItemsInfo(this.sourceSelector));
            }

            if (Polymer.dom(event).path.indexOf(this.localeSelector.popover) !== -1) {
                if (this.localeSelector.lov.multiSelect) {

                    if (!this.allMultiSelect) {
                        this._toggleLovSelectionMode(this.localeSelector, [this.listSelector, this.sourceSelector]);

                        this._isListSelectorMultiSelect = this.listSelector.lov.multiSelect;
                        this._isSourceSelectorMultiSelect = this.sourceSelector.lov.multiSelect;
                    }

                    this._displayToggleButtonText(this.localeSelector, this._isLocaleSelectorMultiSelect);
                }

                this.fireBedrockEvent("dimension-selector-locale", this._getSelectedItemsInfo(this.localeSelector));
            }

            this.listSelector.selectedItems = this.listSelector.lov.selectedItems;
            this.sourceSelector.selectedItems = this.sourceSelector.lov.selectedItems;
            this.localeSelector.selectedItems = this.localeSelector.lov.selectedItems;

            this._setSelectedDimension();

            // this._toggleLovPopover(this._selectedDimensionPopover, this._selectedDimensionLov);
        },

        _toggleLovSelectionMode: function (currentSelector, otherSelectors) {
            if (currentSelector.lov.selectedItems.length > 1) {
                for (var i = 0; i < otherSelectors.length; i++) {
                    otherSelectors[i].lov.multiSelect = !currentSelector.lov.multiSelect;
                }
            } else {
                for (var i = 0; i < otherSelectors.length; i++) {
                    otherSelectors[i].lov.multiSelect = currentSelector.lov.multiSelect;
                }
            }
        },

        _onEntityModelLovCloseButtonTapped: function () {
            // this._toggleLovPopover(this._selectedDimensionPopover, this._selectedDimensionLov);
        },

        _listSelectorModeChanged: function () {
            if (this.listSelector.lov) {
                if (!this.listSelector.lov.multiSelect) {
                    this.listSelector.lov.addEventListener('selection-changed', this.listSelector.selectionChangedHandler);

                    if (this.listSelector.selectedItems && this.listSelector.selectedItems.length ==
                        1) {
                        this.listSelector.lov.selectedItem = this.listSelector.selectedItems[0];
                    }
                } else {
                    this.listSelector.lov.removeEventListener('selection-changed', this.listSelector.selectionChangedHandler);

                    if (this.listSelector.selectedItem) {
                        this.listSelector.lov.push('selectedItems', this.listSelector.selectedItem);
                    }
                }

                this._displayToggleButtonText(this.listSelector, this._isListSelectorMultiSelect);
                this.listSelector.isMultiSelect = this._isListSelectorMultiSelect;
            }
        },

        _listSelectionChanged: function () {
            if (this.listSelector && this.listSelector.lov) {
                this.listSelector.selectedItem = this.listSelector.lov.selectedItem;
                this._displayToggleButtonText(this.listSelector, this._isListSelectorMultiSelect);
                this.fireBedrockEvent("dimension-selector-list", this._getSelectedItemsInfo(this.listSelector));

                if (this.listSelector.popover.isopen) {
                    this.listSelector.popover.hide();
                }
            }
        },

        _sourceSelectorModeChanged: function () {
            if (this.sourceSelector && this.sourceSelector.lov) {
                if (!this.sourceSelector.lov.multiSelect) {
                    this.sourceSelector.lov.addEventListener('selection-changed', this.sourceSelector.selectionChangedHandler);

                    if (this.sourceSelector.selectedItems && this.sourceSelector.selectedItems.length == 1) {
                        this.sourceSelector.lov.selectedItem = this.sourceSelector.selectedItems[0];
                    }
                } else {
                    this.sourceSelector.lov.removeEventListener('selection-changed', this.sourceSelector.selectionChangedHandler);

                    if (this.sourceSelector.selectedItem) {
                        this.sourceSelector.lov.push('selectedItems', this.sourceSelector.selectedItem);
                    }
                }

                this._displayToggleButtonText(this.sourceSelector, this._isSourceSelectorMultiSelect);
            }
        },

        _sourceSelectionChanged: function () {
            if (this.sourceSelector && this.sourceSelector.lov) {
                this.sourceSelector.selectedItem = this.sourceSelector.lov.selectedItem;
                this._displayToggleButtonText(this.sourceSelector, this._isSourceSelectorMultiSelect);
                this.fireBedrockEvent("dimension-selector-source", this._getSelectedItemsInfo(this.sourceSelector));

                if (this.sourceSelector.popover.isopen) {
                    this.sourceSelector.popover.hide();
                }
            }
        },

        _localeSelectorModeChanged: function () {
            if (this.localeSelector && this.localeSelector.lov) {
                if (!this.localeSelector.lov.multiSelect) {
                    this.localeSelector.lov.addEventListener('selection-changed', this.localeSelector.selectionChangedHandler);

                    if (this.localeSelector.selectedItems && this.localeSelector.selectedItems.length == 1) {
                        this.localeSelector.lov.selectedItem = this.localeSelector.selectedItems[0];
                    }
                } else {
                    this.localeSelector.lov.removeEventListener('selection-changed', this.localeSelector.selectionChangedHandler);

                    if (this.localeSelector.selectedItem) {
                        this.localeSelector.lov.push('selectedItems', this.localeSelector.selectedItem);
                    }
                }

                this._displayToggleButtonText(this.localeSelector, this._isLocaleSelectorMultiSelect);
            }
        },

        _localeSelectionChanged: function () {
            if (this.localeSelector && this.localeSelector.lov) {
                this.localeSelector.selectedItem = this.localeSelector.lov.selectedItem;
                this._displayToggleButtonText(this.localeSelector, this._isLocaleSelectorMultiSelect);
                this.fireBedrockEvent("dimension-selector-locale", this._getSelectedItemsInfo(this.localeSelector));

                if (this.localeSelector.popover.isopen) {
                    this.localeSelector.popover.hide();
                }
            }
        },

        _toggleLovPopover: function (popoverId) {
            var currentPopover = this.$$("#" + popoverId);
            if (!DataHelper.isEmptyObject(currentPopover)) {
                if (!currentPopover.opened) {
                    currentPopover.show();
                } else {
                    currentPopover.hide();
                }
            }
        },

        _displayToggleButtonText: function (dimensionObject, isMultiSelect) {
            if (!dimensionObject && !dimensionObject.toggleButton) {
                console.error(
                    'dimensionObject or toggleButton is undefined, cannot show dimension selector text'
                );
                return;
            }
            if (dimensionObject.lov.selectedItem) {
                dimensionObject.toggleButton.buttonText = dimensionObject.lov.selectedItem.title;
            } else if (dimensionObject.lov.selectedItems && dimensionObject.lov.selectedItems.length == 1) {
                dimensionObject.toggleButton.buttonText = dimensionObject.lov.selectedItems[0].title;
            } else if (dimensionObject.lov.selectedItems && dimensionObject.lov.selectedItems.length > 1) {
                dimensionObject.toggleButton.buttonText = dimensionObject.lov.selectedItems.length + " " +
                    dimensionObject.toggleButton.defaultButtonText.toLowerCase() + "s";
            } else {
                //this shouldn't happen
                dimensionObject.toggleButton.buttonText = dimensionObject.toggleButton.defaultButtonText;
            }
        },

        _getSelectedItemsInfo: function (dimensionSelector) {
            var dimensionSelectedItem;
            var dimensionSelectedItems = [];

            if (dimensionSelector.lov.multiSelect) {
                if (dimensionSelector.lov.selectedItems.length > 0) {
                    dimensionSelectedItem = dimensionSelector.lov.selectedItems[0];
                    dimensionSelectedItems = dimensionSelector.lov.selectedItems;
                }
            } else {
                if (dimensionSelector.lov.selectedItem) {
                    dimensionSelectedItems.push(dimensionSelector.lov.selectedItem);
                    dimensionSelectedItem = dimensionSelector.lov.selectedItem;
                }
            }

            return {
                multiSelect: dimensionSelector.lov.multiSelect,
                selectedItem: dimensionSelectedItem,
                selectedItems: dimensionSelectedItems,
            }
        },

        /*
         * Can be used to return the object of the selected dimensions as below:
         * object.selectedLocales
         * object.selectedSources
         * object.selectedContexts
         */
        getSelectedDimensions: function () {
            // var dimensionData = {};

            // dimensionData.selectedContexts = [this._getSelectedValue(this.configData.catalogSelector.catalogItems,
            //     this.configData.catalogSelector.selectedCatalogItems)];
            // dimensionData.selectedSources = [this._getSelectedValue(this.configData.sourceSelector.sourceItems,
            //     this.configData.sourceSelector.selectedSourceItems)];
            // dimensionData.selectedLocales = [this._getSelectedValue(this.configData.localeSelector.localeItems,
            //     this.configData.localeSelector.selectedLocaleItems)];

            // return dimensionData;
        },

        _getSelectedValue: function (data, selectedItems) {
            if (data != undefined && data != null) {
                for (var i = 0; i < data.length; i++) {
                    if (this._indexOfItem(selectedItems, data[i])) {
                        return data[i].value;
                    }
                }
            }
        },

        _indexOfItem: function (selectedItems, selectedItemToCompare) {
            var isSelected = false;

            selectedItems.forEach(function (item) {
                if (item.id == selectedItemToCompare.id) {
                    isSelected = true;
                }
            }, this);

            return isSelected;
        },

        _setSelectedDimension: function () {
            this.selectedDimensions = undefined;
            this.selectedDimensions = {
                "lists": this.listSelector.selectedItems,
                "sources": this.sourceSelector.selectedItems,
                "locales": this.localeSelector.selectedItems
            };
        }
    });
</script>