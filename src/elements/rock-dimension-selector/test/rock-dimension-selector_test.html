<!doctype html>

<html>
  <head>
    <title>dimension-selector test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../../bower_components/web-component-tester/browser.js"></script>
    <script src="../../../../bower_components/iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../../../../bower_components/iron-demo-helpers/demo-pages-shared-styles.html"/>
    <link rel="import" href="../../../../bower_components/iron-test-helpers/test-helpers.html" />
    <link rel="import" href="../rock-dimension-selector.html"/>   
  </head>
  <body>

    <test-fixture id="dimensionSelector">
      <template>        
        <rock-dimension-selector></rock-dimension-selector>
      </template>
    </test-fixture>   
        
    <script>
        suite('dimension-selector', function() {
          var dimensionSelectorElement;

          setup(function() {
            dimensionSelectorElement = fixture('dimensionSelector');
            dimensionSelectorElement.configData = config;
          });

          test('instantiating the dimension selector works', function() {
              assert.equal(dimensionSelectorElement.is, 'rock-dimension-selector');            
          });

          test('dimensions with visible flag set to true are displayed', function() {
              // date selector visible flag is set to false. So, shouldn't be visible
              Polymer.dom.flush();
              var dateSelector = document.getElementById('dateDropdown');
              
              assert.equal(dateSelector, undefined); 
          });

          test('dropdown with a pre-selected item works', function() {
              // catalog selector has master item has selected flag set to true 
               Polymer.dom.flush();
               var catalogSelector = document.getElementById('catalogDropdown');
               var masterCatalog = Polymer.dom(catalogSelector).querySelectorAll('paper-item')[1];
               expect(catalogSelector.selectedItem).to.be.equal(masterCatalog);               
          });

          test('no. of items in the dropdown match with the no. of items given in config', function() {
              // catalog selector has 2 items - master and staging. So, count should be 2.
               Polymer.dom.flush();
               var catalogSelector = document.getElementById('catalogDropdown');
               var totalItems = Polymer.dom(catalogSelector).querySelectorAll('paper-item');
               assert.equal(totalItems.length, 2);               
          });

          test('dropdown opens when tapped', function(done) {              
               Polymer.dom.flush();
               var catalogSelector = document.getElementById('catalogDropdown');
               var content = Polymer.dom(catalogSelector).querySelector('.dropdown-content');

               var contentRect = content.getBoundingClientRect();
                expect(contentRect.width).to.be.equal(0);
                expect(contentRect.height).to.be.equal(0);
                runAfterOpen(catalogSelector, function() {
                    contentRect = content.getBoundingClientRect();
                    expect(catalogSelector.opened).to.be.equal(true);
                    expect(contentRect.width).to.be.greaterThan(0);
                    expect(contentRect.height).to.be.greaterThan(0);
                    done();
                });
                expect(catalogSelector.opened).to.be.equal(true);

          });

          test('dropdown closes when an item is selected', function(done) {
               Polymer.dom.flush();
               var catalogSelector = document.getElementById('catalogDropdown');
               var content = Polymer.dom(catalogSelector).querySelector('.dropdown-content');

               runAfterOpen(catalogSelector, function() {
                    var firstItem = Polymer.dom(content).querySelector('paper-item');
                    MockInteractions.tap(firstItem);
                    Polymer.Base.async(function() {
                        expect(catalogSelector.opened).to.be.equal(false);
                        done();
                    });
                });
          });
      });    

      function runAfterOpen(menu, callback) {
        menu.$.menuButton.$.dropdown.addEventListener('iron-overlay-opened', function() {
            Polymer.Base.async(callback, 1);
        });
        MockInteractions.tap(menu);
      }

      var config = {
                "catalogSelector": {
                    "visible": true,
                    "catalogItems": [      
                        {
                            "text": "Staging",
                            "value": "StagingCatalog",
                            "icon": ""
                        },
                        {
                            "text": "Master",
                            "value": "MasterCatalog",
                            "icon": "",
                            "selected": true
                        }
                    ]
                },
                "sourceSelector": {
                    "visible": true,
                    "sourceItems": [
                        {
                            "text": "Source",
                            "value": "source1",
                            "icon": "",  
                            "selected": true
                        },
                        {
                            "text": "SAP",
                            "value": "SAP",
                            "icon": ""
                        }
                    ]
                },
                "dateSelector": {
                    "visible": false
                },
                "localeSelector": {    
                    "visible": true,
                    "localeItems": [
                        {
                            "text": "en-US",
                            "value": "en-US",
                            "icon": "",
                            "selected": true
                        },
                        {
                            "text": "de-DE",
                            "value": "de-DE",
                            "icon": ""
                        }
                    ]
                }
            }

    </script>
  </body>
</html>
