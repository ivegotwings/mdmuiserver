<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-logger-behavior/bedrock-logger-behavior.html">

<link rel="import" href="../pebble-iframe/pebble-iframe.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<dom-module id="app-external-dashboard">
    <template>
        <style>
            rock-layout {
                --rock-footer-background-color: #f5f7f9;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <rock-layout>
            <rock-titlebar slot="rock-titlebar" icon="[[appConfig.icon]]" main-title="[[appConfig.title]]">
            </rock-titlebar>
            <template is="dom-if" if="[[!_loading]]">
                <pebble-iframe source="[[embeddUrl]]"></pebble-iframe>
            </template>
        </rock-layout>
    </template>
    <script>
        class AppExternalDashboard extends Polymer.mixinBehaviors([RUFBehaviors.AppBehavior, RUFBehaviors.ComponentConfigBehavior, RUFBehaviors.LoggerBehavior], Polymer.Element) {
            static get is () {
                return "app-external-dashboard";
            }
            static get properties () {
                return {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    dashboardName: {
                        type: String,
                        value: ""
                    },
                    dashboardConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _loading: {
                        type: Boolean,
                        value: true
                    }
                };
            }

            disconnectedCallback () {
                super.disconnectedCallback();
            }
            connectedCallback () {
                super.connectedCallback();
                let userContext = {
                    "roles": this.roles,
                    "user": this.userId,
                    "ownershipData": this.ownershipData,
                    "tenant": this.tenantId,
                    "defaultRole": this.defaultRole
                };

                this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];

                this.dashboardName = this.appConfig && this.appConfig.data_route;
                if (this.dashboardName) {
                    this.contextData[ContextHelper.CONTEXT_TYPE_APP] = [{
                        "app": this.dashboardName
                    }];

                    this.requestConfig("rock-" + this.dashboardName, this.contextData);
                } else {
                    this.logError("Dashboard name not found.");
                }
            }
            onConfigLoaded (componentConfig) {
                if (componentConfig && componentConfig.config) {
                    this.set("dashboardConfig", componentConfig.config);
                    if (this.dashboardConfig.url.indexOf("[[WEB-URL]]") !== -1) {
                        let originUrl = window.location.origin + this.dashboardConfig.url.substring(this.dashboardConfig
                            .url.lastIndexOf(":"), this.dashboardConfig.url.length);
                        this.dashboardConfig.url = originUrl;
                    }
                    this.embeddUrl = this.dashboardConfig.url;
                    if (this.dashboardConfig.urlPath) {
                        this.embeddUrl += this.dashboardConfig.urlPath;
                    }
                    Polymer.Async.timeOut.after(ConstantHelper.MILLISECONDS_100).run(() => {
                        this._loading = false;
                    });
                } else {
                    this.logError("Component config not found", "", true);
                }
            }
        }

        customElements.define(AppExternalDashboard.is, AppExternalDashboard);
    </script>
</dom-module>