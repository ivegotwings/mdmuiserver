<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<link rel="import" href="../rock-search-filter/rock-search-filter.html">


<!--
`rock-entity-search-filter` component is used to filter entities in grid. It provides mechanism to add filter criteria for the entities grid.

-->

<dom-module id="rock-entity-search-filter">
    <template>
        <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-entity-discovery"
                                     context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
        <rock-search-filter id="search-filter"
                            icon="pebble-sm-icons:Filter-wt" 
                            text="Refine More" 
                            filters="[[filters]]" 
                            tags="{{tags}}" 
                            context-data="[[_contextData]]" 
                            hide-search-trigger>
        </rock-search-filter>
        <bedrock-pubsub event-name="tag-value-change" handler="_onSearchTagValueChange"></bedrock-pubsub>
        <bedrock-pubsub event-name="tag-item-remove" handler="_onTagItemRemove"></bedrock-pubsub>
</template>

<script> 
    (function () {
        'use strict';

        Polymer({
            is: 'rock-entity-search-filter',
            properties: {
                
                _selectedSearchFilters:{
                    type:Array,
                    notify:true
                },
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: '_prepareContext'
                },
                _contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                typesCriterion: {
                    type: Array,
                    observer: '_prepareContext'
                },
                /**
                 * Indicates the request object that is passed to the data element to retrive the attribute model data.
                 */
                attributeModelRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }

            },
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior
            ],

            // Refine Filter
            _onTagItemRemove: function (e, detail) {
                if (detail != undefined) {
                    this._removeFilterWithName(detail.name);
                    var _selectedSearchFilters = this._selectedSearchFilters;
                    this._selectedSearchFilters = [];
                    this._selectedSearchFilters = _selectedSearchFilters;
                }
            },

            _onSearchTagValueChange: function (e, detail, sender) {
                if (detail != undefined) {
                    var attrCond = {};
                    attrCond[detail.name] = detail.value;
                    this._removeFilterWithName(detail.name);

                    var _selectedSearchFilters = this._selectedSearchFilters;
                    this._selectedSearchFilters = [];

                    _selectedSearchFilters.push(attrCond);

                    this._selectedSearchFilters = _selectedSearchFilters;
                }
            },

            _removeFilterWithName: function (name) {
                if (this._selectedSearchFilters && this._selectedSearchFilters.length > 0) {
                    for (var i = 0; i < this._selectedSearchFilters.length; i++) {
                        if (this._selectedSearchFilters[i][name]) {
                            this._selectedSearchFilters.splice(i, 1);
                        }
                    }
                }
            },

            _prepareContext: function() {
                if(!_.isEmpty(this.contextData) && this.typesCriterion && this.typesCriterion.length > 0)
                {
                    var itemContexts=[];
                    for(var i in this.typesCriterion) {
                        var itemContext = {
                            'type': this.typesCriterion[i]
                        };
                        itemContexts.push(itemContext);
                    }
                    
                    this._contextData = DataHelper.cloneObject(this.contextData);
                    this._contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
//                    this._getAttributeModels(this._contextData);
                }
            }
        });
    })();
</script>
</dom-module>