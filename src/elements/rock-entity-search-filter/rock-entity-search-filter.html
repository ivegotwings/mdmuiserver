<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">

<link rel="import" href="../rock-search-filter/rock-search-filter.html">


<!--
`rock-entity-search-filter` Represents a component that renders the entity search filter control.
It filters the entities in the grid and provides a mechanism to add the filter criteria for the entities in the grid.
@demo demo/index.html
-->

<dom-module id="rock-entity-search-filter">
    <template>
        <rock-search-filter id="search-filter" attributes-type="[[attributesType]]" icon="pebble-icon:Filter" text="Refine More" filters-config="[[filtersConfig]]" tags="{{tags}}"
            context-data="[[contextData]]" hide-search-trigger>
        </rock-search-filter>
        <bedrock-pubsub event-name="tag-value-change" handler="_onSearchTagValueChange"></bedrock-pubsub>
        <bedrock-pubsub event-name="tag-item-remove" handler="_onTagItemRemove"></bedrock-pubsub>
        <bedrock-pubsub event-name="filter-tags-remove" handler="_onFilterTagsRemove"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-entity-search-filter',
                properties: {

                    selectedSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true,
                        observer: '_prepareContext'
                    },
                    _contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    typesCriterion: {
                        type: Array,
                        observer: '_prepareContext'
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    domains: {
                        type: Array,
                        value: function () { return []; }
                    },
                    tags: {
                        type: Array,
                        value: function () { return []; }
                    },
                    attributesType: {
                        type: String,
                        value: "self"
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.AppContextBehavior
                ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                clearSearchFilters: function () {
                    this.shadowRoot.querySelector('#search-filter').removeAllSearchFilters();
                },

                // Refine Filter
                _onTagItemRemove: function (e, detail) {
                    if (detail != undefined) {
                        if(!detail.options) {
                            return;
                        }
                        this._removeFilterWithName(detail.name);
                        if (detail.options.type == "context") {
                            var context = {};
                            var contextData = this.contextData[this.CONTEXT_TYPE_DATA];
                            if (contextData.length) {
                                context = contextData[0];
                            }
                            delete context[detail.name];
                            this.updateContext(this.CONTEXT_TYPE_DATA, [context]);
                        } else {
                            var _selectedSearchFilters = this.selectedSearchFilters;
                            this.selectedSearchFilters = undefined;
                            this.selectedSearchFilters = _selectedSearchFilters;
                        }
                    }
                },

                _onFilterTagsRemove: function(e, detail) {
                    var tags = detail || [];
                    if(tags.length == 0) {
                        return;
                    }
                    
                    for(var i = 0; i < tags.length; i++) {
                        this._removeFilterWithName(detail[i].name);
                    }
                },

                _onSearchTagValueChange: function (e, detail, sender) {
                    if (detail != undefined) {
                        if (detail.type == "context") {
                            var context = {};
                            var val = detail.value.eq;
                            var contextData = this.contextData[this.CONTEXT_TYPE_DATA];
                            if (contextData.length) {
                                context = contextData[0];
                            }
                            context[detail.name] = val;
                            this.updateContext(this.CONTEXT_TYPE_DATA, [context]);
                        } else {
                            var attrCond = {};
                            attrCond[detail.name] = detail.value;
                            this._removeFilterWithName(detail.name);

                            var _selectedSearchFilters = DataHelper.cloneObject(this.selectedSearchFilters);
                            _selectedSearchFilters.push(attrCond);

                            this.set('selectedSearchFilters',  _selectedSearchFilters);
                        }
                    }
                },

                _removeFilterWithName: function (name) {
                    if (this.selectedSearchFilters && this.selectedSearchFilters.length > 0) {
                        for (var i = 0; i < this.selectedSearchFilters.length; i++) {
                            if (this.selectedSearchFilters[i][name]) {
                                this.selectedSearchFilters.splice(i, 1);
                            }
                        }
                    }
                },

                _prepareContext: function () {
                    if (!_.isEmpty(this.contextData)) {
                        var domain;
                        if(this.domains){
                            domain=this.domains[0];
                        }
                        if(this.typesCriterion && this.typesCriterion.length > 0) {
                           var itemContexts = [];
                           for (var i in this.typesCriterion) {
                               var itemContext = {
                                   'type': this.typesCriterion[i],
                                   "domain":domain
                               };
                               itemContexts.push(itemContext);
                           }
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts
                        }
                    }
                },

                formatFilterCollectionDisplay: function(collection, seperator) {
                    var searchFilter = this.shadowRoot.querySelector('#search-filter');

                    if(searchFilter) {
                        return searchFilter.formatFilterCollectionDisplay(collection, seperator);
                    }    
                },

                refresh: function() {
                     var searchFilter = this.shadowRoot.querySelector('#search-filter');
                     if(searchFilter && searchFilter.refresh) {
                         searchFilter.refresh();
                     }
                }
            });
        })();

    </script>
</dom-module>