<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/juicy-html/juicy-html.html">
<link rel="import" href="../pebble-external-html/pebble-external-html.html">
<link rel="import" href="../../../../bower_components/pebble-button/pebble-button.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<dom-module id="pebble-templatizer">
	<template>
		<style include="bedrock-style-common">
			:host {
				height: 100%;
				display: block;
			}
		</style>
		<pebble-external-html html="{{template}}" model="[[dataModel]]"></pebble-external-html>
		<placeholder></placeholder>
		<template is="dom-if" if="{{showeditor}}">
			<div style="width:100%;height:100%">
				<textarea style="resize:none;width:100%;height:85%" name="textarea"></textarea>
				<div style="margin-left:40%">
					<pebble-button noink class="btn btn-secondary m-r-10" button-text="Cancel" raised on-click="_viewHtml">Cancel</pebble-button>
					<pebble-button noink class="btn btn-success" button-text="Save" raised on-click="_saveHtml" class="green save">Save</pebble-button>
				</div>
			</div>
		</template>
		<bedrock-pubsub on-bedrock-event-editpreviewclicked="_editHtml" name="bedrock-event-editpreviewclicked"></bedrock-pubsub>
		<bedrock-pubsub on-bedrock-event-viewdatareceived="_viewDataReceived" name="bedrock-event-viewdatareceived"></bedrock-pubsub>
		<bedrock-pubsub on-bedrock-event-datamodelready="_modelDataReceived" name="bedrock-event-datamodelready"></bedrock-pubsub>
	</template>
	<script>
		(function () {
			Polymer({
				is: 'pebble-templatizer',

				properties: {
					dataModel: {
						type: Object,
						value: function () {
							return {};
						}
					},
					showeditor: {
						type: Boolean,
						value: false
					},
					view: {
						type: String,
						value: ''
					}
				},

				behaviors: [
					Polymer.Templatizer,
					RUFBehaviors.AppBehavior
				],

				attached: function () {},

				ready() {},

				embbedLoops() {
					if (this.html.indexOf('loop') !== -1) {
						this.html = this.html
							.replace(/<\bloop\b/g, '<template is="dom-repeat"')
							.replace(/<\/\bloop\b>/g, '</template>');
					}
				},

				embbedfonts: function () {
					this.fonts = this.view.substring(this.view.indexOf('<font>') + 6, this.view.indexOf(
						'</font>'));
					this.fonts.split(';').forEach(url => {
						let link = document.createElement('link');
						link.rel = 'stylesheet';
						link.href = url.replace(/\s/g, '');
						document.head.appendChild(link);
					})
				},

				embbedRichText: function () {
					let richtexts = Polymer.dom(this.root).querySelectorAll('.richtext');
					if (richtexts) {
						richtexts.forEach(richtext => {
							let content = richtext.getAttribute('data-content');
							richtext.innerHTML = content;
						})
					}
				},

				parseViewModel: function () {
					this.html =
						this.view.substring(this.view.indexOf('<html>') + 6, this.view.indexOf(
							'</html>'));

					this.externStyle = this.view.substring(this.view.indexOf('<style>') + 7, this.view.indexOf(
						'</style>'));
				},

				evalJS() {
					try {
						RUFUtilities.templateRoot = this;
						eval(this.externjs);
					} catch (e) {
						console.log('Error', e);
					}
				},

				parseJS() {
					this.externjs = this.view.substring(this.view.indexOf('<js>') + 4, this.view.indexOf(
						'</js>'));
					let regex = /(document.querySelector\()/gm;
					this.externjs = this.externjs.replace(regex, "Polymer.dom(RUFUtilities.templateRoot.root).querySelector(");
					regex = /(document.querySelectorAll\()/gm;
					this.externjs = this.externjs.replace(regex, "Polymer.dom(RUFUtilities.templateRoot.root).querySelectorAll(");
				},

				fetchImages() {
					this.images = Polymer.dom(this.root).querySelectorAll('img');
					this.images.forEach(image => {
						let imageid = image.getAttribute('data-imageid');
						if (imageid) {
							this._getImageDownloadUrl(imageid);
						}
					})
				},

				_processTemplate: function () {
					this.parseViewModel();
					this.embbedLoops();
					this.embbedfonts();
					this._compileTemplate();
					this.fetchImages();
					setTimeout(() => {
						this.embbedRichText();
						this.parseJS();
						this.evalJS();
					}, 300);
				},

				_compileTemplate: function () {
					this.template =
						`
                            <dom-bind>
                                <template is="dom-bind" id="templateroot">
									${this.html}
									<style>
                                        ${this.externStyle}
                                    </style>
                                </template>
                            </dom-bind>                    
						`
				},

				_editHtml: function () {
					this._showEditor();
				},

				_saveHtml: function () {
					this.view = Polymer.dom(this.root).querySelectorAll('textarea')[0].value;
					let eventData = {
						name: "savepreviewclicked",
						data: this.view
					};
					this.dispatchEvent(new CustomEvent('bedrock-event', {
						detail: eventData,
						bubbles: true,
						composed: true
					}));
				},

				_viewHtml: function () {
					this.showeditor = false;
					this.template = "";
					this._viewDataReceived();
				},

				_showEditor: function () {
					this.showeditor = true;
					Polymer.Async.timeOut.after(100).run(() => {
						Polymer.dom(this.root).querySelectorAll('textarea')[0].value = this.view;
					});
					let range = document.createRange();
					let endNode = Polymer.dom(this.root).querySelectorAll('placeholder')[0];
					let startNode = Polymer.dom(this.root).querySelectorAll('pebble-external-html')[0];
					range.setStart(startNode, 0);
					range.setEnd(endNode, 0);
					this.embeddedDocumentFragment = range.extractContents();
					for (let i = 0; i < this.embeddedDocumentFragment.children.length; i++) {
						this.embeddedDocumentFragment.children.item(i).setAttribute('hidden', true);
					}
					range.detach();
				},

				_getImageDownloadUrl: function (fileName) {
					if (fileName) {
						var req = {
							"binaryStreamObject": {
								"id": fileName,
								"type": "binarystreamobject",
								"data": {}
							}
						};
						var downloadUrlLiquid = this._createLiquidRest("/data/binarystreamobjectservice/prepareDownload", this._onGetDownloadUrlResponse);

						if (downloadUrlLiquid) {
							downloadUrlLiquid.requestData = [req];
							downloadUrlLiquid.generateRequest();
						}
					}
				},

				_createLiquidRest: function (url, responseEvent) {
					var liquidElement = document.createElement("liquid-rest");
					liquidElement.url = url;
					liquidElement.method = "POST";
					DataHelper.oneTimeEvent(liquidElement, 'liquid-response', responseEvent.bind(this));
					return liquidElement;
				},

				_viewDataReceived: function () {
					if (this.view) {
						let regex = /({{model.)(\w+).(\w+)}}/g;
						let attributes = [];
						let relationships = [];
						let relationshipAttributes = [];
						let m = regex.exec(this.view);
						while (m) {
							if (m) {
								m[0] = m[0].substr(m[0].indexOf('{{') + 2, m[0].indexOf("}}") - 2);
								let elems = m[0].split('.');
								if (elems.length === 2) {
									//attribute
									if (attributes.indexOf(elems[1]) === -1) {
										attributes.push(elems[1])
									}
								} else if (elems.length === 3) {
									//relationship
									if (relationships.indexOf(elems[1]) === -1) {
										relationships.push(elems[1]);
									}
									if (elems[2].indexOf('prop') === -1) {
										//relationship attribute
										relationshipAttributes.push(elems[2]);
									}
								}
							}
							m = regex.exec(this.view);
						}
						if (relationships.indexOf('hasimages') === -1) {
							relationships.push('hasimages');
						}
						let eventData = {
							name: "entitydatakeys",
							data: {
								attributes: attributes,
								relationships: relationships,
								relationshipAttributes: relationshipAttributes
							}
						};
						this.dispatchEvent(new CustomEvent('bedrock-event', {
							detail: eventData,
							bubbles: true,
							composed: true
						}));
					}
				},

				_modelDataReceived: function () {
					this._processTemplate();
				},

				_onGetDownloadUrlResponse: function (e) {
					LiquidResponseHelper.downloadURLResponseMapper(e, (downloadURL, objectKey) => {
						this.images.forEach(img => {
							let imageid = img.getAttribute('data-imageid');
							if (imageid && imageid === objectKey) {
								img.src = downloadURL;
							}
						})
					});
				},
			})
		})()
	</script>
</dom-module>