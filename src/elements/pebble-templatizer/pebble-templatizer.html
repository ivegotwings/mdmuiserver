<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/juicy-html/juicy-html.html">

<dom-module id="pebble-templatizer">
    <template>
        <style>
            :host {
                height: 100%;
                display: block;
            }
        </style>
        <juicy-html html="{{template}}" model="{{viewmodel}}"></juicy-html>
        <div></div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'pebble-templatizer',

                properties: {
                    viewmodel: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    dataModel: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: "_onDataModelChange"
                    }
                },

                behaviors: [
                    Polymer.Templatizer
                ],

                ready() {
                    this.viewModel = {
                        name: 'entity',
                        price: '30',
                        colors: ['red', 'blue', 'green']
                    };

                    this.view =
                        `
                            <html>
                                <span> Name {{model.name}} </span>
                                <span> Price {{model.price}}</span>
                                <loop items="{{model.colors}}" as="color">
                                    <p>{{color}}</p>
                                </loop>
                            </html>
                            <style>
                                :host {
                                height: 100%;
                                display: block;
                                } 
                                span{
                                    color: red;
                                    font-size:16px;
                                } 
                                p{
                                    color: blue;
                                    font-size: 10px;
                                }                                 
                            </style>
                            <script>
                                setTimeout(() => {
                                    console.log('ok');
                                    throw(new Error('test error'));
                                },3000)        
                            <\/script>
                        `

                    this.template =
                        `
                            <dom-bind>
                                <template is="dom-bind">
                                    <style>
                                        ${this.externStyle}
                                    </style>
                                    ${this.html}
                                </template>
                            </dom-bind>                    
                    `
                    this.parseViewModel();
                },

                embbedLoops() {
                    if (this.html.indexOf('loop') !== -1) {
                        this.html = this.html
                            .replace(/<\bloop\b/g, '<template is="dom-repeat"')
                            .replace(/<\/\bloop\b>/g, '</template>');
                    }
                },

                parseViewModel: function () {
                    this.html =
                        this.view.substring(this.view.indexOf('<html>') + 6, this.view.indexOf(
                            '</html>'));
                    this.externStyle = this.view.substring(this.view.indexOf('<style>') + 7, this.view.indexOf(
                        '</style>'));
                    this.externJs = this.view.substring(this.view.indexOf('<script>') + 8, this.view.indexOf(
                        '<\/script>'));
                    this.embbedLoops();
                    this.evalJS();
                },

                evalJS() {
                    try {
                        eval(this.externJs);
                    } catch (e) {
                        console.log(e.error);
                    }
                },

                _onDataModelChange: function (dataModel) {
                    console.log('Templatizer', dataModel);
                }

            })
        })()
    </script>
</dom-module>