<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-tags/rock-tags.html">
<!--
`<pebble-combo-box>` Represents an element which contains dimension selection.

### Example:

    <pebble-combo-box id="guideme" selected-items="{{selectedItems}}"></pebble-combo-box>

@group rock Elements
@element pebble-combo-box
@demo demo/index.html
-->

<dom-module id="pebble-combo-box">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">

            pebble-textbox::shadow paper-input {
                margin-top: -25px;
            }

        </style>
        <rock-tags id="rockTags" tags="{{tags}}"  is-non-editable
                   current-tag="{{currentTag}}" class="p-l-10 p-r-10"></rock-tags>
        <pebble-textbox id="line" no-Label-Float type="text" readonly on-tap="_openPopover">
            <pebble-icon icon="icons:arrow-drop-down"  suffix></pebble-icon>
        </pebble-textbox>
        <pebble-popover id="popover" for="line" >
            <pebble-lov id="lov" items="{{items}}" multi-select="[[multiSelect]]" no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]" show-image="[[showImage]]"  show-color="[[showColor]]" selected-item="{{selectedItem}}" selected-items="{{selectedItems}}" on-selection-changed="_lovSelectionChanged">
            </pebble-lov>
        </pebble-popover>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-combo-box',

                properties: {
                    "tags":{
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },
                    /*
                     * Specifies whether or not multiple items is selected at once. When it is set to <b>true</b>,
                     * multiple items are selected at a time. In this case, selected is an array of currently selected items.
                     * When it is set to <b>false</b>, only one item is selected at a time.
                     */
                    multiSelect: {
                        type: Boolean,
                        value: false,
                        observer: '_clear'
                    },
                    /*
                     * Specifies whether or not to show image with item text.
                     */
                    showImage: {
                        type: Boolean,
                        value: false
                    },
                    /*
                     * Specifies whether to show color with item text or not
                     */

                    showColor: {
                        type: Boolean,
                        value: false
                    },
                    /*
                     * Specifies whether or not to show subtitle.
                     */
                    noSubTitle: {
                        type: Boolean,
                        value: false
                    },
                    /*
                     * Specifies whether or not to show action buttons
                     */
                    showActionButtons: {
                        type: Boolean,
                        value: false
                    },
                    /*
                     * Indicates an array of items that determines how many instances of the template
                     * to stamp and to what instances the template binds to.
                     */
                    items: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /*
                     * Indicates the currently selected item when multiSelection is false.
                     * It indicates null if no item is selected.
                     */
                    selectedItem: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    /*
                     * Indicates an array that contains the selected items when the  multiselection is true.
                     */
                    selectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    }

                },
                listeners: {
                    'tag-item-remove':'_tagItemRemoved'
                },
                _openPopover:function (e) {
                    this.$.popover.positionTarget = e.currentTarget;
                    this.$.popover.open();
                },
                _lovSelectionChanged:function (e) {
                    if(!this.multiSelect){
                        this.splice('tags',0,1);
                        this.$.rockTags.addTag({"name":e.detail.item.title});
                        this.$.popover.hide();
                    } else{
                        var item=e.detail.item;
                        if(this.selectedItems.indexOf(item)==-1){
                            for(var i=0;i<this.tags.length;i++){
                                if(this.tags[i].name==item.title){
                                    this.splice('tags',i,1);
                                }
                            }
                        } else{
                            this.$.rockTags.addTag({"name":item.title});
                        }
                    };
                    this.fire('selection-changed');
                },
                _tagItemRemoved:function (e,detail) {
                    if(!this.multiSelect){
                        this.selectedItem="";
                    } else{
                        for(var i=0;i<this.selectedItems.length;i++){
                            if(this.selectedItems[i].title==detail.name){
                                this.splice('selectedItems', i, 1);
                                var selectedItems=this.selectedItems;
                                this.selectedItems=[];
                                this.selectedItems=selectedItems;
                            }
                        }
                    }
                }
            });
        })();
    </script>

</dom-module>