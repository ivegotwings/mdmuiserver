<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="../pebble-textbox-collection/pebble-collection-container.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`<pebble-combo-box>` Represents an element which contains dimension selection.

### Example:

    <pebble-combo-box
            id='multi-select-lov' 
            items='[{"id":1,"title":"color", "color": "blue"},{"id":2, "title":"Size", "color": "red"}]'
            selected-items='[{"id":1,"title":"color", "color": "blue"},{"id":2, "title":"Size", "color": "red"}]'
            multi-select 
            label="Multi Selection">
            Multi selection combo-box
    </pebble-combo-box>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--text-collection-container` | Mixin applied to component | {}
`--line-with-icon` | Mixing for a line and dropdown icon section | {}
`--line-with-icon-readonly` | Mixing for a line and dropdown icon section when readonly | {}
`--text-collection-label` | Mixin applied to component label | {}
`--tags-container` | Mixin applied to tags container | {}
`--combo-box-tag-value` | Mixin applied to tag value | {}
`--tag-close-icon` | Mixin applied to tag close | {}
`--text-collection-popover` | Mixin applied to tags collection popover | {}
`--dropdown-icon` | Mixin applied to dropdown icon | {}
`--pebble-combobox-lov` | Mixing applied for LOV | {}

@group pebble Elements
@element pebble-combo-box
@demo demo/index.html
-->

<dom-module id="pebble-combo-box">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">

            pebble-collection-container {
                @apply(--line-with-icon);
                @apply(--line-with-icon-readonly);
                @apply(--text-collection-container);
                @apply(--text-collection-label);
                @apply(--tags-container);
                @apply(--tag-content);                
                @apply(--tag-close);
                @apply(--text-collection-popover);
                @apply(--dropdown-icon);
                --tag-value :{
                   cursor: default; 
                   @apply(--combo-box-tag-value);
                }
            }

            pebble-lov {
                @apply(--pebble-combobox-lov);
            }
            pebble-collection-container::shadow pebble-tags::shadow pebble-tag-item::shadow .tag-value{
                width: 50px;
                display: block;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

        </style>
        <bedrock-pubsub event-name="on-tap-arrow-icon" handler="_onTapArrowIcon"></bedrock-pubsub>
        <pebble-collection-container label="[[label]]" values="{{values}}" is-readonly="[[isReadonly]]"  display-limit="[[displayLimit]]">
            <pebble-lov id="lov" data-source="{{dataSource}}" items="{{items}}" multi-select="[[multiSelect]]" no-sub-title="[[noSubTitle]]" 
            show-action-buttons="[[showActionButtons]]" show-image="[[showImage]]"  show-color="[[showColor]]" 
            selected-items="{{_lovSelectedItems}}" selected-item="{{_lovSelectedItem}}" on-selection-changed="_lovSelectionChanged">
            </pebble-lov>
        </pebble-collection-container>        
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-combo-box',

                properties: {
                    /**
                     * Indicates tag items
                     */
                    values: {
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify: true
                    },

                    /**
                     * Indicates label for tag collection
                     */
                    label: {
                        type: String,
                        value: null
                    },

                    /**
                     * Indicates readonly or not
                     */
                    isReadonly: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Indicates tags display limit
                     */
                    displayLimit: {
                        type: Number
                    },

                    /*
                     * Specifies whether or not multiple items is selected at once. When it is set to <b>true</b>,
                     * multiple items are selected at a time. In this case, selected is an array of currently selected items.
                     * When it is set to <b>false</b>, only one item is selected at a time.
                     */
                    multiSelect: {
                        type: Boolean,
                        value: false
                    },
                    
                    /*
                     * Specifies whether or not to show image with item text.
                     */
                    showImage: {
                        type: Boolean,
                        value: false
                    },

                    /*
                     * Specifies whether to show color with item text or not
                     */
                    showColor: {
                        type: Boolean,
                        value: false
                    },

                    /*
                     * Specifies whether or not to show subtitle.
                     */
                    noSubTitle: {
                        type: Boolean,
                        value: false
                    },

                    /*
                     * Specifies whether or not to show action buttons
                     */
                    showActionButtons: {
                        type: Boolean,
                        value: false
                    },

                    /*
                     * Indicates an array of items that determines how many instances of the template
                     * to stamp and to what instances the template binds to.
                     */
                    items: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectedIds: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },
                    selectedId: {
                        type: String,
                        value: "",
                        notify: true
                    },

                    /*
                     * Indicates the currently selected item when multiSelection is false.
                     * It indicates null if no item is selected.
                     */
                    _lovSelectedItem: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },

                    /*
                     * Indicates an array that contains the selected items when the  multiselection is true.
                     */
                    _lovSelectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior
                ],

                listeners: {
                    'tag-item-remove':'_tagItemRemoved'
                },

                observers: [
                   '_onSelectedIdsChange(selectedIds)',
                   '_onSelectedIdChange(selectedId)'
                ],

                 _getCollectionContainer: function() {
                    return ElementHelper.getElement(this, "pebble-collection-container");
                },

                /**
                 * Can be used to add a tag to collection
                 */
                add: function(item){
                    this._getCollectionContainer().add(item);
                },

                /**
                 * Can be used to remove a tag from collection
                 */
                remove: function(item){
                    this._getCollectionContainer().remove(item);
                },

                /**
                 * Can be used to know is tag exists in collection or not
                 */
                isExists: function(item){
                    return this._getCollectionContainer().isExists(item);
                },

                _onTapArrowIcon: function (e, detail, sender) {                                       
                    this._getCollectionContainer().openPopover();     
                    this.$$("pebble-lov")._ensureItemsRendered();
                },
                              
                _lovSelectionChanged:function (e) {
                    if(!this.multiSelect) {
                        this.splice('values',0,1);
                        var _color = e.detail.item.color ? e.detail.item.color : '#d2d7dd'; //If null apply default color
                        this.add({"name": e.detail.item.id, "color": _color});
                        this._getCollectionContainer().closePopover();
                        this.set('selectedId', e.detail.item.id);
                    } else {
                        var item = e.detail.item;
                        if(this._lovSelectedItems.indexOf(item) == -1) {
                            var indexToRemove = -1;
                            for(var i = 0; i < this.values.length; i++){
                                if(this.values[i].name == item.id) {
                                    indexToRemove = i;
                                }
                            }
                            if(indexToRemove > -1) {
                                //this.splice('values', indexToRemove, 1);
                                var _values = this.values;
                                this.values = [];
                                _values.splice(indexToRemove, 1);
                                this.values = _values;
                            }
                            indexToRemove = -1;
                            for(var i = 0; i < this.selectedIds.length; i++){
                                if(this.selectedIds[i] == item.id) {
                                    indexToRemove = i;
                                }
                            }
                            if(indexToRemove > -1) {
                                //this.splice('selectedIds', indexToRemove, 1);
                                var _selectedIds = this.selectedIds;
                                this.selectedIds = [];
                                _selectedIds.splice(indexToRemove, 1);
                                this.selectedIds = _selectedIds;
                            }
                        } else {
                            this.add({"name": item.id, "color": "#d2d7dd"});
                            //this.push('selectedIds', item.id);
                            //this.selectedIds = this._pushHack(this.selectedIds, item.id);
                            //TODO: tried couple of things, see above... nothing worked!
                            var _selectedIds = this.selectedIds;
                            this.selectedIds = [];
                            if(typeof(_selectedIds) !== "object") {
                                _selectedIds = [];
                            }
                            _selectedIds.push(item.id);
                            this.selectedIds = _selectedIds;
                        }
                    };
                    this.fire('selection-changed');
                },

                _tagItemRemoved:function (e,detail) {
                    if(!this.multiSelect) {
                        this._lovSelectedItem = {};
                        this.selectedId = "";
                    } else {
                        var indexToRemove = -1;
                        for(var i = 0; i < this.selectedIds.length; i++) {
                            if(this.selectedIds[i] == detail.name) {
                                indexToRemove = i;
                                break;
                            }
                        }
                        if(indexToRemove > -1) {
                            this.splice('selectedIds', indexToRemove, 1);
                            var _selectedIds = this.selectedIds;
                            this.selectedIds = [];
                            this.selectedIds = _selectedIds;
                        }
                        indexToRemove = -1;
                        for(var i = 0; i < this._lovSelectedItems.length; i++) {
                            if(this._lovSelectedItems[i].id == detail.name) {
                                indexToRemove = i;
                                break;
                            }
                        }
                        if(indexToRemove > -1) {
                            this.splice('selectedItems', indexToRemove, 1);
                            var _selectedItems = this._lovSelectedItems;
                            this._lovSelectedItems = [];
                            this._lovSelectedItems = _selectedItems;
                        }
                    }
                },

                // _onSelectedItemsChange: function(){
                //     this.$$('pebble-lov').selectedItems = [];
                //     this.$$('pebble-lov').selectedItems = this._lovSelectedItems;
                    
                //     for(var i = 0; i < this._lovSelectedItems.length; i++)
                //     {
                //         //this.add({"name": this._lovSelectedItems[i], "color": "#d2d7dd"});
                //         this.add({"name": this._lovSelectedItems[i].title, "color": this._lovSelectedItems[i].color});
                //     }
                // },

                // _onSelectedItemChange: function(){                    
                //     this.$$('pebble-lov').selectedItem = this._lovSelectedItem;

                //     if(this._lovSelectedItem.title)
                //     {
                //         //this.add({"name": this._lovSelectedItems[i], "color": "#d2d7dd"});
                //         this.add({"name": this._lovSelectedItem.title, "color": this._lovSelectedItem.color});
                //     }
                // },

                 _onSelectedIdsChange: function(){

                    var tempSelectedItems = [];
                    for(var i = 0; i < this.selectedIds.length; i++)
                    {
                        //this.add({"name": this._lovSelectedItems[i], "color": "#d2d7dd"});
                        this.add({"name": this.selectedIds[i], "color": "#d2d7dd"});
                        tempSelectedItems.push({ "id": this.selectedIds[i], "title": this.selectedIds[i]});
                    }


                    this._lovSelectedItems = [];
                    this._lovSelectedItems = tempSelectedItems;
                },

                _onSelectedIdChange: function(){                    

                    if(this.selectedId)
                    {
                        this.set('selectedItem', { "id": this.selectedId, "title": this.selectedId });
                        //this.add({"name": this._lovSelectedItems[i], "color": "#d2d7dd"});
                        this.add({"name": this.selectedId, "color": "#d2d7dd"});
                    }
                },

                _pushHack: function(array, newItem) {
                    var temp = array;
                    array = [];
                    temp.push(newItem);
                    return temp;
                },
                refreshData:function () {
                    this.$$('pebble-lov').refreshData();
                }
            });
        })();
    </script>

</dom-module>