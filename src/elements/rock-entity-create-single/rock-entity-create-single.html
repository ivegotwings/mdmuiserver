<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">

<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">
<link rel="import" href="../rock-compare-entities/rock-compare-entities.html">
<!--
`rock-entity-create-single` Represents a component that renders a panel with the initial set of 
attributes during the single entity creation. 

@demo demo/index.html
-->


<dom-module id="rock-entity-create-single">
    <template>
        <style include="bedrock-style-common">
            #content-actions {
                position: fixed;
                bottom: 30px;
                left: 50%;
                text-align: center;
                z-index: 99;
                -webkit-transform: translateX(-50%);
                -moz-transform: translateX(-50%);
                -o-transform: translateX(-50%);
                transform: translateX(-50%);
                @apply --entity-create-action-button;
            }
            #errorsDialog {
                --popup-header-color: var(--palette-pinkish-red, #ee204c);
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-rest id="entityMatchService" 
                     url="/data/pass-through/matchservice/search" 
                     method="POST" 
                     request-data={{_entityMatchRequest}}
                     on-liquid-response="_onMatchSuccess" 
                     on-liquid-error="_onMatchFailure">
        </liquid-rest>
        <liquid-rest id="entityGovernService" 
                     url="/data/pass-through/entitygovernservice/validate" 
                     method="POST" 
                     request-data={{_entityGovernRequest}}
                     on-liquid-response="_onEntityGovernResponse" 
                     on-liquid-error="_onEntityGovernFailed">
        </liquid-rest>  
        <pebble-dialog id="updateConfirmDialog" modal small vertical-offset = 150 horizontal-align="auto" vertical-align="auto" no-cancel-on-outside-click no-cancel-on-esc-key dialog-title="Found Match">             
              <p>Found the below matching entity in system: </p>
              <ul>
                  <li>Entity Id: [[_matchedEntity.id]]</li>
                  <li>Entity Type: [[_matchedEntity.type]]</li>
              </ul>
              <p>Do you want to update the entity?</p>
              <div class="buttons">
                <pebble-button id="ok" class="close btn btn-secondary m-r-5" button-text="Update" on-tap="_updateEntity"></pebble-button>
                <pebble-button id="skip" class="apply btn btn-success" button-text="Cancel" on-tap="_cancelProcess"></pebble-button>
              </div>
        </pebble-dialog>
        <pebble-dialog id="errorsDialog" modal small vertical-offset = 150 horizontal-align="auto" vertical-align="auto" no-cancel-on-outside-click no-cancel-on-esc-key dialog-title="Errors on page">
            <p>Found below errors in entity details: </p>
            <ul>
                <template is="dom-repeat" items="[[_syncValidationErrors]]">
                    <li>[[item.attributeExternalName]] with error: [[item.message]]</li>
                </template>
            </ul>             
            <p>Do you want to fix the errors or continue?</p>  
            <div class="buttons">
                <pebble-button id="skip" class="close btn btn-secondary m-r-5" button-text="Skip & Continue" on-tap="_skipServerErrors" ></pebble-button>
                <pebble-button id="ok"  class="apply btn btn-success" button-text="Fix" on-tap="_fixServerErrors" ></pebble-button>
              </div>
        </pebble-dialog>
        <div id="content-entity-create">
            <rock-attribute-list attribute-values="[[_attributeValues]]" attribute-models="[[_attributeModels]]" context-data="[[contextData]]" 
                                no-of-columns="3" mode="[[mode]]" attribute-messages="[[_attributeMessages]]"></rock-attribute-list>
            <div id="content-actions" class="p-b-10" align="center">
                <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onSkipTap"></pebble-button>
                <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
            </div>
        </div>
        <div id="content-entity-match" hidden>
            <rock-compare-entities id="matchEntities" compare-entities-context="[[compareEntitiesContext]]" attribute-names="[[attributeNames]]" show-action-buttons enable-column-select></rock-compare-entities>
        </div>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{attributeModelRequest}}"
                on-entity-model-composite-get-response = "_onCompositeModelGetResponse" >
        <liquid-entity-data-save name="entitySaveService" operation="create" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
            on-response="_onSaveResponse" on-error="_onSaveError" ></liquid-entity-data-save>
        <bedrock-pubsub event-name="error-length-changed" handler="_errorLengthChanged"></bedrock-pubsub>
        <bedrock-pubsub event-name="compare-entities-back" handler="_onCompareEntitiesBack" target-id="matchEntities"></bedrock-pubsub>
        <bedrock-pubsub event-name="compare-entities-create" handler="_onCompareEntitiesCreate" target-id="matchEntities"></bedrock-pubsub>
        <bedrock-pubsub event-name="compare-entities-merge" handler="_onCompareEntitiesMerge" target-id="matchEntities"></bedrock-pubsub>
    </template>
     <script>
            (function () {
                'use strict';

                Polymer({
                    is: "rock-entity-create-single",

                    properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                        contextData: {
                            type:Object,
                            value: function(){
                                return {};
                            }
                        },
                        /**
                         * Indicates the names of the attributes that are rendered while creating a single entity.
                         */
                        attributeNames: {
                            type: Array,
                            value: function() {
                                return [];
                            }
                        },
                        /**
                         * Indicates the mode in which the attributes are rendered.
                         */
                        mode: {
                            type: String,
                            value: "edit",
                            notify: true
                        },
                        /**
                         * Specifies the request object for the attribute model request.
                         */
                        attributeModelRequest: {
                            type: Object,
                            value: function() {
                                return {};
                            }
                        },
                        /**
                         * Specifies the response object for the attribute models.
                         */
                        attributeModelResponse: {
                            type: Object,
                            value: function() {
                                return {};
                            }
                        },
                        _attributeValues: {
                            type: Array,
                            value: function() {
                                return [];
                            }
                        },
                        _attributeMessages: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        _saveRequest: {
                            type: Object,
                            value: function() { return {}; }
                        },
                        _loading: {
                            type: Boolean,
                            value: false
                        },
                        /**
                         * Specifies the length of the error message.
                         */
                        errorLength: {
                            type: Number,
                            notify: true,
                            value: 0
                        },
                        _entityMatchRequest: {
                            type: Object,
                            value: function() { return {}; }
                        },
                         _matchedEntity: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        compareEntitiesContext: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        _syncValidationErrors: {
                            type: Array,
                            value: function() { return []; }
                        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                        messageCodeMapping: {
                            type: Object,
                            value: function() { return {}; }
                        },
                        skipNext: {
                            type: Boolean,
                            value: false
                        },
                        matchConfig: {
                            type: Object,
                            value: function () { return {}; }
                        },
                        enableMatchStep: {
                            type: Boolean,
                            value: false
                        },
                        defaultEntity: {
                            type: Object,
                            value: function () { return {}; }
                        }
                    },
                    observers: [
                        '_contextChanged(attributeNames, contextData)'
                    ],
                    behaviors: [
                        RUFBehaviors.UIBehavior,
                        RUFBehaviors.ComponentContextBehavior
                    ],
                    _contextChanged: function(attributeNames, contextData) {
                        if (attributeNames && attributeNames.length > 0 && !_.isEmpty(contextData)) {
                            var firstItemContext = this.getFirstItemContext();

                            if(typeof(firstItemContext) != "undefined") {
                                firstItemContext.attributeNames = attributeNames;
                            }

                            var t = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                            this.set("attributeModelRequest", t);

                            var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                            if (liquidModelGet) {
                                liquidModelGet.generateRequest();
                            }
                        }
                    },
                    _onCompositeModelGetResponse: async function(e) {
                        var values = [];
                        if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                            this._attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);
                            values = await DataTransformHelper.transformAttributes({}, this._attributeModels, this.contextData, "array", true);
                        }
                        this._attributeValues = values;
                    },
                    _onSaveTap: function(e) {
                        //raise event with name given for onNextAction in configuration
                        var attributeList = this.shadowRoot.querySelector('rock-attribute-list');
                        var changedAttributeElements = attributeList.getChangedAttributeElements();

                        if(attributeList.hasModelErrors()) {
                            this.showErrorToast("Cannot save. Please resolve the errors.");
                            return;
                        }
                        if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                            this.showErrorToast("No changes to save.");
                            return;
                        }

                        var attributesJSON = [];
                        for (var i = 0; i < changedAttributeElements.length; i++) {
                            var attributeElement = changedAttributeElements[i];
                            var attributeJSON = attributeElement.attributeObject;
                            attributesJSON.push(attributeJSON);
                        }

                        var itemCtx = this.getFirstItemContext();
                        var entityType = itemCtx.type;
                        var entityId = "e" + ElementHelper.getRandomString();
                        itemCtx.id = entityId;
                        var newEntity = DataTransformHelper.prepareEntityForCreate(entityId, entityType, attributesJSON, this.contextData, DataHelper.getUserName(), this.defaultEntity);
                        ComponentHelper.getParentElement(this).contextData=this.contextData;
                        
                        this._saveRequest = {
                            "entities": [newEntity]
                        };

                        //Add hotline flag if hotline is enabled
                        if(DataHelper.isHotlineModeEnabled()) {
                            this._saveRequest["hotline"] = true;
                        }

                        //Set match request
                        this.set('_entityMatchRequest', {
                            "entity": newEntity
                        });

                        const entityMatchService = this.shadowRoot.querySelector("#entityMatchService");
                        if(entityMatchService) {
                            entityMatchService.generateRequest();
                        }
                    },
                    _onMatchSuccess: function(e, detail) {
                        if(detail.response)
                        {
                            var response = detail.response.response;
                            if((response.dataObjectOperationResponse &&response.dataObjectOperationResponse.status &&
                                response.dataObjectOperationResponse.status.toLowerCase() == "error") || 
                                (response.status && response.status.toLowerCase() == "error"))
                            {
                                this.logWarning("MatchServiceRequestFail","response",JSON.stringify(detail));
                                this.showErrorToast("There is a problem in match service. Please contact administrator.");
                                return;
                            }

                            if(response.status && response.status.toLowerCase() == "success") {
                                if(response.entities) {
                                    if (!this.enableMatchStep) {
                                        if (response.entities.length == 1) {
                                            this._matchedEntity = response.entities[0];
                                            this.shadowRoot.querySelector('#updateConfirmDialog').open();
                                        } else if (response.entities.length > 1) {
                                            this.showErrorToast("We found multiple entites matching in our system. Please check entity details or contact your administrator.");
                                        }
                                        return;
                                    }

                                    var matchedEntityIds = response.entities.map(entity => entity.id);
                                    var entityType = ContextHelper.getFirstItemContext(this.contextData).type;

                                    this.compareEntitiesContext = {
                                        "newEntity": DataHelper.cloneObject(this._entityMatchRequest.entity),
                                        "entityIds": matchedEntityIds,
                                        "entityTypes": [entityType],
                                        "contextData": DataHelper.cloneObject(this.contextData),
                                        "matchConfig": this.matchConfig
                                    }
                                    this._hideView("entity-create");
                                    this._showView("entity-match");
                                } else {
                                    this._triggerGovernRequest();
                                }
                            }
                        }
                    },

                    _triggerGovernRequest: function() {
                        var governReq = DataHelper.cloneObject(this._entityMatchRequest);

                        this.set("_entityGovernRequest", governReq);
                        var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                        if (liquidSave) {
                            liquidSave.operation = "create";
                        }
                        var liquidGovernGet = this.$.entityGovernService;
                        if (liquidGovernGet) {
                            liquidGovernGet.generateRequest();
                        }
                    },

                    _onMatchFailure: function(e, detail) {
                        this.logWarning("MatchServiceRequestFail","response",JSON.stringify(detail));
                        this.showErrorToast("There is a problem in match service. Please contact administrator.");
                    },

                    _updateEntity: function() {
                        if (!this.enableMatchStep) {
                            var updateConfirmDialog = this.$.updateConfirmDialog;
                            if (updateConfirmDialog) {
                                updateConfirmDialog.close();
                            }
                        }
                        var clientState = {};
                        clientState.notificationInfo = {};
                        clientState.notificationInfo.showNotificationToUser = false;
                        this._saveRequest["clientState"] = clientState;
                        this._saveRequest.entities[0].id = this._matchedEntity.id;
                        var itemCtx = this.getFirstItemContext();
                        itemCtx.id = this._matchedEntity.id;
                        var governReq = DataHelper.cloneObject(this._entityMatchRequest);

                        this.set("_entityGovernRequest", governReq);
                        var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                        if (liquidSave) {
                            liquidSave.operation = "update";
                        }
                        var liquidGovernGet = this.$.entityGovernService;
                        if (liquidGovernGet) {
                            liquidGovernGet.generateRequest();
                        }
                    },
                    _cancelProcess: function() {
                        var updateConfirmDialog = this.$.updateConfirmDialog;
                        if(updateConfirmDialog) {
                            updateConfirmDialog.close();
                        }
                    },
                    _onSaveResponse: function(e) {
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName,
                            data: { "skipNext": this.skipNext }
                        }
                        this._loading = true;
                        var itemCtx = this.getFirstItemContext();
                            var msg="";
                            if(e.detail.request.operation == "create") {
                                msg = "Entity created successfully.";
                            }
                            if(e.detail.request.operation == "update") {
                                msg = "Entity updated successfully.";
                            }
                            var data = {
                                "messages": [
                                    {
                                        "message": msg
                                    }
                                ],
                                "actions": [
                                    {
                                        "name": "closeFunction",
                                        "text": "Take Me back to Where I started"
                                    },
                                    {
                                        "name": "showEntity",
                                        "text": "Show me the entity",
                                        "dataRoute": "entity-manage",
                                        "queryParams": { "id": itemCtx.id, "type": itemCtx.type}
                                    },
                                    {
                                        "name": "createEntity",
                                        "text": "Create one more",
                                        "dataRoute": "entity-create",
                                        "queryParams": { "type": itemCtx.type}
                                    }
                                ]
                            };
                            ComponentHelper.fireBedrockEvent("entity-created",{"id":itemCtx.id,"type":itemCtx.type} , { ignoreId: true });
                        ComponentHelper.getParentElement(this).businessFunctionData=data;
                        setTimeout(() =>{
                            this._loading = false;
                            this.showSuccessToast(msg);
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 100);
                    },
                    _onSaveError: function(e) {
                        // To Remove
                        var messsage = e.detail.response.content.msg;
                        this.showErrorToast(messsage);
                    },
                    _onSkipTap: function(e) {
                        //raise event with name given for onbackAction in configuration
                        var data;
                        var eventName = "onCancel";
                        var eventDetail = {
                            name: eventName,
                            data: data
                        }
                        this.fireBedrockEvent(eventName, eventDetail, {
                            ignoreId: true
                        });
                    },
                    _errorLengthChanged: function (e) {
                        this.errorLength = e.detail.data;
                    },
                    _onEntityGovernResponse: function (e) {
                        var response = e.detail.response;
                        if(response.response && response.response.status && response.response.status.toLowerCase() == "success") {
                            var res = response.response;
                            var itemContext = this.getFirstItemContext();
                            var entityId;
                            if(itemContext) {
                                entityId = itemContext.id;
                            }

                            var entity = DataHelper.findEntityById(res.entities, entityId);
                            var attrMessages = {};
                            if (entity && entity.data && entity.data.attributes) {
                                var attributes = entity.data.attributes;
                                attrMessages = MessageHelper.getAttributeMessages(attributes, this._attributeModels, this.messageCodeMapping, this.localize());
                            }
                            if(!_.isEmpty(attrMessages)) {
                                var errorMessages = MessageHelper.getErrorsFromAttrMessages(attrMessages, this._attributeModels);
                                this.set("_syncValidationErrors", errorMessages);
                                this.shadowRoot.querySelector('#errorsDialog').open();
                                return;
                            } else {
                                var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                                if (liquidSave) {
                                    liquidSave.generateRequest();
                                }
                            }
                        } else {
                            this.logWarning("EntityCreateValidationFail","response",JSON.stringify(e.detail.response));
                            this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                        }
                    },
                    _onEntityGovernFailed: function (e) {
                        this.logWarning("EntityCreateValidationFail","response",JSON.stringify(e));
                        this.showErrorToast("There is a problem in validation service. Please contact administrator.");
                    },
                    _skipServerErrors: function() {
                        var errorDialog = this.$.errorsDialog;
                        if(errorDialog) {
                            errorDialog.close();
                        }
                        var liquidSave = this.shadowRoot.querySelector("[name=entitySaveService]");
                        if (liquidSave) {
                            liquidSave.generateRequest();
                        }
                    },
                    _fixServerErrors: function() {
                        var errorDialog = this.$.errorsDialog;
                        if(errorDialog) {
                            errorDialog.close();
                        }
                        if(this._syncValidationErrors) {
                            var newAttributeMessages = {};
                            for(var i=0;i<this._syncValidationErrors.length;i++) {
                                var attributeMessages = this._syncValidationErrors[i];
                                var attributeName = attributeMessages.attributeName;
                                var message = attributeMessages.message;
                                if(attributeName && message) {
                                   newAttributeMessages[attributeName] = [message];
                                }
                            }
                        }
                        this.set('_attributeMessages', newAttributeMessages);
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    getIsDirty: function() {
                        var attributeList = this.shadowRoot.querySelector('rock-attribute-list');
                        var changedAttributeElements = attributeList.getChangedAttributeElements();
                        return changedAttributeElements && changedAttributeElements.length > 0;
                    },

                    _showView: function (viewName) {
                        if (viewName) {
                            var contentView = this.shadowRoot.querySelector("#content-" + viewName);
                            if (contentView) {
                                contentView.removeAttribute("hidden");
                            }
                        }
                    },

                    _hideView: function (viewName) {
                        if (viewName) {
                            var contentView = this.shadowRoot.querySelector("#content-" + viewName);
                            if (contentView) {
                                contentView.setAttribute("hidden", "");
                            }
                        }
                    },

                    _onCompareEntitiesBack: function(e, detail) {
                        this._hideView("entity-match");
                        this._showView("entity-create");
                    },

                    _onCompareEntitiesCreate: function(e, detail) {
                        this._triggerGovernRequest();
                    },

                    _onCompareEntitiesMerge: function(e, detail) {
                        this._matchedEntity = detail.matchedEntity;
                        this._updateEntity();
                    }
                });
            })();
        </script>
</dom-module>