<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-attribute-list/rock-attribute-list.html">

<dom-module id="rock-entity-create-single">
    <template>
        <style include="pebble-styles-shared">
            #content-actions {
                padding-top: 30px;
            }
        </style>
        <rock-attribute-list attribute-values="[[_attributeValues]]" attribute-models="[[_attributeModels]]" no-of-columns="3" mode="{{mode}}"></rock-attribute-list>
        <div id="content-actions" class="p-b-10" align="center">
            <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onSkipTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{attributeModelRequest}}" 
            on-response="_onCompositeModelGetResponse"></liquid-entity-model-composite-get>
        <liquid-entity-data-save name="attributeSaveDataService" operation="create" request-data="{{_saveRequest}}" last-response="{{_saveResponse}}"
            on-response="_onSaveResponse"></liquid-entity-data-save>
    </template>
     <script>
            (function () {
                'use strict';

                Polymer({
                    is: "rock-entity-create-single",

                    properties: {
                        /**
                         * Indicates the names of the attributes that are rendered while creating a single entity.
                         */
                        attributeNames: {
                            type: Array,
                            value: function() {
                                return [];
                            }
                        },
                        /**
                         * Indicates the mode in which the attributes are rendered.
                         */
                        mode: {
                            type: String,
                            value: "edit",
                            notify: true
                        },
                        /**
                         * Specifies the request object for attribute model request.
                         */
                        attributeModelRequest: {
                            type: Object,
                            value: function() {
                                return {};
                            }
                        },
                        /**
                         * Specifies the response object for attribute models.
                         */
                        attributeModelResponse: {
                            type: Object,
                            value: function() {
                                return {};
                            }
                        },
                        /**
                         * Specifies the source in which entity has to be created.
                         */
                        source: {
                            type: String
                        },
                        /**
                         * Specifies the locale in which entity has to be created.
                         */
                        locale: {
                            type: String
                        },
                        /**
                         * Specifies the list in which entity has to be created.
                         */
                        list: {
                            type: String
                        },
                        /**
                         * Specifies the classification in which entity has to be created.
                         */
                        classification: {
                            type: String
                        },
                        /**
                         * Specifies the type of the entity to be created.
                         */
                        entityType: {
                            type: String
                        },
                        context: {
                            type: Object,
                            value: function() {
                                return {};
                            }
                        },
                        _attributeValues: {
                            type: Array,
                            value: function() {
                                return [];
                            }
                        },
                        _saveRequest: {
                            type: Object,
                            value: function() { return {}; }
                        }
                    },
                    observers: [
                        '_contextChanged(attributeNames, context)'
                    ],
                    behaviors: [
                        RUFBehaviors.UIBehavior
                    ],
                    ready: function() {
                        this._prepareContext();
                    },
                    _prepareContext: function() {
                        this.source = DataHelper.getParamValue("source");
                        this.locale = DataHelper.getParamValue("locale");
                        this.list = DataHelper.getParamValue("list");
                        this.classification = DataHelper.getParamValue("classification");
                        this.entityType = DataHelper.getParamValue("entityType");
                        var context = {
                            "list": this.list,
                            "source": this.source,
                            "locale": this.locale,
                            "classification": this.classification,
                            "entityType": this.entityType
                        };
                        this.set("context", context);
                    },
                    _getCurrentCtx: function() {
                        var ctxItem = {};
                        //ctxItem.list = this.list;
                        ctxItem.classification = this.classification;
                        return ctxItem;
                    },
                    _contextChanged: function(attributeNames, context) {
                        if (attributeNames && attributeNames.length > 0) {
                            var context = this._getCurrentCtx();
                            var t = {
                                "params": {
                                    "query": {
                                        "ctx": [
                                            context
                                        ],
                                        "locale": this.locale,
                                        "name": this.entityType
                                    },
                                    "fields": {
                                        "ctxTypes": [
                                            "properties"
                                        ],
                                        "attributes": attributeNames
                                    }
                                }
                            };
                            this.set("attributeModelRequest", t);
                            var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                            if (liquidModelGet) {
                                liquidModelGet.generateRequest();
                            }
                        }
                    },
                    _onCompositeModelGetResponse: function(e) {
                        var values = [];

                        if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {

                            var valCtx = {
                                "locale": this.locale,
                                "source": this.source
                            };

                            var context = this._getCurrentCtx();
                            this._attributeModels = DataHelper.transformAttributeModelsToUIFormat(e.detail.response.content.entityModels[0], context);
                            values = DataHelper.transformAttributesToManageFormat({}, this._attributeModels, valCtx);
                        }
                        this._attributeValues = values;
                    },
                    _onSaveTap: function(e) {
                        //raise event with name given for onNextAction in configuration
                        var attributeList = Polymer.dom(this).node.root.querySelector('rock-attribute-list');
                        var changedAttributeElements = attributeList.getChangedAttributeElements();
                        if (changedAttributeElements == undefined || changedAttributeElements.length == 0) {
                            // document.querySelector('#app').toastText = "No changes to save";
                            // document.querySelector('#app').$.pebbleAppToast.show();
                            return {
                                "message": "No changes to save"
                            };
                        }
                        var attributesJSON = [];
                        for (var i = 0; i < changedAttributeElements.length; i++) {
                            var attributeElement = changedAttributeElements[i];
                            var attributeJSON = attributeElement.attributeObject;
                            attributesJSON.push(attributeJSON);
                        }
                        var changedAttributes = DataHelper.transformAttributeFromUIFormat(attributesJSON);
                        var entityData = {};
                        entityData = this._getEntityData(changedAttributes);

                        //TODO:: this must come from some model config
                        this._populateEntityIdFromAttrVal(entityData, changedAttributes, "cpimProductName");
                        this._populateEntityIdFromAttrVal(entityData, changedAttributes, "shortDescription");
                        this._populateEntityIdFromAttrVal(entityData, changedAttributes, "skuid");
                        this._saveRequest = {
                            "entities": entityData
                        };
                        var liquidSave = this.$$("[name=attributeSaveDataService]");
                        if (liquidSave) {
                            liquidSave.generateRequest();
                        }
                    },
                    _populateEntityIdFromAttrVal: function(entities, changedAttributes, attrName) {
                        if (attrName in changedAttributes) {
                            var attr = changedAttributes[attrName];

                            if (attr.values && attr.values.length > 0) {
                                entities[0].id = attr.values[0].value;
                            }
                        }
                    },
                    _onSaveResponse: function(e) {
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName
                        }
                        this.fireBedrockEvent(eventName, eventDetail, {
                            ignoreId: true
                        });
                    },
                    _onSkipTap: function(e) {
                        //raise event with name given for onbackAction in configuration
                        var data;
                        var eventName = "onCancel";
                        var eventDetail = {
                            name: eventName,
                            data: data
                        }
                        this.fireBedrockEvent(eventName, eventDetail, {
                            ignoreId: true
                        });
                    },
                    _getRandomString: function() {
                        var x = 2147483648;
                        return Math.floor(Math.random() * x).toString(36) +
                            Math.abs(Math.floor(Math.random() * x) ^ new Date().getTime()).toString(36);
                    },
                    _getEntityData: function(attributes) {
                        var entityId = "e" + this._getRandomString();
                        var data = [];
                        var context = this._getCurrentCtx();
                        var entity = {
                            id: entityId,
                            type: this.entityType,
                            properties: {
                                "createdBy": "John Doe"
                            },
                            data: {
                                contexts: [{
                                    "context": context,
                                    "attributes": attributes
                                }]
                            }
                        };
                        data.push(entity);
                        return data;
                    },
                });
            })();
        </script>
</dom-module>