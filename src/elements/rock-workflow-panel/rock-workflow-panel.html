<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../liquid-governance-workflow-definition-get/liquid-governance-workflow-definition-get.html">
<link rel="import" href="../liquid-governance-workflow-runtimeinstance-get/liquid-governance-workflow-runtimeinstance-get.html">

<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-stepper/pebble-step-details.html">
<link rel="import" href="../pebble-stepper/pebble-step-badge-content.html">

<link rel="import" href="rock-workflow-panel-step-details.html">

<dom-module id="rock-workflow-panel">
    <template>
        <style include="pebble-styles-shared"></style>
        <style>
            #workflowButton {
                --pebble-button: {
                    height: 30px; 
                    padding: 0.5em 2em 0.5em 0em !important; 
                    background-color: #eaeaea;
                    font-weight: bolder !important;                                    
                }
               --pebble-button-left-icon: {
                        height: 24px;
                        width: 24px;
                        padding-bottom: 2px; 
                }
            }
            #workflowButton::shadow paper-button{
                height: 40px;
                padding: 15px;
                width: 100%;
                font-size: 16px;
            }
            #workflow-stepper {
                margin-top: 20px;
            }         
            .workflowtext{
                width: 131px;
                height: 14px;
                font-family: Roboto;
                font-size: 12px;
                color:var(--palette-steel-grey); 
            }
            .workflow-stepper {
                --pebble-connected-badge-width: 30px;
                --pebble-connected-badge-height: 30px;
                --connectorLine-width: 2px;
                --content-connectorLine-width: 9px;
                --pebble-connected-badge-fontSize: 14px;
            }
            pebble-step-details {
                margin-left: 5px;
            }
            pebble-stepper::shadow pebble-step::shadow #step-subtitle{
                font-size:var(--default-font-size) !important;
            }
        </style>
        <liquid-governance-workflow-definition-get id="entityGetWorkflowDefinition" auto operation="getbyids" request-id="req1" request-data={{workflowDefinitionRequest}} 
                last-response={{workflowDefinitions}} on-response="_onDefinitionReceived" on-error="_onDefinitionGetFailed"></liquid-governance-workflow-definition-get>
        <liquid-governance-workflow-runtimeinstance-get id="entityGetRunningInstance" operation="getbyids" request-id="req2" request-data={{runningInstanceRequest}} 
                last-response={{workflowRuntimeInstances}} on-response="_onRunningInstanceReceived" on-error="_onRunningInstanceGetFailed"></liquid-governance-workflow-runtimeinstance-get>
        <pebble-button id="invokeButton" raised class="workflowButton" 
            button-text="invoke Workflow" on-tap="_invokeWorkflow"></pebble-button>
        <pebble-button id="workflowButton" raised class="workflowButton" icon="chevron-right" 
            button-text="[[_workflowstepperData.workflowName]]" on-tap="_onWorkFlowTap"></pebble-button>
        <iron-collapse id="collapse">
            <div id="workflow-description">
                <!-- work flow description here-->
                <span class="workflowtext">[[_getWorkFlowDescription(_workflowstepperData)]]</span>
            </div>
            <div id="workflow-stepper">
                <!-- place stepper here-->
                <bedrock-pubsub event-name="pebble-step-action-click" handler="_onStepActionTap" target-id=""></bedrock-pubsub>
                <pebble-stepper id="workflowStepper" stepper-config="[[_workflowstepperData]]">
                    <template is="dom-repeat" items="[[_workflowstepperData.items]]" as="item">
                        <pebble-step class="workflow-stepper" data="{{item}}">
                            <pebble-step-badge-content>
                                <template is="dom-if" if="[[_userHasImage()]]">
                                    <pebble-image-viewer class="user-image" shape="circle" sizing="contain" 
                                        src="../../images/no-photo.jpg"></pebble-image-viewer>
                                </template>
                                <template is="dom-if" if="[[!_userHasImage()]]">
                                    <span>[[item.index]]</span>
                                </template>
                            </pebble-step-badge-content>
                            <pebble-step-details>
                                <rock-workflow-panel-step-details step-item="[[item]]" workflow-attributes="[[_wfAttributes]]"></rock-workflow-panel-step-details> 
                            </pebble-step-details>
                        </pebble-step>
                    </template>
                </pebble-stepper>
            </div>
        </iron-collapse>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: "rock-workflow-panel",
                properties: {
                    /**
                     * Indicates the context parameters for which the workflow has to be loaded.
                     * JSON sample to be added here.
                     */
                    context: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /*
                    * Indicates the Id of the workflow.
                    */
                    _workflowId: {
                        type: String
                    },
                    _workflowstepperData: {
                        type: Object,
                        value: function() { return {}; }
                    },
                    _wfAttributes: {
                        type: Object,
                        value: function() { return {}; }
                    },
                    /*
                    * Indicates the request to fetch the workflow definition based on workflowId.
                    */
                    workflowDefinitionRequest: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "ctx": [
                                            {
                                                "list": "workflowDefinitions"
                                            }
                                        ],
                                        "valCtx": [
                                            {
                                                "source": "self",
                                                "locale": "en-US"
                                            }
                                        ],
                                        "id": "productCreationWorkflow_id",
                                        "filters": {
                                            "attributesCriterion": [],
                                            "typesCriterion": [
                                                "workflowDefinition"
                                            ]
                                        }
                                    },
                                    "fields": {
                                        "ctxTypes": [
                                            "properties"
                                        ],
                                        "attributes": [
                                            "workflowName",
                                            "workflowVersion",
                                            "published",
                                            "activities"
                                        ],
                                        "relationships": [
                                            "ALL"
                                        ]
                                    }
                                }
                            };
                        }
                    },
                    /*
                    * Indicates the request object to fetch current running workflow instances information.
                    */
                    runningInstanceRequest: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "ctx": [
                                            {
                                                "list": "productMaster"
                                            }
                                        ],
                                        "valCtx": [
                                            {
                                                "source": "self",
                                                "locale": "en-US"
                                            }
                                        ],
                                        "id": "e1_workflow_runtimeinstance",
                                        "filters": {
                                            "attributesCriterion": [],
                                            "typesCriterion": [
                                                "workflowRuntimeInstance"
                                            ]
                                        }
                                    },
                                    "fields": {
                                        "ctxTypes": [
                                            "properties"
                                        ],
                                        "attributes": [
                                            "workflowInstanceId",
                                            "status",
                                            "startDateTime",
                                            "endDateTime",
                                            "activities"
                                        ],
                                        "relationships": [
                                            "ALL"
                                        ]
                                    }
                                }
                            };
                        }
                    },
                    _workflowDefinitionRespose: {
                        type: Object,
                        value: function() { return {}; }
                    },
                    _runningInstanceResponse: {
                        type: Object,
                        value: function() { return {}; }
                    }
                },
                 behaviors: [
                    RUFBehaviors.UIBehavior
                ],
                observers: [
                    '_contextChanged(context)'
                ],
                _contextChanged: function(context) {
                    if(context) {
                        // context object will have entityid. Need to get workflow the given entity is part of
                        // and give it here. Will be replaced once logic in place.
                        this._workflowId = "productCreationWorkflow_id";
                    }
                },
                _generateRequest: function() {
                    this.$$('#entityGetRunningInstance').generateRequest();
                },
                _onDefinitionReceived: function(e) {
                    var workflowDefinitionResponse = e.detail.response;
                    this.set("_workflowDefinitionRespose", workflowDefinitionResponse);
                    // generate request to get running instances
                    this._generateRequest();
                },
                _onDefinitionGetFailed: function (e) {
                    Polymer.Base._error('workflow definition get failed with error ', e.detail);
                },
                _onRunningInstanceReceived: function(e) {
                    var runningInstanceResponse = e.detail.response;
                    this.set("_runningInstanceResponse", runningInstanceResponse);
                    var workflowstepperData = this._transformEntityResponseToStepperJson(this._workflowDefinitionRespose, this._runningInstanceResponse);
                    this.set("_workflowstepperData", workflowstepperData);
                },
                _onRunningInstanceGetFailed: function(e) {
                    Polymer.Base._error('running instance get failed with error ', e.detail);
                },
                _transformEntityResponseToStepperJson: function(workflowDefinition, runningInstance) {
                    var runtimeInstanceId = "e1_workflow_runtimeinstance";
                    if(workflowDefinition && workflowDefinition.content && workflowDefinition.content.entities && this._workflowId in workflowDefinition.content.entities
                        && runningInstance && runningInstance.content && runningInstance.content.entities && runtimeInstanceId in runningInstance.content.entities) {
                            var riContextKey = Object.keys(runningInstance.content.entities[runtimeInstanceId].data.ctxInfo)[0];
                            var riAttributes = runningInstance.content.entities[runtimeInstanceId].data.ctxInfo[riContextKey].attributes;
                            var wfContextKey = Object.keys(workflowDefinition.content.entities[this._workflowId].data.ctxInfo)[0];
                            var wfattributes = workflowDefinition.content.entities[this._workflowId].
                            data.ctxInfo[wfContextKey].attributes;
                            var riActivities = riAttributes.activities;
                            var wfActivities = wfattributes.activities;

                            var attributes = wfattributes;
                            var i = 0;
                            while(Object.keys(riAttributes)[i] && Object.keys(riAttributes)[i] != "activities") {
                                var key = Object.keys(riAttributes)[i];
                                attributes[key] = riAttributes[key];
                                i++;
                            }
                            var activitiesJson = wfActivities;
                            for(var i=0; i<activitiesJson.groups.length; i++) {
                                var wfActivity = activitiesJson.groups[i];
                                var wfActivityGuid = DataHelper.getFirstAttributeValue(wfActivity.activityGuid);
                                for(var j=0; j<riActivities.groups.length; j++) {
                                    var riActivity = riActivities.groups[j];
                                    var riActivityGuid = DataHelper.getFirstAttributeValue(riActivity.activityGuid);
                                    var riActivityStatus = DataHelper.getFirstAttributeValue(riActivity.status);
                                    if(riActivityGuid == wfActivityGuid) {
                                        riActivity["sequence"] = wfActivity["sequence"];
                                        riActivity["activityName"] = wfActivity["activityName"];
                                        riActivity["activityDescription"] = wfActivity["activityDescription"];
                                        if(riActivityStatus == "Executing") {
                                            riActivity["actions"] = wfActivity["actions"];
                                        }
                                        activitiesJson.groups[i] = riActivity;
                                    }
                                }
                            }
                            attributes["activities"] = activitiesJson;
                            this.set("_wfAttributes", attributes);
                            if(attributes) {
                                var config = {
                                    "workflowName": DataHelper.getFirstAttributeValue(attributes.workflowName),
                                    "startDateTime": DataHelper.getFirstAttributeValue(attributes.startDateTime),
                                    "endDateTime": DataHelper.getFirstAttributeValue(attributes.endDateTime),
                                    "status": DataHelper.getFirstAttributeValue(attributes.status),
                                    "items": []
                                };
                                var activities = attributes.activities;
                                var items = [];
                                for(var i=0; i<activities.groups.length; i++) {
                                    var k = activities.groups.length - 1;
                                    var group = activities.groups[k-i];
                                    var actions = [];
                                    if(group && group.actions && group.actions.groups && group.actions.groups.length) {
                                        for(var j=0; j<group.actions.groups.length; j++) {
                                            var actionsGroup = group.actions.groups[j];
                                            var action = {
                                                "action": DataHelper.getFirstAttributeValue(actionsGroup.actionText),
                                                "event": DataHelper.getFirstAttributeValue(actionsGroup.actionName)
                                            };
                                            actions.push(action);
                                        }
                                    }
                                    var item = {
                                        "id": DataHelper.getFirstAttributeValue(group.activityGuid),
                                        "index": DataHelper.getFirstAttributeValue(group.sequence),
                                        "title": DataHelper.getFirstAttributeValue(group.activityName),
                                        "subtitle": this._getItemSubtitle(group.action, group.endDateTime),
                                        "status": this._getItemStatus(group.status),
                                        "selected": this._getSelected(group.status),
                                        "actions": actions
                                    };
                                    items.push(item);
                                }
                                config.items = items;
                                return config;
                            }
                        }
                },
                 _onWorkFlowTap: function(e) {
                    var collapse = this.$$('#collapse');
                    var workFlowButton = this.$$('#workflowButton');
                    if(collapse) {
                        if(collapse.opened){
                            workFlowButton.icon = "chevron-right";
                            collapse.toggle();
                        }
                        else{
                            workFlowButton.icon = "expand-more";
                            collapse.show();
                        }
                    }
                },
                _getWorkFlowDescription: function(config) {
                    var description = "";
                    if(config) {
                        if(config.startDateTime && config.endDateTime) {
                            description = "The workflow started on " + this._formatDate(config.startDateTime) + " and completed by " + this._formatDate(config.endDateTime); 
                        }
                        else if(config.startDateTime) {
                            description = "The workflow started on " + this._formatDate(config.startDateTime) + " and should complete by " + this._getSLADate(config.startDateTime, 21) + " to complete SLA of 21 days."; 
                        }
                    }
                    return description;
                },
                _getSLADate: function(date, days) {
                    var result = new Date(moment(date).add(days, 'day'));
                    result = moment(result).format('DD/MM/YYYY hh:mm A');
                    return result;
                },
                _formatDate: function(date) {
                    var result = new Date(date);
                    result = moment(result).format('DD/MM/YYYY hh:mm A');
                    return result;
                },
                _getItemSubtitle: function(action, endDateTime) {
                    var lastAction = DataHelper.getFirstAttributeValue(action);
                    var endDate = DataHelper.getFirstAttributeValue(endDateTime);
                    if(lastAction && endDate) {
                        return '"' + lastAction + '"' + " on " + this._formatDate(endDate);
                    }
                    return null;
                },
                _onStepActionTap: function(e, detail, sender) {
                    if(detail && detail.data) {
                        var currentStepItem = this.$.workflowStepper.selectedItem;
                        var stepContentElement = currentStepItem.querySelector('rock-workflow-panel-step-details');
                        if(stepContentElement) {
                            var currentStepData = stepContentElement.stepItem;
                            var curretStepDetails = stepContentElement._stepDetails;
                            var stepComments = stepContentElement.$$('#stepComments').value;
                        }
                        var isCommentsRequired;
                        if(curretStepDetails && curretStepDetails.actions && curretStepDetails.actions.groups 
                            && curretStepDetails.actions.groups.length && curretStepDetails.actions.groups.length >0 ) {
                            for(var i=0; i<curretStepDetails.actions.groups.length; i++) {
                                var action = curretStepDetails.actions.groups[i];
                                var actionName = DataHelper.getFirstAttributeValue(action.actionName);
                                if(actionName == detail.data) {
                                    var commentsMode = DataHelper.getFirstAttributeValue(action.commentsMode);
                                    if(commentsMode == "required") {
                                        isCommentsRequired = true;
                                    }
                                    break;
                                }
                            }
                        }
                        if(isCommentsRequired && stepComments == "") {
                            stepContentElement.$$('#stepComments').invalid = true;
                            stepContentElement.$$('#stepComments').errorMessage = "Comments Required.";
                            return;
                        }
                        else {
                            stepContentElement.$$('#stepComments').invalid = false;
                        }
                        var workflowTransitionRequestDataJson = {
                            "params": {
                                "workflow": {
                                    "workflowId": this._workflowId,
                                    "activity": {
                                        "activityId": currentStepData.id,
                                        "action": detail.data,
                                        "comment": stepComments
                                    }
                                }
                            },
                            "entity": {
                                "id": this.context.entityId,
                                "name": "entityName",
                                "entityInfo": {
                                    "entityType": "nart",
                                    "entityDomain": "thing"
                                }
                            }
                        };
                        //To Do: set this to a request object and generate request for activity action save liquid.
                        //on response, need to refresh the workflow-panel
                    }
                },
                _getItemStatus: function(stepStatus) {
                    var status = DataHelper.getFirstAttributeValue(stepStatus);
                    if(status) {
                        if(status == "Completed") {
                            return "completed";
                        }
                        else if(status == "Executing") {
                            return "inprogress";
                        }
                    }
                    else {
                        return "pending";
                    }
                },
                _getSelected: function(stepStatus) {
                    var status = DataHelper.getFirstAttributeValue(stepStatus);
                    if(status && status == "Executing") {
                        return true;
                    }
                    return false;
                },
                _invokeWorkflow: function() {
                    var invokeWorflowRequest = {
                        "params": {
                            "workflow": {
                                "workflowId": this._workflowId
                            }
                        },
                        "entity": {
                            "id": this.context.entityId,
                            "name": "entityName",
                            "entityInfo": {
                                "entityType": "nart",
                                "entityDomain": "thing"
                            }
                        }
                    };
                    //To DO: set this object to a request object and generate request to invoke workflow for the entity.
                    //on response generate request to get workflow-definition and so...
                },
                _userHasImage: function() {
                    //To DO: functionality to get assigned user of item, get user preferences what to show in
                    // step badge and get details of the content to be shown.
                },         
            });
        })();
    </script>
</dom-module>