<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-merge-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">

<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-stepper/pebble-stepper.html">
<link rel="import" href="../pebble-stepper/pebble-step.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<!-- 
`rock-workflow-panel` Represents a component that renders a panel for the `workflow stepper` for the given entity.
@demo demo/index.html
-->

<dom-module id="rock-workflow-panel">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar"></style>
        <style>
            :host {
                display: block;
                height: 100%;
                --rock-workflow-input-container-label: {
                    position: relative;
                }
            }

            #workflow-stepper {
                margin-top: 20px;
            }

            #workflow-description {
                padding: 10px;
            }

            #workflows-content {
                padding-top: 10px;
                height: 100%;
                overflow-y: auto;
            }

            .workflowtext {
                font-family: var(--default-font-family, 'Roboto,Helvetica,Arial,sans-serif');
                font-size: var(--font-size-sm, 12px);
                color: var(--primary-text-color, #212121);
            }

            .workflow-stepper {
                --pebble-connected-badge-width: 30px;
                --pebble-connected-badge-height: 30px;
                --connectorLine-width: 2px;
                --content-connectorLine-width: 2px;
                --pebble-connected-badge-fontSize: 14px;
            }

            pebble-step-details {
                margin-left: 5px;
            }

            pebble-stepper {
                --stepper-horizontal: {
                    font-size: var(--default-font-size, 14px) !important;
                }
            }

            .step-details {
                color: var(--palette-steel-grey, #75808b);
                font-size: var(--font-size-sm, 12px)!important;
                padding-right: 10px;
                width: 216px;
            }

            .view-changes {
                text-decoration: none;
                float: right;
            }

            .user {
                text-decoration: none;
            }

            #step-comments {
                margin-top: 20px;
            }

            .user-image {
                width: 15px;
                height: 15px;
                background: #ddd;
                margin-right: 10px;
                margin-top: 1px;
            }

            .user-details {
                width: calc(100% - 30px);
                display: inline-block;
                vertical-align: top;
            }

            pebble-textarea {
                --paper-input-container-label: {
                    font-size: var(--default-font-size, 14px)!important;
                }
                --paper-input-container-input: {
                    font-size: var(--default-font-size, 14px)!important;
                }
            }

            #step-actions {
                padding: 12px 0px 8px 0px;
            }

            #step-actions pebble-button {
                margin-right: 10px;
                margin-bottom: 10px;
            }

            pebble-accordion {
                height:auto;
                margin-bottom: 10px;
                --accordion-card-actions: {
                    overflow-y: auto;
                    overflow-x: hidden;
                }
            }

            .step-description {
                padding: 10 0px;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-rest id="entityStartWorkflow" url="/data/pass-through/entitygovernservice/startworkflow" method="POST" request-data={{_invokeWorkflowRequest}}
            last-response={{_invokeWorkflowResponse}} on-liquid-response="_onWfStartSuccess" on-liquid-error="_onWfStartFailure"></liquid-rest>
        <liquid-entity-model-get id="getWorkflowMappingDefinition" operation="getbyids" request-id="req1" on-response="_onWfMappingsReceived"
            on-error="_onMappingsGetFailed"></liquid-entity-model-get>
        <liquid-entity-model-get id="entityGetWorkflowDefinition" operation="getbyids" request-id="req1" on-response="_onDefinitionReceived"
            on-error="_onDefinitionGetFailed"></liquid-entity-model-get>
        <liquid-entity-govern-data-get id="entityGetRunningInstance" operation="getbyids" request-id="req2" on-response="_onRunningInstanceReceived"
            on-error="_onRunningInstanceGetFailed" no-cache></liquid-entity-govern-data-get>
        <liquid-rest id="entityWfEventsGet" url="/data/pass-through/eventservice/get" method="POST" on-liquid-response="_onEventsGetResponse"
            on-liquid-error="_onEventsGetFailure"></liquid-rest>
        <liquid-rest id="entityWfTransition" url="/data/pass-through/entitygovernservice/transitionWorkflow" method="POST" on-liquid-response="_onTransitionSuccess"
            on-liquid-error="_onTransitionFailure"></liquid-rest>
        <pebble-button id="invokeButton" disabled="[[readonly]]" hidden raised class="iconButton btn btn-outline-primary m-r-5" button-text="Start Workflow"
            on-tap="_onInvokeWorkflow"></pebble-button>
        <bedrock-pubsub event-name="workflow-refresh" handler="_refresh"></bedrock-pubsub>
        <div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <div id="workflowPanelMessage" class="default-message"></div>
            </div>
            <div class="base-grid-structure-child-2">
                <div id="workflows-content">
                    <template is="dom-if" if="[[_showWorkflow]]">
                        <template id="workflowsTemplate" is="dom-repeat" items="[[_workflowsData]]" as="_workflowstepperData">
                            <pebble-accordion header-text="[[_workflowstepperData.workflowTitle]]" default-icon="pebble-icon:action-scope-take-selection"
                                open-icon="pebble-icon:action-expand">
                                <div slot="accordion-content">
                                    <div id="workflow-description">
                                        <span class="workflowtext">[[_getWorkFlowDescription(_workflowstepperData)]]</span>
                                    </div>
                                    <div id="workflow-stepper_[[_workflowstepperData.workflowId]]" class="workflow-content">
                                        <pebble-stepper id="workflowStepper_[[_workflowstepperData.workflowId]]" stepper-config="[[_workflowstepperData]]">
                                            <template is="dom-repeat" items="[[_workflowstepperData.items]]" as="item">
                                                <pebble-step class="workflow-stepper" data="{{item}}">
                                                    <div slot="step-badge-content" class="step-badge-content">
                                                        <template is="dom-if" if="[[_userHasImage()]]">
                                                            <img class="user-image" atl="No photo" src="/src/images/no-photo.jpg" />
                                                        </template>
                                                        <template is="dom-if" if="[[!_userHasImage()]]">
                                                            <span class="user-details">[[item.index]]</span>
                                                        </template>
                                                    </div>
                                                    <div slot="step-details" class="step-details">
                                                        <div id="step-description">
                                                            <span>[[item.stepDetails.description]]</span>
                                                        </div>
                                                        <template is="dom-if" if="[[_stepHasDetails(item.stepDetails, item.status)]]">
                                                            <div id="action-details">
                                                                <img class="user-image" alt="No photo" src="/src/images/no-photo.jpg" />
                                                                <span class="user-details">
                                                                    <a class="user" href="#">[[item.stepDetails.assignedUser]]</a>[[item.stepDetails.details]]</span>
                                                                <a style="display: none;" class="view-changes" href="#">View all changes &raquo;</a>
                                                            </div>
                                                        </template>
                                                        <template is="dom-if" if="[[_isCommentsEnabled(item)]]">
                                                            <div id="step-comments">
                                                                <pebble-textarea id="stepComments-[[item.id]]" required="[[_isRequired(item.stepDetails)]]" disabled="[[_isDisabled(item)]]"
                                                                    autofocus label="Add a comment" invalid="" error-message="Comments Required."
                                                                    value=""></pebble-textarea>
                                                            </div>
                                                            <div id="step-actions">
                                                                <template is="dom-repeat" items="[[item.stepDetails.actions]]" as="button">
                                                                    <pebble-button disabled="[[readonly]]" class$="[[_getActionButtonClass(button)]]" raised icon="[[button.actionIcon]]" button-text="[[button.action]]"
                                                                        on-tap="_onStepActionTap" data="[[_getDataforButton(button, item.id, _workflowstepperData.workflowId)]]"
                                                                        disabled="[[_isDisabled(item)]]"></pebble-button>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </pebble-step>
                                            </template>
                                        </pebble-stepper>
                                    </div>
                                </div>
                            </pebble-accordion>
                        </template>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-workflow-panel",
                properties: {
                    _workflowsData: {
                        type: Array,
                        value: function () { return []; }
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                    */
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    _invokeWorkflowRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _runningInstances: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _mappedWorkflowNames: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _showWorkflow: {
                        type: Boolean,
                        value: true
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                refresh: function () {
                    this._contextChanged(this.contextData);
                },
                _refresh: function (event) {
                    if (event) {
                        this.contextData = event.detail.contextData;
                        this.refresh();
                    }
                },
                ready: function () {
                    this.refresh();
                },

                get workflowMappingDefinitionLiq() {
                    this._workflowMappingDefinitionLiq = this._workflowMappingDefinitionLiq || this.shadowRoot.querySelector('#getWorkflowMappingDefinition');
                    return this._workflowMappingDefinitionLiq;
                },

                get entityWfEventsGetLiq() {
                    this._entityWfEventsGetLiq = this._entityWfEventsGetLiq || this.shadowRoot.querySelector("#entityWfEventsGet");
                    return this._entityWfEventsGetLiq;
                },

                get entityWfTransitionLiq() {
                    this._entityWfTransitionLiq = this._entityWfTransitionLiq || this.shadowRoot.querySelector("#entityWfTransition");
                    return this._entityWfTransitionLiq;
                },

                get entityGetRunningInstanceLiq() {
                    this._entityGetRunningInstanceLiq = this._entityGetRunningInstanceLiq || this.shadowRoot.querySelector('#entityGetRunningInstance');
                    return this._entityGetRunningInstanceLiq;
                },

                get entityGetWorkflowDefinitionLiq() {
                    this._entityGetWorkflowDefinitionLiq = this._entityGetWorkflowDefinitionLiq || this.shadowRoot.querySelector("#entityGetWorkflowDefinition");
                    return this._entityGetWorkflowDefinitionLiq;
                },

                _contextChanged: async function (contextData) {
                    if (!_.isEmpty(this.contextData)) {
                        var dataContexts = ContextHelper.getDataContexts(this.contextData);
                        var firstItemContext = ContextHelper.getFirstItemContext(this.contextData);
                        var entityType = firstItemContext.type;
                        if (!_.isEmpty(dataContexts)) {
                            for (var i = 0; i < dataContexts.length; i++) {
                                var context = dataContexts[i];
                                var additionalContexts = [];
                                var contextModel = await ContextModelManager.getContextModelByEntityTypeAndDataContext(entityType, context);
                                if (contextModel) {
                                    additionalContexts = contextModel.properties ? contextModel.properties.additionalcontexts : undefined;
                                }
                                if (!_.isEmpty(additionalContexts)) {
                                    additionalContexts.forEach(function (ctxKey) {
                                        delete context[ctxKey];
                                    });
                                }
                            }

                            dataContexts = dataContexts.filter(ctx => !_.isEmpty(ctx));
                            this.contextData[ContextHelper.CONTEXT_TYPE_DATA] = dataContexts;
                        }
                        this.workflowMappingDefinitionLiq.requestData = DataRequestHelper.createWorkflowMappingGetRequest(this.contextData);
                        this.workflowMappingDefinitionLiq.generateRequest();
                    }
                },
                _onWfMappingsReceived: function (e) {
                    var response = e.detail.response;
                    if (response) {
                        var mappingModels = response.content && response.content.entityModels ? response.content.entityModels : undefined;
                        if (mappingModels && mappingModels.length > 0) {
                            var wfDefinitionMappingModel = mappingModels.find(obj => obj.type == "workflowDefinitionMapping");
                            var workflowContexts = ContextHelper.createWorkflowContexts(wfDefinitionMappingModel, this.contextData);
                            var itemContext = this.getFirstItemContext();
                            itemContext.workflowContexts = workflowContexts;
                            if (!_.isEmpty(workflowContexts)) {
                                this.entityWfEventsGetLiq.requestData = DataRequestHelper.createWorkflowEventsGetRequest(this.contextData);
                                this.entityWfEventsGetLiq.generateRequest();
                            }
                        }
                    }
                },
                _onMappingsGetFailed: function (e) {
                    this.logWarning("WorkFlowMappingError", "response", JSON.stringify(e.detail));
                    this.showErrorToast("Failed to get workflow mappings. Please contact administrator.");
                },
                _onEventsGetResponse: function (e) {
                    var workflowEventsResponse = e.detail.response;
                    var activitySequence = 0;
                    var workflowPastEvents = [];
                    if (workflowEventsResponse && workflowEventsResponse.response && workflowEventsResponse.response.events && workflowEventsResponse.response.events.length > 0) {
                        var wfEvents = workflowEventsResponse.response.events;
                        for (var i = 0; i < wfEvents.length; i++) {
                            var wfEvent = wfEvents[i];
                            if (wfEvent && wfEvent.data && wfEvent.data.contexts && wfEvent.data.contexts.length > 0) {
                                var context = wfEvent.data.contexts[0].context;
                                var attributes = wfEvent.data.contexts[0].attributes;
                                var workflow = context.workflow;
                                if (!workflowPastEvents[workflow]) {
                                    workflowPastEvents[workflow] = {
                                        "attributes": {
                                            "activities": {
                                                "group": []
                                            }
                                        }
                                    };
                                }
                                var activity = attributes && attributes.activities && attributes.activities.group && attributes.activities.group.length && attributes.activities.group[0] ? attributes.activities.group[0] : {};
                                if (!_.isEmpty(activity)) {
                                    var activityStatus = AttributeHelper.getFirstAttributeValue(activity.status);
                                    if (activityStatus == "Closed") {
                                        var activityEndDateTime = AttributeHelper.getFirstAttributeValue(activity.endDateTime);
                                        var parsedDateTime = Date.parse(activityEndDateTime);
                                        activity["parsedEndDateTime"] = parsedDateTime;
                                        workflowPastEvents[workflow].attributes.activities.group.push(activity);
                                    }
                                }
                            }
                        }
                    }
                    for (var workflow in workflowPastEvents) {
                        if (workflowPastEvents[workflow].attributes && workflowPastEvents[workflow].attributes.activities && workflowPastEvents[workflow].attributes.activities.group && workflowPastEvents[workflow].attributes.activities.group.length > 0) {
                            workflowPastEvents[workflow].attributes.activities.group.sort(function (a, b) {
                                return a.parsedEndDateTime - b.parsedEndDateTime;
                            });
                            for (var i = 0; i < workflowPastEvents[workflow].attributes.activities.group.length; i++) {
                                workflowPastEvents[workflow].attributes.activities.group[i]["sequence"] = { "values": [{ "value": i + 1 }] };
                            }
                        }
                    }
                    this.set("_workflowPastEvents", workflowPastEvents);
                    this.entityGetRunningInstanceLiq.requestData = DataRequestHelper.createWorkflowRuntimeInstanceGetRequest(this.contextData);
                    this.entityGetRunningInstanceLiq.generateRequest();
                },
                _onRunningInstanceReceived: function (e) {
                    var showInvokeButton = true;

                    if (e.detail.response) {
                        this.fireBedrockEvent("on-workflow-available", e.detail, { ignoreId: true });
                        var runtimeInstanceEntities = e.detail.response && e.detail.response.content && e.detail.response.content.entities
                            ? e.detail.response.content.entities : undefined;

                        if (runtimeInstanceEntities && runtimeInstanceEntities.length > 0) {
                            //console.log('runtime instance entities ', JSON.stringify(runtimeInstanceEntities, null, 2));

                            var runtimeInstanceEntity = runtimeInstanceEntities[0];

                            if (runtimeInstanceEntity && runtimeInstanceEntity.data) {
                                var foundWorkflowNames = [];
                                var runningInstances = [];

                                //Note: Here, workflow runtime data would be always in the context of workflow so no need to check for data.attributes
                                var contexts = runtimeInstanceEntity.data && runtimeInstanceEntity.data.contexts ? runtimeInstanceEntity.data.contexts : [];

                                for (var i = 0; i < contexts.length; i++) {
                                    var currContextItem = contexts[i];
                                    var currContext = currContextItem.context;
                                    var currWorkflowName = currContext.workflow;
                                    var contextAttrs = currContextItem.attributes;

                                    if (currWorkflowName) {
                                        var runtimeInstance = {
                                            "name": currWorkflowName,
                                            "attributes": contexts[i].attributes
                                        };

                                        runningInstances[currWorkflowName] = runtimeInstance;
                                        foundWorkflowNames.push(currWorkflowName);
                                    }
                                }

                                if (foundWorkflowNames.length > 0) {
                                    showInvokeButton = false;

                                    this.set("_runningInstances", runningInstances);

                                    var itemContext = this.getFirstItemContext();
                                    itemContext.workflowNames = foundWorkflowNames;

                                    this.entityGetWorkflowDefinitionLiq.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                                    this.entityGetWorkflowDefinitionLiq.generateRequest();
                                }
                            }
                        }
                    }

                    this._showMessagePanel(showInvokeButton);
                },
                _onRunningInstanceGetFailed: function (e) {
                    this.logWarning("WorkFlowStatusError", "response", JSON.stringify(e.detail));
                    this.showErrorToast("Failed to get workflow status. Please contact administrator.");
                },
                _onDefinitionReceived: function (e) {
                    var workflowDefinitionResponse = e.detail.response;
                    if (workflowDefinitionResponse && workflowDefinitionResponse.content && workflowDefinitionResponse.content.entityModels && workflowDefinitionResponse.content.entityModels.length > 0) {
                        var workflowData = [];

                        for (var i = 0; i < workflowDefinitionResponse.content.entityModels.length; i++) {
                            var entityModel = workflowDefinitionResponse.content.entityModels[i];
                            var workflowName = entityModel.name;

                            if (entityModel.data && entityModel.data.attributes) {

                                var wfPastAttributes = this._workflowPastEvents[workflowName] && this._workflowPastEvents[workflowName].attributes ? this._workflowPastEvents[workflowName].attributes : {};

                                var wfAttributes = entityModel.data.attributes;

                                var riAttributes = this._runningInstances[workflowName].attributes;

                                var _stepperData = this._transformEntityResponseToStepperJson(wfPastAttributes, wfAttributes, riAttributes, workflowName);

                                workflowData.push(_stepperData);
                            }
                        }
                        this.set("_workflowsData", workflowData);
                        this.shadowRoot.querySelector("#workflowsTemplate").render();
                        //this._loading = false;
                        setTimeout(() => {
                            var stepper = this.shadowRoot.querySelector("#workflow-stepper_" + workflowData[0].workflowId);
                            if (stepper) {
                                var step = stepper.querySelector('pebble-step[opened]');
                                if (step) {
                                    step.scrollIntoView();
                                }
                            }
                        }, 1000);//ToDo: need to figure out better way. As of now delay to let the stepper to load with workflow data properly.
                    }
                },
                _onDefinitionGetFailed: function (e) {
                    Polymer.Base._error('workflow definition get failed with error ', e.detail);
                },
                _transformEntityResponseToStepperJson: function (wfPastAttributes, wfAttributes, riAttributes, workflowName) {
                    if (wfPastAttributes && wfAttributes && riAttributes) {
                        var riActivities = riAttributes.activities;
                        var wfActivities = wfAttributes.activities;
                        //To solve creation of duplicate steps because of multiple refresh calls.
                        if (_.isEmpty(wfPastAttributes)) {
                            wfPastAttributes = {
                                "activities": {
                                    "group": []
                                }
                            };
                        }
                        var attributes = DataHelper.cloneObject(wfPastAttributes);
                        var wfPastActivities = wfPastAttributes.activities;

                        if (riActivities) {
                            var keys = Object.keys(riAttributes);

                            for (var i = 0; i < keys.length; i++) {
                                var key = keys[i];
                                if (key != "activities") {
                                    attributes[key] = riAttributes[key];
                                }
                            }
                            var recentActivity = undefined;
                            if (wfPastActivities && wfPastActivities.group && wfPastActivities.group.length > 0) {
                                recentActivity = wfPastActivities.group[wfPastActivities.group.length - 1];
                            }
                            var activitySequence = 0;
                            if (recentActivity) {
                                activitySequence = AttributeHelper.getFirstAttributeValue(recentActivity.sequence);
                            }

                            attributes["workflowName"] = wfAttributes["workflowName"];
                            var riActivity = riActivities.group[0];

                            var riActivityName = AttributeHelper.getFirstAttributeValue(riActivity.activityName);
                            var riActivityStatus = AttributeHelper.getFirstAttributeValue(riActivity.status);
                        } else {
                            this._showMessagePanel(true);
                        }

                        var currentActivityIndex = -1;
                        if (wfActivities) {
                            for (var i = 0; i < wfActivities.group.length; i++) {
                                var wfActivity = wfActivities.group[i];

                                var wfActivityName = AttributeHelper.getFirstAttributeValue(wfActivity.activityName);
                                var wfActivityExternalName = AttributeHelper.getFirstAttributeValue(wfActivity.externalName);
                                if (riActivityName == wfActivityName) {
                                    currentActivityIndex = i;
                                    if (riActivityStatus && (riActivityStatus == "Executing" || riActivityStatus == "AssignmentChange")) {
                                        riActivity["activityDescription"] = wfActivity["activityDescription"];
                                        riActivity["allowedRoles"] = wfActivity["allowedRoles"];
                                        riActivity["actions"] = wfActivity["actions"];
                                        riActivity["sequence"] = { "values": [{ "value": ++activitySequence }] };
                                        riActivity["externalName"] = wfActivity.externalName;

                                        attributes.activities.group.push(riActivity);
                                    }
                                } else if (currentActivityIndex > -1) {
                                    wfActivity["sequence"] = { "values": [{ "value": ++activitySequence }] };
                                    wfActivity.actions = {};
                                    attributes.activities.group.push(wfActivity);
                                }
                            }
                        } else {
                            this._showMessagePanel(true);
                        }

                        if (attributes) {
                            var workflowActivites = attributes.activities;
                            if (workflowActivites) {
                                var workflowActivitiesGroup = workflowActivites.group;
                                if (workflowActivitiesGroup && workflowActivitiesGroup instanceof Array) {
                                    for (var j = 0; j < workflowActivitiesGroup.length; j++) {
                                        var activityName = AttributeHelper.getFirstAttributeValue(workflowActivitiesGroup[j].activityName);
                                        var activityStatus = AttributeHelper.getFirstAttributeValue(workflowActivitiesGroup[j].status);
                                        var workflowActivity = wfActivities.group.find(obj => AttributeHelper.getFirstAttributeValue(obj.activityName) == activityName);
                                        if (workflowActivity && !DataHelper.isEmptyObject(activityStatus)) {
                                            attributes.activities.group[j]["externalName"] = workflowActivity.externalName;
                                        }
                                    }
                                }
                            }

                            var config = {
                                "workflowId": workflowName + "_workflowDefinition",
                                "workflowName": workflowName,
                                "workflowTitle": AttributeHelper.getFirstAttributeValue(attributes.workflowName),
                                "startDateTime": AttributeHelper.getFirstAttributeValue(attributes.startDateTime),
                                "endDateTime": AttributeHelper.getFirstAttributeValue(attributes.endDateTime),
                                "status": AttributeHelper.getFirstAttributeValue(attributes.status),
                                "items": []
                            };

                            var activities = attributes.activities;
                            var items = [];

                            for (var i = 0; i < activities.group.length; i++) {
                                var k = activities.group.length - 1;
                                var group = activities.group[k - i];

                                var actions = [];
                                if (group && group.actions && group.actions.group && group.actions.group.length) {
                                    for (var j = 0; j < group.actions.group.length; j++) {
                                        var actionsGroup = group.actions.group[j];

                                        var action = {
                                            "action": AttributeHelper.getFirstAttributeValue(actionsGroup.actionText),
                                            "event": AttributeHelper.getFirstAttributeValue(actionsGroup.actionName),
                                            "commentsMode": AttributeHelper.getFirstAttributeValue(actionsGroup.commentsMode),
                                            "happyPath": AttributeHelper.getFirstAttributeValue(actionsGroup.happyPath)
                                        };
                                        actions.push(action);
                                    }
                                }

                                var item = {
                                    "id": AttributeHelper.getFirstAttributeValue(group.activityGuid),
                                    "index": AttributeHelper.getFirstAttributeValue(group.sequence),
                                    "activityName": AttributeHelper.getFirstAttributeValue(group.activityName),
                                    "title": AttributeHelper.getFirstAttributeValue(group.externalName),
                                    "subtitle": this._getItemSubtitle(group.performedAction, group.endDateTime),
                                    "status": this._getItemStatus(group.status),
                                    "selected": this._getSelected(group.status),
                                    "workflowName": workflowName,
                                    "allowedRoles": group.allowedRoles
                                };
                                item["stepDetails"] = this._getItemFullDetails(item, group, actions);
                                items.push(item);
                            }

                            config.items = items;

                            return config;
                        } else {
                            this._showMessagePanel(true);
                        }
                    }
                },
                _getWorkFlowDescription: function (config) {
                    var description = "";
                    if (config) {
                        if (config.status == "Completed") {
                            description = "The workflow completed on " + this._formatDate(config.endDateTime) + ".";
                        }
                        else if (config.status == "Executing") {
                            description = "The workflow started on " + this._formatDate(config.startDateTime) + ".";
                        }
                    }
                    return description;
                },
                _getItemSubtitle: function (action, endDateTime) {
                    var lastAction = AttributeHelper.getFirstAttributeValue(action);
                    var endDate = AttributeHelper.getFirstAttributeValue(endDateTime);
                    if (lastAction && endDate) {
                        return '"' + lastAction + '"' + " on " + this._formatDate(endDate);
                    }
                    return null;
                },
                _onStepActionTap: function (e) {

                    if (e.currentTarget.disabled == true) {
                        return;
                    }
                    var data = e.target.data;
                    var commentsEl = this.shadowRoot.querySelector("#stepComments-" + data.id);
                    var currentStepItem = this.shadowRoot.querySelector("#workflowStepper_" + data.workflowId).selectedItem;
                    var stepComments = "";
                    var curretStepDetails;
                    var currentWorkflowName;
                    if (currentStepItem) {
                        var currentStepData = currentStepItem.data;
                        currentWorkflowName = currentStepData.workflowName;
                        curretStepDetails = currentStepData.stepDetails;
                    }
                    var isCommentsRequired;
                    if (curretStepDetails && curretStepDetails.actions && curretStepDetails.actions.length && curretStepDetails.actions.length > 0) {
                        for (var i = 0; i < curretStepDetails.actions.length; i++) {
                            var action = curretStepDetails.actions[i];
                            var actionName = action.event;
                            if (actionName == data.event) {
                                var commentsMode = action.commentsMode;
                                if (commentsMode == "Mandatory") {
                                    isCommentsRequired = true;
                                }

                                break;
                            }
                        }
                    }

                    if (commentsEl) {
                        stepComments = commentsEl.value;
                        if (isCommentsRequired && stepComments == "") {
                            commentsEl.invalid = true;
                            return;
                        }

                        commentsEl.invalid = false;
                    }

                    var firstItemContext = this.getFirstItemContext();
                    firstItemContext.transitionTo = {
                        "workflowName": currentWorkflowName,
                        "activityName": currentStepData.activityName,
                        "action": data.event,
                        "comments": stepComments
                    };

                    var workflowTransitionRequestDataJson = DataRequestHelper.createWorkflowTransitionRequest(this.contextData);

                    var data = {};
                    var workflowContexts = firstItemContext.workflowContexts;
                    if(!_.isEmpty(workflowContexts)) {
                        var mappedWorkflowContext = workflowContexts.find(obj => obj.workflow === currentWorkflowName);
                        data = ContextHelper.createContextForWorkflowActions(mappedWorkflowContext);
                    }

                    if(!_.isEmpty(data)) {
                        workflowTransitionRequestDataJson.entity["data"] = data;
                    }

                    //Add hotline flag if hotline is enabled
                    if (DataHelper.isHotlineModeEnabled()) {
                        workflowTransitionRequestDataJson.hotline = true;
                    }

                    this.entityWfTransitionLiq.requestData = workflowTransitionRequestDataJson;
                    this.entityWfTransitionLiq.generateRequest();
                    //this._loading = true;
                },
                _onTransitionSuccess: function (e) {
                    var request = e.detail.request;
                    var response = e.detail.response.response; //need to check why this is response.response
                    if (response && response.status && response.status.toLowerCase() == "error") {
                        var message = "";
                        if (response.statusDetail && response.statusDetail.message) {
                            message = " with message: " + response.statusDetail.message;
                        }

                        this.showErrorToast("Workflow action failed" + message + ". Please contact your administrator.");
                        return;
                    }
                    if (response && response.statusDetail && response.statusDetail.isCriteriaValid == false) {
                        var actionItem = "Workflow";

                        if (request.requestData && request.requestData.params && request.requestData.params.workflow) {
                            var workflow = request.requestData.params.workflow;
                            if (workflow && workflow.activity && workflow.activity.action) {
                                actionItem = workflow.activity.action;
                            }
                        }

                        this.showErrorToast("'" + actionItem + "' action failed. Please check the business conditions in Summary tab.");
                    } else {
                        setTimeout(() => {
                            this.showSuccessToast("Workflow action completed succesfully.");
                            this.entityGetRunningInstanceLiq.generateRequest();
                        }, 6000)
                    }
                },
                _onTransitionFailure: function (e) {
                    this.logWarning("WorkFlowTransitionError", "response", JSON.stringify(e.detail));
                    this.showErrorToast("Failed to perform the workflow transition. Please contact administrator.");
                },
                _getItemStatus: function (stepStatus) {
                    var status = AttributeHelper.getFirstAttributeValue(stepStatus);
                    if (status) {
                        if (status == "Closed") {
                            return "completed";
                        }
                        else if (status == "Executing" || status == "AssignmentChange") {
                            return "inprogress";
                        }
                        else if (status == "Faulted") {
                            return "failed";
                        }
                    }

                    return "pending";
                },
                _getSelected: function (stepStatus) {
                    var status = AttributeHelper.getFirstAttributeValue(stepStatus);
                    return status && status == "Executing" || status == "AssignmentChange";
                },
                _showMessagePanel: function (show) {
                    var workflowPanelMessage = this.shadowRoot.querySelector("#workflowPanelMessage");
                    if (workflowPanelMessage) {
                        if (show) {
                            workflowPanelMessage.textContent = "No workflows for the entity in current context.";
                            workflowPanelMessage.removeAttribute("hidden");
                        } else {
                            workflowPanelMessage.textContent = "";
                            workflowPanelMessage.setAttribute("hidden", "");
                        }
                        this._showWorkflow = !show;
                    }
                },
                _onInvokeWorkflow: function (e) {

                    if (e.currentTarget.disabled == true) {
                        return;
                    }
                    var firstWorkflowName = this._mappedWorkflowNames[0]; //TODO:: Ehance invoke button to pass workflow name in event..

                    var firstItemContext = this.getFirstItemContext();

                    firstItemContext.invokeWorkflowData = {
                        "workflowName": firstWorkflowName
                    };

                    var invokeWorkflowRequest = DataRequestHelper.createInvokeWorkflowRequest(this.contextData);

                    this.set("_invokeWorkflowRequest", invokeWorkflowRequest);
                    this.shadowRoot.querySelector("#entityStartWorkflow").generateRequest();
                    //this._loading = true;
                },
                _onWfStartSuccess: function (e) {
                    var response = e.detail.response;
                    if (response) {
                        setTimeout(() => {
                            this.entityGetRunningInstanceLiq.generateRequest();
                        }, 3000);
                    }
                },
                _onWfStartFailure: function (e) {
                    this.logWarning("WorkFLowStartFail", "response", JSON.stringify(e.detail));
                    this.showErrorToast("Failed to start the workflow. Please contact administrator.");
                },
                _userHasImage: function () {
                    //ToDO: functionality to get assigned user of item, get user preferences what to show in
                    // step badge and get details of the content to be shown.
                },
                _getItemFullDetails: function (stepItem, currentActivity, actions) {
                    if (stepItem && currentActivity) {

                        var itemDetailsJson = {};

                        var itemDescription = AttributeHelper.getFirstAttributeValue(currentActivity.activityDescription);

                        var itemDetail = this._getItemDetail(stepItem.workflowName, currentActivity, stepItem.status);
                        var assignedUser = AttributeHelper.getFirstAttributeValue(currentActivity.assignedUser);
                        itemDetailsJson["description"] = itemDescription;
                        itemDetailsJson["assignedUser"] = assignedUser;
                        itemDetailsJson["details"] = itemDetail;
                        itemDetailsJson["actions"] = actions;

                        return itemDetailsJson;
                    }
                },
                _getItemDetail: function (workflowName, group, stepStatus) {
                    var activityName = AttributeHelper.getFirstAttributeValue(group.activityName);
                    var startDate = AttributeHelper.getFirstAttributeValue(group.startDateTime);
                    var endDate = AttributeHelper.getFirstAttributeValue(group.endDateTime);
                    var lastAction = AttributeHelper.getFirstAttributeValue(group.performedAction);
                    var comments = AttributeHelper.getFirstAttributeValue(group.comments);
                    var assignedUser = AttributeHelper.getFirstAttributeValue(group.assignedUser);
                    var itemDetail = "";
                    if (stepStatus == "inprogress") {
                        if (!assignedUser || assignedUser == "_UNASSIGNED") {
                            itemDetail = "";
                        } else {
                            itemDetail = "  was assigned task on " + this._formatDate(startDate) + ".";
                        }
                    }
                    if (stepStatus == "failed") {
                        itemDetail = "  was failed due to technical reason.";
                    }
                    if (stepStatus == "completed") {
                        var msg = "";
                        if (comments && comments != "") {
                            msg = "the comment " + comments;
                        } else {
                            msg = "no comments.";
                        }
                        itemDetail = ' "' + lastAction + '"' + " on " + this._formatDate(endDate) + " with " + msg + ".";
                    }
                    return itemDetail;
                },
                _getSLADate: function (date, days) {
                    var result = new Date(moment(date).add(days, 'day'));
                    result = moment(result).format('DD/MM/YYYY hh:mm A')
                    return result;
                },
                _formatDate: function (date) {
                    if (date) {
                        var result = FormatHelper.convertFromISODateTimeToClientFormat(date, "datetime");
                        return result;
                    }
                },
                _isCommentsEnabled: function (item) {
                    return (item &&
                        item.stepDetails &&
                        item.stepDetails.actions &&
                        item.stepDetails.actions.length &&
                        item.status == "inprogress");
                },
                _stepHasDetails: function (stepDetails, status) {
                    return (stepDetails && (stepDetails.assignedUser || stepDetails.details) && status != "pending");
                },
                _isRequired: function (stepDetails) {
                    var required = false;
                    if (stepDetails && stepDetails.actions && stepDetails.actions.length) {
                        required = !!stepDetails.actions.find(action => action.commentsMode === "Mandatory");
                    }

                    return required;
                },
                _getActionButtonClass: function (action) {
                    if (action) {
                        if (action.happyPath) {
                            return "action-button-focus dropdownText btn btn-success m-r-5";
                        }

                        return "action-button btn btn-secondary";
                    }
                },
                _getDataforButton: function (button, id, workflowId) {
                    var data = {
                        "event": button.event,
                        "id": id,
                        "workflowId": workflowId
                    };
                    return data;
                },
                _isDisabled: function (item) {
                    if (item && item.allowedRoles) {
                        if (this._getWritePermission() === false) {
                            return true;
                        }
                        var currentUserRole = DataHelper.getUserRole();
                        if (typeof (currentUserRole) === "undefined") {
                            return true;
                        }
                        var allowedRoles = undefined;
                        if (item.allowedRoles.values) {
                            allowedRoles = AttributeHelper.getAttributeValues(item.allowedRoles.values);
                        }
                        if (allowedRoles && allowedRoles.length) {
                            if (allowedRoles.indexOf(currentUserRole) != -1) {
                                return false;
                            }
                        }
                    }
                    return true;
                },               
                _getWritePermission: function () {
                    var writePermission = true;
                    var itemContext = this.getFirstItemContext();
                    if (DataHelper.isValidObjectPath(itemContext, "permissionContext.writePermission")) {
                        writePermission = itemContext.permissionContext.writePermission;
                    }

                    return writePermission;
                }
            });
        })();
    </script>
</dom-module>