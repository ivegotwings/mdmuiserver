<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-merge-helper.html">
<link rel="import" href="../bedrock-externalref-underscore/bedrock-externalref-underscore.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html">

<!--
`<rock-entity-tofix>` Represents an element that displays the errors, warnings, and information 
of an entity as a list.

### Example

    <template is="dom-bind">
        <iron-ajax url="entities.json" last-response="{{response}}" auto></iron-ajax>
		<rock-entity-tofix entities="{{response}}"></rock-entity-tofix>                
	</template>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--entity-tofix-horizontal-divider` | Mixin applied to horizontal divider | {}
`--entity-tofix-container` | Mixin applied to entity item container | {}
`--entity-icon-outer-circle` | Mixin applied to item icon outer circle | {}
`--entity-icon-width` | The width of item icon | 20px
`--entity-icon-height` | The height of item icon | 20px
`--entity-icon-margin` | The margin of item icon | ``
`--error-icon-outer-bg-color` | The outer bg color of error item icon | rgba(251, 96, 103, 1)
`--entity-error-icon-fill-color` | The fill color of error icon | #ffffff
`--entity-error-icon-stroke-color` | The stroke color of error icon | rgba(251, 96, 103, 1)
`--warning-icon-outer-bg-color` | The outer bg color of warning item icon | orange
`--entity-warning-icon-fill-color` | The fill color of warning icon | #ffffff
`--entity-warning-icon-stroke-color` | The stroke color of warning icon | orange
`--info-icon-outer-bg-color` | The outer bg color of info item icon | rgba(22, 180, 252, 1)
`--entity-info-icon-fill-color` | The fill color of info icon | #ffffff
`--entity-info-icon-stroke-color` | The stroke color of info icon | rgba(22, 180, 252, 1)
`--entity-tofix-content` | Mixin applied to entity item content | {}

@group rock Elements
@element rock-entity-tofix
@demo demo/index.html
-->

<dom-module id="rock-entity-tofix">
    <template>
        <style is="custom-style" include="pebble-styles-shared">
            pebble-horizontal-divider {
                height: 1px;
                width: 100%;
                background: var(--divider-color, #c1cad4);
                opacity: 1;
                min-height: 1px;
                max-height: 1px;
                margin-bottom: 5px;
            }

            .tofix-data-container {
                min-height: 120px;
                max-height: 250px;
                overflow: auto;
                position: relative;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                color: var(--link-text-color, #036Bc3);
                margin-top: 5px;
                font-weight: 500
            }

            .entity-icon-outer {
                display: inline-block;
                margin-right: 8px;
            }

            .entity-icon-outer pebble-icon {
                margin-top: -1px;
            }

            .entity-content {
                cursor: pointer;
                display: inline-block;
                color: var(--secondary-button-text-color, #75808b);
                font-size: var(--font-size-sm, 12px);
            }

            .entity-content.false, .entity-content.unkown {
                color: var(--text-primary-color, #1a2028);
            }
        </style>
        <liquid-entity-model-get exclude-in-progress id="workflowMappingsGet" operation="getbyids" request-id="workflowMappingsGet" on-response="_onWorkflowMappingsGetResponse"
            on-error="_onWorkflowMappingsGetError"></liquid-entity-model-get>

        <liquid-entity-govern-data-get exclude-in-progress id="entityGovernDataGet" operation="getbyids" request-id="entityGovernDataGet" on-response="_onEntityGovernDataGetResponse"
            on-error="_onEntityGovernDataGetResponseError"></liquid-entity-govern-data-get>

        <liquid-entity-model-get exclude-in-progress id="workflowDefintionGet" operation="getbyids" request-id="workflowDefinitionGet" on-response="_onWorkflowDefinitionGetResponse"
            on-error="_onWorkflowDefinitionGetError"></liquid-entity-model-get>

        <liquid-entity-model-get exclude-in-progress id="ruleContextMappingsGet" operation="getbyids" request-id="ruleContextMappingsGet" on-response="_onRuleContextMappingsGetResponse"
            on-error="_onRuleContextMappingsGetError"></liquid-entity-model-get>

        <liquid-entity-model-get exclude-in-progress id="businessConditionsGet" operation="getbyids" request-id="businessConditionsGet" on-response="_onBusinessConditionsGetResponse" 
            on-error="_onBusinessConditionsGetError"></liquid-entity-model-get>

        <liquid-entity-model-get id="unknownBusinessConditionsGet" operation="getbyids" request-id="unknownBusinessConditionsGet" on-response="_onUnkownBusinessConditionsGetResponse"
            on-error="_onUnkownBusinessConditionsGetError"></liquid-entity-model-get>
        <rock-business-function-dialog id="attributeDialog"></rock-business-function-dialog>
        <div class="tofix-data-container">
            <pebble-spinner active="[[!_isToFixDataExists]]"></pebble-spinner>
            <template is="dom-if" if="[[_isToFixDataExists]]">
                <template is="dom-repeat" items="[[_tofixData]]" as="tofixItem">
                    <div class="title">[[tofixItem.label]]</div>
                    <pebble-horizontal-divider></pebble-horizontal-divider>
                    <template is="dom-repeat" items="[[tofixItem.businessConditions]]" as="businessCondition">
                        <div class="data-list" data="[[businessCondition]]" on-tap="_onTap">
                            <div class="entity-icon-outer">
                                <pebble-icon icon="[[_getIconByType(businessCondition.status)]]" class="pebble-sm-icons"></pebble-icon>
                            </div>
                            <div class$="entity-content [[businessCondition.status]]">
                                [[businessCondition.name]]
                            </div>
                        </div>
                    </template>
                </template>
            </template>
            <div id="messagePanel" class="message-panel"></div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-tofix',

            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    'observer': '_contextDataChanged'
                },
                _clonedContextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _entityTypeWorkflowMappings: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _entityBusinessConditionsGovernData: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _entityBusinessConditionNames: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _entityWorkflowGovernData: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _entityGovernWorkflowNames: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _workflowDefinitions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _contextSpecificBusinessConditions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _globalBusinessConditions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _entityTypeBusinessConditions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _originalBusinessConditions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _isToFixDataExists: {
                    type: Boolean,
                    value: false
                },

                _tofixData: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _errorMessage: {
                    type: String,
                    value: "Error in Loading Component: Please contact your Administrator."
                },

                _nothingToFixMessage: {
                    type: String,
                    value: "Nothing to fix!"
                }               
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],

            _contextDataChanged: function () {
                if (typeof (this.contextData) !== "undefined" && !_.isEmpty(this.contextData)) {
                    this._clonedContextData=DataHelper.cloneObject(this.contextData);
                    var itemContext = ContextHelper.getFirstItemContext(this._clonedContextData);
                    itemContext.attributeNames = [];
                    itemContext.relationships = [];
                    itemContext.relationshipAttributes = [];
                    this._clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                    var valueContext = ContextHelper.getFirstValueContext(this._clonedContextData);
                    valueContext = [];
                    this._clonedContextData[ContextHelper.CONTEXT_TYPE_VALUE] = valueContext;
                }
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            attached: function () {
                // Use ES6 and Underscore methods whever applicable
                if (!_.isEmpty(this.contextData)) {
                    this.$$("#messagePanel").textContext = "";

                    var workflowMappingsGet = this.$$('#workflowMappingsGet');

                    if (typeof (workflowMappingsGet) === "undefined" ||
                        workflowMappingsGet == null) {
                        RUFUtilities.Logger.error("Liquid element having id workflowMappingsGet not found.");
                        this._showMessage(this._errorMessage);
                        return;
                    }

                    // Create Request and Get
                    workflowMappingsGet.requestData = DataRequestHelper.createWorkflowMappingGetRequest(this.contextData);
                    workflowMappingsGet.generateRequest();
                }
            },

            _onWorkflowMappingsGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                if (responseContent) {
                    var workflowMappingModels = responseContent.entityModels;

                    // Get Workflows Mapped to the Current EntityType
                    if (workflowMappingModels && workflowMappingModels.length > 0) {
                        var wfDefinitionMappingModel = workflowMappingModels.find(obj => obj.type == "workflowDefinitionMapping");
                        var wfRelationships = DataMergeHelper.mergeWorkflowMappings(wfDefinitionMappingModel, this._clonedContextData);

                        var mappedWorkflowNames = DataHelper.getRelToNames(wfRelationships.hasWorkflowsDefined);
                        this.set("_entityTypeWorkflowMappings", mappedWorkflowNames);
                    }

                    // Make Entity Govern Get
                    this._requestEntityGovernData();
                } else {
                    RUFUtilities.Logger.error("WorkflowMappingsGetResponseContent not found.");
                    this._showMessage(this._errorMessage);
                }
            },

            _onWorkflowMappingsGetError: function (e) {
                RUFUtilities.Logger.error("WorkflowMappingsGetError:- " + e.detail.response.reason.message);
            },


            _requestEntityGovernData: function () {
                var entityGovernDataGet = this.$$('#entityGovernDataGet');

                if (typeof (entityGovernDataGet) === "undefined" || entityGovernDataGet == null) {
                    RUFUtilities.Logger.error("Liquid element having id entityGovernDataGet not found.");
                    this._showMessage(this._errorMessage);
                    return;
                }

                // Prepare Context
                var clonedContextData = DataHelper.cloneObject(this._clonedContextData);

                var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                itemContext.attributeNames = ["_ALL"];

                // Prepare DataContext
                // Note: Can be possible that No Workflow is available for Current EntityType
                var dataContexts = this._prepareWorkflowDataContext(clonedContextData, itemContext);
                if (dataContexts.length > 0) {
                    clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = dataContexts;
                }

                // Create Request and Get
                entityGovernDataGet.requestData = DataRequestHelper.createEntityGetRequest(clonedContextData);
                entityGovernDataGet.generateRequest();
            },

            _onEntityGovernDataGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                if (responseContent) {
                    var entities = responseContent.entities;

                    if (typeof (entities) !== "undefined" && entities.length > 0) {
                        this._setEntityWorkflowGovernData(entities[0]);
                        this._setEntityBusinessConditionsGovernData(entities[0]);

                        this._requestWorkflowDefinition();
                        this._requestOriginalBusinessConditions();

                        // Note: Could be optimized.Why to bring all RuleMappings?
                        this._requestRuleContextMappings();
                    }
                } else {
                    RUFUtilities.Logger.error("EntityGovernDataGetResponseContent not found.");
                    this._showMessage(this._errorMessage);
                }
            },

            _onEntityGovernDataGetError: function (e) {
                RUFUtilities.Logger.error("EntityGovernDataGetError:- " + e.detail.response.reason.message);
                this._showMessage(this._errorMessage);
            },


            _requestWorkflowDefinition: function () {
                if (this._entityGovernWorkflowNames.length > 0) {
                    var workflowDefinitionGet = this.$$("#workflowDefintionGet");

                    if (typeof (workflowDefinitionGet) === "undefined" ||
                        workflowDefinitionGet == null) {
                        RUFUtilities.Logger.error("Element having id workflowDefinitionGet not found.");
                        this._showMessage(this._errorMessage);
                        return;
                    }

                    var clonedContextData = DataHelper.cloneObject(this._clonedContextData);

                    // Prepare ItemContext 
                    var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                    itemContext.workflowNames = this._entityGovernWorkflowNames;
                    clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                    // Create Request and Get
                    workflowDefinitionGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(clonedContextData);
                    workflowDefinitionGet.generateRequest();
                }
            },

            _onWorkflowDefinitionGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                if (responseContent) {
                    var workflowDefintions = responseContent.entityModels;

                    if (typeof (workflowDefintions) !== "undefined" && workflowDefintions.length > 0) {
                        for (var i = 0; i < workflowDefintions.length; i++) {
                            var workflowDefinition = {};
                            workflowDefinition["name"] = workflowDefintions[i].name;
                            workflowDefinition["attributes"] = workflowDefintions[i].data.attributes;
                            this.push("_workflowDefinitions", workflowDefinition);
                        }
                        this._prepareToFixData();
                    } else {
                        this._showMessage(this._errorMessage);
                    }
                } else {
                    RUFUtilities.Logger.error("EntityGovernDataGetResponse Content not found.");
                }
            },

            _onWorkflowDefinitionGetError: function (e) {
                RUFUtilities.Logger.error("Failed to get workflow definition with error: " + e.detail.response.reason.message);
                this._showMessage(this._errorMessage);
            },


            _requestOriginalBusinessConditions: function () {
                if (this._entityBusinessConditionNames.length) {

                    this._requestBusinessConditions(this._entityBusinessConditionNames, "businessConditionsGet");
                } else {
                    this._showMessage(this._nothingToFixMessage);
                }
            },

            _isBusinessConditionAllowedForRole: function(businessCondition) {
                var allowedRoles;
                if(DataHelper.isValidObjectPath(businessCondition, "data.attributes"))
                {
                    allowedRoles = businessCondition.data.attributes.impactedRoles;
                }                
                var userContext = this.contextData.UserContexts[0];

                if(allowedRoles && userContext.role) {
                   for(var i = 0; i < allowedRoles.values.length; i++) {
                      //Check for _ALL or user role  
                      if(allowedRoles.values[i].value == "_ALL" || 
                         allowedRoles.values[i].value.toLowerCase() == userContext.role.toLowerCase()) {
                          return true;
                      }
                   }
                   
                   //Not have "_ALL" / user role
                   return false;
                }

                //No allowedRoles OR No user role, then BC is applicable to any role   
                return true;
            },

            _onBusinessConditionsGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                if (responseContent) {
                    var businessConditions = responseContent.entityModels;

                    if (typeof (businessConditions) !== "undefined" && businessConditions.length > 0) {
                        for (var i = 0; i < businessConditions.length; i++) {
                            var businessCondition = {};
                            businessCondition["id"] = businessConditions[i].id;
                            businessCondition["name"] = businessConditions[i].name;

                            // LongNames are required for Displaying BusinessConditions
                            var formattedBusinessCondition = this._entityBusinessConditionsGovernData.find(businessCondition => businessCondition.id === businessConditions[i].id);

                            if (formattedBusinessCondition && this._isBusinessConditionAllowedForRole(businessConditions[i])) {
                               formattedBusinessCondition["name"] = businessConditions[i].name;
                               formattedBusinessCondition["isAllowedToShow"] = true;
                            }

                            this.push("_originalBusinessConditions", businessCondition);
                        }
                        this._prepareToFixData();
                    } else {
                        this._showMessage(this._errorMessage);
                    }
                } else {
                    RUFUtilities.Logger.error("EntityModelGetByIdsResponse Content not found.");
                    this._showMessage(this._errorMessage);
                }
            },

            _onBusinessConditionsGetError: function (e) {
                RUFUtilities.Logger.error("EntityModelGetByIdsError:- " + e.detail.response.reason.message);
                this._showMessage(this._errorMessage);
            },


            _requestRuleContextMappings: function () {
                if (this._entityGovernWorkflowNames.length > 0 || this._entityBusinessConditionNames.length > 0) {
                    var ruleContextMappingsGet = this.$$('#ruleContextMappingsGet');

                    if (typeof (ruleContextMappingsGet) === "undefined" ||
                        ruleContextMappingsGet == null) {
                        RUFUtilities.Logger.error("Element having id ruleContextMappingsGet not found.");
                        this._showMessage(this._errorMessage);
                        return;
                    }


                    var clonedContextData = DataHelper.cloneObject(this._clonedContextData);

                    // Prepare ItemContext
                    var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                    var requestedType = "ruleContextMappings";
                    var requestedId = itemContext.type + "_" + requestedType;
                    itemContext.id = requestedId;
                    itemContext.type = requestedType;
                    itemContext.relationships = ["hasBusinessConditions"];
                    itemContext.relationshipAttributes = ['isDeleted', 'enabled', 'stepName'];
                    clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                    // Prepare DataContext
                    // This should be optional because entity can be in workflow or cannot be in workflow
                    var dataContexts = this._prepareWorkflowDataContext(clonedContextData, itemContext);
                    if (dataContexts.length > 0) {
                        clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = dataContexts;
                    }


                    // Create Request and Get
                    ruleContextMappingsGet.requestData = DataRequestHelper.createEntityGetRequest(clonedContextData);
                    ruleContextMappingsGet.generateRequest();
                } else {
                    this._showMessage(this._nothingToFixMessage);
                }
            },

            _onRuleContextMappingsGetResponse: function (e) {
                var ruleContextMappingsResponse = e.detail.response;
                var allBusinessConditions = [];
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                if (responseContent) {
                    var ruleContextMappings = responseContent.entityModels.length > 0 ? responseContent.entityModels[0].data : undefined;

                    if (typeof (ruleContextMappings) !== "undefined" && typeof (ruleContextMappings.contexts) !== "undefined" && ruleContextMappings.contexts.length > 0) {

                        var contextSpecificRuleMaps = ruleContextMappings.contexts;

                        for (var i = 0; i < contextSpecificRuleMaps.length; i++) {
                            var workflowName = contextSpecificRuleMaps[i].context.workflow;
                            var businessConditions = contextSpecificRuleMaps[i].relationships.hasBusinessConditions;

                            var contextSpecificBusinessCondition = {};
                            contextSpecificBusinessCondition["workflowName"] = workflowName;
                            contextSpecificBusinessCondition["businessConditions"] = businessConditions;
                            this.push("_contextSpecificBusinessConditions", contextSpecificBusinessCondition);
                            allBusinessConditions = allBusinessConditions.concat(businessConditions);
                        }
                    }

                    if (typeof (ruleContextMappings) !== "undefined" && typeof (ruleContextMappings.relationships) !== "undefined") {

                        var globalBusinessConditions = ruleContextMappings.relationships.hasBusinessConditions;

                        if (typeof (globalBusinessConditions) !== "undefined") {
                            for (var j = 0; j < globalBusinessConditions.length; j++) {

                                var globalBusinessCondition = {};
                                globalBusinessCondition["name"] = globalBusinessConditions[j].relTo.id;
                                globalBusinessCondition["attributes"] = globalBusinessConditions[j].attributes;
                                this.push("_globalBusinessConditions", globalBusinessCondition);
                            }
                            allBusinessConditions = allBusinessConditions.concat(globalBusinessConditions);
                        }
                    }

                    if(allBusinessConditions && allBusinessConditions.length > 0) {
                        this._entityTypeBusinessConditions = allBusinessConditions;
                        this._prepareToFixData();
                    } else {
                        this._showMessage(this._errorMessage);
                    }
                } else {
                    RUFUtilities.Logger.error("RuleContextMappingsGetResponseContent not found.");
                    this._showMessage(this._errorMessage);
                }
            },

            _onRuleContextMappingsGetError: function (e) {
                RUFUtilities.Logger.error("RuleContextMappingsGetError:- " + e.detail.response.reason.message);
                this._showMessage(this._errorMessage);
            },


            _setEntityWorkflowGovernData: function (entityGovernData) {
                if (typeof (entityGovernData) && typeof (entityGovernData.data) !== "undefined" && typeof (entityGovernData.data.contexts) !== "undefined") {
                    var contextualEntityGovernData = entityGovernData.data.contexts;

                    if (typeof (contextualEntityGovernData) !== "undefined" && contextualEntityGovernData.length > 0) {

                        for (var i = 0; i < contextualEntityGovernData.length; i++) {

                            // Non Worflow ContextInformation should be ignored
                            if (typeof (contextualEntityGovernData[i].context.workflow) !== "undefined") {
                                var workflowContext = contextualEntityGovernData[i].context;
                                var attributes = contextualEntityGovernData[i].attributes;

                                if (typeof (workflowContext) !== "undefined" && typeof (attributes) !== "undefined") {

                                    var workflowGovernData = {
                                        "id": workflowContext.workflow,
                                        "name": workflowContext.workflow,
                                        "attributes": attributes // Workflow Attributes [Also includes activities]
                                    }

                                    this.push("_entityGovernWorkflowNames", workflowContext.workflow);
                                    this.push("_entityWorkflowGovernData", workflowGovernData);
                                }
                            }
                        }
                    }
                }
            },

            _setEntityBusinessConditionsGovernData: function (entityGovernData) {
                if (typeof (entityGovernData) && typeof (entityGovernData.data) !== "undefined" && typeof (entityGovernData.data.attributes) !== "undefined") {
                    var entityGovernDataAttributes = entityGovernData.data.attributes;
                    var entityBusinessConditions = [];

                    if (typeof (entityGovernDataAttributes.businessConditions) !== "undefined" && typeof (entityGovernDataAttributes.businessConditions.group) !== "undefined") {
                        entityBusinessConditions = entityGovernDataAttributes.businessConditions.group;
                    }

                    if (typeof (entityBusinessConditions) !== "undefined" && entityBusinessConditions.length > 0) {
                        for (var i = 0; i < entityBusinessConditions.length; i++) {
                            var businessConditionId = AttributeHelper.getFirstAttributeValue(entityBusinessConditions[i].businessConditionName);
                            var businessConditionStatus = AttributeHelper.getFirstAttributeValue(entityBusinessConditions[i].businessConditionStatus);

                            var businessConditionGovernData = {
                                "id": businessConditionId,
                                "name": businessConditionId,
                                "status": businessConditionStatus
                            }

                            this.push("_entityBusinessConditionNames", businessConditionId);
                            this.push("_entityBusinessConditionsGovernData", businessConditionGovernData);
                        }
                    }
                }
            },


            _prepareToFixData: function () {
                if (this._isDataSetPrepared()) {
                    var _tofixData = [];
                    var workflowBusinessConditions = [];
                    var unkownBusinessConditionIds = [];

                    var tofixGlobalData = {};
                    tofixGlobalData["id"] = "general";
                    tofixGlobalData["label"] = "General";
                    tofixGlobalData["type"] = "Global";
                    tofixGlobalData["businessConditions"] = [];
                    if (this._entityWorkflowGovernData.length > 0 && this._contextSpecificBusinessConditions.length > 0) {

                        var tofixWorkflowDataSet = [];
                        for (var i = 0; i < this._entityWorkflowGovernData.length; i++) {
                             var workflowGovernData = this._entityWorkflowGovernData[i];

                            var workflowActivityNames = this._getWorkflowActivityNames(workflowGovernData.attributes);
                            for(var j = 0; j < workflowActivityNames.length; j++) {
                                var tofixWorkflowData = {};
                                tofixWorkflowData["id"] = workflowGovernData.id;
                                tofixWorkflowData["label"] = this._getWorkflowNameById(workflowGovernData.id);
                                tofixWorkflowData["type"] = "Workflow";
                                tofixWorkflowData["workflowActivityName"] = workflowActivityNames[j];
                                tofixWorkflowData["businessConditions"] = [];
                                tofixWorkflowDataSet.push(tofixWorkflowData);
                            }
                        }


                        for (var i = 0; i < tofixWorkflowDataSet.length; i++) {
                            var tofixWorkflowData = tofixWorkflowDataSet[i];

                            //find business conditions mapped to current workflow - from model obejcts
                            var workflowMappedBusinessConditions = this._getWorkflowMappedBusinessConditions(tofixWorkflowData.id);

                            for (var j = 0; j < workflowMappedBusinessConditions.length; j++) {
                                var businessConditionAttrs = workflowMappedBusinessConditions[j].attributes;
                                if(businessConditionAttrs && AttributeHelper.getFirstAttributeValue(businessConditionAttrs.stepName) == tofixWorkflowData.workflowActivityName) {
                                    workflowBusinessConditions.push(workflowMappedBusinessConditions[j].relTo.id);
                                    var toFixBusinessCondition = this._getBusinessConditionStatusAndPrepareToFixData(workflowMappedBusinessConditions[j]);
                                    if (toFixBusinessCondition && !DataHelper.containsObject(toFixBusinessCondition, tofixWorkflowData.businessConditions)) {
                                        if(toFixBusinessCondition.status === "unknown") {
                                            unkownBusinessConditionIds.push(toFixBusinessCondition.id);
                                        }
                                        tofixWorkflowData.businessConditions.push(toFixBusinessCondition); 
                                    }
                                }
                            }

                            //add current wf activity related info in main array
                            if(tofixWorkflowData.businessConditions.length > 0) {
                                _tofixData.push(tofixWorkflowData);
                            }
                        }
                    }

                    // If the BC is not mapped to any of the workflow then it should become Global
                    for (var x = 0; x < this._entityTypeBusinessConditions.length; x++) {
                        var businessCondition = this._entityTypeBusinessConditions[x];
                        if(workflowBusinessConditions.indexOf(businessCondition.relTo.id) == -1) {
                            var toFixBusinessCondition = this._getBusinessConditionStatusAndPrepareToFixData(businessCondition);
                            if (toFixBusinessCondition && !DataHelper.containsObject(toFixBusinessCondition, tofixGlobalData.businessConditions)) {
                                if(toFixBusinessCondition.status === "unknown" && unkownBusinessConditionIds.indexOf(toFixBusinessCondition.id) == -1) {
                                    unkownBusinessConditionIds.push(toFixBusinessCondition.id);
                                }
                                tofixGlobalData.businessConditions.push(toFixBusinessCondition);
                            }
                        }
                    }

                    if(tofixGlobalData.businessConditions.length > 0) {
                        _tofixData.push(tofixGlobalData);
                    }

                    this.set("_tofixData", _tofixData);
                    if(unkownBusinessConditionIds.length > 0) {
                        this._requestUnkownBusinessConditions(unkownBusinessConditionIds);
                    } else {
                        this._isToFixDataExists = true;
                    }
                }
            },

            _requestUnkownBusinessConditions: function (businessConditionIds) {
                if (businessConditionIds.length) {
                    this._requestBusinessConditions(businessConditionIds, "unknownBusinessConditionsGet");
                }
            },



            _onUnkownBusinessConditionsGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                if (responseContent) {
                    var businessConditions = responseContent.entityModels;

                    if (typeof (businessConditions) !== "undefined" && businessConditions.length > 0) {
                        for (var i = 0; i < businessConditions.length; i++) {

                            // LongNames are required for Displaying BusinessConditions
                            for(var j = 0; j < this._tofixData.length; j++) {
                                for(var k = 0; k < this._tofixData[j].businessConditions.length; k++) {
                                    if(this._tofixData[j].businessConditions[k].id == businessConditions[i].id) {
                                        this._tofixData[j].businessConditions[k].name = businessConditions[i].name;
                                    }
                                }
                            }
                        }
                    }

                    this._isToFixDataExists = true;
                } else {
                    RUFUtilities.Logger.error("EntityModelGetByIdsResponse Content not found.");
                    this._showMessage(this._errorMessage);
                }
            },

            _onUnkownBusinessConditionsGetError: function (e) {
                RUFUtilities.Logger.error("UnkownBusinessConditionsGetError:- " + e.detail.response.reason.message);
                this._showMessage(this._errorMessage);
            },

            _requestBusinessConditions: function(businessConditionIds, liquidElementId) {
                if (businessConditionIds.length) {

                    var businessConditionsGet = this.$$('#' + liquidElementId);
                    if (typeof (businessConditionsGet) === "undefined" || businessConditionsGet == null) {
                        RUFUtilities.Logger.error("Element having id " + liquidElementId + " not found.");
                        this._showMessage(this._errorMessage);
                        return;
                    }

                    var clonedContextData = DataHelper.cloneObject(this._clonedContextData);

                    // Prepare ItemContext
                    var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                    itemContext.id = businessConditionIds;
                    itemContext.type = "businessCondition";
                    clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                    clonedContextData.ItemContexts[0].attributeNames = ["impactedRoles"];

                    // Create Request and Get
                    businessConditionsGet.requestData = DataRequestHelper.createEntityGetRequest(clonedContextData);
                    businessConditionsGet.generateRequest();
                }
            },

            _isDataSetPrepared: function () {
                var isWorkflowDefinitionAvailable = false;
                var isGovernDataBCAvailable = false;
                var originalBCAvailable = false;

                if (this._entityBusinessConditionNames.length > 0) {
                    if (this._entityGovernWorkflowNames.length > 0) {
                        isWorkflowDefinitionAvailable = this._workflowDefinitions.length > 0;
                    }

                    isGovernDataBCAvailable = this._contextSpecificBusinessConditions.length > 0 || this._globalBusinessConditions.length > 0;
                    originalBCAvailable = this._originalBusinessConditions.length > 0;
                }

                if (this._entityGovernWorkflowNames.length > 0) {
                    return isWorkflowDefinitionAvailable && isGovernDataBCAvailable && originalBCAvailable;
                } else {
                    return isGovernDataBCAvailable && originalBCAvailable;
                }
            },

            _getWorkflowNameById: function (workflowId) {
                for (var i = 0; i < this._workflowDefinitions.length; i++) {
                    var workflowDefinition = this._workflowDefinitions[i];

                    if (workflowDefinition.name === workflowId) {
                        var workflowAttributes = workflowDefinition.attributes;
                        return AttributeHelper.getFirstAttributeValue(workflowAttributes.workflowName);
                    }
                }
            },

            _getWorkflowActivityNames: function (workflowAttributes) {
                var workflowActivityNames = [];

                if (typeof (workflowAttributes) !== "undefined" && typeof (workflowAttributes.activities) !== "undefined") {

                    var workflowActivities = workflowAttributes.activities;
                    if (typeof (workflowActivities) !== "undefined" && typeof (workflowActivities.group) !== "undefined") {

                        var workflowActivityGroups = workflowActivities.group;
                        for (var i = 0; i < workflowActivityGroups.length; i++) {
                            workflowActivityNames.push(AttributeHelper.getFirstAttributeValue(workflowActivityGroups[i].activityName));
                        }
                    }
                }

                return workflowActivityNames;
            },

            _getWorkflowMappedBusinessConditions: function (workflowName) {
                if (typeof (this._contextSpecificBusinessConditions) && this._contextSpecificBusinessConditions.length > 0) {
                    for (var i = 0; i < this._contextSpecificBusinessConditions.length; i++) {
                        if (this._contextSpecificBusinessConditions[i].workflowName === workflowName) {
                            return this._contextSpecificBusinessConditions[i].businessConditions;
                        }
                    }
                }
            },

            _getBusinessConditionStatusAndPrepareToFixData: function(businessCondition) {
               var unknown = {
                    "id" : businessCondition.relTo.id,
                    "name": businessCondition.relTo.id.replace("_" + businessCondition.relTo.type, ""),
                    "status": "unknown"
                };
                for (var i = 0; i < this._entityBusinessConditionsGovernData.length; i++) {
                    if(this._entityBusinessConditionsGovernData[i].id == businessCondition.relTo.id) {
                        if(this._entityBusinessConditionsGovernData[i].isAllowedToShow)
                        {
                            return this._entityBusinessConditionsGovernData[i];
                        }
                        //When not to show the BC
                        return;
                    }
                }
                return unknown;
            },

            _showMessage: function (message) {
                this.$$("#messagePanel").innerHTML = message;
                this._isToFixDataExists = true;
            },

            _onTap: function (e) {
                this.$$("#attributeDialog").name = "fix-attribute-errors";
                this.$$("#attributeDialog").sharedData={"business-condition-id":e.currentTarget.data.id,"context-data":this.contextData};
                this.$$("#attributeDialog").open();
            },

            _getIconByType: function (type) {
                if(typeof(type) === "boolean") {
                    if (type == false) {
                        return 'pebble-sm-icons:errorcheck';
                    } else {
                        return 'pebble-sm-icons:successCheck';
                    }
                } else {
                    return 'pebble-sm-icons:indeterminate';
                }
            },

            _isDividerNeeded: function (item, index) {
                if (index != 0 && this.data && this.data.tofixes && item.data.type != this.data.tofixes[index - 1].data.type) {
                    return true;
                }

                return false;
            },

            _prepareWorkflowDataContext: function (clonedContextData, itemContext) {
                var workflowDataContexts = [];

                if (typeof (this._entityTypeWorkflowMappings) !== "undefined" && this._entityTypeWorkflowMappings.length > 0) {

                    for (var i = 0; i < this._entityTypeWorkflowMappings.length; i++) {
                        var workflowDataContext = {};
                        workflowDataContext.self = "self/" + itemContext.id;
                        workflowDataContext.workflow = this._entityTypeWorkflowMappings[i];

                        workflowDataContexts.push(workflowDataContext);
                    }
                }

                return workflowDataContexts
            }
        });
    </script>
</dom-module>