<link rel="import" href="../../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../rock-navmenu/rock-navmenu.html">
<link rel="import" href="../rock-disclaimer/rock-disclaimer.html">
<link rel="import" href="../rock-quick-actions/rock-quick-actions.html">

<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../pebble-badge/pebble-badge.html">
<link rel="import" href="../pebble-main-logo/pebble-main-logo.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-tenant-logo/pebble-tenant-logo.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-badge/pebble-badge.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-toast/pebble-toast.html">

<link rel="import" href="../rock-profile/rock-profile.html">
<link rel="import" href="../rock-header-search/rock-header-search.html">
<link rel="import" href="../rock-notification/rock-notification.html">
<link rel="import" href="../rock-notification-list/rock-notification-list.html">
<link rel="import" href="../rock-hotline-settings/rock-hotline-settings.html">
<link rel="import" href="../bedrock-init/bedrock-init.html">
<script type="text/javascript" src="../../scripts/jquery-slim.js"></script>

<dom-module id="app-common">
    <template>
        <custom-style>
            <style include="bedrock-styles-variables bedrock-style-common">
                app-header {
                    color: var(--top-header-font-color);
                    width: 100%;
                    height: var(--app-header-height);
                    padding: 0 10px;
                    background: var(--top-header-background);
                    z-index: 4;
                    position: fixed;
                    left: 0;
                    top: 0;
                    right: 0;
                }

                app-header div[align="left"] {
                    width: 30%;
                    padding-left: 35px;
                    float: left;
                    height: 40px;
                    display: -ms-flexbox;
                    display: -webkit-flex;
                    display: flex;
                    align-items: center;
                }

                app-header div[align="right"] {
                    width: calc(70% - 280px);
                    float: right;
                    font-size: 0;
                    height: 40px;
                    display: -ms-flexbox;
                    display: -webkit-flex;
                    display: flex;
                    align-items: center;
                }

                paper-progress {
                    width: 100%;
                    position: absolute !important;
                    --paper-progress-height: 8px;
                    margin-left: 10px;
                    bottom:-3px;
                }

                app-header paper-icon-button {
                    --paper-icon-button-ink-color: var(--top-header-icon-color);
                }

                #navMenu {
                    --paper-menu: {
                        background: var(--left-nav-background);
                        overflow: hidden;
                    }
                }

                app-toolbar {
                    color: var(--palette-white);
                    height: var(--app-header-height);
                    padding-right: 0;
                    padding-left: 0;
                    display: block;
                }

                pebble-vertical-divider {
                    background: var(--top-header-vertical-divider-color, #ffffff);
                    --pebble-vertical-divider-height: 18px;
                    border-right: none;
                    opacity: 1;
                }

                app-toolbar a {
                    text-decoration: none;
                }

                pebble-vertical-divider {
                    background: var(--top-header-vertical-divider-color);
                    --pebble-vertical-divider-height: 18px;
                    border-right: none;
                    opacity: 1;
                }

                drawer-list {
                    margin: 0 20px;
                }

                .drawer-list a {
                    display: block;
                    padding: 0 16px;
                    text-decoration: none;
                    color: var(--app-secondary-color);
                    line-height: 40px;
                }

                .drawer-list a.iron-selected {
                    color: var(--border-black, #000);
                    font-weight: var(--font-bold, bold);
                }

                rock-notification {
                    height: 20px;
                    display: inline-block;
                    vertical-align: middle;
                    margin: 0px 5px 0 5px;
                    --header-badge: {
                        background: var(--header-notification-color);
                        color: var(--header-notification-text-color);
                        border-color: var(--header-notification-color);
                    }
                }

                #popoverUserNotifications,
                #popoverSystemNotifications {
                    margin-top: 9px;
                    --pebble-popover-width: 542px;
                    --pebble-popover-max-width: 556px;
                    --pebble-popover-max-height: 366px;
                    --popover: {
                        padding-top: 15px !important;
                        padding-bottom: 15px !important;
                    }
                }

                #userNotificationsList,
                #systemNotificationsList {
                    --notification-font-size: var(--default-font-size, 14px);
                    --profile-flex-verticle-max-width: 500px;
                    --desc-box-styles: {
                        text-align: left;
                    }
                }

                #appProgress {
                    --paper-progress-container: {
                        background:transparent !important;
                        z-index: -1;
                    }
                }

                .rock-header-style {
                    --search-icon-fill-color: #09c021;
                    position: relative;
                    display: inline-block;
                    vertical-align: middle;
                    width: 100%;
                }

                app-drawer {
                    margin-top: 40px;
                    z-index: 999;
                    --app-drawer-content-container: {
                        background-color: transparent !important;
                        -webkit-transition: all 0.3s;
                        -moz-transition: all 0.3s;
                        -o-transition: all 0.3s;
                        transition: all 0.3s;
                    }
                    ;
                    --app-drawer-scrim-background: none;
                }

                pebble-main-logo,
                pebble-tenant-logo {
                    display: inline-grid;
                    display: -ms-inline-grid;
                    vertical-align: middle;
                }

                app-header pebble-button {
                    display: inline-block;
                    vertical-align: middle;
                    height: 20px;
                    margin-top: 2px;
                }

                .search-wrap {
                    flex-grow: 1;
                }

                .search-wrap,
                .quick-wrap {
                    float: right;
                }

                [visibility-hidden] {
                    visibility: hidden;
                }

                pebble-horizontal-divider {
                    background-color: var(--palette-pale-grey-three, #e7ebf0);
                    margin-right: 20px;
                    margin-left: 20px
                }

                .popup-title {
                    margin: 0px;
                    font-size: var(--default-font-size, 14px);
                    font-weight: var(--font-medium, 500);
                    text-align: left;
                    @apply --popup-item;
                }

                #clipboard {
                    position: absolute;
                    height: 0;
                    width: 0;
                    top: -20px;
                    left: -20px;
                }
            </style>
        </custom-style>

        <bedrock-init locale-resource-path="/src/resources/locales.json" default-language="en"></bedrock-init>
        <app-header fixed effects="waterfall">
            <app-toolbar>
                <div align="left">
                    <pebble-main-logo logo-url="[[mainLogo]]" on-logo-click="onLogoClick"></pebble-main-logo>
                    <pebble-vertical-divider class="m-r-10 m-l-10"></pebble-vertical-divider>
                    <pebble-tenant-logo logo-url="[[tenantLogo]]" logo-text="[[tenantLogoText]]" on-logo-click="onLogoClick"></pebble-tenant-logo>
                </div>
                <div id="toastArea" align="center"></div>
                <rock-profile id="userProfile" src="../src/images/no-photo.jpg" user-details="[[userDetails]]" icon="pebble-icon:navigation-action-down"></rock-profile>
                <template is="dom-if" if="{{showHeaderSideBar}}">
                    <div align="right">
                        <div class="search-wrap">
                            <rock-header-search class="rock-header-style" context-data="[[contextData]]">
                            </rock-header-search>
                        </div>
                        <div class="quick-wrap">
                            <rock-quick-actions id="quick-actions" context-data="[[contextData]]" page-route="[[pageRoute]]"></rock-quick-actions>
                        </div>
                        <pebble-icon icon="pebble-icon:help" class="icon-button pebble-icon-color-white pebble-icon-size-20 m-r-5 m-l-5 tooltip-bottom"
                            onclick="window.open('/docportal')" data-tooltip="Help"></pebble-icon>
                        <rock-notification id="mdmUserNotifications" label="0" on-click="showUserNotifications" class="tooltip-bottom" data-tooltip="Notifications"></rock-notification>
                        <pebble-popover id="popoverUserNotifications" for="mdmUserNotifications" no-overlap display-arrow-as-per-target horizontal-align="right">
                            <div class="popup-title p-b-5">Notifications</div>
                            <pebble-horizontal-divider></pebble-horizontal-divider>
                            <rock-notification-list id="userNotificationsList" show-line-index="1">
                            </rock-notification-list>
                        </pebble-popover>
                        <rock-notification id="mdmSystemNotifications" label="0" on-click="showSystemNotifications" icon="pebble-icon:inbox" class="tooltip-bottom"
                            data-tooltip="System Notifications"></rock-notification>
                        <pebble-popover id="popoverSystemNotifications" for="mdmSystemNotifications" no-overlap display-arrow-as-per-target horizontal-align="right">
                            <div class="popup-title p-b-5">System Notifications</div>
                            <pebble-horizontal-divider></pebble-horizontal-divider>
                            <rock-notification-list id="systemNotificationsList" show-line-index="1">
                            </rock-notification-list>
                        </pebble-popover>
                        <rock-hotline-settings context-data="[[contextData]]"></rock-hotline-settings>
                    </div>
                </template>
                <div class="clearfix"></div>
            </app-toolbar>
            <paper-progress id="appProgress" class="middle fit" value="0" min="0" max="1000"></paper-progress>
        </app-header>
        <rock-disclaimer context-data="[[contextData]]" user-details="{{userDetails}}" view-opened="{{_appViewOpened}}"></rock-disclaimer>
        <pebble-toast id="pebbleAppToast" vertical-align="top">
            [[toastText]]
        </pebble-toast>
        <app-drawer id="drawerLayout" transition-duration='0' on-app-drawer-transitioned="onAppDrawerTransitioned" align="start"
            persistent opened has-scrolling-region>
            <rock-navmenu id="navMenu" page="{{page}}" query-params="{{queryParams}}" context-data="[[contextData]]" menu-items="{{menuItems}}"
                active-items="{{activeItems}}" route="{{routeData}}" on-menu-click="onMenuClick" on-menu-close-click="onMenuCloseClick"></rock-navmenu>
        </app-drawer>
        <rock-business-function-dialog id="contextDialog"></rock-business-function-dialog>
        <textarea id="clipboard"></textarea>
    </template>
    <script>
        Polymer({
            is: 'app-common',
            attached: function () {
                RUFUtilities.appCommon = this;
                RUFUtilities.pebbleAppToast = this.shadowRoot.querySelector('#pebbleAppToast');
                RUFUtilities.popoverUserNotifications = this.shadowRoot.querySelector(
                    '#popoverUserNotifications');
                RUFUtilities.popoverSystemNotifications = this.shadowRoot.querySelector(
                    '#popoverSystemNotifications');
                RUFUtilities.mdmUserNotifications = this.shadowRoot.querySelector('#mdmUserNotifications');
                RUFUtilities.mdmSystemNotifications = this.shadowRoot.querySelector(
                    '#mdmSystemNotifications');
                RUFUtilities.systemNotificationsList = this.shadowRoot.querySelector(
                    '#systemNotificationsList');
                RUFUtilities.userNotificationsList = this.shadowRoot.querySelector('#userNotificationsList');
                Polymer.Async.microTask.run(() => {
                    var paperProgress = this.shadowRoot.querySelector('#appProgress');
                    if (_.isEmpty(Globals.progressBar) && paperProgress) {
                        Globals.progressBar = paperProgress;
                    }
                    var navMenu = this.shadowRoot.querySelector('#navMenu');
                    if (navMenu && navMenu._collapseExpandDrawer) {
                        if (navMenu.doNotCollapse) {
                            navMenu.doNotCollapse = false;
                            return;
                        }
                        this._collapseExpandDrawer();
                    }
                });
            },
            properties: {
                cols: {
                    type: Number,
                    value: 2
                },
                page: {
                    type: String,
                    notify: true,
                    value: function () {
                        return "";
                    }
                },
                userDetails: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                menuItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                subMenuItem: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                disclaimerMessages: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                globalSettings: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                activeItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                toastText: {
                    type: String
                },
                queryParams: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {};
                    }
                },
                tenantId: {
                    type: String,
                    notify: true,
                    value: "t1"
                },
                roleId: {
                    type: String,
                    notify: true,
                    value: ""
                },
                userId: {
                    type: String,
                    notify: true,
                    value: ""
                },
                fullName: {
                    type: String,
                    value: ""
                },
                userName: {
                    type: String,
                    notify: true,
                    value: ""
                },
                ownershipData: {
                    type: String,
                    notify: true,
                    value: ""
                },
                isAuthenticated: {
                    type: Boolean,
                    value: false
                },
                tenantLogo: {
                    type: String,
                    value: ""
                },
                tenantLogoText: {
                    type: String,
                    value: ""
                },
                mainLogo: {
                    type: String,
                    value: "../src/images/mainlogo.svg"
                },

                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                showHeaderSideBar: {
                    type: Boolean,
                    value: true
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior,
                RUFBehaviors.ComponentConfigBehavior
            ],
            ready: function () {
                this._handleDocumentClick = this._handleDocumentClick.bind(this);
                RUFUtilities.drawerLayout = this.shadowRoot.querySelector("#drawerLayout");
                RUFUtilities.clipboard = this.shadowRoot.querySelector("#clipboard");
                RUFUtilities.navMenu = this.shadowRoot.querySelector("rock-navmenu");
                RUFUtilities.navMenu.addEventListener("click", this._handleDocumentClick);
                document.addEventListener("click", this._collapseExpandDrawer);

                RUFUtilities.progressBar = this.shadowRoot.querySelector("#appProgress");

                this._popoverUserNotifications = this.shadowRoot.querySelector('#popoverUserNotifications')
                this._mdmUserNotifications = this.shadowRoot.querySelector('#mdmUserNotifications');
                this._mdmSystemNotifications = this.shadowRoot.querySelector('#mdmSystemNotifications');
                this._popoverSystemNotifications = this.shadowRoot.querySelector(
                    '#popoverSystemNotifications');
            },
            detached: function () {
                document.removeEventListener("click", this._collapseExpandDrawer);
            },
            _handleDocumentClick: function (e) {
                if (RUFUtilities.drawerLayout && RUFUtilities.drawerLayout.$.contentContainer.style.width !=
                    "45px" && e.__domApi && e.__domApi.rootTarget) {
                    if (e.__domApi.rootTarget.id != "trigger" && e.__domApi.rootTarget.className.indexOf(
                            "menu-trigger") == -1 && e.__domApi.rootTarget.className.indexOf(
                            "iron-selected") == -1) {
                        var navMenu = RUFUtilities.navMenu;
                        if (navMenu) {
                            if (navMenu.doNotCollapse) {
                                return;
                            }
                            navMenu.$.toggleItem.click();
                        }
                    }
                }
            },
            onLogoClick: function () {
                var drawer = this.drawerLayout;
                //ToDo: remove hard coded style and use class toggle
                drawer.setAttribute("menu-expanded", "");
                drawer.style.width = "266px";
            },
            // Scroll page to top and expand header
            scrollPageToTop: function () {
                document.getElementById('mainContainer').scrollTop = 0;
            },
            onMenuClick: function (e, customArgs) {
                //   debugger;
                //   this.page = customArgs.item.name;
                //   this.$.contentViewManager.openView(customArgs.item.name, customArgs.item);
            },
            onMenuCloseClick: function (e, customArgs) {
                this._clearEntityManagePagesRefs();
                RUFUtilities.mainApp.contentViewManager.closeView(customArgs.item.data_route, customArgs.item
                    .queryParams);
            },
            onRefreshClick: function () {
                location.reload();
            },
            showUserNotifications: function () {
                this._popoverUserNotifications.show();
                this._mdmUserNotifications.label = 0;
            },
            showSystemNotifications: function () {
                this._popoverSystemNotifications.show();
                this._mdmSystemNotifications.label = 0;
            },
            _collapseExpandDrawer: function (e) {
                //do not close if we click on navbar
                //e.path is not a standard does not work in some browsers so we use e.composedPath() as a fallback
                //for cross-browser compatibility.
                if (RUFUtilities.navMenu._isMenuOpened && e) {
                    if (e.path) {
                        if (e.path.indexOf(RUFUtilities.navMenu) !== -1)
                            return;
                    } else if (e.composedPath()) {
                        if (e.composedPath().indexOf(RUFUtilities.navMenu) !== -1)
                            return;
                    }
                }
                RUFUtilities.navMenu._collapseSubMenu();
                RUFUtilities.drawerLayout.removeAttribute("menu-expanded");
                RUFUtilities.navMenu._isMenuOpened = false;
                RUFUtilities.drawerLayout.style.width = "45px";
                RUFUtilities.drawerLayout.$.contentContainer.style.width = "45px";
            },
            getFunctionDialog() {
                return this.$.contextDialog;
            },
            _clearEntityManagePagesRefs: function () {
                var appsIdsToClose = Object.keys(RUFUtilities.pubsubEventNameRegistry).filter(appId =>
                    appId.indexOf("app-entity-manage-component-") > -1);

                appsIdsToClose.forEach(appId => {
                    delete RUFUtilities.pubsubEventNameRegistry[appId];
                    delete RUFUtilities.pubsubListenerRegistry[appId];
                });
            }
        });
    </script>
</dom-module>