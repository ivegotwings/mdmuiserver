<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html" />
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html" />
<link rel="import" href="../bedrock-helpers/context-helper.html" />

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html" />
<link rel="import" href="../pebble-button/pebble-button.html" />
<link rel="import" href="../pebble-actions/pebble-actions.html" />
<link rel="import" href="../pebble-popover/pebble-popover.html" />
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html" />

<link rel="import" href="../rock-search-bar/rock-search-bar.html" />
<link rel="import" href="../rock-saved-searches/rock-saved-searches.html" />
<link rel="import" href="../rock-entity-type-model-lov/rock-entity-type-model-lov.html" />
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html" />
<link rel="import" href="../rock-entity-search-grid/rock-entity-search-grid.html" />
<link rel="import" href="../rock-business-function-dialog/rock-business-function-dialog.html" />
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html" />

<dom-module id="rock-entity-search-discovery">
    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
             :host {
                --pebble-popover-max-width: 100%;
            }

            rock-search-bar {
                --rock-search-input-panel-iron-icon: {
                    fill: #fff;
                }
            }

            .search-container {
                width: 100%
            }

            #savedSearchPopover {
                width: 400px;
                max-height: none!important;
                --pebble-popover-max-width: 100%;
                --pebble-popover-max-height: 360px;
                overflow: auto;
                @apply --popup-item;
                --popover: {
                    overflow: inherit;
                    padding-top:20px;
                    padding-bottom:20px;
                }
            }

            #rockSavedSearch {
                --saved-search-tab-content: {
                    max-height: 250px;
                    overflow: auto;
                }
            }

            .grid-filters {
                padding: 0 20px;
            }

            .entity-type-filter-container {
                width: 70%;
                padding-right: 10px;
            }

            rock-search-filter {
                --paper-menu-button: {
                    padding: 0;
                }
                --paper-menu: {
                    background: var(--palette-white, #fff);
                }
                --pebble-button-notraised: {
                    font-weight: normal;
                }
            }

            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--default-font-size, 14px);
                padding: 0 0 0 0;
                min-height: 40px;
            }

            .quick-manage-container {
                width: 30%;
                height: auto;
                display: block;
                position: relative;
                padding-left: 1%;
            }

            pebble-vertical-divider {
                --pebble-vertical-divider-color: #c1cad4;
                height: 100%;
                border: 0px;
                min-height: 0px;
                width: 2px;
                margin: 0;
            }
        </style>
        <template is="dom-if" if="[[_processTemplate]]">
            <div class="grid-filters">
                <div class="layout horizontal">
                    <template is="dom-if" if="[[_getVisibility('rock-search-bar')]]">
                        <div class="flex">
                            <div class="search-container">
                                <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                                <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                                    <pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                                </div>
                            </div>
                            <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                        </div>
                    </template>
                    <template is="dom-if" if="[[_getVisibility('rock-saved-searches')]]">
                        <pebble-button id="savedSearchButton" icon="pebble-md-icons:SavedSearch" button-text="Load Saved Search" noink raised dropdown-icon
                            on-tap="_onSavedSearchTap" class="dropdownIcon dropdownText btn m-l-10 dropdown-outline-primary"></pebble-button>
                        <pebble-popover id="savedSearchPopover" for="savedSearchButton" auto-fit-on-attach no-overlap horizontal-align="right" allow-multiple>
                            <rock-saved-searches id="rockSavedSearch" context-data="[[contextData]]" saved-searches="{{savedSearches}}" saved-search-id="{{savedSearchId}}"
                                show-title allow-create-edit-search show-settings></rock-saved-searches>
                        </pebble-popover>
                        <bedrock-pubsub event-name="saved-search-save" handler="_onCreateEditSavedSearch" target-id=""></bedrock-pubsub>
                        <bedrock-pubsub event-name="saved-search-cancel" handler="_onCancelSavedSearch" target-id=""></bedrock-pubsub>
                        <bedrock-pubsub event-name="rock-saved-search-click" handler="_loadSavedSearch" target-id=""></bedrock-pubsub>
                    </template>
                </div>
                <div class="layout horizontal p-t-10">
                    <template is="dom-if" if="[[_getVisibility('rock-entity-type-model-lov')]]">
                        <div class="entityTypeFilterContainer m-r-10">
                            <pebble-button id="entityTypeFilterButton" icon="pebble-sm-icons:Filter-wt" button-text="Entity Type" dropdown-icon noink
                                class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger" on-tap="_openEntityTypeFilterLov"></pebble-button>
                            <pebble-popover id="entityTypeFilterPopover" for="entityTypeFilterButton" no-overlap auto-fit-on-attach vertical-align="auto"
                                horizontal-align="auto">
                                <rock-entity-type-model-lov id="entityTypeModelLov" allowed-entity-types="[[allowedEntityTypes]]" selected-items="{{_selectedEntityTypes}}"
                                    show-action-buttons>
                                </rock-entity-type-model-lov>
                            </pebble-popover>
                            <bedrock-pubsub event-name="entity-type-model-lov-confirm-button-tap" handler="_onSelectedEntityTypesChange" target-id="entityTypeModelLov"></bedrock-pubsub>
                            <bedrock-pubsub event-name="entity-type-model-lov-close-button-tap" handler="_onEntityTypePopoverClose" target-id="entityTypeModelLov"></bedrock-pubsub>
                        </div>
                    </template>
                    <template is="dom-if" if="[[_getVisibility('rock-entity-search-filter')]]">
                        <div class="flex searchFilterTag">
                            <rock-entity-search-filter id="entitySearchFilter" _selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                types-criterion="[[_typesCriterion]]" tags="{{tags}}"></rock-entity-search-filter>
                            <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
                        </div>
                    </template>
                    <template is="dom-if" if="[[_getVisibility('pebble-actions')]]">
                        <div class="action-buttons">
                            <pebble-actions id="assignmentActions" hidden$="[[_isWorkflowActionsHidden(_workflowCriterion)]]" button-icon="pebble-md-icons:assignedactions"
                                class="dropdownText dropdownIcon btn btn-actions dropdown-success" button-text="Workflow Actions"
                                actions-data="[[getParentAppConfig('assignment-actions')]]"></pebble-actions>
                            <pebble-button class="btn btn-primary m-r-5" button-text="Quick Manage" on-tap="_onTapQuickManage"></pebble-button>
                            <pebble-actions id="actionsButton" button-icon="pebble-md-icons:actions" class="dropdownText dropdownIcon btn btn-actions dropdown-success"
                                button-text="Actions" actions-data="[[getParentAppConfig('pebble-actions')]]"></pebble-actions>
                            <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap" target-id=""></bedrock-pubsub>
                            <rock-business-function-dialog id="rollupDialog"></rock-business-function-dialog>
                            <rock-business-function-dialog id="wfTransitionDialog"></rock-business-function-dialog>
                            <rock-business-function-dialog id="wfAssignmentDialog"></rock-business-function-dialog>
                            <rock-business-function-dialog id="rePublishDialog"></rock-business-function-dialog>
                        </div>
                    </template>
                </div>
            </div>
            <div class="row-wrap">
                <template is="dom-if" if="[[_getVisibility('rock-entity-search-grid')]]">
                    <div class$="[[_applyClass(_quickManageEnabled)]]">
                        <rock-entity-search-grid id="entitySearchGrid" context-data="[[contextData]]" grid-config="[[getParentAppConfig('rock-entity-search-grid', '', 'gridConfig')]]" govern-attributes-criterion = "[[getParentAppConfig('rock-entity-search-grid', '', 'governAttributesCriterion')]]"
                            govern-data-config="[[getParentAppConfig('rock-entity-search-grid', '', 'governDataConfig')]]" search-query="{{searchQuery}}"
                            saved-search-id="[[savedSearchId]]" workflow-criterion="[[_workflowCriterion]]" search-filters="[[_selectedSearchFilters]]"
                            current-record-size="{{_gridFullLength}}" types-criterion="[[_typesCriterion]]"></rock-entity-search-grid>
                        <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
                        <bedrock-pubsub event-name="govern-grid-selecting-item" handler="_onSelectingGridItem" target-id="governGrid"></bedrock-pubsub>
                    </div>
                </template>
                <template is="dom-if" if="[[_getVisibility('rock-entity-quick-manage')]]">
                    <template is="dom-if" if="[[_quickManageEnabled]]">
                        <div>
                            <pebble-vertical-divider>
                            </pebble-vertical-divider>
                        </div>
                        <div class="quick-manage-container">
                            <rock-entity-quick-manage id="entityQuickManage" context-data="[[contextData]]" current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]"
                                selected-entity="[[_selectedEntity]]" tab-config="[[getParentAppConfig('rock-entity-quick-manage', '', 'rock-tabs')]]"
                                toolbar-config="[[getParentAppConfig('rock-entity-quick-manage', '', 'pebble-toolbar')]]" fixes="[[getParentAppConfig('rock-entity-quick-manage', '', 'rock-entity-tofix')]]"></rock-entity-quick-manage>
                            <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                            <bedrock-pubsub event-name="on-tap-previous" handler="_onClickPrevious" target-id="entityQuickManage"></bedrock-pubsub>
                            <bedrock-pubsub event-name="on-tap-next" handler="_onClickNext" target-id="entityQuickManage"></bedrock-pubsub>
                        </div>
                    </template>
                </template>
            </div>
        </template>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-entity-search-discovery',

                properties: {
                    configData: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        'observer': '_configDataChanged'
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    selectedDimensions: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    searchQuery: {
                        type: String,
                        value: ""
                    },
                    savedSearchId: {
                        type: String,
                        value: ""
                    },
                    savedSearches: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_savedSeachesChanged'
                    },
                    workflowName: {
                        type: String,
                        value: ""
                    },
                    workflowShortName: {
                        type: String,
                        value: ""
                    },
                    workflowActivityName: {
                        type: String,
                        value: ""
                    },
                    workflowActivityExternalName: {
                        type: String,
                        value: ""
                    },
                    businessConditionName: {
                        type: String,
                        value: ""
                    },
                    user: {
                        type: String,
                        value: ""
                    },
                    entityIdList: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    allowedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    requestedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _processTemplate: {
                        type: Boolean,
                        value: false
                    },
                    _resetSearchEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _lastSavedSearchId: {
                        type: String,
                        value: ""
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: "_onGridConfigChange"
                    },
                    _selectedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _typesCriterion: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _selectedSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _workflowCriterion: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridFullLength: {
                        type: Number,
                        value: 0
                    },
                    _quickManageEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _currentIndex: {
                        type: Number,
                        value: -1
                    }
                },

                behaviors: [
                    RUFBehaviors.AppBehavior
                ],

                _configDataChanged: function () {
                    if (!DataHelper.isEmptyObject(this.configData)) {
                        this._processTemplate = true;
                        Polymer.dom.flush();

                        this._initializeComponent();

                        this._searchBarElement.searchInput = [];
                        if (this.searchQuery) {
                            this._searchBarElement.query = this.searchQuery;
                        }

                        if (this.savedSearchId && this.savedSearchId !== this._lastSavedSearchId) {
                            this._lastSavedSearchId = this.savedSearchId;
                        } else if (!DataHelper.isEmptyObject(this.workflowName)) {
                            var userId = "";
                            if (this.user.toLowerCase() == "all") {
                                userId = "";
                            } else if (this.user.toLowerCase() == "currentuser") {
                                userId = DataHelper.getUserName();
                            } else if (this.user.toLowerCase() == "unassigned") {
                                userId = "_UNASSIGNED";
                            }

                            var workflowCriterion = {
                                "workflowName": this.workflowName,
                                "workflowActivityName": this.workflowActivityName,
                                "workflowActivityExternalName": this.workflowActivityExternalName,
                                "userId": userId,
                                "status": this.status,
                                "businessConditionExternalName":this.businessConditionExternalName
                            };
                            //WF short name should be added only when it is available
                            if(this.workflowShortName) {
                                workflowCriterion["workflowShortName"] = this.workflowShortName
                            }

                            if(this.businessConditionName){
                                var businessConditionNames = this.businessConditionName.split("#@#");
                                if (businessConditionNames.length > 1) {
                                    workflowCriterion.businessConditionNames = businessConditionNames;
                                } else {
                                    workflowCriterion.businessConditionName = this.businessConditionName;
                                }
                            }

                            if (!DataHelper.isEmptyObject(workflowCriterion)) {
                                this.set("_workflowCriterion", workflowCriterion);
                            }
                        }

                        this._gridConfig = this.getParentAppConfig("rock-entity-search-grid", "", "gridConfig");
                    }
                },

                _initializeComponent: function () {
                    if (this.shadowRoot.querySelector("#searchBar")) {
                        this._searchBarElement = this.shadowRoot.querySelector("#searchBar");
                    }

                    if (this.shadowRoot.querySelector("#savedSearchButton")) {
                        this._savedSearchButton = this.shadowRoot.querySelector("#savedSearchButton");
                    }

                    if (this.shadowRoot.querySelector("#savedSearchPopover")) {
                        this._savedSearchPopoverElement = this.shadowRoot.querySelector("#savedSearchPopover");
                    }

                    if (this.shadowRoot.querySelector("#rockSavedSearch")) {
                        this._savedSearchElement = this.shadowRoot.querySelector("#rockSavedSearch");
                    }

                    if (this.shadowRoot.querySelector("#entityTypeModelLov")) {
                        this._entityTypeModelLov = this.shadowRoot.querySelector("#entityTypeModelLov");
                    }

                    if (this.shadowRoot.querySelector("#entitySearchFilter")) {
                        this._entitySearchFilterElement = this.shadowRoot.querySelector("#entitySearchFilter");
                    }

                    if (this.shadowRoot.querySelector("#entitySearchGrid")) {
                        this._searchGridElement = this.shadowRoot.querySelector("#entitySearchGrid");
                    }
                },

                _getVisibility: function (componentName) {
                    if (typeof (this.configData) == "object") {
                        var componentsVisibility = this.configData.componentsVisibility;
                        for (var i = 0; i < componentsVisibility.length; i++) {
                            if (componentsVisibility[i].name === componentName) {
                                return componentsVisibility[i].visible;
                            }
                        }
                    }
                },

                _onGridConfigChange: function () {
                    if (this._gridConfig && !DataHelper.isEmptyObject(this._gridConfig)) {

                        if(this.requestedEntityTypes && this.requestedEntityTypes.length > 0) {
                            this._typesCriterion = this.requestedEntityTypes;
                        } else {
                            this._typesCriterion = this._gridConfig.dataRequest.typesCriterion;
                        }

                        if (this._typesCriterion && this._typesCriterion.length > 0) {
                            var itemContexts = [];
                            for (var i in this._typesCriterion) {
                                var itemContext = {
                                    'type': this._typesCriterion[i]
                                };
                                itemContexts.push(itemContext);
                            }
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts
                        }

                        if (this.entityIdList && this.entityIdList.length > 0) {
                            var itemContexts = ContextHelper.getItemContexts(this.contextData);
                            for (var i in this.entityIdList) {
                                var itemContext = {
                                    'id': this.entityIdList[i]
                                };
                                itemContexts.push(itemContext);
                            }
                        }

                        this._selectedEntityTypes = this._getSelectedEntityTypes(this._typesCriterion);
                    }
                },

                _getSelectedEntityTypes: function (entityTypes) {
                    var selectedEntityTypesForLOV = [];

                    for (var i in entityTypes) {
                        var itemObj = {
                            "title": entityTypes[i],
                            "id": entityTypes[i]
                        };
                        if (!this._isItemPresent(selectedEntityTypesForLOV, entityTypes[i])) {
                            selectedEntityTypesForLOV.push(itemObj);
                        }
                    }

                    return selectedEntityTypesForLOV;
                },

                _isItemPresent: function (items, id) {
                    var presentItem = items.find(function (item) {
                        return item.id == id;
                    });
                    return !!presentItem;
                },


                // Rock search bar
                _onSearch: function (e, detail, sender) {
                    this.searchQuery = detail;
                 //   this.fireBedrockEvent("search-criteria-changed");
                    // this._searchTimeStamp = new Date().toLocaleString();
                },

                _showResetSearch: function (e) {
                    var tags = [];
                    var rockSearchFilter = this._entitySearchFilterElement.$$("rock-search-filter");
                    if (rockSearchFilter) {
                        tags = rockSearchFilter.tags;
                    }

                    //Preventing the reset search button from disappearing when there is a saved search selected/ search bar query/ refine more tag
                    if (!DataHelper.isEmptyObject(this._searchBarElement.query) || tags.length > 0 || this.savedSearchId !="") {
                        this._resetSearchEnabled = true;
                    } else {
                        this._resetSearchEnabled = false;
                    }
                },

                _resetSearch: function () {
                    // Clear SearchBar
                    this.searchQuery = "";
                    this._searchBarElement.query = "";

                    // Clear SavedSearch
                    this._savedSearchButton.buttonText = "Saved Search";
                    this.savedSearchId = "";

                    // Clear SearchFilter
                    this.tags = []; // Todo
                    this._selectedSearchFilters = [];
                    this._entitySearchFilterElement.clearSearchFilters();

                    this._resetSearchEnabled = false;
                },


                // Saved Search
                _onSavedSearchTap: function (e) {
                    this._savedSearchElement.contextData = this.contextData;
                    this._savedSearchPopoverElement.show();                    
                },

                _onCreateEditSavedSearch: function (e, detail, sender) {
                    if (detail) {
                        var _isUpdate = false;

                        //Check for permission to Update
                        if (!DataHelper.isEmptyObject(detail.selectedSearch)) {
                            var _currentUser = ContextHelper.getFirstUserContext(this.contextData);
                            _isUpdate = true;

                            //Todo: admin role may changed 
                            if (_currentUser && _currentUser.user != detail.selectedSearch.createdby &&
                                _currentUser.role != "admin") {
                                this.showErrorToast(
                                    "You do not have permissions to update the saved search, please contact administrator."
                                );
                                return;
                            }
                        }

                        //Initiate
                        var _savedSearchDetails = {
                            "saved-search-info": "",
                            "search-query": "",
                            "workflowCriterion": this._workflowCriterion,
                            "search-tags": [],
                            "dimensions": {},
                            "entityTypes": []
                        };

                        // create or edit form info
                        _savedSearchDetails["saved-search-info"] = detail;

                        // search input info
                        _savedSearchDetails["search-query"] = this._searchBarElement.query;

                        // search filters
                        if (this._entitySearchFilterElement) {
                            var searchFilterElement = this._entitySearchFilterElement.$$(
                                "rock-search-filter");
                            _savedSearchDetails["search-tags"] = searchFilterElement.tags;
                        }

                        // dimension selectors info
                        _savedSearchDetails["dimensions"] = this.selectedDimensions;

                        // entity-types
                        _savedSearchDetails["entityTypes"] = this._entityTypeModelLov.selectedItems;

                        if (detail.selectedSearch && !DataHelper.isEmptyObject(detail.selectedSearch)) {
                            this._savedSearchElement.createUpdateSavedSearch(_savedSearchDetails,
                                "update");
                            return;
                        }

                        // Use rock-saved-searches to create new search
                        this._savedSearchElement.createUpdateSavedSearch(_savedSearchDetails, "create");
                    }
                },

                _onCancelSavedSearch: function (e, detail, sender) {
                    this._savedSearchElement.shadowRoot.querySelector('rock-tabs').shadowRoot.querySelector('pebble-tab-group').notifyResize(); //To load tabs properly
                },

                _loadSavedSearch: function (e, detail, sender) {                   
                    if (detail) {                        
                        this.savedSearchId = detail.id;
                        ComponentHelper.setQueryParams({
                            "_savedSearchId": detail.id
                        });
                    }
                },

                _savedSeachesChanged: function (newValue, oldValue) {
                    if (newValue != oldValue) {
                        if (this.savedSearchId && this.savedSearches) {
                            var savedSearch = this._getSavedSearches(this.savedSearches, this.savedSearchId);
                            this._populateHeaderControls(savedSearch);
                            this._searchGridElement.savedSearchCriterion = savedSearch;
                        }
                    }
                },

                _getSavedSearches: function (savedSearches, savedSearchId) {
                    var savedSearch;
                    if (savedSearches) {
                        for (var category in savedSearches) {
                            var categorySavedSearches = savedSearches[category];
                            if (categorySavedSearches && categorySavedSearches.length > 0) {
                                for (var i = 0; i < categorySavedSearches.length; i++) {
                                    if (categorySavedSearches[i].id == savedSearchId) {
                                        savedSearch = categorySavedSearches[i];
                                        break;
                                    }
                                }
                                if (savedSearch) {
                                    break;
                                }
                            }
                        }
                    }
                    return savedSearch;
                },

                _populateHeaderControls: function (savedSearch) {
                    if (savedSearch) {
                        //Show the Reset Button
                        this._showResetSearch();

                        // search input info
                        this._searchBarElement.query = savedSearch.searchQuery;

                        // search filter info
                        this._selectedSearchFilters = [];
                        this._entitySearchFilterElement.tags = savedSearch.searchTags ? savedSearch.searchTags :
                            [];
                        if (!DataHelper.isEmptyObject(this._entitySearchFilterElement.tags)) {
                            for (var i = 0; i < this._entitySearchFilterElement.tags.length; i++) {
                                var attr = {};
                                attr[this._entitySearchFilterElement.tags[i].name] = this._entitySearchFilterElement
                                    .tags[i].value;
                                attr[this._entitySearchFilterElement.tags[i].name]["noPopoverOnAttach"] = true;
                                this.push('_selectedSearchFilters', attr);
                            }
                        }

                        // dimensionselector info
                        this.selectedDimensions = savedSearch.dimensions;
                        // dimensionSelector.$$('rock-entity-lov').refershTemplate(); // Todo: May be need to raise an event here

                        this._savedSearchButton.buttonText = savedSearch.name;
                        this.searchQuery = savedSearch.searchQuery;

                        if (!DataHelper.isEmptyObject(savedSearch.workflowCriterion)) {
                            this.set("_workflowCriterion", savedSearch.workflowCriterion);
                        }

                        // entitytype info
                        this._entityTypeModelLov.selectedItems = savedSearch.entityTypes;
                        var typesCriterion = savedSearch.entityTypes.map(function (e) {
                            return e.id
                        });
                        this.set("_typesCriterion", typesCriterion);
                        this.refresh();
                    }
                },


                // Quick Manage
                _onSelectingGridItem: function (e, detail, sender) {
                    if (this._quickManageEnabled) {
                        this._selectedEntity = detail.item;

                        if (!DataHelper.isEmptyObject(this._selectedEntity)) {
                            var itemContext = {
                                'id': this._selectedEntity.id,
                                'type': this._selectedEntity.type
                            };
                            this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                            this._searchGridElement.clearSelection();
                            Polymer.Async.microTask.run(() => { 
                                this._currentIndex = this._searchGridElement.getSelectedItemIndex();
                            });
                        }
                    }
                },

                _onTapQuickManage: function () {
                    this._quickManageEnabled = !this._quickManageEnabled;

                    var selectedCount = this._searchGridElement.getSelectedItems();
                    if (selectedCount.length > 1) {
                        this.showWarningToast("Cannot use multiple entities for Quick Manage");
                    }
                    if (this._quickManageEnabled) {
                        var selectedItem = this._searchGridElement.selectedItem;
                        this._selectedEntity = selectedItem;

                        if (!DataHelper.isEmptyObject(selectedItem)) {
                            var itemContext = {
                                'id': selectedItem.id,
                                'type': selectedItem.type
                            };
                            this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                            this._searchGridElement.clearSelection(); //Clear current selection
                            this._searchGridElement.selectItem(selectedItem); //Select item
                            this._currentIndex = this._searchGridElement.getSelectedItemIndex();
                            this._searchGridElement.scrollToIndex(this._currentIndex);
                        }
                    } else {
                        this._currentIndex = -1;
                    }

                    this._searchGridElement.notifyResize();
                },

                _applyClass: function () {
                    if (this._quickManageEnabled) {
                        return "col-8";
                    }

                    return "col-12";
                },

                _selectEntity: function (index, nav) {
                    if (!(index < 0)) {
                        var gridData = this._searchGridElement.getData();

                        if (gridData.length > 0 && index < this._gridFullLength) {
                            if (gridData[index].attributes) {
                                this._selectedEntity = gridData[index];

                                var itemContext = {
                                    'id': this._selectedEntity.id,
                                    'type': this._selectedEntity.type
                                };
                                this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                                this._currentIndex = index;
                                this._searchGridElement.clearSelection();
                                this._searchGridElement.selectItem(gridData[index]);

                                //On previous click already data got loaded, so directly we can set scroll index
                                //but for next, data will loaded as per page size, so scroll as per allow scroll
                                if (nav == 'previous' || this._isAllowedToScroll()) {
                                    this._searchGridElement.scrollToIndex(this._currentIndex);
                                }
                            } else {
                                var nextScrollIndex = this._searchGridElement.totalRecords + this._searchGridElement
                                    .pageSize;
                                // Todo: nextScrollIndex will be based on the grid total count
                                this._searchGridElement.scrollToIndex(nextScrollIndex);

                                setTimeout(() =>{
                                    this._selectEntity(index);
                                }, 10);
                            }
                        }
                    }
                },

                _isAllowedToScroll: function () {
                    if (((this._currentIndex) % this._searchGridElement.pageSize) == 0) {
                        return true;
                    }

                    return false;
                },

                _onClickPrevious: function (e, detail, sender) {
                    if (this._currentIndex > 0) {
                        this._selectEntity(this._currentIndex - 1, 'previous');
                    }
                },

                _onClickNext: function (e, detail, sender) {
                    if (this._currentIndex < this._gridFullLength) {
                        this._selectEntity(this._currentIndex + 1);
                    }
                },

                _onAttributeSave: function (e, detail, sender) {
                    //Changing the row style of the updated record
                    var selectedRow = this._searchGridElement.getSelectedGridRow();
                    selectedRow.style['font-style'] = 'italic';
                },


                // Entity Type Filter
                _openEntityTypeFilterLov: function () {
                    this.shadowRoot.querySelector("#entityTypeFilterPopover").open();
                },

                _onSelectedEntityTypesChange: function (e, detail) {
                    var selectedEntitiesObj = detail.data;

                    if (selectedEntitiesObj && selectedEntitiesObj.length) {
                        var selectedEntities = [];
                        for (var i = 0; i < selectedEntitiesObj.length; i++) {
                            if (typeof selectedEntitiesObj[i].id == "string" || typeof selectedEntitiesObj[i].id == "number") {
                                selectedEntities.push(selectedEntitiesObj[i].id);
                            }
                        }
                        this.set("_typesCriterion", selectedEntities);
                        this.refresh();
                    } else {
                        this._onGridConfigChange();
                    }
                    this.shadowRoot.querySelector("#entityTypeFilterPopover").close();
                },

                _onEntityTypePopoverClose: function (e, detail) {
                    this.shadowRoot.querySelector("#entityTypeFilterPopover").close();
                },


                // Actions Buttons
                _onActionsTap: function (e) {
                    this.$$('#actionsPopover').show();
                },

                // Revisit
                _onActionItemTap: function (e, detail, sender) {
                    var selectedItems = this._searchGridElement.getSelectedItems();
                    var selectionMode = this._searchGridElement.getSelectionMode();
                    var selectionQuery = this._searchGridElement.getSelectedItemsAsQuery();

                    var eventName;
                    if (detail && detail.data) {
                        eventName = detail.data.eventName;
                    }

                    if (!eventName) {
                        this.showErrorToast("Unknown action triggered, system cannot do the process.");
                        return;
                    }

                    var asyncAvailable = false;
                    if (eventName == "action-takeTask" ||
                        eventName == "action-releaseTask" ||
                        eventName == "action-wfTransitions") {
                        asyncAvailable = true;
                    }

                    if (!asyncAvailable || (asyncAvailable && selectionMode == "count")) {
                        if (DataHelper.isEmptyObject(selectedItems)) {
                            this.showErrorToast(
                                "Select atleast one entity for which you want to perform this action."
                            );
                            return;
                        }
                    }

                    if (asyncAvailable) {
                        if (selectionMode == "query" && DataHelper.isEmptyObject(selectionQuery)) {
                            this.showErrorToast(
                                "Selection query should be available for which you want to perform this action."
                            );
                            return;
                        }
                    } else { //Check needed when async not available
                        if (!DataHelper.isEmptyObject(selectedItems) && selectedItems.length > 20) {
                            this.showErrorToast("Maximum 20 entities can be selected.");
                            return;
                        }
                    }

                    if (!DataHelper.isEmptyObject(selectedItems)) {
                        this._selectedEntities = selectedItems;
                    }

                    if (detail) {
                        if (detail.data.eventName == "action-takeTask") {
                            this._showAssignmentDialog(detail, "take", selectionMode, selectionQuery);
                        } else if (detail.data.eventName == "action-releaseTask") {
                            this._showAssignmentDialog(detail, "release", selectionMode, selectionQuery);
                        } else if (detail.data.eventName == "action-wfTransitions") {
                            //Fetch the wf details from the URL
                            var wfName = this._workflowCriterion.workflowName;
                            var wfActivityName = this._workflowCriterion.workflowActivityName;
                            var wfActivityExternalName = this._workflowCriterion.workflowActivityExternalName;
                            var user = this._workflowCriterion.userId; // ?

                            var currentWorkflow = {
                                "name": wfName,
                                "activityName": wfActivityName
                            }

                            var transitionDialog = this.shadowRoot.querySelector("#wfTransitionDialog");
                            transitionDialog.name = detail.data.componentName;
                            transitionDialog.sharedData = {
                                "selection-mode": selectionMode,
                                "selection-query": selectionQuery,
                                "selected-entities": this._selectedEntities,
                                "context-data": this.contextData,
                                "current-workflow": currentWorkflow
                            };
                            transitionDialog.open();
                            var existingTitle = transitionDialog.getTitle();
                            transitionDialog.setTitle(existingTitle + " - " + wfActivityExternalName);
                        } else if (detail.data.eventName == "action-rollup") {
                            var rollupDialog = this.shadowRoot.querySelector("#rollupDialog");
                            rollupDialog.name = detail.data.componentName;
                            rollupDialog.configName = detail.data.componentConfigName;
                            rollupDialog.sharedData = {
                                "context-data": this.contextData,
                                "selected-entities": this._selectedEntities
                            };
                            rollupDialog.open();
                        } else if (detail.data.eventName == "action-re-publish") {
                            var validatePublishResult = this._validateRePublish();
                            if (validatePublishResult.valid) {
                                var rePublishDialog = this.shadowRoot.querySelector("#rePublishDialog");
                                rePublishDialog.name = detail.data.componentName;
                                rePublishDialog.sharedData = {
                                    "context-data": this.contextData,
                                    "selected-entities": this._selectedEntities
                                };
                                rePublishDialog.open();
                            } else {
                                this._showToastMessage(validatePublishResult);
                            }
                        }
                    }
                },

                _validateRePublish: function () {
                    var resultObj = {
                        valid: false,
                        type: 'error',
                        message: "welcome"
                    };

                    var selectedEntities = this._selectedEntities;

                    if (selectedEntities && selectedEntities.length <= 20) {
                        resultObj.message = "Config Not Found."
                        var rock_republish_config = this.getParentAppConfig("rock-re-publish");
                        if (rock_republish_config) {
                            var rePublishConfig = rock_republish_config.steps;
                            if (rePublishConfig && rePublishConfig.length > 0) {
                                var profiles = rePublishConfig[0].component.properties.profiles;
                                if (profiles && profiles.length > 0) {
                                    var typesInConfig = [];

                                    _.each(profiles, function (element) {
                                        typesInConfig = _.union(typesInConfig, element[
                                            "types-criterion"]);
                                    });
                                    var isValid = true;
                                    for (var index = 0; index < selectedEntities.length; index++) {
                                        var element = selectedEntities[index];
                                        if (typesInConfig.indexOf(element.type) == -1) {
                                            isValid = false;
                                            resultObj.message =
                                                "You can publish only following entity types: " +
                                                typesInConfig.toString();
                                            break;
                                        }
                                    }
                                    resultObj.valid = isValid;
                                }
                            }
                        }
                    } else {
                        resultObj.message = "Maximum 20 entities can be selected.."
                    }

                    return resultObj;
                },

                _showAssignmentDialog: function (detail, action, selectionMode, selectionQuery) {
                    var assignmentDialog = this.shadowRoot.querySelector("#wfAssignmentDialog");
                    assignmentDialog.name = detail.data.componentName;
                    assignmentDialog.sharedData = {
                        "selection-mode": selectionMode,
                        "selection-query": selectionQuery,
                        "selected-entities": this._selectedEntities,
                        "context-data": this.contextData,
                        "assignment-Action": action,
                        "workflow-external-name": this._workflowCriterion.workflowName,
                        "workflow-activity-external-name": this._workflowCriterion.workflowActivityExternalName,
                        "workflow-name": this._workflowCriterion.workflowShortName,
                        "workflow-activity-name": this._workflowCriterion.workflowActivityName
                    };
                    assignmentDialog.open();
                },

                _showToastMessage: function (msgObject) {
                    if (msgObject) {
                        if (msgObject.type == "error") {
                            this.showErrorToast(msgObject.message, 10000);
                        } else if (msgObject.type == "success") {
                            this.showSuccessToast(msgObject.message, 10000);
                        }
                    }
                },

                _isWorkflowActionsHidden: function (wfCriterion) {
                    if (DataHelper.isEmptyObject(wfCriterion)) {
                        return true;
                    }
                    return false;
                },

                refresh: function () {
                    if (!this._quickManageEnabled && !DataHelper.isEmptyObject(this.contextData)) {
                        if (this._typesCriterion && this._typesCriterion.length > 0) {
                            var itemContexts = [];
                            for (var i in this._typesCriterion) {
                                var itemContext = {
                                    'type': this._typesCriterion[i]
                                };
                                itemContexts.push(itemContext);
                            }
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts
                        }

                        if (this.entityIdList && this.entityIdList.length > 0) {
                            var itemContexts = ContextHelper.getItemContexts(this.contextData);
                            for (var i in this.entityIdList) {
                                var itemContext = {
                                    'id': this.entityIdList[i]
                                };
                                itemContexts.push(itemContext);
                            }
                        }
                    }

                    if (this._quickManageEnabled) {
                        if (this.shadowRoot.querySelector("#entityQuickManage")) {
                            this.shadowRoot.querySelector("#entityQuickManage").reload();
                        }
                    } else {
                        if (this._searchGridElement) {
                            this._searchGridElement.refresh();
                        }
                    }
                }
            });
        })();
    </script>
</dom-module>