<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">


<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html"/>

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<link rel="import" href="./child-items/rock-entity-relationships-summary-item.html">

<!--
    @group rock Elements
    @element rock-entity-relationships-summary
-->

<dom-module id="rock-entity-relationships-summary">
    <template>
        <style include="bedrock-styles-scroll-bar">
            :host{
                display: block;
                height:100%;
                position: relative;
            }
            .relationships-summary__items {
                text-align: center;
                margin:0px;
                padding:0px;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                height:100%;
            }

            .relationships-summary__item-wrapper {
                padding-bottom: 10px;
                text-align: center;
                cursor: pointer;
                list-style: none;
                padding-right: 10px;
            }

            .relationships-summary__items-wrapper{
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                box-sizing: border-box;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            pebble-spinner {
                background: var(--white, #fff);
                margin: 5px 20px 30px;
                box-sizing: border-box;
            }
        </style>

        <liquid-entity-model-get id="liquidModeleGet" operation="getbyids" request-data={{_request}}
                                 on-response="_onModelReceived"
                                 on-error="_onModelGetFailed"></liquid-entity-model-get>

        <liquid-entity-model-get id="getRelDomains" operation="getbyids" on-response="_onRelModelsReceived"
                                 on-error="_onModelGetFailed"></liquid-entity-model-get>

        <pebble-spinner active="[[_loading]]"></pebble-spinner>

        <template is="dom-if" if="{{hasComponentErrored(isComponentErrored)}}">
                <div id="error-container"></div>
        </template>
            
        <template is="dom-if" if="{{!hasComponentErrored(isComponentErrored)}}">
            <div class="relationships-summary__items-wrapper">
                <ul class="relationships-summary__items">
                    <template is="dom-repeat" items="[[values]]">
                        <li class="relationships-summary__item-wrapper">
                            <rock-entity-relationships-summary-item is-down-direction="true" entity="[[entity]]" color="[[_getStyle(0, index)]]" data="[[item]]"
                                data-index$="[[dataIndex]]" data-sub-index$="[[dataSubIndex]]" load-govern-data$="[[loadGovernData]]"
                                context-data="[[contextData]]" on-tap="_onTap" apply-context-coalesce="[[applyContextCoalesce]]"></rock-entity-relationships-summary-item>
                        </li>
                    </template>
                    <template is="dom-repeat" items="[[whereUsedItems]]">
                        <li class="relationships-summary__item-wrapper">
                            <rock-entity-relationships-summary-item entity="[[entity]]" color="[[_getStyle(values.length, index)]]" data="[[item]]" data-index$="[[dataIndex]]"
                                data-sub-index$="[[dataSubIndex]]" load-govern-data$="[[loadGovernData]]" context-data="[[contextData]]" on-tap="_onTap"
                                apply-context-coalesce="[[applyContextCoalesce]]"></rock-entity-relationships-summary-item>
                        </li>
                    </template>
                </ul>
            </div>
        </template>

    </template>

    <script>
        class RockEntityRelationshipSummary
                    extends Polymer.mixinBehaviors([
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
    
                    ], Polymer.Element) {
            static get is() {
                return 'rock-entity-relationships-summary';
            }
            
            static get properties() {
                return {
                    data: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        }
                    },

                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    values: {
                        type: Array,
                        value: []
                    },

                    whereUsedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    excludeItems: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    domain: {
                        type: String,
                        value: "thing"
                    },

                    dataIndex: {
                        type: String,
                        value: "entityData"
                    },

                    dataSubIndex: {
                        type: String,
                        value: "data"
                    },

                    loadGovernData: {
                        type: Boolean,
                        value: true
                    },

                    entity: {
                        type: Object,
                        value: {}
                    },

                    _loading: {
                        type: Boolean,
                        value: true
                    },

                    applyContextCoalesce: {
                        type: Boolean,
                        value: false
                    },
                    
                    linkTab: {
                        type: String,
                        value: ""
                    }
                }
            }



                /**
                 *  Indicates the list of entities in the "JSON" format.
                 */

            _getStyle(offset, index) {
                return "color-variant-" + ((offset + index + 1) % 9);
            }

            ready() {
                super.ready();
                this.getData();
            }

            getData() {
                this._loading = true;
                this._setRequestObject();
                let liquid = this.$.liquidModeleGet;
                this.entity = this.getFirstItemContext();
                if (liquid) {
                    liquid.generateRequest();
                }
            }

            refresh() {
                this.getData();
            }

            //TODO: copy-paste section follows. This code is need to be extracted and generalized.
            _onModelReceived(e) {
                let responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                if (responseContent) {
                    this._relationshipEntityTypeMappings = this._getRelationshipEntityTypeMappings(responseContent.entityModels);
                    let relationshipTypeNames = this._relationshipEntityTypeMappings.map(function (rel) {
                        return rel.relationshipTypeName + "_relationshipModel";
                    });
                    this._generateCheckDomainRequest(relationshipTypeNames);
                } else {
                    this.logError("Models not found", e.detail, true);
                    this._loading = false;
                }
            }

            _generateCheckDomainRequest(relationshipTypeNames) {
                let req = DataHelper.cloneObject(this._request);
                delete req.params.query.id;
                req.params.query.ids = relationshipTypeNames;
                req.params.query.domain = this.domain;
                req.params.query.filters = {
                    "typesCriterion": ["relationshipModel"]
                };
                req.params.fields = {};
                let checkDomainLiquid = this.shadowRoot.querySelector("#getRelDomains");
                if (checkDomainLiquid) {
                    checkDomainLiquid.requestData = req;
                    checkDomainLiquid.generateRequest();
                }
            }
            _onRelModelsReceived(e) {
                let responseContent = DataHelper.validateAndGetResponseContent(e.detail.response)
                if (responseContent) {
                    let models = responseContent.entityModels;
                    let relationshipTypeNames = [];
                    for (let i = 0; i < models.length; i++) {
                        if (models[i].domain == this.domain) {
                            relationshipTypeNames.push(models[i].name);
                        }
                    }
                    this._relationshipEntityTypeMappings = this._relationshipEntityTypeMappings.filter(function (rel) {
                        let ownership = rel.relatedEntityTypes[0].properties.relationshipOwnership;
                        if (ownership != "whereused") {
                            return relationshipTypeNames.indexOf(rel.relationshipTypeName) > -1 && this.excludeItems.indexOf(rel.relationshipTypeName) == -1;
                        }
                    }.bind(this));
                    this.set("values",[])
                    this.values = this._relationshipEntityTypeMappings;
                    //adding a delay of half second since if data is severd from cache its
                    //immediate so we dont see the loader.
                    Polymer.Async.timeOut.after(500).run(() => {
                        this._loading = false;
                    });
                    // TODO: following lines are presenting in original source
                    // this._buildMenuItems(this._relationshipEntityTypeMappings);
                    // this._callback(menuItems);
                } else {
                    this.logError("Relationship models not found", e.detail, true);
                    this._loading = false;
                }
            }

            _onModelGetFailed(e) {
                this.logError("TabMenuError", e.detail, true);
                this._loading = false;
            }

            _getRelationshipEntityTypeMappings(entityModels) {
                let relationshipEntityTypeMappings = [];
                if (entityModels && entityModels.length > 0) {
                    if (entityModels[0].data && entityModels[0].data.relationships) {
                        let relationshipModels = entityModels[0].data.relationships;

                        Object.keys(relationshipModels).map(function (relationshipTypeName) {
                            let relationshipModel = {};
                            relationshipModel.relationshipTypeName = relationshipTypeName;
                            relationshipModel.relatedEntityTypes = relationshipModels[
                                    relationshipTypeName];
                            relationshipEntityTypeMappings.push(relationshipModel);
                        });
                    }
                }
                return relationshipEntityTypeMappings;
            }

            _setRequestObject() {
                let firstDataContext = this.getFirstDataContext();
                let firstItemContext = this.getFirstItemContext();

                let entityType = firstItemContext.type;

                let req = {
                    "params": {
                        "query": {
                            "id": entityType + "_entityManageModel",
                            "filters": {
                                "typesCriterion": ["entityManageModel"]
                            }
                        },
                        "fields": {
                            "relationships": ["_ALL"]
                        }
                    }
                };

                if(this.contextData) {
                    DataRequestHelper.addContextsToModelRequest(req, this.contextData);
                } else if (!_.isEmpty(firstDataContext)) {
                    req.params.query.contexts = [firstDataContext];
                }

                this._request = req;
            }
            // TODO: ends
            
            /**
             * Handling tap on rock-entity-relationships-summary-item.
             */
             _onTap(e) {
                if(e && e.target) {
                    let eventDetail = {
                        "defaultTab" : this.linkTab,
                        "defaultSubMenu" : e.target.description
                    }                
                    ComponentHelper.fireBedrockEvent("selection-changed", eventDetail, {ignoreId: true});
                }
            }
        }

        customElements.define(RockEntityRelationshipSummary.is, RockEntityRelationshipSummary)

    </script>
</dom-module>
