<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../../bedrock-helpers/data-helper.html">
<link rel="import" href="../../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../../rock-grid-data-sources/entity-relationship-grid-datasource.html">
<!--
    @group rock Elements
    @element rock-entity-relationships-summary-item
-->

<dom-module id="rock-entity-relationships-summary-item">
    <template>
        <style include="bedrock-style-common">
            .relationships-summary__item {
                border-radius: 50%;
                border: solid var(--border-black, #000) 2px;
                width: 65px;
                height: 65px;
                box-sizing: border-box;
                text-align: center;
            }

            .relationships-summary__item-value {
                font-weight: var(--font-bold, bold);
                color: var(--border-black, #000);
                margin-top: 30%;
                font-size: 18px;
            }

            .relationships-summary__item-description {
                margin-top: 10px;
                font-size: 11px;
                font-weight: var(--font-bold, bold);
                max-width: 70px;
            }
            .color-variant-1 {
                border-color:#0bb2e8;
                color: #0bb2e8;
            }
            .color-variant-2 {
                border-color:#36b44a;
                color: #0bb2e8;
            }
            .color-variant-3 {
                border-color:#785da7;
                color: #785da7;
            }
            .color-variant-4 {
                border-color:#f68d1e;
                color: #f68d1e;
            }
            .color-variant-5 {
                border-color:#f5d30c;
                color: #f5d30c;
            }
            .color-variant-6 {
                border-color:#ed204c;
                color: #ed204c;
            }
            .color-variant-7 {
                border-color:#1ccad5;
                color: #1ccad5;
            }
            .color-variant-8 {
                border-color: #54abe4;
                color: #54abe4;
            }
            .color-variant-9 {
                border-color:#42c9b6;
                color: #42c9b6;
            }
        </style>

        <!-- Search request section -->
        <liquid-entity-govern-data-get exclude-in-progress
                                       id="parentRelationsGet"
                                       operation="initiatesearchandgetcount"
                                       request-data="[[request]]"
                                       on-error="_onError"></liquid-entity-govern-data-get>
        <!-- Search request section ends-->

        <!-- Get request section -->
        <liquid-entity-data-get exclude-in-progress
                                id="getRelations"
                                operation="getbyids"
                                request-data="[[request]]"
                                on-error="_onError"
                                data-index$="[[dataIndex]]" 
                                data-sub-index$="[[dataSubIndex]]"></liquid-entity-data-get>
        <!-- Get request section ends-->

        <div class$="[[getSummaryItemColor('true')]]">
            <div class$="[[getSummaryItemColor()]]">
                <template is="dom-if" if="[[!_loading]]">
                    [[value]]
                </template>
                <template is="dom-if" if="[[_loading]]">
                    <div id="taskCountLoading">
                        <img id="loadingIcon" src="../../../../src/images/loading.svg" />
                    </div>
                </template>

            </div>
        </div>

        <div class="relationships-summary__item-description tooltip-bottom" data-tooltip$="[[description]]"><div class="text-ellipsis">[[description]]</div></div>
    </template>

    <script>
        Polymer({
            is: 'rock-entity-relationships-summary-item',

            properties: {

                color: {
                    type: String,
                    // value: ""
                },

                /**
                 *  Indicates the list of entities in the "JSON" format.
                 */
                data: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {};
                    }
                },

                request: {
                    type: Object,
                    value: {}
                },

                isDownDirection: {
                    type: Boolean,
                    value: false
                },

                downRequestTemplate: {
                    type: Object,
                    value: {
                        "params": {
                            "query": {
                                "id": "",
                                "filters": {
                                    "typesCriterion": []
                                }
                            },
                            "fields": {
                                "relationships": []
                            },
                            "options": {
                                "maxRecords": 1
                            }
                        }
                    }
                },

                upRequestTemplate: {
                    type: Object,
                    value: {
                        "params": {
                            "query": {
                                "filters": {
                                    "typesCriterion": [],
                                    "relationshipsCriterion": [
                                    ]
                                }
                            },
                            "fields": {
                                "relationships": []
                            },
                            "options": {
                                "maxRecords": 1
                            }
                        }
                    }
                },

                _loading: {
                    type: Boolean,
                    value: true
                },

                dataIndex: {
                    type: String,
                    value: "entityData"
                },

                dataSubIndex: {
                    type: String,
                    value: "data"
                },

                loadGovernData:{                    
                    type: Boolean,
                    value: true
                },

                contextData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                applyContextCoalesce: {
                    type: Boolean,
                    value: false
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],

            ready: function () {
                var liquid;
                this._loading = true;
                if (this.isDownDirection) {
                    this.description = this.data.relatedEntityTypes[0].properties.externalName;
                    this.request = this.generateDownRequestObject(this.downRequestTemplate);
                    liquid = this.$.getRelations;
                    liquid.useDataCoalesce = this.applyContextCoalesce;
                    this._oneTimeEvent(liquid, 'response', this.onResponseGetByIdData.bind(this));
                } else if (this.loadGovernData) {
                    this.description = this.data.label;
                    this.request = this.generateUpRequestObject(this.upRequestTemplate,this.data.relationshipType);
                    liquid = this.$.parentRelationsGet;
                    liquid.useDataCoalesce = this.applyContextCoalesce;
                    this._oneTimeEvent(liquid, 'response', this.onResponseSearchData.bind(this));
                }
                if(liquid) {
                    liquid.generateRequest();
                }
            },
            getSummaryItemColor: function(arg){
                if(arg){
                    return "relationships-summary__item " + this.color
                }else{
                    return "relationships-summary__item-value " + this.color
                }
                
            },
            generateDownRequestObject: function (template) {
                var request = DataHelper.cloneObject(template);
                request.params.query.id = this.entity.id;
                request.params.query.filters.typesCriterion = [this.entity.type];
                request.params.fields.relationships = [this.data.relatedEntityTypes[0].id];
                var firstDataContext = this.getFirstDataContext();
                request.params.query.contexts = [firstDataContext];
                return request;
            },

            generateUpRequestObject: function (template,relationshipType) {
                var request = DataHelper.cloneObject(template);
                request.params.query.filters.typesCriterion = this.data.entityType;
                var relationshipTypeObject = {};
                relationshipTypeObject[relationshipType] = {
                    "relTo": {
                        "id": this.entity.id,
                        "type": this.entity.type
                    }
                };
                request.params.query.filters.relationshipsCriterion.push(relationshipTypeObject)
                request.params.fields.relationships = this.data.entityType;
                var firstDataContext = this.getFirstDataContext();
                if(firstDataContext){
                    request.params.query.contexts = [firstDataContext];
                }
                return request;
            },

            onResponseGetByIdData: function (e) {
                if (e.detail && e.detail.response) {
                    var response = e.detail.response;
                    if (response && response.content) {
                        var countOfRelations = 0;
                        if (e.detail.response.content.entities &&
                            e.detail.response.content.entities[0] &&
                            e.detail.response.content.entities[0].data) {
                            var currentItemData = e.detail.response.content.entities[0].data;
                            var relationshipData = {};
                            if (currentItemData.contexts && currentItemData.contexts.length > 0) {
                                relationshipData = currentItemData.contexts[0].relationships;
                            } else {
                                relationshipData = currentItemData.relationships;
                            }
                            if (relationshipData &&
                                relationshipData[this.data.relationshipTypeName]) {
                                countOfRelations = relationshipData[this.data.relationshipTypeName].length;
                            }
                        }
                        this.value = countOfRelations;
                        this._loading = false;
                    }
                }
            },

            onResponseSearchData: function (e) {
                this.value = 0;
                if (e.detail && e.detail.response) {
                    var response = e.detail.response;
                    if (response && response.content) {
                        this.value = response.content.totalRecords || 0;
                    }
                }
                this._loading = false;
            },

            _oneTimeEvent: function (element, type, callback) {
                element.addEventListener(type, function (e) {
                    e.target.removeEventListener(e.type, arguments.callee);
                    return callback(e);
                });
            },

            _onError: function (e) {
                this.showErrorToast(e.detail.response.reason);
            }
        });
    </script>
</dom-module>
