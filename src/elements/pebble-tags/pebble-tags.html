<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-tag-item/pebble-tag-item.html">

<!--
`pebble-tags` Represents a group of tag items which together can form a selection.

### Example

        <template>
          <pebble-tags id="exPebbleTags" disable-delete is-non-editable></pebble-tags>
          <script>

            var data = [
                {
                  "name": "Brand",
                  "value":"Levis",
                  "icon":"settings"
                },
                {
                  "name": "Color",
                  "value": "Red",
                }
              ];

            window.addEventListener('WebComponentsReady', function(e) {
              Polymer.dom(document).querySelector("#exPebbleTags").tags = data;
            });
            
          </script>
        </template>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--tag-item-container` | Mixin applied to tag container | {}
`--tag-name` | Mixin applied to tag display name | {}
`--tag-value` | Mixin applied to tag display value | {}
`--expand-more-icon-styles` | Mixin applied to expand icon | {}
`--close-icon-styles` | Mixin applied to close icon | {}
`--expand-icon-section` | Mixin applied to expand section | {}
`--close-icon-section` | Mixin applied to close section | {}

@group Pebble Elements
@element pebble-tags
@demo demo/index.html
-->
<dom-module id="pebble-tags">
  <template>
    <style include="pebble-styles-shared"></style>    
    <style>
       :host {
        display: inline-flex;
        display: -webkit-inline-flex;        
      }
      
      .clearfix:after {
        content: " ";
        display: block;
        height: 0;
        clear: both;
      }

      .more-values-message {
        display:inline-block;        
        height: 25px;
        padding-top: 8px;
        font-size: 12px;
        color: blue;
        cursor: pointer;
      }

      pebble-tag-item {
        --tag-container: {
            padding-right: 5px;
            padding-left: 5px;
            @apply(--tag-item-container);
        }

        @apply(--tag-name);
        @apply(--tag-value);
        @apply(--expand-icon-section);
        @apply(--expand-more-icon-styles);
        @apply(--close-icon-section);
        @apply(--close-icon-styles);
      }
      
    </style>
    <div>
      <template is="dom-repeat" items="{{tags}}" >
        <template is="dom-if" if="[[_showItem(index, displayLimit)]]">
            <pebble-tag-item  id$="tag[[index]]" 
                              index="{{index}}"
                              name$="{{item.name}}" 
                              long-name="{{item.longName}}" 
                              value="{{item.value}}"
                              display-params="{{item.displayParams}}"                               
                              icon="[[item.icon]]" 
                              src="[[item.src]]"
                              tag-color="[[item.color]]"
                              options="[[item.options]]"
                              show-icon="[[showIcon]]"
                              show-expand-icon="[[showExpandIcon]]"
                              show-remove-icon="[[showRemoveIcon]]">
            </pebble-tag-item>
        </template>
      </template>
      <span class="more-values-message" hidden$="[[!_enableShowMore]]" on-tap="_onTapShowMore">[[_limitMessage]]</span>
      <bedrock-pubsub event-name="tag-item-remove" handler="_onTagItemRemove"></bedrock-pubsub>
      <bedrock-pubsub event-name="tag-item-tap" handler="_onTagItemTap"></bedrock-pubsub>
      <bedrock-pubsub event-name="tag-item-attached" handler="_onTagItemAttached"></bedrock-pubsub>
    </div>
  </template>
  <script>

  Polymer({

    is: 'pebble-tags',

    properties: {

      /**
       * Indicates the list of strings that holds the tags. Values in this array must be identical. Avoid duplicates due to the definition of tags. Icons for individual tag can also be passed in this list.
       */
      tags:{
        type:Array,
        notify: true,
        value:function(){return []}
      },
      /**
        * Specifies whether or not the deletion of a tag is allowed.
       */
      showIcon: {
        type: Boolean,
        value: false
      },
      /**
        * Specifies whether or not the deletion of a tag is allowed.
       */
      showRemoveIcon: {
        type: Boolean,
        value: false
      },
      
       /**
        * Specifies whether or not adding more tags is allowed.
       */
      showExpandIcon: {
        type: Boolean,
        value: false
      },
      /**
       *  Indicates the reference to the currently opened tag.
       */
      currentTag:{
          type:Object,
          notify:true
      },

      /**
       * Indicates how many tags should display initially
       * Default is 0 for no limit
       */
      displayLimit: {
        type: Number,
        value: 0
      },

      _enableShowMore: {
        type: Boolean,
        value: false
      },

      _limitMessage: {
        type: String,
        values: "more values..."
      }
    },
    behaviors: [
        RUFBehaviors.UIBehavior
    ],
    observers: [
       '_onTagsChange(tags.*)'
    ],
    // Element Behavior
    /**
     * Can be used to add a new tag to the list.
     *
     * @param {JSON} the tag that needs to be added.
     */
    addTag: function(tag){      
        if (typeof(this.tags) == 'undefined'){
          this.tags = [];
        }
        if (typeof tag != "object"){
          console.warn('bad tag object');
          return;
        }
        else {
          for(var i=0;i<this.tags.length;i++) {
            if(this.tags[i].name == tag.name) {
              console.warn(tag.name + ': tag alerady added');
              return;
            }
          }
        }

        this.push('tags', tag);
    },
    
    /**
     * Handler for 'tag-item-remove' event, which is fired when a <tag-item> is being removed.
     *
     * @param {Object} event object.
     */
    _onTagItemRemove: function(e, detail) {
         //Clear values before removing
         this.set('tags.' + detail.index + '.displayParams', []);
         this.set('tags.' + detail.index + '.value', {});         
         this.splice('tags', detail.index, 1);
         this.fireBedrockEvent('on-tap-tag-remove', detail, { ignoreId: true }); //Re-triggering from pebble-tag-item
    },
    _onTagItemTap:function (e, detail) {        
        this.fireBedrockEvent('on-tap-tag-item', detail, { ignoreId: true }); //Re-triggering from pebble-tag-item
    },
    _onTagItemAttached:function (e,detail) {
        this.fireBedrockEvent('on-attached-tag-item', detail, { ignoreId: true }); //Re-triggering from pebble-tag-item
    },

    _showItem: function(index){
      if(index < this.displayLimit || this.displayLimit == 0)
      {
        this._enableShowMore = false;
        return true;
      }
      
      this._enableShowMore = true;
      return false;      
    },

    _onTapShowMore: function() {
      this._enableShowMore = false;
      this.displayLimit = 0;
    },

    _onTagsChange: function() {
      if(this.displayLimit != 0 && this.displayLimit < this.tags.length)
      {      
        this._limitMessage = this.tags.length - this.displayLimit + " more values...";
      }
      else
      {
        this._limitMessage = "";
      }
    }

  });

</script>
</dom-module>
