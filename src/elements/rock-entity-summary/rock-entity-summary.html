<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../rock-widget-panel/rock-widget-panel.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">


<!--
`<rock-entity-summary>` Represents an element that renders the widgets 
such as "to-do" and "to-fix" for an entity.

### Example

    <template is="dom-bind" id="demo-app">				
				<rock-entity-summary config="{{config}}"></rock-entity-summary>
		</template>

@group rock Elements
@element rock-entity-summary
@demo demo/index.html
-->

<dom-module id="rock-entity-summary">
  <template>
    <style include="bedrock-style-common">
      .grid-stack-item[data-gs-height="4"] {
        height: 320px!important;
      }
      
      /*tmp workaround for gridstack (it doesn't set the height for tab-content rendered from the cache)*/
      rock-widget-panel {
        --stack-item-height: 320px;
      }
    </style>
    <style include="bedrock-style-common"></style>
    <rock-widget-panel config="{{config}}" readonly$="[[readonly]]" no-of-columns="" context-data="[[contextData]]"></rock-widget-panel>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rock-entity-summary',
        properties: {
          /**
           * Specifies the widget-panel config used for the "summary" dashboard.
           */
          config: {
            type: Object,
            value: function () {
              return {};
            }
          },
          /**
           * If set as true , it indicates the component is in read only mode
           */
          readonly: {
              type: Boolean,
              value: false		
          },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
          contextData: {
            type: Object,
            value: function () {
              return {};
            },
            observer: "_onContextDataChange"
          }
        },

        behaviors: [
          RUFBehaviors.ComponentContextBehavior,
          RUFBehaviors.ComponentConfigBehavior
        ],

        _onContextDataChange: function() {
          if(!_.isEmpty(this.contextData)) {
            var context = DataHelper.cloneObject(this.contextData);            

            //App specific
            var appName = ComponentHelper.getCurrentActiveAppName();
            if(appName) {
              context[ContextHelper.CONTEXT_TYPE_APP] = [{
                "app": appName
              }];
            }
            
            this.requestConfig('rock-entity-summary', context);
          }
        },

        onConfigLoaded: function(componentConfig) {
          if(componentConfig && componentConfig.config) {
            var config = componentConfig.config;
            if(!_.isEmpty(config.widgets)) {
              config.widgets = DataHelper.convertObjectToArray(config.widgets);
              for(var i = 0; i < config.widgets.length; i++) {
                var widget = config.widgets[i];
                if(widget.config && widget.config.iconButtons) {
                  widget.config.iconButtons = DataHelper.convertObjectToArray(widget.config.iconButtons);
                }
              }

              this.config = config;
            }
          }
        },

        refresh: function () {
          var rockWidgetPanel = this.$$("rock-widget-panel");
          rockWidgetPanel.refresh();
        },

        getControlIsDirty: function () {
          var rockWidgetPanel = this.$$("rock-widget-panel");
          if (rockWidgetPanel && rockWidgetPanel.getControlIsDirty) {
            return rockWidgetPanel.getControlIsDirty();
          }
        }
      });
    })();
  </script>
</dom-module>