<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="entity-type-model-datasource.html">

<!--
`rock-attribute-model-datasource` component is used to render model entities in refine more
-->

<dom-module id="rock-entity-type-model-lov">
    <template>
        <entity-type-model-datasource id="attributeModelDataSource" request="[[requestData]]"  data-formatter="{{_dataFormatter}}">
        </entity-type-model-datasource>
        <pebble-lov id="entityTypeModelLov" page-size="[[pageSize]]" multi-select show-image="[[showImage]]" show-color="[[showColor]]"
            no-sub-title="[[noSubTitle]]" show-action-buttons="[[showActionButtons]]"  items="[[items]]" selected-items="{{selectedItems}}">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-type-model-lov',
            properties: {
                selectedItems:{
                    type:Array,
                    value:function () {
                        return [];
                    },
                observer:'_onSelectedItemsChange'
                },
                multiSelect:{
                    type:Boolean,
                    value:true
                },
                contextData:{
                    type:Object,
                    value:function () {
                        return {};
                    },
                    observer:"_getAttributeModels"
                },
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                domains: {
                    type: Array,
                    value: function() {
                        return ["thing"];
                    }
                },
                _lovColumnNameValueCollection: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },                
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _itemContexts:{
                    type:Array,
                    value: function () {
                        return [];
                    }
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior,
                RUFBehaviors.AppContextBehavior
            ],


            ready: function () {
                this._dataFormatter = this._getAttributeFormattedData.bind(this);
                this._prepareAttributeMaps();
                if (this.verbose) {
                    console.log("Request Object for the Element: " + this.id + "is" + JSON.stringify(this.requestData));
                }
            },
            _onSelectedItemsChange:function () {
                alert(this.selectedItems.length);            
            },
            
            _defaultEntityTypes:function () {
                var contextData = this.contextData;
                if(contextData.ItemContexts){
                this._itemContexts = contextData.ItemContexts.map( function(item){
                    return item.type;
                })
                }
            },
            reTriggerRequest: function() {
                this.$$('#attributeModelDataSource').reTriggerRequest();
            },
            
            _prepareAttributeMaps: function () {
                this._lovColumnNameValueCollection.id = this.idField;
                this._lovColumnNameValueCollection.title = this.titlePattern;
                this._lovColumnNameValueCollection.subtitle = this.subTitlePattern;
                this._lovColumnNameValueCollection.image = this.imageField;
                this._lovColumnNameValueCollection.color = this.colorField;
                this._lovColumnNameValueCollection.value = this.valueField;
            },

            _getAttributeModels:function () {
                var contextData = DataHelper.cloneObject(this.contextData);

                if(_.isEmpty(contextData)){
                        return;
                }
                 contextData[this.CONTEXT_TYPE_ITEM]=[{"type":"entityType"}]; 
                 contextData[this.CONTEXT_TYPE_VALUE]=[]; 
                 contextData[this.CONTEXT_TYPE_DATA]=[]; 
                var req = DataRequestHelper.createEntityGetRequest(contextData); 
                delete req.params.options.totalRecords;
                    this.set('requestData',req)
                this._defaultEntityTypes();
            },

            _getAttributeFormattedData: function (data) {
                var test = this._selectedItems;
                var entityModels = data.content.entityModels;
                var _itemContexts = this._itemContexts;
                var filteredEntityTypes = [];
                var selectedEntityTypes = [];
                var defaultEntityTypes = DataHelper.cloneObject(this.selectedItems)
                for(var i=0; i<entityModels.length;i++) {
                    var entityModel = entityModels[i];
                    if(entityModel.domain && this.domains.indexOf(entityModel.domain) > -1 
                        && filteredEntityTypes.indexOf(entityModel.name) == -1) {
                            if(_itemContexts.indexOf(entityModel.name) > -1){
                                selectedEntityTypes.push({
                                    "title":entityModel.name,
                                    "id":entityModel.id
                                })   
                            }
                            filteredEntityTypes.push({
                                "title":entityModel.name,
                                "id":entityModel.id
                            });
                            
                            
                        }
                }
                this.items = filteredEntityTypes;
                this.selectedItems = selectedEntityTypes;
                
            },

        });
    </script>
</dom-module>