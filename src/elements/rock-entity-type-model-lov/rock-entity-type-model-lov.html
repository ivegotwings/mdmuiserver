<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<!--
`<rock-entity-type-model-lov></rock-entity-type-model-lov>` component is used to render model entities in entity-type 
-->

<dom-module id="rock-entity-type-model-lov">
    <template>
        <liquid-entity-model-get id="initGetEntities" operation="initiatesearch" request-data="{{requestData}}" last-response="{{_initGetEntitySearchResponse}}"
            on-error="_onError" on-response="_onInitResponse" exclude-in-progress>
        </liquid-entity-model-get>
        <liquid-entity-model-get id="getEntitiesSearchResults" operation="getsearchresultdetail" request-data="{{requestData}}" request-id="[[_initGetEntitySearchResponse.content.requestId]]"
            on-response="_onGetResponse" on-error="_onError" exclude-in-progress>
        </liquid-entity-model-get>

        <pebble-lov id="entityTypeModelLov" page-size="[[pageSize]]" multi-select="{{multiSelect}}" show-image="[[showImage]]" show-color="[[showColor]]"
            no-sub-title show-action-buttons="[[showActionButtons]]" items="[[items]]" selected-item="{{selectedItem}}" selected-items="{{selectedItems}}">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-type-model-lov',
            properties: {
                selectedItems: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                    observer: '_onSelectedItemsChange'
                },
                selectedItem: {
                    type: String,
                    value: function () {
                        return [];
                    }
                },
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                domains: {
                    type: Array,
                    value: function () {
                        return ["thing"];
                    }
                },
                multiSelect: {
                    type: Boolean,
                    value: true
                },
                preselectedEntityTypes: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                    observer: '_setSelectedEntityTypes'
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],
            listeners: {
                'entityTypeModelLov.selection-changed': '_onSelectedItemChange'
            },
            ready: function () {
                this._getEntityTypeModels();
            },
            _onInitResponse: function _generateSearchRequest() {
                this.$$('#getEntitiesSearchResults').generateRequest();
            },

            _onGetResponse: function _onGetResponse(e) {
                var response = event.detail.response;
                if (response.status === "success") {
                    this._getEntityTypeFormattedData(response);
                }
            },
            _onError: function _onError() {
                this.items = [];
                //this.$$("#entityTypeModelLov").stopLoading();
            },
            _onSelectedItemsChange: function () {

                if (this.selectedItems && this.selectedItems.length > 0) {
                    var eventDetail = {
                        data: this.selectedItems
                    };
                    this.fireBedrockEvent("entity-type-selection-changed", eventDetail);
                }
            },
            _onSelectedItemChange: function () {

                if (!_.isEmpty(this.selectedItem)) {
                    var eventDetail = {
                        data: this.selectedItem
                    };
                    this.fireBedrockEvent("entity-type-selection-changed", eventDetail);
                }
            },

            _getEntityTypeModels: function () {
                var contextData = {};
                var itemContext = {
                    "type": "entityType"
                };

                if (this.domains && this.domains.length) {
                    itemContext.domain = this.domains[0];
                }

                contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
                contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
                var req = DataRequestHelper.createEntityGetRequest(contextData);
                delete req.params.options.MaxRecords;
                this.set('requestData', req);
                this.$$('#initGetEntities').generateRequest();
                //this.$$("#entityTypeModelLov").startLoading();
            },

            _getEntityTypeFormattedData: function (data) {
                var entityModels = data.content.entityModels;
                var filteredEntityTypes = [];
                for (var i = 0; i < entityModels.length; i++) {
                    var entityModel = entityModels[i];
                    if (!this._isItemPresent(filteredEntityTypes, entityModel.name)) {
                        filteredEntityTypes.push({
                            "title": entityModel.name,
                            "id": entityModel.name
                        });
                    }
                }
                this.items = filteredEntityTypes;
                //this.$$("#entityTypeModelLov").stopLoading();
            },

            _isItemPresent: function (items, id) {
                var presentItem = items.find(function (item) {
                    return item.id == id;
                });
                return !!presentItem;
            },
            _setSelectedEntityTypes: function () {
                var _entityTypes = this.preselectedEntityTypes;
                for (var i in _entityTypes) {
                    var itemObj = {
                        "title": _entityTypes[i],
                        "id": _entityTypes[i]
                    };
                    if (!this._isItemPresent(this.selectedItems, _entityTypes[i])) {
                        this.push('selectedItems', itemObj);
                    }
                }
            }

        });
    </script>
</dom-module>