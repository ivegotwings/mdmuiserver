<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">

<link rel="import" href="../pebble-lov/pebble-lov.html">


<link rel="import" href="entity-type-model-datasource.html">

<!--
`<rock-entity-type-model-lov> Represents a component that renders the model entities in the entity type. 
@demo demo/index.html
-->     

<dom-module id="rock-entity-type-model-lov">
    <template>
        <attribute-model-datasource id="entityModelDataSource" mode="all" request="[[requestData]]" r-data-source="{{rDataSource}}" r-data-formatter="{{_dataFormatter}}"
            keywords-criterion-builder="{{_keywordsCriterionBuilder}}" schema="lov"  sort-criterion-builder="{{_sortCriterionBuilder}}">
        </attribute-model-datasource>

        <pebble-lov id="entityTypeModelLov" select-all="[[selectAll]]" page-size="[[pageSize]]" multi-select="{{multiSelect}}" show-image="[[showImage]]" show-color="[[showColor]]"
            no-sub-title show-action-buttons="[[showActionButtons]]" r-data-source="{{rDataSource}}" items="[[items]]" selected-item="{{selectedItem}}"
            selected-items="{{selectedItems}}" on-selection-changed="_onSelectedItemChange" on-lov-confirm-button-tap="_onLovConfirmButtonTapped" on-lov-close-button-tap="_onLovCloseButtonTapped">
        </pebble-lov>
    </template>
    <script>
        Polymer({
            is: 'rock-entity-type-model-lov',
            properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                selectedItems: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                selectedItem: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
                rDataSource: {
                    type: Object,
                    value: function () {
                        return {}
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                requestData: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                domain: {
                    type: String,
                    value:"thing",
                    observer: "_domainsChanged"
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                multiSelect: {
                    type: Boolean,
                    value: true,
                    computed: '_getMultiSelect(settings)'
                },
               
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                allowedEntityTypes: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _dataFormatter: {
                        notify: true,
                        value: function () {
                            return this._getEntityTypeFormattedData.bind(this);
                        }
                    },
                _keywordsCriterionBuilder: {
                        notify: true,
                        value: function () {
                            return this._prepareKeywordsCriteria.bind(this);
                        }
                    },
                selectAll: {
                    type: Boolean,
                    value: false
                },
                pageSize: {
                    type: Number,
                    value: 100  
                },
                sortField : {
                    type: String,
                    value: ""
                },
                _sortCriterionBuilder: {
                    type: Object,
                    value: function () {
                        return this._getSortCriterion.bind(this);
                    }
                },
                settings: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.LovBehavior
            ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        
            _domainsChanged: function () {
                this._getEntityTypeModels();
                this.resetData();
            },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
            resetData: function () {
                var lov = this.shadowRoot.querySelector("#entityTypeModelLov");
                if (lov) {
                    lov.reset();
                }
            },
            _onInitResponse: function _generateSearchRequest() {
                this.shadowRoot.querySelector('#getEntitiesSearchResults').generateRequest();
            },

            _onError: function _onError() {
                this.items = [];
            },
            _onSelectedItemChange: function (e) {
                this.set("selectedItem",e.detail.item);
                if (!_.isEmpty(this.selectedItem)) {
                    var eventDetail = {
                        data: this.selectedItem
                    };
                    this.fireBedrockEvent("entity-type-selection-changed", eventDetail);
                }
            },
            _getSortCriterion:function(){
                if(this.sortField){
                    var sortObj = {"sortType": "_STRING"}
                    sortObj[this.sortField] = "_ASC";
                    return {
                        "properties": [sortObj]
                    }
                }
                return undefined;
            },
            _getEntityTypeModels: function () {
                var contextData = {};
                var itemContext = {
                    "type": "entityType"
                };

                if (this.domain ) {
                    itemContext.domain = this.domain;
                }
                contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
                contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
                var req = DataRequestHelper.createEntityGetRequest(contextData);
                delete req.params.options.maxRecords;
                req.params.sort = {
                    "properties": [{
                        "externalName": "_ASC",
                        "sortType": "_STRING"
                    }]
                };
                if(req.params.fields.attributes && req.params.fields.attributes.length > 0){
                    req.params.fields.attributes.push("externalName")
                }else{
                    req.params.fields.attributes = ["externalName"];
                }

                this.set('requestData', req);
            },

            _getEntityTypeFormattedData: function (data) {
                var entityModels = data.content.entityModels;
                var filteredEntityTypes = [];
                if (this.allowedEntityTypes && this.allowedEntityTypes.length) {
                    for (var i = 0; i < entityModels.length; i++) {
                        var entityModel = entityModels[i];
                        if (this._isEntityTypePresent(this.allowedEntityTypes, entityModel.name)) {
                            if (!this._isItemPresent(filteredEntityTypes, entityModel.name)) {
                                filteredEntityTypes.push({
                                    "title": entityModel.properties && entityModel.properties.externalName ?
                                        entityModel.properties.externalName : entityModel.name,
                                    "id": entityModel.name
                                });
                            }
                        }
                    }
                } else {
                    for (var i = 0; i < entityModels.length; i++) {
                        var entityModel = entityModels[i];
                        if (!this._isItemPresent(filteredEntityTypes, entityModel.name)) {
                            filteredEntityTypes.push({
                                "title": entityModel.properties && entityModel.properties.externalName ?
                                    entityModel.properties.externalName : entityModel.name,
                                "id": entityModel.name
                            });
                        }
                    }
                }
                return filteredEntityTypes;
            },

            _isItemPresent: function (items, id) {
                var presentItem = items.find(function (item) {
                    return item.id == id;
                });
                return !!presentItem;
            },
            _isEntityTypePresent: function (items, id) {
                var presentItem = items.find(function (item) {
                    return item == id;
                });
                return !!presentItem;
            },
            _prepareKeywordsCriteria: function (searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = "*" + searchText + "*";
                    keywordsCriterion.operator = "_AND";
                    return keywordsCriterion;
                }
            },
             _onLovConfirmButtonTapped: function (event) {
                var eventDetail ={name: "entity-type-model-lov-confirm-button-tap"}
                if (this.selectedItems.length > 0) {
                    eventDetail["data"] = this.selectedItems;                        
                }
               /*else{
                     var lov = this.shadowRoot.querySelector("#entityTypeModelLov");
                      eventDetail["data"] = lov.items;
                }*/                
                this.fireBedrockEvent(eventDetail.name, eventDetail);
            },
            _onLovCloseButtonTapped: function (event) {
                var eventDetail = {
                    data: this.id,
                    name: "entity-type-model-lov-close-button-tap"
                }
                this.fireBedrockEvent(eventDetail.name, eventDetail);
            },
            _getMultiSelect: function (settings) {
                if(settings){
                    return settings.multiSelect;
                }
                return true;
            }   
        });
        
    </script>
</dom-module>