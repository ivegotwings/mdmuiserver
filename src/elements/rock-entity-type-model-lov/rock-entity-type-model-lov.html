<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">
<link rel="import" href="../bedrock-lov-behavior/bedrock-lov-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../rock-grid-data-sources/attribute-model-datasource.html">
<link rel="import" href="../pebble-lov/pebble-lov.html">
<link rel="import" href="entity-type-model-datasource.html">

<!--
`<rock-entity-type-model-lov> Represents a component that renders the model entities in the entity type. 
@demo demo/index.html
-->

<dom-module id="rock-entity-type-model-lov">
    <template>
        <attribute-model-datasource id="entityModelDataSource" mode="all" request="[[requestData]]" r-data-source="{{rDataSource}}"
            r-data-formatter="{{_dataFormatter}}" keywords-criterion-builder="{{_keywordsCriterionBuilder}}" schema="lov" sort-criterion-builder="{{_sortCriterionBuilder}}">
        </attribute-model-datasource>

        <pebble-lov id="entityTypeModelLov" select-all="[[selectAll]]" page-size="[[pageSize]]" multi-select="{{multiSelect}}" show-image="[[showImage]]"
            show-color="[[showColor]]" no-sub-title show-action-buttons="[[showActionButtons]]" r-data-source="{{rDataSource}}"
            items="[[items]]" selected-item="{{selectedItem}}" selected-items="{{selectedItems}}" on-selection-changed="_onSelectedItemChange"
            on-lov-confirm-button-tap="_onLovConfirmButtonTapped" on-lov-close-button-tap="_onLovCloseButtonTapped">
        </pebble-lov>
    </template>
    <script>
        class RockEntityTypeModelLov extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, 
        RUFBehaviors.LovBehavior], Polymer.Element) {
            static get is() {
                return "rock-entity-type-model-lov";
            }

            static get properties() {
                return {
                    selectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                    },

                    selectedItem: {
                        type: Object,
                        value: function () {
                            return {}
                        }
                    },

                    rDataSource: {
                        type: Object,
                        value: function () {
                            return {}
                        }
                    },

                    requestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    domain: {
                        type: String,
                        value: "thing",
                        observer: "_domainsChanged"
                    },

                    multiSelect: {
                        type: Boolean,
                        value: false,
                        computed: '_getMultiSelect(settings)'
                    },

                    allowedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _dataFormatter: {
                        notify: true,
                        value: function () {
                            return this._getEntityTypeFormattedData.bind(this);
                        }
                    },

                    _keywordsCriterionBuilder: {
                        notify: true,
                        value: function () {
                            return this._prepareKeywordsCriteria.bind(this);
                        }
                    },

                    selectAll: {
                        type: Boolean,
                        value: false
                    },

                    pageSize: {
                        type: Number,
                        value: 100
                    },

                    sortField: {
                        type: String,
                        value: ""
                    },

                    _sortCriterionBuilder: {
                        type: Object,
                        value: function () {
                            return this._getSortCriterion.bind(this);
                        }
                    },

                    settings: {
                        type: Object
                    }
                };
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
            }

            disconnectedCallback() {
                super.disconnectedCallback();
            }

            _domainsChanged() {
                this._getEntityTypeModels();
                this.resetData();
            }

            resetData() {
                var lov = this.shadowRoot.querySelector("#entityTypeModelLov");
                if (lov) {
                    lov.reset();
                }
            }

            _onInitResponse() {
                this.shadowRoot.querySelector('#getEntitiesSearchResults').generateRequest();
            }

            _onError() {
                this.items = [];
            }

            _onSelectedItemChange(e) {
                this.set("selectedItem", e.detail.item);
                if (!_.isEmpty(this.selectedItem)) {
                    var eventDetail = {
                        data: this.selectedItem
                    };
                    //PUBSUB is handled only in reference discovery
                    this.fireBedrockEvent("entity-type-selection-changed", eventDetail);
                }
            }

            _getSortCriterion() {
                if (this.sortField) {
                    var sortObj = { "sortType": "_STRING" }
                    sortObj[this.sortField] = "_ASC";
                    return {
                        "properties": [sortObj]
                    }
                }
                return undefined;
            }

            _getEntityTypeModels() {
                var contextData = {};
                var itemContext = {
                    "type": "entityType"
                };

                if (this.domain) {
                    itemContext.domain = this.domain;
                }
                contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
                contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
                var req = DataRequestHelper.createEntityGetRequest(contextData);
                delete req.params.options.maxRecords;
                req.params.sort = {
                    "properties": [{
                        "externalName": "_ASC",
                        "sortType": "_STRING"
                    }]
                };
                if (req.params.fields.attributes && req.params.fields.attributes.length > 0) {
                    req.params.fields.attributes.push("externalName")
                } else {
                    req.params.fields.attributes = ["externalName"];
                }

                this.set('requestData', req);
            }

            _getEntityTypeFormattedData(data) {
                var entityModels = data.content.entityModels;
                if (_.isEmpty(entityModels)) {
                    this.logError("rock-entity-type-model-lov - entity type models are empty", data);
                }
                var filteredEntityTypes = [];
                if (this.allowedEntityTypes && this.allowedEntityTypes.length) {
                    for (var i = 0; i < entityModels.length; i++) {
                        var entityModel = entityModels[i];
                        if (this._isEntityTypePresent(this.allowedEntityTypes, entityModel.name)) {
                            if (!this._isItemPresent(filteredEntityTypes, entityModel.name)) {
                                filteredEntityTypes.push({
                                    "title": entityModel.properties && entityModel.properties.externalName ?
                                        entityModel.properties.externalName : entityModel.name,
                                    "id": entityModel.name
                                });
                            }
                        }
                    }
                } else {
                    for (var i = 0; i < entityModels.length; i++) {
                        var entityModel = entityModels[i];
                        if (!this._isItemPresent(filteredEntityTypes, entityModel.name)) {
                            filteredEntityTypes.push({
                                "title": entityModel.properties && entityModel.properties.externalName ?
                                    entityModel.properties.externalName : entityModel.name,
                                "id": entityModel.name
                            });
                        }
                    }
                }
                var typesCriterion = this.__dataHost._typesCriterion;
                if (_.isEmpty(typesCriterion) && _.isEmpty(this.selectedItem)) {
                    var eventDetail = {
                        detail: {
                            item: filteredEntityTypes[0]
                        }
                    };
                    this._onSelectedItemChange(eventDetail);
                }
                return filteredEntityTypes;
            }

            _isItemPresent(items, id) {
                var presentItem = items.find(function (item) {
                    return item.id == id;
                });
                return !!presentItem;
            }

            _isEntityTypePresent(items, id) {
                var presentItem = items.find(function (item) {
                    return item == id;
                });
                return !!presentItem;
            }

            _prepareKeywordsCriteria(searchText) {
                if (searchText) {
                    var keywordsCriterion = {};

                    keywordsCriterion.keywords = "*" + searchText + "*";
                    keywordsCriterion.operator = "_AND";
                    return keywordsCriterion;
                }
            }

            _onLovConfirmButtonTapped(event) {
                var eventDetail = { name: "entity-type-model-lov-confirm-button-tap" }
                if (this.multiSelect) {
                    if (this.selectedItems.length > 0) {
                        eventDetail["data"] = this.selectedItems;
                    }
                }
                else {
                    if (!_.isEmpty(this.selectedItem)) {
                        eventDetail["data"] = this.selectedItem;
                    }
                }
                /*else{
                      var lov = this.shadowRoot.querySelector("#entityTypeModelLov");
                       eventDetail["data"] = lov.items;
                 }*/
                this.fireBedrockEvent(eventDetail.name, eventDetail);
            }

            _onLovCloseButtonTapped(event) {
                var eventDetail = {
                    data: this.id,
                    name: "entity-type-model-lov-close-button-tap"
                }
                this.fireBedrockEvent(eventDetail.name, eventDetail);
            }

            _getMultiSelect(settings) {
                if (settings) {
                    if (!_.isEmpty(settings)) {
                        return settings.multiSelect;
                    }
                    return true;
                }
            }
        }

        customElements.define(RockEntityTypeModelLov.is, RockEntityTypeModelLov);
    </script>
</dom-module>