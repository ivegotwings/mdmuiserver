<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<!--
`<pebble-dialog>` Represents a dialog with material design styling and optional animations when it is
opened or closed. It provides styles for a header, content area, and an action area for buttons.

The following code implements a dialog with a header, scrolling content area, and
buttons. The focus is on the `dialog-confirm` button when the dialog is opened.

### Example
    <pebble-dialog>
      <h2>Header</h2>
        Lorem ipsum...
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </pebble-dialog>

### Styling

Custom property    | Description              | Default
-------------------|-------------|-------------
`--dialog-layout`  | Mixin applied to #dialog | `{}`


@group pebble Elements
@element pebble-dialog
@demo demo/index.html
-->

<dom-module id="pebble-dialog">
    <template>
        <style include="bedrock-style-common">
            #dialog {
                position: fixed;
                top: 5px !important;
                right: 0;
                left: 0!important;
                max-width: 80% !important;
                max-height: 100% !important;
                border-radius: 3px;
                box-shadow: 0 0 8px 0 rgba(0, 0, 0, 0.22);
                background-color: var(--popup-background-color, #ffffff);
                margin: 0 auto 30px auto !important;
                padding: 0 !important;
                overflow: hidden;
                width: 100%;
                z-index: 1003 !important;
                @apply --dialog-component;
            }

            .dialogTitle {
                position: relative;
                color: var(--popup-header-text-color, #ffffff);
                background-color: var(--popup-header-color, #036bc3);
                font-family: var(--default-font-family);
                height: 40px;
                font-size: var(--default-font-size, 14px) !important;
                margin: 0!important;
                padding: 0 20px!important;
                line-height: 3.1!important;
                text-align: left;                
            }

            #closeIcon {
                position: absolute;
                right: 15px;
                top: -2px;
                cursor: pointer;
            }

            .dialogContent {
                padding: 10px 20px 20px!important;
                margin: 0!important;
            }                

            .buttons {
                padding: 0!important;
                margin-top: 10px!important;
                margin-bottom: 10px!important;
                text-align: center;
                display: block!important;
            }

            :host(.opened) {
                opacity: 0.4;
            }

            :host([alert-box]) #dialog {
                text-align: center;
                top: 20%!important;
                max-width: 400px !important;
            }

            :host([small]) #dialog {
                max-width: 40% !important;
            }            

            :host([medium]) #dialog {
                max-width: 60% !important;
            }

            :host([large]) #dialog {
                max-width: 90%!important;
            }

            :host ::slotted(ul) {
                padding-left: 50px !important;
            }
        </style>
        <template is="dom-if" if="[[_isVisible]]">
            <paper-dialog id="dialog" opened on-iron-overlay-closed="_onDialogClose" role="alertdialog" position-target="[[positionTarget]]" horizontal-align="[[horizontalAlign]]"
                vertical-align="[[verticalAlign]]" dynamic-align="[[dynamicAlign]]" no-overlap="[[noOverlap]]" vertical-offset="[[verticalOffset]]"
                horizontal-offset="[[horizontalOffset]]" no-cancel-on-outside-click="[[noCancelOnOutsideClick]]" no-cancel-on-esc-key="[[noCancelOnEscKey]]">
                <h2 class="dialogTitle">[[dialogTitle]]
                    <!-- Close Dialog -->
                    <template is="dom-if" if="[[showCloseIcon]]">
                        <div id="closeIcon">
                            <pebble-icon id="close" name="close" icon="pebble-icon:window-action-close" title="Remove" on-tap="_close" title="Close" class="icon pebble-icon-color-white pebble-icon-size-12"
                                role="button" tabindex="0" aria-disabled="false"></pebble-icon>
                        </div>
                    </template>
                </h2>
                
                <div class="dialogContent">
                    <slot></slot>
                    <template is="dom-if" if="[[_showCancelok()]]">
                    <div class="buttons">
                        <!-- Cancel Button -->
                        <template is="dom-if" if="[[showCancel]]">
                            <pebble-button button-text="[[buttonCancelText]]" class="btn btn-secondary m-r-10" on-tap="_cancel" raised elevation="0"></pebble-button>
                        </template>
                        <!-- Ok Button -->
                        <template is="dom-if" if="[[showOk]]">
                            <pebble-button button-text="[[buttonOkText]]" class="btn btn-success" on-tap="_confirm" raised elevation="0"></pebble-button>
                        </template>
                    </div>
                </template>
                </div>
            </paper-dialog>
        </template>
    </template>
    <script>
        Polymer({
            is: "pebble-dialog",
            properties: {
                /** 
                * Indicates the dialog is open.
                */
                _isVisible: {
                    type: Boolean,
                    value: false
                },
                /** 
                * Indicates the title of the dialog.
                */
                dialogTitle: {
                    type: String,
                    value: 'Title'
                },

                /**
                  * Indicates whether or not the dialog is modal.
                  * If it is set to <b>true</b>, then this implies no-cancel-on-outside-click, no-cancel-on-esc-key, and with-backdrop.
                  */
                modal: {
                    type: Boolean
                },

                /**
                * Indicates the orientation against which the element are aligned horizontally relative to the positionTarget.
                * The possible values are left, right, and auto.
                */
                horizontalAlign: {
                    type: String
                },

                /**
                * Indicates the orientation against which the element are aligned vertically relative to the positionTarget.
                * The possible values are top, bottom, and auto.
                */
                verticalAlign: {
                    type: String
                },

                /**
                 * Indicates the alignment of dialog dynamically.
                 * If it is set to <b>true</b>, then it uses horizontalAlign and verticalAlign values as preferred alignment.
                 * If there is not enough space, then it picks the values which minimizes the cropping.
                 */
                dynamicAlign: {
                    type: Boolean,
                },


                /**
                * Indicates whether or not to position the element around the positionTarget without overlapping it.
                */
                noOverlap: {
                    type: Boolean
                },

                /**
                * Indicates the element that is used to position the dialog control. If it is not set, then it defaults to the parent node.
                */
                positionTarget: {
                    type: Element,
                    observer: '_positionTargetChanged'
                },

                /**
                * Indicates the vertical positioning. It is same as setting margin-top and margin-bottom css properties. 
                */
                verticalOffset: {
                    type: Number
                },

                /**
                * Indicates horizontal positioning. It is same as setting margin-left and margin-right css properties.
                */
                horizontalOffset: {
                    type: Number
                },
                /**
                * Indicates property to disable cancelling the overlay by clicking outside it.
                */
                noCancelOnOutsideClick: {
                    type: Boolean,
                    value: false
                },
                /**
                * Indicates property to disable cancelling the overlay with the ESC key.
                */
                noCancelOnEscKey: {
                    type: Boolean,
                    value: false
                },

                /* Specifies whether or not the dailog close button can be shown.
                 * If it is set to <b>true</b>, then the dialog close button is shown.
                 */
                showCloseIcon: {
                    type: Boolean,
                    value: false
                },
                /* Specifies whether or not the `Ok` button is displayed on dailog.
                 * If it is set to <b>true</b>, `Ok` button is displayed.
                 */
                showOk: {
                    type: Boolean,
                    value: false
                },
                /**
                * Indcates the `Ok` button text if `showOk` is set to true.
                */
                buttonOkText: {
                    type: String,
                    value: 'Yes'
                },
                /* Specifies whether or not the `Cancel` button is displayed on dailog.
                 * If it is set to <b>true</b>, `Cancel` button is displayed.
                 */
                showCancel: {
                    type: Boolean,
                    value: false
                },
                /**
                * Indcates the `Cancel` button text if `showCancel` is set to true.
                */
                buttonCancelText: {
                    type: String,
                    value: 'Cancel'
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                close: {
                    notify: true,
                    value: function () {
                        return this._close.bind(this);
                    }
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior
            ],
            /*
             * Can be used to open the overlay.
             */
            open: function () {
                this._isVisible = true;
                if (this.modal) {
                    this._createOverlay('bodyOverlay', 'fixed', '1002');
                }
                //this.$.dialog.open();
            },
            isVisible: function () {
                return this._isVisible;
            },
            _createOverlay: function (className, position, zIndex) {
                if(this.shadowRoot.querySelector(".bodyOverlay")) return;
                
                var tag = document.createElement('div');
                tag.className = className;
                tag.setAttribute('style', 'display:block;transition: opacity 0.2s;z-index:' + zIndex + ';opacity:.6;position:' + position + ';top:0px;left:0px;width:100%;height:100%;background-color:#000;');
                tag.setAttribute('onClick', 'if(event.stopPropagation){event.stopPropagation();}event.cancelBubble=true;')
                
                this.shadowRoot.appendChild(tag);
            },
            _removeOverlay: function () {
                ComponentHelper.removeNode(this.shadowRoot.querySelector(".bodyOverlay"));
            },
            get dialog() {
                this._dialog = this._dialog || this.shadowRoot.querySelector('#dialog');
                return this._dialog;
            },
            _close: function () {
                this._isVisible = false;
                if (this.modal) {
                    this._removeOverlay();
                }
                
                if(this.dialog) {
                    this.dialog.close();
                }
            },
            _confirm: function (event) {
                this._close();
                var eventDetail = event;
                this.fireBedrockEvent("on-buttonok-clicked", eventDetail);
            },
            _cancel: function (event) {
                this._close();
                var eventDetail = event;
                this.fireBedrockEvent("on-buttoncancel-clicked", eventDetail);
            },
            _positionTargetChanged: function () {
                this.dialog.style.margin = "0px";
            },
            getControlIsDirty: function () {
                return this._isVisible;
            },
            _showCancelok:function(){
               return this.showCancel || this.showOk;
            },
            _onDialogClose: function(event) {
                this.dispatchEvent(new CustomEvent('asset-popover-closed', {detail:event, bubbles:true,composed:true}));
            }
        });
    </script>
</dom-module>
