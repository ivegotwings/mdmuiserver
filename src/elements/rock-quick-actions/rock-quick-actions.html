<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<!--
@group rock Elements
@element rock-quick-actions
@demo demo/index.html
-->
<dom-module id="rock-quick-actions">
    <template>
        <style include="bedrock-style-common">
            pebble-actions {
                position: relative;
                display: inline-block;
                vertical-align: middle;
                --pebble-actions-button: {
                    height: 24px;
                    font-size: var(--default-font-size, 14px)!important;
                    top: 0px;
                    color: var(--palette-white, #fff);
                    background: transparent;
                    border: none;
                }

                --pebble-button: {
                    position: relative;
                    height: 24px;
                }

                --paper-button-focus-before: {
                    opacity: 1;
                    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=100)";
                }

                --paper-button-before: {
                    position: absolute;
                    content: "";
                    left: 0;
                    right: 0;
                    top: -11px;
                    bottom: -5px;
                    background-color: rgba(0, 0, 0, 0.2);
                    opacity: 0;
                    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
                    z-index: -1;
                }

            }
        </style>
        <template is="dom-if" if="[[visible]]">
            <pebble-actions id="quickActions" class="m-l-10 pebble-icon-color-white" button-icon="pebble-icon:action-quick-global" button-text="Quick Actions" actions-data="[[actionsData]]">
            </pebble-actions>
            <bedrock-pubsub event-name="pebble-actions-action-click" handler="_onActionItemTap"></bedrock-pubsub>
        </template>
    </template>
    <script>
        class RockQuickActions
            extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior, RUFBehaviors.ComponentContextBehavior, RUFBehaviors.ComponentConfigBehavior], Polymer.Element) {
            static get is() { return 'rock-quick-actions' }
            ready() {
                super.ready();
            }

            static get properties() {
                return {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },
                    actionsData: {
                        type: Array,
                        value: function () { return []; }
                    },
                    pageRoute: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    visible: {
                        type: Boolean,
                        value: true
                    }
                }
            }
            
            static get observers() {
                return []
            }

            /**
            *
            */
            connectedCallback() {
                super.connectedCallback();
            }

            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }

            _onContextDataChange() {
                if (!_.isEmpty(this.contextData)) {
                    var context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    var appName = ComponentHelper.getCurrentActiveAppName();
                    if (appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }

                    this.requestConfig('rock-quick-actions', context);
                }
            }

            onConfigLoaded(componentConfig) {
                if (componentConfig && componentConfig.config) {
                    var actionGroups = [];

                    if (componentConfig.config.actionGroups) {
                        var actionsData = DataHelper.convertObjectToArray(componentConfig.config.actionGroups);
                        for (var data in actionsData) {
                            if (actionsData[data].actions) {
                                actionsData[data].actions = DataHelper.convertObjectToArray(actionsData[data].actions);
                            }
                        }
                        this.actionsData = actionsData;
                        return;
                    }
                }
                this.visible = false;
            }

            _onActionItemTap(e, detail, sender) {
                if (detail && detail.data) {

                    //Want to open same path, then close the existing and reopen newly
                    if (this.pageRoute.path == ("/" + detail.data.dataRoute)) {
                        ComponentHelper.closeBusinessFunction();
                    }

                    var mainApp = RUFUtilities.mainApp;

                    var dataRoute = detail.data.dataRoute;
                    var contextData = detail.data.contextData;
                    var type = contextData && contextData.itemContext ? contextData.itemContext.type : '';
                    if (type) {
                        ComponentHelper.setQueryParamsWithoutEncode({ "type": type });
                    } else {
                        ComponentHelper.setQueryParamsWithoutEncode({}); //clear
                    }

                    mainApp.changePageRoutePath(dataRoute);
                }
            }

        }
        customElements.define(RockQuickActions.is, RockQuickActions);
    </script>
</dom-module>