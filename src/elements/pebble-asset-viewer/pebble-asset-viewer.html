<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-scroll-bar.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">

<dom-module id="pebble-asset-viewer">
    <template is="dom-if" if="[[assetUrl]]">
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            .asset-render{
                height: 80vh;
                position: relative;
                padding-top: 40px;
            }
            #viewerContainer {
                text-align: center;
            }
            .asset-render img{
                max-width: 100%;
            }
            .overflow{
                overflow-y: auto;
            }
            .video-extension-not-supported{
                position:absolute;
                left:40%;
                top:50%;
            }
            header{
                position: fixed;
                bottom: 10%;
                z-index: 1;
                left: 50%;
                transform: translateX(-50%);
            }
            header paper-fab{
                display: inline-block;
                background: #cbcbcb;
            }
            header div{
                display: inline-block;
            }
            .download{
                position: absolute;
                right: 0;
                top: 0;
                display: inline-block;
                font-weight: 400;
                line-height: 16px;
                padding: 5px 10px;
                height: 30px;
                text-align: center;
                border: 1px solid transparent;
                font-size: var(--default-font-size, 14px);
                border-radius: 3px;
                text-transform: capitalize;
                color: var(--button-text-color, #ffffff)!important;
                background-color: var(--success-button-color, #09c021);
                border-color: var(--success-button-color, #09c021);
                text-decoration: none;
            }
            video::-webkit-media-controls-fullscreen-button {
                display: none;
            }
        </style>
        <div id="viewerContainer" class$="[[_computeClass(assetType)]]">
            <pebble-spinner active="[[_loading]]"></pebble-spinner>
            <template is="dom-if" if="[[isImageView(assetType)]]">
                <template is="dom-if" if="[[!isPublicUrl]]">
                    <a href$="[[assetUrl]]" download class="download"><pebble-icon icon="pebble-icon:download-asset" class="download-icon pebble-icon-size-16 pebble-icon-color-white m-r-5"></pebble-icon> Download</a> 
                </template>
                <img class="modal-content" src$="[[assetUrl]]" id="bigImage" sizing="contain" onload="[[_onAssetLoad]]"/>
            </template>
            <template is="dom-if" if="[[isVideoView(assetType)]]">
                <template is="dom-if" if="[[assetError]]">
                    <div class="video-extension-not-supported">
                        <span>Video extension not supported. Click <a href$="[[assetUrl]]">here</a> to Download</span>                        
                    </div>      
                </template>
                <template is="dom-if" if="[[!assetError]]">
                    <video id="videoPlay" controls autoplay src$="[[assetUrl]]" height="100%" width="100%" oncanplay="[[_onAssetLoad]]" onerror="[[_onAssetError]]"></video>
                </template>
            </template>
            <template is="dom-if" if="[[isDocumentView(assetType)]]">
                <template is="dom-if" if="[[assetError]]">
                    <span>Document preview not available. Click <a href$="[[assetUrl]]">here</a> to Download</span>
                </template>
                <template is="dom-if" if="[[!assetError]]">
                    <a href$="[[assetUrl]]" class="download"><pebble-icon icon="pebble-icon:download-asset" class="download-icon"></pebble-icon> Download</a> 
                    <header>
                        <paper-fab mini icon="pebble-icon:action-scope-release-selection" action="previous" on-tap="_performDocumentAction"></paper-fab>
                        <div>[[documentPage]]/[[documentPages]]</div>
                        <paper-fab mini icon="pebble-icon:action-scope-take-selection" action="next" on-tap="_performDocumentAction"></paper-fab>
                    </header>
                </template>
            </template>
            <template is="dom-if" if="[[isAudioView(assetType)]]">
                    <audio id="audioPlay" controls autoplay src$="[[assetUrl]]" oncanplay="[[_onAssetLoad]]"></audio>
            </template>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "pebble-asset-viewer",

                properties: {
                    assetType:{
                        type: String
                    },
                    assetUrl: {
                        type: String,
                        value: ""
                    },
                    assetExtension:{
                        type: String
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    assetError: {
                        type: Boolean,
                        value: false
                    },
                    documentPage: {
                        type: Number,
                        value: 1
                    },
                    documentPages: {
                        type: Number,
                        notify: true
                    },
                    isPublicUrl:{
                        type: Boolean,
                        value: false
                    }
                },
                observers: ["_onAssetValuesChange(assetType, assetUrl, assetExtension)"],
                _onAssetLoad: function () {
                    var viewer = this.__dataHost.parentModel;
                    viewer.set("_loading" , false);
                },
                _onAssetError: function () {
                    var viewer = this.__dataHost.parentModel;
                    viewer.set("_loading" , false);
                    viewer.$.viewerContainer.classList.remove("asset-render");
                    viewer.set("assetError" , true);
                },
                isImageView: function (assetType) {
                    if(assetType == "image"){
                        this.set("_loading" , true);
                        return true;
                    }
                    return false;
                },
                isVideoView: function (assetType) {
                    if(assetType == "video"){
                        this.set("_loading" , true);
                        return true;
                    }
                    return false;
                },
                isDocumentView: function (assetType) {
                    if(assetType == "document"){
                        if(this.assetExtension != "pdf"){
                            this.set("assetError" , true);
                        }
                        return true;
                    }
                    return false;
                },
                isAudioView: function (assetType) {
                    if(assetType == "audio"){
                        return true;
                    }
                    return false;
                },
                _onAssetValuesChange:function(assetType, assetUrl, assetExtension){
                    if(assetType && assetUrl && assetExtension){
                        if(this.assetType == "document" && this.assetExtension == "pdf"){
                            if(!this.shadowRoot.querySelector("pdf-viewer")){
                                var link = this.importHref("../../../bower_components/pdf-viewer/pdf-viewer.html", function() {
                                    var dynamicEl = document.createElement("pdf-viewer");
                                    dynamicEl.setAttribute("id", "docViewer");
                                    dynamicEl.setAttribute("src", this.assetUrl);
                                    dynamicEl.setAttribute("page", this.documentPage);
                                    dynamicEl.setAttribute("mode", "single");
                                    dynamicEl.setAttribute("initial-zoom", "fit-width");
                                    Polymer.dom(this.$.viewerContainer).appendChild(dynamicEl);
                                });
                            }
                            
                        }
                    }
                },
                _computeClass: function (assetType) {
                    //compute class if no error is there
                    if(!this.assetError){
                        if(assetType == "image" || assetType == "video" || assetType == "document"){
                            return "asset-render overflow";
                        }
                    }
                    
                },
                _performDocumentAction: function (event) {
                    this._docViewer = this._docViewer || this.shadowRoot.querySelector("#docViewer");
                    var document = this._docViewer;
                    this.set("documentPage",document.page);
                    this.set("documentPages",document.pages);
                    var action = event.target.getAttribute("action")
                   
                    switch (action) {
                        case "previous":
                           document.previous();
                           break;
                        case "next":
                            document.next();
                            break;
                        case "full":
                            document.fitWidth();
                            break;
                        case "fit":
                            document.fit();
                            break;
                        case "zoomin":
                            document.zoomin();
                            break;
                        case "zoomout":
                            document.zoomout();
                            break;
                        default:
                            alert("No Action")
                           break;
                    }
                   
                   
                },
                onClose: function(){
                    if(this.assetType == "audio"){
                       var audio =  this.shadowRoot.querySelector("#audioPlay");
                       audio.pause();
                    }
                    else if(this.assetType == "video"){
                       var video =  this.shadowRoot.querySelector("#videoPlay");
                       video.pause();
                    }
                }
            });
        })();
    </script>
</dom-module>
