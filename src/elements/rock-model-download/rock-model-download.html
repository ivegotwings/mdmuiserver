<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-model-download">
    <template>
        <style include="bedrock-style-common">
        </style>
        <liquid-rest id="copDownloadService" url="/data/cop/downloadModelJob" method="POST" on-liquid-response="_onAsyncDownloadSuccess"
            on-liquid-error="_onAsyncDownloadFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-model-download",

                properties: {
                    /**
                     * <b><i>Content development is under progress... </b></i> 
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    enableAsyncDownload: {
                        type: Boolean,
                        value: true
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                onDownload: function (profile, filename, domain) {
                    var req = this._prepareRequest(profile, filename, domain);
                    if (req) {
                        if(this.enableAsyncDownload) {
                            var downloadLiq = this.shadowRoot.querySelector("#copDownloadService");
                            if (downloadLiq) {
                                downloadLiq.requestData = req;
                                downloadLiq.generateRequest();
                            }
                        } else {
                            var _this = this;
                            RUFUtilities.fileDownload("/data/cop/downloadModelExcel", {
                                httpMethod: 'POST',
                                data: {
                                    data: JSON.stringify(req)
                                },
                                fileName: filename,
                                successCallback: function (url) {
                                    this._onSyncDownloadSuccess();
                                }.bind(_this),
                                failCallback: function (responseHtml, url, error) {
                                    this._onSyncDownloadFailure(error);
                                }.bind(_this)
                            });
                        }
                    }
                },

                _prepareRequest: function (profile, filename, domain) {
                    if (!domain) {
                        domain = "";
                    }
                    var profiles = [];
                    profiles.push(profile);
                    var req = {
                        "params": {
                            "fields": {
                                "attributes": [
                                    "_ALL"
                                ]
                            },
                            "rsconnect": {
                                "domain": domain,
                                "includeValidationData": true,
                                "profiles": profiles
                            }
                        },
                        "fileName": filename
                    };

                    if(this.enableAsyncDownload) {
                        var user = "";
                        var userContext = ContextHelper.getFirstUserContext(this.contextData);
                        if (userContext) {
                            user = userContext.user;
                        }
                        req["clientState"] = {
                            "notificationInfo": {
                                "userId": user
                            }
                        }
                    }

                    return req;
                },

                _onSyncDownloadSuccess: function () {
                    this.fireBedrockEvent("onDownloadSuccess", "Success", {
                        ignoreId: true
                    });
                },

                _onSyncDownloadFailure: function (e) {
                    var response = "";
                    if (e && e.detail && e.detail.response) {
                        response = e.detail.response;
                    }
                    this._triggerErrorToast(response);
                },

                _onAsyncDownloadSuccess: function (e, detail) {
                    if (DataHelper.isValidObjectPath(detail, "response.dataObjectOperationResponse.dataObjects.0.properties.workAutomationId") &&
                        detail.response.dataObjectOperationResponse.status == "success") {
                        var eventDetails = {
                            "status": "success",
                            "workAutomationId": detail.response.dataObjectOperationResponse.dataObjects[0].properties.workAutomationId
                        }
                        this.fireBedrockEvent("onDownloadSuccess", eventDetails, {
                            ignoreId: true
                        });
                        return;
                    }
                    this._triggerErrorToast(detail);
                },

                _onAsyncDownloadFailure: function (e, detail) {
                    var response = "";
                    if (detail && detail.response) {
                        response = detail.response;
                    }
                    this._triggerErrorToast(response);
                },

                _triggerErrorToast: function (response) {
                    this.logWarning("UnexpectedCOP", "response", JSON.stringify(response));
                    this.showErrorToast(
                        "Unable to download the data model. Please check the service or contact your administrator."
                    );
                }

            });

        })();
    </script>
</dom-module>