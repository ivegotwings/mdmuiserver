<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-model-download">
    <template>
        <style include="bedrock-style-common">
        </style>        
        <liquid-rest id="copDownloadService" url="" method="POST" request-data={{_copDownloadRequest}} on-liquid-response="_onCOPDownloadSuccess"
            on-liquid-error="_onCOPDownloadFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-model-download",

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    } 
                },
              
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                onDownload: function (profile,domain) {
                    var profiles = [];
                    profiles.push(profile);
                    var req = {                                   
                      "params": {
                        "fields": {
                            "attributes": [
                                "_ALL"
                            ]
                        },
                        "rsconnect": {
                            "includeValidationData": true,
                            "profiles": profiles
                        }
                      }
                    };

                    if (req) {
                      var _this = this;
                      RUFUtilities.fileDownload("/data/cop/downloadModelExcel", {
                          httpMethod: 'POST',
                          data: { data: JSON.stringify(req) },
                          successCallback: function (url) {
                              this._onDownloadSuccess();
                          }.bind(_this),
                          failCallback: function (responseHtml, url, error) {
                              this._onDownloadFailure(error);
                          }.bind(_this)
                      });
                    } 
                },
                
                _onDownloadSuccess: function () {
                  this.fireBedrockEvent("onDownloadSuccess","Success",{ignoreId: true});            
                },
                _onDownloadFailure: function (e) {
                  this.logWarning("UnexpectedCOP", "response", JSON.stringify(e.detail.response));
                  this.showErrorToast("Unable to download the data model. Please check the service or contact your administrator.");
                }               
               
              });
          
        })();
    </script>
</dom-module>