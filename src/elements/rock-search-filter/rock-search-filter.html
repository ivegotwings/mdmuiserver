<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-tags/pebble-tags.html">
<link rel="import" href="../pebble-datetime-picker/pebble-datetime-picker-overlay.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-attribute-model-lov/rock-attribute-model-lov.html">
<link rel="import" href="../rock-entity-type-model-lov/rock-entity-type-model-lov.html">
<!--
`rock-search-filter` Represents an element that contains search bar and filter tags. 
An user can switch between a search mode and a filter mode to get the query they want to search.

@demo demo/index.html
-->

<dom-module id="rock-search-filter"> 

  <template>
    <style include="pebble-styles-shared"></style>
    <style>
      .container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        display: inline-flex;
        display: -webkit-inline-flex;
        width: 100%;
      }     
      
      pebble-tags::shadow pebble-tag-item::shadow paper-icon-button {
        height: var(--tag-icon-size);
        width: var(--tag-icon-size);
        padding: 0;
      }

      pebble-tags::shadow pebble-tag-item::shadow paper-icon-button::shadow iron-icon {
        height: 20px;
        width: 20px;
      }
      #entityTypeFilterButton{
        margin-right:5px;
      }
      #filter-tags {
        width: calc(100% - 180px);
      }
      
      paper-menu-button {
        padding: 0;
      }

      paper-menu.dropdown-content {
        padding: 0;
      }

      paper-menu-button paper-menu paper-item {
        padding: 0px 10px;
        color: var(--palette-dark, #1a2028);
      }
      
      paper-menu-button paper-menu paper-item:hover {
        background-color: var(--bgColor-hover, #e8f4f9);
        color: var(--focused-line, #026bc3) !important;
      }
      
      paper-menu-button paper-menu paper-item:focus:before,
      paper-menu-button paper-menu paper-item:focus:after {
        background-color: var(--bgColor-hover, #e8f4f9);
      }
      
      paper-menu-button paper-menu paper-item:focus {
        background-color: var(--bgColor-hover, #e8f4f9);
        color: var(--focused-line, #026bc3) !important;
      }
      
      #filterPopover{
        min-width: 240px;
        padding: 10px;
      }

      #filterPopover paper-item {
        --paper-item: {
          font-size: 12px;             
        }
        --paper-item-min-height: 30px;
      }

      #filterPopover paper-menu {
        --paper-menu-selected-item: {
          font-size: 12px;
        }
      }
      #booleanDisplay::shadow paper-button{
        height:30px;
        width:100px;
        font-size:14px;
      }
      #filterPopover{
         min-width: 240px;
         padding: 10px;
      }
       
      pebble-textarea::shadow paper-textarea::shadow paper-input-container{
         padding: 0;
      }

      pebble-textarea::shadow paper-textarea::shadow paper-input-container::shadow .floated-label-placeholder{
         line-height: 0;
      }

      pebble-popover .dialogOptions paper-radio-button{
         padding: 0;
      }

      pebble-textarea::shadow paper-textarea::shadow paper-input-container iron-autogrow-textarea{
         font-size: var(--default-font-size, 14px)!important;
      }

      pebble-popover .dialogOptions paper-radio-button::shadow #offRadio, pebble-popover .dialogOptions paper-radio-button::shadow #onRadio{
         top: -9px;
      }
      pebble-popover .dialogOptions paper-radio-button input{               
         width: 100px;
         font-size: 15px;
         padding: 0 4px;
         line-height: 30px;
      }

      pebble-popover rock-entity-lov::shadow pebble-lov{
        padding: 0;
      }

      paper-input {
         width: 90%;
      }

      .dialogOptions paper-radio-button{
         display: block ;
      }     

    </style>
    <template is="dom-if" if="{{searchMode}}">
      <div class="container">
        <rock-search-bar id="searchSection" style="width:90%" search-input="{{tags}}"></rock-search-bar>
        <pebble-button icon="filter-list" class="button" on-tap="toggleMode" raised></pebble-button>
      </div>
    </template>
    <template is="dom-if" if="{{!searchMode}}">
      <div class="row layout-top">
        <template is="dom-if" if="{{!hideSearchTrigger}}">
          <pebble-button icon="search" class="button" on-tap="toggleMode" raised></pebble-button>
        </template>
          <pebble-button id="entityTypeFilterButton" icon="{{icon}}" button-text="Entity Type" dropdown-icon noink class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger"
                         on-tap="_openEntityTypeFilterLov"></pebble-button>
          <pebble-popover id="entityTypeFilterPopover" for="entityTypeFilterButton" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
              <rock-entity-type-model-lov id="entityTypeModelLov" context-data="[[contextData]]" no-sub-title id-field="name" title-pattern="externalName" type-field=""></rock-entity-type-model-lov>
          </pebble-popover>
          <pebble-button id="filterButton" icon="{{icon}}" button-text="{{text}}" dropdown-icon noink class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger"
                         on-tap="_openFilterLov"></pebble-button>
          <pebble-popover id="refineFilterPopover" for="filterButton" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
              <rock-attribute-model-lov  id="attributeModelLov" context-data="[[contextData]]" no-sub-title  id-field="name"
                                    title-pattern="externalName" type-field="" request-data="{{attributeModelRequest}}"  ></rock-attribute-model-lov>
          </pebble-popover>
          
          <bedrock-pubsub event-name="attribute-model-lov-selection-changed" handler="_onSelectedFilterChange" target-id="attributeModelLov"></bedrock-pubsub>
        <pebble-tags id="filter-tags" 
                     tags="{{tags}}"
                     show-expand-icon 
                     show-remove-icon
                     class="p-l-10 p-r-10">
        </pebble-tags>        
        <bedrock-pubsub event-name="on-tap-tag-item" handler="_onTagItemTap"></bedrock-pubsub>
        <bedrock-pubsub target-id="rockEntityLov" event-name="entity-lov-selection-changed" handler="_onLOVSelectedItemChange"></bedrock-pubsub>
        <bedrock-pubsub target-id="rockEntityLovForDropdown" event-name="entity-lov-selection-changed" handler="_onLOVDropdownSelectedItemChange"></bedrock-pubsub>
        <!-- Refine popover starts here -->
        <pebble-popover id="filterPopover" for="pebble-tag" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">            
            <template is="dom-if" if="{{_showTagModifier('textbox', _tigger)}}">
               <rock-entity-lov id="rockEntityLov"
                                selected-item="{{selectedItem}}">                               
							</rock-entity-lov>              
            </template>
            <template is="dom-if" if="{{_showTagModifier('textArea', _tigger)}}">
                <pebble-textarea class="input" placeholder="{{longName}}" value="{{tav}}"></pebble-textarea>
                <div class="PebbleButtonPadding text-center m-t-15">
                    <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
                    <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
                    <div class="clearfix"></div>
                </div>  
            </template>
            <template is="dom-if" if="{{_showTagModifier('boolean', _tigger)}}">
                <pebble-boolean class="text-center" id="booleanDisplay" value="{{booleanvalue}}" required></pebble-boolean>
                 <div class="PebbleButtonPadding text-center m-t-15">
                    <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
                    <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
                </div>
            </template>
            <template is="dom-if" if="{{_showTagModifier('numeric', _tigger)}}">
                <paper-radio-group aria-labelledby="{{longName}}" class="dialogOptions" on-paper-radio-group-changed="_onRadioGroupChange">
                    <paper-radio-button name="range">
                        <div class="col-50 pull-left">
                            <div class="radio-name">Min</div>
                            <input is="iron-input" type="number" bind-value="{{gte}}">
                        </div>
                        <div class="col-50 pull-left">
                            <div class="radio-name">Max</div>
                            <input is="iron-input" type="number" bind-value="{{lte}}">
                        </div>
                        <div class="clearfix"></div>
                    </paper-radio-button>
                    <paper-radio-button name="equalToDate">
                        <div class="col-90 pull-left">
                            <div class="radio-name">Equal to</div>
                            <input is="iron-input" type="number" bind-value="{{equalNum}}">
                        </div>
                        <div class="clearfix"></div>
                    </paper-radio-button>
                </paper-radio-group>
                <div class="PebbleButtonPadding text-center">
                    <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
                    <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
                </div>
            </template>
            <template is="dom-if" if="{{_showTagModifier('dropDown', _tigger)}}">
               <rock-entity-lov id="rockEntityLovForDropdown"
                                request-data="[[_prepareRequestData(contextData)]]"
                                selected-item="{{selectedItem}}">                               
							</rock-entity-lov> 
            </template>
        </pebble-popover>
        <!-- Already overlay, so out of popover -->
        <pebble-datetime-picker-overlay id="rangepicker" 
                                        for="pebble-tag" 
                                        picker-type="daterange" 
                                        show-ranges     
                                        heading-format="ddd, MMM DD YYYY"
                                        start-date-value="{{gte}}" 
                                        end-date-value="{{lte}}" 
                                        on-date-range-selected="_updateValue">
        </pebble-datetime-picker-overlay>
        <!-- Refine popover ends here -->
      </div>
    </template>

  </template>
  <script>

  Polymer({

    is: 'rock-search-filter',

    properties: {
    /**
       * Indicates the list of string type that holds the tags. 
       * Note that values in this array must be identical and duplicates must be avoided due to the definition of the tags.
       */
      tags: {
        type: Array,
        notify: true,
        reflectToAttribute: true,
        value: function () { return [] }
      },
       /**
       * Indicates the list of properties that can be passed as filter tags.
       */
      filters: {
        type: Array,
        notify: true,
        value: function () { return [] },
      },
      /**
        * Specifies whether or not an element is in search mode or filter mode.
       */
      searchMode: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
        * Specifies whether or not search-bar trigger button is visible when the seach mode is disabled.
       */
      hideSearchTrigger: {
        type: Boolean,
        value: false
      },
      /**
        * Specifies the text for the search filter button.
       */
      text: {
        type: String,
        value: "Refine",
        reflectToAttribute: true
      },
      /**
        * Specifies the icon to be used for the search filter button.
       */
      icon: {
        type: String,
        value: "pebble-sm-icons:Filter-wt",
        reflectToAttribute: true
      },
      /**
       *  Indicates the reference to the currently opened tag.
       */
      currentTag:{
           type:Object,
           notify:true
      },

      _tigger: {
        type: String
      },

      colors: {
        type: Array,
        value: ['red', 'green', 'blue']
      },

      contextData: {
        type: Object,
        value: function () {
            return {};
        },
        observer:'_getAttributeModels'
      }

    },
    behaviors: [
        RUFBehaviors.UIBehavior,
        RUFBehaviors.AppContextBehavior
    ],

    /**
    * Can be used add a filter tag on selecting it from the dropdown.
    */
    _onSelectedFilterChange: function(e, detail) {
       var data = detail.data;
       var tag={};
       tag["value"] = (data.value && !_.isEmpty(data.value)) ? data.value : {"eq": "All"};
       tag["displayParams"] = (data.displayParams && !_.isEmpty(data.displayParams)) ? data.displayParams : ["eq"];
       var dataType=data.dataType;
       var displayType=data.displayType;
       if(displayType=="referenceList" || displayType=="textCollection"){
           displayType="textbox"
       }
       if(displayType=="date"){
           displayType="datetime"
       }
       if(dataType.toLowerCase()=="integer" || dataType.toLowerCase()=="decimal"){
           displayType="numeric"
       }
       tag.options=data;
       tag.options.displayType= displayType
       tag["longName"] = data.externalName;
       tag["name"] = data.name;
       this.$$("#filter-tags").addTag(tag);
       this.$$("#refineFilterPopover").close();
    },
    /**
     *  Can be used to toggle between the search mode and filter mode.
    */
    toggleMode: function(e){
      this.searchMode= !this.searchMode;
    },

    _prepareRequestData: function(contextData){
       return DataRequestHelper.createEntityGetRequest(contextData);
    },  

     // On tag tap should select the soecific element 
     _onTagItemTap:function (e, detail) {
       
        this.currentTag=detail;

        if(this.currentTag && this.currentTag.options.displayType.toLowerCase() == "datetime")
        {
          //Display range picker based on the currerntTag
          if(this.currentTag.value.eq != 'All')
          {
            if(this.currentTag.value.eq)
            {
              this.$$('#rangepicker').startDateValue = this.currentTag.value.eq;
              this.$$('#rangepicker').endDateValue = this.currentTag.value.eq;
            }
            else
            {
              this.$$('#rangepicker').startDateValue = this.currentTag.value.gte;
              this.$$('#rangepicker').endDateValue = this.currentTag.value.lte;
            } 

            var _date = new Date(this.$$('#rangepicker').startDateValue);
            this.$$('#rangepicker').setDate(_date);           
          }
          else
          {
            this.$$('#rangepicker').startDateValue = "";
            this.$$('#rangepicker').endDateValue = "";
            this.$$('#rangepicker').setDate(new Date());
          }

          this.$$('#rangepicker').setRangeType(null);          

          this.async(function(){
            this.$$('#rangepicker').positionTarget = this.$$('#filter-tags').$$("#tag" + detail.index);
            this.$$('#rangepicker').noOverlap = true;                        
            this.$$('#rangepicker').show(true);
          });      
        }
        else
        {
          this._tigger = Date.parse(new Date().toString()); //Just used to trigger popover element
          
          //Delayed to open the popover, because want to close the existing popover          
          this.async(function(){
              this.$$('#filterPopover').positionTarget = this.$$('#filter-tags').$$("#tag" + detail.index);
              this.$$('#filterPopover').show(true);

              //Set values to the components
              //TextArea
              if(this.currentTag.options.displayType.toLowerCase() == "textarea")
              {
                if(this.$$('pebble-popover').querySelector('.input'))
                {
                  this.$$('pebble-popover').querySelector('.input').value = this.currentTag.value.eq;
                  this.async(function(){
                    this.$$('pebble-popover').querySelector('.input').focus();
                  }, 10); //Delayed to set the value and focus the input                
                }            
              }
              else if(this.currentTag.options.displayType.toLowerCase() == "numeric")
              {
                this.gte = this.lte = this.equalNum = "";
                if(this.currentTag.value.eq && this.currentTag.value.eq != 'All')
                {
                  this.$$('#filterPopover').querySelector('paper-radio-group').selected = 'equalToDate';
                  this.equalNum = this.currentTag.value.eq;                  
                }
                else
                {
                  this.$$('#filterPopover').querySelector('paper-radio-group').selected = 'range';
                  this.gte = this.currentTag.value.gte;
                  this.lte = this.currentTag.value.lte;

                }
              }              
              else if(this.currentTag.options.displayType.toLowerCase() == "textbox")
              {                
                //Set Id, Title and Value to the LOV
                var lovComponent = this.$$('#filterPopover').querySelector('#rockEntityLov');
                
                if(this.currentTag.options.isReferenceType){
                    lovComponent.idField = "name";
                    lovComponent.titlePattern = "name";
                    lovComponent.valueField = "name";
                    var refEntityTypes=this.currentTag.options.referenceEntityTypes;
                    var itemContexts=[];
                    for(var i in refEntityTypes){
                      itemContexts.push({"type":refEntityTypes[i]});
                    }
                    var contextData = DataHelper.cloneObject(this.contextData);
                    contextData[this.CONTEXT_TYPE_ITEM]=itemContexts; 
                    contextData[this.CONTEXT_TYPE_VALUE]=[]; 
                    lovComponent.requestData = this._prepareRequestData(contextData);
                } else{
                    lovComponent.idField = this.currentTag.name;
                    lovComponent.titlePattern = this.currentTag.name;
                    lovComponent.valueField = this.currentTag.name;
                    lovComponent.requestData = this._prepareRequestData(this.contextData);
                    lovComponent.requestData.params.fields.attributes=[this.currentTag.name];
                }
                  lovComponent.refreshLOVData();

                  if(!this.currentTag.value.eq)
                {
                  return;
                }

                if(this.currentTag.value.eq == 'All')
                {
                    lovComponent.selectedItem = {};
                }
                else
                {
                  this.async(function(){
                    lovComponent.selectedItem = this.currentTag.options.selectedItem;
                  });                    
                }
              }
              else if(this.currentTag.options.displayType.toLowerCase() == "dropdown")
              {                
                //Set Id, Title and Value to the LOV
                var lovComponent = this.$$('#filterPopover').querySelector('#rockEntityLovForDropdown');
                
                lovComponent.idField = this.currentTag.name;
                lovComponent.titlePattern = this.currentTag.name;
                lovComponent.valueField = this.currentTag.name;               

                lovComponent.resetLOV();
                lovComponent.reTriggerRequest();

                if(!this.currentTag.value.eq)
                {
                  return;
                }

                if(this.currentTag.value.eq == 'All')
                {
                    lovComponent.selectedItem = {};
                }
                else
                {
                  this.async(function(){
                    lovComponent.selectedItem = this.currentTag.options.selectedItem;
                  });                    
                }
              }
          });
        }     
    },
    
    // Refine filter radio buttons
    _onRadioGroupChange: function() {
        this.gte = this.lte = this.equalNum = "";
    },

    // Refine filter dropdown
    _onLOVDropdownSelectedItemChange: function(e, detail) {
        if(detail && detail.data)
        {
            this.currentTag.value = {
              "eq": detail.data.value
            }
            this.currentTag.options["selectedItem"] = detail.data;            
            this.currentTag.displayParams = ["eq"];

            this.set('tags.' + this.currentTag.index + '.displayParams', this.currentTag.displayParams);
            this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }

        this.$$('#filterPopover').hide();
        //Fire event
        this._fireChangeEvent(this.currentTag.name, this.currentTag.value);
    },

    _onLOVSelectedItemChange: function(e, detail) {
        if(detail && detail.data)
        {
            this.currentTag.value = {
              "eq": detail.data.value
            }
            this.currentTag.options["selectedItem"] = detail.data;            
            this.currentTag.displayParams = ["eq"];

            this.set('tags.' + this.currentTag.index + '.displayParams', this.currentTag.displayParams);
            this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }

        this.$$('#filterPopover').hide();
        //Fire event
        this._fireChangeEvent(this.currentTag.name, this.currentTag.value,this.currentTag.options.type);
    },

    // Refine filter tags will be updated as per selection
    _updateValue: function (e) {
        if(this.currentTag.options.displayType.toLowerCase() == "datetime") //DateTime
        {
            if (this.gte == this.lte) {
                this.currentTag.value = {
                    "eq": this.gte
                };
                this.currentTag.displayParams = ["eq"];
                } else {
                    this.currentTag.value = {
                        "gte": this.gte,
                        "lte": this.lte
                    };
                    this.currentTag.displayParams = ["gte", "lte"];
                }

                this.set('tags.' + this.currentTag.index + '.displayParams', this.currentTag.displayParams);
                this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }
        else if (this.currentTag.options.displayType.toLowerCase() == "numeric") //Radio group
        {
                if (this.$$('paper-radio-group').selected == "range") {

                    if(!(this.gte && this.lte))
                    {
                      console.warn('Values not provided');
                      return;
                    }

                    this.currentTag.value = {
                         "gte": this.gte,
                         "lte": this.lte
                    };
                    this.currentTag.displayParams = ["gte", "lte"];
                } else {

                    if(!this.equalNum)
                    {
                      console.warn('Value not provided');
                      return;
                    }

                    this.currentTag.value = {
                         "eq": this.equalNum
                    };
                    this.currentTag.displayParams = ["eq"];
               }

               this.set('tags.' + this.currentTag.index + '.displayParams', this.currentTag.displayParams);
               this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }
        else if(this.currentTag.options.displayType.toLowerCase() == "boolean") //boolean
        {
                this.currentTag.value = {
                  "eq":this.booleanvalue
                };
                this.currentTag.displayParams= ["eq"];
                this.set('tags.' + this.currentTag.index + '.displayParams', this.currentTag.displayParams);
                this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }

        else //TextArea
        {
            if(!this.tav)
            {
              console.warn('Value not provided');
              return;
            }

            this.currentTag.value = {
                    "eq": this.tav
            };
            this.currentTag.displayParams = ["eq"];

            this.set('tags.' + this.currentTag.index + '.displayParams', this.currentTag.displayParams);
            this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }

        //Close the popover once value updated
        if(this.currentTag.options.displayType.toLowerCase() == "datetime")
        {
          this.$$('#rangepicker').hide();
        }
        else
        {
          this.$$('#filterPopover').hide();
        }

        //Fire event
        this._fireChangeEvent(this.currentTag.name, this.currentTag.value)

    },

    _fireChangeEvent: function (_name, _value,_type) {
         var attribute = {
             name: _name,
             value:  _value,
             type:_type
         };
         if (_value && _name) {
             this.fireBedrockEvent('tag-value-change', attribute, {
                  ignoreId: true
             });
         }
    },

    // When tag tapped, which popover component need to show
    _showTagModifier: function(displayType) {

        if(this.currentTag && this.currentTag.options.displayType.toLowerCase() == displayType.toLowerCase())  {
                return true;
        }

        return false;
    },

    //Hide the popover
    _dismissDialog: function () {
        this.$$('#filterPopover').hide();
    },
    _openFilterLov:function () {
        this.$$("#refineFilterPopover").open();
    },
    _openEntityTypeFilterLov:function () {
       this.$$("#entityTypeFilterPopover").open();
    },
      _getAttributeModels:function (contextData) {
          if(_.isEmpty(contextData)){
                return;
          }
          var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(
              contextData);
              if(compositeModelGetRequest && compositeModelGetRequest.params){
                compositeModelGetRequest.params.fields.attributes=["_ALL"];
              }
        //  compositeModelGetRequest.params.fields.attributes=['_ALL'];
          this.set('attributeModelRequest',compositeModelGetRequest);
          // var lov=this.$$('rock-attribute-model-lov');
          // if(lov){
          //     lov.refreshData();
          // }
      }
    
  });

</script>
</dom-module>