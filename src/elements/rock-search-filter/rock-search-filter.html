<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-tags/rock-tags.html">

<!--
`rock-search-filter` Represents an element that contains search bar and filter tags. 
An user can switch between a search mode and a filter mode to get the query they want to search.

@demo demo/index.html
-->

<dom-module id="rock-search-filter"> 

  <template>
    <style include="pebble-styles-shared"></style>
    <style>
      .container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        display: inline-flex;
        display: -webkit-inline-flex;
        width: 100%;
      }
      
      #filter-tags{
          width: calc(100% - 142px);
      }

      paper-menu-button{
          padding: 0;
      }

    </style>
    <template is="dom-if" if="{{searchMode}}">
      <div class="container">
        <rock-search-bar id="searchSection" style="width:90%" search-input="{{tags}}"></rock-search-bar>
        <pebble-button icon="filter-list" class="button" on-tap="toggleMode" raised></pebble-button>
      </div>
    </template>
    <template is="dom-if" if="{{!searchMode}}">
      <div class="row layout-top">
        <template is="dom-if" if="{{!hideSearchTrigger}}">
          <pebble-button icon="search" class="button" on-tap="toggleMode" raised></pebble-button>
        </template>
        <!--<pebble-button class="button" id="pebbleButtonMenu1" items={{filters}} icon="filter-list" filter="_alreadyAdded" menu-button  raised  on-iron-select="_dropdownValueChanged" ></pebble-button>-->
        <paper-menu-button>
          <pebble-button icon="{{icon}}" button-text="{{text}}" dropdown-icon noink class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger" on-tap="refreshFilter"></pebble-button>
          <paper-menu class="dropdown-content" on-iron-select="_dropdownValueChanged">
            <template id="filterList" is="dom-repeat" items="{{filters}}" filter="_alreadyAdded" observe="tags">
              <paper-item item="[[item]]">[[item.longName]]</paper-item>
            </template>
          </paper-menu>
        </paper-menu-button>
        <rock-tags id="filter-tags" tags="{{tags}}" tag-colors="{{tagColors}}" disable-add="{{disableFilterAdd}}" is-non-editable="{{filterNonEditable}}"
          disable-delete="{{disableFilterDelete}}" current-tag="{{currentTag}}" class="p-l-10 p-r-10"></rock-tags>
      </div>
    </template>

  </template>
  <script>

  Polymer({

    is: 'rock-search-filter',

    properties: {
    /**
       * Indicates the list of string type that holds the tags. 
       * Note that values in this array must be identical and duplicates must be avoided due to the definition of the tags.
       */
      tags:{
        type:Array,
        notify: true,
        reflectToAttribute: true,
        value:function(){return []}
      },
       /**
       * Indicates the list of properties that can be passed as filter tags.
       */
      filters:{
        type:Array,
        notify: true,
        value:function(){return []},
      },
      /**
        * Specifies whether or not an element is in search mode or filter mode.
       */
      searchMode:{
        type:Boolean,
        value:false,
        notify: true
      },
       /**
        * Specifies whether or not the value of the filter tag is editable.
       */
       filterNonEditable: {
        type: Boolean,
        value: false
      },
      /**
        * Specifies whether or not addition of more filter tags are allowed.
       */
      disableFilterAdd: {
        type: Boolean,
        value: false
      },
      /**
        * Indicates the list of colors that is used in the filter tags. Order of color used is based on the index.
       */
      tagColors:{
       type: Array,
       notify: true,
       value: function(){return []}
      },
       /**
        * Specifies whether or not the deletion of filter tag is allowed.
       */
      disableFilterDelete: {
        type: Boolean,
        value: false
      },

      /**
        * Specifies whether or not search-bar trigger button is visible when the seach mode is disabled.
       */
      hideSearchTrigger: {
        type: Boolean,
        value: false
      },
      /**
        * Specifies the text for the search filter button.
       */
      text: {
        type: String,
        value: "Refine",
        reflectToAttribute: true
      },
      /**
        * Specifies the icon to be used for the search filter button.
       */
      icon: {
        type: String,
        value: "pebble-sm-icons:Filter-wt",
        reflectToAttribute: true
      },
        /**
         *  Indicates the reference to the currently opened tag.
         */
        currentTag:{
            type:Object,
            notify:true
        }

    },
    /**
    * Can be used add a filter tag on selecting it from the dropdown.
    */
    _dropdownValueChanged: function(e) {
       var tag=e.target.selectedItem.item;
       this.$$("#filter-tags ").addTag(tag);
    },
    /**
     *  Can be used to toggle between the search mode and filter mode.
    */
    toggleMode: function(e){
      this.searchMode= !this.searchMode;
    },
    /**
     *  Can be used to check if a property is already added in the filter tags. 
     *  If it is added, then that property is not shown in the drop-down list.
    */
    _alreadyAdded: function(item){
        if (!item){
          return false;
        }
        var tag  = this.tags.filter(function(i){
          return i.name == item.name;
        });
        if(tag && tag.length>0){
          return false;
        }
        return true;
    },

  
    /**
     *  Can be used to refresh the drop-down elements.
    */
    refreshFilter: function(){
        var list=this.$$("#filterList");
        if(list){
          list.render();
          this.$$('paper-menu').selected=null;
        }
    }

  });

</script>
</dom-module>