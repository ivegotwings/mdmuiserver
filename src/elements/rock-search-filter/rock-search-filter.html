<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-helpers/constant-helper.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-tags/pebble-tags.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-datetime-picker/pebble-datetime-picker-overlay.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-self-attribute-model-lov/rock-self-attribute-model-lov.html">
<!--
`rock-search-filter` Represents an element that contains the "search bar" and filter tags. 
The users can switch between a search mode and a filter mode to get the query they want to search.

@demo demo/index.html
-->

<dom-module id="rock-search-filter">

  <template>
    <style include="pebble-styles-shared"></style>
    <style>
      .container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        display: inline-flex;
        display: -webkit-inline-flex;
        width: 100%;
      }

      pebble-tags {
        --actions-icon-button: {
          height: var(--tag-icon-size);
          width: var(--tag-icon-size);
          padding: 0;
        };
      }

      pebble-tags {
        --pebble-button-iron-icon: {
          height: 20px;
          width: 20px;
        };  
      }

      #filter-tags {
        width: calc(100% - 290px);
      }

      paper-menu-button {
        padding: 0;
      }

      paper-menu.dropdown-content {
        padding: 0;
      }

      paper-menu-button paper-menu paper-item {
        color: var(--palette-dark, #1a2028);
      }

      paper-menu-button paper-menu paper-item:hover {
        background-color: var(--bgColor-hover, #e8f4f9);
        color: var(--focused-line, #026bc3) !important;
      }

      paper-menu-button paper-menu paper-item:focus:before,
      paper-menu-button paper-menu paper-item:focus:after {
        background-color: var(--bgColor-hover, #e8f4f9);
      }

      paper-menu-button paper-menu paper-item:focus {
        background-color: var(--bgColor-hover, #e8f4f9);
        color: var(--focused-line, #026bc3) !important;
      }

      #filterPopover {
        min-width: 240px;
      }

      pebble-textbox::shadow #textbox {
        @apply --popup-item;
      }
    
      #filterPopover paper-item {
        --paper-item: {
          font-size: 12px;
        }
        --paper-item-min-height: 30px;
      }

      #filterPopover paper-menu {
        --paper-menu-selected-item: {
          font-size: 12px;
        }
      }

      pebble-boolean::shadow paper-button {
        height: 30px;
        width: 100px;
        font-size: 14px;
      }

      pebble-button[disabled] {
        pointer-events: none;
        color: #c1cad4;
        background-color: #c1cad4;
        border-color: #c1cad4;
      }

      pebble-textarea {
        --paper-input-container: {
          padding: 0 20px !important;
        };
      }

      pebble-textarea(.floated-label-placeholder) {
        line-height: 0;
      }

      pebble-popover .dialogOptions paper-radio-button {
        @apply --popup-item;
      }

      pebble-textarea::shadow paper-textarea::shadow paper-input-container iron-autogrow-textarea {
        font-size: var(--default-font-size, 14px)!important;
      }

      pebble-popover .dialogOptions paper-radio-button::shadow #offRadio,
      pebble-popover .dialogOptions paper-radio-button::shadow #onRadio {
        top: -9px;
      }

      pebble-popover .dialogOptions paper-radio-button input {
        width: 100px;
        font-size: 15px;
        padding: 0 4px;
        line-height: 30px;
      }

      pebble-popover rock-entity-lov::shadow pebble-lov {
        padding: 0;
      }

      paper-input {
        width: 90%;
      }

      .dialogOptions paper-radio-button {
        display: block;
      }
    </style>

    <template is="dom-if" if="{{searchMode}}">
      <div class="container">
        <rock-search-bar id="searchSection" style="width:90%" search-input="{{tags}}"></rock-search-bar>
        <pebble-button icon="filter-list" class="button" on-tap="toggleMode" raised></pebble-button>
      </div>
    </template>
    <template is="dom-if" if="{{!searchMode}}">
      <div class="row layout-top">
        <template is="dom-if" if="{{!hideSearchTrigger}}">
          <pebble-button icon="search" class="button" on-tap="toggleMode" raised></pebble-button>
        </template>
        <pebble-button id="filterButton" icon="{{icon}}" button-text="{{text}}" dropdown-icon noink class="dropdownText dropdownIcon btn dropdown-primary dropdown-trigger"
          on-tap="_openFilterLov"></pebble-button>
        <pebble-popover id="refineFilterPopover" for="filterButton" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
          <rock-self-attribute-model-lov id="attributeModelLov" context-data="[[contextData]]" no-sub-title id-field="name" title-pattern="externalName"
            type-field="[]"></rock-self-attribute-model-lov>
        </pebble-popover>

        <bedrock-pubsub event-name="self-attribute-model-lov-selection-changed" handler="_onSelectedFilterChange" target-id="attributeModelLov"></bedrock-pubsub>
        <pebble-tags id="filter-tags" tags="{{tags}}" show-expand-icon show-remove-icon class="p-l-10 p-r-10">
        </pebble-tags>
        <bedrock-pubsub event-name="on-tap-tag-item" handler="_onTagItemTap"></bedrock-pubsub>
        <bedrock-pubsub event-name="on-attached-tag-item" handler="_onTagItemTap"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-lov-confirm-button-tap" handler="_onLOVConfirmTap" target-id="rockEntityLov"></bedrock-pubsub>
        <bedrock-pubsub event-name="entity-lov-close-button-tap" handler="_onLOVCloseTap" target-id="rockEntityLov"></bedrock-pubsub>
        <!-- Refine popover starts here -->
        <pebble-popover id="filterPopover" for="pebble-tag" no-overlap auto-fit-on-attach vertical-align="auto" horizontal-align="auto">
          <template is="dom-if" if="{{_showTagModifier('textbox', _tigger)}}">
            <pebble-textbox class="input" label="Enter text here" value="{{tav}}"></pebble-textbox>
            <div class="PebbleButtonPadding text-center m-t-15">
              <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
              <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
              <div class="clearfix"></div>
            </div>
          </template>
          <template is="dom-if" if="{{_showTagModifier('textArea', _tigger)}}">
            <pebble-textarea class="input" label="Enter text here" value="{{tav}}"></pebble-textarea>
            <div class="PebbleButtonPadding text-center m-t-15">
              <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
              <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
              <div class="clearfix"></div>
            </div>
          </template>
          <template is="dom-if" if="{{_showTagModifier('referenceList', _tigger)}}">
            <rock-entity-lov id="rockEntityLov" multi-select no-sub-title show-action-buttons selected-items="{{_selectedItems}}">
            </rock-entity-lov>
          </template>
          <template is="dom-if" if="{{_showTagModifier('boolean', _tigger)}}">
            <pebble-boolean class="text-center" id="booleanDisplay" value="{{booleanvalue}}" required></pebble-boolean>
            <div class="PebbleButtonPadding text-center m-t-15">
              <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
              <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue"></pebble-button>
            </div>
          </template>
          <template is="dom-if" if="{{_showTagModifier('numeric', _tigger)}}">
            <paper-radio-group aria-labelledby="{{longName}}" class="dialogOptions" on-paper-radio-group-changed="_onRadioGroupChange">
              <paper-radio-button name="range">
                <div class="colspan-2 pull-left">
                  <pebble-textbox label="Min" prevent-invalid-input allowed-pattern="[0-9.]" invalid="{{numericMinInvalid}}" show-error input-data-type="[[currentTag.options.dataType]]"
                    value="{{gte}}">
                  </pebble-textbox>
                </div>
                <div class="colspan-2 pull-left">
                  <pebble-textbox label="Max" prevent-invalid-input allowed-pattern="[0-9.]" invalid="{{numericMaxInvalid}}" show-error input-data-type="[[currentTag.options.dataType]]"
                    value="{{lte}}">
                  </pebble-textbox>
                </div>
                <div class="clearfix"></div>
              </paper-radio-button>
              <paper-radio-button name="equalToDate">
                <div class="col-90 pull-left">
                  <pebble-textbox label="Equal to" prevent-invalid-input allowed-pattern="[0-9.]" invalid="{{numericEqualInvalid}}" show-error
                    input-data-type="[[currentTag.options.dataType]]" value="{{equalNum}}">
                  </pebble-textbox>
                </div>
                <div class="clearfix"></div>
              </paper-radio-button>
            </paper-radio-group>
            <div class="PebbleButtonPadding text-center">
              <pebble-button class="btn btn-secondary" on-tap="_dismissDialog" raised elevation="1" button-text="Close"></pebble-button>
              <pebble-button class="btn btn-success m-r-5" button-text="Update" raised elevation="1" on-tap="_updateValue" disabled="{{_updateDisable}}"></pebble-button>
            </div>
          </template>
        </pebble-popover>
        <!-- Already overlay, so out of popover -->
        <pebble-datetime-picker-overlay id="rangepicker" for="pebble-tag" picker-type="daterange" show-ranges heading-format="ddd, MMM DD YYYY"
          start-date-text="{{displaygte}}" end-date-text="{{displaylte}}" start-date-value="{{gte}}" end-date-value="{{lte}}"
          on-date-range-selected="_updateValue">
        </pebble-datetime-picker-overlay>
        <!-- Refine popover ends here -->
      </div>
    </template>

  </template>
  <script>
    Polymer({

      is: 'rock-search-filter',

      properties: {
        /**
         * Indicates the list of string type that holds the tags. 
         * Note that values in this array must be identical and duplicates must be avoided due to the definition of the tags.
         */
        tags: {
          type: Array,
          notify: true,
          reflectToAttribute: true,
          value: function () {
            return []
          }
        },
        /**
         * Indicates the list of properties that are used as filter tags.
         */
        filters: {
          type: Array,
          notify: true,
          value: function () {
            return []
          }
        },

        /**
         * Specifies whether or not an element is in the search or filter mode.
         */
        searchMode: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * Specifies whether or not the "search bar" triggered button is visible when the search mode is disabled.
         */
        hideSearchTrigger: {
          type: Boolean,
          value: false
        },
        /**
         * Specifies the text for the search filter button.
         */
        text: {
          type: String,
          value: "Refine",
          reflectToAttribute: true
        },
        /**
         * Specifies the icon for the search filter button.
         */
        icon: {
          type: String,
          value: "pebble-sm-icons:Filter-wt",
          reflectToAttribute: true
        },
        /**
         *  Indicates the reference to the currently opened tag.
         */
        currentTag: {
          type: Object,
          notify: true
        },

        _tigger: {
          type: String
        },

        _selectedItems: {
          type: Array,
          value: function () {
            return [];
          }
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        colors: {
          type: Array,
          value: ['red', 'green', 'blue']
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        contextData: {
          type: Object,
          value: function () {
            return {};
          }
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        gte: {
          type: String,
          value: function () {
            return "";
          },
          observer: '_isMaxGreaterThanMin'
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        lte: {
          type: String,
          value: function () {
            return "";
          },
          observer: '_isMaxGreaterThanMin'
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        equalNum: {
          type: String,
          value: function () {
            return "";
          }
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        numericMinInvalid: {
          type: Boolean,
          value: false
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        numericMaxInvalid: {
          type: Boolean,
          value: false
        },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
        numericEqualInvalid: {
          type: Boolean,
          value: false
        },
        _updateDisable: {
          type: Boolean,
          computed: '_disableUpdate(numericMinInvalid,numericMaxInvalid,numericEqualInvalid,gte,lte,equalNum)'
        }

      },
      behaviors: [
        RUFBehaviors.UIBehavior,
        RUFBehaviors.AppContextBehavior
      ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
      removeAllSearchFilters: function () {
        if (this.$$("#filter-tags")) {
          this.$$("#filter-tags").removeAllTags();
        }
      },

      /**
       * validate the input for numeric display type and disables the update button
       */
      _disableUpdate: function (numericMinInvalid, numericMaxInvalid, numericEqualInvalid, gte, lte, equalNum) {
        if (!_.isEmpty(this.gte + "") || !_.isEmpty(this.lte + "") || !_.isEmpty(this.equalNum + "")) {
          if (this.$$('paper-radio-group') && this.$$('paper-radio-group').selected == "range") {
            return (numericMaxInvalid || numericMinInvalid)
          } else {
            return numericEqualInvalid
          }
        } else {
          return true;
        }
      },
      /**
       * checks if the min value is less than maximum value in numeric display type popover
       */
      _isMaxGreaterThanMin: function () {
        if (!_.isEmpty(this.gte + "") && !_.isEmpty(this.lte + "")) {
          if (parseFloat(this.gte) > parseFloat(this.lte)) {
            this.set('numericMaxInvalid', true);
          } else {
            this.set('numericMaxInvalid', false);
          }
        } else {
          this.set('numericMaxInvalid', false);
        }
      },

      /**
       * Can be used add a filter tag on selecting it from the dropdown.
       */
      _onSelectedFilterChange: function (e, detail) {
        //Reseting the selected values of the attribute
        this._selectedItems = [];
        var data = detail.data;
        var tag = {};
        tag["value"] = (data.value && !_.isEmpty(data.value)) ? data.value : {
          "eq": "All"
        };
        tag["displayParams"] = (data.displayParams && !_.isEmpty(data.displayParams)) ? data.displayParams : [
          "eq"
        ];
        var dataType = data.dataType;
        var displayType = data.displayType;

        if (displayType == "textCollection") {
          displayType = "textbox";
        }

        // For now, we are not showing LOV for textbox attributes,
        // as system does not know how to return distinct / unique values for given attribute in given search scope.
        // We fix would show textbox only to type freeflow data till we fix the api / get new api
        // if(displayType.toLowerCase() == "textbox") {
        //   displayType = "referenceList";
        // }

        if (displayType == "date") {
          displayType = "datetime";
        }

        if (dataType.toLowerCase() == "integer" || dataType.toLowerCase() == "decimal") {
          displayType = "numeric";
        }

        tag.value["type"] = ConstantHelper.getDataTypeConstant(dataType);

        tag.options = data;
        tag.options.displayType = displayType
        tag["longName"] = data.externalName;
        tag["name"] = data.name;
        this.$$("#filter-tags").addTag(tag);
        this._fireAddEvent(data.name);
        this.$$("#refineFilterPopover").close();        
      },
      /**
       *  Can be used to toggle between the search and filter mode.
       */
      toggleMode: function (e) {
        this.searchMode = !this.searchMode;
      },

      _prepareRequestData: function (contextData) {
        return DataRequestHelper.createEntityGetRequest(contextData);
      },

      // On tag tap should select the specific element 
      _onTagItemTap: function (e, detail) {

        this.currentTag = detail;
        var showTagPopover = true;

        if(detail && detail.value && detail.value.noPopoverOnAttach) {
          if(e.type.indexOf("on-tap-tag-item") == -1) {
            showTagPopover = false; //set only on attach
          }
          delete detail.value.noPopoverOnAttach; //delete, as it is only on attach
        }

        if (this.currentTag && this.currentTag.options.displayType.toLowerCase() == "datetime") {
          var rangePicker = this.$$('#rangepicker');

          //Display range picker based on the currerntTag
          if (this.currentTag.value.eq != 'All') {
            if (this.currentTag.value.eq) {
              rangePicker.startDateValue = this.currentTag.value.eq;
              rangePicker.endDateValue = this.currentTag.value.eq;
            } else {
              rangePicker.startDateValue = this.currentTag.value.gte;
              rangePicker.endDateValue = this.currentTag.value.lte;
            }

            var _date = new Date(rangePicker.startDateValue);
            rangePicker.setDate(_date);
          } else {
            rangePicker.startDateValue = "";
            rangePicker.endDateValue = "";
            rangePicker.setDate(new Date());
          }

          rangePicker.setRangeType(null);

          this.async(function () {
            rangePicker.positionTarget = this.$$('#filter-tags').$$("#tag" + detail.index);
            rangePicker.noOverlap = true;
            if(showTagPopover) {
              rangePicker.show(true);
            }
          });
        } else {
          this._tigger = Date.parse(new Date().toString()); //Just used to trigger popover element

          //Delayed to open the popover, because want to close the existing popover
          this.async(function () {
            var filterPopover = this.$$('#filterPopover');

            filterPopover.positionTarget = this.$$('#filter-tags').$$("#tag" + detail.index);
            if(showTagPopover) {
              filterPopover.show(true);
            }

            //Set values to the components
            if (this.currentTag.options.displayType.toLowerCase() == "textbox") {
              var filterInput = filterPopover.querySelector('.input');
              if (filterInput) {

                filterInput.value = '';

                if (this.currentTag.value.exact && this.currentTag.value.exact != 'All') {
                  filterInput.value = this.currentTag.value.exact;
                }

                this.async(function () {
                  filterInput.focus();
                }, 10); //Delayed to set the value and focus the input
              }
            } else if (this.currentTag.options.displayType.toLowerCase() == "textarea") {
              var filterInput = filterPopover.querySelector('.input');
              if (filterInput) {

                filterInput.value = '';

                if (this.currentTag.value.exact && this.currentTag.value.exact != 'All') {
                  filterInput.value = this.currentTag.value.exact;
                }

                this.async(function () {
                  filterInput.focus();
                }, 10); //Delayed to set the value and focus the input
              }
            } else if (this.currentTag.options.displayType.toLowerCase() == "numeric") {
              this.gte = this.lte = this.equalNum = "";
              if (this.currentTag.value.eq && this.currentTag.value.eq != 'All') {
                filterPopover.querySelector('paper-radio-group').selected = 'equalToDate';
                this.equalNum = this.currentTag.value.eq;
              } else {
                filterPopover.querySelector('paper-radio-group').selected = 'range';
                this.gte = this.currentTag.value.gte || "";
                this.lte = this.currentTag.value.lte || "";

              }
            } else if (this.currentTag.options.displayType.toLowerCase() == "referencelist") {
              //Set Id, Title and Value to the LOV
              var lovComponent = filterPopover.querySelector('#rockEntityLov');

              if (this.currentTag.options.isReferenceType) {
                var titlePattern = "name";
                var options = this.currentTag.options;

                if(options.properties  && options.properties.referenceEntityInfo && options.properties.referenceEntityInfo.length) {
                  titlePattern = options.properties.referenceEntityInfo[0].listTitle;
                }

                lovComponent.idField = "name";
                lovComponent.titlePattern = titlePattern;
                lovComponent.valueField = "name";
                var refEntityTypes = this.currentTag.options.referenceEntityTypes;
                var itemContexts = [];
                for (var i in refEntityTypes) {
                  itemContexts.push({
                    "type": refEntityTypes[i]
                  });
                }
                var contextData = DataHelper.cloneObject(this.contextData);
                contextData[this.CONTEXT_TYPE_ITEM] = itemContexts;
                lovComponent.requestData = this._prepareRequestData(contextData);
              } else {
                lovComponent.idField = this.currentTag.name;
                lovComponent.titlePattern = this.currentTag.name;
                lovComponent.valueField = this.currentTag.name;
                lovComponent.requestData = this._prepareRequestData(this.contextData);
                lovComponent.requestData.params.fields.attributes = [this.currentTag.name];
              }
              lovComponent.reset();
            }
          });
        }
      },

      // Refine filter radio buttons
      _onRadioGroupChange: function () {
        this.gte = this.lte = this.equalNum = "";
      },

      _onLOVConfirmTap: function (e, detail) {
        var selectedItemString = "";
        var selectedItemSearchString = "";
        var selectedItemsObj = this._selectedItems;
        if(selectedItemsObj.length) {
          for(var i=0; i < selectedItemsObj.length; i++) {
            if(selectedItemsObj[i].title)
              selectedItemString = selectedItemString + selectedItemsObj[i].title + " ";
              selectedItemSearchString = selectedItemSearchString + selectedItemsObj[i].title + ", ";
          }
          selectedItemString = selectedItemString.trim();
          selectedItemSearchString = selectedItemSearchString.substr(0,selectedItemSearchString.length-2);
        }
        if (detail && detail.data) {
          this.currentTag.value = {
            "contains": selectedItemString,
            "operator": "_OR"
          }

          this.currentTag.options["selectedItem"] = detail.data;
          this.currentTag.displayValue = detail.data.value;
         
          this.set('tags.' + this.currentTag.index + '.displayValue', selectedItemSearchString);
          this.set('tags.' + this.currentTag.index + '.value',  this.currentTag.value);
        }
       
        this.$$('#filterPopover').hide();
        //Fire event
        this._fireChangeEvent(this.currentTag.name, this.currentTag.value, this.currentTag.options.type);
        
      },

      // Closing the filter popover 
      _onLOVCloseTap: function (e, detail) {
          this.$$("#filterPopover").hide();
      },
	  
      // Refine filter tags will be updated as per selection
      _updateValue: function (e) {
        var dataType = ConstantHelper.getDataTypeConstant(this.currentTag.options.dataType);
        if (this.currentTag.options.displayType.toLowerCase() == "datetime") { //DateTime
        // Note:- For datetime attribute it is necessary to pass dataType as 'datetime' because from UI the 
        //        system is currently passing datetime value instead of date value in range search
          if (this.gte == this.lte) {
          
            this.currentTag.value = {
              "gte": this.gte,
              "lte": this.lte,
              "type": ConstantHelper.getDataTypeConstant("datetime")
            };

            this.currentTag.displayValue = this.displaygte;
          } else {

            this.currentTag.value = {
              "gte": this.gte,
              "lte": this.lte,
              "type": ConstantHelper.getDataTypeConstant("datetime")
            };
            //console.log('range ', JSON.stringify(this.currentTag.value));

            if(this.displaygte == this.displaylte) {
              this.currentTag.displayValue = this.displaygte;
            }
            else {
              this.currentTag.displayValue = this.displaygte + " - " + this.displaylte;  
            }
          }

          this.set('tags.' + this.currentTag.index + '.displayValue', this.currentTag.displayValue);
          this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        } else if (this.currentTag.options.displayType.toLowerCase() == "numeric") { //Radio group
          if (this.$$('paper-radio-group').selected == "range") {
            if (this.gte == "") {
              this.gte = undefined;
            }
            if (this.lte == "") {
              this.lte = undefined;
            }
            if (!(this.gte || this.lte)) {
              this.logWarning("FilterValuesEmpty");
              return;
            } else {
              var gteAsString = (parseFloat(this.gte)).toString();
              var lteAsString = (parseFloat(this.lte)).toString();
              if (!this.gte) {
                this.currentTag.value = {
                  "gte": this.gte,
                  "lte": lteAsString,
                  "type": dataType
                };
                this.currentTag.displayValue = "<= " + lteAsString;
              } else if (!this.lte) {
                this.currentTag.value = {
                  "gte": gteAsString,
                  "lte": this.lte,
                  "type": dataType
                };
                this.currentTag.displayValue = ">= " + gteAsString;
              } else {
                this.currentTag.value = {
                  "gte": gteAsString,
                  "lte": lteAsString,
                  "type": dataType
                };
                this.currentTag.displayValue = gteAsString + " - " + lteAsString;
              }
            }
          } else {
            if (!this.equalNum) {
              this.logWarning("FilterValuesEmpty");
              return;
            } else {
              var parsedValue = parseFloat(this.equalNum);
              this.currentTag.value = {
                "eq": parsedValue.toString(),
                "type": dataType
              };
              this.currentTag.displayValue = parsedValue.toString();
            }
          }

          this.set('tags.' + this.currentTag.index + '.displayValue', this.currentTag.displayValue);
          this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        } else if (this.currentTag.options.displayType.toLowerCase() == "boolean") { //boolean
          this.currentTag.value = {
            "eq": this.booleanvalue,
            "type": dataType
          };
          this.currentTag.displayValue = this.booleanvalue;
          this.set('tags.' + this.currentTag.index + '.displayValue', this.currentTag.displayValue);
          this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        } else { //TextArea
          if (!this.tav) {
            this.logWarning("FilterValuesEmpty");
            return;
          }

          var operator;
          this.currentTag.displayValue = this.tav;
          var splitQueryByAnd = this.tav.toLowerCase().split(' and ');
          var splitQueryByOr = this.tav.toLowerCase().split(' or ');

          if (splitQueryByAnd.length > 1) {
              operator = "_AND";
              this.tav = splitQueryByAnd;
          } else if (splitQueryByOr.length > 1) {
              operator = "_OR";
              this.tav = splitQueryByOr;
          }

          if(operator) {
             // exact or contains operator
            this.currentTag.value = {
              "contains": this.tav.join(' '),
              "type": dataType,
              "operator": operator
            };
          } else {
             this.currentTag.value = {
              "exact": this.tav,
              "type": dataType
            };
          }

          this.set('tags.' + this.currentTag.index + '.displayValue', this.currentTag.displayValue);
          this.set('tags.' + this.currentTag.index + '.value', this.currentTag.value);
        }

        //Close the popover once value updated
        if (this.currentTag.options.displayType.toLowerCase() == "datetime") {
          this.$$('#rangepicker').hide();
        } else {
          this.$$('#filterPopover').hide();
        }

        //Fire event
        this._fireChangeEvent(this.currentTag.name, this.currentTag.value);
      },

      _fireChangeEvent: function (_name, _value, _type) {
        var attribute = {
          name: _name,
          value: _value,
          type: _type
        };
        if (_name) {
          this.fireBedrockEvent('tag-value-change', attribute, {
            ignoreId: true
          });
        }
      },

      _fireAddEvent: function (_name, _value, _type) {
        var attribute = {
          name: _name
        };
        if (_name) {
          this.fireBedrockEvent('tag-item-added', attribute, {
            ignoreId: true
          });
        }
      },

      // When tag tapped, which popover component need to show
      _showTagModifier: function (displayType) {
        if (this.currentTag && this.currentTag.options.displayType.toLowerCase() == displayType.toLowerCase()) {
          return true;
        }

        return false;
      },

      //Hide the popover
      _dismissDialog: function () {
        this.$$('#filterPopover').hide();
      },
      _openFilterLov: function () {
        this.$$("#refineFilterPopover").open();
      },
      _openEntityTypeFilterLov: function () {
        this.$$("#entityTypeFilterPopover").open();
      }
    });
  </script>
</dom-module>