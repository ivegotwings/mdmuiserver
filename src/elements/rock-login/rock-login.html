<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-externalref-socketio/bedrock-externalref-socketio.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../pebble-button/pebble-button.html" />
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-main-logo/pebble-main-logo.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-styles-app/pebble-styles-app.html">
<link rel="import" href="../pebble-main-logo/pebble-main-logo.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">


<!--
`<rock-login>` Represents an element to render the login page for the authentication of the user.

### Example

    <rock-login is-authenticated="{{isAuth}}" auth-response="{{authResponse}}"></rock-login>


@group rock Elements
@element rock-login
@demo demo/index.html
-->

<dom-module id="rock-login">
        <template>
        <style include="pebble-styles-app"></style>
            <style include="pebble-styles-shared">
                    .login {
                        width: 100%;
                        position: absolute;
                        top: 0;
                        left: 0;
                        bottom: 0;
                        margin: 0;
                        background-color: var(--login-page-bg);
                    }
        
                    .mask {
                        width: 650px;
                        height: 540px;
                        display: block;
                        position: relative;
                        margin: 60px auto 0 auto;
                        border-radius: 3px;
                        background-color: var(--login-wrapper-bg);
                        -webkit-box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
                        -moz-box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
                        -o-box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
                        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
                    }
        
                    .loginlogo {
                        padding-top: 93px;
                        position: relative;
                        text-align: center;
                    }
        
                    .login-Content {
                        margin: 25px auto 0;
                        width: 350px;
                    }
        
                    #staySignedIn {
                        color: var(--color-steal-grey, #75808b);
                    }
        
                    .login-Checkbox {
                        width: 15px;
                        height: 15px;
                        border-radius: 3px;
                        background-color: var(--palette-white, #fff);
                        border: solid 1px var(--textbox-border, #d2d8de);
                    }
        
                    .login-Text {
                        width: 76px;
                        height: 15px;
                        font-size: var(--font-size-sm, 12px);
                        font-weight: normal;
                        font-style: normal;
                        font-stretch: normal;
                        line-height: 22px;
                        vertical-align: text-top;
                        color: var(--color-steal-grey, #75808b);
                    }
        
                    .footerbg {
                        background-image: url('../../images/illustration.svg');
                        background-repeat: no-repeat;
                        width: 649px;
                        height: 82px;
                        position: absolute;
                        bottom: 0;
                        right: 0;
                        left: 0;
                    }
        
                    .copyright {
                        position: absolute;
                        left: 0;
                        right: 0;
                        bottom: -65px;
                        font-family: var(--default-font-family);
                        font-size: var(--font-size-sm, 12px);
                        font-weight: normal;
                        font-style: normal;
                        font-stretch: normal;
                        line-height: 1.4;
                        text-align: center;
                        color: var(--palette-white, #fff);
                    }
        
                    .forgot-div {
                        text-align: right;
                        font-size: var(--font-size-sm, 12px);
                        color: var(--link-text-color, #036bc3);
                        cursor: pointer;
                        margin-top: 25px;
                    }
        
                    .logoimg {
                        width: 200px;
                        height: 60px;
                    }
        
                    .checkbox-wrapper {
                        display: inline-block;
                        vertical-align: middle;
                        font-size: var(--font-size-sm, 12px);
                        color: var(--color-steal-grey, #75808b);
                    }
        
                    .checkbox-wrapper pebble-checkbox {
                        --pebble-checkbox-label: {
                            color: var(--secondary-button-text-color, #75808b);
                            vertical-align: bottom;
                        }
                    }
        
                    .checkboxText {
                        padding-top: 5px;
                        float: left;
                    }
        
                    pebble-checkbox {
                        line-height: 17px;
                    }
        
                    pebble-checkbox {
                        --pebble-checkbox-container: {
                            margin-right: 5px;
                        }
                        ;
                    }
                </style>
            <style include="pebble-styles-app"></style>
            <div class="login">
                <div class="mask">
                    <div class="loginlogo">
                        <img src="/src/images/loginlogo.svg" class="logoimg" on-logo-click="onLogoClick">
                    </div>
                    <div class="login-Content">
                        <pebble-textbox value="{{_userName}}" label="USERNAME"></pebble-textbox>
                        <pebble-textbox type="password" value="{{_password}}" on-keyup="_loginOnEnter" label="PASSWORD"></pebble-textbox>
                        <div class="forgot-div">
                            <span on-tap="_onForgotTap">Forgot Password</span>
                        </div>
                        <div class="checkboxText m-t-20">
                            <div class="checkbox-wrapper">
                                <pebble-checkbox noink checked="{{_isStaySignedIn}}">Stay Signed In</pebble-checkbox>
                            </div>
                        </div>
                        <pebble-button id="loginButton" class="btn btn-success m-t-20 pull-right" button-text="Login" raised on-tap="_onTapLogin"></pebble-button>
                    </div>
                    <div class="footerbg"></div>
                    <div class="copyright">Powered by Riversand Data Platform <br>Copyright @ Riversand 2017</div>
                </div>
            </div>
        </template>
        <script>
            Polymer({
                is: "rock-login",
                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    userStore: {
                        type: Object
                    },
                    /**
                     * Indicates user name
                     */
                    _userName: {
                        type: String,
                        value: null
                    },

                    /**
                     * Indicates password
                     */
                    _password: {
                        type: String,
                        value: null
                    },

                    /*
                     * Indicates tenant id
                     */
                    _tenantId: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Indicates to store the credentials in cookies
                     */
                    _isStaySignedIn: {
                        type: Boolean,
                        value: false
                    },

                    /*
                    * Indicates role id, it can have multiple roles as comma separated string
                    */
                    _roleId: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Specifies whether or not a user is authenticated.
                     */
                    isAuthenticated: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    /**
                     * Indicates the user authentication response.
                     */
                    authResponse: {
                        type: Object,
                        value: function () { return {}; },
                        notify: true
                    }
                },

                _onTapLogin: function () {
                    this.isAuthenticated = this._isValid();

                    if (this.isAuthenticated) {
                        this.authResponse = {
                            "isSuccessful": true,
                            "userDetails": {
                                "userName": this._userName,
                                "userFullName": this._userName,
                                "isStaySignedIn": this._isStaySignedIn,
                                "isAuthenticated": this.isAuthenticated,
                                "tenantId": this._tenantId,
                                "roleId": this._roleId
                            }
                        };
                    }
                    else {
                        this.authResponse = {
                            "isSuccessful": false,
                            "errorDetails": {
                                "message": "Please provide valid credentials and make sure that tenant is appended in URL"
                            }
                        };
                    }
                },

                _isValid: function () {
                    var userStore = this.userStore;

                    if (userStore) {
                        if (userStore.users && userStore.users.length) {
                            var validUser = Array.prototype.filter.call(userStore.users, function (user) {
                                return user.userName == this._userName && user.password == this._password;
                            }, this);
                            if (validUser && validUser.length) {
                                var mainApp = document.querySelector("main-app");
                                if (!mainApp.tenantId || mainApp.tenantId == "") {
                                    return false;
                                }
                                this._roleId = validUser[0].roles;
                                this._tenantId = mainApp.tenantId;
                                return true;
                            }
                        }
                    }

                    return false;
                },

                _onForgotTap: function () {
                    // Add logic here for forgot link clicked
                },

                _loginOnEnter: function (e) {
                    if (e.keyCode === 13) {
                        this._onTapLogin();
                    }
                }

            });
        </script>
</dom-module>