<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">

<link rel="import" href="../pebble-button/pebble-button.html" />
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-main-logo/pebble-main-logo.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-styles-app/pebble-styles-app.html">
<link rel="import" href="../pebble-main-logo/pebble-main-logo.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">


<!--
`<rock-login>` Represents an element to authenticate user.

### Example

    <rock-login is-authenticated="{{isAuth}}" auth-response="{{authResponse}}"></rock-login>


@group rock Elements
@element rock-login
@demo demo/index.html
-->

<dom-module id="rock-login">
    <style is="custom-style" include="pebble-styles-shared">
        .login {
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            margin: 0;
            background-color: var(--login-page-bg);
        }
        
        .mask {
            width: 650px;
            height: 540px;
            display: block;
            position: relative;
            margin: 60px auto 0 auto;
            border-radius: 3px;
            background-color: var(--login-wrapper-bg);
            -webkit-box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
            -moz-box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
            -o-box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.34);
        }
        
        .loginlogo {
            padding-top: 93px;
            position: relative;
            text-align: center;
        }
        
        .login-Content {
            margin: 25px auto 0;
            width: 350px;
        }
        
        #staySignedIn {
            color: var(--color-steal-grey, #75808b);
        }
        
        .login-Checkbox {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            background-color: var(--palette-white, #fff);
            border: solid 1px var(--textbox-border, #d2d8de);
        }
        
        .login-Text {
            width: 76px;
            height: 15px;
            font-size: var(--font-size-sm, 12px);
            font-weight: normal;
            font-style: normal;
            font-stretch: normal;
            line-height: 22px;
            vertical-align: text-top;
            color: var(--color-steal-grey, #75808b);
        }
        
        .footerbg {
            background-image: url('../../images/illustration.svg');
            background-repeat: no-repeat;
            width: 649px;
            height: 82px;
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
        }
        
        .copyright {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -65px;
            font-family: var(--default-font-family);
            font-size: var(--font-size-sm, 12px);
            font-weight: normal;
            font-style: normal;
            font-stretch: normal;
            line-height: 1.4;
            text-align: center;
            color: var(--palette-white, #fff);
        }
        
        .forgot-div {
            text-align: right;
            font-size: var(--font-size-sm, 12px);
            color: var(--link-text-color, #036bc3);
            cursor: pointer;
            margin-top: 25px;
        }
        
        .logoimg {
            width: 200px;
            height: 60px;
        }
        
        .checkbox-wrapper {
            display: inline-block;
            vertical-align: middle;
            font-size: var(--font-size-sm, 12px);
            color: var(--color-steal-grey, #75808b);
        }
        
        .checkbox-wrapper pebble-checkbox::shadow #checkboxLabel {
            color: var(--secondary-button-text-color, #75808b);
            vertical-align: bottom;
        }
        
        .checkboxText {
            padding-top: 5px;
            width: calc( 100% - 78px);
            float: left;
        }
        
        pebble-checkbox {
            line-height: 17px;
        }
        
        pebble-checkbox::shadow #checkboxContainer {
            margin-right: 5px;
        }
    </style>
    <style is="custom-style" include="pebble-styles-app"></style>
    <template>
        <div class="login">
            <div class="mask">
                <div class="loginlogo">
                    <img src="/src/images/loginlogo.svg" class="logoimg" on-logo-click="onLogoClick">
                </div>
                <div class="login-Content">
                    <pebble-textbox value="{{_userName}}" label="USERNAME"></pebble-textbox>
                    <pebble-textbox type="password" value="{{_password}}" on-keyup="_loginOnEnter" label="PASSWORD"></pebble-textbox>
                    <div class="forgot-div">
                        <span on-tap="_onForgotTap">Forgot Password</span>
                    </div>
                    <div class="checkboxText m-t-20">
                        <div class="checkbox-wrapper">
                            <pebble-checkbox noink checked="{{_isStaySignedIn}}">Stay Signed In</pebble-checkbox>
                        </div>
                    </div>
                    <pebble-button id="loginButton" class="btn btn-success m-t-20" button-text="Login" raised on-tap="_onTapLogin"></pebble-button>
                </div>
                <div class="footerbg"></div>
                <div class="copyright">Powered by Riversand Data Platform <br>Copyright @ Riversand 2017</div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "rock-login",
            properties: {
                userStore: {
                    type: Object
                },
                /**
                 * Indicates user name
                 */
                _userName: {
                    type: String,
                    value: null
                },

                /**
                 * Indicates password
                 */
                _password: {
                    type: String,
                    value: null
                },

                /*
                 * Indicates tenant id
                 */
                _tenantId: {
                    type: String,
                    value: ''
                },

                /**
                 * Indicates to store the credentials in cookies
                 */
                _isStaySignedIn: {
                    type: Boolean,
                    value: false
                },

                 /*
                 * Indicates role id, it can have multiple roles as comma separated string
                 */
                 _roleId: {
                    type: String,
                    value: ''
                },

                /**
                 * Specifies whether or not a user is authenticated.
                 */
                isAuthenticated: {
                    type: Boolean,
                    value: false,
                    notify: true
                },

                /**
                 * Indicates the user authentication response.
                 */
                authResponse: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true
                }
            },

            _onTapLogin: function () {
                this.isAuthenticated = this._isValid();

                if (this.isAuthenticated) {
                    this.authResponse = {
                        "isSuccessful": true,
                        "userDetails": {
                            "userName": this._userName,
                            "isStaySignedIn": this._isStaySignedIn,
                            "isAuthenticated": this.isAuthenticated,
                            "tenantId": this._tenantId,
                            "roleId": this._roleId
                        }
                    };
                }
                else {
                    this.authResponse = {
                        "isSuccessful": false,
                        "errorDetails": {
                            "message": "Please provide valid credentials and make sure that tenant is appended in URL"
                        }
                    };
                }
            },

            _isValid: function () {
                if (this.userStore) {
                    var userStore = DataHelper.getValue(this.userStore, "user-store");
                    if (userStore) {
                        var configValue = userStore.components["user-config"];
                        if (configValue) {
                            userStore = DataHelper.getValue(configValue, "config");
                            if (userStore && userStore.users && userStore.users.length) {
                                var validUser = Array.prototype.filter.call(userStore.users, function (user) {
                                    return user.userName == this._userName && user.password == this._password;
                                }, this);
                                if (validUser && validUser.length) {
                                    var mainApp = document.querySelector("main-app");
                                    if (!mainApp.tenantId || mainApp.tenantId == "") {
                                        return false;
                                    }
                                    this._roleId = validUser[0].roles;
                                    this._tenantId = mainApp.tenantId;
                                    return true;
                                }
                            }
                        }
                    }
                }
                return false;
            },

            _onForgotTap: function () {
                // Add logic here for forgot link clicked
            },

            _loginOnEnter: function (e) {
                if (e.keyCode === 13) {
                    this._onTapLogin();
                }
            }

        });
    </script>
</dom-module>