<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">


<script>
    'use strict';
    let ModelManager = (function () {

        let _contextModels;
        let _entityTypes;

        async function _init() {
            _getEntityTypes();
        }

        function _getEntityTypes() {
            var liquidEntityCustomElement = customElements.get("liquid-entity-model-get");
            var liquidEntityModelGet = new liquidEntityCustomElement();
            liquidEntityModelGet.addEventListener("response", _onGetEntityTypesResponse);
            liquidEntityModelGet.addEventListener("error", _onGetEntityTypesError);
            liquidEntityModelGet.requestId = "";
            liquidEntityModelGet.operation = "searchandget";

            var contextData = {};
            var itemContext = {
                "type": "entityType",
            };
            // itemContext.domain = "thing";
            contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

            var req = DataRequestHelper.createEntityGetRequest(contextData);
            delete req.params.options.maxRecords;

            req.params.fields.attributes = ["externalName"];
            liquidEntityModelGet.requestData = req;
            liquidEntityModelGet.generateRequest();
        }

        function _onGetEntityTypesResponse(ev) {
            if (ev && ev.detail && ev.detail.response && ev.detail.response.content) {
                var entityTypes = ev.detail.response.content.entityModels;
                _entityTypes = [];
                entityTypes.forEach(element => {
                    if (element && !_.isEmpty(element)) {
                        _entityTypes.push(element.name);
                    }
                });

                if (!_.isEmpty(_entityTypes)) {
                    _getContextModelBasedOnEntityTypes();
                }
            }
        }

        function _onGetEntityTypesError(ev) {
            console.log(ev)
        }

        function _getContextModelBasedOnEntityTypes() {
            var liquidEntityCustomElement = customElements.get("liquid-rest");
            var liquidEntityModelGet = new liquidEntityCustomElement();

            liquidEntityModelGet.url = "/data/pass-through/entitymodelservice/getcontext";
            liquidEntityModelGet.method = "POST";

            liquidEntityModelGet.addEventListener("liquid-response", _onContextModelGetReponse);
            liquidEntityModelGet.addEventListener("liquid-error", _onContextModelGetFailed);

            var contextData = {};
            var itemContext = {
                "type": "entityContextModel",
                "ids": ""
            };
            // itemContext.domain = "thing";
            contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
            contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
            contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
            var req = DataRequestHelper.createEntityGetRequest(contextData);
            delete req.params.options.maxRecords;
            req.params.fields.attributes = ["externalName"];
            liquidEntityModelGet.requestData = req;
            liquidEntityModelGet.generateRequest();
        }

        function _onContextModelGetReponse(ev) {
            if (ev && ev.detail && ev.detail.response && ev.detail.response.response && ev.detail.response.response.entityModels) {
                var entityModels = ev.detail.response.response.entityModels;
                if (!_.isEmpty(entityModels)) {
                    _contextModels = {};
                    entityModels.forEach(element => {
                        if (element && !_.isEmpty(element)) {
                            _contextModels[element.name] = element;
                        }
                    });
                }
            }
        }

        function _onContextModelGetFailed(ev) {
            console.log(ev)
        }

        let modelManagerInstance;

        class ModelManager {
            constructor() {
                if (!modelManagerInstance) {
                    _init();
                    modelManagerInstance = this;
                }

                return modelManagerInstance;
            }

            async getContextModelByEntityType(entityType) {
                if(!_contextModels) {
                    await _init();
                }
                return _contextModels[entityType];
            }
        }

        return modelManagerInstance = new ModelManager();;
    }());

</script>