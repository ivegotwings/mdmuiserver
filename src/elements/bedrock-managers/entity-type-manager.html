<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<script>
    'use strict';

    var EntityTypeManager = (function(){
        var entityTypeByIds;
        var promiseResolve;
        //Private methods
        function _generateRequest(){
            var liquidEntityCustomElement = customElements.get("liquid-entity-model-get");
            var liquidEntityModelGet = new liquidEntityCustomElement();
            liquidEntityModelGet.addEventListener("response", _onResponse.bind(this));
            liquidEntityModelGet.addEventListener("error", _onError.bind(this));
            liquidEntityModelGet.requestId = "";
            liquidEntityModelGet.operation = "searchandget";
            var contextData = {};
            var itemContext = {
                "type": "entityType",
            };
            // itemContext.domain = "thing";
            contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
            contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
            contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
            var req = DataRequestHelper.createEntityGetRequest(contextData);
            delete req.params.options.maxRecords;
            req.params.fields.attributes = ["externalName"];
            liquidEntityModelGet.requestData = req;
            liquidEntityModelGet.generateRequest();
        }
        function _onResponse(ev) {
            if (ev && ev.detail && ev.detail.response && ev.detail.response.content) {
                var entityTypes = ev.detail.response.content.entityModels;
                entityTypeByIds = {}
                entityTypes.forEach(element => {
                    if (element && !_.isEmpty(element)) {
                        entityTypeByIds[element.id] = element;
                    }
                });
            }
            if (promiseResolve) {
                promiseResolve();
            }
        }
        function _onError(ev) {
            console.log(ev)
        }
        function _triggerRequest(data) {
            return new Promise((resolve, reject) => {
                promiseResolve = resolve;
                _generateRequest();
            })
        }
        function _getExternalNameById(entityTypeId) {
            var _entityTypeId = entityTypeId + "_entityType";
            var obj = entityTypeByIds[_entityTypeId];
            if (obj && !_.isEmpty(obj) && obj.properties && obj.properties.externalName) {
                return obj.properties.externalName;
            }
            return entityTypeId;
        }
        async function _getExternalNameByIdAsync(entityTypeId) {
            if (entityTypeByIds) {
                return _getExternalNameById(entityTypeId);
            } else {
                var callLiquid = await _triggerRequest(entityTypeId);
                return _getExternalNameById(entityTypeId);
            }
        }

        //Public methods
        return {
            getTypeExternalNameByIdAsync: async function(id){
                return await _getExternalNameByIdAsync(id);
            },
            getTypeExternalNameById:function(id){
                return _getExternalNameById(id);
            }
        }
    })();

</script>