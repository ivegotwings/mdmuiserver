<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/liquid-response-helper.html">
<link rel="import" href="../bedrock-logger-behavior/bedrock-logger-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<script>
    class FileDownloadManager
                    
        extends Polymer.mixinBehaviors([
            RUFBehaviors.LoggerBehavior
        ], Polymer.Element) {

        static get is() {
            return "file-download-manager";
        }

        constructor() {
            super();
            this.requestData;
            this.parentObj;
            if (!RUFUtilities.fileDownloadManager) {
                RUFUtilities.fileDownloadManager = this;
            }
            return RUFUtilities.fileDownloadManager;
        }
        
        /**
         * Function to get the FileDownloadManager instance 
         */ 
        static getInstance() {
            if (!RUFUtilities.fileDownloadManager) {
                RUFUtilities.fileDownloadManager = new FileDownloadManager();;
            }
            return RUFUtilities.fileDownloadManager;
        } 

        /**
         * Function to download a file 
         */ 
        downloadFile(fileDetails,isLargeFile,parentObj){
            this.parentObj = {};
            if(parentObj) {
                this.parentObj = parentObj;
            }
            if(!fileDetails) {
                this.logError('No File to download');
                return;
            }
            const {
                fileId,
                fileName,
                fileType,
                fileExtension,
                taskType
            } = fileDetails;

            if (!isLargeFile) {
                let req = {
                    "params": {
                        "query": {
                            "id": fileId
                        }
                    },
                    fileName,
                    fileType,
                    fileExtension,
                    taskType
                }

                let _this = this;
                RUFUtilities.fileDownload("/data/binaryobjectservice/downloadBinaryObject", {
                    httpMethod: 'POST',
                    data: {
                        data: JSON.stringify(req)
                    },
                    fileName: fileName,
                    successCallback: function (url) {
                        this._onSuccess();                                     
                    }.bind(_this),
                    failCallback: function (responseHtml, url, error) {
                        this._onError(error);
                    }.bind(_this)
                });
            } else {
                this._downloadLargeFile(fileId);
            }
        }
        
        /**
         * Function to trigger a request to download large file 
         */ 
        _downloadLargeFile(fileId){
            this.requestData = {};
            let binaryStreamObjects = [];
            if (fileId) {
                binaryStreamObjects.push({
                    "binaryStreamObject": {
                        "id": fileId,
                        "type": "importDataStream",
                        "data": {}
                    }
                })
            }
           
            if (!_.isEmpty(binaryStreamObjects)) {
                this.requestData = binaryStreamObjects;
                this._triggerRequest();                              
            } else {
                this._onError("No binaryStreamObjects found");
            }
        }
        
        /**
         * Function to handle file download error
         */ 
        _onError(ev){
            let detail = "";
            if(ev){
                if(ev.detail) {
                    detail = ev.detail;
                } else {
                    detail = ev;
                }
            }
            this.logError('File download failed', detail);
            if(this.parentObj && this.parentObj.onFileDownloadFailure) {
                this.parentObj.onFileDownloadFailure(ev);
            }
        }
        
        /**
         * Function to handle file download success
         */ 
        _onSuccess(){
            this.logInfo('File download success'); 
            if(this.parentObj && this.parentObj.onFileDownloadSuccess) {
                this.parentObj.onFileDownloadSuccess(); 
            }
        }

        /**
         * Function to trigger a liquid call to download a large file in a new window
         */ 
        _triggerRequest() {
            return new Promise((resolve, reject) => {
                this._generateRequest(resolve);
            })
        }
        
        /**
         * Function to generate a request for a liquid call to download a large file in new window
         */ 
        _generateRequest(resolve) {
            let liquidRestCustomElement = customElements.get("liquid-rest");
            let liquidObj = new liquidRestCustomElement();
            liquidObj.url = "/data/binarystreamobjectservice/prepareDownload";
            liquidObj.method = "POST";

            let _onResponse = (e) => {
                if (DataHelper.isValidObjectPath(e, "detail.response.response")) {
                    LiquidResponseHelper.downloadURLResponseMapper(e, downloadURL => {
                        window.open(downloadURL, "_blank");
                    });
                    this._onSuccess();
                } else {
                    this._onError("Null response");
                }
                if (resolve) {
                    resolve();
                }
            };

            liquidObj.addEventListener("response", _onResponse.bind(this));
            liquidObj.addEventListener("error", this._onError.bind(this));
            liquidObj.requestId = "";

            liquidObj.requestData = this.requestData;
            liquidObj.generateRequest();
        }
    }
    customElements.define(FileDownloadManager.is, FileDownloadManager);
</script>