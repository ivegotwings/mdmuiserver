<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-logger-behavior/bedrock-logger-behavior.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-merge-helper.html">

<script>
    class EntityCompositeModelManager
        extends Polymer.mixinBehaviors([
            RUFBehaviors.LoggerBehavior
        ], Polymer.Element) {

        static get is() {
            return "entity-composite-model-manager";
        }

        constructor() {
            super();
            let entityCompositeModelManager = this;
            return entityCompositeModelManager;
        }

        _triggerRequest(requestData, coalesceOptions) {
            return new Promise((resolve, reject) => {
                if(_.isEmpty(coalesceOptions)) {
                    this._generateModelGetRequest(resolve, requestData);
                } else {
                    this._generateModelRestRequest(resolve, requestData);
                }
            }, this)
        }

        _generateModelGetRequest(resolve, requestData) {
            let liquidEntityCustomElement = customElements.get("liquid-entity-model-get");
            let liquidEntityModelGet = new liquidEntityCustomElement();

            let _onResponse = (ev) => {
                if (DataHelper.isValidObjectPath(ev, "detail.response.content.entityModels.0")) {
                    this.compositeModel = ev.detail.response.content.entityModels[0];
                }

                if (resolve) {
                    resolve();
                }
            };

            liquidEntityModelGet.addEventListener("response", _onResponse.bind(this));
            liquidEntityModelGet.addEventListener("error", this._onError.bind(this));
            liquidEntityModelGet.operation = "getbyids";
            liquidEntityModelGet.requestData = requestData;
            liquidEntityModelGet.useModelCoalesce = requestData.useModelCoalesce;
            liquidEntityModelGet.generateRequest();
        }

        _generateModelRestRequest(resolve, requestData) {
            let liquidEntityCustomElement = customElements.get("liquid-rest");
            let liquidEntityModelGet = new liquidEntityCustomElement();

            let _onResponse = (ev) => {
                if (DataHelper.isValidObjectPath(ev, "detail.response.response.entityModels.0")) {
                    this.compositeModel = ev.detail.response.response.entityModels[0];
                }

                if (resolve) {
                    resolve();
                }
            };

            liquidEntityModelGet.addEventListener("liquid-response", _onResponse.bind(this));
            liquidEntityModelGet.addEventListener("liquid-error", this._onError.bind(this));
            liquidEntityModelGet.url = "/data/pass-through-model/compositemodelget";
            if(DataHelper.isValidObjectPath(requestData, "params.query.name")) {
                requestData.params.query.id = requestData.params.query.name + "_entityCompositeModel";
                delete requestData.params.query.name;
            }
            liquidEntityModelGet.requestData = requestData;
            liquidEntityModelGet.generateRequest();
        }

        _onError(e) {
            this.logError('Entity composite model get failed', e.detail);
            this.dispatchEvent(new CustomEvent("error", { detail:e.detail, bubbles: this.bubbles, composed:true }));
            this.dispatchEvent(new CustomEvent("liquid-error", { detail:e.detail, bubbles: this.bubbles, composed:true }));
        }

        async get(requestData) {
            if(!_.isEmpty(requestData)) {
                this.compositeModel;
                this.enhancerAttributes;
                let currentActiveApp = ComponentHelper.getCurrentActiveApp();
                let contextData = {};
                if(currentActiveApp) {
                    contextData = currentActiveApp.contextData;
                }
                let query = requestData.params.query;
                let options = requestData.params.options;
                let coalesceOptions;
                if(requestData.applyEnhancerCoalesce) {
                    coalesceOptions = await this._getCoalesceOptions(contextData);
                }
                if (!query.contexts) {
                    query.contexts = [];
                }
                if (!query.filters) {
                    query.filters = {};
                }

                if(!_.isEmpty(coalesceOptions)) {
                    options = options || {};
                    options["coalesceOptions"] = coalesceOptions;
                    requestData.params.options = options;
                }

                query.filters.typesCriterion = ["entityCompositeModel"];
                let callLiquid = await this._triggerRequest(requestData, coalesceOptions);
                return this.compositeModel;
            }
        }

        async _getCoalesceOptions(contextData) {
            let coalesceOptions = {};
            let itemContext = ContextHelper.getFirstItemContext(contextData);
            let domainContext = ContextHelper.getFirstDomainContext(contextData);
            let dataContext = ContextHelper.getFirstDataContext(contextData);
            if(itemContext && itemContext.id &&
                domainContext && domainContext.domain) {
                    let enhancerAttributeNames = await ContextModelManager.getEnhancerAttributeNamesBasedOnDomainAndContext(domainContext.domain, dataContext);
                    if(!_.isEmpty(enhancerAttributeNames)) {
                        itemContext.attributeNames = enhancerAttributeNames;
                        let callLiquid = await this._getEntityAsync(contextData);

                        if(!_.isEmpty(this.enhancerAttributes)) {
                            coalesceOptions = this._prepareCoalesceOptions(dataContext);
                        }
                    }
            }

            return coalesceOptions;
        }

        async _getEntityAsync(contextData, enhancerAttributes) {
            return new Promise((resolve, reject) => {
                this._getEntity(resolve, contextData, enhancerAttributes);
            }, this);
        }

        _getEntity(resolve, contextData, enhancerAttributes) {
            let liquidEntityCustomElement = customElements.get("liquid-entity-data-get");
            let liquidEntityDataGet = new liquidEntityCustomElement();

            let _onResponse = (ev) => {
                if (DataHelper.isValidObjectPath(ev, "detail.response.content.entities.0")) {
                    let entity = ev.detail.response.content.entities[0];
                    let firstDataContext = ContextHelper.getFirstDataContext(contextData);
                    let mergedAttributes = {};
                    if (entity && entity.data && entity.data.attributes) {
                        mergedAttributes = DataMergeHelper.mergeAttributes(mergedAttributes, entity.data.attributes, true);
                    }

                    if (firstDataContext) {
                        let ctxAttributes = SharedUtils.DataObjectFalcorUtil.getAttributesByCtx(entity, firstDataContext);
                        mergedAttributes = DataMergeHelper.mergeAttributes(mergedAttributes, ctxAttributes, true);
                    }
                    this.enhancerAttributes = mergedAttributes;
                }

                if (resolve) {
                    resolve();
                }
            };

            let request = DataRequestHelper.createEntityGetRequest(contextData,true);
            liquidEntityDataGet.addEventListener("response", _onResponse.bind(this));
            liquidEntityDataGet.addEventListener("error", this._onError.bind(this));
            liquidEntityDataGet.operation = "getbyids";
            liquidEntityDataGet.requestData = request;
            liquidEntityDataGet.generateRequest();
        }

        _prepareCoalesceOptions(dataContext) {
            let coalesceOptions = {};
            let enhancerAttributes = [];
            let isContextPresent = false;

            if(!_.isEmpty(dataContext)) {
                isContextPresent = true;
            }

            Object.keys(this.enhancerAttributes).forEach(function(attributeName) {
                let values = this.enhancerAttributes[attributeName].values;
                for(let valIdx =0; valIdx<values.length; valIdx++) {
                    let obj = {};
                    obj[attributeName] = values[valIdx].value;
                    if(isContextPresent) {
                        obj["contexts"] = [dataContext];
                    }
                    enhancerAttributes.push(obj);
                }
            }, this);

            coalesceOptions["enhancerAttributes"] = enhancerAttributes;

            return coalesceOptions;
        }
    }

    customElements.define(EntityCompositeModelManager.is, EntityCompositeModelManager);
</script>