
<link rel="import" href="../bedrock-helpers/context-helper.html">

<script>
    'use strict';
    
    class NavigationManager {
        constructor() {
            if (!RUFUtilities.navigationManager) {
                RUFUtilities.navigationManager = this;
            }
            this._storedNavData = this._readStorage();
            return RUFUtilities.navigationManager;
        }
        static getInstance() {
            if (!RUFUtilities.navigationManager) {
                RUFUtilities.navigationManager = new NavigationManager();
            }
            return RUFUtilities.navigationManager;
        }
        
        _writeStorage(_dataObj){
            sessionStorage.setItem('navigationData', JSON.stringify(_dataObj));
        }
        _readStorage(){
            let obj = sessionStorage.getItem('navigationData');
            let navDataObj = {};
            if(!obj){
                return navDataObj;
            }
            navDataObj =  JSON.parse(obj);
            return navDataObj;
        }
        _getPageFromUrl(){
            let page = "";
            let queryParamSplit = location.href.split("?");
            if(queryParamSplit.length){
                let urlWithoutParam = queryParamSplit[0];
                if(urlWithoutParam){
                    let slashIndex = urlWithoutParam.lastIndexOf("/")+1;
                    page = urlWithoutParam.substr(slashIndex, urlWithoutParam.length);
                }
            }
            return page;
        }
        _getQueryParamsFromUrl(param){
            let mainApp = RUFUtilities.mainApp;
            if (mainApp && mainApp.pageRoute && mainApp.pageRoute.__queryParams && param in mainApp.pageRoute
                .__queryParams) {
                let paramValue = mainApp.pageRoute.__queryParams[param];
                if (paramValue) {
                    return paramValue;
                }
            }
        }
        getNavData(domain, parentId, childId, _page){
            if(this._storedNavData[domain]){
                let page = _page ? _page : this._getPageFromUrl();
                let pageLevelNav;
                if(page && (page == "entity-manage")){
                    let e_id = this._getQueryParamsFromUrl("id");
                    pageLevelNav = this._storedNavData[domain][page][e_id];
                }else{
                    pageLevelNav = this._storedNavData[domain][page];
                }
                if(pageLevelNav && !_.isEmpty(pageLevelNav) && parentId){
                    let parentObj = pageLevelNav[parentId];
                    if(parentObj && !_.isEmpty(parentObj)){
                        if(childId){
                            return parentObj[childId];
                        }else{
                            return parentObj;
                        }
                    }
                }
                return pageLevelNav;
            }
            return {}
        }
        
        setNavData(domain, parentId, childId, property, value){
            if(!this._storedNavData[domain]){
              this._storedNavData[domain] = {};
            }
            let domainLevel = this._storedNavData[domain];
            let currentPage = this._getPageFromUrl();
            if(!domainLevel[currentPage]){
                domainLevel[currentPage] = {};
            }
            let pageLevel = domainLevel[currentPage];
            if(currentPage == "entity-manage"){
                let e_id = this._getQueryParamsFromUrl("id");
                if(e_id){
                    if(!pageLevel[e_id]){
                        pageLevel[e_id] = {};
                        pageLevel = pageLevel[e_id];
                    }
                }else{
                    return;
                }
            }
            if(parentId){
                if(!pageLevel[parentId]){
                    pageLevel[parentId] = {};
                }
                if(childId){
                    let compLevel = pageLevel[parentId];
                    if(!compLevel[childId]){
                        if(value){
                            compLevel[childId][property] = value;
                        }else{
                            compLevel[childId] = DataHelper.cloneObject(property);
                        }
                    }
                }else{
                    if(value){
                        pageLevel[parentId][property] = value;
                    }else{
                        pageLevel[parentId] = DataHelper.cloneObject(property)
                    }
                };
            };
            
            this._writeStorage(this._storedNavData);
        }

    }
    
</script>