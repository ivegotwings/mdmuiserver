<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">

<link rel="import" href="../bedrock-helpers/element-helper.html">

<link rel="import" href="../pebble-styles-app/pebble-styles-app.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">

<!--
` <pebble-card> ` Represents a container with a drop shadow. 
It contains a photo, text, and a link about a single subject. 
It displays the content containing elements of varying size such as notification list or charts.

@demo demo/index.html 
-->

<dom-module id="pebble-card">
    <template>
        <custom-style>
            <style include="pebble-styles-app"></style>
        </custom-style>
        <style>
             :host {

                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;

                /* Safari */
                flex-direction: column;
                -webkit-flex-direction: column;
            }
            /* IE 10 support for HTML5 hidden attr */

            [hidden] {
                display: none !important;
            }

            .widget-title iron-icon {
                margin-right: 10px;
                @apply --layout-start;
                width: 20px;
                height: 20px;
            }

            .layout-start {
                width: 25px;
                height: 21px;
            }

            .header .title-text.over-image {
                position: absolute;
                bottom: 0px;
                @apply --paper-card-header-image-text;
            }

             :host::shadow rock-tabs {
                padding: 0;
            }

             :host::slotted(.card-content) {
                padding: 0;
                /* 16px */
                position: relative;
                @apply --paper-card-content;
            }

             :host::slotted(.card-actions) {
                border-top: 1px solid #e8e8e8;
                padding: 0px;
                position: relative;
                @apply --paper-card-actions;
            }

            paper-menu-button {
                padding: 0;
            }

             :host paper-icon-button {
                color: var(--paper-grey-600);
                width: 14px;
                height: 14px;
                padding: 0px;
            }

            .card-icons {
                font-size: 0;
            }

             :host paper-icon-button.white {
                color: var(--palette-white, #fff) !important;
            }

             :host paper-item {
                cursor: pointer;
            }

             ::shadow pebble-tab-group {
                margin-bottom: 20px;
            }

            .pebble-md-icons {
                --pebble-button: {
                    color: var(--primary-icon-color, #75808b);
                }
            }

            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--font-size-sm, 12px);
                min-height: 24px;
            }

            pebble-popover paper-item:hover {
                background-color: var(--bgColor-hover, #e8f4f9);
                color: var(--focused-line, #026bc3);
            }

            .card-icons pebble-button {
                --pebble-button-left-icon: {
                    cursor: default !important;
                    color:var(--palette-steel-grey,#75808b);
                }
            }

            .widget-box {
                @apply --pebble-card-widget-box;
            }
        </style>
        <div class="widget-box">
            <div class="p-0 row" hidden$="[[noHeader]]">
                <div hidden$="[[!heading]]" class="widget-title">
                    <template is="dom-if" if="[[_showHeaderIcon]]">
                        <pebble-icon class="big layout-start" icon="[[headerIcon]]"></pebble-icon>
                    </template>[[heading]]
                </div>
                <div class="card-icons">
                    <template is="dom-if" if="[[_cardIconButtons]]">
                        <template is="dom-repeat" items="[[_cardIconButtons]]">
                            <paper-icon-button name="[[item.name]]" class="pebble-md-icons tooltip-bottom" icon="[[item.icon]]" on-tap="_onIconButtonClick"
                                data-tooltip="Refresh" noink>
                            </paper-icon-button>
                        </template>
                    </template>

                    <template is="dom-if" if="[[!nonMaximizable]]">
                        <pebble-button id="maximize" class="minimize pebble-md-icons m-l-10 tooltip-bottom" name="maximize" icon="pebble-md-icons:Expand"
                            data-tooltip="Expand">
                        </pebble-button>
                        <pebble-button id="settings" class="minimize pebble-md-icons m-l-10 tooltip-bottom" name="settings" icon="pebble-md-icons:Settings"
                            data-tooltip="Settings">
                        </pebble-button>
                    </template>

                    <template is="dom-if" if="[[!nonClosable]]">
                        <paper-icon-button name="remove" icon="pebble-icons:Clear" title="Remove" on-tap="_onRemoveClick"></paper-icon-button>
                    </template>

                    <template is="dom-if" if="[[_isMoreButtonsAvailable(_moreIconButtons)]]">
                        <paper-icon-button id="actionButton" on-tap="_onActionsButtonTap" icon="pebble-md-icons:MoreVert" class="dropdown-trigger m-l-5 tooltip-bottom"
                            noink data-tooltip="More">
                        </paper-icon-button>
                        <pebble-popover id="actionsPopover" for="actionButton" auto-fit-on-attach no-overlap horizontal-align="auto" allow-multiple>
                            <template is="dom-repeat" items="[[_moreIconButtons]]">
                                <paper-item name="[[item.name]]" on-tap="_onIconButtonClick">
                                    [[item.label]]
                                </paper-item>
                            </template>
                        </pebble-popover>
                    </template>
                </div>
            </div>

            <slot></slot>
        </div>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-card',
                ready: function () { },
                properties: {
                    /**
                     * Indicates the title of the card.
                     * 
                     */
                    heading: {
                        type: String,
                        value: "Card Heading"
                    },
                    /**
                     * Indicates to hide/display header
                     */
                    noHeader: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Indicates the url of the title image of the card.
                     * 
                     */
                    headerIcon: {
                        type: String,
                        value: ""
                    },
                    /**
                     * Specifies whether the card container can be closed or not.
                     * If it is set to <b>true</b>, then the card container cannot be closed.
                     * 
                     */
                    nonClosable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Specifies whether the card container can be maximized or not.
                     * If it is set to <b>true</b>, then the card container cannot be maximized.
                     * 
                     */
                    nonMaximizable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Specifies whether the card container's position can be dragged or not.
                     * If it is set to <b>true</b>, then the card is not draggable.
                     * 
                     */
                    nonDraggable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Indicates the list of actions available in <b>more</b> icon on top right corner of the card.
                     * 
                     */
                    iconButtons: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _cardIconButtons: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        computed: '_computeCardIconButtons(iconButtons)'
                    },

                    _moreIconButtons: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        computed: '_computeMoreIconButtons(iconButtons)'
                    },

                    _showHeaderIcon: {
                        type: Boolean,
                        computed: "_isHeaderIconEmpty(headerIcon)"
                    }
                },

                _computeMoreIconButtons: function (iconButtons) {
                    var moreIconButtons = [];

                    if (!DataHelper.isEmptyObject(iconButtons)) {
                        iconButtons.forEach(function (iconButton) {
                            if (iconButton.showInMoreActions) {
                                moreIconButtons.push(iconButton);
                            }
                        });
                    }

                    return moreIconButtons;
                },

                _isMoreButtonsAvailable: function() {
                    if(_.isEmpty(this._moreIconButtons)) {
                        return false;
                    }
                    return true;
                },

                _computeCardIconButtons: function(iconButtons) {
                    var cardIconButtons = [];

                    if (!DataHelper.isEmptyObject(iconButtons)) {
                        iconButtons.forEach(function (iconButton) {
                            if (!iconButton.showInMoreActions) {
                                cardIconButtons.push(iconButton);
                            }
                        });
                    }

                    return cardIconButtons;
                },

                // Action Button
                _onActionsButtonTap: function (e) {
                    this.shadowRoot.querySelector('#actionsPopover').show();
                },
                _isHeaderIconEmpty: function (headerIcon) {
                    if (headerIcon && headerIcon !== "") {
                        return true;
                    } else {
                        return false;
                    }
                },
                /**
                 * Used to process the event that gets tiggered when one of the header buttons gets clicked. 
                 * 
                 */
                _onIconButtonClick: function (e) {
                    var targetName = e.target.name;
                    //when clicking on the atcual icon, the target is iron icon, 
                    //when clicking outside edge of icon the target is paper icon button
                    var path = ElementHelper.getElementPath(e);
                    if (e.target.tagName == "IRON-ICON") {
                        targetName = path[1].name;
                    }
                    for (var i = 0; i < this.iconButtons.length; i++) {
                        if (this.iconButtons[i].name == targetName) {
                            this.dispatchEvent(new CustomEvent("icon-button-click", { detail: this.iconButtons[i], bubbles: true, composed: true }));
                        }
                    }
                },
                /**
                 * Used to process the event that gets tiggered when "Maximize" button is clicked. 
                 * 
                 */
                _onMaximizeClick: function (e) {
                    // alert('_onMaximizeClick');
                },
                /**
                 * Used to process the event that gets tiggered when "Remove" button is clicked. 
                 * 
                 */
                _onRemoveClick: function (e) {
                    // alert('_onRemoveClick');
                }
            });
        })();
    </script>

</dom-module>