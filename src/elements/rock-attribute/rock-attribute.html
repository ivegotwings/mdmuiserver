<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">
<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-boolean/pebble-boolean.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">

<!--
`rock-attribute`
Represents the attribute component in the framework. It takes parameters to know the details of the attribute and renders appropriate UI elements to manage an attribute value.

@demo demo/index.html 
-->

<dom-module id="rock-attribute">
  <template>
    <style include="pebble-styles-shared">
      .attribute {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      .attribute-main {
        padding-bottom:10px;
        width:80%;
      }
      /*.attribute-edit {
        
      }*/

      .attribute-view {
        clear:both;
        border-bottom: 1px solid var(--color-steal-grey);
        margin-bottom: 2px;
      }

      .attribute-view-label {
        font-size: 12px;
        font-weight: normal;
        font-style: normal;
        font-stretch: normal;
        line-height: 1.42;
        text-transform:uppercase;
        color:var(--color-steal-grey);
      }

      .attribute-view-value {
        font-size: 16px;
      }      

      .attribute-icons {
        height:32px;
      }

      .attribute-icons paper-icon-button {
        float:right;
        width:32px;
        color:var(--color-steal-grey);
      }

      .attribute paper-icon-button {
        width:32px;
        height: 32px;
        color:var(--color-steal-grey);
        top: 10px;
      }

      .attribute-edit {
        background-color: white;
      }

      .attribute-edit-changed {
        background-color: #EDF8FE !important;
      }
     
    </style>
    <div class="attribute">
      <div class="attribute-main">
        <div class="attribute-icons">
          <template is="dom-if" if="[[!_isEditMode(mode)]]">
            <paper-icon-button name="edit" icon="pebble-icons:create" title="Edit" on-tap="_onEditClick" tabindex="-1"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[_isEditMode(mode)]]">
            <paper-icon-button name="revert" icon="pebble-icons:refresh" title="Revert" on-tap="_onRevertClick" tabindex="-1"></paper-icon-button>
          </template>
          <paper-icon-button name="owner" icon="pebble-icons:low-priority" title="View ownership info" on-tap="_onOwnerClick" tabindex="-1"></paper-icon-button>
          <paper-icon-button name="time" icon="pebble-icons:access-time" title="Manage historical data" on-tap="_onTimeClick" tabindex="-1"></paper-icon-button>
          <paper-icon-button name="locale" icon="pebble-icons:language" title="Manage in multiple locales" on-tap="_onLocaleClick" tabindex="-1"></paper-icon-button>
        </div>
        <template is="dom-if" if="[[_isEditMode(mode)]]">
          <div class$="[[_getAttributeEditClass(changed)]]">
            <template is="dom-if" if="[[_isTextArea(attributeModelObject.displayType)]]">
              <pebble-textarea 
              label="{{attributeModelObject.longName}}" value="{{attributeObject.value}}"
              required="[[attributeModelObject.required]]"
              minlength="[[attributeModelObject.minLength]]" maxlength="[[attributeModelObject.maxLength]]" pattern="[[attributeModelObject.pattern]]" precision="[[attributeModelObject.precision]]"
              min="[[attributeModelObject.min]]" max="[[attributeModelObject.max]]"  validation-type="[[attributeModelObject.validationType]]" validation-type-array="[[attributeModelObject.validationTypeArray]]"
              ></pebble-textarea>
            </template>
            <template is="dom-if" if="[[_isDropDown(attributeModelObject.displayType)]]">
              <pebble-dropdown label="{{attributeModelObject.longName}}" items="{{attributeModelObject.allowedValues}}" selected-value="{{attributeObject.value}}" pattern="[[attributeModelObject.pattern]]"  precision="[[attributeModelObject.precision]]" required="[[attributeModelObject.required]]"
                               min="[[attributeModelObject.min]]" max="[[attributeModelObject.max]]"  validation-type="[[attributeModelObject.validationType]]" validation-type-array="[[attributeModelObject.validationTypeArray]]"></pebble-dropdown>
            </template>
            <template is="dom-if" if="[[_isBoolean(attributeModelObject.displayType)]]">
              <pebble-boolean label="{{attributeModelObject.longName}}" value="{{attributeObject.value}}"></pebble-boolean>
            </template>
            <!-- If display type is not supported then textbox is used -->
            <template is="dom-if" if="[[_isTextBox(attributeModelObject.displayType)]]">
              <pebble-textbox 
              label="{{attributeModelObject.longName}}" value="{{attributeObject.value}}"
              required="[[attributeModelObject.required]]" 
              minlength="[[attributeModelObject.minLength]]" maxlength="[[attributeModelObject.maxLength]]"
              pattern="[[attributeModelObject.pattern]]" precision="[[attributeModelObject.precision]]"
              min="[[attributeModelObject.min]]" max="[[attributeModelObject.max]]"  validation-type="[[attributeModelObject.validationType]]" validation-type-array="[[attributeModelObject.validationTypeArray]]"
              ></pebble-textbox>
            </template>
          </div>
        </template>
        <template is="dom-if" if="[[!_isEditMode(mode)]]">
          <div class="attribute-view">
            <span class="attribute-view-label">{{attributeModelObject.longName}}:</span><br>
            <span class="attribute-view-value"> {{attributeObject.value}}</span><br>
          </div>
        </template>
      </div>
      <div>
        <template is="dom-if" if="[[_isEditMode(mode)]]">
            <paper-icon-button name="clear" icon="pebble-icons:clear" title="Clear" on-tap="_onClearClick" tabindex="-1"></paper-icon-button>
        </template>
      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rock-attribute',
        ready: function() {
          //console.log('attribute ready '+this._isInitialized);
          this._isInitialized = true;
        },
        attached: function() {
          //console.log('attribute attached');
        },
        properties: {
          
          /**
          * Indicates whether the attribute should be rendered in edit mode or view mode. 
          * The two possible values are <b>view</b> and <b>edit</b>.
          */
          mode: {
            type: String,
            value: "view",
            notify: true
          },
          /**
          * Indicates the JSON for the attribute value object. This object records all user changes to the value.
          * Sample: {
                      "value":"Nivea Creme 400 Ml"
                    }
          */
          attributeObject: {
            type: Object,
            value: function (){
              return {};
            },
            notify: true
          },
          originalAttributeObject: {
            type: Object,
            value: function (){
              return {};
            }
          },
          /**
          * Indicates the JSON for the attribute model object. 
          * It renders appropriate UI element to edit the attribute, to configure validation, and other behaviors.
          * Sample: {
                      "name": "name",
                      "longName": "Name",
                      "displayType": "textbox",
                      "minLength": 5,
                      "maxLength": 10 
                    }
          */
          attributeModelObject: {
            type: Object,
            value: function (){
              return {};
            }
          },
          changed: {
            type: Boolean,
            value: false,
            notify: true,
            reflectToAttribute: true
          },
          _isInitialized: {
            type: Boolean,
            value: false
          }
        },
        observers: [
          '_attributeObjectChanged(attributeObject.*)'
        ],
        _isEditMode: function(mode) {
          return mode === "edit";
        },
        _onChange: function(event) {
          //todo: this is not working right now, have to find out how to propagate change event up the control hierarchy
          if (this.shadowRoot) {
            this.fire(event.type, {
              sourceEvent: event
            }, {
              node: this,
              bubbles: event.bubbles,
              cancelable: event.cancelable
            });
          }
        },
        _isTextBox: function(displayType) {
          //If display type is not supported then also textbox is used
          return displayType === "textbox" || 
            (!this._isTextArea(displayType) && !this._isDropDown(displayType) && !this._isBoolean(displayType));
        },
        _isTextArea: function(displayType) {
          return displayType === "textarea";
        },
        _isDropDown: function(displayType) {
          return displayType === "dropdown";
        },
        _isBoolean: function(displayType) {
          return displayType === "boolean";
        },
        _onEditClick: function(e){
          this.mode = "edit";
        },
        _attributeObjectChanged: function(newValue) {
          if(this._isInitialized) {
            this.changed = true;
            //console.log("newValue after ready " + JSON.stringify(newValue));
          }
        },
        _getAttributeEditClass: function(changed) {
          if(changed) {
            return 'attribute-edit attribute-edit-changed';
          }
          else {
            return 'attribute-edit';
          }
        },
        _onRevertClick: function(e) {
          this.attributeObject = this._cloneObject(this.originalAttributeObject);//can't assign directly, its by ref - thus using cloning
          this.changed = false;
        },
        _onClearClick: function() {
          this.attributeObject.value = null;
          this.attributeObject = this._cloneObject(this.attributeObject);
        },
        _cloneObject: function(o) {
          return JSON.parse(JSON.stringify(o));
        }
      });
    })();
  </script>

</dom-module>