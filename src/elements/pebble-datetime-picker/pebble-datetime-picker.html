<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/polymer-paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../../bower_components/polymer-paper-date-picker/paper-date-picker-dialog-style.html">

<link rel="import" href="../pebble-time-picker/pebble-time-picker.html">
<link rel="import" href="../pebble-time-picker/pebble-time-picker-dialog-style.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">

<!--
`<pebble-datetime-picker>` Represents an element that provides date and time.

Example:

    <template is="dom-bind">
				<paper-button id="datetimePicker" raised onclick="picker.show()">Date Time Picker</paper-button>
				<pebble-datetime-picker id="picker" 
				                        for="datetimePicker"
										value="{{dateTime}}"></pebble-datetime-picker>
				<span>{{dateTime}}</span>
	</template>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--pebble-date-picker-width` | Date picker width | 275px
`--pebble-date-picker-height` | Date picker height | 300px
`--pebble-date-picker-heading-width` | Date picker heading width | ``
`--pebble-date-picker-heading-height` | Date picker heading height | 76px
`--pebble-date-picker-calendar-bgcolor` | Date picker body background color | ``
`--pebble-date-picker` | Mixin applied to date picker | {}
`--pebble-date-picker-heading` | Mixin applied to date picker heading | {}
`--pebble-date-picker-heading-date` | Mixin applied to date picker heading date | {}
`--pebble-date-picker-heading-year` | Mixin applied to date picker heading year | {}
`--pebble-date-picker-body-monthyear` | Mixin applied to date picker body month year | {}
`--pebble-date-picker-calendar-weekdays` | Mixin applied to date picker calendar weekdays | {}
`--pebble-date-picker-calendar-day-selected` | Mixin applied to date picker calendar day selected | {}
`--pebble-date-picker-calendar-today` | Mixin applied to date picker calendar today | {}
`--pebble-date-picker-yearlist` | Mixin applied to date picker yearlist | {}
`--pebble-date-picker-yearlist-selected` | Mixin applied to date picker yearlist selected | {} 
`--pebble-date-picker-calendar` | Mixin applied to the date picker calendar | {}
`--pebble-date-picker-button` | Mixin applied to the date picker button | {}
`--pebble-time-picker-selected-font-color` | Selected elements text color in time picker | #ffffff
`--pebble-time-picker-clockhand-color` | Apply color to clock hand and heading | #3f51b5
`--pebble-timepicker-narrow` | Mixins applied for time picker | {}
`--pebble-timepicker-heading-narrow` | Mixins applied for heading | {}
`--pebble-timepicker-heading-time` | Mixins applied to heading time | {}
`--pebble-time-picker-heading-period` | Mixins applied to heading period | {}
`--pebble-time-picker-heading-color` | Mixins applied for heading color | {}
`--pebble-time-picker-selected` | Mixins applied for selected elements at heading | {}
`--pebble-time-picker-clock` | Mixins applied for time picker clock | {}

@group Pebble Elements
@element pebble-datetime-picker
@demo demo/index.html
-->

<dom-module id="pebble-datetime-picker">
    <template>
        <style is="custom-style" include="paper-date-picker-dialog-style"></style>
        <style is="custom-style" include="pebble-time-picker-dialog-style"></style>
        <style is="custom-style" include="pebble-shared-styles">

        :host {
        display: block;
        position: absolute;
        background-color: #ffffff;        
        box-sizing: border-box;
        box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.26);
        border-radius: 2px;        
        font-size: 14px;
        overflow:auto;
        padding: 5px;
        margin: 5px;
      }
      
      paper-date-picker ::shadow #datePicker.paper-date-picker {
        width: var(--pebble-date-picker-width, 275px);
        height: var(--pebble-date-picker-height, 300px);
        @apply(--pebble-date-picker)
      }

      paper-date-picker ::shadow #heading.paper-date-picker {
        width: var(--pebble-date-picker-heading-width);
        height:  var(--pebble-date-picker-heading-height, 76px);
        @apply(--pebble-date-picker-heading);        
      }
      
      paper-date-picker ::shadow #heading.paper-date-picker .year.paper-date-picker {
        @apply(--pebble-date-picker-heading-year);
      }

      paper-date-picker ::shadow .month-weekdays.paper-calendar {
        @apply(--pebble-date-picker-calendar-weekdays);
      }

      paper-date-picker ::shadow .day-item.selected.paper-calendar {
        @apply(--pebble-date-picker-calendar-day-selected);
      }

      paper-date-picker ::shadow .day-item.today.paper-calendar .day.paper-calendar {
        @apply(--pebble-date-picker-calendar-today);
      }

      paper-date-picker ::shadow .year.paper-year-list {
        @apply(--pebble-date-picker-yearlist);
      }

      paper-date-picker ::shadow  .selected.paper-year-list {
        @apply(--pebble-date-picker-yearlist-selected);
      }

      paper-date-picker {
        --paper-font-display1: {
              font-size: 16px;
              @apply(--pebble-date-picker-heading-date);
            };
        
        --paper-font-body2: {
            @apply(--pebble-date-picker-body-monthyear);
        };

        --default-background-color: var(--pebble-date-picker-calendar-bgcolor);
        --paper-date-picker-calendar: {
            @apply(--pebble-date-picker-calendar); 
        }

      }

      paper-button {
        @apply(--pebble-date-picker-button);
      }

     #timePicker {
            --pebble-time-picker-narrow: {
                width: 275px;
                height: 300px;
                @apply(--pebble-timepicker-narrow);
            }

            --pebble-time-picker-heading-narrow: {                
                height: 76px;
                @apply(--pebble-timepicker-heading-narrow);
            }
            
            --pebble-time-picker-heading-time: {
                font-size: 35px;
                @apply(--pebble-timepicker-heading-time);
            }
            
            --default-primary-color: var(--pebble-time-picker-clockhand-color, #3f51b5);
            --text-primary-color: var(--pebble-time-picker-selected-font-color, #ffffff);                      
                                    
            @apply(--pebble-time-picker-clock);
            @apply(--pebble-time-picker-selected);   
            @apply(--pebble-time-picker-heading-color);
            @apply(--pebble-time-picker-heading-period);
                                 
      }
      
    </style>

<template is="dom-if" if="[[!_showTime]]">
    <section class="paper-date-picker-dialog">
        <paper-date-picker date="{{_date}}" 
                           min-date="[[minDate]]" 
                           max-date="[[maxDate]]" 
                           force-narrow 
                           heading-format="[[headingFormat]]">
        </paper-date-picker>
        <div class="buttons" align="right">
            <paper-button dialog-dismiss on-tap="hide">Cancel</paper-button>
            <paper-button dialog-confirm on-tap="_onDateSelect">Ok</paper-button>
        </div>
    </section>
</template>

<template is="dom-if" if="[[_showTime]]">
    <section class="pebble-time-picker-dialog">
        <pebble-time-picker id="timePicker" 
                            force-narrow 
                            time="{{_time}}" 
                            enable-seconds>
        </pebble-time-picker>
        <div class="buttons" align="right">
            <paper-button dialog-dismiss on-tap="_onTimeCancel">Cancel</paper-button>
            <paper-button dialog-confirm on-tap="_onTimeSelect">OK</paper-button>
        </div>
    </section>
</template>

</template>

<script>

    //To capture current opened Datetime picker
    var currentDateTimePicker = null;

    Polymer({
        is: 'pebble-datetime-picker',

        properties: {


            /*
             * Indicates the selected date (YYYY-MM-DD)
             */
            _date: {
                type: Date,
                notify: true
            },

            /*
             * Indicates selected time
             */
            _time: {
                type: String,
                notify: true
            },

            /*
             *  Specifies the popover not to overlap with target.
             */
            _noOverlap: {
                type: Boolean,
                value: true
            },

            /*
             * Specifies hide/show date and time
             */
            _showTime: {
                type: Boolean,
                value: false,
                notify: true
            },

            /**
             * Indicates datetime/date/time as per pickerType 
             */
            value: {
                type: String,
                notify: true
            },

            /**
             * Specifies date value
             */
            dateValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies time value
             */
            timeValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies utc format
             */
            utcValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the minimum allowed date
             */
            minDate: {
                type: Date,
                value: null
            },

            /**
             * Specifies the maximum allowed date
             */
            maxDate: {
                type: Date,
                value: null
            },

            /**
             * Specifies the format of the date displayed in the heading.
             * See documentation for Moment.js for more info.
             */
            headingFormat: {
                type: String,
                value: 'ddd, MMM D'
            },

            /**
             * Specifies the date format for pricker type date
             */
            dateFormat: {
                type: String,
                value: "MM/DD/YYYY"
            },

            /**
             * Specifies the time format for pricker type time
             */
            timeFormat: {
                type: String,
                value: "hh:mm:ss a"
            },

            /*
            *  Indicates the target for picker to display.
            */
            for: {
                type: String,
                value: null
            },

            /*
            *  Indicates the "vertical" alignment of the picker.            
            *  If <b>value</b> is selected as "top", then picker is aligned below the target.  
            *  If <b>value</b> is selected as "below", then picker is aligned above the target.
            */

            verticalAlign: {
                type: String,
                value: "top"
            },

            /*
            *  Indicates the "horizontal" alignment of the picker.            
            *  If <b>value</b> is selected as "left", then picker is aligned to the left of the target.  
            *  If <b>value</b> is selected as "right", then picker is aligned to the right of the target.
            */
            horizontalAlign: {
                type: String,
                value: "left"
            },

            /*
             * Indicates type of the picker (datetime or date or time)
             */
            pickerType: {
                type: String,
                value: "datetime",
                observer: "_onPickerTypeChange"
            },
        },

        listeners: {
            'iron-overlay-opened': '_datetimePickerOpened',
            'iron-overlay-closed': '_datetimePickerClosed',
        },

        behaviors: [
            Polymer.IronOverlayBehavior
        ],

        attached: function () {
            window.addEventListener('scroll', this._fixPickerOnScrollAndResize);
            window.addEventListener('resize', this._fixPickerOnScrollAndResize);
        },

        _onPickerTypeChange: function () {
            if (this.pickerType == '' || this.pickerType == undefined || this.pickerType == null) {
                return;
            }

            this.pickerType = this.pickerType.toLowerCase();
        },

        /*
        *  To display Date and Time Picker.
        */
        show: function () {

            this.noOverlap = this._noOverlap //Alwaya noOverlap as true

            this.open(); //IronOverlayBehavior to display popover

            var scope = Polymer.dom(this).getOwnerRoot();
            var target = Polymer.dom(scope).querySelector('#' + this.for);
            this.positionTarget = target;

            this._refitPopover();
        },

        /*
        *  To hide/close Date and Time Picker
       */

        hide: function () {
            this.close();
        },

        /*
         * This is for date formating
         */
        _getDateByFormat: function (datevalue) {
            if(!datevalue)
            {
                return moment(this._date).format(this.dateFormat);
            }
            else
            {
                return moment(datevalue).format(this.dateFormat);
            }
        },

        /*
         * This is for time formating
         */
        _getTimeByFormat: function (timevalue) {
            if(!timevalue)
            {
                return moment(this._time, 'hh:mm:ss a').format(this.timeFormat);
            }
            else
            {
                return moment(timevalue, 'hh:mm:ss a').format(this.timeFormat);
            }
        },

        /*
         * Fix the overlay picker postion on scroll or resize
         */
        _fixPickerOnScrollAndResize: function () {
            if (currentDateTimePicker == null) {
                return;
            }
            currentDateTimePicker._refitPopover();
        },

        /*
         * Triggers when open the picker
         */
        _datetimePickerOpened: function () {
            currentDateTimePicker = this;

            if (this.pickerType == "datetime") {
                if (!this.value) {
                    this._date = new Date();
                }
                else {
                    this._date = new Date(this.value);
                }

                this._time = moment(this._date).format("hh:mm:ss a");
            }
            else if (this.pickerType == "date") {
                if (!this.value) {
                    this._date = new Date();
                }
                else {
                    this._date = new Date(moment(this.value, this.dateFormat).format('MM/DD/YYYY'));
                }
            }
            else {
                this._time = this.value ? moment(this.value, this.timeFormat).format('hh:mm:ss a') : moment(this._date).format("hh:mm:ss a");
            }

            //Show Date/Time as per pickerType
            if (this.pickerType == "time") {
                this._showTime = true;
            }
            else {
                this._showTime = false;
            }
        },

        /*
         * Triggers when close the picker
         */
        _datetimePickerClosed: function () {
            if (currentDateTimePicker == this) {
                if (this.opened) {
                    return;
                }
                currentDateTimePicker = null;
            }
        },

        /*
        *  Used to reset the position of the Date and Time Picker.
        */
        _refitPopover: function () {
            this.refit();
        },

        /*
         *  Selected a date on clicking OK
         */
        _onDateSelect: function () {
            if (this.pickerType == "date") {
                this.value = this._getDateByFormat(this._date);
                this._setDateTimeComponents();
                this.close();
            }
            else {
                this._showTime = true;
                this._refitTimePickerClock(this);
            }
        },

        /**
         * Refit clock selectors 
         */
        _refitTimePickerClock: function (picker) {
            this.async(function () {
                var clockSelectorList = picker.querySelectorAll('pebble-clock-selector');
                for (var idx = 0; idx < clockSelectorList.length; idx++) {
                    clockSelectorList[idx].UpdateClockSelector();
                }
            }.bind(this), 150);
        },

        /*
         *  On cancel time selection
         */
        _onTimeCancel: function () {
            if (this.pickerType == "time") {
                this.close();
            }
            else {
                this._showTime = false;
            }
        },

        /*
         *  Selected time on clicking OK
         */
        _onTimeSelect: function () {
            if (this.pickerType == "datetime") {
                var parseTime = this.querySelector("#timePicker").parseTime(this._time);
                this._date.setHours(parseTime.hour);
                this._date.setMinutes(parseTime.minute);
                this._date.setSeconds(parseTime.second);
                this._date = new Date(this._date);

                this.value = this._date;                
            }
            else if (this.pickerType == "time") {
                this.value = this._getTimeByFormat();                
            }

            this._setDateTimeComponents();
            this.close();
        },

        /**
         * Set readonly datetime components
         */
        _setDateTimeComponents: function () {

            var datetime = null;

            if (this.pickerType == "datetime") {
                datetime = this.value;
            }
            else if (this.pickerType == "date") {                
                datetime = new Date(moment(this._date).format('MM/DD/YYYY')); 
            }
            else {
                var date = new Date();
                var parseTime = this.querySelector("#timePicker").parseTime(this._time); //For 24 hours window                
                date.setHours(parseTime.hour);
                date.setMinutes(parseTime.minute);
                date.setSeconds(parseTime.second);
                datetime = new Date(date);
            }
        
            this.set('dateValue', this._getDateByFormat(datetime));
            this.set('timeValue', this._getTimeByFormat(datetime))
            this.set('utcValue', datetime.toUTCString());            
        }
    })
</script>
</dom-module>