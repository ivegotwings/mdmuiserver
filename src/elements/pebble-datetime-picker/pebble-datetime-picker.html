<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../pebble-date-picker/pebble-date-picker.html">
<link rel="import" href="../pebble-date-picker/pebble-date-picker-dialog-style.html">
<link rel="import" href="../pebble-time-picker/pebble-time-picker.html">
<link rel="import" href="../pebble-time-picker/pebble-time-picker-dialog-style.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../bedrock-validator/bedrock-validator.html">

<!--
`<pebble-datetime-picker>` Represents an element that provides date and time.

### Example

    <template is="dom-bind">
				<paper-button id="datetimePicker" raised onclick="picker.show()">Date Time Picker</paper-button>
				<pebble-datetime-picker id="picker" 
				                        for="datetimePicker"
										value="{{dateTime}}"></pebble-datetime-picker>
				<span>{{dateTime}}</span>
	</template>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--pebble-date-picker-width` | Date picker width | 275px
`--pebble-date-picker-height` | Date picker height | 300px
`--pebble-date-picker-heading-width` | Date picker heading width | ``
`--pebble-date-picker-heading-height` | Date picker heading height | 76px
`--pebble-date-picker-calendar-bgcolor` | Date picker body background color | ``
`--pebble-date-picker` | Mixin applied to date picker | {}
`--pebble-date-picker-heading` | Mixin applied to date picker heading | {}
`--pebble-range-date-picker-heading` | Mixins applied for heading in range picker | {}
`--pebble-date-picker-heading-date` | Mixin applied to date picker heading date | {}
`--pebble-date-picker-heading-year` | Mixin applied to date picker heading year | {}
`--pebble-date-picker-body-monthyear` | Mixin applied to date picker body month year | {}
`--pebble-date-picker-calendar-weekdays` | Mixin applied to date picker calendar weekdays | {}
`--pebble-date-picker-calendar-day-selected` | Mixin applied to date picker calendar day selected | {}
`--pebble-date-picker-calendar-today` | Mixin applied to date picker calendar today | {}
`--pebble-date-picker-yearlist` | Mixin applied to date picker yearlist | {}
`--pebble-date-picker-yearlist-selected` | Mixin applied to date picker yearlist selected | {} 
`--pebble-date-picker-calendar` | Mixin applied to the date picker calendar | {}
`--pebble-date-picker-day-item-selected-day` | Mixin applied to calendar selected day text | {}
`--pebble-date-picker-day-item` | Mixin applied to calendar days | {}
`--pebble-date-picker-button` | Mixin applied to the date picker button | {}
`--pebble-time-picker-selected-font-color` | Selected elements text color in time picker | #ffffff
`--pebble-time-picker-clockhand-color` | Apply color to clock hand and heading | #3f51b5
`--pebble-timepicker-narrow` | Mixins applied for time picker | {}
`--pebble-timepicker-heading-narrow` | Mixins applied for heading | {}
`--pebble-timepicker-heading-time` | Mixins applied to heading time | {}
`--pebble-time-picker-heading-period` | Mixins applied to heading period | {}
`--pebble-time-picker-heading-color` | Mixins applied for heading color | {}
`--pebble-time-picker-selected` | Mixins applied for selected elements at heading | {}
`--pebble-time-picker-clock` | Mixins applied for time picker clock | {}

### Accessibility

See the docs for `Polymer.IronOverlayBehavior` for accessibility features implemented by this element.

@group Pebble Elements
@element pebble-datetime-picker
@demo demo/index.html
-->

<dom-module id="pebble-datetime-picker">
    <template>
        <style is="custom-style" include="pebble-date-picker-dialog-style"></style>
        <style is="custom-style" include="pebble-time-picker-dialog-style"></style>
        <style is="custom-style" include="pebble-shared-styles">

     :host {
        display: inline-table;
        position: absolute;
        background-color: #ffffff;        
        box-sizing: border-box;
        box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.26);
        border-radius: 2px;        
        font-size: 14px;
        overflow:auto;
        padding: 5px;
        margin: 5px;
      }
      
      pebble-date-picker {
          --pebble-nw-date-picker: {
                width: var(--pebble-date-picker-width, 275px);
                height: var(--pebble-date-picker-height, 300px);
                @apply(--pebble-date-picker)
            }

            --pebble-nw-date-picker-heading: {
                width: var(--pebble-date-picker-heading-width);
                height:  var(--pebble-date-picker-heading-height, 76px);
                @apply(--pebble-date-picker-heading);        
            }

            --pebble-date-picker-head-year: {
                @apply(--pebble-date-picker-heading-year);
            }

            --pebble-date-picker-head-date: {
                font-size: 15px;
                @apply(--pebble-date-picker-heading-date);
            }

            --pebble-ls-date-picker-heading: {
                height: 285px;
                @apply(--pebble-range-date-picker-heading)
            }
            
            @apply(--pebble-date-picker-calendar);
            @apply(--pebble-date-picker-calendar-weekdays);
            @apply(--pebble-date-picker-calendar-day-selected);
            @apply(--pebble-date-picker-calendar-today);
            @apply(--pebble-date-picker-yearlist);
            @apply(--pebble-date-picker-yearlist-selected);
            @apply(--pebble-date-picker-body-monthyear);
            @apply(--pebble-date-picker-day-item-selected-day);
            @apply(--pebble-date-picker-day-item);                        
      }
      
      paper-button {
        @apply(--pebble-date-picker-button);
      }

     #timePicker {
            --pebble-time-picker-narrow: {
                width: 275px;
                height: 300px;
                @apply(--pebble-timepicker-narrow);
            }

            --pebble-time-picker-heading-narrow: {                
                height: 76px;
                @apply(--pebble-timepicker-heading-narrow);
            }
            
            --pebble-time-picker-heading-time: {
                font-size: 35px;
                @apply(--pebble-timepicker-heading-time);
            }
            
            --default-primary-color: var(--pebble-time-picker-clockhand-color, #3f51b5);
            --text-primary-color: var(--pebble-time-picker-selected-font-color, #ffffff);                      
                                    
            @apply(--pebble-time-picker-clock);
            @apply(--pebble-time-picker-selected);   
            @apply(--pebble-time-picker-heading-color);
            @apply(--pebble-time-picker-heading-period);
                                 
      }
      .error  {
          color: var(--error-color);
          font-size: 12px;
          font-weight: 400;
          letter-spacing: 0.011em;
          line-height: 20px;
          width: 92%;
          word-wrap: break-word;
      }
    </style>

    <template is="dom-if" if="[[_isDateRange(pickerType)]]">
        <section class="pebble-date-range-picker-dialog">
                <pebble-date-picker date="{{_date}}"
                                    is-range                                    
                                    heading-format="[[headingFormat]]"
                                    start-date="{{_startDate}}"
                                    end-date="{{_endDate}}">
                </pebble-date-picker>
                <div class="error" ><span> {{errorMessage}}</span></div>
                <div class="buttons" align="right">
                    <paper-button dialog-dismiss on-tap="hide">Cancel</paper-button>
                    <paper-button dialog-confirm on-tap="_onDateRangeSelect">Ok</paper-button>
                </div>
            </section>
    </template>

    <template is="dom-if" if="[[!_isDateRange(pickerType)]]">
        <template is="dom-if" if="[[!_showTime]]">
            <section class="pebble-date-picker-dialog">
                <pebble-date-picker date="{{_date}}"
                                    force-narrow 
                                    heading-format="[[headingFormat]]">
                </pebble-date-picker>
                <div class="error" ><span> {{errorMessage}}</span></div>
                <div class="buttons" align="right">
                    <paper-button dialog-dismiss on-tap="hide">Cancel</paper-button>
                    <paper-button dialog-confirm on-tap="_onDateSelect">Ok</paper-button>
                </div>
            </section>
        </template>

        <template is="dom-if" if="[[_showTime]]">
            <section class="pebble-time-picker-dialog">
                <pebble-time-picker id="timePicker" 
                                    force-narrow 
                                    time="{{_time}}" 
                                    enable-seconds>
                </pebble-time-picker>
                <div class="error" ><span> {{errorMessage}}</span></div>
                <div class="buttons" align="right">
                    <paper-button dialog-dismiss on-tap="_onTimeCancel">Cancel</paper-button>
                    <paper-button dialog-confirm on-tap="_onTimeSelect">OK</paper-button>
                </div>
            </section>
        </template>
    </template>


        <template is="dom-if" if="[[_isTime]]">
         <bedrock-validator  input="[[_time]]"  min="[[minTime]]" max="[[maxTime]]" required="[[required]]" invalid="{{invalid}}" error-message="{{errorMessage}}"  type="timeRange" date-format="[[timeFormat]]"
        ></bedrock-validator>
       </template>
        <template is="dom-if"  if="[[_isDate]]">
        <bedrock-validator  input="[[_date]]"  min="[[minDate]]" max="[[maxDate]]" required="[[required]]"
                            invalid="{{invalid}}" error-message="{{errorMessage}}"  type="dateRange" date-format="[[dateFormat]]"
        ></bedrock-validator>
        </template>
        <template is="dom-if"  if="[[_isDateTime]]">
            <bedrock-validator  input="[[_date]]"  min="[[minDate]]" max="[[maxDate]]" required="[[required]]"
                                invalid="{{invalid}}" error-message="{{errorMessage}}"  type="dateRange" date-format="[[dateFormat]] [[timeFormat]]"
            ></bedrock-validator>
        </template>


</template>

<script>

    //To capture current opened Datetime picker
    var currentDateTimePicker = null;

    Polymer({
        is: 'pebble-datetime-picker',

        properties: {

            /*
             * Indicates the selected date in the YYYY-MM-DD format.
             */
            _date: {
                type: Date,
                notify: true
            },

            /*
             * Indicates the selected time.
             */
            _time: {
                type: String,
                notify: true
            },

            _startDate: {
                type: Date,
                notify: true
            },

            _endDate: {
                type: Date,
                notify: true
            },

            /*
             *  Specifies the popover not to overlap with target.
             */
            _noOverlap: {
                type: Boolean,
                value: true
            },

            /*
             * Specifies whether or not to show the date and time.
             */
            _showTime: {
                type: Boolean,
                value: false,
                notify: true
            },

            /**
             * Indicates datetime, date, and time as per pickerType. 
             */
            value: {
                type: String,
                notify: true
            },

            /**
             * Specifies the value of the date.
             */
            dateValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the value of the start date.
             */
            startDateValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the value of the end date.
             */
            endDateValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the value of the time.
             */
            timeValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the utc format.
             */
            utcValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },           

            /**
             * Specifies the minimum allowed date.
             */
            minDate: {
                type: Date,
                value: null
            },

            /**
             * Specifies the maximum allowed date.
             */
            maxDate: {
                type: Date,
                value: null
            },

            /**
             * Specifies the format of the date displayed in the heading.
             * See documentation for Moment.js for more info.
             */
            headingFormat: {
                type: String,
                value: 'ddd, MMM D'
            },

            /**
             * Specifies the date format for picker.
             */
            dateFormat: {
                type: String,
                value: "MM/DD/YYYY"
            },

            /**
             * Specifies the time format for picker.
             */
            timeFormat: {
                type: String,
                value: "hh:mm:ss a"
            },

            /*
            *  Indicates the target for picker to display.
            */
            for: {
                type: String,
                value: null
            },

            /*
            *  Indicates the "vertical" alignment of the picker.            
            *  If <b>value</b> is selected as "top", then picker is aligned below the target.  
            *  If <b>value</b> is selected as "below", then picker is aligned above the target.
            */

            verticalAlign: {
                type: String,
                value: "top"
            },

            /*
            *  Indicates the "horizontal" alignment of the picker.            
            *  If <b>value</b> is selected as "left", then picker is aligned to the left of the target.  
            *  If <b>value</b> is selected as "right", then picker is aligned to the right of the target.
            */
            horizontalAlign: {
                type: String,
                value: "left"
            },

            /*
             * Indicates the type of the picker. It can have the value as datetime or date or time or daterange.
             */
            pickerType: {
                type: String,
                value: "datetime",
                observer: "_onPickerTypeChange"
            },

            /**
             * Indicates to show range group
             */
            showRanges: {
                type: Boolean,
                value: false,
                observer: "_onShowRangesChange"                
            },

            invalid:{
                type: Boolean,
                value:false,
                notify:true
            },
            required:{
                type:Boolean
            },
            _isTime:{
                type:Boolean
            },
            _isDateTime:{
                type:Boolean
            },
            _isDate:{
                type:Boolean
            }
        },

        listeners: {
            'iron-overlay-opened': '_datetimePickerOpened',
            'iron-overlay-closed': '_datetimePickerClosed',
        },

        behaviors: [
            Polymer.IronOverlayBehavior
        ],

        attached: function () {
            window.addEventListener('scroll', this._fixPickerOnScrollAndResize);
            window.addEventListener('resize', this._fixPickerOnScrollAndResize);
        },

        _onPickerTypeChange: function () {
            if (this.pickerType == '' || this.pickerType == undefined || this.pickerType == null) {
                return;
            }

            this.pickerType = this.pickerType.toLowerCase();
        },

        _onShowRangesChange: function(){
            if(this.pickerType == "daterange")
            {
                this.async(function(){
                    var picker = this.$$('pebble-date-picker');
                    picker.showRanges = this.showRanges;
                }, 600); //Delayed to find the picker
            }
        },

        _isDateRange: function(){
            if(this.pickerType == "daterange")
            {
                return true;
            }

            return false;
        },

        /**
        *  Can be used to display date and time picker.
        */
        show: function () {

            this.noOverlap = this._noOverlap //Alwaya noOverlap as true

            this.open(); //IronOverlayBehavior to display popover

            var scope = Polymer.dom(this).getOwnerRoot();
            var target = Polymer.dom(scope).querySelector('#' + this.for);
            this.positionTarget = target;

            this._refitPopover();
        },

        /**
        *  Can be used to hide or close the date and time picker.
        */

        hide: function () {
            this.close();
        },

        /**
         * Can be used to format the date.
         */
        _getDateByFormat: function (datevalue) {
            if(!datevalue)
            {
                return moment(this._date).format(this.dateFormat);
            }
            else
            {
                return moment(datevalue).format(this.dateFormat);
            }
        },

        /**
         * Can be used to format the time.
         */
        _getTimeByFormat: function (timevalue) {
            if(!timevalue)
            {
                return moment(this._time, 'hh:mm:ss a').format(this.timeFormat);
            }
            else
            {
                return moment(timevalue, 'hh:mm:ss a').format(this.timeFormat);
            }
        },

        /**
         * Can be used to fix the overlay picker postion on scroll or on resize.
         */
        _fixPickerOnScrollAndResize: function () {
            if (currentDateTimePicker == null) {
                return;
            }
            currentDateTimePicker._refitPopover();
        },

        // When popover opens retrigger the range type, 
        // so start and end dates will be re-calculated
        _triggerRangeTypeChange: function(){
            if(this.rangeType)
            {            
                this.$$("pebble-date-picker").rangeType = null;
                this.$$("pebble-date-picker").rangeType = this.rangeType;
            }
        },

        /**
         * Fired when the datetimepicker is opened.
         */
        _datetimePickerOpened: function () {
            currentDateTimePicker = this;

            if(this.pickerType == "daterange"){                
                if(!this.startDateValue){
                    this._startDate = new Date(); 
                    this._triggerRangeTypeChange();                  
                }
                else
                {
                    this._startDate = new Date(this.startDateValue);
                }

                if(!this.endDateValue){
                    this._endDate = null;
                    this._triggerRangeTypeChange();
                }
                else
                {
                    this._endDate = new Date(this.endDateValue);
                }

                this.$$("pebble-date-picker").date = this._startDate; //Show range as per start date
            }
            else if (this.pickerType == "datetime") {
                this._isDateTime=true;
                if (!this.value) {
                    this._date = new Date();
                }
                else {
                    this._date = new Date(this.value);
                }

                this._time = moment(this._date).format("hh:mm:ss a");
            }
            else if (this.pickerType == "date") {
                this._isDate=true;
                if (!this.value) {
                    this._date = new Date();
                }
                else {
                    this._date = new Date(moment(this.value, this.dateFormat).format('MM/DD/YYYY'));
                }
            }
            else {
                this._time = this.value ? moment(this.value, this.timeFormat).format('hh:mm:ss a') : moment(this._date).format("hh:mm:ss a");
            }

            //Show Date/Time as per pickerType
            if (this.pickerType == "time") {
                this._showTime = true;
                this._isTime=true;
            }
            else {
                this._showTime = false;
            }
        },

        /*
         * Fired when the datetimepicker is closed.
         */
        _datetimePickerClosed: function () {
            if (currentDateTimePicker == this) {
                if (this.opened) {
                    return;
                }
                currentDateTimePicker = null;
            }
        },

        /*
        *  Can be used to reset the position of the date and time picker.
        */
        _refitPopover: function () {
            this.refit();
        },

        /*
         *  Can be used to select a date on clicking `OK` button.
         */
        _onDateSelect: function () {
            if(!this.invalid) {
                if (this.pickerType == "date") {
                    this.value = this._getDateByFormat(this._date);
                    this._setDateTimeComponents();
                    this.close();
                }
                else {
                    this._showTime = true;
                    this._refitTimePickerClock(this);
                }
            }
        },

        _onDateRangeSelect: function(){
            if(!this.invalid) {
                this.startDateValue = this._getDateByFormat(this._startDate);
                this.endDateValue = this._getDateByFormat(this._endDate);                
                this.close();
            }
        },

        /**
         * Can be used to refit the clock selectors.
         */
        _refitTimePickerClock: function (picker) {
            this.async(function () {
                var clockSelectorList = picker.querySelectorAll('pebble-clock-selector');
                for (var idx = 0; idx < clockSelectorList.length; idx++) {
                    clockSelectorList[idx].UpdateClockSelector();
                }
            }.bind(this), 150);
        },

        /**
         *  Fired when time selection is cancelled.
         */
        _onTimeCancel: function () {
            if (this.pickerType == "time") {
                this.close();
            }
            else {
                this._showTime = false;
            }
        },

        /*
         *  Can be used to select the time on clicking `OK` button.
         */
        _onTimeSelect: function () {
            if (this.pickerType == "datetime") {
                var parseTime = this.$$("#timePicker").parseTime(this._time);
                this._date.setHours(parseTime.hour);
                this._date.setMinutes(parseTime.minute);
                this._date.setSeconds(parseTime.second);
                this._date = new Date(this._date);
                if(this.invalid) {
                    return;
                }
                    this.value = this._date;
            }
            else if (this.pickerType == "time") {
                if(this.invalid) {
                    return;
                }
                this.value = this._getTimeByFormat();
            }

            this._setDateTimeComponents();
            this.close();
        },

        /**
         * Can be used to set readonly datetime components.
         */
        _setDateTimeComponents: function () {

            var datetime = null;

            if (this.pickerType == "datetime") {
                datetime = this.value;
            }
            else if (this.pickerType == "date") {                
                datetime = new Date(moment(this._date).format('MM/DD/YYYY')); 
            }
            else {
                var date = new Date();
                var parseTime = this.querySelector("#timePicker").parseTime(this._time); //For 24 hours window                
                date.setHours(parseTime.hour);
                date.setMinutes(parseTime.minute);
                date.setSeconds(parseTime.second);
                datetime = new Date(date);
            }
        
            this.set('dateValue', this._getDateByFormat(datetime));
            this.set('timeValue', this._getTimeByFormat(datetime))
            this.set('utcValue', datetime.toUTCString());            
        }
    })
</script>
</dom-module>