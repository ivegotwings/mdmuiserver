<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button-group/paper-button-group.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="pebble-datetime-picker-overlay.html">

<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-validator/bedrock-validator.html">

<!--
`<pebble-datetime-picker>` Represents an element that provides the date and time with default picker text box and icon.

### Example

    <pebble-datetime-picker></pebble-datetime-picker>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--pebble-date-picker` | Mixin applied to date picker | {}
`--pebble-date-picker-heading` | Mixin applied to date picker heading | {}
`--pebble-date-picker-heading-date` | Mixin applied to date picker heading date | {}
`--pebble-date-picker-heading-year` | Mixin applied to date picker heading year | {}
`--pebble-date-picker-body-monthyear` | Mixin applied to date picker body month year | {}
`--pebble-date-picker-calendar-weekdays` | Mixin applied to date picker calendar weekdays | {}
`--pebble-date-picker-calendar-day-selected` | Mixin applied to date picker calendar day selected | {}
`--pebble-date-picker-calendar-today` | Mixin applied to date picker calendar today | {}
`--pebble-date-picker-yearlist` | Mixin applied to date picker yearlist | {}
`--pebble-date-picker-yearlist-selected` | Mixin applied to date picker yearlist selected | {} 
`--pebble-date-picker-calendar` | Mixin applied to the date picker calendar | {}
`--pebble-date-picker-day-item-selected-day` | Mixin applied to calendar selected day text | {}
`--pebble-date-picker-day-item` | Mixin applied to calendar days | {}
`--pebble-picker-buttons` | Mixin applied to the date picker button | {}
`--pebble-timepicker-narrow` | Mixins applied for time picker | {}
`--pebble-timepicker-heading-narrow` | Mixins applied for heading | {}
`--pebble-timepicker-heading-time` | Mixins applied to heading time | {}
`--pebble-time-picker-heading-period` | Mixins applied to heading period | {}
`--pebble-time-picker-heading-color` | Mixins applied for heading color | {}
`--pebble-time-picker-selected` | Mixins applied for selected elements at heading | {}
`--pebble-time-picker-clock` | Mixins applied for time picker clock | {}
`--pebble-datetime-okbutton` | Mixins applied for picker 'OK' button | {}
`--pebble-datetime-cancelbutton` | Mixins applied for picker 'CANCEL' button | {}
`--pebble-dt-default-inputarea` | Mixins applied for picker addon input area | {}
`--pebble-dt-default-iconarea` | Mixins applied for picker addon default icon area | {}
`--pebble-dt-iconarea` | Mixins applied for picker addon icon area when no input shown | {}

### Accessibility

See the docs for `Polymer.IronOverlayBehavior` for accessibility features implemented by this element.

@group Pebble Elements
@element pebble-datetime-picker
@demo demo/index.html
-->

<dom-module id="pebble-datetime-picker">
  <template>
    <style is="custom-style" include="pebble-styles-shared">
       .datetimepicker-container {
           @apply(--layout-horizontal)
       } 
       #inputDiv {
          width:250px;
          @apply(--pebble-dt-default-inputarea)           
       }  
       #iconDiv {
          align-self: flex-end;
          -webkit-align-self: flex-end;
          margin-left: -20px; 
          cursor: pointer;
          color: var(--primary-icon-color, #75808b);
          @apply(--pebble-dt-default-iconarea)
       } 

       #iconDiv pebble-icon{
         margin-bottom: 8px;
       }

       :host[no-default-input] #iconDiv{
          align-self: flex-end;
          -webkit-align-self: flex-end;
          padding-bottom: 10px;
          margin-left: 0px; 
          cursor: pointer;
          @apply(--pebble-dt-iconarea)
       }
       .error  {
           color: var(--error-color);
           font-size: var(--font-size-sm, 12px);
           font-weight: var(--font-regular, 400);
           letter-spacing: 0.011em;
           line-height: 20px;
           width: 92%;
           word-wrap: break-word;
       }

       pebble-datetime-picker-overlay {
          pebble-date-picker {
              @apply(--pebble-date-picker);
              @apply(--pebble-date-picker-heading);
              @apply(--pebble-date-picker-heading-year);
              @apply(--pebble-date-picker-heading-date);
              @apply(--pebble-date-picker-calendar);
              @apply(--pebble-date-picker-calendar-weekdays);
              @apply(--pebble-date-picker-calendar-day-selected);
              @apply(--pebble-date-picker-calendar-today);
              @apply(--pebble-date-picker-yearlist);
              @apply(--pebble-date-picker-yearlist-selected);
              @apply(--pebble-date-picker-body-monthyear);
              @apply(--pebble-date-picker-day-item-selected-day);
              @apply(--pebble-date-picker-day-item);                            
          }
          pebble-time-picker {              
              @apply(--pebble-timepicker-narrow);
              @apply(--pebble-timepicker-heading-narrow);
              @apply(--pebble-timepicker-heading-time);
              @apply(--pebble-time-picker-clock);
              @apply(--pebble-time-picker-selected);   
              @apply(--pebble-time-picker-heading-color);
              @apply(--pebble-time-picker-heading-period);
          }

          @apply(--pebble-datetime-okbutton);
          @apply(--pebble-datetime-cancelbutton);
          @apply(--pebble-picker-buttons);
       } 
    </style>    
    <div class="datetimepicker-container">
         <template is="dom-if" if="[[!noDefaultInput]]"> 
            <div id="inputDiv">
                 <pebble-textbox id="datetimePickerText" label="{{label}}" readonly="{{isReadonlyInput}}" value="{{text}}" on-tap="_showPicker"></pebble-textbox>
            </div>
             <bedrock-validator  show-error validation-errors="{{validationErrors}}" input="[[value]]"  required="[[required]]" invalid="{{invalid}}" error-message="{{errorMessage}}" type="[[validationType]]"
             ></bedrock-validator>
         </template>
         <div id="iconDiv">
             <pebble-icon id="datetimePickerIcon" class="pebble-md-icons" icon="pebble-md-icons:Calendar" on-tap="_showPicker"></pebble-icon>
         </div>
    </div>
    <div class="error"> {{errorMessage}}</div>
      <pebble-datetime-picker-overlay id="datetimepicker"
                                    for="[[_target]]"
                                    picker-type="{{pickerType}}"
                                    datetime-format="{{datetimeFormat}}"
                                    date-format="{{dateFormat}}"
                                    time-format="{{timeFormat}}" 
                                    date-value="{{dateValue}}" 
                                    time-value="{{timeValue}}"
                                    utc-value="{{utcDateTime}}"
                                    value="{{value}}"                                   
                                    horizontal-align="{{horizontalAlign}}"
                                    vertical-align="{{verticalAlign}}"
                                    min-date="[[minDate]]"
                                    max-date="[[maxDate]]"
                                    min-time="[[minTime]]"
                                    max-time="[[maxTime]]"
    ></pebble-datetime-picker-overlay>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'pebble-datetime-picker',
        ready: function(){
        },
        properties: {
            /**
             * Indicates text datetime, date, and time 
             */
            text: {
                type: String,
                notify: true,
                observer: '_onDateTextChange'
            },

            /**
             * Indicates datetime, date, and time as per pickerType. 
             */
            value: {
                type: String,
                notify: true,
                observer: '_onDateValueChange'
            },

            /**
             * Specifies the value of the date.
             */
            dateValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },           

            /**
             * Specifies the value of the time.
             */
            timeValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the value in the `UTC` format.
             */
            utcValue: {
                type: String,
                value: null,
                readonly: true,
                notify: true
            },

            /**
             * Specifies the format of the date displayed in the heading.
             * See documentation for Moment.js for more info.
             */
            headingFormat: {
                type: String,
                value: 'ddd, MMM D'
            },

            /**
             * Specifies the datetime format for picker.
             */
            datetimeFormat: {
                type: String,
                value: "MM/DD/YYYY hh:mm:ss A"
            },

            /**
             * Specifies the date format for picker.
             */
            dateFormat: {
                type: String,
                value: "MM/DD/YYYY"
            },

            /**
             * Specifies the time format for picker.
             */
            timeFormat: {
                type: String,
                value: "hh:mm:ss A"
            },

            _isoDateTimeFormat: {
                type: String,
                readonly: true,
                value: "YYYY-MM-DDTHH:mm:ss.000+0000"
            },

            _isoDateFormat: {
                type: String,
                readonly: true,
                value: "YYYY-MM-DD"
            },

            /*
            *  Indicates the "vertical" alignment of the picker.            
            *  If <b>value</b> is selected as "top", then picker is aligned below the target.  
            *  If <b>value</b> is selected as "below", then picker is aligned above the target.
            */

            verticalAlign: {
                type: String,
                value: "auto"
            },

            /*
            *  Indicates the "horizontal" alignment of the picker.            
            *  If <b>value</b> is selected as "left", then picker is aligned to the left of the target.  
            *  If <b>value</b> is selected as "right", then picker is aligned to the right of the target.
            */
            horizontalAlign: {
                type: String,
                value: "auto"
            },

            /*
             * Indicates the type of the picker. It can have the value as datetime or date or time or daterange.
             */
            pickerType: {
                type: String,
                value: "datetime"
            },

            /**
             * Indicates the `showrange` group.
             */
            showRanges: {
                type: Boolean,
                value: false                
            },

            /**
             * Indicates the `showbuttons`.
             */
            showButtons: {
                type: Boolean,
                value: false
            },           

            /**
             * Specifies whether or not to hide the default input.
             */
            noDefaultInput: {
                type: Boolean,
                reflectToAttribute: true,
                value: false,
                observer: '_onDefaultInputFlagChange'
            },

            /**
             * Specifies whether or not input textbox is readonly or editable.
             */
            isReadonlyInput: {
                type: Boolean,               
                value: false
            },

            _target: {
                type: String,
                value: "datetimePickerText"
            },
            /**
            * Specifies whether the field is required or not.
            */
            required:{
                type:Boolean,
                value:false
            }
        },

        attached: function(){
          this.$$('#datetimepicker').showButtons = this.showButtons;          
        },        

        _showPicker: function(){
            this.$$('#datetimepicker').show();
        },

        _onDefaultInputFlagChange: function(){
            if(this.noDefaultInput)
            {
                this._target = "datetimePickerIcon";
            }
        },

        // When textbox value change, set the value to date value for validation
        _onDateTextChange: function() {
            var _format = this.pickerType == "datetime" ? this.datetimeFormat : this.dateFormat;                        
            var isoDateFromText = moment(this.text, _format, true).format(this._isoDateTimeFormat);

            if(this.value == isoDateFromText)
            {
                return;
            }

            if(isoDateFromText == "Invalid date")
            {
                this.value = this.text;
                return;
            }

            this.value = isoDateFromText;
        },

        // When date value change, set the textbox value in UI format
        _onDateValueChange: function() {
            if(this.value && this.pickerType)
            {
                var format = this.pickerType == "datetime" ? this.datetimeFormat : this.dateFormat;
                this.text = FormatHelper.convertFromISODateTime(this.value, this.pickerType, format);
            }
            else
            {
                this.text = this.value;
            }            
        }
      });
    })();
  </script>

</dom-module>