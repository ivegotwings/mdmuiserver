<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../rock-entity-search-grid/rock-entity-search-grid.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html" />
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html" />
<link rel="import" href="../rock-entity-type-model-lov/rock-entity-type-model-lov.html">

<dom-module id="app-reference-discovery">
    <template>
        <style include="bedrock-style-common"></style>
        <style include="iron-flex"></style>
        <custom-style>
            <style>
                #dimensionContainer {
                    align-self: center;
                    -webkit-align-self: center;
                }

                :host {
                    --item-length-overflow: {
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                }

                pebble-popover {
                    --pebble-popover-width: 260px;
                    --pebble-popover-max-width: 100%;
                }

                pebble-popover paper-item {
                    cursor: pointer;
                    font-size: var(--default-font-size, 14px);
                    padding: 0 0 0 0;
                    min-height: 40px;
                }

                pebble-popover paper-item iron-icon {
                    --iron-icon-width: 18px;
                    --iron-icon-height: 18px;
                    color: var(--palette-white, #fff);
                }

                pebble-button {
                    --pebble-icon: {
                        color: var(--palette-white, #fff) !important;
                    };
                }

                .badge {
                    font-weight: normal;
                    border-radius: 50%;
                    margin-right: 10px;
                    width: 25px;
                    height: 25px;
                    background-color: var(--default-notification-color, #ed204c);
                    opacity: 1.0;
                    color: var(--default-notification-text-color, #ffffff);
                    @apply --layout;
                    @apply --layout-center-center;
                    @apply --paper-font-common-base;
                }

                rock-header {
                    padding: 20px 20px 0 20px;
                }

                pebble-actions {
                    --pebble-icon: {
                        color: var(--white, #fff) !important;
                        margin-top: 0:
                        margin-right: 5px;
                        margin-bottom: 0:
                        margin-left: 5px;
                    };
                }

                .quick-manage-container {
                    height: auto;
                    width: 30%;
                    display: block;
                    position: relative;
                }

                .grid-quick-manage-container {
                    width: 70%;
                }

                pebble-vertical-divider {
                    --pebble-vertical-divider-color: #c1cad4;
                    height: 100%;
                    border: 0px;
                    min-height: 0px;
                    width: 2px;
                    margin-top: 0px;
                    margin-right: 0px;
                    margin-bottom: 0px;
                    margin-left: 0px;
                }

                .container {
                    width: 100%;
                }

                pebble-actions {
                    --popover: {
                        color: var(--palette-white, #fff);
                    };
                    --popover-paper-item: {
                        padding-top: 5px;
                        padding-right: 10px;
                        padding-bottom: 5px;
                        padding-left: 10px;
                        text-align: left;
                    };
                    --popover-action-item: {
                        font-size: var(--font-size-sm, 12px);
                        color: var(--palette-steel-grey);
                    };
                    --popover-action-item-hover: {
                        color: var(--focused-line, #026bc3);
                        background-color: var(--bgColor-hover, #e8f4f9);
                    };
                    --popover-action-item-focus: {
                        color: var(--primary-button-color, #09c021);
                    };
                    --pebble-manual-actions: {
                        margin-top: 0;
                    };
                }

                .contentContainer {
                    height: calc(100% - 55px);
                }

                /* Search */
                .search-container .resetsearch {
                    position: absolute;
                    right: 0;
                    bottom: -14px;
                    font-size: var(--font-size-xs, 10px);
                    color: var(--link-text-color);
                    --pebble-button-left-icon: {
                        width: 14px !important;
                        height: 14px!important;
                        margin-right: 2px;
                        margin-top: 3px;
                        bottom: -1px;
                    };
                }

                .search-container .resetsearch pebble-button {
                    height: auto;
                    --pebble-button: {
                        font-size: var(--font-size-xs, 10px)!important;
                        height: auto;
                    };
                }

                .search-container {
                    position: relative;
                    display: inline-block;
                    width: 100%;
                }
            </style>
        </custom-style>

        <rock-layout>
            <liquid-config-aggregate-get id="getEntityDiscoveryAppConfig" verbose operation="getbyids" request-id="req1" app-name="app-reference-discovery"
                context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{_attributeModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse">
            </liquid-entity-model-composite-get>
            <rock-titlebar slot="rock-titlebar" icon="pebble-md-icons:Reference" main-title="Reference Search & Refine" non-minimizable="[[appConfig.nonMinimizable]]" non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" config-data="[[getConfig('rock-dimension-selector')]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>
            <rock-header slot="rock-header">
                <div class="fixed-content" slot="fixed-content">
                    <div class="layout horizontal">
                        <div class="action-buttons m-r-10">
                            <!-- Actions buttons and its popover -->
                            <div>
                                <pebble-button id="actions" class="dropdownText btn dropdown-success m-r-5" button-text="{{_mainTitle}}" noink dropdown-icon
                                    on-tap="_onActionsTap"></pebble-button>
                                <pebble-popover id="actionsPopover" for="actions" auto-fit-on-attach no-overlap horizontal-align="left">
                                    <rock-entity-type-model-lov multi-select="{{_multiSelect}}" domain="[[domain]]" id="referenceDataLov"></rock-entity-type-model-lov>
                                </pebble-popover>
                                <bedrock-pubsub event-name="entity-type-selection-changed" handler="_onReferenceDataChange" target-id="referenceDataLov"></bedrock-pubsub>
                            </div>
                        </div>
                        <div class="flex">
                            <!-- search bar-->
                            <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                            <div class="search-container">
                                <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                                <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                                    <pebble-button icon="pebble-sm-icons:Resetsearch" class="btn-link" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <!-- Saved Search button & its popover-->
                        </div>
                    </div>
                    <div class="layout horizontal p-t-10">
                        <div class="flex searchFilterTag">
                            <!-- Search Filter Tags -->
                            <rock-entity-search-filter id="searchFilter" selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                tags="{{tags}}"></rock-entity-search-filter>
                            <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
                            <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
                        </div>
                        <pebble-button class="btn btn-primary" button-text="Manage" on-tap="_onTapManage"></pebble-button>
                    </div>
                </div>
                <div class="shrunk-content" slot="shrunk-content">
                </div>
            </rock-header>
            <div class="layout horizontal contentContainer">
                <div id="entityGridContainer" class$="[[_applyClass(_quickManageEnabled)]]">
                    <rock-entity-search-grid id="entitySearchGrid" context-data="[[contextData]]"
                                             search-filters="[[_selectedSearchFilters]]"
                                             types-Criterion="[[_typeCriterion]]"
                                             search-query="[[_searchQuery]]"
                                             current-record-size="{{_gridFullLength}}"></rock-entity-search-grid>
                    <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem"
                                    target-id="entityGrid"></bedrock-pubsub>
                </div>
                <template is="dom-if" if="[[_quickManageEnabled]]">
                    <div>
                        <pebble-vertical-divider></pebble-vertical-divider>
                    </div>
                    <div class="quick-manage-container p-15">
                        <pebble-button icon="pebble-sm-icons:Add" class="btn btn-primary m-r-10" button-text="Add New" on-click="_onQuickManageAdd"></pebble-button>
                        <rock-entity-quick-manage id="entityQuickManage" show-Expand-Icon={{_showExpandIcon}} no-header context-data="[[contextData]]"
                            current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]" selected-entity="[[_selectedEntity]]"
                            tab-config="{{getConfig('rock-entity-quick-manage', '', 'rock-tabs')}}" toolbar-config="{{getConfig('rock-entity-quick-manage', '', 'pebble-toolbar')}}"
                            fixes="{{getConfig('rock-entity-quick-manage', '', 'rock-entity-tofix')}}"></rock-entity-quick-manage>
                        <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                        <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                        <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                    </div>
                </template>
            </div>
        </rock-layout>
        <bedrock-pubsub event-name="app-context-changed" handler="_onAppContextChanged"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-reference-discovery',
                properties: {
                    _searchResponse: {
                        type: Object,
                        value: undefined,
                        notify: true,
                        observer: '_searchResponseChanged'
                    },
                    _searchResultResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    domain: {
                        type: String,
                        value: "referenceData"
                    },
                    _gridAttributes: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                    },
                    _multiSelect: {
                        type: Boolean,
                        value: false
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        computed: 'getConfig("rock-entity-search-grid")',
                        observer: '_onGridConfigChange'
                    },
                    _currentIndex: {
                        type: Number,
                        value: -1
                    },
                    _gridFullLength: {
                        type: Number,
                        value: 0
                    },
                    _mainTitle: {
                        type: String,
                        value: "Select Reference Type"
                    },
                    _showExpandIcon: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * Indicates selected item
                      */
                    _selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _searchQuery: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    _rockEntitySearchFilter: {
                        type: Object
                    },
                    _rockSearchFilter: {
                        type: Object
                    },
                    _rockSavedSearch: {
                        type: Object
                    },
                    _currentWorkflowAction: {
                        type: String
                    },
                    _currentEntityIndex: {
                        type: Number,
                        value: 0
                    },
                    _selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _failedEntities: {
                        type: Number,
                        value: 0
                    },
                    _doneEntities: {
                        type: Number,
                        value: 0
                    },
                    _selectedSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _typeCriterion: {
                        type: String,
                        value: ""

                    },
                    _resetSearchEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _failedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                    * Indicates the request object that is passed to the data element to retrive attribute model data.
                      Sample: {
                              }
                    */
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _selectedReferenceType: {
                        type: String,
                        value: ''
                    },

                    _quickManageEnabled: {
                        type: Boolean,
                        value: false
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },
                behaviors: [
                    RUFBehaviors.AppBehavior
                ],
                ready: function () {
                    this.shadowRoot.querySelector("#searchBar").searchInput = [];
                    //get saved search id from query string
                    this._searchQuery = DataHelper.getParamValue('searchtext');
                },
                created: function () {


                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };
                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
                },
                attached: function () {

                    //get saved search id from query string
                    if (DataHelper.getParamValue('searchtext')) {
                        this.shadowRoot.querySelector('#searchBar').query = this._searchQuery;
                    }
                    this._setGridHeight();

                },
                _onApplicationConfigReceived: function (e) {
                    // this.logInfo("ConfigReceived","response",JSON.stringify(e, null, 2));
                    this.set('applicationConfig', e.detail);
                },
                _onGridConfigChange: function () {
                    if (this._gridConfig && !_.isEmpty(this._gridConfig)) {
                        this._typeCriterion = this._gridConfig.dataRequest.typesCriterion;
                    }
                    //Loading the grid for the first time with default reference type
                    this._prepareContext();
                },
                _onReferenceDataChange: function (e, detail, sender) {
                    var selectedItem = detail.data.id;
                    this.set("_typeCriterion", selectedItem);
                    this._prepareContext();

                    var popover = this.shadowRoot.querySelector("#actionsPopover");
                    if (popover) {
                        popover.hide();
                    }
                },

                _onCompositeModelGetResponse: function (e) {
                    var _attributeModelResponse = e.detail.response || {};
                    var entityId = this._selectedEntity.id;
                    this.logInfo("CompositeModelResponse", "_attributeModelResponse", JSON.stringify(_attributeModelResponse, null, 2), "entityId", entityId);

                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {

                        var attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response
                            .content.entityModels[0], this.contextData);

                        var attributeNames = Object.keys(attributeModels);

                        if (attributeNames && attributeNames.length > 0) {

                            var itemContext = ContextHelper.getFirstItemContext(this.contextData);
                            itemContext.attributeNames = attributeNames;
                            this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                            var columns = [];
                            for (var i = 0; i < attributeNames.length; i++) {
                                var model = attributeModels[attributeNames[i]];
                                columns.push({
                                    "header": model.externalName,
                                    "name": model.name,
                                    "sortable": true
                                });
                            }
                            this._gridAttributes = attributeNames;
                            this._gridConfig.dataRequest.attributes = this._gridAttributes;
                            this._gridConfig.tabular.columns = columns;
                            var grid = this._getSearchGrid();
                            grid.attributeModels={};
                            grid.gridConfig = {};
                            grid.gridConfig = this._gridConfig;
                        }
                    }
                },
                _onSearch: function (e, detail, sender) {
                    this._searchQuery = detail;
                },
                _resetSearch: function () {
                    this._searchQuery = '';
                    this.tags = [];


                    var rockSearchBar = this.shadowRoot.querySelector('#searchBar');
                    if (rockSearchBar) {
                        rockSearchBar.query = "";
                    }

                    this._selectedSearchFilters = [];
                    this.$.searchFilter.clearSearchFilters();

                    this._resetSearchEnabled = false;
                },
                _getSearchGrid: function () {
                    return ElementHelper.getElement(this, "#entitySearchGrid");
                },
                _onSelectingGridItem: function (e, detail, sender) {
                    this._selectedEntity = detail.item;
                    if (!_.isEmpty(this._selectedEntity)) {
                        var itemContext = {
                            'id': this._selectedEntity.id,
                            'type': this._selectedEntity.type,
                            'attributeNames': this._gridAttributes
                        };

                        this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext], {refresh: false});

                        this._getSearchGrid().clearSelection();
                        Polymer.Async.microTask.run(() => {
                            this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                        });
                    }
                },
                _onAttributeSave: function (e, detail, sender) {
                    //Reseting the context to load the updated grid                    
                    var itemContext = {
                        'id': "",
                        'type': this._selectedReferenceType,
                        'attributeNames': this._gridAttributes
                    };
                    this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                    //Changing the row style of the updated record
                    var searchGrid = this._getSearchGrid();
                    if (searchGrid) {
                        searchGrid.reloadGrid();

                        var selectedRow = searchGrid.getSelectedGridRow();
                        if (selectedRow) {
                            selectedRow.style['font-style'] = 'italic';
                        }
                    }
                },

                _onClickPrevious: function (e, detail, sender) {
                    if (this._currentIndex > 0) {
                        this._selectEntity(this._currentIndex - 1, 'previous');
                    }
                },
                _onClickNext: function (e, detail, sender) {
                    if (this._currentIndex < this._gridFullLength) {
                        this._selectEntity(this._currentIndex + 1);
                    }
                },
                _selectEntity: function (index, nav) {
                    if (!(index < 0)) {
                        var grid = this._getSearchGrid();
                        var gridData = grid.getData();

                        if (gridData.length > 0 && index < this._gridFullLength) {
                            if (gridData[index].attributes) {
                                this._selectedEntity = gridData[index];

                                var itemContext = {
                                    'id': this._selectedEntity.id,
                                    'type': this._selectedEntity.type,
                                    'attributeNames': this._gridAttributes
                                };
                                this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                                this._currentIndex = index;
                                grid.clearSelection();
                                grid.selectItem(gridData[index]);

                                //On previous click already data got loaded, so directly we can set scroll index
                                //but for next, data will loaded as per page size, so scroll as per allow scroll
                                if (nav == 'previous' || this._isAllowedToScroll()) {
                                    grid.scrollToIndex(this._currentIndex);
                                }
                            } else {
                                var nextScrollIndex = grid.currentRecordSize + grid.pageSize;
                                // Todo: nextScrollIndex will be based on the grid total count
                                grid.scrollToIndex(nextScrollIndex);

                                setTimeout(() => {
                                    this._selectEntity(index);
                                }, 10);
                            }
                        }
                    }
                },
                _isAllowedToScroll: function () {
                    var grid = this._getSearchGrid();

                    if (((this._currentIndex) % grid.pageSize) == 0) {
                        return true;
                    }

                    return false;
                },
                _getElement: function (element) {
                    if (element == "rockEntitySearchFilter") {
                        if (!this._rockEntitySearchFilter) {
                            this._rockEntitySearchFilter = this.shadowRoot.querySelector("#searchFilter");
                        }

                        return this._rockEntitySearchFilter
                    } else if (element == "rockSearchFilter") {
                        if (!this._rockSearchFilter) {
                            var entitySearchFilter=this._getElement("rockEntitySearchFilter");
                            if(entitySearchFilter && entitySearchFilter.shadowRoot) {
                                this._rockSearchFilter = entitySearchFilter.shadowRoot.querySelector(
                                    "rock-search-filter");
                            }
                        }
                        return this._rockSearchFilter;
                    }
                },
                _populateHeaderControls: function (savedSearch) {
                    if (savedSearch) {
                        // search input info
                        var searchBarElement = this.shadowRoot.querySelector("#searchBar");
                        if (searchBarElement) {
                            searchBarElement.query = savedSearch.searchQuery;
                        }

                        // search filter info
                        var searchFilter = this.shadowRoot.querySelector("#searchFilter");
                        if (searchFilter) {
                            searchFilter.tags = savedSearch.searchTags ? savedSearch.searchTags : [];

                            this._selectedSearchFilters = [];
                            if (!_.isEmpty(searchFilter.tags)) {
                                for (var i = 0; i < searchFilter.tags.length; i++) {
                                    var attr = {};
                                    attr[searchFilter.tags[i].name] = searchFilter.tags[i].value;
                                    this.push('_selectedSearchFilters', attr);
                                }
                            }
                        }

                        // dimensionselector info
                        var dimensionSelector = this.$.dimensionSelector;
                        if (dimensionSelector) {
                            dimensionSelector.selectedDimensions = savedSearch.dimensions;
                            dimensionSelector.shadowRoot.querySelector('rock-entity-lov').refershTemplate();
                        }

                        var _savedSearchButton = this.shadowRoot.querySelector("#savedSearchButton");
                        if (_savedSearchButton) {
                            _savedSearchButton.buttonText = savedSearch.name;
                        }
                        this._searchQuery = savedSearch.searchQuery;

                    }
                },
                /* Not used anywhere
                _searchResponseChanged: function (_searchResponse) {
                    if (!_searchResponse || !_searchResponse.content || _searchResponse.content.totalRecords ==
                        0) {
                        this._searchResultResponse = {
                            "content": {
                                "entities": {}
                            }
                        };
                    }
                },*/
                _onActionsTap: function (e) {
                    this.shadowRoot.querySelector('#actionsPopover').show();
                },
                _onActionItemTap: function (e, detail, sender) {
                    this._currentEntityIndex = 0;
                    var searchGrid = this.shadowRoot.querySelector("#entitySearchGrid");
                    if (searchGrid && searchGrid.selectedItems && searchGrid.selectedItems.length > 0) {
                        if (searchGrid.selectedItems.length > 5) {
                            this.showErrorToast("Maximum 5 entities can be selected.");
                            return;
                        } else {
                            this._selectedEntities = searchGrid.selectedItems;
                        }
                    } else {
                        this.showErrorToast(
                            "Select atleast one entity for which you want to perform this action.");
                        return;
                    }
                },
                _refreshGrid: function(){
                    var grid = this._getSearchGrid();
                    if (grid) {
                        grid.refresh();
                    }
                },
                _onAppContextChanged: function (e) {

                    this.logInfo("AppContextChanged", "contextData", JSON.stringify(e.detail.contextData));

                    this.contextData = {}; // To notify
                    this.contextData = e.detail.contextData;

                    if(!(e.detail.additionalInfo && e.detail.additionalInfo.refresh === false)) {
                        this._refreshGrid();
                    }

                    if (this.shadowRoot.querySelector("#entityQuickManage")) {
                        this.shadowRoot.querySelector("#entityQuickManage").reload();
                    }
                },
                _prepareContext: function () {
                    if (!_.isEmpty(this.contextData)) {
                        if (this._typeCriterion) {
                            this._mainTitle = this._typeCriterion;
                            this._selectedReferenceType = this._typeCriterion;
                            this._gridConfig.dataRequest.typesCriterion = [this._typeCriterion];
                            var itemContext = {};
                            itemContext.type = this._typeCriterion;
                            itemContext.attributeNames = ["_ALL"];
                            this.contextData[this.CONTEXT_TYPE_ITEM] = [itemContext];
                            var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);
                            this.set("_attributeModelRequest", compositeModelGetRequest);
                            var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                            if (liquidModelGet) {
                                liquidModelGet.generateRequest();
                            }
                        }
                    }

                    if (this._quickManageEnabled) {
                        if (this.shadowRoot.querySelector("#entityQuickManage")) {
                            this.shadowRoot.querySelector("#entityQuickManage").reload();
                        }
                    } else {
                        this._refreshGrid();
                    }
                },
                _showResetSearch: function (e) {
                    var rockSearchBar = this.shadowRoot.querySelector('#searchBar');
                    var rockSearchFilter = this._getElement('rockSearchFilter');
                    var query = '';
                    var tags = [];

                    if (rockSearchBar) {
                        query = rockSearchBar.query;
                    }

                    if (rockSearchFilter) {
                        tags = rockSearchFilter.tags;
                    }

                    if (!_.isEmpty(query) || tags.length > 0) {
                        this._resetSearchEnabled = true;
                    } else {
                        this._resetSearchEnabled = false;
                    }
                },
                _onQuickManageAdd: function () {
                    var itemContext = {
                        'id': "-1",
                        'type': this._selectedReferenceType,
                        'attributeNames': this._gridAttributes
                    };
                    this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                    this._getSearchGrid().clearSelection();
                },
                _onTapManage: function () {
                    if (!_.isEmpty(this._selectedReferenceType)) {
                        this._quickManageEnabled = !this._quickManageEnabled;
                        var grid = this._getSearchGrid();
                        var selectedCount = grid.getSelectedItems();
                        if (selectedCount.length > 1) {
                            this.showWarningToast("Cannot use multiple records for Quick Manage");
                        }

                        if (this._quickManageEnabled) {
                            var selectedItem = grid.selectedItem;
                            this._selectedEntity = selectedItem;

                            if (!_.isEmpty(selectedItem)) {

                                var itemContext = {
                                    'id': selectedItem.id,
                                    'type': selectedItem.type
                                };
                                this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                                grid.clearSelection(); //Clear current selection
                                grid.selectItem(selectedItem); //Select item
                                this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                                grid.scrollToIndex(this._currentIndex);
                            }
                        } else {
                            this._currentIndex = -1;
                        }

                        grid.notifyResize();
                    } else {
                        this.showInformationToast("Please select reference type to manage.");
                    }
                },
                _applyClass: function () {
                    if (this._quickManageEnabled) {
                        return "grid-quick-manage-container";
                    }

                    return "container";
                }      ,
                _setGridHeight: function () {
                    var rockGridHeight = 0;
                    var rockLayout = this.shadowRoot.querySelector('rock-layout');
                    if(rockLayout) {
                        var layout = rockLayout.shadowRoot.querySelector('#rockLayoutContainer');
                        if (layout) {
                            var footer = rockLayout.shadowRoot.querySelector('rock-footer');
                            rockGridHeight = layout.offsetHeight;
                            if (footer) {
                                rockGridHeight = rockGridHeight - footer.offsetHeight;
                            } else {
                                rockGridHeight = rockGridHeight;
                            }
                        }
                    }
                    var grid = this.shadowRoot.querySelector("rock-entity-search-grid");
                    if (grid && rockGridHeight > 0) {
                        grid.updateStyles({"--rock-grid-height": rockGridHeight -38 + 'px'});
                    }

                }

            });
        })();
    </script>
</dom-module>