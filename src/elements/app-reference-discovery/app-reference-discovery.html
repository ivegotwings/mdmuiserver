<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-query-builder-behavior/bedrock-query-builder-behavior.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">

<link rel="import" href="../pebble-actions/pebble-actions.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">

<link rel="import" href="../rock-entity-search-result/rock-entity-search-result.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../rock-business-actions/rock-business-actions.html">
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-search-filter/rock-entity-search-filter.html" />
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html" />
<link rel="import" href="../rock-entity-type-model-lov/rock-entity-type-model-lov.html">
<link rel="import" href="../rock-search-query-parser/rock-search-query-parser.html" />

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<dom-module id="app-reference-discovery">
    <template>
        <style include="bedrock-style-common"></style>
        <style include="iron-flex"></style>
        <style>
            #dimensionContainer {
                align-self: center;
                -webkit-align-self: center;
            }

            :host {
                --item-length-overflow: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            pebble-popover {
                --pebble-popover-width: 260px;
                --pebble-popover-max-width: 100%;
            }

            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--default-font-size, 14px);
                padding: 0 0 0 0;
                min-height: 40px;
            }

            .badge {
                font-weight: normal;
                border-radius: 50%;
                margin-right: 10px;
                width: 25px;
                height: 25px;
                background-color: var(--default-notification-color, #ed204c);
                opacity: 1.0;
                color: var(--default-notification-text-color, #ffffff);
                @apply --layout;
                @apply --layout-center-center;
                @apply --paper-font-common-base;
            }

            rock-header {
                padding: 20px 20px 0 20px;
            }

            .quick-manage-container {
                height: auto;
                width: 31%;
                display: block;
                position: relative;
            }

            .grid-quick-manage-container {
                width: 70%;
            }

            pebble-vertical-divider {
                --pebble-vertical-divider-color: #c1cad4;
                height: 100%;
                border: 0px;
                min-height: 0px;
                width: 2px;
                margin-top: 0px;
                margin-right: 0px;
                margin-bottom: 0px;
                margin-left: 0px;
            }

            .container {
                width: 100%;
            }

            pebble-actions {
                --popover: {
                    color: var(--palette-white, #fff);
                }
                ;
                --popover-paper-item: {
                    padding-top: 5px;
                    padding-right: 10px;
                    padding-bottom: 5px;
                    padding-left: 10px;
                    text-align: left;
                }
                ;
                --popover-action-item: {
                    font-size: var(--font-size-sm, 12px);
                    color: var(--palette-steel-grey);
                }
                ;
                --popover-action-item-hover: {
                    color: var(--focused-line, #026bc3);
                    background-color: var(--bgColor-hover, #e8f4f9);
                }
                ;
                --popover-action-item-focus: {
                    color: var(--primary-button-color, #09c021);
                }
                ;
                --pebble-manual-actions: {
                    margin-top: 0;
                }
                ;
            }

            .contentContainer {
                height: calc(100% - 55px);
            }

            /* Search */

            .search-container .resetsearch {
                position: absolute;
                right: 0;
                bottom: -12px;
                font-size: var(--font-size-xs, 10px);
                color: var(--link-text-color, #036Bc3);
            }

            .search-container .resetsearch pebble-button {
                height: auto;
                --pebble-button: {
                    font-size: var(--font-size-xs, 10px)!important;
                    height: auto;
                    padding-bottom: 0;
                };
                --pebble-icon-dimension: {
                    width: 12px;
                    height: 12px;
                };
                --pebble-button-left-icon: {
                    margin-right: 5px;
                }
            }

            .search-container {
                position: relative;
                display: inline-block;
                width: 100%;
            }

            #actionsButton {
                margin-left: 10px
            }

            #refTypeMsg {
                top: 0;
                left: 30px;
                right: 30px;
                bottom: auto;
            }
            rock-layout {
                --scroller: {
                    overflow: hidden;
                }
            }
            rock-entity-quick-manage {
                --quick-manage-header:{
                    padding-top:0;
                };
                --first-row:{
                    padding:0;
                }
            }
        </style>
        <rock-layout>
            <liquid-entity-model-composite-get name="compositeAttributeModelGet" on-entity-model-composite-get-response="_onCompositeModelGetResponse">
            </liquid-entity-model-composite-get>
            <rock-titlebar slot="rock-titlebar" icon="pebble-icon:data-model" main-title="Reference Search & Refine" non-minimizable="[[appConfig.nonMinimizable]]"
                non-closable="[[appConfig.nonClosable]]">
                <div id="dimensionContainer" align="right">
                    <rock-dimension-selector id="dimensionSelector" context-data="[[contextData]]" app-name="app-reference-discovery" domain="[[domain]]" all-multi-select></rock-dimension-selector>
                </div>
            </rock-titlebar>

            <template is="dom-if" if="[[isContextLoaded]]">
                <rock-header slot="rock-header">
                    <div class="fixed-content" slot="fixed-content">
                        <div class="layout horizontal">
                            <div class="action-buttons m-r-10">
                                <!-- Actions buttons and its popover -->
                                <div>
                                    <pebble-button id="actions" class="dropdownText btn dropdown-outline-primary m-r-5" button-text="{{_mainTitle}}" noink dropdown-icon
                                        on-tap="_onActionsTap"></pebble-button>
                                    <pebble-popover id="actionsPopover" for="actions" no-overlap horizontal-align="left">
                                        <rock-entity-type-model-lov multi-select="{{_multiSelect}}" domain="[[domain]]" id="referenceDataLov" sort-field="externalName"></rock-entity-type-model-lov>
                                    </pebble-popover>
                                    <bedrock-pubsub event-name="entity-type-selection-changed" handler="_onReferenceDataChange" target-id="referenceDataLov"></bedrock-pubsub>
                                </div>
                            </div>
                            <div class="flex">
                                <!-- search bar-->
                                <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                                <bedrock-pubsub event-name="rock-search-update" handler="_showResetSearch" target-id="searchBar"></bedrock-pubsub>
                                <div class="search-container">
                                    <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                                    <div class="resetsearch" hidden$="[[!_resetSearchEnabled]]">
                                        <pebble-button icon="pebble-icon:reset" class="btn-link pebble-icon-color-blue" on-tap="_resetSearch" button-text="Reset Search"></pebble-button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <!-- Saved Search button & its popover-->
                            </div>
                        </div>
                        <template is="dom-if" if="[[_processTemplate]]">
                            <div class="layout horizontal p-t-10">
                                <div class="flex searchFilterTag">
                                    <!-- Search Filter Tags -->
                                    <rock-entity-search-filter id="searchFilter" selected-search-filters="{{_selectedSearchFilters}}" context-data="[[contextData]]"
                                        types-criterion="[[_typesCriterion]]" tags="{{tags}}" settings="[[_getComponentSettings('rock-entity-search-filter')]]"></rock-entity-search-filter>
                                    <bedrock-pubsub event-name="tag-item-added" handler="_showResetSearch"></bedrock-pubsub>
                                    <bedrock-pubsub event-name="tag-item-remove" handler="_showResetSearch"></bedrock-pubsub>
                                    <bedrock-pubsub event-name="build-query" handler="_buildQueryString"></bedrock-pubsub>
                                </div>
                                <rock-business-actions id="businessActions" context-data="[[contextData]]"></rock-business-actions>
                                <bedrock-pubsub event-name="business-actions-action-click" handler="_onBusinessActionItemTap" target-id="businessActions"></bedrock-pubsub>
                            </div>
                        </template>
                    </div>
                    <div class="shrunk-content" slot="shrunk-content">
                    </div>
                </rock-header>
                <div class="layout horizontal contentContainer">
                    <div id="entityGridContainer" class$="[[_applyClass(_quickManageEnabled)]]">
                        <div id="refTypeMsg" class="default-message" hidden$="[[_isTypesCriterionAvailable(_typesCriterion)]]"> Please select reference type </div>
                        <rock-entity-search-result id="entitySearchGrid" context-data="[[contextData]]" search-filters="[[_selectedSearchFilters]]"
                            types-Criterion="[[_typesCriterion]]" search-query="[[_searchQuery]]" process-with-dynamic-fields dynamic-fields="[[_dynamicFields]]"
                            current-record-size="{{_gridFullLength}}">
                        </rock-entity-search-result>
                        <bedrock-pubsub event-name="grid-selecting-item" handler="_onSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
                        <bedrock-pubsub event-name="grid-deselecting-item" handler="_onDeSelectingGridItem" target-id="entityGrid"></bedrock-pubsub>
                        <bedrock-pubsub event-name="grid-refresh-items" handler="_onRefreshGrid" target-id="entityGrid"></bedrock-pubsub>
                        <bedrock-pubsub event-name="quick-manage-event" handler="_onTapManage"></bedrock-pubsub>
                    </div>
                    <template is="dom-if" if="[[_quickManageEnabled]]" restamp>
                        <div>
                            <pebble-vertical-divider></pebble-vertical-divider>
                        </div>
                        <div class="quick-manage-container p-l-15 p-r-15">
                            <pebble-button icon="pebble-icon:action-add" class="btn btn-primary m-r-10" button-text="Add New" on-click="_onQuickManageAdd"></pebble-button>
                            <rock-entity-quick-manage id="entityQuickManage" show-Expand-Icon={{_showExpandIcon}} no-header context-data="[[_quickManageContextData]]"
                                current-index="{{_currentIndex}}" current-record-size="[[_gridFullLength]]" selected-entity="[[_selectedEntity]]"></rock-entity-quick-manage>
                            <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                            <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                            <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                        </div>
                    </template>
                </div>
                <rock-search-query-parser id="queryParser" context-data="[[contextData]]"></rock-search-query-parser>
                <bedrock-pubsub id="parser-event" event-name="on-search-filters" handler="_onSearchFiltersChange" target-id="queryParser"></bedrock-pubsub>
            </template>
        </rock-layout>
        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="dimensionSelector"></bedrock-pubsub>

    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-reference-discovery',
                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    domain: {
                        type: String,
                        value: "referenceData"
                    },
                    appConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    publish: {
                        type: Boolean,
                        value: false
                    },
                    _searchResponse: {
                        type: Object,
                        value: undefined,
                        notify: true,
                        observer: '_searchResponseChanged'
                    },
                    _searchResultResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    _gridAttributes: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                    },
                    _multiSelect: {
                        type: Boolean,
                        value: false
                    },
                    _currentIndex: {
                        type: Number,
                        value: -1
                    },
                    _gridFullLength: {
                        type: Number,
                        value: 0
                    },
                    _mainTitle: {
                        type: String,
                        value: "Select Reference Type"
                    },
                    _showExpandIcon: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * Indicates selected item
                      */
                    _selectedEntity: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _searchQuery: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    _rockEntitySearchFilter: {
                        type: Object
                    },
                    _rockSearchFilter: {
                        type: Object
                    },
                    _rockSavedSearch: {
                        type: Object
                    },
                    _currentWorkflowAction: {
                        type: String
                    },
                    _currentEntityIndex: {
                        type: Number,
                        value: 0
                    },
                    _selectedEntities: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _failedEntities: {
                        type: Number,
                        value: 0
                    },
                    _doneEntities: {
                        type: Number,
                        value: 0
                    },
                    _selectedSearchFilters: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _typesCriterion: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _resetSearchEnabled: {
                        type: Boolean,
                        value: false
                    },
                    _failedEntityTypes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                    * Indicates the request object that is passed to the data element to retrive attribute model data.
                      Sample: {
                              }
                    */
                    _attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _selectedReferenceType: {
                        type: String,
                        value: ''
                    },
                    _quickManageEnabled: {
                        type: Boolean,
                        value: false
                    },
                    inputQueryString: {
                        type: String,
                        value: ""
                    },
                    _attributeListArray: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _searchBarElement: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _entitySearchFilterElement: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _quickManageContextData: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    isContextLoaded: {
                        type: Boolean,
                        value: false
                    },
                    configData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _processTemplate: {
                        type: Boolean,
                        value: false
                    },
                },

                behaviors: [
                    RUFBehaviors.QueryBuilderBehavior,
                    RUFBehaviors.AppBehavior,
                    RUFBehaviors.ComponentConfigBehavior
                ],

                ready: function () {
                    if (this._searchBarElement) {
                        this._searchBarElement.searchInput = [];
                    }
                    //get saved search id from query string
                    this._searchQuery = DataHelper.getParamValue('searchtext') || "";
                },

                created: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "tenant": this.tenantId
                    };
                    this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];
                },

                attached: function () {
                    
                },

                _onContextDataChange: function () {
                    if (!_.isEmpty(this.contextData)) {
                        this._quickManageContextData = DataHelper.cloneObject(this.contextData);

                        this.requestConfig('rock-reference-discovery', this._quickManageContextData);
                    }
                },

                onConfigLoaded: function (componentConfig) {
                    if (componentConfig && componentConfig.config) {

                        this.configData = componentConfig.config;
                        this._processTemplate = true;
                        this._initializeComponent();
                        //get saved search id from query string
                        if (!DataHelper.isEmptyObject(this._searchQuery) && this._searchBarElement) {
                            this._searchBarElement.query = this._searchQuery;
                        }
                        this._setGridHeight();
                        
                        this._typesCriterion = [componentConfig.config.defaultReferenceType];
                        this.publish = componentConfig.config.showPublish;
                        this._buildQueryString();
                    }
                    //this._prepareContext();
                },

                _onBusinessActionItemTap: function(e) {
                    if(e && "detail" in e) {
                        var data = "data" in e.detail && e.detail.data;
                        if(!_.isEmpty(data)) {
                            if(data.eventName == "action-re-publish") {
                                this._rePublish(data.subComponentName);
                            }
                        }
                    }
                },

                _rePublish: function (subComponentName) {
                    var selectedItems = this._searchGridElement.getSelectedItems();
                    var selectionMode = this._searchGridElement.getSelectionMode();
                    var selectionQuery = this._searchGridElement.getSelectedItemsAsQuery();

                    var eventName;
                    var asyncAvailable = false;

                    if (!asyncAvailable || (asyncAvailable && selectionMode == "count")) {
                        if (DataHelper.isEmptyObject(selectedItems)) {
                            this.showErrorToast(
                                "Select atleast one entity for which you want to perform this action."
                            );
                            return;
                        }
                    }

                    if (!DataHelper.isEmptyObject(selectedItems) && selectedItems.length > 200) {
                        this.showErrorToast("Maximum 200 entities can be selected.");
                        return;
                    }
                    if (!DataHelper.isEmptyObject(selectedItems)) {
                        this._selectedEntities = selectedItems;
                    }
                  
                    const sharedData = {
                        "context-data": this._quickManageContextData,
                        "selected-entities": this._selectedEntities,
                        "selection-query": selectionQuery,
                        "selection-mode": selectionMode
                    };

                    this.openBusinessFunctionDialog({ name: 'rock-wizard-re-publish', subName: subComponentName }, sharedData);
                },
                _showToastMessage: function (msgObject) {
                    if (msgObject) {
                        if (msgObject.type == "error") {
                            this.showErrorToast(msgObject.message, 10000);
                        } else if (msgObject.type == "success") {
                            this.showSuccessToast(msgObject.message, 10000);
                        }
                    }
                },

                _initializeComponent: function () {
                    this._rockLayout = this.shadowRoot.querySelector('rock-layout');
                    this._entityTypeModelLov = this.shadowRoot.querySelector("#referenceDataLov");
                    this._searchGridElement = this.shadowRoot.querySelector("#entitySearchGrid");
                    this._searchBarElement = this.shadowRoot.querySelector("#searchBar");
                    this._entitySearchFilterElement = this.shadowRoot.querySelector("#searchFilter");
                    this._popover = this.shadowRoot.querySelector("#actionsPopover");
                    this._grid = this.shadowRoot.querySelector("rock-entity-search-result");
                    this._parserPubsub = this.shadowRoot.querySelector("#parser-event");
                    this._queryParser = this.shadowRoot.querySelector("#queryParser");
                },
                _onReferenceDataChange: function (e, detail, sender) {
                    var selectedItem = detail.data.id;
                    this.set("_typesCriterion", [selectedItem]);
                    /***
                     * TODO: Need to discuss this. There is/are existing attribute filter(s), when reference entity
                     * type changed, what should we do with the existing attribute filter tag(s). Keep them or remove?
                     * For now removing the existing filters.
                     * */
                    this._selectedSearchFilters = [];
                    this.shadowRoot.querySelector("#searchFilter").clearSearchFilters();
                    //this._prepareContext();
                    this._buildQueryString();

                    this._popover.hide();
                },

                _prepareContext: async function () {
                    if (!_.isEmpty(this.contextData)) {
                        if (this._typesCriterion) {
                            var typeExternalName = await EntityTypeManager.getInstance().getTypeExternalNameByIdAsync(this._typesCriterion[0]);
                            this._mainTitle = typeExternalName;
                            
                            this._selectedReferenceType = this._typesCriterion[0];
                            var itemContext = {};
                            itemContext.type = this._typesCriterion[0];
                            itemContext.attributeNames = ["_ALL"];
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                            var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                            this._liquidModelGet = this._liquidModelGet || this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                            if (this._liquidModelGet) {
                                this._liquidModelGet.requestData = compositeModelGetRequest;
                                this._liquidModelGet.generateRequest();
                            }
                        }
                    }
                },

                _onCompositeModelGetResponse: function (e) {
                    var _attributeModelResponse = e.detail.response || {};
                    var entityId = this._selectedEntity.id;

                    this.logInfo("CompositeModelResponse", "_attributeModelResponse", JSON.stringify(_attributeModelResponse, null, 2), "entityId", entityId);

                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {

                        var attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response
                            .content.entityModels[0], this.contextData);

                        var attributeNames = Object.keys(attributeModels);

                        if (attributeNames && attributeNames.length > 0) {

                            var itemContext = ContextHelper.getFirstItemContext(this.contextData);
                            itemContext.attributeNames = attributeNames;
                            this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                            this._quickManageContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                            var columns = {};
                            for (var i = 0; i < attributeNames.length; i++) {
                                var linkTemplate = "";
                                //Set the first item of the grid as a link to the entity manage screen
                                if(i==0) {
                                    linkTemplate = "entity-manage?id={id}&type={type}";
                                }
                                var model = attributeModels[attributeNames[i]];
                                columns[model.name] = {
                                    "header": model.externalName,
                                    "name": model.name,
                                    "sortable": true,
                                    "linkTemplate": linkTemplate                                    
                                };
                            }

                            this._gridAttributes = attributeNames;
                            this._dynamicFields = columns; //Fields are prepared based on reference type change
                            this._refreshGrid();
                        }
                    }
                },
                _onSearch: function (e, detail, sender) {
                    if (!_.isEmpty(detail)) {
                        this._searchQuery = detail.query;
                        this._buildQueryString();
                    }
                },
                _resetSearch: function () {
                    this._searchQuery = '';
                    this.tags = [];

                    if (this._searchBarElement) {
                        this._searchBarElement.query = "";
                        this._searchBarElement.searchText = "";
                        //TODO: Temperory fix to show keyword in search bar. Will be removed once advanced search implemented here
                        this._searchBarElement.setAttribute("placeholder", "Enter Search text");
                    }

                    this.inputQueryString = "";
                    this._attributeListArray = [];
                    this._selectedSearchFilters = [];
                    if(this.shadowRoot.querySelector("#searchFilter")){
                        this.shadowRoot.querySelector("#searchFilter").clearSearchFilters();
                    }

                    this._resetSearchEnabled = false;
                    //this._refreshGrid();
                    this._buildQueryString();
                },
                _getSearchGrid: function () {
                    return ElementHelper.getElement(this, "#entitySearchGrid");
                },
                _onSelectingGridItem: function (e, detail, sender) {
                    if (this._quickManageEnabled) {
                        this._selectedEntity = detail.item;
                        if (!_.isEmpty(this._selectedEntity)) {
                            var itemContext = {
                                'id': this._selectedEntity.id,
                                'type': this._selectedEntity.type,
                                'attributeNames': this._gridAttributes
                            };

                            this._quickManageContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                            this._getSearchGrid().clearSelection();
                            Polymer.Async.microTask.run(() => {
                                this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                                this._refreshQuickManage();
                            });
                        }
                    }
                },
                _onDeSelectingGridItem: function () {
                    if (this._quickManageEnabled) {
                        this._selectedEntity = {};
                    }
                },
                _onRefreshGrid: function (event) {
                    if (event.detail.invalidateEntityCache) {
                        if (this._typesCriterion && this._typesCriterion[0]) {
                            var entity = {
                                "type": this._typesCriterion[0]
                            };
                            LiquidDataObjectUtils.invalidateDataObjectCache(entity);
                        }
                        if (this._quickManageEnabled) {
                            this._quickManageEnabled = false;
                            this._selectedEntity = {};
                            this._getSearchGrid().notifyResize();
                        }
                    }
                },

                _onAttributeSave: function (e, detail, sender) {
                    //Reseting the context to load the updated grid                    
                    var itemContext = {
                        'id': "",
                        'type': this._selectedReferenceType,
                        'attributeNames': this._gridAttributes
                    };
                    this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                    //Changing the row style of the updated record
                    var searchGrid = this._getSearchGrid();
                    if (searchGrid) {
                        var selectedRow = searchGrid.getSelectedGridRow();
                        if (selectedRow) {
                            selectedRow.style['font-style'] = 'italic';
                        }
                    }
                },

                _onClickPrevious: function (e, detail, sender) {
                    if (this._currentIndex > 0) {
                        this._selectEntity(this._currentIndex - 1, 'previous');
                    }
                },
                _onClickNext: function (e, detail, sender) {
                    if (this._currentIndex < this._gridFullLength) {
                        this._selectEntity(this._currentIndex + 1);
                    }
                },
                _selectEntity: function (index, nav) {
                    if (!(index < 0)) {
                        var grid = this._getSearchGrid();
                        var gridData = grid.getData();

                        if (gridData.length > 0 && index < this._gridFullLength) {
                            if (gridData[index].attributes) {
                                this._selectedEntity = gridData[index];

                                var itemContext = {
                                    'id': this._selectedEntity.id,
                                    'type': this._selectedEntity.type,
                                    'attributeNames': this._gridAttributes
                                };
                                this._quickManageContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                                this._currentIndex = index;
                                grid.clearSelection();
                                grid.selectItem(gridData[index]);

                                //On previous click already data got loaded, so directly we can set scroll index
                                //but for next, data will loaded as per page size, so scroll as per allow scroll
                                if (nav == 'previous' || this._isAllowedToScroll()) {
                                    grid.scrollToIndex(this._currentIndex);
                                }
                            } else {
                                var nextScrollIndex = grid.currentRecordSize + grid.pageSize;
                                // Todo: nextScrollIndex will be based on the grid total count
                                grid.scrollToIndex(nextScrollIndex);

                                setTimeout(() => {
                                    this._selectEntity(index);
                                }, 10);
                            }
                        }

                        this._refreshQuickManage();
                    }
                },
                _isAllowedToScroll: function () {
                    var grid = this._getSearchGrid();

                    if (((this._currentIndex) % grid.pageSize) == 0) {
                        return true;
                    }

                    return false;
                },
                _onActionsTap: function (e) {
                    this._popover.show();
                },
                _refreshGrid: function () {
                    var grid = this._getSearchGrid();
                    if (grid) {
                        grid.refresh();
                    }
                },
                _refreshComponent: function () {
                    this._refreshQuickManage();
                    this._refreshGrid();
                },

                _refreshQuickManage: function() {
                    this._quickManage = this._quickManage || this.shadowRoot.querySelector("#entityQuickManage");
                    if (this._quickManage) {
                        this._quickManage.reload();
                    }
                },

                _showResetSearch: function (e) {
                    var rockSearchFilter = undefined;
                    if (!_.isEmpty(this._entitySearchFilterElement)) {
                        rockSearchFilter = this._entitySearchFilterElement.$$("rock-search-filter");
                    }
                    var query = '';
                    var tags = [];

                    if (!_.isEmpty(this._searchBarElement)) {
                        query = this._searchBarElement.query;
                    }

                    if (rockSearchFilter) {
                        tags = rockSearchFilter.tags;
                    }

                    if (!_.isEmpty(query) || tags.length > 0 || this.inputQueryString != "") {
                        this._resetSearchEnabled = true;
                    }
                },
                _onQuickManageAdd: function () {
                    var itemContext = {
                        'id': "-1",
                        'type': this._selectedReferenceType,
                        'attributeNames': this._gridAttributes
                    };
                    this._quickManageContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                    this._refreshQuickManage();

                    this._getSearchGrid().clearSelection();
                },
                _onTapManage: function () {
                    if (!_.isEmpty(this._selectedReferenceType)) {
                        this._quickManageEnabled = !this._quickManageEnabled;
                        var grid = this._getSearchGrid();
                        var selectedCount = grid.getSelectedItems();
                        if (selectedCount.length > 1) {
                            this.showWarningToast("Cannot use multiple records for Quick Manage");
                        }

                        if (this._quickManageEnabled) {
                            var selectedItem = grid.selectedItem;
                            this._selectedEntity = selectedItem;

                            if (!_.isEmpty(selectedItem)) {

                                var itemContext = {
                                    'id': selectedItem.id,
                                    'type': selectedItem.type
                                };

                                this._quickManageContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                                grid.clearSelection(); //Clear current selection
                                grid.selectItem(selectedItem); //Select item
                                this._currentIndex = this._getSearchGrid().getSelectedItemIndex();
                                grid.scrollToIndex(this._currentIndex);
                            }

                            this._refreshQuickManage();
                        } else {
                            this._currentIndex = -1;
                        }

                        grid.notifyResize();
                    } else {
                        this.showInformationToast("Please select reference type to manage.");
                    }
                },
                _applyClass: function () {
                    if (this._quickManageEnabled) {
                        return "grid-quick-manage-container";
                    }

                    return "container";
                },
                _setGridHeight: function () {
                    var rockGridHeight = 0;
                    this._rockLayoutContainer = this._rockLayoutContainer || this._rockLayout.shadowRoot.querySelector('#rockLayoutContainer');
                    if (this._rockLayoutContainer) {
                        this._footer = this._footer || this._rockLayout.shadowRoot.querySelector('rock-footer');
                        rockGridHeight = this._rockLayoutContainer.offsetHeight;
                        if (this._footer) {
                            rockGridHeight = rockGridHeight - this._footer.offsetHeight;
                        } else {
                            rockGridHeight = rockGridHeight;
                        }
                    }
                    if (rockGridHeight > 0) {
                        this._grid.updateStyles({ "--rock-grid-height": rockGridHeight - 38 + 'px' });
                    }
                },
                _onDimensionsChanged: function (e) {
                    var newDimensions = e.detail.dimensions;
                    newDimensions["app"] = ["app-reference-discovery"];

                    if(this.domain) {
                        newDimensions["domain"] = [this.domain];
                    }

                    // Created seperate copy of context data for action functionality who needs selected entity info.
                    // May be need to correct it in proper way.
                    ContextHelper.updateContextData(this.contextData, newDimensions);
                    ContextHelper.updateContextData(this._quickManageContextData, newDimensions);
                    if(this.isContextLoaded) {
                        this._refreshComponent();
                    } else {
                        this.set("isContextLoaded", true);
                        this._onContextDataChange();
                    }
                },
                _isTypesCriterionAvailable: function (typesCriterion) {
                    if (!_.isEmpty(typesCriterion)) {
                        return true;
                    }

                    return false;
                },
                _buildQueryString: async function (e, detail) {
                    //Closing the quick manage to enable search if it is opened when search query is built
                    if (this._quickManageEnabled) {
                        this._onTapManage();
                    }
                    this._queryBuilder = this._queryBuilder || this.shadowRoot.querySelector("#queryBuilder");
                    var queryBuilderData = {};
                    if (this._queryBuilder) {
                        queryBuilderData = this._queryBuilder.getQueryBuilderData();
                    }
                    //User has input some keyword search criteria
                    var keywordSearchStr = "";
                    if (this._searchQuery) {
                        keywordSearchStr = this._searchQuery;
                    }

                    var attributeListArray = [];
                    if (detail) {
                        var attributeList = detail;

                        for (var i = 0; i < attributeList.length; i++) {
                            let newItem = {
                                name: attributeList[i].longName,
                                value: (attributeList[i].displayValue).replace(/"|'/g, ""),
                                attributeModel: attributeList[i].options
                            }
                            attributeListArray.push(newItem);
                        }
                    }

                    this.set("_attributeListArray", attributeListArray);
                    //show externalName in placeholder
                    if (this._typesCriterion.length > 0) {
                        await EntityTypeManager.getInstance().getTypeExternalNameByIdAsync(this._typesCriterion[0]);
                    }
                    //this binding not working it returns null
                    //hardbinding directly to behavior                   
                    var queryString = RUFBehaviors.QueryBuilderBehavior.buildQuery(this._typesCriterion, this._attributeListArray, queryBuilderData, false, keywordSearchStr);
                    //this binding not working it returns null
                    //hardbinding directly to behavior
                    var parsableString = RUFBehaviors.QueryBuilderBehavior.buildQuery(this._typesCriterion, this._attributeListArray, queryBuilderData, true, keywordSearchStr);

                    this._displayQuery(queryString, parsableString);
                    this._parseQuery(parsableString);
                },
                /**
                * Function to display the query on the search bar
                */
                _displayQuery: function (queryStr, parsableQueryStr) {
                    this.inputQueryString = queryStr;

                    if (this._searchBarElement) {
                        this._searchBarElement.searchInput = [];
                        if (queryStr) {
                            this._searchBarElement.query = this._searchQuery;
                            this._searchBarElement.searchText = this._searchQuery;
                            this._searchBarElement.setAttribute("placeholder", "");
                            if(queryStr.indexOf("!%&") > -1){
                                queryStr = queryStr.replace( /!%&|=/g, "" );
                            }
                            this._searchBarElement.setAttribute("placeholder", queryStr);
                        }
                        if (parsableQueryStr) {
                            this._searchBarElement.internalQuery = parsableQueryStr;
                        }
                    }

                    this._showResetSearch();
                },
                /**
                * Function to parse the query
                */
                _parseQuery: function (query) {
                    this._parserPubsub.registerEvent();
                    this._queryParser.parseQueryToFilters(query);
                },
                _onSearchFiltersChange: function (e, detail) {
                    this._updateProperties(detail);
                },
                _updateProperties: function (searchFilters) {
                    var typesCriterion = searchFilters.typesCriterion;
                    var selectedSearchFilters = searchFilters.attributesCriterion;
                    var searchQuery = searchFilters.searchQuery ? searchFilters.searchQuery : "";
                    this.set("_typesCriterion", typesCriterion);
                    this.set("_selectedSearchFilters", selectedSearchFilters);
                    this.set("_searchQuery", searchQuery);
                    if (this._entitySearchFilterElement && this._entitySearchFilterElement.refresh) {
                        this._entitySearchFilterElement.refresh();
                    }
                    this._prepareContext();
                },
                _getComponentSettings: function(componentName){
                    if (typeof (this.configData) == "object") {
                        if(this.configData.componentSettings) {
                            return this.configData.componentSettings[componentName];
                        }
                    }
                }
            });
          
        })();
    </script>
</dom-module>
