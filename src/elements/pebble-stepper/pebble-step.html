<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/paper-badge/paper-badge.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-textarea/pebble-textarea.html">

<!--
`pebble-step` Represents a child element to the `pebble-stepper` element. 
Each step that is indicating the given flow in the `pebble-stepper`

@group Pebble Elements
@element pebble-step
@demo demo/index.html
-->
<dom-module id="pebble-step">
  <template>
    <style>
    /* horizontal step style */
    :host([_horizontal]) {
        @apply(--layout-horizontal);
        @apply(--paper-font-common-base);
      }
      :host([_horizontal]) #label {
        @apply(--layout-vertical);
        @apply(--layout-center);
        position: relative;
      }
      :host([_horizontal]) #step-heading {
        @apply(--layout-vertical);
        @apply(--layout-center);
        max-width: var(--pebble-connected-badge-width,26px);
      }
      :host([_horizontal]) #connectedBadge {
        z-index: 1;
        @apply(--layout-horizontal);
      }
      :host([_horizontal]) #textWrapper {
        z-index: 1;
        color: var(--paper-grey-400);
        @apply(--layout-vertical);
        width: 50px; 
      }
      :host([_horizontal]) #beforeConnectorLine, :host([_horizontal]) #afterConnectorLine {
        width: var(--pebble-horizontal-step-connector-line-width, 60px);
        background: var(--connectorLine-color, --paper-grey-300);
        height: var(--pebble-horizontal-step-connector-line-height, 1px);
        margin-top: calc(var(--pebble-connected-badge-width, 26px)/2);
      }
      :host([_horizontal]) #contentConnectorLine {
        height: var(--pebble-horizontal-step-connector-line-height, 1px);
        background: var(--divider-color, --paper-grey-300);
      }
      :host([_horizontal]) #collapse {
         @apply(--layout-horizontal);
         --iron-collapse-transition-duration: var(--pebble-vertical-step-transition-duration, 500ms);
      }
    /* horizontal child step style */
      :host([_horizontal]) #childLabel {
        @apply(--layout-vertical);
        @apply(--layout-center);
        position: relative;
      }
      :host([_horizontal]) #connectedChildBadge {
        @apply(--layout-horizontal);
        margin-top: calc((var(--pebble-connected-badge-width,26px) - var(--pebble-connected-childBadge-width,12px))/2 );
      }
      :host([_horizontal]) #child-step-heading {
        @apply(--layout-vertical);
        @apply(--layout-center);
        max-width: var(--pebble-connected-child-badge-width,12px);
      }
      :host([_horizontal]) #childBeforeConnectorLine, :host([_horizontal]) #childAfterConnectorLine {
        width: var(--pebble-horizontal-step-child-connector-line-width, 40px);
        background: var(--palette-pale-grey, --paper-grey-300);
        height: var(--pebble-horizontal-step-child-connector-line-height, 1px);
        margin-top: calc(var(--pebble-connected-child-badge-width, 12px)/2);
      }
      :host([_horizontal]) #childContentConnectorLine { 
        height: var(--pebble-horizontal-step-child-connector-line-height, 1px);
        background: var(--palette-pale-grey, --paper-grey-300);
      }
      /* vertical step style */
      :host(:not([_horizontal])) {
        @apply(--layout-vertical);
        @apply(--paper-font-common-base);
        @apply(--layout-flex);
      }
      :host(:not([_horizontal])) #label {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        position: relative;
      }
      :host(:not([_horizontal])) #step-heading {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        max-height: var(--pebble-connected-badge-width,26px);
      }
      :host(:not([_horizontal])) #connectedBadge {
        z-index: 1;
        @apply(--layout-vertical);
        margin-left: 19px;
      }
      :host(:not([_horizontal])) #textWrapper {
        z-index: 1;
        color: var(--paper-grey-400);
        @apply(--layout-vertical);
        padding-left: 12px;
      }
      :host(:not([_horizontal])) #beforeConnectorLine, :host(:not([_horizontal])) #afterConnectorLine {
        width: var(--connectorLine-width, 4px) !important;
        background: var(--connectorLine-color, --paper-grey-300);
        height: var(--connectorLine-height, 10px);
        margin-left: calc(var(--pebble-connected-badge-width, 26px)/2);
      }
      :host(:not([_horizontal])) #contentConnectorLine {
        width: var(--content-connectorLine-width, 4px) !important;        
        background: var(--connectorLine-color, --paper-grey-300);
        margin-left: calc(5px + var(--pebble-connected-badge-width, 26px)/2);
        margin-right: 24px;
      }
      /*Vertical child step style*/
      :host(:not([_horizontal])) #childLabel {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        position: relative;
      }
      :host(:not([_horizontal])) #connectedChildBadge {
        @apply(--layout-vertical);
        margin-left: calc(5px + (var(--pebble-connected-badge-width,26px) - var(--pebble-connected-childBadge-width,12px))/2 );
      }
      #child-step-heading{
        margin-left: 1px;
      }
      :host(:not([_horizontal])) #child-step-heading {
         @apply(--layout-horizontal);
         @apply(--layout-center);
         max-height: var(--pebble-connected-child-badge-width,12px);
      }
      :host(:not([_horizontal])) #childBeforeConnectorLine, :host(:not([_horizontal])) #childAfterConnectorLine {
        width: var(--child-connectorLine-width, 3px) !important;
        background: var(--palette-pale-grey, --paper-grey-300);
        margin-left: calc(var(--pebble-connected-child-badge-width, 12px)/2);
        height: 10px;
      }
      :host(:not([_horizontal])) #childContentConnectorLine { 
        width: var(--child-connectorLine-width, 3px)!important;
        background: var(--palette-pale-grey, --paper-grey-300);
        margin-left: calc(5px + (var(--pebble-connected-childBadge-width,12px))/2 + (var(--pebble-connected-badge-width,26px) - var(--pebble-connected-childBadge-width,12px))/2 );
        margin-right: 18px;
      }
      /* step styles */
      #textLabel {
        font-size: var(--default-font-size, 14px);
        font-weight: var(--font-bold, bold);
      }
      #collapse {
        --iron-collapse-transition-duration: var(--pebble-vertical-step-transition-duration, 500ms);
      }
      #stepContent {
        @apply(--layout-horizontal);
      }
      #stepDetails {
        @apply(--layout-vertical);
      }
      #step-subtitle {
        @apply(--layout-horizontal);
        font-size: var(--font-size-sm);
        color:var(--palette-steel-grey); 
      }
      paper-badge {
        --paper-badge-background: #f5f0f0;
        --paper-badge-text-color: #616161;
        padding: 18px 0px 0px 24px;
        margin-left:5px;
        --paper-badge: {
            border: 1px solid #616161;
        }
        .badge{
          background-color: #0abf21;
        }
      }
      #outerBadge {
        width: var(--pebble-connected-badge-width, 26px);
        height: var(--pebble-connected-badge-height, 26px);
        background: var(--pebble-step-outer-badge-background, white);
        border-radius: 50%;
        border: 2px solid;
        border-color:  var(--pebble-step-outer-badge-color, --paper-grey-300);
        @apply(--layout);
        @apply(--layout-center-center);
        z-index: 1;
      }
      #badge {
          width: calc(var(--pebble-connected-badge-width, 26px) - 4px);
          height: calc(var(--pebble-connected-badge-height, 26px) - 4px);
          background: var(--pebble-step-connected-badge-background, --paper-grey-300);
          border-radius: 50%;
          color:var(--pebble-step-connected-badge-color, white);
          font-size: var(--pebble-connected-badge-fontSize, 12px);
          text-shadow: 0 1px 1px rgba(137, 147, 159, 0.57);
          @apply(--layout);
          @apply(--layout-center-center);
          cursor: pointer;
          pointer-events: auto;
      }      
      :host(.first-step) #beforeConnectorLine, :host(.last-step) #afterConnectorLine {
        display: none;  
      }
      :host(.last-step:not([opened])) #afterConnectorLine {
        display: none;
      }
      :host(.last-step) #contentConnectorLine {
        visibility: hidden;
      }
      :host #textWrapper {
        color: var(--paper-grey-600);
        cursor: pointer;
        pointer-events: auto;
      }
      :host([opened]) paper-badge {
          visibility: hidden;
      }
      :host([opened]) #step-subtitle {
        display: none;
      }
      [hidden] {
        display: none;
      }
      /* child step Styles */
      .childCollapse {
        --iron-collapse-transition-duration: var(--pebble-vertical-step-transition-duration, 500ms);
        @apply(--layout-horizontal);
      }

      /**
       * Buttons
       */
      #buttonsWrapper {
        /*height: 48px;*/
        padding: 12px 0px 8px 0px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .action-button {
        padding-right: 6px;
        --pebble-button: {
              height: 24px; 
              padding: 0.75em !important;
              border: 1px solid #75808b;
              color: #75808b;                                     
          }
          --pebble-button-left-icon: {
              height: 18px;
              width: 18px;
              padding-bottom: 2px; 
          }
      }
      #childBadge {
        width: var(--pebble-connected-childBadge-width, 12px);
        height: var(--pebble-connected-childBadge-height, 12px);
        background: var(--pebble-connected-childBadge-background,--paper-grey-300);
        border-radius: 50%;
        color: var(--pebble-connected-childBadge-color,white);
        font-size: var(--pebble-connected-childBadge-fontSize,12px);
        @apply(--layout);
        @apply(--layout-center-center);
      }
      /* Styles for Completed Step */
      :host(.completed) #textLabel {
        color: var(--pebble-step-completed-label-color, --paper-green-500);
      }
      :host(.completed) #badge{
        background-color: var(--pebble-step-completed-badge-color, --paper-green-500);
      }
      :host(.completed) #outerBadge {
        border-color: var(--pebble-step-completed-outer-badge-color, --paper-green-500);
        background-color: var(--pebble-step-completed-outer-badge-background-color, #fff);
      }
      /* Styles for Executing Step */
      :host(.inprogress) #textLabel {
        color: var(--pebble-step-inprogress-label-color, --paper-blue-500);
      }
      :host(.inprogress) #badge{
        background-color: var(--pebble-step-inprogress-badge-color, --paper-blue-500);
      }
      :host(.inprogress) #outerBadge {
        border-color: var(--pebble-step-inprogress-outer-badge-color, --paper-blue-500);
        background-color: var(--pebble-step-inprogress-outer-badge-background-color, #fff);
      }
      #label.pebble-step{
        margin-right:-5px !important;
      }
    </style>
      <div id="label">
      <div id="connectedBadge">
        <div id="beforeConnectorLine"></div>
        <div id="step-heading">
          <div id="outerBadge">
            <div id="badge" on-tap="_selectStep">
              <content id="stepBadgeContent" select="pebble-step-badge-content"></content>
            </div>
          </div>
          <div id="textWrapper" on-tap="_selectStep">
            <div id="step-title">
              <span id="textLabel">[[data.title]]</span>
              <template is="dom-if" if="{{_isBadgeLabel(data)}}">
                <paper-badge id="itemsBadge" for="textLabel" label="+{{_badgeLabel(data)}}"></paper-badge>
              </template>
            </div>
            <div id="step-subtitle">
              <template is="dom-if" if="{{_isSubtitle(data)}}">
                <span>[[data.subtitle]]</span>
              </template>
            </div>
          </div>
        </div>
        <div id="afterConnectorLine" class="connectorLine"></div>
      </div>
    </div>
    <iron-collapse id="collapse" horizontal="[[_horizontal]]" opened="[[opened]]">
      <div id="stepContent">
        <div id="contentConnectorLine"></div>
        <div id="stepDetails">
          <content id="stepDetailsContent" select="pebble-step-details"></content>
          <div id="buttonsWrapper">
            <template is="dom-repeat" items="{{data.actions}}">
              <pebble-button class="action-button" raised disabled="[[_computeDisabled()]]" icon="[[item.actionIcon]]" button-text="[[item.action]]" on-tap="_buttonTap"></pebble-button>
            </template>
          </div>
        </div>
      </div>
      <template is="dom-repeat" items={{data.items}}>
        <div id="childLabel">
          <div id="connectedChildBadge">
            <div id="childBeforeConnectorLine"></div>
            <div id="child-step-heading">
              <div id="childBadge" on-tap="_expand"></div>
              <div id="textWrapper" on-tap="_expand">
                <span id="textLabel">[[item.label]]</span>
              </div>
            </div>
            <div id="childAfterConnectorLine" class="connectorLine"></div>
          </div>
        </div>
        <iron-collapse id="[[_getCollapseId(item)]]" horizontal="[[_horizontal]]" class="childCollapse">
            <div id="childContentConnectorLine"></div>
            <div id="stepWrapper">
              <div id="paperStepWrapper"></div>
              <div id="buttonsWrapper">
                <template is="dom-repeat" items="{{item.actions}}">
                  <pebble-button class="action-button" raised icon="[[item.actionIcon]]" button-text="[[item.action]]" on-tap="_childActionTap"></pebble-button>
                </template>
              </div>
            </div>
          </template>
        </iron-collapse>
      </template>
    </iron-collapse>
  </template>

  <script>
    Polymer({

      is: 'pebble-step',

      properties: {
        /**
         * Indicates the open or closed state of the step.
         */
        opened: {
          type: Boolean,
          value: false
        },
        /**
         * Indicates the layout of the step and its child steps.
         */
        _horizontal: {
          type: Boolean,
          reflectToAttribute: true
        },
        /**
         * Indicates the model given to the step.
         */
         data: {
           type: Array,
           value: null
         },
         /**
         * Indicates the number of total steps in the given flow.
         */
         _steps: {
           type: Number,
           value: null
         },
         /**
         * Indicates an index value of the current step.
         */
         _index: {
           type: Number,
           value: null
         },
         /**
         * Indicates the status of the step. 
         * Valid values are "completed","inprogress" and "pending".
         */
         status: {
           type: String,
           observer: '_stepStatusChanged'
         },
      },
      behaviors: [
          RUFBehaviors.UIBehavior
      ],
      observers: [
        '_toggleClassPosition(_index)'
      ],

      ready: function() {
        this._calculateStepStatus(this.data);
      },

       _toggleClassPosition: function(_index) {
        this.async(function() {
          this.toggleClass('first-step', (_index == 1), this);
          this.toggleClass('last-step', (_index == this._steps), this);
        });
      },
      _selectStep: function() {
          this.fire('select-step');
        },
      _badgeLabel: function() {
        if(this.data && this.data.items) {
          return this.data.items.length;
        }
      },
      _isBadgeLabel: function() {
        if(this.data && this.data.items && this.data.items.length > 0) {
          return true;
        }
        return false;
      },
      _isSubtitle: function() {
        if(this.data && this.data.subtitle) {
          return true;
        }
        return false;
      },
       _expand: function(e) {
         var collapse = this.$$('#child-collapse-' + e.model.item.name);
         if(collapse) {
           if(collapse.opened){
               collapse.toggle();
           }
           else{
               collapse.show();
           }
         }
       },
       _getCollapseId: function(item) {
         return "child-collapse-" + item.name;
       },
       _buttonTap: function(e) {
         var eventName = "pebble-step-action-click";
            var eventDetail= {
              name : eventName,
              data: e.model.get('item.event')
            }
           this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
        },
        _calculateStepStatus: function(data) {
          if(data && data.status) {
            this.status =  data.status;
          }
        },
        _stepStatusChanged: function(newValue, oldValue) {
            this.async(function() {
              this.toggleClass(newValue, true, this);
              this.toggleClass(oldValue, false, this);
            });
        },
        _computeDisabled: function() {
          if(!this.status || this.status == "pending") {
            return true;
          }
        }
    });

  </script>
</dom-module>
