<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-behaviors/iron-button-state.html">
<link rel="import" href="../../../bower_components/iron-behaviors/iron-control-state.html">
<link rel="import" href="../../../bower_components/paper-behaviors/paper-ripple-behavior.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-dropdown/iron-dropdown.html">

<link rel="import" href="../../../bower_components/pebble-styles-shared/pebble-styles-shared.html">

<!--
` <pebble-tab>` Represents a tab with with Material Design styling. It is used in conjunction with ` <pebble-tab-group>`

@demo demo/index.html
-->

<dom-module id="pebble-tab">
    <template>

        <style include="shared-styles">
            :host {
                @apply(--layout-inline);
                @apply(--layout-center);
                @apply(--layout-center-justified);
                @apply(--layout-flex-auto);
                position: relative;
                padding: 0 12px;
                overflow: hidden;
                cursor: pointer;
                vertical-align: middle;
                @apply(--paper-font-common-base);
                @apply(--paper-tab);
            }
            
            :host(:focus) {
                outline: none;
            }
            
            :host([link]) {
                padding: 0;
            }
            
            .tab-content {
                height: 100%;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                transition: opacity 0.1s cubic-bezier(0.4, 0.0, 1, 1);
                @apply(--layout-horizontal);
                @apply(--layout-center-center);
                @apply(--layout-flex-auto);
                @apply(--paper-tab-content);
            }
            
            :host(:not(.iron-selected)) > .tab-content {
                opacity: 0.8;
                @apply(--paper-tab-content-unselected);
            }
            
            :host(:focus) .tab-content {
                opacity: 1;
                font-weight: 700;
            }
            
            paper-ripple {
                color: var(--paper-tab-ink, --paper-yellow-a100);
            }
            
            .tab-content >::content > a {
                @apply(--layout-flex-auto);
                height: 100%;
            }

            .tab-content paper-icon-button {
                margin-left: 0.5em
            }

        </style>

        <div class="tab-content">
            <content select=".tab-title"></content>
            <template is="dom-if" if="{{displayMenu}}">
                <paper-icon-button class="dropdown-trigger" icon="icons:expand-more" on-tap="_toggle">
                </paper-icon-button>
            </template>
        </div>

        <iron-dropdown opened="{{_opened}}" focus-target="[[_dropdownContent]]">
            <div class="dropdown-content">
                <content select=".dropdown-content"></content>
            </div>
        </iron-dropdown>
        
    </template>

    <script>

        (function() {
            'use strict';

            Polymer({
                is: 'pebble-tab',

                properties: {
                    /**
                     * Property denoting the id of an `element`
                     */
                    id: {
                        type: String,
                        reflectToAttribute: true,
                    },

                    /**
                     * Property denoting whether the tab will have an dropdown menu icon or not 
                     */
                    displayMenu: {
                        type: Boolean,
                        value: false,
                    },

                    /**
                     * Property denoting whether the tab will forward keyboard clicks (enter/space) to
                     * the first anchor `element` found in its descendants
                     */
                    link: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },

                    /**
                     * Property denoting whether the ink ripple effect is disabled or not. When this property is changed, all descendant <paper-tab> elements 
                     * have their noink property changed to the new value as well.
                     */
                    noink: {
                        type: Boolean,
                        value: false
                    },

                    _opened: {
                        type: Boolean,
                        value: false,
                        notify: true,
                        observer: '_openedChanged'
                    },

                     _dropdownId: {
                        type: String
                    },
                    
                    _dropdownContentId: {
                        type: String
                    },
                    
                    _dropdownContent: {
                        type: Object
                    }
                },

                behaviors: [
                    Polymer.IronControlState,
                    Polymer.IronButtonState,
                    Polymer.PaperRippleBehavior
                ],

                listeners: {
                    down: '_updateNoink',
                    tap: '_onTap'
                },

                /** `attached` fires once the `element` and its parents have been inserted
                 *  into a document.
                 *
                 * This is a good place to perform any work related to your element's
                 * visual state or active behavior (measuring sizes, beginning animations,
                 * loading resources, etc).
                 */
                attached: function() {
                    this._updateNoink();
                },
                
                /**
                 * Returns the host attributes of an `element`
                 */
                hostAttributes: {
                    role: 'tab'
                },

                /**
                 * Returns boolean value which indicates whether apply ripple effect or not on an `element`
                 *
                 * @return Returns boolean
                 */
                get _parentNoink () {
                    var parent = Polymer.dom(this).parentNode;
                    return !!parent && !!parent.noink;
                },

                _updateNoink: function() {
                    this.noink = !!this.noink || !!this._parentNoink;
                },

                _onTap: function(event) {
                    if (this.link) {
                        var anchor = this.queryEffectiveChildren('a');

                        if (!anchor) {
                            return;
                        }

                        // Don't get stuck in a loop delegating
                        // the listener from the child anchor
                        if (event.target === anchor) {
                            return;
                        }

                       anchor.click();
                    }
                },

                _openedChanged: function(opened, oldOpened) {
                    this._dropdownContent = this._contentElement;
                },

                get _contentElement() {
                    return Polymer.dom(this.$$("#" + this._dropdownContentId)).getDistributedNodes()[0];
                },

                _toggle: function(event) {
                    if (!this.opened) {
                        this.$$("iron-dropdown").open();
                    } else {
                        this.$$("iron-dropdown").close();
                    }
                }

            });
        })();

    </script>

</dom-module>