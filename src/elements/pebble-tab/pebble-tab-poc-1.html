<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-behaviors/iron-button-state.html">
<link rel="import" href="../../../bower_components/iron-behaviors/iron-control-state.html">
<link rel="import" href="../../../bower_components/paper-behaviors/paper-ripple-behavior.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<dom-module id="pebble-tab">
    <template>

        <style>
            :host {
                @apply(--layout-inline);
                @apply(--layout-center);
                @apply(--layout-center-justified);
                @apply(--layout-flex-auto);
                position: relative;
                padding: 0 12px;
                overflow: hidden;
                cursor: pointer;
                vertical-align: middle;
                @apply(--paper-font-common-base);
                @apply(--paper-tab);
            }
            
            :host(:focus) {
                outline: none;
            }
            
            :host([link]) {
                padding: 0;
            }
            
            .tab-content {
                height: 100%;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                transition: opacity 0.1s cubic-bezier(0.4, 0.0, 1, 1);
                @apply(--layout-horizontal);
                @apply(--layout-center-center);
                @apply(--layout-flex-auto);
                @apply(--paper-tab-content);
            }
            
            :host(:not(.iron-selected)) > .tab-content {
                opacity: 0.8;
                @apply(--paper-tab-content-unselected);
            }
            
            :host(:focus) .tab-content {
                opacity: 1;
                font-weight: 700;
            }
            
            paper-ripple {
                color: var(--paper-tab-ink, --paper-yellow-a100);
            }
            
            .tab-content >::content > a {
                @apply(--layout-flex-auto);
                height: 100%;
            }
        </style>

        <div class="tab-content">
            <content></content>
            <paper-icon-button id="[[id]]-[[_suffix.dropdownButton]]" class="dropdown-trigger" icon="icons:more-vert" 
                               style="margin-left: 0.4em" on-tap="toggle">
            </paper-icon-button>
        </div>

        <iron-dropdown id="[[id]]-[[_suffix.dropdown]]" opened="{{opened}}" focus-target="[[_dropdownContent]]">
            <div class="dropdown-content">
                <!--<content id="[[id]]-[[_suffix.dropdownContent]]" select=".dropdown-content"></content>-->
                <paper-menu id="[[id]]-[[_suffix.dropdownContent]]" class="dropdown-content">
                    <paper-item>ABC</paper-item>
                    <paper-item>MNO</paper-item>
                    <paper-item>PQR</paper-item>
                    <paper-item>XYZ</paper-item>
                </paper-menu>
            </div>
        </iron-dropdown>
        
    </template>

    <script>

        (function() {
            'use strict';

            Polymer({
                is: 'pebble-tab',
                properties: {
                    /**
                    * If true, the tab will forward keyboard clicks (enter/space) to
                    * the first anchor element found in its descendants
                    */
                    link: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },

                    id: {
                        type: String
                    },
                    noink: {
                        type: Boolean,
                        value: false
                    },
                    opened: {
                        type: Boolean,
                        value: false,
                        notify: true,
                        observer: '_openedChanged'
                    },
                    _suffix: {
                        type: Object,
                        value: { dropdownButton: "dropdownButton", dropdown: "dropdown", dropdownContent: "dropdownContent" } ,
                        readOnly: true
                    },
                     _dropdownId: {
                        type: String
                    },
                    _dropdownContentId: {
                        type: String
                    },
                    _dropdownContent: {
                        type: Object
                    }
                },

                behaviors: [
                    Polymer.IronControlState,
                    Polymer.IronButtonState,
                    Polymer.PaperRippleBehavior
                ],

                hostAttributes: {
                    role: 'tab'
                },

                listeners: {
                    down: '_updateNoink',
                    tap: '_onTap'
                },

                attached: function() {
                    this._updateNoink();
                },

                get _parentNoink () {
                    var parent = Polymer.dom(this).parentNode;
                    return !!parent && !!parent.noink;
                },

                _updateNoink: function() {
                    this.noink = !!this.noink || !!this._parentNoink;
                },

                _onTap: function(event) {
                    if (this.link) {
                    var anchor = this.queryEffectiveChildren('a');

                    if (!anchor) {
                        return;
                    }

                    // Don't get stuck in a loop delegating
                    // the listener from the child anchor
                    if (event.target === anchor) {
                        return;
                    }

                    anchor.click();
                    }
                },

                _openedChanged: function(opened, oldOpened) {
                    if (opened) {
                        this._dropdownContent = this.contentElement;
                        this.fire('paper-dropdown-open');
                    } else if (oldOpened != null) {
                        this.fire('paper-dropdown-close');
                    }
                },

                get contentElement() {
                    return Polymer.dom(this.$$("#" + this._dropdownContentId)).getDistributedNodes()[0];
                },

                toggle: function(e) {
                    console.log(e);
                    var dropdownButtonId = e.currentTarget.id;
                    this._dropdownId = dropdownButtonId.replace(this._suffix.dropdownButton, this._suffix.dropdown);
                    this._dropdownContentId = dropdownButtonId.replace(this._suffix.dropdownButton, this._suffix.dropdownContent);

                    if (this.opened) {
                        this.close(this._dropdownId);
                    } else {
                        this.open(this._dropdownId);
                    }
                },

                open: function(dropdownId) {
                    if (this.disabled) {
                        return;
                    }
                    
                    this.$$("#" + dropdownId).open();
                    },

                    close: function(dropdownId) {
                    this.$$("#" + dropdownId).close();
                }

            });
        })();

    </script>

</dom-module>
<script>
// <paper-tab id="[[id]]" noink>
//             <content select=".tab-content"></content>
//             <paper-icon-button id="[[id]]-[[_suffix.dropdownButton]]" class="dropdown-trigger" icon="icons:more-vert" style="margin-left: 0.4em"
//                 on-tap="toggle">
//             </paper-icon-button>
//         </paper-tab>

//         <iron-dropdown id="[[id]]-[[_suffix.dropdown]]" opened="{{opened}}" focus-target="[[_dropdownContent]]">
//             <div class="dropdown-content">
//                 <content id="[[id]]-[[_suffix.dropdownContent]]" select=".dropdown-content"></content>
//             </div>
//         </iron-dropdown>        
</script>

