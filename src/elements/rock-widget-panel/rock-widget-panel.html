<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../rock-widget/rock-widget.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<!--
`rock-widget-panel` Represents an element that displays the `rock-widgets` 
based on the configuration that the user provided.

@demo demo/index.html
-->
<dom-module id="rock-widget-panel">
    <template> 
        <style include="bedrock-style-common">
            #widget-panel 
            {
                padding: 10px;
                background: var(--palette-pale-grey-five, #f5f7f9);
                @apply --rock-widget-panel;
            }

            .grid-stack {
                display: grid;
                grid-template-columns: repeat(12, 1fr);
                width: 100%;
            }

            .grid-stack>.grid-stack-item {
                width: 100%;
                padding: 10px;
                position: relative;
                transition: opacity 400ms ease-in-out;
                opacity: 1;
            }

            .grid-stack>.grid-stack-item.hidden {
                opacity: 0;
            }

            .grid-stack>.grid-stack-item>.grid-stack-item-content {
                height: 100%;
                overflow-x: hidden;
                overflow-y: auto;
                box-shadow: 1px 4px 6px rgba(0, 0, 0, .2);
            }

            .grid-stack-item-content {
                overflow: hidden;
            }
            
            .grid-stack-item[data-gs-height="4"] {
                height: 320px;
            }

            .grid-stack-item[data-gs-height="6"] {
                height: 480px;
            }

            .grid-stack-item[data-gs-height="10"] {
                height: 800px;
            }
        </style>

        <div id="widget-panel">
            <div class="grid-stack">
                <template is="dom-repeat" items="{{config.widgets}}" as="widget">
                    <div id$="[[_computeWidgetId(index)]]" class="grid-stack-item hidden">
                        <div class="grid-stack-item-content">
                            <rock-widget id="[[widget.name]]" readonly="[[readonly]]" config="[[widget.config]]" context-data="[[contextData]]" icon-buttons="[[widget.iconButtons]]"
                                non-closable="[[widget.nonClosable]]" non-maximizable="[[widget.nonMaximizable]]" non-draggable="[[widget.nonDraggable]]"
                                widget-id="[[index]]"
                                on-rock-widget-loaded="_widgetAdded">
                            </rock-widget>
                        </div>
                    </div>
                </template>
            </div>
        </div>

    </template>
    <script>
        (function () {
            'use strict';
    
            Polymer({
                is: 'rock-widget-panel',
                properties: {
                    /*
                        * Indicates the configuration information that the user provided.
                        */
                    config: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false                    
                    },
                /**
                * <b><i>Content development is under progress... </b></i> 
                */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },
    
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
    
                getControlIsDirty: function () {
                    var widgets = this.shadowRoot.querySelectorAll('rock-widget');
                    if (widgets) {
                        for (var i = 0; i < widgets.length; i++) {
                            if (widgets[i].getControlIsDirty) {
                                let isDirty = widgets[i].getControlIsDirty();
                                if (isDirty) {
                                    return true;
                                }
                            }
                        }
                    }
                },
    
                _computeWidgetId: function (_index) {
                    return "grid_widget_item_" + _index;
                },

                _setWidgetAttr(el, attributes) {
                    for(let key in attributes) {
                        if(!attributes.hasOwnProperty(key)) continue;

                        el.setAttribute(key, attributes[key]);
                    }
                },

                _widgetAdded: function (ev) {
                    const { widgetId, config } = ev.detail;

                    let {
                        height,
                        width,
                        'position-x': x,
                        'position-y': y
                    } = config;

                    const widgetWrapper = this.shadowRoot.getElementById(`${this._computeWidgetId(widgetId)}`);

                    widgetWrapper.setAttribute('data-gs-height', height);

                    widgetWrapper.style.gridColumn = `${++x} / ${x + width}`;
                    widgetWrapper.style.gridRow = `${++y} / ${y + height}`;
                    
                    requestAnimationFrame(()=> {
                        widgetWrapper.classList.remove('hidden');
                    });
                },
                /**
                     * <b><i>Content development is under progress... </b></i> 
                    */
                reloadWidgets: function () {
                    var widgets = this.shadowRoot.querySelectorAll("rock-widget");

                    if(!widgets.length) return;

                    for (var i in widgets) {
                        if (widgets[i].refresh) {
                            widgets[i].refresh();
                        }
                    }
                },
    
                refresh: function () {
                    this.reloadWidgets();
                }
            });
        })();
    </script>
</dom-module>
