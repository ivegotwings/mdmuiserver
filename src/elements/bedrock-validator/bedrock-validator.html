<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-helpers/validation-helper.html">

<dom-module id="bedrock-validator">

    <script src="../../../bower_components/moment/moment.js"></script>

    <script>
/**
* `bedrock-validator` Represents a component that validates the user input against a specified validation condition.
*
* @demo demo/index.html
*/
        Polymer({
            is: 'bedrock-validator',

            properties: {
                // Indicates a pattern using which a regular expressions can be passed for validation.
                pattern:{
                    type: String,
                    notify:true
                },
                // Indicates an input that needs validation.
                input:{
                    type: String,
                    notify:true,
                    observer: 'inputChanged'
                },
                // Indicates the type of the validator. If there are multiple validators, then they can be passed as comma separated strings. Possible validation types are required, minLength, maxLength, range, email, pattern, decimalPrecision, timeRange, dateRange, and fileExtension. Some common validation types like required, minLength, and maxLength can be directly passed as attributes. There is no need to add them in the type.
                type:{
                    type:String,
                    notify:true
                },
                // Indicates the type of validator to be used if the type `required` is passed as an Array. You can use either this or the `type`. But you cannot use both.
                typeArray:{
                    type:Array,
                    notify:true,
                    value: function () {
                        return [];
                    }
                },
                // Indicates whether or not the data is successfully validated.
                invalid:{
                    type:Boolean,
                    value:false,
                    notify:true,
                    reflectToAttribute:true
                },
                // Indicates an error message.
                errorMessage:{
                    type: String,
                    notify:true,
                    value: ''
                },
                // Indicates the minimum value allowed in the range validator.
                min:{
                    type: String,
                    notify:true
                },
                //Indicates the maximum value allowed in the range validator.
                max:{
                    type: String
                },
                // Indicates the minimum length of the text allowed.
                minLength:{
                    type: Number,
                    notify:true
                },
                // Indicates the maximum length of the text allowed.
                maxLength:{
                    type: Number,
                    notify:true
                },
                //Indicates the decimal precision.
                precision:{
                    type: Number
                },
                //Specifies whether or not the input is required.
                required:{
                    type: Boolean,
                    value: false
                },
                // Specifies the date format.
                dateFormat:{
                    type:String
                },
                // Indicates an array of validation errors.
                validationErrors:{
                    type:Array,
                    value:function () {
                        return [];
                    },
                    notify: true,
                    observer: '_validationErrorsChanged'
                },
                // Specifies whether or not to show the erros.
                showError:{
                    type:Boolean,
                    value: false,
                    notify:true
                }
            },
            // Can be used to observe the input. It is called whenever any change is made to the input.
            inputChanged: function (input) {
                this.validate(input);
            },
            // Can be used to validate the input. It invokes the required validator based on the given validation type.
            validate: function(input) {
                this.errorMessage='';
                this.validationErrors=[];
                this.invalid=false;
                if(this.required){
                    if(!ValidationHelper.requiredValidator(input)) {
                        this.invalid =true;
                        this.push('validationErrors', "Required");
                    }
                }
                if(this.minLength && input){
                    if(!ValidationHelper.minLengthValidator(input, this.minLength)) {
                        this.invalid =true;
                        this.push('validationErrors', "Length shouldn't be smaller than " + this.minLength);
                    }
                }
                if(this.maxLength && input){
                    if(!ValidationHelper.maxLengthValidator(input, this.maxLength)) {
                        this.invalid =true;
                        this.push('validationErrors', "Length shouldn't be greater than " + this.maxLength);
                    }
                }
                var types;
                if(this.type) {
                    types = this.type.split(",");
                } else if(this.typeArray) {
                    types=this.typeArray;
                }
                if(types && types.length>0){
                    for (var i = 0; i < types.length; i++) {
                        var invalid = false;
                        if(types[i]=='required' && !this.required){
                            if(!ValidationHelper.requiredValidator(input)) {
                                this.invalid =true;
                                this.push('validationErrors', "Required");
                            }
                        } else if(input) {
                            switch (types[i]) {
                                case 'range':
                                    invalid = !ValidationHelper.numberRangeValidator(input, this.min, this.max);
                                    this.push('validationErrors',"Value should be between  " + this.min + " and " + this.max );
                                    break;
                                case 'rangeTo':
                                    invalid = !ValidationHelper.numberRangeValidator(input, '', this.max);
                                    this.push('validationErrors', "Value should be smaller than " + this.max);
                                    break;
                                case 'rangeFrom':
                                    invalid = !ValidationHelper.numberRangeValidator(input, this.min, '');
                                    this.push('validationErrors',  "Value should be greater than " + this.min);
                                    break;
                                case 'email':
                                    invalid = !ValidationHelper.emailValidator(input);
                                    this.push('validationErrors', "Invalid Email");
                                    break;
                                case 'pattern':
                                    invalid = !ValidationHelper.regexValidator(input, this.pattern);
                                    this.push('validationErrors', "Text doesn't match the required pattern");
                                    break;
                                case 'decimalPrecision':
                                    invalid = !ValidationHelper.decimalPrecisionValidator(input, this.precision);
                                    this.push('validationErrors', "Value should have a decimal precision of " + this.precision);
                                    break;
                                case 'fileExtension':
                                    var allowedFiles = [".png",".doc", ".docx", ".pdf",".xls",".xlsx",".txt"];
                                    invalid = !ValidationHelper.fileExtensionValidator(input,allowedFiles);
                                    this.push('validationErrors', "File with the given extension is not supported");
                                    break;
                                case 'timeRange':
                                    invalid =  !ValidationHelper.dateRangeValidator(input,this.dateFormat, this.min, this.max);
                                    this.push('validationErrors', "Time should be between "+ ValidationHelper.getDateByFormat(this.min,this.dateFormat) +" and "+ ValidationHelper.getDateByFormat(this.max,this.dateFormat));
                                    break;
                                case 'dateRange':
                                    invalid =  !ValidationHelper.dateRangeValidator(input,this.dateFormat, this.min, this.max);
                                    this.push('validationErrors', "Date should be between "+ ValidationHelper.getDateByFormat(this.min,this.dateFormat) +" and "+ ValidationHelper.getDateByFormat(this.max,this.dateFormat));
                                    break;
                            }
                        }
                        if (invalid) {
                            this.invalid = true;
                        }
                    }
                }
                if(this.invalid){
                    this._refreshValidationErrors();                    
                }
            },
            attached: function() {
                this.validate(this.input);
            },
            _refreshValidationErrors: function () {
                var val=this.validationErrors;
                this.validationErrors=[];
                this.validationErrors=val;
            },

            _validationErrorsChanged:function(){
                this.errorMessage="";
                    if(this.showError){
                        for(var j=0;j<this.validationErrors.length;j++){
                            this.errorMessage+=this.validationErrors[j]+". "
                        }
                    }

                    if(this.validationErrors.length > 0)
                    {
                        this.invalid = true;
                    }
                    else
                    {
                        this.invalid = false;
                    }
            }
        });
    </script>
</dom-module>