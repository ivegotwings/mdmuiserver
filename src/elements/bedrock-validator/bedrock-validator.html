<link rel="import" href="../../../bower_components/polymer/polymer.html">


<dom-module id="rock-tag-item">
    <template>
        [[errorMessage]]
    </template>
<script>
    /**
     * `bedrock-validator` validates user input against a specified validation condition.
     *
     * @demo demo/index.html
     */

    function requiredValidator(input) {
        return (input !=undefined && input !="") ;
    }
    function minLengthValidator (input,length) {
        return input.length>= length;
    }
    function maxLengthValidator (input,length) {
        return input.length<= length;
    }
    function numberRangeValidator(value,min,max) {
        if(isNaN(value)){
            if(isFraction(value)){
                var split = value.split('/');
                if(!isNaN(split[0]) && !isNaN(split[1])){
                    value=parseInt(split[0])/parseInt(split[1]);
                }
            } else{
                return false;
            }
        }
        if(isNaN(min)){
            return value<max;
        } else if(isNaN(max)){
            return value>min;
        }
        return value>min && value< max;
    }
    function emailValidator(input) {
        var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
        return regex.test(input);
    }
    function regexValidator(input,pattern) {
        var regExp= new RegExp(pattern);
        return regExp.test(input);
    }
    function isFraction(value){
        if(isNaN(value)){
            var split = value.split('/');
            return split.length == 2 && !isNaN(split[0]) && !isNaN(split[1]) && parseInt(split[1]) != 0;
        }
        return false;
    }
    function decimalPrecisionValidator(input, precision) {
        var pattern =new RegExp("^-?[0-9]+(\.([0-9]{1,"+precision+"})?)?$");
        return pattern.test(input);
    }

    function fileExtensionValidator(input) {
        //todo
        return true;
    }


    Polymer({
        is: 'bedrock-validator',

        properties: {
            pattern:{
                type: String,
                notify:true
            },
            input:{
                type: String,
                notify:true,
                observer: 'input_changed'
            },
            type:{
                type:String,
                notify:true
            },
            typeArray:{
                type:String,
                notify:true
            },
            invalid:{
                type:Boolean,
                value:false,
                notify:true,
                reflectToAttribute:true
            },
            errorMessage:{
                type: String,
                notify:true,
                reflectToAttribute:true,
                value:''
            },
            min:{
                type: Number,
                notify:true
            },
            max:{
                type: Number
            },
            minLength:{
                type: Number,
                notify:true
            },
            maxLength:{
                type: Number,
                notify:true,
                reflectToAttribute:true
            },
            precision:{
                type: Number
            },
            required:{
                type: Boolean,
                value: false
            }
        },
        input_changed: function (input) {
           this.validate(input);
        },

        validate: function(input) {
            this.errorMessage='';
            this.invalid=false;
            if(this.required){
                if(!requiredValidator(input)) {
                    this.invalid =true;
                    this.errorMessage += "Required.\t";
                }
            }
            if(this.minLength){
                if(!minLengthValidator(input, this.minLength)) {
                    this.invalid =true;
                    this.errorMessage += "Length shouldn't be smaller than " + this.minLength + " .\t";
                }
            }
            if(this.maxLength){
                if(!maxLengthValidator(input, this.maxLength)) {
                    this.invalid =true;
                    this.errorMessage += "Length shouldn't be greater than " + this.maxLength + " .\t";
                }
            }
            var types;
            if(this.type) {
                types = this.type.split(",");
            } else if(this.typeArray) {
                types=this.typeArray;
            }
            if(types && types.length>0){
                for (var i = 0; i < types.length; i++) {
                    var invalid = false;
                    var errorMessage='';
                    if(types[i]=='required' && !this.required){
                        if(!requiredValidator(input)) {
                            this.invalid =true;
                            this.errorMessage += "Required.\t";
                        }
                    } else if(input) {
                        switch (types[i]) {
                            case 'range':
                                invalid = !numberRangeValidator(input, this.min, this.max);
                                errorMessage = "Value should be between  " + this.min + " and " + this.max + ".\t";
                                break;
                            case 'rangeTo':
                                invalid = !numberRangeValidator(input, '', this.max);
                                errorMessage = "Value should be smaller than " + this.max + "\t";
                                break;
                            case 'rangeFrom':
                                invalid = !numberRangeValidator(input, this.min, '');
                                errorMessage = "Value should be greater than " + this.min + "\t";
                                break;
                            case 'email':
                                invalid = !emailValidator(input);
                                errorMessage = "Invalid Email.\t";
                                break;
                            case 'pattern':
                                invalid = !regexValidator(input, this.pattern);
                                errorMessage = "Text doesn't match the required pattern.\t";
                                break;
                            case 'decimalPrecision':
                                invalid = !decimalPrecisionValidator(input, this.precision);
                                errorMessage = "Value should have a decimal precision of " + this.precision + " . \t";
                                break;
                            case 'fileExtension':
                                invalid = !fileExtensionValidator(input);
                                errorMessage = "File with the given extension is not supported";
                                break;
                        }
                    }
                    if (invalid) {
                        this.errorMessage+=errorMessage;
                        this.invalid = true;
                    }
                }
            }
        },
        attached: function() {
           this.validate(this.input);
        }


    });
</script>
</dom-module>