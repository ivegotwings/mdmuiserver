<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="bedrock-validator">

<script src="../../../bower_components/moment/moment.js"></script>
<script src="../bedrock-helpers/validation-helper.js"></script>

<script>
    /**
     * `bedrock-validator` validates user input against a specified validation condition.
     *
     * @demo demo/index.html
     */



    Polymer({
        is: 'bedrock-validator',

        properties: {
            // property using which regular expressions can be passed for validation
            pattern:{
                type: String,
                notify:true
            },
            // input to be validated
            input:{
                type: String,
                notify:true,
                observer: 'input_changed'
            },
            // type/name of validator to be used. If multiple validators, then it can be passed as comma separated string
            type:{
                type:String,
                notify:true
            },
            // type of validator to be used if required to be passed as an Array. Either this or type should be used not both.
            typeArray:{
                type:Array,
                notify:true,
                value: function () {
                    return [];
                }
            },
            // boolean flag to know if data is successfully validated or not
            invalid:{
                type:Boolean,
                value:false,
                notify:true,
                reflectToAttribute:true
            },
            //error message to be shown
            errorMessage:{
                type: String,
                notify:true,
                reflectToAttribute:true,
                value: ''
            },
            // min value to be used in range validator
            min:{
                type: String,
                notify:true
            },
            //max value to be used in range validator
            max:{
                type: String
            },
            // minimum length of text allowed
            minLength:{
                type: Number,
                notify:true
            },
            // maximum length of text allowed
            maxLength:{
                type: Number,
                notify:true,
                reflectToAttribute:true
            },
            //decimal precision
            precision:{
                type: Number
            },
            //boolean which tells if the input is required or not
            required:{
                type: Boolean,
                value: false
            },
            // date format
            dateFormat:{
                type:String
            }
        },
        // observer on input. It is called whenever any change is made to input
        input_changed: function (input) {
           this.validate(input);
        },
        // function to validate the input. It calls the required validator based on the validation type given
        validate: function(input) {
            this.errorMessage='';
            this.invalid=false;
            if(this.required){
                if(!requiredValidator(input)) {
                    this.invalid =true;
                    this.errorMessage += "Required. ";
                }
            }
            if(this.minLength && input){
                if(!minLengthValidator(input, this.minLength)) {
                    this.invalid =true;
                    this.errorMessage += "Length shouldn't be smaller than " + this.minLength + ". ";
                }
            }
            if(this.maxLength && input){
                if(!maxLengthValidator(input, this.maxLength)) {
                    this.invalid =true;
                    this.errorMessage += "Length shouldn't be greater than " + this.maxLength + ". ";
                }
            }
            var types;
            if(this.type) {
                types = this.type.split(",");
            } else if(this.typeArray) {
                types=this.typeArray;
            }
            if(types && types.length>0){
                for (var i = 0; i < types.length; i++) {
                    var invalid = false;
                    var errorMessage='';
                    if(types[i]=='required' && !this.required){
                        if(!requiredValidator(input)) {
                            this.invalid =true;
                            this.errorMessage += "Required. ";
                        }
                    } else if(input) {
                        switch (types[i]) {
                            case 'range':
                                invalid = !numberRangeValidator(input, this.min, this.max);
                                errorMessage = "Value should be between  " + this.min + " and " + this.max + ". ";
                                break;
                            case 'rangeTo':
                                invalid = !numberRangeValidator(input, '', this.max);
                                errorMessage = "Value should be smaller than " + this.max + ". ";
                                break;
                            case 'rangeFrom':
                                invalid = !numberRangeValidator(input, this.min, '');
                                errorMessage = "Value should be greater than " + this.min + ". ";
                                break;
                            case 'email':
                                invalid = !emailValidator(input);
                                errorMessage = "Invalid Email. ";
                                break;
                            case 'pattern':
                                invalid = !regexValidator(input, this.pattern);
                                errorMessage = "Text doesn't match the required pattern. ";
                                break;
                            case 'decimalPrecision':
                                invalid = !decimalPrecisionValidator(input, this.precision);
                                errorMessage = "Value should have a decimal precision of " + this.precision + ".  ";
                                break;
                            case 'fileExtension':
                                var allowedFiles = [".png",".doc", ".docx", ".pdf",".xls",".xlsx",".txt"];
                                invalid = !fileExtensionValidator(input,allowedFiles);
                                errorMessage = "File with the given extension is not supported. ";
                                break;
                            case 'dateRange':
                                invalid =  !dateRangeValidator(input,this.dateFormat, this.min, this.max);
                                errorMessage = "Value should be between"+ this.min +" and "+ this.max+ ". ";
                                break;
                        }
                    }
                    if (invalid) {
                        this.errorMessage+=errorMessage;
                        this.invalid = true;
                    }
                }
            }
        },
        attached: function() {
           this.validate(this.input);
        }


    });
</script>
</dom-module>