<link rel="import" href="../../../bower_components/polymer/polymer.html">


<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html" />

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">

<link rel="import" href="child-elements/my-todo-detail-view-list.html">
<link rel="import" href="child-elements/my-todo-detail-view.html">
<link rel="import" href="child-elements/my-todo-product-view.html">
<link rel="import" href="child-elements/my-todo-summary-list.html">
<link rel="import" href="child-elements/my-todo-summary.html">

<!--
`rock-my-todos` Represents an element that displays the list of `my-todo`s.

@demo demo/index.html
-->
<dom-module id="rock-my-todos">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem">
            #rock-my-todos .widget-box {
                padding-bottom: 0 !important;
            }

            rock-tabs {
                --rock-tab-content: {
                    height: calc(100% - 180px);
                    overflow-y: auto;
                    overflow-x: auto;
                };
                --pebble-tab-group: {
                    margin-bottom: 20px;
                    width: 100%;
                };
            }

            .widget-box {
                padding: 20px;
                border: solid 1px var(--palette-cloudy-blue, #c1cad4);
                margin: 10px 0 0 10px;
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);
                min-width: 310px;
                font-size: var(--default-font-size, 14px);
                @apply --box-style;
            }

            .widget-title {
                font-weight: var(--font-bold);
                font-size: var(--default-font-size);
                color: var(--main-content-text-color);
                @apply --layout-flex;
                margin-bottom: 10px;
            }

            .widget-sub-title {
                font-size: var(--default-font-size);
                color: var(--label-text-color);
            }

            .default-message {
                padding: 10px;
                margin: 10px 0;
                background: var(--palette-pale-grey-four, #eff4f8);
                font-size: var(--default-font-size, 14px);
                text-align: center;
                border-radius: 3px;
                font-weight: normal;
                line-height: 18px;
            }
        </style>

        <liquid-entity-model-get exclude-in-progress id="initWorkflowDefinitionMappingsGet" operation="initiatesearch" last-response="{{initWorkflowDefinitionMappingsGet}}"
            on-response="_onInitWorkflowDefinitionMappingsGetResponse" on-error="_onInitWorkflowDefinitionMappingsGetError"></liquid-entity-model-get>
        <liquid-entity-model-get exclude-in-progress id="workflowDefinitionMappingsGet" operation="getsearchresultdetail" request-id="[[initWorkflowDefinitionMappingsGet.content.requestId]]"
            on-response="_onWorkflowDefinitionMappingsGetResponse" on-error="_onWorkflowDefinitionMappingsGetError"></liquid-entity-model-get>


        <liquid-entity-model-get exclude-in-progress id="initWorkflowDefinitionsGet" operation="initiatesearch" last-response="{{initWorkflowDefinitionsGet}}"
            on-response="_onInitWorkflowDefinitionsGetResponse" on-error="_onInitWorkflowDefinitionsGetError"></liquid-entity-model-get>
        <liquid-entity-model-get exclude-in-progress id="workflowDefinitionsGet" operation="getsearchresultdetail" request-id="[[initWorkflowDefinitionsGet.content.requestId]]"
            on-response="_onWorkflowDefinitionsGetResponse" on-error="_onWorkflowDefinitionsGetError"></liquid-entity-model-get>

        <template is="dom-if" if="[[_load]]">
            <div class="row-wrap">
                <div class="col-3">
                    <pebble-dropdown id="assignedTo" label="Assigned To" selected-value="{{selectedValue}}" items="[[dropDownItems]]"></pebble-dropdown>
                </div>
            </div>
            <rock-tabs id="rock-my-todos-tabs" deferred-render></rock-tabs>
        </template>
        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
        <div class="default-message" id="noWorkflows">You don't have any Workflow yet</div>

    </template>
    <script>
        (function () {
            'use strict';

            Polymer({

                is: 'rock-my-todos',

                properties: {
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _assignedTo: {
                        type: String,
                        value: 'All'
                    },

                    _workflowDefinitionMappings: {
                        type: Object,
                        value: function () {
                            return {}
                        }
                    },
                    dropDownItems: {
                        type: Array,
                        value: [{
                                "value": "All",
                                "title": "All"
                            },
                            {
                                "value": "Assigned to me",
                                "title": "Assigned to me"
                            },
                            {
                                "value": "Unassigned",
                                "title": "Unassigned"
                            }
                        ]
                    },
                    selectedValue:{
                        type: String,
                        value: 'All'
                    },
                    _load: {
                        type: Boolean,
                        value: false
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                listeners: {
                    'change': '_onDropdownChange'
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                
                attached: function () {
                    if (!_.isEmpty(this.contextData)) {
                        var initWorkflowDefinitionMappingsGet = this.shadowRoot.querySelector('#initWorkflowDefinitionMappingsGet');

                        if (typeof (initWorkflowDefinitionMappingsGet) === "undefined" ||
                            initWorkflowDefinitionMappingsGet == null) {
                            this.logError("InitGetError");
                            return;
                        }

                        Polymer.Async.timeOut.after(10).run(() => {
                            this._initWorkflowDefinitionGet();
                            initWorkflowDefinitionMappingsGet.requestData = DataRequestHelper.createWorkflowDefinitionMappingGetRequest();
                            initWorkflowDefinitionMappingsGet.generateRequest();
                        });
                    }
                },

                _onInitWorkflowDefinitionMappingsGetResponse: function () {
                    if (!_.isEmpty(this.contextData)) {
                        var workflowDefinitionMappingsGet = this.shadowRoot.querySelector('#workflowDefinitionMappingsGet');

                        if (typeof (workflowDefinitionMappingsGet) === "undefined" ||
                            workflowDefinitionMappingsGet == null) {
                            this.logError("InitGetError");
                            return;
                        }

                        workflowDefinitionMappingsGet.requestData = DataRequestHelper.createWorkflowDefinitionMappingGetRequest();
                        workflowDefinitionMappingsGet.generateRequest();
                    }
                },

                _onInitWorkflowDefinitionMappingsGetError: function (e) {
                    this.logError("InitWorkFlowError", e);
                },

                _onWorkflowDefinitionMappingsGetResponse: function (e) {
                    var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                    if (responseContent) {
                        var workflowDefinitionMappings = responseContent.entityModels;
                        var workflowMappings = {};
                        workflowDefinitionMappings.forEach(function (WDMapping) {
                            if (WDMapping) {
                                if (WDMapping.data && WDMapping.data.relationships) {
                                    var relationshipTypes = Object.keys(WDMapping.data.relationships);
                                    if (relationshipTypes && relationshipTypes.length) {
                                        var relationships = WDMapping.data.relationships[relationshipTypes[0]];
                                        if (relationships && relationships.length) {
                                            relationships.forEach(function (relItem) {
                                                if (relItem && relItem.relTo) {
                                                    if (!workflowMappings[relItem.relTo.id]) {
                                                        workflowMappings[relItem.relTo.id] = [];
                                                    }
                                                    workflowMappings[relItem.relTo.id].push(WDMapping.name);
                                                }
                                            }, this);
                                        }
                                    }
                                }
                            }
                        }, this);

                        this._workflowDefinitionMappings = workflowMappings;        
                    }
                },

                _onWorkflowDefinitionMappingsGetError: function (e) {
                    this.logError("WorkFlowError", e);
                },

                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.properties) {
                        component.properties['context-data'] = this.contextData;
                    }
                },

                _initWorkflowDefinitionGet: function () {
                    if (!_.isEmpty(this.contextData)) {
                        var initWorkflowDefinitionsGet = this.shadowRoot.querySelector('#initWorkflowDefinitionsGet');

                        if (typeof (initWorkflowDefinitionsGet) === "undefined" ||
                            initWorkflowDefinitionsGet == null) {
                            this.logError("InitGetError");
                            return;
                        }

                        var itemContext = {};
                        itemContext.atttributeNames = ["_ALL"];
                        this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                        initWorkflowDefinitionsGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(
                            this.contextData);
                        initWorkflowDefinitionsGet.generateRequest();
                    }
                },

                _onInitWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionsGet = this.shadowRoot.querySelector('#workflowDefinitionsGet');

                    if (typeof (workflowDefinitionsGet) === "undefined" ||
                        workflowDefinitionsGet == null) {
                        this.logError("IdNotFound");
                        return;
                    }

                    workflowDefinitionsGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(this.contextData);
                    workflowDefinitionsGet.generateRequest();
                },

                _onInitWorkflowDefinitionsGetError: function (e) {
                    this.logError("InitWorkFlowError", e);
                },

                _onWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionResponse = e.detail.response;
                    var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                    var currentUserRole = DataHelper.getUserRole();
                    if (typeof (currentUserRole) === "undefined") {
                        this.logError("UserNotFound");
                    }

                    if (responseContent) {
                        var workflowDefinitions = responseContent.entityModels;
                        var tabConfig = {
                            "scrollable": true,
                            "tabItems": []
                        };

                        for (var i = 0; i < workflowDefinitions.length; i++) {
                            var workflowDefinition = workflowDefinitions[i];

                            if (typeof (workflowDefinition.data) !== "undefined" && typeof (
                                workflowDefinition.data.attributes) !== "undefined") {
                                var workflowAttributes = workflowDefinition.data.attributes;

                                var workflowActivities = AttributeHelper.getNestedAttributeValues(workflowAttributes.activities);
                                var noOfAllowedActivities = 0;
                                for (var j = 0; j < workflowActivities.length; j++) {
                                    var workflowActivity = workflowActivities[j];

                                    // Validate if current loggedin user has a role to work on the activity

                                    var allowedRoles = undefined;
                                    if (workflowActivity && workflowActivity.allowedRoles && workflowActivity.allowedRoles.values) {
                                        allowedRoles = AttributeHelper.getAttributeValues(
                                            workflowActivity.allowedRoles.values);
                                    }
                                    if (typeof (allowedRoles) !== "undefined" && allowedRoles instanceof Array &&
                                        allowedRoles.length > 0) {
                                        if (allowedRoles.indexOf(currentUserRole) == -1) {
                                            continue;
                                        } else {
                                            noOfAllowedActivities++;
                                        }
                                    }
                                }

                                if (noOfAllowedActivities < 1) {
                                    continue;
                                }

                                var workflowName = AttributeHelper.getFirstAttributeValue(workflowAttributes.workflowName);
                                var tabItem = {
                                    "name": workflowName.replace(/\W/g, '_'),
                                    "title": workflowName,
                                    "enableDropdownMenu": false,
                                    "component": {
                                        "name": "my-todo-summary-list",
                                        "path": "/src/elements/rock-my-todos/child-elements/my-todo-summary-list.html",
                                        "properties": {
                                            "config-context": {
                                                "workflowName": workflowDefinition.name,
                                                "mappedEntityTypes": this._workflowDefinitionMappings[workflowDefinition.id]
                                            },
                                            "assigned-to": this._assignedTo
                                        }
                                    }
                                };
                                tabConfig.tabItems.push(tabItem);
                            }
                        }

                        if (tabConfig.tabItems instanceof Array && tabConfig.tabItems.length > 0) {
                            tabConfig.tabItems[0].selected = true;
                            this.setNoWorkflowMessageVisibility(false);
                        } else {
                            this.setNoWorkflowMessageVisibility(true);
                        }
                        this._load = true;
                        var that = this;
                        Polymer.Async.microTask.run(() => {
                            var rockTabs = that.shadowRoot.querySelector('rock-tabs');
                            rockTabs.readyToRender(true);
                            rockTabs.config = tabConfig;
                        });
                        this.logInfo("TodoSummaryList", "lists", JSON.stringify(this.lists));
                    }
                },

                _onWorkflowDefinitionsGetError: function (e) {
                    this.logError("WorkFlowError", e);
                },

                _onDropdownChange: function (e, details) {
                    if (details) {
                        var assignedToList = this.shadowRoot.querySelector("#assignedTo");
                        var rockTabs = this.shadowRoot.querySelector('rock-tabs');

                        if(assignedToList) {
                            this._assignedTo = assignedToList.selectedValue;
                        }

                        if (rockTabs) {
                            var tabConfig = rockTabs.config;

                            if (tabConfig && tabConfig.tabItems && tabConfig.tabItems.length) {
                                tabConfig.tabItems.forEach(function (tabItem) {
                                    if (tabItem && tabItem.component) {
                                        tabItem.component.properties["assigned-to"] = this._assignedTo;
                                    }
                                }, this);
                            }

                            rockTabs.reloadTabs();
                        }
                    }
                },

                refresh: function() {
                    this.shadowRoot.querySelector('rock-tabs').reloadCurrentTab();
                },

                setNoWorkflowMessageVisibility: function (isVisible) {
                    this.$.noWorkflows.style.display = isVisible ? "block" : "none";
                }
            });
        })();
    </script>
</dom-module>