<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../rock-tabs/rock-tabs.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../pebble-dropdown/pebble-dropdown.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">


<!--
`rock-my-todos` Represents an element that displays the list of my-todos.

@demo demo/index.html
-->
<dom-module id="rock-my-todos">
    <style include="pebble-styles-shared">
        #rock-my-todos .widget-box {
            padding-bottom: 0 !important;
        }
        
        rock-tabs::shadow pebble-tab-group {
            margin-bottom: 20px;
        }
        
        rock-tabs::shadow pebble-tab-group pebble-tab {
            margin-left: 0;
        }
    </style>
    <template>
        <liquid-entity-model-get id="initWorkflowDefinitionsGet" operation="initiatesearch" last-response="{{initWorkflowDefinitionsGet}}"
            on-response="_onInitWorkflowDefinitionsGetResponse" on-error="_onInitWorkflowDefinitionsGetError"></liquid-entity-model-get>

        <liquid-entity-model-get id="workflowDefinitionsGet" operation="getsearchresultdetail" request-id="[[initWorkflowDefinitionsGet.content.requestId]]"
            on-response="_onWorkflowDefinitionsGetResponse" on-error="_onWorkflowDefinitionsGetError"></liquid-entity-model-get>

        <pebble-dropdown id="taskList" label="Status" selected-value="All" items="All,Assigned to me,Unassigned"></pebble-dropdown>
        <rock-tabs id="rock-my-todos-tabs" config="{{_tabConfig}}"></rock-tabs>

        <bedrock-pubsub event-name="component-creating" handler="_onComponentCreating"></bedrock-pubsub>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({

                is: 'rock-my-todos',

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * Indicates the configuration for the tabs.
                     */
                    _tabConfig: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                attached: function () {
                    if (!_.isEmpty(this.contextData)) {
                        var initWorkflowDefinitionsGet = this.$$('#initWorkflowDefinitionsGet');

                        if (typeof (initWorkflowDefinitionsGet) === "undefined" ||
                            initWorkflowDefinitionsGet == null) {
                            console.error("Element having id initWorkflowDefinitionsGet not found.");
                            return;
                        }

                        var itemContext = {};
                        itemContext.atttributeNames = ["workflowName", "activities"];
                        this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                        initWorkflowDefinitionsGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(
                            this.contextData);
                        initWorkflowDefinitionsGet.generateRequest();
                    }
                },

                _onComponentCreating: function (e, detail, sender) {
                    var component = detail.data;

                    if (component.properties) {
                        component.properties['context-data'] = this.contextData;
                    }
                },

                _onInitWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionsGet = this.$$('#workflowDefinitionsGet');

                    if (typeof (workflowDefinitionsGet) === "undefined" ||
                        workflowDefinitionsGet == null) {
                        console.error("Element having id workflowDefinitionsGet not found.");
                        return;
                    }

                    workflowDefinitionsGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(
                        this.contextData);
                    workflowDefinitionsGet.generateRequest();
                },

                _onInitWorkflowDefinitionsGetError: function (e) {
                    console.error("InitWorkflowDefinitionsGetError:- " + e.detail.response.reason.message);
                },

                _onWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionResponse = e.detail.response;
                    var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                    var currentUserRole = DataHelper.getUserRole();
                    if (typeof (currentUserRole) === "undefined") {
                        console.error("CurrentUser role not found.");
                    }

                    if (responseContent) {
                        var workflowDefinitions = responseContent.entityModels;
                        var tabConfig = {
                                "scrollable": false,
                                "tabItems": []
                        }
                        for (var i = 0; i < workflowDefinitions.length; i++) {
                            var workflowDefinition = workflowDefinitions[i];

                            if (typeof (workflowDefinition.data) !== "undefined" && typeof (
                                workflowDefinition.data.attributes) !== "undefined") {
                                var workflowAttributes = workflowDefinition.data.attributes;
                                var workflowName = AttributeHelper.getFirstAttributeValue(workflowAttributes.workflowName); 
                                var tabItem = {
                                    "name": workflowName,
                                    "title": workflowName,
                                    "enableDropdownMenu": false,
                                    "selected": true,
                                    "component": {
                                        "name": "my-todo-summary-list",
                                        "path": "/src/elements/rock-my-todos/child-elements/my-todo-summary-list.html",
                                        "properties": {
                                            "workflowName": workflowName
                                        }
                                    }
                                }
                                tabConfig.tabItems.push(tabItem);
                            }
                        }

                        this._tabConfig = tabConfig;

                        if (this.verbose) {
                            console.log(JSON.stringify({
                                "SummaryList:- ": this.lists
                            }))
                        }
                    }
                },

                _onWorkflowDefinitionsGetError: function (e) {
                    console.error("WorkflowDefinitionsGetError:- " + e.detail.response.reason.message);
                },

            });
        })();
    </script>
</dom-module>