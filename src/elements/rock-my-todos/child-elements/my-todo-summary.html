<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../rock-saved-searches/rock-saved-searches-tags.html">

<link rel="import" href="../../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../../bedrock-helpers/data-helper.html">
<link rel="import" href="../../bedrock-helpers/context-helper.html">
<link rel="import" href="../../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../../liquid-entity-model-get/liquid-entity-model-get.html">

<dom-module id="my-todo-summary">
    <template>
        <style include="pebble-styles-shared">
            .list-item {
                -webkit-flex-wrap: nowrap;
                /* Safari 6.1+ */
                flex-wrap: nowrap;
                cursor: var(--list-item-cursor, pointer);
            }
            
            .content-div {
                width: calc( 100% - 210px);
            }
            
            .sub-content {
                width: 130px;
            }
            
            .circle {
                width: 42px;
                height: 42px;
                text-align: center;
                -moz-border-radius: 50%;
                -webkit-border-radius: 50%;
                border-radius: 50%;
                border: 1px solid var(--palette-dark-two);
                line-height: 42px;
                color: var(--palette-dark);
                font-size: var(--font-size-sm);
                margin: 0 10px;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }
            
            .todo-status {
                width: 8px;
                min-height: 56px;
            }
            
            .border-left-1 {
                background: rgba(18, 156, 230, 1);
            }
            
            .border-left-2 {
                background: rgba(54, 180, 74, 1);
            }
            
            .border-left-3 {
                background: rgba(120, 93, 168, 1);
            }
            
            .border-left-4 {
                background: rgba(247, 142, 30, 1);
            }
            
            .border-left-5 {
                background: rgba(246, 212, 12, 1);
            }
            
            .border-left-6 {
                background: rgba(238, 32, 76, 1);
            }
        </style>
        <div class="list-item row layout-middle" on-tap="_onTapEvent">
            <div class$="{{_computeClass(myTodo.status)}} todo-status"></div>
            <div class="circle">
                <!--[[myToDo.numberOfTasks]] -->
            </div>
            <div id="workflowMetadataContainer" class="content-div list-content" data="[[myTodo.workflowData]]">
                <div class="to-do-name block-text">[[myTodo.name]]</div>
                <div class="to-do-body">Workflow : [[myTodo.workflow]]</div>
            </div>
            <div class="sub-content text-right m-r-10">
                <div id="viewDetails" class="text-link" on-tap="_showHideDetails">
                    [[_detailsToggleText]] >>
                </div>
            </div>
        </div>
        <div id="moreDetails" hidden="true">
            tags
        </div>
        <div class="clearfix"></div>
        </div>

        <liquid-entity-model-get id="businessConditionsGet" operation="getbyids" request-id="businessConditionsGet" on-response="_onBusinessConditionsGetResponse"
            on-error="_onBusinessConditionsGetError"></liquid-entity-model-get>
    </template>
    <script>
        Polymer({

            is: 'my-todo-summary',

            properties: {

                /**
                 * Fired when any of the my-todo is tapped in my-todo's widget with event name: "rock-my-todo-click" and data is the data of the clicked my-todo
                 *
                 * @event bedrock-event
                 */

                /**
                 * myTodo represents the data
                */
                myTodo: {
                    type: Object,
                    notify: true,
                    value: {}
                },

                _detailsToggleText: {
                    type: String,
                    value: 'View details'
                }
            },

            /**
             *  This s internal function used to compute the class based on the status of my-todo
             */
            _computeClass: function (status) {
                if (status) {
                    if (status == "red") {
                        return 'border-left-1';
                    } else if (status == "orange") {
                        return 'border-left-2';
                    } else {
                        return 'border-left-3';
                    }
                }
                return 'border-left-3';
            },

            _showHideDetails: function () {
                var moreDetails = this.$$('#moreDetails');
                if (moreDetails) {
                    if (moreDetails.hidden) {
                        moreDetails.hidden = false;
                        this._detailsToggleText = "Hide details";

                        if (this.myTodo) {

                        }

                    } else {
                        moreDetails.hidden = true;
                        this._detailsToggleText = "View details";
                    }
                }
            },

            /**
             * This is internal function used to fire an rock-my-todo-click when my-todo element is tapped
             */
            _onActivityTap: function () {
                var eventData = {
                    name: "rock-my-todo-click",
                    data: {
                        wfcId: this.$.workflowMetadataContainer.data
                    },
                }
                this.fire('bedrock-event', eventData);
            },

            _requestBusinessConditions: function () {
                if (this._entityBusinessConditionNames.length) {

                    var businessConditionsGet = this.$$('#businessConditionsGet');
                    if (typeof (businessConditionsGet) === "undefined" || businessConditionsGet == null) {
                        console.error("Element having id businessConditionsGet not found.");
                        this._showMessage(this._errorMessage);
                        return;
                    }

                    var clonedContextData = DataHelper.cloneObject(this.contextData);

                    // Prepare ItemContext
                    var itemContext = ContextHelper.getFirstItemContext(clonedContextData);
                    itemContext.id = this._entityBusinessConditionNames;
                    itemContext.type = "businessCondition";
                    clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];

                    // Create Request and Get
                    businessConditionsGet.requestData = DataRequestHelper.createEntityGetRequest(clonedContextData);
                    businessConditionsGet.generateRequest();
                }
            },

            _onBusinessConditionsGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);

                if (responseContent) {
                    var businessConditions = responseContent.entityModels;

                    if (typeof (businessConditions) !== "undefined" && businessConditions.length > 0) {
                        for (var i = 0; i < businessConditions.length; i++) {
                            var businessCondition = {};
                            businessCondition["id"] = businessConditions[i].id;
                            businessCondition["name"] = businessConditions[i].name;

                            // LongNames are required for Displaying BusinessConditions
                            var formattedBusinessCondition = this._entityBusinessConditionsGovernData.find(businessCondition => businessCondition.id === businessConditions[i].id);

                            if (formattedBusinessCondition) {
                                formattedBusinessCondition["name"] = businessConditions[i].name;
                            }

                            this.push("_originalBusinessConditions", businessCondition);
                        }
                    }

                    this._prepareToFixData();
                } else {
                    console.error("EntityModelGetByIdsResponse Content not found.");
                    this._showMessage(this._errorMessage);
                }
            },

            _onBusinessConditionsGetError: function (e) {
                console.error("EntityModelGetByIdsError:- " + e.detail.response.reason.message);
                this._showMessage(this._errorMessage);
            }
        });
    </script>
</dom-module>