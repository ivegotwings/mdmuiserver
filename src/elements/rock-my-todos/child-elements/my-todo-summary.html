<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../../bedrock-helpers/data-helper.html">
<link rel="import" href="../../bedrock-helpers/context-helper.html">
<link rel="import" href="../../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../../pebble-button/pebble-button.html">

<link rel="import" href="../../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../../bedrock-style-manager/styles/bedrock-style-gridsystem.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->

<dom-module id="my-todo-summary">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem">
            .list-item {
                -webkit-flex-wrap: nowrap;
                /* Safari 6.1+ */
                flex-wrap: nowrap;
                cursor: var(--list-item-cursor, pointer);
                position: relative;
                padding: 10px 10px 10px 8px;
                min-height: 50px;
                overflow: hidden;
            }

            .content-div {
                width: calc( 100% - 200px);
            }

            .square {
                max-width: 90px;
                height: 30px;
                text-align: center;
                line-height: 32px;
                color: var(--list-item-count-wrap-text-color, #036bc3);
                font-size: var(--font-size-lg, 18px);
                font-weight: 500;
                margin: 0 10px;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .todo-status {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                width: 8px;
            }

            .border-left-1 {
                background: rgba(18, 156, 230, 1);
            }

            .border-left-2 {
                background: rgba(54, 180, 74, 1);
            }

            .border-left-3 {
                background: rgba(120, 93, 168, 1);
            }

            .border-left-4 {
                background: rgba(247, 142, 30, 1);
            }

            .border-left-5 {
                background: rgba(246, 212, 12, 1);
            }

            .border-left-6 {
                background: rgba(238, 32, 76, 1);
            }

            .contentContainer {
                width: 100%;
            }

            #moreDetails {
                padding-left: 10px;
                padding-top: 10px;
            }

            .sub-content {
                position: absolute;
                right: 10px;
                top: 17px;
            }

            .to-do-name {
                line-height: 17px;
            }

            pebble-button.action {
                display: inline-block;
                border: 1px solid var(--palette-cerulean, #036bc3);
                border-radius: 3px;
                margin-top:0px;
                margin-right:7px;
                margin-bottom:10px;
                margin-left:0px;
                --pebble-button: {
                    height: 30px !important;
                    color: var(--error-button-color);
                    font-size: var(--default-font-size, 14px);
                    margin-top:0px;
                    margin-right:10px;
                    margin-bottom:0px;
                    margin-left:10px;
                }
                --pebble-button-iron-icon: {
                    padding-top: 0px;
                    padding-right:5px;
                    padding-bottom:0px;
                    padding-left:0px;
                }
                --pebble-menu-button: {
                    height: 30px !important;
                    border-top: 1px solid var(--palette-cerulean);
                    border-right: 1px solid var(--palette-cerulean);
                    border-bottom: 1px solid var(--palette-cerulean);
                    background: #FFFFFF;
                    box-sizing: border-box;
                }
                --actions-icon-button: {
                    height: 16px;
                    width: 16px;
                    background: #FFFFFF;
                    color: var(--palette-cerulean);
                    padding-top:0px !important;
                    padding-right:0px !important;
                    padding-bottom:0px !important;
                    padding-left:0px !important;
                    margin-top:0px;
                    margin-right:5px;
                    margin-bottom:0px;
                    margin-left:5px;
                    top: -2px;
                }
                --pebble-button-paper-menu: {
                    background: #FFFFFF;
                }
                --pebble-button-paper-menu-item: {
                    background: #FFFFFF;
                    color: var(--palette-cerulean);
                    padding-top: 0px;
                    padding-right:8px;
                    padding-bottom: 0px;
                    padding-left:8px;
                }
            }
            pebble-button.bcButtons{
                --pebble-button: {
                    color: var(--error-button-color);
                    padding-right:10px;
                    padding-left:10px;
                }
            }
            pebble-button#passedBCButton{
                --pebble-button: {
                    color: var(--success-button-color);
                    padding-right:10px;
                    padding-left:10px;
                }
            }

            #loadingIcon {
                height: 24px;
                margin: 0px 10px -4px 10px;
            }

            pebble-button {
                --pebble-custom-icon-height: {
                    height: 20px;
                    margin-right: 5px;
                }
            }
        </style>
        <div class="list-item row layout-middle">
            <div class$="{{_computeClass(myTodo.status)}} todo-status"></div>
            <div class="contentContainer">
                <div class="row layout-middle">
                    <div id="taskCount" class="square" hidden>
                        [[_numberOfTasks]]
                    </div>
                    <div id="taskCountLoading">
                        <img id="loadingIcon" src="../../../../src/images/loading.svg"></img>
                    </div>
                    <div id="workflowMetadataContainer" class="content-div list-content" data="[[myTodo.workflowData]]" on-tap="_onActivityTap">
                        <div class="to-do-name block-text text-ellipsis">[[myTodo.name]]</div>
                    </div>
                    <div class="sub-content text-right">
                        <div id="viewDetails" class="btn-link" on-tap="_showHideDetails">
                            [[_detailsToggleText]] &raquo;
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div id="moreDetails" hidden="true">
                    <template is="dom-repeat" items="[[_businessConditionMappings]]" as="businessCondition">
                        <pebble-button id="[[businessCondition.data.bcId]]" icon-url="../../../../src/images/loading.svg" class="action bcButtons" noink raised
                            elevation="0" horizontal-align="right" vertical-align="top" button-text="[[businessCondition.businessConditionName]]"
                            data="[[businessCondition.data]]" on-tap="_onBusinessConditionTap">
                        </pebble-button>
                    </template>
                    <template is="dom-if" if="[[_bCsExist]]">
                        <pebble-button id="passedBCButton" icon-url="../../../../src/images/loading.svg" class="action" noink raised
                                       elevation="0" horizontal-align="right" vertical-align="top" button-text="[[_passedBC.text]]"
                                       data="[[_passedBC.data]]"    on-tap="_onBusinessConditionTap">
                        </pebble-button>
                    </template>
                </div>
            </div>
        </div>
        <div class="clearfix"></div>
        </div>

        <liquid-entity-model-get exclude-in-progress id="initBusinessConditionsGet" operation="initiatesearch" request-data="[[_businessConditionRequest]]"
            last-response="{{initBusinessConditionsGet}}" on-response="_onInitBusinessConditionsGetResponse" on-error="_onInitBusinessConditionsGetError"></liquid-entity-model-get>
        <liquid-entity-model-get exclude-in-progress id="businessConditionsGet" operation="getsearchresultdetail" request-data="[[_businessConditionRequest]]"
            request-id="[[initBusinessConditionsGet.content.requestId]]" on-response="_onBusinessConditionsGetResponse" on-error="_onBusinessConditionsGetError"></liquid-entity-model-get>

        <liquid-entity-model-get exclude-in-progress id="initBusinessConditionsMappingGet" operation="initiatesearch" request-data="[[_businessConditionMappingRequest]]"
            last-response="{{initBusinessConditionsMappingGet}}" on-response="_onInitBusinessConditionsMappingGetResponse" on-error="_onInitBusinessConditionsMappingGetError"></liquid-entity-model-get>
        <liquid-entity-model-get exclude-in-progress id="businessConditionsMappingGet" operation="getsearchresultdetail" request-data="[[_businessConditionMappingRequest]]"
            request-id="[[initBusinessConditionsMappingGet.content.requestId]]" on-response="_onBusinessConditionsMappingGetResponse"
            on-error="_onBusinessConditionsMappingGetError"></liquid-entity-model-get>

        <liquid-entity-govern-data-get name="governDataGet" operation="initiatesearchandgetcount" request-data="{{_governDataRequest}}"
            on-response="_onGovernDataResponse" on-error="_onGovernDataError" exclude-in-progress></liquid-entity-govern-data-get>

    </template>
    <script>
        Polymer({

            is: 'my-todo-summary',

            properties: {

                /**
                 * Fired when the `my-todo` is tapped in `my-todo`'s widget along with the event such as `rock-my-todo-click` and  "clicked" `my-todo`.
                 *
                 * @event bedrock-event
                 */

                /**
                 * Indicates the `myTodo` data.
                */
                myTodo: {
                    type: Object,
                    notify: true,
                    value: {}
                },

                _detailsToggleText: {
                    type: String,
                    value: 'View details'
                },

                _businessConditionMappings: {
                    type: Array,
                    observer: '_getBusinessConditionCount',
                    value: function () {
                        return [];
                    }
                },

                _businessConditions: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                _numberOfTasks: {
                    type: Number,
                    value: 0
                },

                _governDataRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _businessConditionRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _businessConditionMappingRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _allowedEntityTypes: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _passedBC:{
                    type:Object
                },
                _bCsExist:{
                    type:Boolean,
                    value:false
                },
                temp: {
                    type:Boolean,
                    value:false
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior
            ],

            attached: function () {
                var governDataLiquid = this.shadowRoot.querySelector("[name=governDataGet]");
                var businessConditionLiquid = this.shadowRoot.querySelector("#initBusinessConditionsGet");
                this._allowedEntityTypes = this.appSetting('allowedEntityTypes');
                var mappedEntityTypesString = this.myTodo.mappedEntityTypes ? this.myTodo.mappedEntityTypes.join("#@#") : undefined;
                this.myTodo.workflowData.mappedEntityTypesString = mappedEntityTypesString;

                if (governDataLiquid) {

                    if (this._allowedEntityTypes && this._allowedEntityTypes.length) {

                        var userId = "";
                        if (!_.isEmpty(this.myTodo.workflowData.user)) {
                            var user = this.myTodo.workflowData.user;

                            if (user.toLowerCase() == "all") {
                                userId = "";
                            } else if (user.toLowerCase() == "currentuser") {
                                userId = DataHelper.getUserName();
                            } else if (user.toLowerCase() == "unassigned") {
                                userId = "_UNASSIGNED";
                            }
                        }

                        var contexts = [
                            {
                                "workflow": this.myTodo.workflowName
                            }
                        ];

                        var options = {
                            "contexts": contexts,
                            "typesCriterion": this._allowedEntityTypes,
                            "userId": userId,
                            "workflowActivityName": this.myTodo.workflowData.wfActivityName,
                            "excludeNonContextual": true
                        }
                        var req = DataRequestHelper.createGovernGetRequest(options);
                        this._governDataRequest = req;
                        governDataLiquid.generateRequest();
                    } else {
                        this.showErrorToast("Types criterion is undefied or empty for govern get.");
                    }
                }

                if (businessConditionLiquid && this.myTodo.getBusinessCondition) {
                    var attributeNames = ["name"];
                    this._businessConditionRequest = DataRequestHelper.createBusinessConditionGetRequest(attributeNames);

                    businessConditionLiquid.generateRequest();
                }
            },

            _onInitBusinessConditionsGetResponse: function () {
                var businessConditionsGet = this.shadowRoot.querySelector('#businessConditionsGet');
                if (typeof (businessConditionsGet) === "undefined" || businessConditionsGet == null) {
                    this.logError("BusinessConditionError");
                    this.showErrorToast(this._errorMessage);
                    return;
                }

                businessConditionsGet.generateRequest();
            },

            _onInitBusinessConditionsGetError: function (e) {
                this.showErrorToast(e.detail.response.reason);
            },

            _onBusinessConditionsGetResponse: function (e) {
                if (e.detail && e.detail.response) {
                    var response = e.detail.response;
                    if (response && response.content) {
                        this._businessConditions = response.content.entityModels;
                    }
                }
            },

            _onBusinessConditionsGetError: function (e) {
                this.showErrorToast(e.detail.response.reason);
            },

            _onGovernDataResponse: function (e) {
                if (e.detail && e.detail.response) {
                    var response = e.detail.response;
                    if (response && response.content) {
                        var totalRecords = response.content.totalRecords || 0;
                        var maxRecords = response.content.maxRecords || 0;

                        if (totalRecords > maxRecords) {
                            this._numberOfTasks = maxRecords + "+";
                        } else {
                            this._numberOfTasks = totalRecords;
                        }
                    }

                    this.shadowRoot.querySelector('#taskCountLoading').hidden = true;
                    this.shadowRoot.querySelector('#taskCount').hidden = false;
                }
            },

            _onGovernDataError: function (e) {
                this.showErrorToast(e.detail.response.reason);
            },

            /**
             *  This s internal function used to compute the class based on the status of my-todo
             */
            _computeClass: function (status) {
                if (status) {
                    if (status == "red") {
                        return 'border-left-1';
                    } else if (status == "orange") {
                        return 'border-left-2';
                    } else {
                        return 'border-left-3';
                    }
                }
                return 'border-left-3';
            },

            _showHideDetails: function () {
                var moreDetails = this.shadowRoot.querySelector('#moreDetails');
                if (moreDetails) {
                    if (moreDetails.hidden) {
                        moreDetails.hidden = false;
                        this._showBusinessConditions();
                    } else {
                        moreDetails.hidden = true;
                        this._detailsToggleText = "View details";
                    }
                }
            },

            /**
             * This is internal function used to fire an rock-my-todo-click when my-todo element is tapped
             */
            _onActivityTap: function () {
                var appName = this._getAppNameToRedirect();
                ComponentHelper.appRoute(appName, this.myTodo.workflowData);
            },

            _onBusinessConditionTap: function (e) {
                if (e && e.currentTarget) {
                    var appName = this._getAppNameToRedirect();
                    ComponentHelper.appRoute(appName, e.currentTarget.data);
                }
            },

            _onInitBusinessConditionsMappingGetResponse: function () {

                var businessConditionsMappingGet = this.shadowRoot.querySelector('#businessConditionsMappingGet');
                if (typeof (businessConditionsMappingGet) === "undefined" || businessConditionsMappingGet == null) {
                    this.logError("BusinessConditionError");
                    this.showErrorToast(this._errorMessage);
                    return;
                }

                businessConditionsMappingGet.generateRequest();
            },
            _isBusinessConditionAllowedForRole: function (businessCondition) {
                var allowedRoles;
                if (DataHelper.isValidObjectPath(businessCondition, "data.attributes")) {
                    allowedRoles = businessCondition.data.attributes.impactRoles;
                }
                if (allowedRoles && this.roleId) {
                    for (var i = 0; i < allowedRoles.values.length; i++) {
                        //Check for _ALL or user role
                        if (allowedRoles.values[i].value == "_ALL" ||
                            allowedRoles.values[i].value.toLowerCase() == this.roleId.toLowerCase()) {
                            return true;
                        }
                    }

                    //Not have "_ALL" / user role
                    return false;
                }

                //No allowedRoles OR No user role, then BC is applicable to any role
                return true;
            },

            _onBusinessConditionsMappingGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                if (responseContent) {
                    var ruleContextMappings = responseContent.entityModels;

                    if (ruleContextMappings && ruleContextMappings.length) {
                        var firstRuleContextMapping = ruleContextMappings[0];

                        if (firstRuleContextMapping && firstRuleContextMapping.data) {
                            var contextBaseMappings = firstRuleContextMapping.data.contexts;

                            if (contextBaseMappings && contextBaseMappings.length) {
                                var businessConditions = [];
                                var bcIds=[];
                                contextBaseMappings.forEach(function (ctxMapping) {
                                    if (ctxMapping && ctxMapping.relationships) {
                                        var hasBusinessConditions = ctxMapping.relationships['hasBusinessConditions'];

                                        if (hasBusinessConditions && hasBusinessConditions.length) {
                                            hasBusinessConditions.forEach(function (businessCondition) {
                                                if (businessCondition && businessCondition.attributes && businessCondition.relTo) {
                                                    if (this._isBusinessConditionAllowedForRole(businessCondition.relTo)) {
                                                        var stepNameAttr = businessCondition.attributes['stepName'];
                                                        var businessConditionName = this._getBusinessConditionName(businessCondition.relTo.id);
                                                        if (!this._isBusinessConditionExist(businessConditionName, businessConditions)) {
                                                            if (stepNameAttr) {
                                                                var value = AttributeHelper.getFirstAttributeValue(stepNameAttr);

                                                                if (value && value == this.myTodo.workflowData.wfActivityName) {
                                                                    bcIds.push(businessCondition.relTo.id);
                                                                    var businessConditionItem = {
                                                                        "businessConditionName": businessConditionName,
                                                                        "data": {
                                                                            "wfName": this.myTodo.workflow,
                                                                            "wfShortName": this.myTodo.workflowName,
                                                                            "wfActivityName": this.myTodo.workflowData.wfActivityName,
                                                                            "wfActivityExternalName": this.myTodo.workflowData.wfActivityExternalName,
                                                                            "bcId": businessCondition.relTo.id,
                                                                            "user": this.myTodo.workflowData.user,
                                                                            "bcExternalName":businessConditionName,
                                                                            "status":"failed",
                                                                            "mappedEntityTypesString": this.myTodo.workflowData.mappedEntityTypesString
                                                                        }
                                                                    };

                                                                    businessConditions.push(businessConditionItem);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }, this);
                                        }
                                    }
                                }, this);
                                if(bcIds && bcIds.length){
                                    this._bCsExist=true;
                                    var bcId=bcIds.join("#@#");
                                    this._passedBC={
                                        "text":"Ready for transition",
                                        "data": {
                                            "wfName": this.myTodo.workflow,
                                            "wfShortName": this.myTodo.workflowName,
                                            "wfActivityName": this.myTodo.workflowData.wfActivityName,
                                            "wfActivityExternalName": this.myTodo.workflowData.wfActivityExternalName,
                                            "user": this.myTodo.workflowData.user,
                                            "bcId": bcId,
                                            "status":"passed",
                                            "bcExternalName":"Ready for transition",
                                            "mappedEntityTypesString": this.myTodo.workflowData.mappedEntityTypesString
                                        }
                                    };
                                }
                                this._prepareBusinessConditions(businessConditions);
                            }
                        }
                    }
                } else {
                    this.showErrorToast("Business conditions not found.");
                }
            },

            _onBusinessConditionsMappingGetError: function (e) {
                this.showErrorToast(e.detail.response.reason);

            },

            _prepareBusinessConditions: function (businessConditions) {
                if (businessConditions && businessConditions.length) {
                    this._businessConditionMappings = businessConditions;
                }
            },

            _showBusinessConditions: function () {
                this._detailsToggleText = "Hide details";
                this._businessConditionButtons = [];
                var contexts = this._getContextFromTypeCriterion(this._allowedEntityTypes);

                if (this.myTodo) {
                    var req = {
                        "params": {
                            "query": {
                                "contexts": contexts,
                                "filters": {
                                    "typesCriterion": [
                                        "ruleContextMappings"
                                    ],
                                    "relationshipsCriterion": [
                                        {
                                            "hasBusinessConditions": {
                                                "attributes": [
                                                    {
                                                        "stepName": {
                                                            "eq": this.myTodo.workflowData.wfActivityName
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "fields": {
                                "relationships": [
                                    "hasBusinessConditions"
                                ],
                                "relationshipAttributes": [
                                    "stepName"
                                ],
                                "relatedEntityAttributes":["impactRoles"]
                            }
                        }
                    };

                    var initBusinessConditionsMapingGet = this.shadowRoot.querySelector('#initBusinessConditionsMappingGet');

                    if (typeof (initBusinessConditionsMapingGet) === "undefined" || initBusinessConditionsMapingGet == null) {
                        this.logError("BusinessConditionError");
                        return;
                    }
                    this._businessConditionMappingRequest = req;
                    initBusinessConditionsMapingGet.generateRequest();
                }
            },

            _getBusinessConditionCount: function () {
                if (!_.isEmpty(this._businessConditionMappings)) {
                    if (this._allowedEntityTypes && this._allowedEntityTypes.length) {
                        var contexts = this._getContextFromTypeCriterion(this._allowedEntityTypes);
                        var userId = "";
                        var user = this.myTodo.workflowData.user;

                        if (user.toLowerCase() == "all") {
                            userId = "";
                        } else if (user.toLowerCase() == "currentuser") {
                            userId = DataHelper.getUserName();
                        } else if (user.toLowerCase() == "unassigned") {
                            userId = "_UNASSIGNED";
                        }
                        var attributes = ["businessConditions", "status", "activities"];
                        var passedBCOptions={};
                        this._businessConditionMappings.forEach(function (businessCondition) {
                            if (businessCondition && businessCondition.data) {
                                var options = {
                                    "contexts": contexts,
                                    "typesCriterion": this._allowedEntityTypes,
                                    "userId": userId,
                                    "workflowActivityName": businessCondition.data.wfActivityName,
                                    "businessConditionName": businessCondition.data.bcId,
                                    "attributes": attributes,
                                    "excludeNonContextual": false
                                };
                                passedBCOptions=options;
                                var req = DataRequestHelper.createGovernGetRequest(options);
                                if (!_.isEmpty(req)) {
                                    var governGetLiquid = document.createElement('liquid-entity-govern-data-get');
                                    governGetLiquid.id = businessCondition.data.bcId;
                                    governGetLiquid.operation = 'initiatesearchandgetcount';
                                    governGetLiquid.requestData = req;
                                    governGetLiquid.excludeInProgress = true;
                                    governGetLiquid.addEventListener('response', this._getBusinessConditionCountResponse.bind(this));
                                    governGetLiquid.addEventListener('error', this._getBusinessConditionCountFailed);
                                    governGetLiquid.generateRequest();
                                }
                            }
                        }, this);
                        delete  passedBCOptions.businessConditionName;
                        this._getPassedBusinessConditionsCount(passedBCOptions,this._businessConditionMappings);
                    } else {
                        this.logError("TypesCriterionEmptyError");
                    }
                }
            },
            _getPassedBusinessConditionsCount:function (options,businessConditionMappings) {
                var bcIds=businessConditionMappings.map(function (businessCondition) {
                   return businessCondition.data.bcId
                });
                options.businessConditionNames=bcIds;
                options.passedBusinessConditions=true;
                var req = DataRequestHelper.createGovernGetRequest(options);
                if (!_.isEmpty(req)) {
                    var governGetLiquid = document.createElement('liquid-entity-govern-data-get');
                    governGetLiquid.id = "passedBCGovernLiquid";
                    governGetLiquid.operation = 'initiatesearchandgetcount';
                    governGetLiquid.requestData = req;
                    governGetLiquid.excludeInProgress = true;
                    governGetLiquid.addEventListener('response', this._onGetPassedBusinessConditionsCountResponse.bind(this));
                    governGetLiquid.addEventListener('error', this._getBusinessConditionCountFailed);
                    governGetLiquid.generateRequest();
                }
            },
            _addCountToBCButton:function (response,businessConditionButton) {
                var bcCount = 0;
                var totalRecords = response.content.totalRecords || 0;
                var maxRecords = response.content.maxRecords || 0;

                if (totalRecords > maxRecords) {
                    bcCount = maxRecords + "+";
                } else {
                    bcCount = totalRecords;
                }
                businessConditionButton.iconUrl = '';
                businessConditionButton.buttonText = bcCount + "  " + businessConditionButton.buttonText;
            },
            _onGetPassedBusinessConditionsCountResponse:function (e) {
                if (e && e.currentTarget && e.detail) {
                    var businessConditionButton = this.$$('pebble-button[id=passedBCButton]');
                    var response = e.detail.response;
                    if (response && response.content && businessConditionButton) {
                       this._addCountToBCButton(response,businessConditionButton);
                    }
                }
            },

            _getBusinessConditionCountResponse: function (e) {
                if (e && e.currentTarget && e.detail) {
                    var businessConditionButton = this.shadowRoot.querySelector('pebble-button[id=' + e.currentTarget.id + ']');
                    var response = e.detail.response;
                    if (response && response.content && businessConditionButton) {
                        this._addCountToBCButton(response,businessConditionButton);
                    }
                }
            },

            __getBusinessConditionCountFailed: function (e) {
                this.showErrorToast(e.detail.response.reason);
            },

            _isBusinessConditionExist: function (businessConditionName, businessConditions) {
                if (businessConditions && businessConditions.length) {
                    var isExist = false;
                    businessConditions.forEach(function (businessCondition) {
                        if (businessCondition.businessConditionName && businessCondition.businessConditionName == businessConditionName) {
                            isExist = true;
                        }
                    }, this);
                    return isExist;
                }
                return false;
            },

            _getContextFromTypeCriterion: function (allowedTypes) {
                var contexts = [];
                if (allowedTypes && allowedTypes.length) {
                    allowedTypes.forEach(function (type) {
                        contexts.push({
                            "self": "self/" + type + "_ruleContextMappings",
                            "workflow": this.myTodo.workflowName
                        });
                    }, this);
                }
                return contexts;
            },

            _getAppNameToRedirect: function () {
                var appName = "entity-discovery";

                if (this.myTodo.mappedEntityTypes) {
                    this.myTodo.mappedEntityTypes.forEach(function (entityType) {
                        if (entityType == "image" || entityType == "video" || entityType == "document") {
                            appName = "asset-discovery";
                        }
                    }, this);
                }

                return appName;
            },

            _getBusinessConditionName: function (businessConditionId) {
                var businessConditionName = "";

                if (this._businessConditions && this._businessConditions.length && businessConditionId) {
                    for (var i = 0; i < this._businessConditions.length; i++) {
                        var businessCondition = this._businessConditions[i];
                        if (businessCondition.id == businessConditionId) {
                            if (businessCondition.data && businessCondition.data.attributes) {
                                var businessConditionNameAttribute = businessCondition.data.attributes["name"];

                                if (businessConditionNameAttribute && businessConditionNameAttribute.values && businessConditionNameAttribute.values.length) {
                                    businessConditionName = businessConditionNameAttribute.values[0].value;
                                }
                            }
                        }
                    }
                }

                return businessConditionName;
            }

        });
    </script>
</dom-module>