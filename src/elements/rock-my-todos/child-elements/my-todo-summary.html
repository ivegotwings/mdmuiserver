<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../../bedrock-helpers/data-helper.html">
<link rel="import" href="../../bedrock-helpers/context-helper.html">
<link rel="import" href="../../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../../pebble-button/pebble-button.html">

<link rel="import" href="../../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->

<dom-module id="my-todo-summary">
    <template>
        <style include="pebble-styles-shared">
            .list-item {
                -webkit-flex-wrap: nowrap;
                /* Safari 6.1+ */
                flex-wrap: nowrap;
                cursor: var(--list-item-cursor, pointer);
                position: relative;
                padding: 10px 10px 10px 8px;
                min-height: 50px;
                overflow: hidden;
            }

            .content-div {
                width: calc( 100% - 200px);
            }

            .square {
                max-width: 90px;
                height: 30px;
                text-align: center;
                line-height: 32px;
                color: var(--list-item-count-wrap-text-color, #036bc3);
                font-size: var(--font-size-lg, 18px);
                font-weight: 500;
                margin: 0 10px;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .todo-status {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                width: 8px;
            }

            .border-left-1 {
                background: rgba(18, 156, 230, 1);
            }

            .border-left-2 {
                background: rgba(54, 180, 74, 1);
            }

            .border-left-3 {
                background: rgba(120, 93, 168, 1);
            }

            .border-left-4 {
                background: rgba(247, 142, 30, 1);
            }

            .border-left-5 {
                background: rgba(246, 212, 12, 1);
            }

            .border-left-6 {
                background: rgba(238, 32, 76, 1);
            }

            .contentContainer {
                width: 100%;
            }

            #moreDetails {
                padding-left: 10px;
                padding-top: 10px;
            }

            .sub-content {
                position: absolute;
                right: 10px;
                top: 17px;
            }

            .to-do-name {
                line-height: 17px;
            }

            pebble-button.action {
                display: inline-block;
                border: 1px solid var(--palette-cerulean, #036bc3);
                border-radius: 3px;
                margin: 0px 7px 10px 0px;
                --pebble-button: {
                    height: 30px !important;
                    color: var(--palette-cerulean);
                    font-size: var(--default-font-size, 14px);
                }
                --pebble-button-iron-icon: {
                    padding: 0 5px 0 0;
                }
                --pebble-menu-button: {
                    height: 30px !important;
                    border-top: 1px solid var(--palette-cerulean);
                    border-right: 1px solid var(--palette-cerulean);
                    border-bottom: 1px solid var(--palette-cerulean);
                    background: #FFFFFF;
                    box-sizing: border-box;
                }
                --actions-icon-button: {
                    height: 16px;
                    width: 16px;
                    background: #FFFFFF;
                    color: var(--palette-cerulean);
                    padding: 0 !important;
                    margin: 0 5px;
                    top: -2px;
                }
                --pebble-button-paper-menu: {
                    background: #FFFFFF;
                }
                --pebble-button-paper-menu-item: {
                    background: #FFFFFF;
                    color: var(--palette-cerulean);
                    padding: 0px 8px;
                }
            }

            #loadingIcon {
                height: 24px;
                margin: 0px 10px -4px 10px;
            }

            pebble-button {
                --pebble-custom-icon-height: {
                    height: 30px;
                }
            }
        </style>
        <div class="list-item row layout-middle">
            <div class$="{{_computeClass(myTodo.status)}} todo-status"></div>
            <div class="contentContainer">
                <div class="row layout-middle">
                    <div id="taskCount" class="square" hidden>
                        [[_numberOfTasks]]
                    </div>
                    <div id="taskCountLoading">
                        <img id="loadingIcon" src="../../../../src/images/loading.svg"></img>
                    </div>
                    <div id="workflowMetadataContainer" class="content-div list-content" data="[[myTodo.workflowData]]" on-tap="_onActivityTap">
                        <div class="to-do-name block-text text-ellipsis">[[myTodo.name]]</div>
                    </div>
                    <div class="sub-content text-right">
                        <div id="viewDetails" class="btn-link" on-tap="_showHideDetails">
                            [[_detailsToggleText]] &raquo;
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div id="moreDetails" hidden="true">
                    <template is="dom-repeat" items="[[_businessConditions]]" as="businessCondition">
                        <pebble-button id="[[businessCondition.data.bcId]]" icon-url="../../../../src/images/loading.svg" class="action" noink raised
                            action-menu elevation="0" horizontal-align="right" vertical-align="top" button-text="[[businessCondition.businessConditionName]]"
                            data="[[businessCondition.data]]">
                        </pebble-button>
                    </template>
                </div>
            </div>
        </div>
        <div class="clearfix"></div>
        </div>

        <liquid-entity-model-get exclude-in-progress id="initBusinessConditionsGet" operation="initiatesearch" request-data="[[_businessConditionRequest]]"
            last-response="{{initBusinessConditionsGet}}" on-response="_onInitBusinessConditionsGetResponse" on-error="_onInitBusinessConditionsGetError"></liquid-entity-model-get>

        <liquid-entity-model-get exclude-in-progress id="businessConditionsGet" operation="getsearchresultdetail" request-data="[[_businessConditionRequest]]"
            request-id="[[initBusinessConditionsGet.content.requestId]]" on-response="_onBusinessConditionsGetResponse" on-error="_onBusinessConditionsGetError"></liquid-entity-model-get>

        <liquid-entity-govern-data-get name="governDataGet" operation="initiatesearchandgetcount" request-data="{{_governDataRequest}}" on-response="_onGovernDataResponse"
            on-error="_onGovernDataError" exclude-in-progress></liquid-entity-govern-data-get>

    </template>
    <script>
        Polymer({

            is: 'my-todo-summary',

            properties: {

                /**
                 * Fired when the `my-todo` is tapped in `my-todo`'s widget along with the event such as `rock-my-todo-click` and  "clicked" `my-todo`.
                 *
                 * @event bedrock-event
                 */

                /**
                 * Indicates the `myTodo` data.
                */
                myTodo: {
                    type: Object,
                    notify: true,
                    value: {}
                },

                _detailsToggleText: {
                    type: String,
                    value: 'View details'
                },

                _contexts: {
                    type: Array,
                    value: function () {
                        return ['self/sku_ruleContextMappings', 'self/lot_ruleContextMappings', 'self/productPresentation_ruleContextMappings']
                    }
                },

                _businessConditions: {
                    type: Array,
                    observer: '_getBusinessConditionCount',
                    value: function () {
                        return [];
                    }
                },

                _numberOfTasks: {
                    type: Number,
                    value: 0
                },

                _governDataRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _businessConditionRequest: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                _allowedEntityTypes: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior
            ],

            attached: function () {
                var governDataLiquid = this.$$("[name=governDataGet]");
                this._allowedEntityTypes = this.getSetting('allowedEntityTypes');

                if (governDataLiquid) {

                    if (this._allowedEntityTypes && this._allowedEntityTypes.length) {
                        var req = {
                            "params": {
                                "query": {
                                    "contexts": [
                                        {
                                            "workflow": this.myTodo.workflowName
                                        }
                                    ],
                                    "filters": {
                                        "attributesCriterion": [
                                            {
                                                "activities": {
                                                    "attributes": [
                                                        {
                                                            "activityName": {
                                                                "eq": this.myTodo.workflowData.wfActivityName
                                                            }
                                                        }
                                                    ]
                                                }
                                            }
                                        ],
                                        "typesCriterion": this._allowedEntityTypes
                                    }
                                }
                            }
                        };

                        if (!_.isEmpty(this.myTodo.workflowData.user)) {
                            var userId = "";
                            var user = this.myTodo.workflowData.user;

                            if (user.toLowerCase() == "all") {
                                userId = "";
                            } else if (user.toLowerCase() == "currentuser") {
                                userId = DataHelper.getUserId();
                            } else if (user.toLowerCase() == "unassigned") {
                                userId = "_UNASSIGNED";
                            }

                            if (userId) {
                                req.params.query.filters.attributesCriterion[0]["activities"].attributes.push({
                                    "assignedUser": {
                                        "eq": userId
                                    }
                                });
                            }
                        }

                        req.params.options = { "from": 0, "to": 0 };

                        this._governDataRequest = req;
                        governDataLiquid.generateRequest();
                    } else {
                        this.showErrorToast("Types criterion is undefied or empty for govern get.");
                    }
                }
            },

            _onGovernDataResponse: function (e) {
                if (e.detail && e.detail.response) {
                    var response = e.detail.response;
                    if (response && response.content) {
                        var totalRecords = response.content.totalRecords || 0;
                        var maxRecords = response.content.maxRecords || 0;

                        if (totalRecords > maxRecords) {
                            this._numberOfTasks = maxRecords + "+" ;
                        } else {
                            this._numberOfTasks = totalRecords;
                        }
                    }

                    this.$$('#taskCountLoading').hidden = true;
                    this.$$('#taskCount').hidden = false;
                }
            },

            _onGovernDataError: function (e) {
                this.showErrorToast(e.detail.response.reason);
            },

            /**
             *  This s internal function used to compute the class based on the status of my-todo
             */
            _computeClass: function (status) {
                if (status) {
                    if (status == "red") {
                        return 'border-left-1';
                    } else if (status == "orange") {
                        return 'border-left-2';
                    } else {
                        return 'border-left-3';
                    }
                }
                return 'border-left-3';
            },

            _showHideDetails: function () {
                var moreDetails = this.$$('#moreDetails');
                if (moreDetails) {
                    if (moreDetails.hidden) {
                        moreDetails.hidden = false;
                        this._showBusinessConditions();
                    } else {
                        moreDetails.hidden = true;
                        this._detailsToggleText = "View details";
                    }
                }
            },

            /**
             * This is internal function used to fire an rock-my-todo-click when my-todo element is tapped
             */
            _onActivityTap: function () {
                var eventData = {
                    name: "rock-my-todo-click",
                    data: this.myTodo.workflowData,
                }
                this.fire('bedrock-event', eventData);
            },

            _onInitBusinessConditionsGetResponse: function () {

                var businessConditionsGet = this.$$('#businessConditionsGet');
                if (typeof (businessConditionsGet) === "undefined" || businessConditionsGet == null) {
                    this.logError("BusinessConditionError");
                    this.showErrorToast(this._errorMessage);
                    return;
                }

                businessConditionsGet.generateRequest();
            },

            _onBusinessConditionsGetResponse: function (e) {
                var responseContent = DataHelper.validateAndGetResponseContent(e.detail.response);
                if (responseContent) {
                    var ruleContextMappings = responseContent.entityModels;

                    if (ruleContextMappings && ruleContextMappings.length) {
                        var firstRuleContextMapping = ruleContextMappings[0];

                        if (firstRuleContextMapping && firstRuleContextMapping.data) {
                            var contextBaseMappings = firstRuleContextMapping.data.contexts;

                            if (contextBaseMappings && contextBaseMappings.length) {
                                var businessConditions = [];
                                contextBaseMappings.forEach(function (ctxMapping) {
                                    if (ctxMapping && ctxMapping.relationships) {
                                        var hasBusinessConditions = ctxMapping.relationships['hasBusinessConditions'];

                                        if (hasBusinessConditions && hasBusinessConditions.length) {
                                            hasBusinessConditions.forEach(function (businessCondition) {
                                                if (businessCondition && businessCondition.attributes && businessCondition.relTo) {
                                                    var stepNameAttr = businessCondition.attributes['stepName'];
                                                    var businessConditionName = businessCondition.relTo.id.replace("_" + businessCondition.relTo.type, "");
                                                    if (!this._isBusinessConditionExist(businessConditionName, businessConditions)) {
                                                        if (stepNameAttr) {
                                                            var value = AttributeHelper.getFirstAttributeValue(stepNameAttr);

                                                            if (value && value == this.myTodo.workflowData.wfActivityName) {
                                                                var businessConditionItem = {
                                                                    "businessConditionName": businessConditionName,
                                                                    "data": {
                                                                        "wfName": this.myTodo.workflowName,
                                                                        "wfActivityName": this.myTodo.workflowData.wfActivityName,
                                                                        "wfActivityExternalName": this.myTodo.workflowData.wfActivityExternalName,
                                                                        "bcId": businessCondition.relTo.id,
                                                                        "user": this.myTodo.workflowData.user
                                                                    }
                                                                };

                                                                businessConditions.push(businessConditionItem);
                                                            }
                                                        }

                                                    }
                                                }
                                            }, this);
                                        }
                                    }
                                }, this);
                                this._prepareBusinessConditions(businessConditions);
                            }
                        }
                    }
                } else {
                    this.showErrorToast("Business conditions not found.");
                }
            },

            _onBusinessConditionsGetError: function (e) {
                this.showErrorToast(e.detail.response.reason);

            },

            _prepareBusinessConditions: function (businessConditions) {
                if (businessConditions && businessConditions.length) {
                    this._businessConditions = businessConditions;
                }
            },

            _showBusinessConditions: function () {
                this._detailsToggleText = "Hide details";
                this._businessConditionButtons = [];
                var contexts = this._getContextFromTypeCriterion(this._allowedEntityTypes);

                if (this.myTodo) {
                    var req = {
                        "params": {
                            "query": {
                                "contexts": contexts,
                                "filters": {
                                    "typesCriterion": [
                                        "ruleContextMappings"
                                    ],
                                    "relationshipsCriterion": [
                                        {
                                            "hasBusinessConditions": {
                                                "attributes": [
                                                    {
                                                        "stepName": {
                                                            "eq": this.myTodo.workflowData.wfActivityName
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "fields": {
                                "relationships": [
                                    "hasBusinessConditions"
                                ],
                                "relationshipAttributes": [
                                    "stepName"
                                ]
                            }
                        }
                    };

                    var initBusinessConditionsGet = this.$$('#initBusinessConditionsGet');

                    if (typeof (initBusinessConditionsGet) === "undefined" || initBusinessConditionsGet == null) {
                        this.logError("BusinessConditionError");
                        return;
                    }
                    this._businessConditionRequest = req;
                    initBusinessConditionsGet.generateRequest();
                }
            },

            _getBusinessConditionCount: function () {
                if (!_.isEmpty(this._businessConditions)) {
                    if (this._allowedEntityTypes && this._allowedEntityTypes.length) {
                        var contexts = this._getContextFromTypeCriterion(this._allowedEntityTypes);
                        var userId = "";
                        var user = this.myTodo.workflowData.user;

                        if (user.toLowerCase() == "all") {
                            userId = "";
                        } else if (user.toLowerCase() == "currentuser") {
                            userId = DataHelper.getUserId();
                        } else if (user.toLowerCase() == "unassigned") {
                            userId = "_UNASSIGNED";
                        }

                        var attributes = ["businessConditions", "status", "activities"];
                        this._businessConditions.forEach(function (businessCondition) {
                            if (businessCondition && businessCondition.data) {
                                var req = DataRequestHelper.createGovernGetRequest(contexts, typesCriterion, userId, businessCondition.data.wfActivityName, businessCondition.data.bcId, attributes);
                                if (!_.isEmpty(req)) {
                                    var governGetLiquid = document.createElement('liquid-entity-govern-data-get');
                                    governGetLiquid.id = businessCondition.data.bcId;
                                    governGetLiquid.operation = 'initiatesearchandgetcount';
                                    governGetLiquid.requestData = req;
                                    governGetLiquid.excludeInProgress = true;
                                    governGetLiquid.addEventListener('response', this._getBusinessConditionCountResponse.bind(this));
                                    governGetLiquid.addEventListener('error', this._getBusinessConditionCountFailed);
                                    governGetLiquid.generateRequest();
                                }
                            }
                        }, this);
                    } else {
                        this.logError("TypesCriterionEmptyError");
                    }
                }
            },

            _getBusinessConditionCountResponse: function (e) {
                if (e && e.currentTarget && e.detail) {
                    var businessConditionButton = this.$$('pebble-button[id=' + e.currentTarget.id + ']');
                    var response = e.detail.response;

                    if (response && response.content && businessConditionButton) {
                        var bcCount = 0;
                        var totalRecords = response.content.totalRecords || 0;
                        var maxRecords = response.content.maxRecords || 0;

                        if (totalRecords > maxRecords) {
                            bcCount = maxRecords + "+" ;
                        } else {
                            bcCount = totalRecords;
                        }

                        businessConditionButton.iconUrl = '';
                        businessConditionButton.buttonText = bcCount + "  " + businessConditionButton.buttonText;
                    }
                }
            },

            __getBusinessConditionCountFailed: function (e) {
                this.showErrorToast(e.detail.response.reason);
            },

            _isBusinessConditionExist: function (businessConditionName, businessConditions) {
                if (businessConditions && businessConditions.length) {
                    var isExist = false;
                    businessConditions.forEach(function (businessCondition) {
                        if (businessCondition.businessConditionName && businessCondition.businessConditionName == businessConditionName) {
                            isExist = true;
                        }
                    }, this);
                    return isExist;
                }
                return false;
            },

            _getContextFromTypeCriterion: function (allowedTypes) {
                var contexts = [];
                if (allowedTypes && allowedTypes.length) {
                    allowedTypes.forEach(function (type) {
                        contexts.push({
                            "self": "self/" + type + "_ruleContextMappings",
                            "workflow": this.myTodo.workflowName
                        });
                    }, this);
                }
                return contexts;
            }

        });
    </script>
</dom-module>