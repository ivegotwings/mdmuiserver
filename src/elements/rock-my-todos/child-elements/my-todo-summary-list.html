<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../../bedrock-helpers/data-helper.html">
<link rel="import" href="../../bedrock-helpers/context-helper.html">
<link rel="import" href="../../bedrock-helpers/data-request-helper.html">

<link rel="import" href="../../liquid-entity-model-get/liquid-entity-model-get.html">

<link rel="import" href="../../pebble-list-view/pebble-list-view.html">
<link rel="import" href="../../pebble-list-item/pebble-list-item.html">
<link rel="import" href="my-todo-summary.html">

<dom-module id="my-todo-summary-list">
    <template>
        <style include="pebble-styles-shared">
            .list-group {
                /*height: 490px;*/
                overflow-y: auto;
                /*padding: 0px 5px 0 0;*/
            }

            pebble-list-item:last-child .list-item {
                margin-bottom: 0!important;
            }
        </style>

        <app-localstorage-document id="todoSummaryStorage" session-only></app-localstorage-document>

        <liquid-entity-model-get id="initWorkflowDefinitionsGet" operation="initiatesearch" last-response="{{initWorkflowDefinitionsGet}}"
            on-response="_onInitWorkflowDefinitionsGetResponse" on-error="_onInitWorkflowDefinitionsGetError"></liquid-entity-model-get>

        <liquid-entity-model-get id="workflowDefinitionsGet" operation="getsearchresultdetail" request-id="[[initWorkflowDefinitionsGet.content.requestId]]"
            on-response="_onWorkflowDefinitionsGetResponse" on-error="_onWorkflowDefinitionsGetError"></liquid-entity-model-get>

        <pebble-list-view class="list-group column">
            <template is="dom-if" if="[[_isWorkflowDefinitionAvailable]]">
                <template is="dom-repeat" items="[[_getLists()]]">
                    <pebble-list-item>
                        <my-todo-summary my-todo="[[item]]" workflow-data="[[_workflowData]]" assigned-data="[[_assignedData]]" unassigned-data="[[_unAssignedData]]"></my-todo-summary>
                    </pebble-list-item>
                </template>
            </template>
        </pebble-list-view>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'my-todo-summary-list',

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * This property represents the list of my-todos
                     */
                    lists: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true,
                    },

                    verbose: {
                        type: Boolean,
                        value: true
                    },

                    _isWorkflowDefinitionAvailable: {
                        type: Boolean,
                        value: false
                    },

                    _activitiesCount: {
                        type: Number,
                        value: 0
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                attached: function () {
                    if (!_.isEmpty(this.contextData)) {
                        var initWorkflowDefinitionsGet = this.$$('#initWorkflowDefinitionsGet');

                        if (typeof (initWorkflowDefinitionsGet) === "undefined" ||
                            initWorkflowDefinitionsGet == null) {
                            console.error("Element having id initWorkflowDefinitionsGet not found.");
                            return;
                        }

                        initWorkflowDefinitionsGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(
                            this.contextData);
                        initWorkflowDefinitionsGet.generateRequest();
                    }
                },

                _onInitWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionsGet = this.$$('#workflowDefinitionsGet');

                    if (typeof (workflowDefinitionsGet) === "undefined" ||
                        workflowDefinitionsGet == null) {
                        console.error("Element having id workflowDefinitionsGet not found.");
                        return;
                    }

                    workflowDefinitionsGet.requestData = DataRequestHelper.createWorkflowDefinitionGetRequest(
                        this.contextData);
                    workflowDefinitionsGet.generateRequest();
                },

                _onInitWorkflowDefinitionsGetError: function (e) {
                    console.error("InitWorkflowDefinitionsGetError:- " + e.detail.response.reason.message);
                },

                _onWorkflowDefinitionsGetResponse: function (e) {
                    var workflowDefinitionResponse = e.detail.response;
                    var responseContent = this._validateResponsePackage(e.detail.response);
                    var localeStorage = this.$.todoSummaryStorage;

                    if (responseContent) {
                        var workflowDefinitions = responseContent.entityModels;

                        for (var i = 0; i < workflowDefinitions.length; i++) {
                            var workflowDefinition = workflowDefinitions[i];

                            if (typeof (workflowDefinition.data) !== "undefined" && typeof (
                                    workflowDefinition.data.attributes) !== "undefined") {
                                var workflowAttribtues = workflowDefinition.data.attributes;

                                // Note: Assume that this will always be 0
                                //       To be change in Future
                                var workflowGroup = workflowAttribtues.workflows.group[0];
                                var workflowActivities = AttributeHelper.getNestedAttributeValues(
                                    workflowGroup.activities);

                                for (var j = 0; j < workflowActivities.length; j++) {
                                    var workflowActivity = workflowActivities[j];

                                    var listItem = {};
                                    listItem.workflow = AttributeHelper.getFirstAttributeValue(
                                        workflowGroup.workflowName);
                                    listItem.name = AttributeHelper.getFirstAttributeValue(
                                        workflowActivity.activityName);


                                    var itemVariants = [];

                                    var workflowData = this._prepareWorkflowData(listItem);
                                    listItem.workflowData = workflowData ? workflowData.workflowInstanceId : "";
                                    itemVariants.push(listItem.workflowData);

                                    var assignedData = this._prepareAssignData(listItem);
                                    listItem.assignedData = assignedData ? assignedData.workflowInstanceId : "";
                                    itemVariants.push(listItem.assignedData);

                                    var unAssignedData = this._prepareUnAssignData(listItem);
                                    listItem.unassignedData = unAssignedData ? unAssignedData.workflowInstanceId : "";
                                    itemVariants.push(listItem.unassignedData);

                                    if (localStorage) {
                                        for (var x = 0; x < itemVariants.length; x++) {
                                            localeStorage.key = itemVariants[x].workflowInstanceId;
                                            localeStorage.data = itemVariants[x];
                                        }
                                    } else {
                                        console.error("app-localstorage-document element not found.");
                                    }

                                    if (!_.isEmpty(listItem)) {
                                        this.lists.push(listItem);
                                    }
                                }
                            }
                        }

                        if (this.lists.length > 0) {
                            this._isWorkflowDefinitionAvailable = true;
                        }

                        if (this.verbose) {
                            console.log(JSON.stringify({
                                "SummaryList:- ": this.lists
                            }))
                        }
                    }
                },

                _onWorkflowDefinitionsGetError: function (e) {
                    console.error("WorkflowDefinitionsGetError:- " + e.detail.response.reason.message);
                },

                _validateResponsePackage: function (responsePkg) {
                    if (typeof (responsePkg) !== "undefined" && responsePkg.status == "success") {
                        return responsePkg.content;
                    } else {
                        return false;
                    }
                },

                _getLists: function () {
                    if (this.lists && this.lists.length) {
                        return this.lists;
                    } else {
                        return this.getParentAppConfig('my-todo-summary-list');
                    }
                },

                _prepareWorkflowData: function (listItem) {
                    // var variant = {};
                    // variant.workflowInstanceId = this._getNewWorkflowInstanceId();
                    // variant.workflowName = listItem.workflow;
                    // variant.workflowActivityName = listItem.name
                    // variant.userId = "";
                    return {
                        workflowInstanceId: this._getNewWorkflowInstanceId(),
                        workflowName: listItem.workflow,
                        workflowActivityName: listItem.name,
                        userId: "",
                    };
                },

                _prepareAssignData: function (listItem) {
                    // var variant2 = {};
                    // variant2.workflowInstanceId = this._getNewWorkflowInstanceId();
                    // variant2.workflowName = listItem.workflow;
                    // variant2.workflowActivityName = listItem.name
                    // variant2.userId = DataHelper.getUserId();
                    // return variant2;

                    return {
                        workflowInstanceId: this._getNewWorkflowInstanceId(),
                        workflowName: listItem.workflow,
                        workflowActivityName: listItem.name,
                        userId: DataHelper.getUserId()
                    };
                },

                _prepareUnAssignData: function (listItem) {
                    // var variant3 = {};
                    // variant3.workflowInstanceId = this._getNewWorkflowInstanceId();
                    // variant3.workflowName = listItem.workflow;
                    // variant3.workflowActivityName = listItem.name
                    // variant3.userId = "_UNASSIGNED";
                    // return variant3;

                    return {
                        workflowInstanceId: this._getNewWorkflowInstanceId(),
                        workflowName: listItem.workflow,
                        workflowActivityName: listItem.name,
                        userId: "_UNASSIGNED"
                    };
                },

                _getNewWorkflowInstanceId: function () {
                    return "wfc" + (++this._activitiesCount);
                }

            });
        })();
    </script>
</dom-module>