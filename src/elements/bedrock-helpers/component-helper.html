<link rel="import" href="element-helper.html">

<script>
    window.ComponentHelper = window.ComponentHelper || {};

    (function () {
        ComponentHelper.deleteQueue = [];

        ComponentHelper.fireBedrockEvent = function (name, data, settings, element) {
            var returnVal;
            if (element) {
                return ComponentHelper._fireBedrockEvent(name, data, settings, element);
            }

            var eventNameRegistries = ['universal'];
            const activeApp = ComponentHelper.getCurrentActiveApp();
            var currentAppId = activeApp ? activeApp.id : "";
            if (currentAppId) {
                eventNameRegistries.push(currentAppId);
            }
            eventNameRegistries.forEach((registry) => {
                const registryEvent = RUFUtilities.pubsubEventNameRegistry[registry];
                var eventIndex = registryEvent && registryEvent.indexOf(name);
                if (eventIndex !== -1) {
                    var listeners = RUFUtilities.pubsubListenerRegistry[registry][eventIndex];
                    listeners.forEach((listener) => {
                        if (listener && listener.element) {
                            ComponentHelper.fireBedrockEvent(name, data, settings, listener.element);
                        }
                    })
                }
            });
        };
        ComponentHelper._fireBedrockEvent = function (name, data, settings, element) {
            if ((!settings || !settings.ignoreId) && element.id) {
                name = name + "-" + element.id;
            }
            var cancelable = false;
            if (settings && settings.cancelable) {
                cancelable = true;
            }

            if (settings && settings.appId) {
                name = name + "-" + settings.appId;
            } else if (settings && settings.isMainApp) {
                name = name + "-" + element.appId;
            } else if (element.appId) {
                name = name + "-" + element.getAppId();
            }
            return element.fire('bedrock-event' + "-" + name, data, {
                cancelable: cancelable
            });
        };

        ComponentHelper.displayNode = function (node, state) {
            if (!(node instanceof HTMLElement)) return;

            state ? node.removeAttribute('hidden') : node.setAttribute('hidden', '');
        };

        ComponentHelper.clearNode = function (contentElement) {
            if (!contentElement) return;

            var rangeObj = new Range();
            rangeObj.selectNodeContents(contentElement);
            rangeObj.deleteContents();
        };

        ComponentHelper.removeNode = function (node) {
            if (!(node instanceof HTMLElement) || !(node.parentNode)) return;

            node.parentNode.removeChild(node);
        };

        ComponentHelper.addToDeleteQueue = function (node) {
            ComponentHelper.deleteQueue.push(node);
        };

        ComponentHelper.emptyDeleteQueue = function () {
            var deleteNodes = ComponentHelper.deleteQueue.filter(n => !!n.parentNode);
            deleteNodes.forEach(n => ComponentHelper.removeNode(n));
            ComponentHelper.deleteQueue = [];
        };

        ComponentHelper.loadContent = function (contentElement, component, element, callback) {
            if (!contentElement) return;
            //if properties bag is not created then create it
            if (!component.properties) {
                component.properties = {};
            }

            var createComponent = (cElement) => {
                var dynamicEl = new cElement(); //document.createElement(component.name);
                this._componentCreating(component, element);
                for (var property in component.properties) {
                    if (component.properties.hasOwnProperty(property)) {
                        var val = component.properties[property];
                        if (typeof val == "object") {
                            dynamicEl.setAttribute(property, JSON.stringify(val));
                        } else {
                            //Polymer takes default as true, so do not set attribute for boolean false
                            if (typeof val != "boolean" || (typeof val == "boolean" && val)) {
                                dynamicEl.setAttribute(property, val);
                            }
                        }
                    }
                }
                if (element.nodeName == "ROCK-CONTENT-VIEW") {
                    dynamicEl.contentViewManager = element.manager;
                }
                dynamicEl.setAttribute("id", component.name + "-component-" + ElementHelper.getRandomId());
                dynamicEl.setAttribute("class", dynamicEl.getAttribute(
                    "class") + " view-component");

                //remove any existing child elements
                this.clearNode(contentElement);

                contentElement.appendChild(dynamicEl);
                ComponentHelper._componentCreated(component, element);
                if (callback) {
                    callback(dynamicEl);
                }
            };

            var cElement = customElements.get(component.name);
            if (cElement) {
                createComponent(cElement);
            } else {
                Polymer.importHref(element.resolveUrl(component.path), function (e) {
                    var cElement = customElements.get(component.name);
                    createComponent(cElement);
                }, function (e) {
                    console.log('dynamic component load failed with exception', e); //import failed
                }, true);
            }

        };

        ComponentHelper._componentCreating = function (...arg) {
            this._onComponentCreate('component-creating', ...arg);
        };

        ComponentHelper._componentCreated = function (...arg) {
            this._onComponentCreate('component-created', ...arg);
        };

        ComponentHelper._onComponentCreate = function (eventName, component, element) {
            var eventData = component;
            var eventDetail = {
                name: eventName,
                data: eventData
            }
            this.fireBedrockEvent(eventName, eventDetail, {
                ignoreId: true
            }, element);
        };

        ComponentHelper.getCurrentActiveApp = function () {
            var mainApp = RUFUtilities.mainApp;
            if (mainApp && mainApp.shadowRoot) {
                var contentViewMgr = mainApp.contentViewManager;
                if (contentViewMgr) {
                    var activeContentView = contentViewMgr.activeContentView;
                    if (activeContentView) {
                        var viewComponent = activeContentView.shadowRoot.querySelector(
                            "#content-view-container").querySelector(".view-component");
                        return viewComponent;
                    }
                    return mainApp;
                }
            }
        };

        ComponentHelper.getCurrentActiveAppName = function () {
            var currentActiveApp = ComponentHelper.getCurrentActiveApp();

            if (currentActiveApp && DataHelper.isValidObjectPath(currentActiveApp, 'appConfig.component.name')) {
                return currentActiveApp.appConfig.component.name;
            }
        };

        ComponentHelper.getAppById = function (appId) {
            var mainApp = RUFUtilities.mainApp;
            if (!mainApp || !mainApp.contentViewManager) return null;

            var contentViewMgr = mainApp.contentViewManager;
            var openedContentViews = contentViewMgr.$.contentViewManager.querySelectorAll("rock-content-view");

            if (!openedContentViews || !Array.isArray(openedContentViews)) return null;

            let viewComponent = null;

            [].find.call(openedContentViews, element => {
                viewComponent = element.shadowRoot.querySelector("#content-view-container").querySelector(
                    ".view-component");
                return viewComponent && viewComponent.id == appId;
            });

            return viewComponent;
        };

        /**
         * @method getContentViewByName - select content view node by name
         * @param {String} viewName
         * @return {HTMLElement|null}
         */
        ComponentHelper.getContentViewByName = function (viewName) {
            this.mainApp = this.mainApp || RUFUtilities.mainApp;

            if (!this.mainApp) return null;

            const contentViewManager = this.mainApp.contentViewManager;

            return contentViewManager ? contentViewManager.shadowRoot.querySelector(
                `rock-content-view[name="${viewName}"]`) : null;
        };

        ComponentHelper.getAppContainerById = function (appId) {
            var contentView;
            if (appId) {
                var app = ComponentHelper.getAppById(appId);
                if (app) {
                    contentView = ComponentHelper.getParentElement(app);
                }
            }
            return contentView;
        };

        ComponentHelper.getProgressBar = function () {
            var appCommon = RUFUtilities.appCommon;
            if (appCommon) {
                this._progressBar = this._progressBar || appCommon.querySelector("paper-progress");
                return this._progressBar;
            }
        };

        ComponentHelper.getViewNameWithQueryParams = function (queryParams, viewName) {
            if (queryParams && !isEmpty(queryParams)) {
                var queryString = JSON.stringify(queryParams).replace(/,/g, '');
                queryString = queryString.replace(/"|{|}\s*/g, "").replace(/:\s*/g, "-");
                viewName += queryString;
            }
            return viewName;
        };

        ComponentHelper.getParentElement = function (component) {
            if (!component) return;

            var parentNode = component.parentNode;
            if (parentNode) {
                if (parentNode.isRufComponent) {
                    return parentNode;
                }
                if (parentNode.host && parentNode.host.isRufComponent) {
                    return parentNode.host;
                }
                return ComponentHelper.getParentElement(parentNode);
            }
        };

        ComponentHelper.closeCurrentApp = function (action) {
            var activeApp = ComponentHelper.getCurrentActiveApp();
            var contentView = ComponentHelper.getParentElement(activeApp);
            var manager;
            if (contentView) {
                manager = contentView.manager;
            }
            if (manager) {
                manager.closeView(contentView.name, {}, action);
            }
        };

        ComponentHelper.appRoute = function (appName, queryParams) {
            var mainApp = RUFUtilities.mainApp;

            if (mainApp) {
                if (!_.isEmpty(queryParams)) {
                    ComponentHelper.setQueryParamsWithoutEncode(queryParams);
                }
                mainApp.changePageRoutePath(appName);
            }
        };

        ComponentHelper.setQueryParams = function (queryParams) {
            for (var key in queryParams) {
                if (queryParams.hasOwnProperty(key)) {
                    var element = queryParams[key];
                    queryParams[key] = encodeURIComponent(element);
                }
            }
            RUFUtilities.mainApp.set('pageRoute.__queryParams', queryParams);
        };

        ComponentHelper.setQueryParamsWithoutEncode = function (queryParams) {
            RUFUtilities.mainApp.set('pageRoute.__queryParams', queryParams);
        };

        ComponentHelper.closeBusinessFunction = function (action) {
            var bfDialog = document.querySelector("#businessFunctionDialog");
            if (bfDialog) {
                bfDialog.close();
                if (action && action.name) {
                    ComponentHelper.getCurrentActiveApp().fire(action.name, action);
                }
            } else {
                ComponentHelper.closeCurrentApp(action);
            }
        };

        ComponentHelper.getComputedStyleValue = function (element, styleClass) {
            var value;

            if (window.ShadyCSS) {
                value = ShadyCSS.getComputedStyleValue(element, styleClass);
            } else {
                value = getComputedStyle(element).getPropertyValue(styleClass);
            }

            return value;
        };

        ComponentHelper.getLocaleManager = function () {
            var mainApp = RUFUtilities.mainApp;
            if (mainApp) {
                return mainApp.localeManager;
            }
        }
    })();
</script>