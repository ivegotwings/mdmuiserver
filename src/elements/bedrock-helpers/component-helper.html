<link rel="import" href="element-helper.html">

<script>
    window.ComponentHelper = window.ComponentHelper || {};

    (function () {
        ComponentHelper.fireBedrockEvent = function (name, data, settings, element) {
            var returnVal;
            if (element) {
                returnVal = ComponentHelper._fireBedrocEvent(name, data, settings, element);
            } else {
                _pubsubListenerRegistry.forEach(function (item) {
                    var eventName = name;
                    if (item) {
                        var element = item.element;
                    }
                    if (item.eventName && item.eventName.indexOf(eventName) >= 0) {
                        returnVal = ComponentHelper._fireBedrocEvent(eventName, data, settings, element);
                    }
                });
            };
            return returnVal;
        };
        ComponentHelper._fireBedrocEvent = function (name, data, settings, element) {
            if ((!settings || !settings.ignoreId) && element.id) {
                name = name + "-" + element.id;
            }
            var cancelable = false;
            if (settings && settings.cancelable) {
                cancelable = true;
            }

            if (settings && settings.appId) {
                name = name + "-" + settings.appId;
            } else {
                if (settings && settings.isMainApp) {
                    name = name + "-" + element.appId;
                } else {
                    if (element.appId) {
                        name = name + "-" + element.getAppId();
                    }
                }
            }

            return element.fire('bedrock-event' + "-" + name, data, { cancelable: cancelable });
        };

        ComponentHelper.loadContent = function (contentElement, component, element, callback) {
            //if properties bag is not created then create it
            if (!component.properties) {
                component.properties = {};
            }

            var createComponent = function (cElement) {
                var dynamicEl = new cElement();//document.createElement(component.name);
                ComponentHelper._componentCreating(component, element);
                for (var property in component.properties) {
                    if (component.properties.hasOwnProperty(property)) {
                        var val = component.properties[property];
                        if (typeof val == "object") {
                            dynamicEl.setAttribute(property, JSON.stringify(val));
                        } else {
                            //Polymer takes default as true, so do not set attribute for boolean false
                            if (typeof val != "boolean" || (typeof val == "boolean" && val)) {
                                dynamicEl.setAttribute(property, val);
                            }
                        }
                    }
                }
                if (element.nodeName == "ROCK-CONTENT-VIEW") {
                    dynamicEl.contentViewManager = element.manager;
                }
                dynamicEl.setAttribute("id", component.name + "-component-" + ElementHelper.getRandomId());
                dynamicEl.setAttribute("class", dynamicEl.getAttribute(
                    "class") + " view-component");

                //remove any existing child elements
                if (contentElement && contentElement.childNodes.length) {
                    while (contentElement.childNodes.length) {
                        contentElement.removeChild(contentElement.firstChild);
                    }
                }
                contentElement.appendChild(dynamicEl);
                Polymer.dom.flush();
                ComponentHelper._componentCreated(component, element);
                if (callback) {
                    callback(dynamicEl);
                }
            };

            var cElement = customElements.get(component.name);
            if (cElement) {
                createComponent(cElement);
            } else {
                Polymer.importHref(element.resolveUrl(component.path), function (e) {
                    var cElement = customElements.get(component.name);
                    createComponent(cElement);
                }, function (e) {
                    console.log('dynamic component load failed with exception', e);  //import failed
                },
                    true
                );
            }

        };

        ComponentHelper._componentCreating = function (component, element) {
            //event to let consumer change component configuration before creating it
            var eventName = "component-creating";
            var eventData = component;
            var eventDetail = {
                name: eventName,
                data: eventData
            }
            this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true }, element);
        };

        ComponentHelper._componentCreated = function (component, element) {
            var eventName = "component-created";
            var eventData = component;
            var eventDetail = {
                name: eventName,
                data: eventData
            }
            this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true }, element);
        };

        ComponentHelper.getCurrentActiveApp = function () {
            var mainApp = document.querySelector("main-app");
            if (mainApp && mainApp.shadowRoot) {
                var contentViewMgr = mainApp.shadowRoot.querySelector("rock-content-view-manager");
                if (contentViewMgr) {
                    var activeContentView = contentViewMgr.$.contentViewManager.querySelector(
                        "rock-content-view:not([hidden])");
                    if (activeContentView) {
                        var viewComponent = activeContentView.shadowRoot.querySelector("#content-view-container").querySelector(".view-component");
                        return viewComponent;
                    } else {
                        return mainApp;
                    }
                }
            }
            return undefined;
        };

        ComponentHelper.getAppById = function (appId) {
            var mainApp = document.querySelector("main-app");
            var app;
            if (mainApp) {
                var contentViewMgr = mainApp.shadowRoot.querySelector("rock-content-view-manager");
                if (contentViewMgr) {
                    var openedContentViews = contentViewMgr.$.contentViewManager.querySelectorAll("rock-content-view");
                    if (openedContentViews) {
                        openedContentViews.forEach(function (element) {
                            var viewComponent = element.shadowRoot.querySelector("#content-view-container").querySelector(".view-component");
                            if (viewComponent && viewComponent.id == appId) {
                                app = viewComponent;
                            }
                        }, this);
                    }
                }
            }
            return app;
        };

        /**
        * @method getContentViewByName - select content view node by name
        * @param {String} viewName
        * @return {HTMLElement|null}
        */
        ComponentHelper.getContentViewByName = function (viewName) {
            this.mainApp = this.mainApp || document.querySelector("main-app");

            if (!this.mainApp) return null;

            const contentViewManager = this.mainApp.shadowRoot.querySelector("rock-content-view-manager");

            return contentViewManager ? contentViewManager.shadowRoot.querySelector(`rock-content-view[name="${viewName}"]`) : null;
        };

        ComponentHelper.getAppContainerById = function (appId) {
            var contentView = undefined;
            if (appId) {
                var app = ComponentHelper.getAppById(appId);
                if (app) {
                    contentView = ComponentHelper.getComponentContainer(app);
                }
            }
            return contentView;
        };

        ComponentHelper.getComponentContainer = function (element) {
            var parentNode = element.parentNode;
            if (parentNode) {
                if (parentNode.isRufComponent) {
                    return parentNode;
                }
                else if (parentNode.host && parentNode.host.isRufComponent) {
                    return parentNode.host;
                }
                else {
                    return this.getComponentContainer(parentNode);
                }
            }
            return parentNode;
        };

        ComponentHelper.getProgressBar = function () {
            var mainApp = document.querySelector("main-app");
            if (mainApp) {
                return mainApp.shadowRoot.querySelector("paper-progress");
            }
            return undefined;
        };

        ComponentHelper.getViewNameWithQueryParams = function (queryParams, viewName) {
            if (queryParams && !isEmpty(queryParams)) {
                var queryString = JSON.stringify(queryParams).replace(/,/g, '');
                queryString = queryString.replace(/"|{|}\s*/g, "").replace(/:\s*/g, "-");
                viewName += queryString;
            }
            return viewName;
        };

        ComponentHelper.getParentElement = function (component) {
            if (component) {
                var parentNode = component.parentNode;
                if (parentNode) {
                    if (parentNode.isRufComponent) {
                        return parentNode;
                    }
                    else if (parentNode.host && parentNode.host.isRufComponent) {
                        return parentNode.host;
                    }
                    else {
                        return ComponentHelper.getParentElement(parentNode);
                    }
                }
            }
        };

        ComponentHelper.closeCurrentApp = function (action) {
            var activeApp = ComponentHelper.getCurrentActiveApp();
            var contentView = ComponentHelper.getComponentContainer(activeApp);
            var manager;
            if (contentView) {
                manager = contentView.manager;
            }
            if (manager) {
                manager.closeView(contentView.name, {}, action);
            }
        };

        ComponentHelper.appRoute = function (appName, queryParams) {
            var mainApp = document.querySelector("main-app");

            if (mainApp) {
                if (!_.isEmpty(queryParams)) {
                    ComponentHelper.setQueryParamsWithoutEncode(queryParams);
                }
                document.querySelector("main-app").changePageRoutePath(appName);
            }
        };

        ComponentHelper.setQueryParams = function (queryParams) {
            for (var key in queryParams) {
                if (queryParams.hasOwnProperty(key)) {
                    var element = queryParams[key];
                    queryParams[key] = encodeURIComponent(element);
                }
            }
            document.querySelector("main-app").set('pageRoute.__queryParams', queryParams);
        };

        ComponentHelper.setQueryParamsWithoutEncode = function (queryParams) {
            document.querySelector("main-app").set('pageRoute.__queryParams', queryParams);
        };

        ComponentHelper.closeBusinessFunction = function (action) {
            var bfDialog = document.querySelector("#businessFunctionDialog");
            if (bfDialog) {
                bfDialog.close();
                if (action && action.name) {
                    ComponentHelper.getCurrentActiveApp().fire(action.name, action);
                }
            } else {
                ComponentHelper.closeCurrentApp(action);
            }
        };

        ComponentHelper.getComputedStyleValue = function (element, styleClass) {
            var value;

            if (window.ShadyCSS) {
                value = ShadyCSS.getComputedStyleValue(element, styleClass);
            } else {
                value = getComputedStyle(element).getPropertyValue(styleClass);
            }

            return value;
        }
    })();

</script>