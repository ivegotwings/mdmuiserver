<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="context-helper.html">

<script>
    DataRequestHelper = {};

    (function () {

        DataRequestHelper.createEntityModelCompositeGetRequest = function (contextData) {
            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valContexts = ContextHelper.getValueContexts(contextData);
            var itemContexts = ContextHelper.getItemContexts(contextData);

            var locale = valContexts && valContexts.length > 0 && valContexts[0].locale ? valContexts[0].locale : 'en-US';
            var typeName = itemContexts && itemContexts.length > 0 && itemContexts[0].type ? itemContexts[0].type : undefined;
            var attributeNames = itemContexts && itemContexts.length > 0 && itemContexts[0].attributeNames ? itemContexts[0].attributeNames : undefined;
            var relationships = itemContexts && itemContexts.length > 0 && itemContexts[0].relationships ? itemContexts[0].relationships : undefined;
            var relationshipAttributes = itemContexts && itemContexts.length > 0 && itemContexts[0].relationshipAttributes ? itemContexts[0].relationshipAttributes : undefined;

            if (!typeName) {
                return undefined;
            };

            var req = {
                "params": {
                    "query": {
                        "contexts": dataContexts,
                        "locale": locale,
                        "name": typeName
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames,
                        "relationships": relationships,
                        "relationshipAttributes": relationshipAttributes
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createEntityGetRequest = function (contextData) {
            var itemContexts = ContextHelper.getItemContexts(contextData);

            if (!(itemContexts && itemContexts.length > 0)) {
                return undefined;
            };

            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valueContexts = ContextHelper.getValueContexts(contextData);

            var filteredIds = [];
            var ids = [...new Set(itemContexts.map((obj) => obj.id))];
            ids = ids.filter(id => typeof(id) !== "undefined" && typeof(id) !== "null");

            // May Need Fix...  Array inside Array[[]]
            // Ask Vishal
            var types = [...new Set(itemContexts.map((obj) => obj.type))];

            var firstItemContext = ContextHelper.getFirstItemContext(contextData);
            var attributeNames = firstItemContext.attributeNames;
            var relationships = firstItemContext.relationships;
            var relationshipAttributes = firstItemContext.relationshipAttributes;
            
            var req = {
                "params": {
                    "query": {
                        "contexts": dataContexts,
                        "valueContexts": valueContexts,
                        "filters": {
                            "typesCriterion": types[0]
                        }
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames,
                        "relationships": relationships,
                        "relationshipAttributes": relationshipAttributes
                    },
                    "options": {
                        "totalRecords": 1,
                        "includeRequest": false
                    }
                }
            };

            if (!_.isNull(ids) && !_.isEmpty(ids) && ids) {
                req.params.query.ids = ids;
            }

            return req;
        };

    })();
</script>