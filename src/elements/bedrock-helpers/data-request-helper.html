<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">-->
<link rel="import" href="context-helper.html">
<link rel="import" href="component-helper.html">
<link rel="import" href="data-transform-helper.html">

<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">

<script>
    window.DataRequestHelper = window.DataRequestHelper || {};

    (function () {

        DataRequestHelper.createEntityModelCompositeGetRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData);//to avoid live reference change

            var itemContexts = ContextHelper.getItemContexts(contextData);

            var typeName = itemContexts && itemContexts.length > 0 && itemContexts[0].type ? itemContexts[0].type : undefined;
            var domain = itemContexts && itemContexts.length > 0 && itemContexts[0].domain ? itemContexts[0].domain : undefined;
            var attributeNames = itemContexts && itemContexts.length > 0 && itemContexts[0].attributeNames ? itemContexts[0].attributeNames : undefined;
            var relationships = itemContexts && itemContexts.length > 0 && itemContexts[0].relationships ? itemContexts[0].relationships : undefined;
            var relationshipAttributes = itemContexts && itemContexts.length > 0 && itemContexts[0].relationshipAttributes ? itemContexts[0].relationshipAttributes : undefined;

            if (!typeName) {
                return undefined;
            }

            var req = {
                "params": {
                    "query": {
                        "name": typeName,
                        "filters": {
                            "typesCriterion": [
                                "entityCompositeModel"
                            ]
                        }
                    },
                    "fields": {
                        "attributes": attributeNames,
                        "relationships": relationships,
                        "relationshipAttributes": relationshipAttributes
                    }
                }
            };
            if (!_.isEmpty(domain)) {
                req.params.query.domain = domain;
            }

            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valContexts = ContextHelper.getValueContexts(contextData);

            if (!_.isEmpty(dataContexts) && !_.isEmpty(dataContexts[0])) {
                req.params.query.contexts = dataContexts;
            }

            if (_.isEmpty(valContexts) && _.isEmpty(valContexts[0])) {
                valContexts = [DataHelper.getDefaultValContext()];
            }
            req.params.query.valueContexts = valContexts;

            return req;
        };

        DataRequestHelper.addContextsToModelRequest = function (requestObject, contextData) {

            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valContexts = ContextHelper.getValueContexts(contextData);
            var targetContexts = [{
                "locale": DataHelper.getDefaultLocale()
            }];

            //in both cases (remove from the top)
            if (DataHelper.getValue(requestObject, "params.query.locale")) {
                delete requestObject.params.query.locale;
            }

            //requestObject.params.query.contexts <- locale here for every of (dataContexts x valContexts.locale)
            if (!_.isEmpty(dataContexts) && !_.isEmpty(dataContexts[0])) {
                targetContexts = dataContexts.reduce((result, dataContext) => {
                    (valContexts || []).forEach((valContext) => {
                        let dataContextWithLocale = DataHelper.cloneObject(dataContext);
                        dataContextWithLocale.locale = valContext.locale;
                        result.push(dataContextWithLocale);
                    });
                    return result;
                }, []);
            }

            //requestObject.params.query.contexts if empty - create a new one with locale
            //req.params.query.locale = valContexts && valContexts.length > 0 && valContexts[0].locale ? valContexts[0].locale : DataHelper.getDefaultLocale();

            //Overrideing Ilya's changes for now beacause it's breaking modelCoalesce
            requestObject.params.query.contexts = dataContexts;
        };

        DataRequestHelper.createEntityGetRequest = function (contextData, addDefaultContext, allowCoalesceFallback) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var itemContexts = ContextHelper.getItemContexts(contextData);

            if (!(itemContexts && itemContexts.length > 0)) {
                return undefined;
            }

            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valueContexts = ContextHelper.getValueContexts(contextData);

            var filteredIds = [];

            var ids = [];
            var types = [];
            for (var i = 0; i < itemContexts.length; i++) {
                var currentItemContext = itemContexts[i];
                //ids
                if (currentItemContext.id instanceof Array) {
                    var itemContextIds = currentItemContext.id;
                    for (var j = 0; j < itemContextIds.length; j++) {
                        ids.push(itemContextIds[j]);
                    }
                } else {
                    var itemContextId = currentItemContext.id;
                    ids.push(itemContextId);
                }
                //types
                if (currentItemContext.type instanceof Array) {
                    var itemContextTypes = currentItemContext.type;
                    for (var j = 0; j < itemContextTypes.length; j++) {
                        types.push(itemContextTypes[j]);
                    }
                } else {
                    var itemContextType = currentItemContext.type;
                    types.push(itemContextType);
                }
            }

            //remove falsy items
            ids = ids.filter(Boolean);
            types = types.filter(Boolean);

            var firstItemContext = ContextHelper.getFirstItemContext(contextData);
            var attributeNames = firstItemContext.attributeNames;
            var relationships = firstItemContext.relationships;
            var relationshipAttributes = firstItemContext.relationshipAttributes;
            var relationshipsCriterion = firstItemContext.relationshipsCriterion;
            var domain = itemContexts && itemContexts.length > 0 && itemContexts[0].domain ? itemContexts[0].domain : undefined;

            var req = {
                "params": {
                    "query": {
                        "filters": {
                            "typesCriterion": types
                        }
                    },
                    "fields": {
                        "attributes": attributeNames,
                        "relationships": relationships,
                        "relationshipAttributes": relationshipAttributes
                    },
                    "options": {
                        "maxRecords": ids.length || 200
                    }
                }
            };

            if (domain) {
                req.params.query.domain = domain;
            }

            if (!_.isNull(ids) && !_.isEmpty(ids) && ids) {
                if(ids.length == 1) {
                    req.params.query.id = ids[0];
                } else {
                    req.params.query.ids = ids;
                }
                
            }

            if (!_.isNull(relationshipsCriterion) && !_.isEmpty(relationshipsCriterion)) {
                req.params.query.filters.relationshipsCriterion = relationshipsCriterion;
            }

            if (!_.isEmpty(dataContexts) && !_.isEmpty(dataContexts[0])) {
                req.params.query.contexts = dataContexts;
            }

            if (!_.isEmpty(valueContexts) && !_.isEmpty(valueContexts[0])) {
                req.params.query.valueContexts = valueContexts;
            }

            if (allowCoalesceFallback && !_.isEmpty(req.params.query.valueContexts)) {
                for (var i = 0; i < req.params.query.valueContexts.length; i++) {
                    req.params.query.valueContexts[i].localeCoalesce = true;
                }
            }

            if (addDefaultContext) {
                DataRequestHelper.addDefaultContext(req);
            }

            return req;
        };

        DataRequestHelper.createEntityGetRequestForDownload = function (contextData, profileContexts) {
            var req = undefined;
            if (!_.isEmpty(contextData)) {
                req = this.createEntityGetRequest(contextData);

                var userContext = ContextHelper.getFirstUserContext(contextData);

                if (req) {
                    if (req.params) {
                        req.params.rsconnect = {
                            "includeValidationData": true,
                            "profilecontexts": profileContexts
                        };
                        req.clientState = {
                            "notificationInfo": {
                                "userId": userContext.user
                            }
                        };
                    }
                }
            }

            return req;
        };

        DataRequestHelper.createWorkflowMappingGetRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var typeName = "workflowDefinitionMapping";
            var entityType = firstItemContext.type;

            var relationships = ["hasWorkflowsDefined"];

            var req = {
                "params": {
                    "query": {
                        "filters": {
                            "typesCriterion": [typeName]
                        }
                    },
                    "fields": {
                        "properties": [
                            "_ALL"
                        ],
                        "relationships": relationships
                    }
                }
            };
            if (entityType instanceof Array) {
                req.params.query["names"] = entityType;
            } else {
                req.params.query["name"] = entityType;
            }
            //console.log('workflow def mapping req get ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createWorkflowDefinitionGetRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var typeName = "workflowDefinition";

            var workflowNames = [];
            var attributeNames = ["_ALL"];
            if (firstItemContext) {
                if (typeof (firstItemContext.workflowNames) !== "undefined") {
                    workflowNames = firstItemContext.workflowNames;
                }

                if (typeof (firstItemContext.atttributeNames) !== "undefined") {
                    attributeNames = firstItemContext.atttributeNames;
                }
            }

            var workflowDefinitionIds = [];
            for (var i = 0; i < workflowNames.length; i++) {
                var workflowName = workflowNames[i];
                workflowDefinitionIds.push(workflowName + "_" + typeName);
            }

            var req = {
                "params": {
                    "query": {
                        "filters": {
                            "typesCriterion": [typeName]
                        }
                    },
                    "fields": {
                        "properties": [
                            "_ALL"
                        ],
                        "attributes": attributeNames
                    }
                }
            };

            if (!_.isNull(workflowDefinitionIds) && workflowDefinitionIds.length >
                0) {
                req.params.query.ids = workflowDefinitionIds;
            }

            //console.log('workflow def req get ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createWorkflowDefinitionMappingGetRequest = function () {

            var typeName = "workflowDefinitionMapping";

            var req = {
                "params": {
                    "query": {
                        "filters": {
                            "typesCriterion": [typeName]
                        }
                    },
                    "fields": {
                        "relationships": [
                            "_ALL"
                        ]
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createWorkflowRuntimeInstanceGetRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var entityId = firstItemContext.id;
            var entityType = firstItemContext.type;
            var workflowNames = firstItemContext.workflowNames;
            var attributeNames = firstItemContext.atttributeNames ? firstItemContext.attributeNames : ["workflowInstanceId", "status", "startDateTime", "endDateTime", "activities"];

            var workflowContexts = [];

            for (var i = 0; i < workflowNames.length; i++) {
                var workflowName = workflowNames[i];
                var workflowContext = undefined;

                workflowContext = {
                    "workflow": workflowName,
                    "self": "self"
                };
                workflowContexts.push(workflowContext);
            }

            var req = {
                "params": {
                    "query": {
                        "contexts": workflowContexts,
                        "id": entityId,
                        "filters": {
                            "typesCriterion": [entityType]
                        }
                    },
                    "fields": {
                        "attributes": attributeNames
                    }
                }
            };

            //console.log('workflow runtime instance get req ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createWorkflowEventsGetRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData);
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var entityId = firstItemContext.id;
            var workflowNames = firstItemContext.workflowNames;
            var attributeNames = firstItemContext.atttributeNames ? firstItemContext.attributeNames : ["workflowInstanceId", "status", "startDateTime", "endDateTime", "activities"];

            var workflowContexts = [];

            for (var i = 0; i < workflowNames.length; i++) {
                var workflowName = workflowNames[i];
                var workflowContext = undefined;

                workflowContext = {
                    "workflow": workflowName,
                    "self": "self"
                };
                workflowContexts.push(workflowContext);
            }

            var req = {
                "params": {
                    "query": {
                        "contexts": workflowContexts,
                        "filters": {
                            "typesCriterion": ["entitygovernevent"],
                            "attributesCriterion": [{
                                "entityId": {
                                    "exact": entityId,
                                    "nonContextual": true
                                }
                            }],
                            "excludeNonContextual": true
                        }
                    },
                    "fields": {
                        "attributes": attributeNames
                    }
                }
            };

            return req;
        },

            DataRequestHelper.createWorkflowTransitionRequest = function (contextData) {
                var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
                var firstDataContext = ContextHelper.getFirstDataContext(contextData);
                var firstItemContext = ContextHelper.getFirstItemContext(contextData);
                var operations = SharedEnumsUtil.Enums.operations;
                var entityId = firstItemContext.id;
                var entityType = firstItemContext.type;
                var transitionTo = firstItemContext.transitionTo;
                var currentActiveApp = ComponentHelper.getCurrentActiveApp();
                var appInstanceId = "";
                if (currentActiveApp) {
                    appInstanceId = currentActiveApp.id;
                }

                var req = {
                    "params": {
                        "workflow": {
                            "workflowName": transitionTo.workflowName,
                            "activity": {
                                "activityName": transitionTo.activityName,
                                "action": transitionTo.action,
                                "comment": transitionTo.comments
                            }
                        }
                    },
                    "clientState": {
                        "notificationInfo": {
                            "operation": operations.WorkflowTransition,
                            "showNotificationToUser": true,
                            "context": {
                                "appInstanceId": appInstanceId,
                                "workflowName": transitionTo.workflowName,
                                "workflowActivityName": transitionTo.activityName,
                                "workflowAction": transitionTo.action
                            }
                        }
                    },
                    "entity": {
                        "id": entityId,
                        "name": entityId,
                        "type": entityType,
                        "data": {}
                    }
                };

                //console.log('workflow transition req ', JSON.stringify(req, null, 2));
                return req;
            };

        DataRequestHelper.createInvokeWorkflowRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var entityId = firstItemContext.id;
            var entityType = firstItemContext.type;
            var invokeWorkflowData = firstItemContext.invokeWorkflowData;

            var req = {
                "params": {
                    "workflow": {
                        "workflowName": invokeWorkflowData.workflowName
                    }
                },
                "entity": {
                    "id": entityId,
                    "name": entityId,
                    "type": entityType,
                    "data": {}
                }
            };

            //console.log('workflow invoke req ', JSON.stringify(req, null, 2));
            return req;
        };


        DataRequestHelper.createConfigInitialRequest = function (contextData) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var _context = ContextHelper.getFirstDataContext(contextData);
            var _typesCriterion = ContextHelper.getItemContexts(contextData);

            var req = {
                "params": {
                    "query": {
                        "contexts": [
                            _context
                        ],
                        "filters": {
                            "typesCriterion": _typesCriterion,
                            "excludeNonContextual": true
                        }
                    },
                    "fields": {
                        "jsonData": true
                    }
                }
            };

            return req;
        };

        DataRequestHelper.getContextSepecificConfigRequest = function (appName, componentName, contextCollection) {
            var configContext = {
                "app": appName,
                "component": componentName,
                "service": "_ALL",
                "subComponent": "_ALL"
            };

            var request = {
                "params": {
                    "query": {
                        "contexts": [configContext],
                        "filters": {
                            "typesCriterion": ["uiConfig"],
                            "excludeNonContextual": true
                        }
                    },
                    "fields": {
                        "jsonData": true
                    }
                }
            };

            if (!_.isEmpty(contextCollection)) {
                for (var key in contextCollection) {
                    configContext[key] = contextCollection[key];
                }
            }

            return request;
        };

        DataRequestHelper.getConfigCreateRequest = function (contextData, type, appName, contextSearchName) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var _context = ContextHelper.getFirstDataContext(contextData);
            var _details = {};

            _details["id"] = appName + "_" + type + "_" + ElementHelper.getRandomString();
            _details["name"] = contextSearchName ? contextSearchName : type + "_" + ElementHelper.getRandomString();
            _details["type"] = type;

            var req = {
                "id": _details["id"],
                "name": _details["name"],
                "version": {},
                "type": _details["type"],
                "properties": {},
                "data": {
                    "contexts": [
                        _context
                    ]
                }
            };

            return req;
        };

        DataRequestHelper.createConfigGetRequest = function (appName, context, componentName) {
            if (componentName) {
                context.component = componentName;
            }

            if (_.isEmpty(context.component)) {
                context.component = "_ALL";
            }

            var name = this._createConfigName(context);

            var req = {
                "params": {
                    "query": {
                        "name": name,
                        "contexts": [
                            context
                        ],
                        "filters": {
                            "typesCriterion": ["uiConfig"]
                        }
                    },
                    "fields": {
                        "jsonData": true
                    }
                }
            };

            //console.log('config get request ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createConfigGetRequestNew = function (configId, configContext) {

            var req = {
                "params": {
                    "query": {
                        "id": configId,
                        "contexts": [
                            configContext
                        ],
                        "filters": {
                            "typesCriterion": ["uiConfig"]
                        }
                    },
                    "fields": {
                        "jsonData": true
                    }
                }
            };

            //console.log('config X get request ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createSyncValidationRequest = function (id, type, data, requestObjectKeyName) {
            var reqObj = {};
            var reqObjKeyName = requestObjectKeyName ? requestObjectKeyName : "entity";
            reqObj[reqObjKeyName] = {
                                    "id": id,
                                    "type":type,
                                    "data": data
                                }
            return reqObj;
        };

        DataRequestHelper._createConfigName = function (context) {
            var name = undefined;
            for (var field in context) {
                var value = context[field];
                if (value != "_ALL") {
                    if (name) {
                        name = name + "_" + context[field];
                    } else {
                        name = context[field];
                    }
                }
            }

            return name;
        };

        DataRequestHelper.createWfChangeAssignmentRequest = function (entity, wfCriterion, contextData, action, userToBeAssigned) {
            var contextData = DataHelper.cloneObject(contextData); //to avoid live reference change
            var userContext = {};
            var userName;
            var currentActiveApp = ComponentHelper.getCurrentActiveApp();
            var appInstanceId = "";
            var operations = SharedEnumsUtil.Enums.operations;
            if (currentActiveApp) {
                appInstanceId = currentActiveApp.id;
            }

            //TODO: user name here should be name of the user and not id...Fix tihs by reading proper header
            switch (action) {
                case 'take':
                    userContext = ContextHelper.getFirstUserContext(contextData);
                    if(userContext && userContext.id){
                        userName = userContext.user.replace('_user', '');
                    }
                    break;
                case 'release':
                    userName = ""
                    break;
                case 'reassign':
                    userContext = userToBeAssigned;
                    if(userContext && userContext.id){
                        userName = userContext.id.replace('_user', '');
                    }
                    break;
            }
            var request = {
                "params": {
                    "workflow": {
                        "workflowName": wfCriterion.workflowShortName,
                        "activity": {
                            "activityName": wfCriterion.workflowActivityName,
                            "newlyAssignedUserName": userName
                        }
                    }
                },
                "clientState": {
                    "notificationInfo": {
                        "operation": operations.WorkflowAssignment,
                        "showNotificationToUser": true,
                        "context": {
                            "appInstanceId": appInstanceId,
                            "workflowName": wfCriterion.workflowShortName,
                            "workflowActivityName": wfCriterion.workflowActivityName,
                            "workflowAction": "assigned to '" + userName + "'"
                        }
                    }
                }
            };

            if (entity) {
                request["entity"] = {
                    "id": entity.id,
                    "type": entity.type
                }
            }

            return request;
        }

        DataRequestHelper.createRePublishRequest = function (profiles) {
            var profileContexts = [];
            var typesCriterion = [];

            for (var i = 0; i < profiles.length; i++) {
                var element = profiles[i];
                if (element) {
                    var copContext = {};
                    if (element["copContext"]) {
                        copContext = element["copContext"];
                    }
                    profileContexts.push(copContext);
                    var elementTypesCriterion = element["types-criterion"];
                    if (elementTypesCriterion && elementTypesCriterion.length > 0) {
                        typesCriterion = typesCriterion.concat(elementTypesCriterion);
                    }
                }
            }
            var request = {
                "params": {
                    "query": {
                        "filters": {
                            "typesCriterion": typesCriterion
                        }
                    },
                    "fields": {
                        "attributes": ["_ALL"]
                    },
                    "rsconnect": {
                        "profilecontexts": profileContexts
                    }
                }
            };
            return request;
        }

        DataRequestHelper.createGovernGetRequest = function (options) {

            if (options) {
                var req = {
                    "params": {
                        "query": {
                            "contexts": options.contexts,
                            "filters": {
                                "attributesCriterion": [],
                                "typesCriterion": options.typesCriterion,
                                "excludeNonContextual": options.excludeNonContextual
                            }
                        }
                    }
                };

                if (!_.isEmpty(options.workflowActivityName)) {
                    req.params.query.filters.attributesCriterion.push({
                        "activities": {
                            "attributes": [{
                                "activityName": {
                                    "eq": options.workflowActivityName
                                }
                            }]
                        }
                    });
                }

                if (!_.isEmpty(options.userId)) {
                    if (req.params.query.filters.attributesCriterion.length) {
                        req.params.query.filters.attributesCriterion[0]["activities"].attributes.push({
                            "assignedUser": {
                                "eq": options.userId
                            }
                        });
                    } else {
                        req.params.query.filters.attributesCriterion.push({
                            "activities": {
                                "attributes": [{
                                    "assignedUser": {
                                        "eq": options.userId
                                    }
                                }]
                            }
                        });
                    }
                }

                req.params.query.filters.attributesCriterion.push({
                    "status": {
                        "eq": "Executing"
                    }
                });

                if (!_.isEmpty(options.businessConditionName)) {
                    req.params.query.filters.attributesCriterion.push({
                        "businessConditions": {
                            "attributes": [{
                                "businessConditionName": {
                                    "eq": options.businessConditionName
                                }
                            },
                            {
                                "businessConditionStatus": {
                                    "eq": options.passedBusinessConditions ? true : false
                                }
                            }
                            ]
                        }
                    });
                }
                if (options.businessConditionNames && options.businessConditionNames.length) {
                    for (var i = 0; i < options.businessConditionNames.length; i++) {
                        var businessConditionName = options.businessConditionNames[i];
                        req.params.query.filters.attributesCriterion.push({
                            "businessConditions": {
                                "attributes": [{
                                    "businessConditionName": {
                                        "eq": businessConditionName
                                    }
                                },
                                {
                                    "businessConditionStatus": {
                                        "eq": options.passedBusinessConditions ? true : false
                                    }
                                }
                                ]
                            }
                        });
                    }
                }

                if (!_.isEmpty(options.attributes)) {
                    req.params.fields = {
                        "attributes": options.attributes
                    }
                }

                req.params.options = {
                    "from": 0,
                    "to": 0
                };

                return req;
            }
        };

        DataRequestHelper.createOverridesGetRequest = function (copContext) {
            var contexts = [];
            if (!_.isEmpty(copContext)) {
                contexts.push(copContext);
            }
            var req = {
                "params": {
                    "query": {
                        "filters": {
                            "typesCriterion": [
                                "overrides"
                            ]
                        },
                        "contexts": contexts
                    },
                    "fields": {
                        "attributes": [
                            "_ALL"
                        ]
                    }
                }
            };
            return req;
        };

        DataRequestHelper.createMappingsGetRequest = function (contextData, copContext, selectedContexts, types, mappingType) {
            var context = DataRequestHelper._createMappingContext(contextData, selectedContexts, copContext, mappingType);
            var req = {
                "params": {
                    "query": {
                        "filters": {
                            "excludeNonContextual": true,
                            "typesCriterion": types
                        },
                        "contexts": [
                            context
                        ]
                    },
                    "fields": {
                        "attributes": [
                            "_ALL"
                        ]
                    },
                    "rsconnect": {
                        "loadMappingsFromHeaders": true,
                        "profilecontexts": [ 
                            copContext
                        ],
                        "headers": {
                            "relationships": [],
                            "entities": []
                        }
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createMappingsSaveRequest = function (contextData, copContext, selectedContexts, type, selectedRole, mappingType) {
            var clonedContetData = DataHelper.cloneObject(contextData);
            DataRequestHelper._setRoleBasedContextData(clonedContetData, selectedRole);
            var context = DataRequestHelper._createMappingContext(clonedContetData, selectedContexts, copContext, mappingType);
            var req = {
                "entity": {
                    "id": "",
                    "type": type,
                    "data": {
                        "contexts": [
                            {
                                "context": context,
                                "attributes": {}
                            }
                        ]
                    }
                }
            };
            req.hotline = true; // Should be removed once mapping review is enabled
            return req;
        };

        DataRequestHelper._createMappingContext = function (contextData, selectedContexts, copContext, mappingType) {
            var context = {};
            if (!_.isEmpty(contextData)) {
                var context = {};
                var itemContext = ContextHelper.getFirstItemContext(contextData);
                if (itemContext) {
                    context["entitytype"] = itemContext.type;
                }

                if (!_.isEmpty(selectedContexts)) {
                    for (var i = 0; i < selectedContexts.length; i++) {
                        context[selectedContexts[i].type] = selectedContexts[i].value;
                    }
                }

                var userContext = ContextHelper.getFirstUserContext(contextData);
                if (!_.isEmpty(userContext)) {
                    if(mappingType === "valueMapping") {
                        context["User Id"] = userContext.user;
                        context["Role"] = userContext.role;
                    } else {
                        context["user"] = userContext.user;
                        context["role"] = userContext.role;
                    }
                }

                if(mappingType === "valueMapping") {
                    context["Ownership Data"] = "";
                } else {
                    context["ownershipdata"] = "";
                }
                context.service = copContext.service;
            }

            return context;
        };

        DataRequestHelper._setRoleBasedContextData = function (contextData, selectedRole) {
            if (selectedRole) {
                var userContext = ContextHelper.getFirstUserContext(contextData) || {};
                var user = "_DEFAULT";
                var role = "_DEFAULT";

                if (selectedRole != "self") {
                    if (selectedRole == "role") {
                        role = userContext.role;
                    }
                    //Set user/role based on selection
                    userContext.user = user;
                    userContext.role = role;
                }
            }
        },

        DataRequestHelper.createEntityEventGetRequest = function (entityId) {
            if (entityId) {
                var req = {
                    "params": {
                        "query": {
                            "filters": {
                                "typesCriterion": [
                                    "entityhistoryevent"
                                ],
                                "attributesCriterion": [
                                    {
                                        "entityId": {
                                            "exact": entityId
                                        }
                                    },
                                    {
                                        "entityAction": {
                                            "exact": "systemupdate",
                                            "not": true
                                        }
                                    },
                                    {
                                        "eventType": {
                                            "exact": "NoChange",
                                            "not": true
                                        }
                                    }
                                ]
                            }
                        },
                        "fields": {
                            "attributes": [
                                "message",
                                "action",
                                "timeStamp"
                            ]
                        },
                        "sort": {
                            "properties": [
                                {
                                    "modifiedDate": "_DESC",
                                    "sortType": "_DATETIME"
                                }
                            ]
                        }
                    }
                }
                return req;
            }
        };

        DataRequestHelper.createProfileCreationRequest = function (profileId, baseProfile, service) {
            var ctxService = "";
            if (service == "transform") {
                ctxService = "excelImportTransformService";
            } else if (service == "process") {
                ctxService = "excelImportProcessService";
            }
            var profile = DataHelper.cloneObject(baseProfile);
            profile.id = profileId;
            profile.name = profileId;
            profile.data.contexts[0].context.service = ctxService;
            profile.data.contexts[0].jsonData.id = profileId;
            profile.data.contexts[0].jsonData.name = profileId;
            return profile;
        };

        DataRequestHelper.createBusinessConditionGetRequest = function (attributeNames) {
            var typeName = "businessCondition";
            var valContexts = [DataHelper.getDefaultValContext()];
            var req = {
                "params": {
                    "query": {
                        "valueContexts": valContexts,
                        "filters": {
                            "typesCriterion": [
                                "businessCondition"
                            ]
                        }
                    },
                    "fields": {
                        "attributes": attributeNames
                    }
                }
            };
            return req;
        };

        DataRequestHelper.generateRelationshipProcessRequest = function (contextData) {
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var entityId = firstItemContext && firstItemContext.id ? firstItemContext.id : "";
            var type = firstItemContext && firstItemContext.type ? firstItemContext.type : "";

            var req = {
                "id": entityId,
                "type": type,
                "data": {
                    "relationships": {}
                }
            };

            return req;
        };

        DataRequestHelper.createCombinedGetRequest = function (governDataReq, entityDataReq, isBulkOperation) {
            var isBulkOperation = isBulkOperation || false;

            var req = {
                "id": "combinedGet",
                "name": "combinedGet",
                "type": "config",
                "data": {
                    "jsonData": {
                        "searchQueries": []
                    }
                }
            }

            if (governDataReq) {
                var governDataSearchQuery = {
                    "serviceName": "entitygovernservice",
                    "action": "get",
                    "searchSequence": 1,
                    "searchQuery": governDataReq.params
                }
                req.data.jsonData.searchQueries.push(governDataSearchQuery);
            }

            if (entityDataReq) {
                var entityDataSearchQuery = {
                    "serviceName": "entityservice",
                    "action": "get",
                    "searchSequence": 2,
                    "searchQuery": entityDataReq.params
                };
                req.data.jsonData.searchQueries.push(entityDataSearchQuery);
            }

            if (!isBulkOperation) {
                var combinedGetReq = {};
                combinedGetReq.params = {};
                combinedGetReq.params.isCombinedQuerySearch = true;
                combinedGetReq.entity = req;
                return combinedGetReq;
            } else {
                return [req];
            }
        };

        DataRequestHelper.createImportRequest = function (fileDetails, copContext, hotline) {
            var copRequest = {
                "dataObject": {
                    "id": "",
                    "dataObjectInfo": {
                        "dataObjectType": "entityjson"
                    },
                    "properties": {
                        "createdByService": "user interface",
                        "createdBy": "user",
                        "createdDate": "2016-07-16T18:33:52.412-07:00",
                        "filename": fileDetails.originalFileName,
                        "encoding": "Base64",
                        "service": copContext.service,
                        "channel": copContext.channel,
                        "format": copContext.format,
                        "source": copContext.source,
                        "subtype": copContext.subtype,
                        "order": copContext.order
                    },
                    "data": {
                        "blob": ""
                    }
                }
            };

            if (hotline) {
                copRequest.hotline = hotline;
            }
            return copRequest;
        };

        DataRequestHelper.addDefaultContext = function (req) {
            let defaultLocale = DataHelper.getDefaultLocale();
            if (req.params.query) {
                req.params.query.valueContexts = req.params.query.valueContexts || [];
                let defaultValueContext = req.params.query.valueContexts.find(context => context.locale === defaultLocale);
                if (!defaultValueContext) {
                    req.params.query.valueContexts.push(DataHelper.getDefaultValContext());
                }
            }
        };

        DataRequestHelper.createContextModelGetRequest = function (entityType) {
            var req = {};

            if (entityType) {
                var contextModelId = entityType + "_entityContextModel";
                var req = {
                    "params": {
                        "query": {
                            "id": contextModelId,
                            "filters": {
                                "typesCriterion": [
                                    "entityContextModel"
                                ]
                            }
                        },
                        "fields": {
                            "attributes": ["_ALL"]
                        }
                    }
                };
            }
            return req;
        };

        DataRequestHelper.createGetModelRequest = function (types, modelName) {
            var ids = [];
            for (let i = 0; i < types.length; i++) {
                let type = types[i];
                ids.push(type + "_" + modelName);
            }

            var req = {
                "params": {
                    "query": {
                        "ids": ids,
                        "filters": {
                            "typesCriterion": [
                                modelName
                            ]
                        }
                    },
                    "fields": {
                        "attributes": [
                            "_ALL",
                            "INTERNAL_DATAOBJECT_METADATA_FIELDS"
                        ],
                        "relationships": [
                            "_ALL"
                        ]
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createGetManageModelRequest = function (entityTypes) {
            var ids = [];
            for (let i = 0; i < entityTypes.length; i++) {
                let entityType = entityTypes[i];
                ids.push(entityType + "_entityManageModel");
            }

            var req = {
                "params": {
                    "query": {
                        "ids": ids,
                        "filters": {
                            "typesCriterion": [
                                "entityManageModel"
                            ]
                        }
                    },
                    "fields": {
                        "attributes": [
                            "_ALL"
                        ],
                        "relationships": [
                            "_ALL"
                        ]
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createGetAttributeModelRequest = function (types, attributes) {
            var ids = [];
            if(!attributes || attributes.length == 0) {
                attributes = "_ALL";
            }

            for (let i = 0; i < types.length; i++) {
                let type = types[i];
                ids.push(type + "_attributeModel");
            }

            var req = {
                "params": {
                    "query": {
                        "ids": ids,
                        "filters": {
                            "typesCriterion": [
                                "attributeModel"
                            ]
                        }
                    },
                    "fields": {
                        "attributes": [
                            attributes
                        ]
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createGetReferenceRequest = function (contextData, referenceTypes) {
            var req = {
                "params": {
                    "query": {
                        "valueContexts": contextData.ValContexts,
                        "filters": {
                            "typesCriterion": referenceTypes
                        }
                    },
                    "fields": {
                        "attributes": [
                            "_ALL"
                        ]
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createEntityContextGetRequest = function (entityId, entityType) {
            var req = {}

            if (entityId && entityType) {
                req = {
                    "params": {
                        "query": {
                            "id": entityId,
                            "filters": {
                                "typesCriterion": [
                                    entityType
                                ]
                            }
                        },
                        "fields": {
                            "attributes": ["_ALL"]
                        }
                    }
                };
            }

            return req;
        };

        DataRequestHelper.createAttributesCriteria = function (searchText, titlePattern, subTitlePattern) {
            var attributesCriterion = [];

            if (!_.isEmpty(searchText)) {
                var attributes = [];

                if (typeof (titlePattern) !== 'undefined' && titlePattern !== "") {
                    if (!attributes.includes(this.titlePattern)) {
                        var titleFields = DataHelper.getAttributesBetweenCurlies(titlePattern);
                        if (_.isEmpty(titleFields)) {
                            attributes.push(titlePattern);
                        }
                        else if (titleFields && titleFields instanceof Array) {
                            attributes.push(...titleFields);
                        }
                    }
                }

                if (typeof (subTitlePattern) !== 'undefined' && subTitlePattern !== "") {
                    if (!attributes.includes(subTitlePattern)) {
                        var subTitleFields = DataHelper.getAttributesBetweenCurlies(subTitlePattern);
                        if (subTitleFields && subTitleFields instanceof Array) {
                            attributes.push(...subTitleFields);
                        }
                    }
                }

                if (attributes && attributes.length) {
                    attributes.forEach(function (item) {
                        var searchKey = new Object();
                        var searchValue = new Object();
                        searchValue.eq = '*' + searchText + '*';
                        searchKey[item] = searchValue;
                        attributesCriterion.push(searchKey);
                    }, this);
                }

            }
            return attributesCriterion;
        };

    })();
</script>