<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="context-helper.html">
<link rel="import" href="component-helper.html">

<link rel="import" href="../bedrock-enums-util/bedrock-enums-util.html">

<script>
    DataRequestHelper = {};

    (function () {

        DataRequestHelper.createEntityModelCompositeGetRequest = function (contextData) {
            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valContexts = ContextHelper.getValueContexts(contextData);
            var itemContexts = ContextHelper.getItemContexts(contextData);

            var locale = valContexts && valContexts.length > 0 && valContexts[0].locale ? valContexts[0].locale : 'en-US';
            var typeName = itemContexts && itemContexts.length > 0 && itemContexts[0].type ? itemContexts[0].type : undefined;
            var attributeNames = itemContexts && itemContexts.length > 0 && itemContexts[0].attributeNames ? itemContexts[0].attributeNames : undefined;
            var relationships = itemContexts && itemContexts.length > 0 && itemContexts[0].relationships ? itemContexts[0].relationships : undefined;
            var relationshipAttributes = itemContexts && itemContexts.length > 0 && itemContexts[0].relationshipAttributes ? itemContexts[0].relationshipAttributes : undefined;

            if (!typeName) {
                return undefined;
            };

            var req = {
                "params": {
                    "query": {
                        "contexts": dataContexts,
                        "locale": locale,
                        "name": typeName
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames,
                        "relationships": relationships,
                        "relationshipAttributes": relationshipAttributes
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createEntityGetRequest = function (contextData) {
            var itemContexts = ContextHelper.getItemContexts(contextData);

            if (!(itemContexts && itemContexts.length > 0)) {
                return undefined;
            };

            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valueContexts = ContextHelper.getValueContexts(contextData);

            var filteredIds = [];
            
            // Temp Commented
            // var ids = itemContexts.map(function(itemContext){return itemContext.id});
            // ids = ids.filter(id => typeof (id) !== "undefined" && typeof (id) !== "null");

            var ids = [];
            for(var i = 0; i < itemContexts.length; i++) {
                if(itemContexts[i].id instanceof Array) {
                    var itemContextIds = itemContexts[i].id;
                    for(var j = 0; j < itemContextIds.length; j++) {
                        ids.push(itemContextIds[j]);
                    }
                } else {
                    // Empty Check ??
                    var itemContextId = itemContexts[i].id;
                    ids.push(itemContextId);
                }
            }

            ids = ids.filter(Boolean);

            // May Need Fix...  Array inside Array[[]]
            // Ask Vishal
            var types = itemContexts.map(function (itemContext) { return itemContext.type });

            var firstItemContext = ContextHelper.getFirstItemContext(contextData);
            var attributeNames = firstItemContext.attributeNames;
            var relationships = firstItemContext.relationships;
            var relationshipAttributes = firstItemContext.relationshipAttributes;

            var req = {
                "params": {
                    "query": {
                        "contexts": dataContexts,
                        "valueContexts": valueContexts,
                        "filters": {
                            "typesCriterion": types
                        }
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames,
                        "relationships": relationships,
                        "relationshipAttributes": relationshipAttributes
                    },
                    "options": {
                        "totalRecords": 1,
                        "includeRequest": false
                    }
                }
            };

            if (!_.isNull(ids) && !_.isEmpty(ids) && ids) {
                req.params.query.ids = ids;
            }

            return req;
        };

        DataRequestHelper.createWorkflowMappingGetRequest = function (contextData) {
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var typeName = "workflowDefinitionMapping";
            var entityType = firstItemContext.type;

            var relationships = ["hasWorkflowsDefined"];

            var req = {
                "params": {
                    "query": {
                        "name": entityType,
                        "filters": {
                            "typesCriterion": [typeName]
                        }
                    },
                    "fields": {
                        "properties": [
                            "_ALL"
                        ],
                        "relationships": relationships
                    }
                }
            };

            if (firstDataContext) {
                req.params.query.contexts = [firstDataContext];
            }

            //console.log('workflow def mapping req get ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createWorkflowDefinitionGetRequest = function (contextData) {
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var typeName = "workflowDefinition";
            var workflowNames = firstItemContext.workflowNames;
            var attributeNames = firstItemContext.atttributeNames ? firstItemContext.attributeNames : ["workflows"];

            var workflowDefinitionIds = [];
            for (var i = 0; i < workflowNames.length; i++) {
                var workflowName = workflowNames[i];
                workflowDefinitionIds.push(workflowName + "_" + typeName);
            }

            var req = {
                "params": {
                    "query": {
                        "ids": workflowDefinitionIds,
                        "filters": {
                            "typesCriterion": [typeName]
                        }
                    },
                    "fields": {
                        "properties": [
                            "_ALL"
                        ],
                        "attributes": attributeNames
                    }
                }
            };

            if (firstDataContext) {
                req.params.query.contexts = [firstDataContext];
            }

            //console.log('workflow def req get ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createWorkflowRuntimeInstanceGetRequest = function (contextData) {
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var entityId = firstItemContext.id;
            var entityType = firstItemContext.type;
            var workflowNames = firstItemContext.workflowNames;
            var attributeNames = firstItemContext.atttributeNames ? firstItemContext.attributeNames : ["workflowInstanceId", "status", "startDateTime", "endDateTime", "activities"];

            var workflowContexts = [];

            for (var i = 0; i < workflowNames.length; i++) {
                var workflowName = workflowNames[i];
                var workflowContext = undefined;

                if (firstDataContext) {
                    workflowContext = DataHelper.cloneObject(firstDataContext);
                    workflowContext.workflow = workflowName;
                    workflowContext.self = "self/" + entityId;
                } else {
                    workflowContext = { "workflow": workflowName, "self": "self/" + entityId };
                }

                workflowContexts.push(workflowContext);
            }

            var req = {
                "params": {
                    "query": {
                        "contexts": workflowContexts,
                        "id": entityId,
                        "filters": {
                            "typesCriterion": [entityType]
                        }
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames
                    }
                }
            };

            //console.log('workflow runtime instance get req ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createWorkflowTransitionRequest = function (contextData) {

            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);
            var operations = SharedEnumsUtil.Enums.operations;
            var entityId = firstItemContext.id;
            var entityType = firstItemContext.type;
            var transitionTo = firstItemContext.transitionTo;
            var currentActiveApp = ComponentHelper.getCurrentActiveApp();
            var appInstanceId = "";
            if (currentActiveApp) {
                appInstanceId = currentActiveApp.id;
            }

            var req = {
                "params": {
                    "workflow": {
                        "workflowName": transitionTo.workflowName,
                        "activity": {
                            "activityName": transitionTo.activityName,
                            "action": transitionTo.action,
                            "comment": transitionTo.comments
                        }
                    }
                },
                "clientState": {
                    "notificationInfo": {
                        "operation": operations.WorkflowTransition,
                        "context": {
                            "appInstanceId": appInstanceId,
                            "workflowName": transitionTo.workflowName,
                            "workflowActivityName": transitionTo.activityName,
                            "workflowAction": transitionTo.action
                        }
                    }
                },
                "entity": {
                    "id": entityId,
                    "name": entityId,
                    "type": entityType,
                    "data": {
                    }
                }
            };

            if (firstDataContext) {
                req.entity.data.contexts = [firstDataContext];
            }

            //console.log('workflow transition req ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createInvokeWorkflowRequest = function (contextData) {
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);

            var entityId = firstItemContext.id;
            var entityType = firstItemContext.type;
            var invokeWorkflowData = firstItemContext.invokeWorkflowData;

            var req = {
                "params": {
                    "workflow": {
                        "workflowName": invokeWorkflowData.workflowName
                    }
                },
                "entity": {
                    "id": entityId,
                    "name": entityId,
                    "type": entityType,
                    "data": {
                    }
                }
            };

            if (firstDataContext) {
                req.entity.data.contexts = [firstDataContext];
            }

            //console.log('workflow invoke req ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper.createConfigGetRequest = function (appName, context, componentName) {
            if (componentName) {
                context.component = componentName;
            }

            if (_.isEmpty(context.component)) {
                context.component = "_ALL";
            }

            var name = this._createConfigName(context);

            var req = {
                "params": {
                    "query": {
                        "name": name,
                        "contexts": [
                            context
                        ],
                        "filters": {
                            "typesCriterion": ["uiConfig"]
                        }
                    },
                    "fields": {
                        "jsonData": true
                    }
                }
            };

            //console.log('config get request ', JSON.stringify(req, null, 2));
            return req;
        };

        DataRequestHelper._createConfigName = function (context) {
            var name = undefined;
            for (var field in context) {
                var value = context[field];
                if (value != "_ALL") {
                    if (name) {
                        name = name + "_" + context[field];
                    } else {
                        name = context[field];
                    }
                }
            }

            return name;
        };
    })();

</script>