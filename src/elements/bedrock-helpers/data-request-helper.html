<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="context-helper.html">

<script>
    DataRequestHelper = {};

    (function () {

        DataRequestHelper.createEntityModelCompositeGetRequest = function (contextData) {
            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valContexts = ContextHelper.getValueContexts(contextData);
            var itemContexts = ContextHelper.getItemContexts(contextData);

            var locale = valContexts && valContexts.length > 0 && valContexts[0].locale ? valContexts[0].locale : 'en-US';
            var typeName = itemContexts && itemContexts.length > 0 && itemContexts[0].type ? itemContexts[0].type : undefined;
            var attributeNames = itemContexts && itemContexts.length > 0 && itemContexts[0].attributeNames ? itemContexts[0].attributeNames : undefined;

            if (!typeName) {
                return undefined;
            };

            var req = {
                "params": {
                    "query": {
                        "contexts": dataContexts,
                        "locale": locale,
                        "name": typeName
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames
                    }
                }
            };

            return req;
        };

        DataRequestHelper.createEntityGetRequest = function (contextData) {
            var itemContexts = ContextHelper.getItemContexts(contextData);

            if (!(itemContexts && itemContexts.length > 0)) {
                return undefined;
            };

            var dataContexts = ContextHelper.getDataContexts(contextData);
            var valueContexts = ContextHelper.getValueContexts(contextData);
            
            var ids = [...new Set( itemContexts.map((obj) => obj.id)) ];
            var types = [...new Set( itemContexts.map((obj) => obj.type)) ];
            
            var firstItemContext = ContextHelper.getFirstItemContext(contextData);
            var attributeNames = firstItemContext.attributeNames;
            
            var req = {
                "params": {
                    "query": {
                        "contexts": dataContexts,
                        "valueContexts": valueContexts,
                        "ids": ids,
                        "filters": {
                            "typesCriterion": types
                        }
                    },
                    "fields": {
                        "ctxTypes": [
                            "properties"
                        ],
                        "attributes": attributeNames
                    },
                    "options": {
                        "totalRecords": 1,
                        "includeRequest": false
                    }
                }
            };

            return req;
        };

    })();

</script>