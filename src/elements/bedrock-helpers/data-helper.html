<!--
`bedrock-helpers` Represents a bunch of helpers that any bedrock, pebble, rock or app can use. 
-->
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="../bedrock-externalref-underscore/bedrock-externalref-underscore.html">

<!--<script type="text/javascript" src="data-helper.js" />-->
<script>
    DataHelper = {};

    (function () {
        DataHelper.cloneObject = function (o) {
            return JSON.parse(JSON.stringify(o));
        };

        DataHelper.areEqualArrays = function (array1, array2) {
            var arrayUtil1 = DataHelper.cloneObject(array1);
            var arrayUtil2 = DataHelper.cloneObject(array2);
            var arrayUtil3 = DataHelper.cloneObject(array2);
            if (arrayUtil1.length != arrayUtil2.length) {
                return false;
            } else {
                for (var i = 0; i < arrayUtil1.length; i++) {
                    var obj1 = arrayUtil1[i];
                    for(var j=0; j<arrayUtil2.length; j++) {
                        var obj2 = arrayUtil2[j];
                        if(DataHelper.compareObjects(obj1, obj2)) {
                            arrayUtil3.splice(arrayUtil3.indexOf(obj2), 1);
                            break;
                        }
                    }
                    continue;
                }
                if (arrayUtil3.length == 0) {
                    return true;
                } else {
                    return false;
                }
            }
        };
        DataHelper.toStr = function (obj) {
            if (obj && obj.toString) {
                return obj.toString();
            } else {
                return JSON.stringify(obj);
            }
        };
        DataHelper.findEntityById = function (entitiesExternalFormat, entityId) {
            if (entitiesExternalFormat && entitiesExternalFormat.length) {
                for (var i = 0; i < entitiesExternalFormat.length; i++) {
                    var entity = entitiesExternalFormat[i];
                    if (entityId == entity.id) {
                        return entity;
                    }
                }
            }
            return {};
        };

        DataHelper.compareObjects = function (firstObject, secondObject) {
            if(_.isEmpty(firstObject) && _.isEmpty(secondObject)){
                return true;
            } else if(_.isEmpty(firstObject) || _.isEmpty(secondObject)){
                return false;
            }
            // Create arrays of property names
            var firstObjectProps = Object.getOwnPropertyNames(firstObject);
            var secondObjectProps = Object.getOwnPropertyNames(secondObject);

            // If number of properties is different,
            // objects are not equivalent
            if (firstObjectProps.length != secondObjectProps.length) {
                return false;
            }

            for (var i = 0; i < firstObjectProps.length; i++) {
                var propName = firstObjectProps[i];

                // If values of same property are not equal,
                // objects are not equivalent
                if(typeof firstObject[propName] === typeof secondObject[propName]) {
                    if(typeof firstObject[propName] === "object") {
                        if(!DataHelper.compareObjects(firstObject[propName], secondObject[propName])) {
                            return false;
                        }
                    } else if(typeof firstObject[propName] === "array") {
                        if(!DataHelper.areEqualArrays(firstObject[propName], secondObject[propName])) {
                            return false;
                        }
                    } else if (firstObject[propName] !== secondObject[propName]) {
                        return false;
                    }
                } else {
                    return false;
                }
            }

            // If we made it this far, objects
            // are considered equivalent
            return true;
        };

        DataHelper.containsObject = function (obj, list) {
            var res = _.find(list, function (val) {
                return _.isEqual(obj, val)
            });

            return (_.isObject(res)) ? true : false;
        };

        DataHelper.isValidObjectPath = function (base, path) {
            var current = base;
            var components = path.split(".");
            for (var i = 0; i < components.length; i++) {
                if ((typeof current !== "object") || (!current.hasOwnProperty(components[i]))) {
                    return false;
                }
                current = current[components[i]];
            }
            return true;
        };

        DataHelper.getParamValue = function (param) {
            var mainApp = document.querySelector('main-app');
            if (mainApp && mainApp.pageRoute && mainApp.pageRoute.__queryParams && param in mainApp.pageRoute
                .__queryParams) {
                var paramValue = mainApp.pageRoute.__queryParams[param];
                if (paramValue) {
                    return decodeURIComponent(paramValue);
                }
            }
        };

        DataHelper._isEqual = function (stooge, clone) {
            return _.isEqual(stooge, clone);
        };

        DataHelper._findItemByKeyValue = function (array, key, value) {
            var elementToReturn = _.filter(array, function (currentElement) {
                if (currentElement[key] === value) {
                    return currentElement;
                }
            });

            return elementToReturn[0];
        };

        DataHelper.getValue = function (obj, key) {
            var outputObj = {};
            for (var i in obj) {
                if (!obj.hasOwnProperty(i)) continue;
                if (i == key) {
                    return obj[i];
                } else if (typeof obj[i] == 'object') {
                    outputObj = DataHelper.getValue(obj[i], key);
                }
            }
            return outputObj;
        };

        DataHelper.validateGetEntitiesResponse = function (entitiesResponse) {
            if (entitiesResponse && entitiesResponse.content && entitiesResponse.content.entities &&
                !_.isEmpty(entitiesResponse.content.entities)) {

                return true;
            }
            return false;
        };

        DataHelper.validateGetModelsResponse = function (modelsResponse) {
            if (modelsResponse && modelsResponse.content &&
                modelsResponse.content.entityModels && modelsResponse.content.entityModels
                    .length >
                0) {

                return true;
            }
            return false;
        };

        DataHelper.validateGetAttributeModelsResponse_New = function (attributeModelsResponsee) {
            if (attributeModelsResponsee && attributeModelsResponsee.content &&
                attributeModelsResponsee.content.entityModels && attributeModelsResponsee.content.entityModels.length >
                0 && !_.isEmpty(attributeModelsResponsee.content.entityModels[0])) {
                return true;
            }
            return false;
        };

        DataHelper.oneTimeEvent = function (element, type, callback) {
            element.addEventListener(type, function (e) {
                e.target.removeEventListener(e.type, arguments.callee);
                return callback(e);
            });
        };

        DataHelper.getTenantId = function () {
            var tenantId = 'jcpenney';
            var mainApp = document.querySelector("main-app");
            if (mainApp && mainApp.tenantId) {
                tenantId = mainApp.tenantId;
            }

            return tenantId;
        };

        DataHelper.getUserId = function () {
            var userId = 'admin';
            var mainApp = document.querySelector("main-app");
            if (mainApp && mainApp.userId) {
                userId = mainApp.userId;
            }

            return userId;
        };

        DataHelper.getUserName = function () {
            var userName = 'admin';
            var userId = DataHelper.getUserId();
            if (userId) {
                userName = userId.replace(/_user$/, "");
            }
            return userName;
        };

        DataHelper.getUserRole = function () {
            var userRole;
            var mainApp = document.querySelector("main-app");
            if (mainApp && mainApp.roleId) {
                userRole = mainApp.roleId;
            }

            return userRole;
        };

        DataHelper.arrayRemove = function (arr, val) {
            var index = -1;
            index = arr.indexOf(val);
            while (index >= 0) {
                arr.splice(index, 1);
                index = arr.indexOf(val);
            }
        };

        DataHelper.getRelToNames = function (relationships) {
            if (relationships && relationships.length > 0) {
                var relToNames = [];
                for (var i = 0; i < relationships.length; i++) {
                    if (relationships[i].relTo) {
                        var relToName = relationships[i].relTo.id.replace("_" + relationships[i].relTo.type, "");
                        relToNames.push(relToName);
                    }
                }
                return relToNames;
            }
        };

        DataHelper.getRandomString = function () {
            var x = 2147483648;
            return Math.floor(Math.random() * x).toString(36) +
                Math.abs(Math.floor(Math.random() * x) ^ new Date().getTime()).toString(36);
        };

        DataHelper.sort = function (arrayOfObjects, sortByProperty, dataType, sortType) {
            var sortedData = arrayOfObjects;
            if (arrayOfObjects && sortByProperty) {
                if (dataType == "date" || dataType == "datetime") {
                    sortedData = arrayOfObjects.sort(function (item1, item2) {
                        item1[sortByProperty] = item1[sortByProperty] != undefined ? item1[sortByProperty] : "";
                        item2[sortByProperty] = item2[sortByProperty] != undefined ? item2[sortByProperty] : "";
                        if (sortType == "desc") {
                            return new Date(item1[sortByProperty]) < new Date(item2[sortByProperty]);
                        } else {
                            return new Date(item1[sortByProperty]) > new Date(item2[sortByProperty]);
                        }
                    });
                } else if (dataType == "integer" || dataType == "decimal") {
                    sortedData = arrayOfObjects.sort(function (item1, item2) {
                        item1[sortByProperty] = item1[sortByProperty] != undefined ? item1[sortByProperty] : "";
                        item2[sortByProperty] = item2[sortByProperty] != undefined ? item2[sortByProperty] : "";
                        if (item1[sortByProperty] != undefined && item2[sortByProperty] != undefined) {
                            if (sortType == "desc") {
                                return item1[sortByProperty] < item2[sortByProperty];
                            } else {
                                return item1[sortByProperty] > item2[sortByProperty];
                            }
                        }
                    });
                } else {
                    sortedData = arrayOfObjects.sort(function (item1, item2) {
                        item1[sortByProperty] = item1[sortByProperty] != undefined ? item1[sortByProperty] : "";
                        item2[sortByProperty] = item2[sortByProperty] != undefined ? item2[sortByProperty] : "";
                        if (sortType == "desc") {
                            return item1[sortByProperty].toString().toLowerCase() < item2[sortByProperty].toString().toLowerCase();
                        } else {
                            return item1[sortByProperty].toString().toLowerCase() > item2[sortByProperty].toString().toLowerCase();
                        }
                    });
                }
            }

            return sortedData;
        };

        DataHelper.readAttributeFromPath = function (word) {
            if (DataHelper.isEmptyObject(word)) {
                return word;
            }

            if (word.indexOf("entity.name") >= 0 || word.indexOf("entity.id") >= 0) {
                return word.replace("entity.", "");
            } else {
                return word.replace("entity.attributes.", "");
            }
        }

        DataHelper.getWordsBetweenCurlies = function (str) {
            var results = [],
                re = /{([^}]+)}/g,
                text;

            while (text = re.exec(str)) {
                results.push(text[1]);
            }
            return results;
        }

        DataHelper.getAttributesBetweenCurlies = function (fieldPattern) {
            var attributeNames = [];

            var attributesWithPattern = DataHelper.getWordsBetweenCurlies(fieldPattern);
            if (!DataHelper.isEmptyObject(attributesWithPattern) && attributesWithPattern instanceof Array) {
                for (var j = 0; j < attributesWithPattern.length; j++) {
                    var attributeWithPattern = attributesWithPattern[j];
                    attributeNames.push(DataHelper.readAttributeFromPath(attributeWithPattern));
                }
            }

            return attributeNames;
        }

        DataHelper.isEmptyObject = function (obj) {
            return _.isEmpty(obj);
        }

        DataHelper.validateAndGetResponseContent = function (responsePkg) {
            // If response package has an issue it should return false
            if (typeof (responsePkg) !== "undefined" && responsePkg.status == "success") {
                return responsePkg.content;
            } else {
                return false;
            }
        }

        DataHelper.validateAndFillProfile = function (config) {
            if (config) {
                if (config.data) {
                    if (config.data.contexts && config.data.contexts.length > 0) {
                        if (config.data.contexts[0].jsonData) {
                            if (config.data.contexts[0].jsonData.transform) {
                                if (config.data.contexts[0].jsonData.transform.fieldOverrides) {
                                    return config;
                                } else {
                                    config.data.contexts[0].jsonData.transform.fieldOverrides = [];
                                    return config;
                                }
                            } else {
                                config.data.contexts[0].jsonData.transform = {
                                    "fieldOverrides": []
                                };
                                return config;
                            }
                        } else {
                            config.data.contexts[0].jsonData = {
                                "transform": {
                                    "fieldOverrides": []
                                }
                            };
                            return config;
                        }
                    } else {
                        config.data.contexts = [{
                            "jsonData": {
                                "transform": {
                                    "fieldOverrides": []
                                }
                            }
                        }];
                        return config;
                    }
                } else {
                    config.data = {
                        "contexts": [{
                            "jsonData": {
                                "transform": {
                                    "fieldOverrides": []
                                }
                            }
                        }]
                    };
                    return config;
                }
            } else {
                config = {
                    "data": {
                        "contexts": [{
                            "jsonData": {
                                "transform": {
                                    "fieldOverrides": []
                                }
                            }
                        }]
                    }
                };
                return config;
            }
        };

        DataHelper.validateAndGetConfigObjects = function (response) {
            if (response && response.status && response.status.toLowerCase() == "success" && response.content &&
                response.content.configObjects) {
                return response.content.configObjects;
            }
        };

        DataHelper.validateAndGetMessage = function (response) {
            var message = "";
            //from transform, fieldMap API response.response, from process API response.dataObjectOperationResponse
            if ((response && response.response && response.response.status && response.response.status.toLowerCase() ==
                "success") || (response && response.dataObjectOperationResponse && response.dataObjectOperationResponse
                    .status && response.dataObjectOperationResponse.status.toLowerCase() == "success")) {
                message = "";
            }
            //if the response is from transform or fieldMap API
            else if (response && response.response && response.response.statusDetail && response.response.statusDetail
                .message) {
                message = response.response.statusDetail.message;
            }
            //if the response is from process API
            else if (response && response.dataObjectOperationResponse && response.dataObjectOperationResponse.statusDetail &&
                response.dataObjectOperationResponse.statusDetail.message) {
                message = response.dataObjectOperationResponse.statusDetail.message;
            }
            //if there is no status/statusDetail at all in response
            else {
                message = "COP service is down";
            }
            return message;
        };

        DataHelper.generateUUID = function () {
            var d = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = (d + Math.random() * 16) % 16 | 0;
                d = Math.floor(d / 16);
                return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            return uuid;
        };


        // JSFiddle: http://jsfiddle.net/9Q23E/527/
        DataHelper.isTextSelected = function (input) {
            var text = this.getSelectedText(input);
            if (text && text.trim().length > 0) {
                return true;
            } else {
                return false
            }
        }

        DataHelper.getSelectedText = function (textBox) {
            var selectedText = "";

            // all browsers (including IE9 and up), except IE before version 9 
            if (textBox && (textBox.tagName.toLowerCase() == "textarea" || (textBox.tagName.toLowerCase() ==
                "input" && textBox.type.toLowerCase() == "text"))) {
                var startIndex = textBox.selectionStart;
                var endIndex = textBox.selectionEnd;

                if (endIndex - startIndex > 0) {
                    selectedText = textBox.value.substring(textBox.selectionStart, textBox.selectionEnd);
                }
            }

            return selectedText;
        }

        DataHelper.replaceAt = function (currentString, index, stringToReplace) {
            return currentString.substr(0, index) + stringToReplace + currentString.substr(index +
                stringToReplace.length);
        }

        DataHelper.getKeywordCriteria = function (searchText) {
            if (searchText) {
                var keywordsCriterion = {};
                var splitQueryByAnd = searchText.toLowerCase().split(' and ');
                var splitQueryByOr = searchText.toLowerCase().split(' or ');

                if (splitQueryByAnd.length > 1 || (splitQueryByAnd.length == 1 && splitQueryByOr.length == 1)) {
                    keywordsCriterion.operator = "_AND";
                    keywordsCriterion.keywords = splitQueryByAnd.join(' ');
                } else {
                    keywordsCriterion.operator = "_OR"
                    keywordsCriterion.keywords = splitQueryByOr.join(' ');
                }

                return keywordsCriterion;
            }
         }
    })();

</script>