<!--
`bedrock-helpers` Represents a bunch of helpers that any bedrock, pebble, rock or app can use. 
-->
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<!--<script type="text/javascript" src="data-helper.js" />-->
<script>
    DataHelper = {};

    (function () {
        DataHelper.cloneObject = function (o) {
            return JSON.parse(JSON.stringify(o));
        };

        DataHelper.transformAttributeFromUIFormat = function (attributesJSON) {
            var attributes = {};
            for (var i = 0; i < attributesJSON.length; i++) {
                var attributeJSON = attributesJSON[i];
                var attributeValues = [];
                //TODO: Review what to do with governance data  
                delete attributeJSON.errors;
                attributeValues.push(attributeJSON);
                attributes[attributeJSON.name] = {
                    "values": attributeValues
                };
            }
            return attributes;
        }

        DataHelper.transformAttributeToUIFormat = function (attributes, attributeModels, locale, time, source) {
            var attributesData = [];
            for (var attributeGroupName in attributeModels) {
                var attributeGroupJSON = {
                    "name": attributeGroupName,
                    "longName": attributeModels[attributeGroupName].longName,
                    attributes: []
                };
                for (var attributeModelName in attributeModels[attributeGroupName]) {
                    var attributeJSON = {};
                    var attributeModel = attributeModels[attributeGroupName][attributeModelName];
                    if (attributeModel.name) {
                        var attribute = attributes[attributeModel.name];
                        if (attribute && attribute.values) {
                            attributeJSON = this._getCurrentValue(attribute.values, locale, time, source);
                        }
                        if (attributeJSON == undefined) {
                            attributeJSON = this._getEmptyValue(locale, time, source);
                        }
                        attributeJSON.name = attributeModel.name;
                        attributeGroupJSON.attributes.push(attributeJSON);
                    }
                }
                attributesData.push(attributeGroupJSON);
            }
            //console.log(attributesData);
            return attributesData;
        };

        DataHelper.transformAttributesToGridFormat = function (attributes, attributeModels, locale, time, source) {
            var attributesData = {};
            for (var attributeGroupName in attributeModels) {
                var attributeValueData = {};
                for (var attributeModelName in attributeModels[attributeGroupName]) {
                    var attributeModel = attributeModels[attributeGroupName][attributeModelName];
                    if (attributeModel.name) {
                        var attributeJSON;
                        var attribute = attributes[attributeModel.name];
                        if (attribute && attribute.values) {
                            attributeJSON = this._getCurrentValue(attribute.values, locale, time, source);
                        } else {
                            attributeJSON = this._getEmptyValue(locale, time, source);
                        }

                        attributeValueData[attributeModel.name] = attributeJSON;
                    }
                    attributesData[attributeGroupName] = attributeValueData;
                }
            }

            return attributesData;
        };

        DataHelper.transformEntitySchemaForGrid = function (entities, attributeModels, locale, time, source) {
            if (entities && entities.length) {
                for (var i = 0; i < entities.length; i++) {
                    if (typeof (entities[i]) == "object") {
                        var contextKey = Object.keys(entities[i].data.ctxInfo)[0];
                        entities[i].attributes = this.transformAttributesToGridFormat(entities[i].data.ctxInfo[
                                contextKey].attributes,
                            attributeModels, locale, time, source);
                    }
                }
            }
        };

        DataHelper.compareObjects = function (firstObject, secondObject) {
            // Create arrays of property names
            var firstObjectProps = Object.getOwnPropertyNames(firstObject);
            var secondObjectProps = Object.getOwnPropertyNames(secondObject);

            // If number of properties is different,
            // objects are not equivalent
            if (firstObjectProps.length != secondObjectProps.length) {
                return false;
            }

            for (var i = 0; i < firstObjectProps.length; i++) {
                var propName = firstObjectProps[i];

                // If values of same property are not equal,
                // objects are not equivalent
                if (firstObject[propName] !== secondObject[propName]) {
                    return false;
                }
            }

            // If we made it this far, objects
            // are considered equivalent
            return true;
        }

        DataHelper.isEmptyObject = function (obj) {
            for (var prop in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, prop)) {
                    return false;
                }
            }

            return true;
        }

        DataHelper._getCurrentValue = function (values, locale, time, source) {
            var value;
            if (values) {
                for (var i = 0; i < values.length; i++) {
                    var currentValue = values[i];
                    //TODO: locale and source case is not matching for what is there in dimension selector and what is coming in data,
                    // need to find a better answer
                    if (locale && currentValue.locale && currentValue.locale.toLowerCase() != locale.toLowerCase()) {
                        continue;
                    }
                    if (source && currentValue.source && currentValue.source.toLowerCase() != source.toLowerCase()) {
                        continue;
                    }
                    //TODO: compare for time?
                    value = this.cloneObject(currentValue);
                    break;
                }
            }
            return value;
        };

        DataHelper._getEmptyValue = function (locale, time, source) {
            return {
                "value": "",
                "locale": locale,
                "time": time,
                "source": source
            };
        };

    })();
</script>