<!--
`bedrock-helpers` Represents a bunch of helpers that any bedrock, pebble, rock or app can use. 
-->
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<!--<script type="text/javascript" src="data-helper.js" />-->

<script>
    DataHelper = {};

    (function(){
        DataHelper.cloneObject = function(o) {
            return JSON.parse(JSON.stringify(o));
        };

        DataHelper.transformAttributeToUIFormat = function(attributes, attributeModels, locale, time, source) {
            var attributesData = [];
            for(var attributeGroupName in attributeModels) {
                var attributeGroupJSON = {"name": attributeGroupName, "longName": attributeModels[attributeGroupName].longName, attributes: []};
                for(var attributeModelName in attributeModels[attributeGroupName]) {
                    var attributeJSON = {};
                    var attributeModel = attributeModels[attributeGroupName][attributeModelName];
                    if(attributeModel.name) {
                        var attribute = attributes[attributeModel.name];
                        if(attribute && attribute.values) {
                            attributeJSON = this._getCurrentValue(attribute.values, locale, time, source);
                        }
                        if(attributeJSON == undefined) {
                            attributeJSON = this._getEmptyValue(locale, time, source);
                        }
                        attributeJSON.name = attributeModel.name;
                        attributeGroupJSON.attributes.push(attributeJSON);
                    }   
                }
                attributesData.push(attributeGroupJSON);
            }
            //console.log(attributesData);
            return attributesData;
        };
        
        DataHelper.transformAttributesToGridFormat = function(attributes, attributeModels, locale, time, source) {
            var attributesData = {};
            for(var attributeGroupName in attributeModels) {
                var attributeValueData = {};
                for(var attributeModelName in attributeModels[attributeGroupName]) {
                    var attributeModel = attributeModels[attributeGroupName][attributeModelName];
                    if(attributeModel.name) {
                        var attributeJSON;
                        var attribute = attributes[attributeModel.name];
                        if(attribute && attribute.values) {
                            attributeJSON = this._getCurrentValue(attribute.values, locale, time, source);
                        }
                        else {
                            attributeJSON = this._getEmptyValue(locale, time, source);
                        }
                        
                        attributeValueData[attributeModel.name] = attributeJSON;
                    }
                    attributesData[attributeGroupName] = attributeValueData;  
                }
            }
            
            return attributesData;
        };

        DataHelper.transformEntitySchemaForGrid = function(entities, attributeModels, locale, time, source){
            if(entities && entities.length) {
                for(var i=0; i < entities.length; i++) {
                    if(typeof(entities[i]) == "object") {
                        var contextKey = Object.keys(entities[i].data.ctxInfo)[0];
                        entities[i].attributes = this.transformAttributesToGridFormat(entities[i].data.ctxInfo[contextKey].attributes,
                        attributeModels, locale, time, source);
                    }
                }
            }
            
        };

        DataHelper._getCurrentValue = function(values, locale, time, source) {
            var value;
            if(values) {
                for(var i=0;i<values.length;i++) {
                    var currentValue = values[i];
                    if(locale && currentValue.locale && currentValue.locale != locale) {
                        continue;
                    }
                    if(source && currentValue.source && currentValue.source != source) {
                        continue;
                    }
                    value = this.cloneObject(currentValue);
                    break;
                }
            }
            return value;
        };
        DataHelper._getEmptyValue = function(locale, time, source) {
            return {
                "value": "",
                "locale": locale,
                "time": time,
                "source": source
            };
        };
    })();
</script>

