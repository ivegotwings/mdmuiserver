<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">-->

<script>
    MessageHelper = {};

    (function() {
        MessageHelper.getAttributeMessages= function(attributes, attributeModels, messageCodeMapping, localeHelper) {
            var attrMessages = {};
            for (var attributeName in attributes) {
                if(attributeModels[attributeName]) {
                    var messageCodes = MessageHelper.getMessageCodes(attributes[attributeName]);
                    var messages = MessageHelper.getMessagesFromCodes(messageCodes, messageCodeMapping, localeHelper, attributeModels);
                    if (messages && messages.length) {
                        attrMessages[attributeName] = messages;
                    }
                }
            }
            return attrMessages; 
        };
        
        MessageHelper.getRelationshipMessages= function(relationship, messageCodeMapping, localeHelper) {
            var messageCodes = MessageHelper.getMessageCodes(relationship[0]);
            var messages = MessageHelper.getMessagesFromCodes(messageCodes, messageCodeMapping, localeHelper);
            return messages;
        };

        MessageHelper.getMessageCodes = function (attribute) {
            var messageCodes = [];
            var properties = attribute.properties;
            var valueProperties = attribute.values && attribute.values.length > 0 && attribute.values[0].properties ? attribute.values[0].properties : undefined;
            var messages = [];
            if(properties && properties.messages && properties.messages.length > 0) {
                messages = messages.concat(properties.messages);
            }
            if(valueProperties && valueProperties.messages && valueProperties.messages.length > 0) {
                messages = messages.concat(valueProperties.messages);
            }
            if(messages && messages.length > 0) {
                for (var i=0; i< messages.length; i++) {
                    messageCodes.push({ "code": messages[i].messageCode, "params": messages[i].messageParams });
                }
            }

            return messageCodes;
        };

        MessageHelper.getMessagesFromCodes= function (messageCodes, messageCodeMapping, localeHelper, attributeModels) {
            var messages=[];
            if(messageCodes && messageCodes.length > 0) {
                for(var i=0; i<messageCodes.length; i++){
                    var messageCode = messageCodes[i];
                    if(messageCode.code != 'SYS001') {
                        var mes;

                        //Pick message from locale
                        if(localeHelper) {
                            if(messageCode.params) {
                                var params = messageCode.params;
                                var localeParams = [messageCode.code];
                                for(var i = 0; i < params.length; i++) {
                                    localeParams.push(i);
                                    //If attributename, then show external name
                                    if(attributeModels) {
                                        if(attributeModels[params[i]]) {
                                            localeParams.push(attributeModels[params[i]].externalName);
                                            continue;
                                        }
                                    }

                                    localeParams.push(params[i]);
                                }

                                mes = localeHelper.apply(this, localeParams);
                            } else {
                                mes = localeHelper(messageCode.code);
                            }                            
                        }

                        //If message not picked from locale, then pick from config mappings
                        if(!mes && messageCodeMapping) {
                            mes = messageCodeMapping[messageCode.code];
                        }
                        
                        if(mes){
                            messages.push(mes);
                        } else{
                            messages.push("Error with Code: " + messageCode.code);
                        }
                    }
                }
            }
            return messages;
        };

        MessageHelper.getErrorsFromAttrMessages= function(attrMessages, attributeModels) {
            var messageObjects = [];
            for(var attributeName in attrMessages) {
                var externalName = attributeModels[attributeName].externalName;
                var currentAttributeMessages = attrMessages[attributeName];
                if(currentAttributeMessages && currentAttributeMessages.length > 0) {
                    var firstErrorMessage = currentAttributeMessages[0];//TODO: what if there are more messages for an attribute
                    var messageObject = {
                        "attributeName": attributeName,
                        "attributeExternalName": externalName,
                        "message": firstErrorMessage
                    };
                    messageObjects.push(messageObject);
                }
            }
            return messageObjects;
        };

        MessageHelper.getErrorsFromRelMessages= function(relMessages, messageCodeMapping, localeHelper) {
            var errorMessages = [];
            for(var i in relMessages) {
               var relObj = relMessages[i];
               var attrMessages = MessageHelper.getAttributeMessages(relObj.relAttributes, relObj.attrModels, messageCodeMapping, localeHelper);
               var attributeErrors = MessageHelper.getErrorsFromAttrMessages(attrMessages, relObj.attrModels);
               var errorMessage = {
                   "attributeName": relObj.relTitle,
                   "message": relObj.relMessage
               };
               attributeErrors.push(errorMessage);
               errorMessages.push.apply(errorMessages, attributeErrors);
            }
            return errorMessages;
        };

        MessageHelper.getErrorsFromWhereUsedMessages= function(relMessages, messageCodeMapping, localeHelper) {
            var errorMessages = [];
            for(var i in relMessages) {
               var relObj = relMessages[i];
               var attrMessages = MessageHelper.getAttributeMessages(relObj.relAttributes, relObj.attrModels, messageCodeMapping, localeHelper);
               var attributeErrors = MessageHelper.getErrorsFromAttrMessages(attrMessages, relObj.attrModels);
               var errorMessage = {
                   "fromEntity": relObj.fromEntityId,
                   "fromEntityType": relObj.fromEntityType,
                   "attrErrorMessages": attributeErrors
               };
               errorMessages.push(errorMessage);
            }
            return errorMessages;
        };

    })();
</script>