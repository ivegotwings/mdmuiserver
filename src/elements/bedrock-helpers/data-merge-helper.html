<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">-->
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="data-helper.html">
<link rel="import" href="context-helper.html">

<script>
    window.DataMergeHelper = window.DataMergeHelper || {};

    (function () {

        DataMergeHelper.mergeDataObjects = function (target, source, addMissing = false) {

            const utils = SharedUtils.DataObjectFalcorUtil;

            var targetData = target.data;

            if (!targetData) {
                return target;
            }

            var targetContexts = target.data.contexts;

            var sourceData = source.data;

            if (!sourceData) {
                return target;
            }

            var sourceContexts = sourceData.contexts;

            var targetSelfCtxItem = { 'attributes': targetData.attributes, 'relationships': targetData.relationships, 'properties': targetData.properties };
            var sourceSelfCtxItem = { 'attributes': sourceData.attributes, 'relationships': sourceData.relationships, 'properties': sourceData.properties };

            var mergedSelfCtxItem = this.mergeCtxItems(targetSelfCtxItem, sourceSelfCtxItem, addMissing);
            targetData.attributes = mergedSelfCtxItem.attributes;
            targetData.relationships = mergedSelfCtxItem.relationships;
            targetData.properties = mergedSelfCtxItem.properties;

            for (var i = 0; i < targetContexts.length; i++) {
                var targetCtxItem = targetContexts[i];
                var targetContext = targetCtxItem.context;

                var sourceCtxItem = utils.getCtxItem(sourceContexts, targetContext);

                if (sourceCtxItem) {
                    targetCtxItem = this.mergeCtxItems(targetCtxItem, sourceCtxItem, addMissing);
                }
            }

            return target;
        };

        DataMergeHelper.mergeRelationships = function (target, source, addMissing = false) {
            if (!target) {
                if (addMissing) {
                    target = {};
                }
                else {
                    return target;
                }
            }

            if (!source) {
                return target;
            }

            for (var targetObjKey in target) {
                var targetObj = target[targetObjKey];
                var sourceObj = source[targetObjKey];

                if (sourceObj) {
                    targetObj = SharedUtils.DataObjectFalcorUtil.mergeArraysNoOverride(targetObj, sourceObj, "id", true);
                }
            }

            if (addMissing) {
                for (var sourceObjKey in source) {
                    var sourceObj = source[sourceObjKey];
                    var targetObj = target[sourceObjKey];

                    if (!targetObj) {
                        target[sourceObjKey] = sourceObj;
                    }
                }
            }

            return target;
        };

        DataMergeHelper.mergeCtxItems = function (target, source, addMissing = false) {

            var utils = SharedUtils.DataObjectFalcorUtil;
            var deepAssign = utils.deepAssign;

            target.attributes = this.mergeAttributes(target.attributes, source.attributes, addMissing);
            target.relationships = this.mergeRelationships(target.relationships, source.relationships, addMissing);
            target.properties = utils.mergeObjectsNoOverride(target.properties, source.properties, true);

            return target;
        }

        DataMergeHelper.mergeAttributes = function (target, source, addMissing = false) {
            var utils = SharedUtils.DataObjectFalcorUtil;
            target = utils.mergeObjectsNoOverride(target, source, addMissing);
            return target;
        }

        DataMergeHelper.mergeWorkflowMappings = function (model, contextData) {
            var firstDataContext = ContextHelper.getFirstDataContext(contextData);

            var mergedWorkflows = {};
            if (model && model.data && model.data.relationships) {
                mergedWorkflows = DataMergeHelper.mergeRelationships(mergedWorkflows, model.data.relationships, true);
            }
            if (firstDataContext) {
                var ctxRelationships = SharedUtils.DataObjectFalcorUtil.getRelationshipsByCtx(model, firstDataContext);
                if (!_.isEmpty(ctxRelationships)) {
                    mergedWorkflows = DataMergeHelper.mergeRelationships(mergedWorkflows, ctxRelationships, true);
                }
            }
            return mergedWorkflows;
        };

    })();

</script>