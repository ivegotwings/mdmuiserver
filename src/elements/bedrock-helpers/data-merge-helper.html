<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="data-helper.html">
<link rel="import" href="context-helper.html">

<script>
    DataMergeHelper = {};

    (function () {

        DataMergeHelper.mergeDataObjects = function (target, source) {

            const utils = SharedUtils.DataObjectFalcorUtil;

            var targetData = target.data;

            if (!targetData) {
                return target;
            }

            var targetContexts = target.data.contexts;

            var sourceData = source.data;

            if (!sourceData) {
                return target;
            }

            var sourceContexts = sourceData.contexts;

            var targetSelfCtxItem = { 'attributes': targetData.attributes, 'relationships': targetData.relationships, 'properties': targetData.properties };
            var sourceSelfCtxItem = { 'attributes': sourceData.attributes, 'relationships': sourceData.relationships, 'properties': sourceData.properties };

            targetSelfCtxItem = this.mergeCtxItems(targetSelfCtxItem, sourceSelfCtxItem, false);

            for (var i = 0; i < targetContexts.length; i++) {
                var targetCtxItem = targetContexts[i];
                var targetContext = targetCtxItem.context;

                var sourceCtxItem = utils.getCtxItem(sourceContexts, targetContext);

                if (sourceCtxItem) {
                    targetCtxItem = this.mergeCtxItems(targetCtxItem, sourceCtxItem, false);
                }
            }

            return target;
        };

        DataMergeHelper.mergeRelationships = function (target, source, addMissing = false) {
            if (!target) {
                if (addMissing) {
                    target = {};
                }
                else {
                    return target;
                }
            }

            if (!source) {
                return target;
            }

            for (var targetObjKey in target) {
                var targetObj = target[targetObjKey];
                var sourceObj = source[targetObjKey];

                if (sourceObj) {
                    targetObj = SharedUtils.DataObjectFalcorUtil.mergeArraysNoOverride(targetObj, sourceObj, "id", true);
                }
            }

            if (addMissing) {
                for (var sourceObjKey in source) {
                    var sourceObj = source[sourceObjKey];
                    var targetObj = target[sourceObjKey];

                    if (!targetObj) {
                        target[sourceObjKey] = sourceObj;
                    }
                }
            }

            return target;
        };

        DataMergeHelper.mergeCtxItems = function (target, source, addMissing = false) {

            var utils = SharedUtils.DataObjectFalcorUtil;
            var deepAssign = utils.deepAssign;

            target.attributes = this.mergeAttributes(target.attributes, source.attributes, addMissing);
            target.relationships = this.mergeRelationships(target.relationships, source.relationships, addMissing);
            target.properties = utils.mergeObjectsNoOverride(target.properties, source.properties, true);

            return target;
        }

        DataMergeHelper.mergeAttributes = function (target, source, addMissing = false) {
            var utils = SharedUtils.DataObjectFalcorUtil;
            target = utils.mergeObjectsNoOverride(target, source, addMissing);
            return target;
        }

    })();

</script>