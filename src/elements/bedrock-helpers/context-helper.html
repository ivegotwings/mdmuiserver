<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">-->

<script>
    window.ContextHelper = window.ContextHelper || {};

    (function () {

        ContextHelper.CONTEXT_TYPE_DOMAIN = 'DomainContexts';
        ContextHelper.CONTEXT_TYPE_DATA = 'Contexts';
        ContextHelper.CONTEXT_TYPE_VALUE = 'ValContexts';
        ContextHelper.CONTEXT_TYPE_ITEM = 'ItemContexts';
        ContextHelper.CONTEXT_TYPE_APP = 'AppContexts';
        ContextHelper.CONTEXT_TYPE_USER = 'UserContexts';
        ContextHelper.CONTEXT_TYPE_RELATIONSHIP = 'RelationshipContexts';

        ContextHelper.valContextKeys = ['source', 'locale'];
        ContextHelper.appContextKeys = ['app'];
        ContextHelper.domainContextKeys = ['domain'];

        ContextHelper.getContexts = function (contextData, contextType) {
            return contextData[contextType] !== undefined ? contextData[contextType] : [];
        };

        ContextHelper.getFirstContext = function (contextData, contextType) {
            let contexts = contextData[contextType];
            if (contexts && contexts.length > 0) {
                return contexts[0];
            }

            return undefined;
        };

        ContextHelper.getDomainContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_DOMAIN);
        };

        ContextHelper.getDataContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_DATA);
        };

        ContextHelper.getItemContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_ITEM);
        };

        ContextHelper.getValueContexts = function (contextData) {
            let valueContexts = ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_VALUE);
            return valueContexts;
        };

        ContextHelper.getUserContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_USER);
        };

        ContextHelper.getAppContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_APP);
        };

        ContextHelper.getRelationshipContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_RELATIONSHIP);
        };

        ContextHelper.getFirstDomainContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_DOMAIN);
        };

        ContextHelper.getFirstDataContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_DATA);
        };

        ContextHelper.getFirstValueContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_VALUE);
        };

        ContextHelper.getFirstItemContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_ITEM);
        };

        ContextHelper.getFirstUserContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_USER);
        };

        ContextHelper.getFirstAppContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_APP);
        };

        ContextHelper.getFirstRelationshipContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_RELATIONSHIP);
        };

        ContextHelper.updateContext = function (contextData, contextType, contexts) {
            contextData[contextType] = contexts;
        };

        ContextHelper.createContextDataFromFlatValue = function (selContextsFlat) {
            if (!_.isEmpty(selContextsFlat)) {
                for (let key in selContextsFlat) {
                    let val = selContextsFlat[key];
                    if (!(val && val.length)) {
                        delete selContextsFlat[key]
                    }
                }

                return _.isEmpty(selContextsFlat) ? [] : _.createCartesianObjects(selContextsFlat);
            }
        };

        ContextHelper.updateContextData = function (contextData, newDimensions) {
            if (_.isEmpty(newDimensions)) {
                return;
            }

            let selDataContextsFlat = {};
            let selValContextsFlat = {};
            let selAppContextsFlat = {};
            let selDomainContextsFlat = {};

            // scope out data contexts vs val contexts
            Object.keys(newDimensions).map(function (dimName) {
                let dimValues = newDimensions[dimName];
                if (ContextHelper.valContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selValContextsFlat[dimName] = dimValues;
                } else if (ContextHelper.appContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selAppContextsFlat[dimName] = dimValues;
                } else if (ContextHelper.domainContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selDomainContextsFlat[dimName] = dimValues;
                }
                else {
                    selDataContextsFlat[dimName] = dimValues;
                }
            });

            if (!_.isEmpty(selDataContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_DATA] = ContextHelper.createContextDataFromFlatValue(selDataContextsFlat);
            }

            if (!_.isEmpty(selValContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_VALUE] = ContextHelper.createContextDataFromFlatValue(selValContextsFlat);
            }

            if (!_.isEmpty(selAppContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_APP] = ContextHelper.createContextDataFromFlatValue(selAppContextsFlat);
            }

            if (!_.isEmpty(selDomainContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_DOMAIN] = ContextHelper.createContextDataFromFlatValue(selDomainContextsFlat);
            }
        }

        ContextHelper.addDefaultValContext = function (contextData) {
            let checkDefaultLocale = false;
            if (contextData && !_.isEmpty(contextData)) {
                let valContexts = contextData[ContextHelper.CONTEXT_TYPE_VALUE] || [];
                if (valContexts && valContexts.length) {
                    let defaultLocale = DataHelper.getDefaultLocale();
                    valContexts.forEach(function (valCtx) {
                        if (valCtx.locale == defaultLocale) {
                            checkDefaultLocale = true;
                        }
                    });
                }
                if (!checkDefaultLocale) {
                    contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [];
                    contextData[ContextHelper.CONTEXT_TYPE_VALUE].push(DataHelper.getDefaultValContext());
                }
            }
        }

        ContextHelper.isValidContext = function (entityType, dataContext, valueContext, successCB, errorCB) {
            ContextHelper.validateContext(entityType, dataContext, valueContext).then((result) => {
                if (!_.isEmpty(result)) {
                    if (result.status == "valid") {
                        successCB();
                    } else {
                        errorCB(result.statusCode);
                    }
                }
            });
        }

        ContextHelper.validateContext = async function (entityType, dataContext, valueContext) {
            let status = {};
            let statusCode = [];
            let isCombinationValid = true;
            let localeManager = ComponentHelper.getLocaleManager();

            if (!_.isEmpty(entityType)) {
                if (!_.isEmpty(valueContext)) {
                    let emptyValContext;
                    for (let vcKey of ContextHelper.valContextKeys) {
                        if (_.isEmpty(valueContext[vcKey])) {
                            isCombinationValid = false;
                            statusCode.push('Value context: ' + vcKey + ' is missing.'); // TODO:: Need to convert into ERROR CODE.
                        }
                    }
                }

                // dataContext = {"country": "Germany", "channel": "DE WEb"}
                if (!_.isEmpty(dataContext)) {
                    let matchedCtxModelInstance = await ContextModelManager.getContextModelByEntityTypeAndDataContext(entityType, dataContext);
                    if (_.isEmpty(matchedCtxModelInstance)) {
                        isCombinationValid = false;
                        statusCode.push('Invalid data context:' + JSON.stringify(dataContext) + '.'); // TODO:: Need to convert into ERROR CODE.
                    }

                    for (let dcKey in dataContext) {
                        let depsOfCurrentDataCtx = await ContextModelManager.getDependentRelationshipDetails(entityType, dcKey, dataContext[dcKey]); // deps = {"allowedLocales": [{relTo: {"id": "", "type": ""}}, {relTo: {"id": "", "type": ""}}]}
                        let mappedValueContexts = await ContextModelManager.getMappedValueContextsBasedOnEntityTypeAndContextKey(entityType, dcKey); // mappedValueContexts = [{"valueContext": "locale", "valueContextRelationship": "allowedLocales"}]

                        if (mappedValueContexts && depsOfCurrentDataCtx) {
                            for (let mvc of mappedValueContexts) {
                                // mvc = {"valueContext": "locale", "valueContextRelationship": "allowedLocales"}
                                if (mvc.valueContext == "locale") {
                                    let locale = valueContext[mvc.valueContext]; // locale = "th-TH"
                                    let depRels = depsOfCurrentDataCtx[mvc.valueContextRelationship]; // depRels = [{relTo: {"id": "", "type": ""}}, {relTo: {"id": "", "type": ""}}]

                                    if (!_.isEmpty(depRels)) {
                                        let relIds = depRels.map(v => v.relTo.id); // relIds = rel ids of "allowedLocales" in Germany

                                        if (relIds && locale) {
                                            let localeObjects = localeManager && await localeManager.getByIdsAsync(relIds); // localeObjects = [{"en-US with name"}, {"de-DE with name"}, {"en-GB with name"}]
                                            let matchedLocale;
                                            
                                            if (!_.isEmpty(localeObjects)) {
                                                matchedLocale = localeObjects.find(v => v.name == locale); // matchedLocale = [];
                                            }

                                            if (_.isEmpty(matchedLocale)) {
                                                isCombinationValid = false;
                                                statusCode.push('Invalid combination of data and value context:' + JSON.stringify(dataContext) + ' - ' + JSON.stringify(valueContext) + '.'); // TODO:: Need to convert into ERROR CODE.
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if (!isCombinationValid) {
                status.status = "invalid";
                status.statusCode = statusCode;
            } else {
                status.status = "valid";
            }

            return status;
        };

        ContextHelper.createWorkflowContexts = function(wfDefinitionMappingModel, contextData) {
            let workflowContexts = [];
            let dataContexts = ContextHelper.getDataContexts(contextData);
            let clonedDataContexts = !_.isEmpty(dataContexts) ? DataHelper.cloneObject(dataContexts) : [];
            let mergedWorkflows = {};

            if (!_.isEmpty(clonedDataContexts)) {
                for (let i = 0; i < clonedDataContexts.length; i++) {
                    let firstDataContext = clonedDataContexts[i];
                    let ctxRelationships = SharedUtils.DataObjectFalcorUtil.getRelationshipsByCtx(wfDefinitionMappingModel, firstDataContext);
                    mergedWorkflows = DataMergeHelper.mergeRelationships(mergedWorkflows, ctxRelationships, true);
                    let mappedWorkflowNames = DataHelper.getRelToNames(mergedWorkflows.hasWorkflowsDefined);

                    if(!_.isEmpty(mappedWorkflowNames)) {
                        mappedWorkflowNames.forEach(function(workflowName) {
                            let workflowContext = DataHelper.cloneObject(firstDataContext);
                            workflowContext["workflow"] = workflowName;
                            workflowContexts.push(workflowContext); 
                        });
                    }
                }
            } else {
                if(DataHelper.isValidObjectPath(wfDefinitionMappingModel, "data.relationships")) {
                    mergedWorkflows = DataMergeHelper.mergeRelationships(mergedWorkflows, wfDefinitionMappingModel.data.relationships, true);
                    let mappedWorkflowNames = DataHelper.getRelToNames(mergedWorkflows.hasWorkflowsDefined);

                    if(!_.isEmpty(mappedWorkflowNames)) {
                        mappedWorkflowNames.forEach(function(workflowName) {
                            let workflowContext = {
                                "self": "self",
                                "workflow": workflowName
                            };
                            workflowContexts.push(workflowContext); 
                        });
                    }
                }
            }

            return workflowContexts;
        };

        ContextHelper.createContextForWorkflowActions = function(workflowContext) {
            let data = {};
            if(!_.isEmpty(workflowContext)) {
                let context = DataHelper.cloneObject(workflowContext);
                if(context["self"]) {
                    delete context["self"];
                }
                if(context["workflow"]) {
                    delete context["workflow"];
                }
                
                if(!_.isEmpty(context)) {
                    let ctxObj = { "context": context };
                    data["contexts"] = [ ctxObj ];
                }
            }

            return data;
        }

        ContextHelper.getPrimaryContexts = async function (contextData, type) {
            let clonedContextData = DataHelper.cloneObject(contextData);
            let dataContexts = ContextHelper.getDataContexts(clonedContextData);
            let firstItemContext = ContextHelper.getFirstItemContext(clonedContextData) || {};
            type = type || firstItemContext.type;
            if (!_.isEmpty(dataContexts)) {
                for (let i = 0; i < dataContexts.length; i++) {
                    let context = dataContexts[i];
                    let additionalContexts = [];
                    let contextModel = await ContextModelManager.getContextModelByEntityTypeAndDataContext(type, context);
                    if (contextModel) {
                        additionalContexts = contextModel.properties ? contextModel.properties.additionalcontexts : undefined;
                    }
                    if (!_.isEmpty(additionalContexts)) {
                        additionalContexts.forEach(function (ctxKey) {
                            delete context[ctxKey];
                        });
                    }
                }

                return dataContexts.filter(ctx => !_.isEmpty(ctx));
            }
        }
    })();

</script>