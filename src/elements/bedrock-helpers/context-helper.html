<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">-->

<script>
    window.ContextHelper = window.ContextHelper || {};

    (function () {

        ContextHelper.CONTEXT_TYPE_DOMAIN = 'DomainContexts';
        ContextHelper.CONTEXT_TYPE_DATA = 'Contexts';
        ContextHelper.CONTEXT_TYPE_VALUE = 'ValContexts';
        ContextHelper.CONTEXT_TYPE_ITEM = 'ItemContexts';
        ContextHelper.CONTEXT_TYPE_APP = 'AppContexts';
        ContextHelper.CONTEXT_TYPE_USER = 'UserContexts';
        ContextHelper.CONTEXT_TYPE_RELATIONSHIP = 'RelationshipContexts';

        ContextHelper.valContextKeys = ['source', 'locale'];
        ContextHelper.appContextKeys = ['app'];
        ContextHelper.domainContextKeys = ['domain'];

        ContextHelper.getContexts = function (contextData, contextType) {
            return contextData[contextType] !== undefined ? contextData[contextType] : [];
        };

        ContextHelper.getFirstContext = function (contextData, contextType) {
            var contexts = contextData[contextType];
            if (contexts && contexts.length > 0) {
                return contexts[0];
            }

            return undefined;
        };

        ContextHelper.getDomainContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_DOMAIN);
        };

        ContextHelper.getDataContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_DATA);
        };

        ContextHelper.getItemContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_ITEM);
        };

        ContextHelper.getValueContexts = function (contextData) {
            var valueContexts = ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_VALUE);
            return valueContexts;
        };

        ContextHelper.getUserContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_USER);
        };

        ContextHelper.getAppContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_APP);
        };

        ContextHelper.getRelationshipContexts = function (contextData) {
            return ContextHelper.getContexts(contextData, ContextHelper.CONTEXT_TYPE_RELATIONSHIP);
        };

        ContextHelper.getFirstDomainContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_DOMAIN);
        };

        ContextHelper.getFirstDataContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_DATA);
        };

        ContextHelper.getFirstValueContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_VALUE);
        };

        ContextHelper.getFirstItemContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_ITEM);
        };

        ContextHelper.getFirstUserContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_USER);
        };

        ContextHelper.getFirstAppContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_APP);
        };

        ContextHelper.getFirstRelationshipContext = function (contextData) {
            return ContextHelper.getFirstContext(contextData, ContextHelper.CONTEXT_TYPE_RELATIONSHIP);
        };

        ContextHelper.updateContext = function (contextData, contextType, contexts) {
            contextData[contextType] = contexts;
        };

        ContextHelper.createContextDataFromFlatValue = function (selContextsFlat) {
            if (!_.isEmpty(selContextsFlat)) {
                for (var key in selContextsFlat) {
                    var val = selContextsFlat[key];
                    if (!(val && val.length)) {
                        delete selContextsFlat[key]
                    }
                }
                
                return _.isEmpty(selContextsFlat) ? [] : _.createCartesianObjects(selContextsFlat);
            }
        };

        ContextHelper.updateContextData = function (contextData, newDimensions) {
            if (_.isEmpty(newDimensions)) {
                return;
            }

            var selDataContextsFlat = {};
            var selValContextsFlat = {};
            var selAppContextsFlat = {};
            var selDomainContextsFlat = {};

            // scope out data contexts vs val contexts
            Object.keys(newDimensions).map(function (dimName) {
                var dimValues = newDimensions[dimName];
                if (ContextHelper.valContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selValContextsFlat[dimName] = dimValues;
                } else if (ContextHelper.appContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selAppContextsFlat[dimName] = dimValues;
                } else if (ContextHelper.domainContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selDomainContextsFlat[dimName] = dimValues;
                }
                else {
                    selDataContextsFlat[dimName] = dimValues;
                }
            });

            if (!_.isEmpty(selDataContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_DATA] = ContextHelper.createContextDataFromFlatValue(selDataContextsFlat);
            }

            if (!_.isEmpty(selValContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_VALUE] = ContextHelper.createContextDataFromFlatValue(selValContextsFlat);
            }

            if (!_.isEmpty(selAppContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_APP] = ContextHelper.createContextDataFromFlatValue(selAppContextsFlat);
            }

            if (!_.isEmpty(selDomainContextsFlat)) {
                contextData[ContextHelper.CONTEXT_TYPE_DOMAIN] = ContextHelper.createContextDataFromFlatValue(selDomainContextsFlat);
            }
        }

        ContextHelper.addDefaultValContext = function (contextData) {
            var checkDefaultLocale = false;
            if(contextData && !_.isEmpty(contextData)){
                var valContexts = contextData[ContextHelper.CONTEXT_TYPE_VALUE] || [];
                if (valContexts && valContexts.length) {
                    var defaultLocale = DataHelper.getDefaultLocale();
                    valContexts.forEach(function (valCtx) {
                        if (valCtx.locale == defaultLocale) {
                            checkDefaultLocale = true;
                        }
                    });
                }
                if(!checkDefaultLocale){
                    contextData[ContextHelper.CONTEXT_TYPE_VALUE].push(DataHelper.getDefaultValContext());
                }
            }
        }

    })();

</script>