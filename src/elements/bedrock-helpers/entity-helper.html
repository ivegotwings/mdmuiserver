<!--
`bedrock-helpers` Represents a bunch of helpers that any bedrock, pebble, rock or app can use. 
-->
<!--<link rel="import" href="../../../bower_components/polymer/polymer.html">-->
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-merge-helper.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<script>
    window.EntityHelper = window.EntityHelper || {};

    (function () {

        EntityHelper.getAllAttributes = function (entity) {
            var attributes = {};
            if (entity) {
                if (entity.data) {
                    if (entity.data.attributes) {
                        attributes = DataMergeHelper.mergeAttributes(attributes, entity.data.attributes, true);
                    }

                    if (entity.data.contexts) {
                        entity.data.contexts.forEach(function (element) {
                            if (element && element.attributes) {
                                attributes = DataMergeHelper.mergeAttributes(attributes, element.attributes, true);
                            }
                        }, this);
                    }
                }
            }

            return attributes;
        };

        EntityHelper.getAttribute = function (entity, attributeName) {
            var attribute = undefined;
            if (entity) {
                if (entity.data) {
                    if (entity.data.contexts) {
                        entity.data.contexts.forEach(function (context) {
                            if (!attribute && context && context.attributes) {
                                attribute = context.attributes[attributeName];
                            }
                        }, this);
                    }

                    if (!attribute) {
                        if (entity.data.attributes) {
                            attribute = entity.data.attributes[attributeName];
                        }
                    }
                }
            }

            return attribute;
        };

        EntityHelper.getRelationshipsBasedOnContext = function (entity, dataContext, isSelfContext) {
            var relationships = {};
            if (entity && entity.data) {
                if (isSelfContext) {
                    if (entity.data.relationships) {
                        relationships = entity.data.relationships;
                    }
                } else {
                    if (!_.isEmpty(dataContext)) {
                        if (entity.data.contexts) {
                            relationships = SharedUtils.DataObjectFalcorUtil.getRelationshipsByCtx(entity, dataContext);
                        }

                    }
                }
            }

            return relationships;
        };

        EntityHelper.getRelationshipByType = function (entity, dataContext, relationshipType) {
            var relationships = [];
            if (entity) {
                if (!dataContext) {
                    if (!entity.data) {
                        entity.data = EntityHelper.getEmptyRelationshipDataObject(undefined, relationshipType);
                    }

                    if (entity.data.relationships) {
                        if (entity.data.relationships[relationshipType]) {
                            relationships = entity.data.relationships[relationshipType];
                        } else {
                            relationships = entity.data.relationships[relationshipType] = [];
                        }
                    } else {
                        relationships = entity.data.relationships = {};
                    }

                } else {
                    if (!entity.data) {
                        entity.data = EntityHelper.getEmptyRelationshipDataObject(dataContext, relationshipType);
                    }

                    var contexts = entity.data.contexts;
                    if (contexts && contexts.length) {
                        contexts.forEach(function (item) {
                            if (item) {
                                item.attributes = {};
                                relationships = item.relationships[relationshipType];

                                if (_.isEmpty(relationships)) {
                                    item.relationships[relationshipType] = [];
                                    relationships = item.relationships[relationshipType];
                                }
                            }
                        }, this);
                    } else {
                        entity.data.contexts = [];
                        entity.data.contexts.push({ "context": dataContext });
                        entity.data.contexts[0].relationships = {};
                        entity.data.contexts[0].relationships[relationshipType] = [];
                        relationships = entity.data.contexts[0].relationships[relationshipType];
                    }
                }
            }
            return relationships;
        };

        // This code has to be removed after completing add assets relationship in a context.
        EntityHelper.getRelationshipByType = function (entity, dataContext, relationshipType, isSelfContext) {
            var relationships = [];
            if (entity) {
                if (isSelfContext) {
                    if (!entity.data) {
                        entity.data = EntityHelper.getEmptyRelationshipDataObject(undefined, relationshipType);
                    }

                    if (entity.data.relationships) {
                        if (entity.data.relationships[relationshipType]) {
                            relationships = entity.data.relationships[relationshipType];
                        } else {
                            relationships = entity.data.relationships[relationshipType] = [];
                        }
                    } else {
                        relationships = entity.data.relationships = {};
                    }

                } else {
                    if (!entity.data) {
                        entity.data = EntityHelper.getEmptyRelationshipDataObject(dataContext, relationshipType);
                    }

                    var contexts = entity.data.contexts;
                    if (contexts && contexts.length) {
                        contexts.forEach(function (item) {
                            if (item) {
                                item.attributes = {};
                                relationships = item.relationships[relationshipType];

                                if (_.isEmpty(relationships)) {
                                    item.relationships[relationshipType] = [];
                                    relationships = item.relationships[relationshipType];
                                }
                            }
                        }, this);
                    } else {
                        entity.data.contexts = [];
                        entity.data.contexts.push({ "context": dataContext });
                        entity.data.contexts[0].relationships = {};
                        entity.data.contexts[0].relationships[relationshipType] = [];
                        relationships = entity.data.contexts[0].relationships[relationshipType];
                    }
                }
            }
            return relationships;
        };

        EntityHelper.getCoalescedRelationshipByType = function (entity, dataContext, relationshipType, applyContextCoalesce) {
            var firstDataContext = ContextHelper.getFirstDataContext(dataContext);
            var coalescedRelationships = [];

            if (entity && entity.data) {
                var data = entity.data;

                if (!_.isEmpty(data.relationships)) {
                    coalescedRelationships = entity.data.relationships[relationshipType];
                }

                if (!_.isEmpty(firstDataContext)) {
                    coalescedRelationships.forEach(function (rel) {
                        if (rel) {
                            rel.properties = rel.properties || {};
                            rel.properties['contextCoalesce'] = [
                                {
                                    "Self": "Self"
                                }
                            ]
                        }
                    }, this);

                    if (!_.isEmpty(data.contexts) && !_.isEmpty(data.contexts[0].relationships)) {
                        
                        if (!applyContextCoalesce) {
                            coalescedRelationships = [];
                        }

                        var contextualRelationships = data.contexts[0].relationships[relationshipType];

                        if (!_.isEmpty(coalescedRelationships)) {
                            contextualRelationships.forEach(function (ctxRel) {
                                if (ctxRel) {
                                    var indexOfExistingRel = coalescedRelationships.findIndex(rel => rel.relTo.id == ctxRel.relTo.id);

                                    if (indexOfExistingRel > -1) {
                                        coalescedRelationships[indexOfExistingRel] = ctxRel;
                                    } else {
                                        coalescedRelationships.push(ctxRel);
                                    }
                                }
                            }, this);
                        } else {
                            coalescedRelationships = contextualRelationships;
                        }
                    }
                }
            }

            return coalescedRelationships;
        };

        EntityHelper.getEmptyRelationshipDataObject = function (dataContext, relationship) {

            var relationships = {};

            relationships[relationship] = [];

            if (!_.isEmpty(dataContext)) {
                return {
                    "contexts": [{
                        "context": dataContext,
                        "relationships": relationships
                    }]
                }
            } else {
                return {
                    "relationships": relationships
                }
            }
        };

        EntityHelper.getAttributeNamesFromEntities = function (entities, noOfRowsToRead) {
            var loopThroughLength = entities.length;
            if (noOfRowsToRead && typeof (noOfRowsToRead) == 'number') {
                loopThroughLength = noOfRowsToRead;
            }
            var attributeNames = [];
            for (var i = 0; i < loopThroughLength; i++) {
                if (entities[i]) {
                    var entity = entities[i];
                    var attributes = EntityHelper.getAllAttributes(entity);
                    var keys = Object.keys(attributes);
                    if (keys && keys.length > 0) {
                        for (var j = 0; j < keys.length; j++) {
                            if (attributeNames.indexOf(keys[j]) === -1) {
                                var hasValue = attributes[keys[j]].values && attributes[keys[j]].values.length > 0 && (attributes[keys[j]].values[0].value || attributes[keys[j]].values[0].action == "delete") ? true : false;
                                var hasGroup = attributes[keys[j]].group && attributes[keys[j]].group.length > 0 ? true : false;
                                if (hasValue || hasGroup) {
                                    attributeNames.push(keys[j]);
                                }
                            }
                        }
                    }
                }
            }
            return attributeNames;
        };

        EntityHelper.getContextsFromEntities = function (entities, noOfRowsToRead) {
            var loopThroughLength = entities.length;
            if (noOfRowsToRead && typeof (noOfRowsToRead) == 'number') {
                loopThroughLength = noOfRowsToRead;
            }
            var contexts = [];
            for (var i = 0; i < loopThroughLength; i++) {
                if (entities[i]) {
                    var entity = entities[i];
                    if (entity && entity.data && entity.data.contexts) {
                        var entityContexts = entity.data.contexts;
                        if (entityContexts && entityContexts.length > 0) {
                            for (var j = 0; j < entityContexts.length; j++) {
                                if (entityContexts[j] && entityContexts[j].context) {
                                    var entityContext = entityContexts[j].context;
                                    if (!DataHelper.containsObject(entityContext, contexts)) {
                                        contexts.push(entityContext);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return contexts;
        };

    })();

</script>