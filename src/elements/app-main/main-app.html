<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/mutable-data.html">
<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/app-route/app-location.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="../bedrock-managers/bedrock-managers.html">
<link rel="import" href="../bedrock-managers/locale-manager.html">
<link rel="import" href="../bedrock-managers/context-model-manager.html">
<link rel="import" href="../bedrock-managers/entity-composite-model-manager.html">
<link rel="import" href="../bedrock-helpers/constant-helper.html">

<!-- loading behaviors early to avoid behavior is null error -->
<link rel="import" href="../bedrock-datasource-behavior/bedrock-datasource-behavior.html">
<link rel="import" href="../bedrock-query-builder-behavior/bedrock-query-builder-behavior.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-variables.html">
<link rel="import" href="../bedrock-notification-receiver/bedrock-notification-receiver.html">
<link rel="import" href="../bedrock-dataobject-notification-handler/bedrock-dataobject-notification-handler.html">

<link rel="import" href="../rock-self-help/rock-self-help.html">
<link rel="import" href="../rock-app-repository/rock-app-repository.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-style-manager/bedrock-style-theme-provider.html">
<link rel="import" href="../bedrock-helpers/bedrock-helpers.html">

<script type="text/javascript" src="../../scripts/fileDownloader.js"></script>
<script type="text/javascript" src="../../scripts/Base64.js"></script>
<script type="text/javascript" src="../../scripts/log4javascript.js"></script>
<script type="text/javascript" src="../../scripts/rufLogger.js"></script>
<script type="text/javascript" src="ProgressTracker.js"></script>

<!--
`main-app`
Main os app for riversand ui framework

@demo demo/index.html 
-->
<dom-module id="main-app">
    <template>
        <style include="bedrock-styles-variables bedrock-style-common">
            
            #middle-container {
                margin-left: 45px;
                padding-bottom: 30px;
                padding-top: 40px;
            }

            .header-loading,
            .nav-loading {
                display: block;
                opacity: var(--loading-opacity, 0);
                position: absolute;
                top: 0px;
                left: 0px;
                transition: opacity 2s ease-in-out;
                -moz-transition: opacity 2s ease-in-out;
                -webkit-transition: opacity 2s ease-in-out;

            }

            .header-loading {
                background: var(--top-header-background);
                height: 40px;
                width: 100%;
                left: 45px;
            }

            .nav-loading {
                background: var(--left-nav-background);
                width: 45px;
                height: 100%;
            }
        </style>
        <bedrock-style-theme-provider></bedrock-style-theme-provider>
        
        <div class="header-loading"></div>
        <div class="nav-loading"></div>
       
        <div style="display:none">
            <rock-app-repository context-data="[[contextData]]" app-repository="{{appRepository}}"></rock-app-repository>
            <bedrock-pubsub event-name="app-status-changed" handler="_onAppStatusChanged" app-id="main-app"></bedrock-pubsub>
            <bedrock-pubsub on-bedrock-event-appstatusupdated="_updateActiveItemsAppStatusTitle" name="bedrock-event-appstatusupdated"></bedrock-pubsub>
            <bedrock-pubsub event-name="app-repository-get-error" handler="_onAppRepositoryGetError" name="bedrock-event-app-repository-get-error"></bedrock-pubsub>
            <app-location id="tenantRoute" route="{{route}}"></app-location>
            <app-route route="{{route}}" pattern="/:tenant" data="{{baseRouteData}}" query-params="{{tenantRouteQueryParams}}" tail="{{pageRoute}}"></app-route>
            <app-route route="{{pageRoute}}" pattern="/:page" data="{{routeData}}" query-params="{{queryParams}}" tail="{{subRoute}}"></app-route>
            <app-route route="{{subRoute}}" pattern="/:id" data="{{subRouteData}}"></app-route> 
            <bedrock-notification-receiver></bedrock-notification-receiver>
            <bedrock-dataobject-notification-handler></bedrock-dataobject-notification-handler>
            <rock-self-help context-data="[[contextData]]"></rock-self-help>
        </div>
        <app-common sub-menu-item="{{subMenuItem}}" tenant-logo="{{tenantLogo}}" tenant-logo-text="{{tenantLogoText}}" main-logo="{{mainLogo}}"
            route="{{routeData}}" tenant-id="{{tenantId}}" context-data="[[contextData]]" page="{{page}}" query-params="{{queryParams}}" menu-items="{{menuItems}}" active-items="{{activeItems}}"></app-common>
        
        <div id="middle-container">
            <rock-content-view-manager id="contentViewManager" on-open="onViewOpen" on-opened="onViewOpened" on-close="onViewClose" on-minimize="_onViewMinimize"></rock-content-view-manager>
        </div>
    </template>
    <script>
        function isEmpty(obj) {
            for (let x in obj) {
                return false;
            }
            return true;
        }

        class MainApp
            extends Polymer.mixinBehaviors([
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior,
                RUFBehaviors.ComponentConfigBehavior
            ], Polymer.OptionalMutableData(Polymer.Element)) {
            static get is() { 
                return 'main-app';
            }

            static get properties() {
                return {
                    page: {
                        type: String,
                        notify: true,
                        value: function () {
                            return "";
                        }
                    },
                    pages: {
                        type: Object,
                        value: []
                    },
                    menuItems: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
                    activeItems: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
                    appRepository: {
                        type: Object,
                        notify: true
                    },
                    globalSettings: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    queryParams: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        }
                    },
                    tenantId: {
                        type: String,
                        notify: true,
                        value: "t1"
                    },
                    userId: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    fullName: {
                        type: String,
                        value: ""
                    },
                    userName: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    ownershipData: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    ownershipEditData: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    isAuthenticated: {
                        type: Boolean,
                        value: false
                    },
                    tenantLogo: {
                        type: String,
                        value: ""
                    },
                    tenantLogoText: {
                        type: String,
                        value: ""
                    },
                    mainLogo: {
                        type: String,
                        value: "../src/images/mainlogo.svg"
                    },
                    noPreload: {
                        type: String,
                        value: "false"
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    localeManager: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    roles: {
                        type: String,
                        value: ""
                    },
                    defaultRole: {
                        type: String,
                        value: ""
                    },
                    errorList: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                }
            }
            
            static get observers() {
                return [
                    "_routePageChanged(routeData.page)",
                    "_pageChanged(page,appRepository,queryParams)",
                ]
            }
            
            disconnectedCallback() {
                super.disconnectedCallback();
            }
            
            connectedCallback() {
                super.connectedCallback();
                if (this.isAuthenticated) {
                    if (this.route.path == "/" || (location.href.indexOf("logout") !== -1)) {
                        window.history.pushState("", "Riversand MDMCenter", "/" + this.tenantId);
                        this.shadowRoot.querySelector("#tenantRoute").set("route.prefix", this.tenantId);
                    }

                    if (!_.isEmpty(this.roles)) {
                        this.roles = this.roles.split(",");
                    }

                    RUFUtilities.mainApp = Polymer.dom(document).querySelector("main-app");

                    Polymer.Async.timeOut.after(ConstantHelper.MILLISECONDS_100).run(() => {
                        RUFUtilities.navbarPlaceholder = this.shadowRoot.querySelectorAll(".nav-loading")[0];
                        RUFUtilities.middleContainer = this.shadowRoot.querySelectorAll("#middle-container")[0];
                    });
                    
                    RUFUtilities.initializeLogger(RUFUtilities.Logger.levelError);

                    let logDetail = {
                        "userName": this.userName,
                        "userAgent": navigator.userAgent
                    };

                    RUFUtilities.Logger.info("RUF_BROWSER_APPLICATION_LOADED", logDetail, "main-app");

                    if (this.mainAppSpinner) {
                        this.mainAppSpinner.active = false;
                    }

                    this.requestConfig("global-settings", this.contextData);
                }
            }

            ready() {
                super.ready();
                Polymer.setPassiveTouchGestures(true);
                Polymer.Gestures.add(document.documentElement, "down", null);
            }
            
            changePageRoutePath(newPath, action) {
                if (newPath) {
                    this.set("pageRoute.path", newPath);
                    window.dispatchEvent(new CustomEvent("location-changed"));
                }
                this.openAction = action;
            }

            onConfigLoaded(componentConfig) {
                if (componentConfig && componentConfig.config) {
                    let globalSettings = componentConfig.config;
                    this.initGlobalSettings(globalSettings);
                    this._renderTenantLogo(globalSettings.themeSettings);
                    this._themeProvider = this._themeProvider || this.shadowRoot.querySelector("bedrock-style-theme-provider");
                    this._themeProvider.initiateTheme(globalSettings.themeSettings);

                    this.localeManager = new LocaleManager();   
                    
                    this.loadAppCommon();
                } else {
                    ComponentHelper.removeNode(document.getElementById("loader"));
                    let domContainer = this.shadowRoot.querySelector("#middle-container");
                    this.logError("Base configs are missing", "", true, "Configurations are missing. Contact administrator", domContainer);
                }
            }

            onConfigError(detail) {
                ComponentHelper.removeNode(document.getElementById("loader"));
                let domContainer = this.shadowRoot.querySelector("#middle-container");
                this.logError("Base configs are missing", detail, true, "Configurations are missing. Contact administrator", domContainer);
            }

            _onAppRepositoryGetError(e, detail) {
                ComponentHelper.removeNode(document.getElementById("loader"));
                let domContainer = this.shadowRoot.querySelector("#middle-container");
                this.logError("Base configs are missing", detail, true, "Configurations are missing. Contact administrator", domContainer);
            }

            onLogoClick() {
                let drawer = this.drawerLayout;
                //ToDo: remove hard coded style and use class toggle
                drawer.setAttribute("menu-expanded", "");
                drawer.style.width = "266px";
            }
            
            get contentViewManager() {
                this._contentViewManager = this._contentViewManager || this.shadowRoot.querySelector("#contentViewManager");

                return this._contentViewManager;
            }

            onMenuCloseClick(e, customArgs) {
                this.contentViewManager.closeView(customArgs.item.data_route, customArgs.item.queryParams);
            }

            onRefreshClick() {
                location.reload();
            }

            onViewOpen(e, customArgs) {
                let queryParams;

                if (!customArgs || !customArgs.config) {
                    return;
                }

                if (!isEmpty(this.queryParams)) {
                    queryParams = this.queryParams;
                    RUFUtilities.notinnavmenu = RUFUtilities.notinnavmenu ? RUFUtilities.notinnavmenu : _.difference(Object.keys(this.appRepository), RUFUtilities.menuTitles);
                    if (RUFUtilities.notinnavmenu.indexOf(customArgs.config.data_route) === -1) {
                        for (let ind = 0; ind < this.menuItems.length; ind++) {
                            if (this.menuItems[ind].data_route == customArgs.config.data_route) {
                                if (!queryParams || JSON.stringify(queryParams) == JSON.stringify(this.menuItems[ind].queryParams)) {
                                    return;
                                }
                            }

                            if (this.menuItems[ind].menuItems) {
                                for (let subind = 0; subind < this.menuItems[ind].menuItems.length; subind++) {
                                    if (this.menuItems[ind].menuItems[subind].data_route == customArgs.config.data_route) {
                                        if (!queryParams || JSON.stringify(queryParams) == JSON.stringify(this.menuItems[ind].menuItems[subind].queryParams)) {
                                            return;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    for (let actind = 0; actind < this.activeItems.length; actind++) {
                        if (this.activeItems[actind].data_route == customArgs.config.data_route) {
                            if (!queryParams || JSON.stringify(queryParams) == JSON.stringify(this.activeItems[actind].queryParams)) {
                                return;
                            }
                        }
                    }
                }

                let config = DataHelper.cloneObject(customArgs.config);
                config.queryParams = queryParams;
                this.push("activeItems", config);
            }
            
            onViewOpened(e, customArgs) {
                if(customArgs) {
                    let app = customArgs.previousView ? customArgs.previousView : customArgs.contentView;

                    if (this.activeItems.length && app && app.getAppCurrentStatus) {
                        let activeItem = this.activeItems[this.activeItems.length - 1];
                        if (activeItem.component.name == app.localName) {
                            activeItem = this.pop("activeItems");
                            activeItem.appStatus = app.getAppCurrentStatus(activeItem);
                            this.push("activeItems", activeItem);
                        }
                    }
                }
            }
            
            loadAppCommon () {
                let cElement = customElements.get("app-common");
                
                // This shall / must execute only on first view opened event...as after that customElements registry would already have app-common element
                if (!cElement) {
                    this.updateStyles({
                        "--loading-opacity": 1
                    });

                    ComponentHelper.removeNode(document.getElementById("loader"));
                    
                    Polymer.Async.timeOut.after(ConstantHelper.MILLISECONDS_100).run(() => {
                        Polymer.RenderStatus.afterNextRender(this, () => {
                            Polymer.importHref(Polymer.ResolveUrl.resolveUrl("../../src/elements/app-common/app-common.html"), null, null, true);
                            let localeManager = ComponentHelper.getLocaleManager();
                            if (localeManager) {
                                localeManager.preload();
                            }
                            let entityTypeManager = EntityTypeManager.getInstance();

                            if (entityTypeManager) {
                                entityTypeManager.preload();
                            }
                        });
                    });
                }
            }

            onViewClose(e, customArgs) {
                let viewIndex;
                for (let actIndex = 0; actIndex < this.activeItems.length; actIndex++) {
                    let viewName = ComponentHelper.getViewNameWithQueryParams(this.activeItems[actIndex].queryParams, this.activeItems[actIndex].data_route);
                    if (viewName == customArgs.viewName) {
                        viewIndex = actIndex;
                        break;
                    }
                }
                if (viewIndex || viewIndex == 0) {
                    this.splice("activeItems", viewIndex, 1);
                }
            }
            
            getIsDirty() {
                return this.contentViewManager && this.contentViewManager.getIsDirty();
            }
            
            _routePageChanged(page) {
                if (page) {
                    this.page = page || "";
                }
            }

            _fillPages(pages, appRepository) {
                if (_.isEmpty(this.pages) && !_.isEmpty(appRepository)) {
                    for (let appName in appRepository) {
                        let appConfig = appRepository[appName];
                        if (!_.isEmpty(appConfig) && appConfig.data_route && pages.indexOf(appConfig.data_route) < 0) {
                            pages.push(appConfig.data_route);
                        }
                    }
                }
            }

            _pageChanged(page, appRepository, queryParams) {
                this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(0),
                    () => {
                        if (page != undefined && queryParams != undefined && !_.isEmpty(appRepository)) {
                            this._fillPages(this.pages, appRepository);
                            //Extract page from URL
                            let pageurl = "";
                            let queryParamSplit = location.href.split("?");
                            if (queryParamSplit.length) {
                                let urlWithoutParam = queryParamSplit[0];
                                if (urlWithoutParam) {
                                    let slashIndex = urlWithoutParam.lastIndexOf("/") + 1;
                                    pageurl = urlWithoutParam.substr(slashIndex, urlWithoutParam.length);
                                }
                            }

                            if (this.pages.indexOf(pageurl) !== -1) {
                                this.page = pageurl;
                                this.changePageRoutePath(pageurl);
                                let that = this;
                                Polymer.importHref(Polymer.ResolveUrl.resolveUrl("../../src/elements/rock-content-view-manager/rock-content-view-manager.html"), function () {
                                    let contentViewManager = that.contentViewManager;
                                    if (contentViewManager) {
                                        ComponentHelper.setQueryParamsWithoutEncode(queryParams);
                                        contentViewManager.openView(page, that.appRepository[page], that.queryParams, that.openAction);
                                    }
                                }, null, true);
                                ComponentHelper.emptyDeleteQueue();
                            } else {
                                if (!_.isEmpty(pageurl)) {
                                    this.logError("Requested app '" + this.page + "' is not available in app repository.");
                                }

                                this.page = "dashboard";
                                this.changePageRoutePath("dashboard");
                            }
                        }
                        this.dispatchEvent(new CustomEvent("bedrock-event", {
                            detail: {
                                name: "route-changed",
                                data: {
                                    route: this.route
                                }
                            },
                            bubbles: true,
                            composed: true
                        }));
                    });
            }
           
            get mainAppSpinner() {
                this._mainAppSpinner = this._mainAppSpinner || document.querySelector("#mainAppSpinner");
                return this._mainAppSpinner;
            }

            get mainAppErrorPanel() {
                this._mainAppErrorPanel = this._mainAppErrorPanel || this.shadowRoot.querySelector("#mainAppErrorPanel");
                return this._mainAppErrorPanel;
            }

            _renderTenantLogo(_tenantConfig) {
                if (_tenantConfig) {
                    this.tenantLogo = _tenantConfig.headerLogoUrl;
                    this.tenantLogoText = _tenantConfig.footerTitle;

                    if (!_.isEmpty(_tenantConfig.mainLogoUrl)) {
                        this.mainLogo = _tenantConfig.mainLogoUrl;
                    }

                    if (this.mainAppSpinner) {
                        this.mainAppSpinner.tenantLogoText = this.tenantLogoText;
                    }

                } else {
                    console.error("Configuration not found for User:" + this.userName);
                    //RUFUtilities.Logger.error("Configuration not found for user");
                }
            }
            
            _onViewMinimize(e, customArgs) {
                this._updateActiveItemsAppStatus(customArgs);
            }

            _onAppStatusChanged(e, customArgs) {
                this._updateActiveItemsAppStatus(customArgs);
            }

            _updateActiveItemsAppStatus(customArgs) {
                let viewIndex;
                for (let actIndex = 0; actIndex < this.activeItems.length; actIndex++) {
                    let viewName = ComponentHelper.getViewNameWithQueryParams(this.activeItems[actIndex].queryParams, this.activeItems[actIndex].data_route);
                    if (viewName == customArgs.viewName) {
                        viewIndex = actIndex;
                        break;
                    }
                }

                let appInstance = customArgs.contentView.shadowRoot.querySelector(".view-component");
                if (viewIndex >= 0 && appInstance && appInstance.getAppCurrentStatus) {
                    let appStatus = appInstance.getAppCurrentStatus(this.activeItems[viewIndex]);
                    let activeItems = this.activeItems;
                    activeItems[viewIndex].appStatus = appStatus;
                    this.activeItems = [];
                    this.set("activeItems", activeItems);
                }
            }

            _updateActiveItemsAppStatusTitle(customArgs) {
                let activeItems = DataHelper.cloneObject(this.activeItems);
                for (let actIndex = 0; actIndex < activeItems.length; actIndex++) {
                    if (JSON.stringify(activeItems[actIndex].queryParams) == JSON.stringify(customArgs.detail.queryParams)) {
                        activeItems[actIndex].appStatus.title = customArgs.detail.title;
                        break;
                    }
                }
                if (activeItems.length > 0) {
                    this.activeItems = [];
                    this.set("activeItems", activeItems);
                }
            }
        }

        customElements.define(MainApp.is, MainApp)
    </script>
</dom-module>