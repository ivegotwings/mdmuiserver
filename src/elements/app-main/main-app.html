<!-- <link rel="import" href="../../../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="../../../bower_components/shadycss/apply-shim.html"> -->
<!-- <link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html"> -->

<!-- <link rel="import" href="../../../bower_components/polymer/lib/elements/custom-style.html"> -->

<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/app-route/app-location.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<!--<link rel="import" href="../../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html"> -->

<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-if.html">

<!-- <link rel="import" href="../bedrock-helpers/bedrock-helpers.html">
<link rel="import" href="../bedrock-init/bedrock-init.html"> -->

<!-- loading behaviors early to avoid behavior is null error -->
<link rel="import" href="../bedrock-datasource-behavior/bedrock-datasource-behavior.html">
<link rel="import" href="../bedrock-query-builder-behavior/bedrock-query-builder-behavior.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-app-behavior/bedrock-app-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<!-- <link rel="import" href="../bedrock-style-manager/bedrock-style-theme-provider.html">-->

<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-variables.html">

<!-- <link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-notification-receiver/bedrock-notification-receiver.html">
<link rel="import" href="../bedrock-dataobject-notification-handler/bedrock-dataobject-notification-handler.html"> -->

<!-- <link rel="import" href="../pebble-badge/pebble-badge.html">
<link rel="import" href="../pebble-main-logo/pebble-main-logo.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">
<link rel="import" href="../pebble-tenant-logo/pebble-tenant-logo.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-horizontal-divider/pebble-horizontal-divider.html">
<link rel="import" href="../pebble-toast/pebble-toast.html">
<link rel="import" href="../pebble-badge/pebble-badge.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icon/pebble-icon.html"> -->

<link rel="import" href="../liquid-dataobject-preload/liquid-dataobject-preload.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../rock-login/rock-login.html">

<!-- <link rel="import" href="../rock-login/rock-login.html">
<link rel="import" href="../rock-profile/rock-profile.html">
<link rel="import" href="../rock-header-search/rock-header-search.html">
<link rel="import" href="../rock-notification/rock-notification.html">
<link rel="import" href="../rock-notification-list/rock-notification-list.html"> -->
<link rel="import" href="../rock-content-view-manager/rock-content-view-manager.html">
<!-- <link rel="import" href="../rock-navmenu/rock-navmenu.html">
<link rel="import" href="../rock-disclaimer/rock-disclaimer.html">
<link rel="import" href="../rock-quick-actions/rock-quick-actions.html"> -->
<link rel="import" href="../rock-app-repository/rock-app-repository.html">
<!-- <link rel="import" href="../rock-hotline-settings/rock-hotline-settings.html"> -->

<link rel="import" href="../rock-business-function-elements/rock-business-function-elements.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<link rel="import" href="../bedrock-style-manager/bedrock-style-theme-provider.html">


<!-- <link rel="import" href="../app-common/app-common.html"> -->


<!-- 
    <link rel="import" href="../bedrock-elements/bedrock-elements.html">
    <link rel="import" href="../liquid-elements/liquid-elements.html">
    <link rel="import" href="../pebble-elements/pebble-elements.html">
    <link rel="import" href="../rock-elements/rock-elements.html">
    <link rel="import" href="../app-core-elements/app-core-elements.html"> 
-->

<!-- <script type="text/javascript" src="../../scripts/log4javascript.js"></script>
<script type="text/javascript" src="../../scripts/rufLogger.js"></script>
<script type="text/javascript" src="../../scripts/jquery-slim.js"></script>
<script type="text/javascript" src="../../scripts/fileDownloader.js"></script>
<script type="text/javascript" src="../../scripts/Base64.js"></script> -->

<script>

//RUFUtilities.initializeLogger("{{tenantId}}-{{userId}}");

window.addEventListener('HTMLImportsLoaded', function(e) {
    console.log('all html imports are loaded');
});

window.addEventListener('WebComponentsReady', function(e) {
    console.log('all web components are ready now');
});

var Globals = Globals || {};

Globals.requestCount = 0;
Globals.responseCount = 0;

pages= ["dashboard", "entity-discovery", "asset-discovery", "reference-discovery", "system-healthcheck"];

</script>

<!--
`main-app`
Main os app for riversand ui framework

@demo demo/index.html 
-->
<dom-module id="main-app">
    <template>
        <style include="bedrock-styles-variables bedrock-style-common">
            app-header-layout {
                    z-index: inherit !important;
                }

                app-header-layout {
                    --layout-vertical: {
                        @apply --layout;
                        -ms-flex-direction: column;
                        -webkit-flex-direction: column;
                        flex-direction: column;
                        z-index: inherit !important;
                    }
                }
            </style>
        <bedrock-style-theme-provider></bedrock-style-theme-provider>
        <app-location id="tenantRoute" route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:tenant" data="{{baseRouteData}}" query-params="{{tenantRouteQueryParams}}" tail="{{pageRoute}}"></app-route>
        <app-route route="{{pageRoute}}" pattern="/:page" data="{{routeData}}" query-params="{{queryParams}}" tail="{{subRoute}}"></app-route>
        <app-route route="{{subRoute}}" pattern="/:id" data="{{subRouteData}}"></app-route>
        <template is="dom-if" if="[[!isAuthenticated]]">
            <template is="dom-if" if="{{_loadUserStore}}">
                <liquid-config-get auto id="getUserStore" operation="getbyids" request-id="req2" request-data="[[_userStoreRequest]]" on-response="_onUserStoreGetResponse"></liquid-config-get>
            </template>
            <rock-login is-authenticated="{{isAuthenticated}}" auth-response="{{_authResponse}}" user-store="{{userStore}}"></rock-login>
        </template>
        <liquid-dataobject-preload id="liquidDataObjectPreLoad" on-preload-request-tracker-change="_onRequestTrackerChange" on-dataobject-preload-completed="_onPreloadCompleted"
        on-error="_onPreloadCompleted" pre-load-config="{}"></liquid-dataobject-preload>
        <template is="dom-if" if="[[isAuthenticated]]">
            <app-header-layout>
                <app-common tenant-logo="{{tenantLogo}}" tenant-logo-text="{{tenantLogoText}}" main-logo="{{mainLogo}}" route="{{routeData}}" tenant-id="{{tenantId}}" context-data="[[contextData]]" user-details="{{_userDetails}}" page="{{page}}" query-params="{{queryParams}}" context-data="[[contextData]]" menu-items="{{menuItems}}" active-items="{{activeItems}}"></app-common>
                <div id="middle-container">
                        <rock-content-view-manager id="contentViewManager" on-open="onViewOpen" on-opened="onViewOpened" on-close="onViewClose" on-minimize="_onViewMinimize"></rock-content-view-manager>
                </div>
            </app-header-layout>
            <rock-app-repository context-data="[[contextData]]" app-repository="{{appRepository}}"></rock-app-repository>
        </template>

    </template>
    <script>
        function isEmpty(obj) {
            for (var x in obj) {
                return false;
            }
            return true;
        }
        Polymer({
            is: 'main-app',
            attached: function () {
                if (this.isAuthenticated) {
                    if (this.route.path == "/") {
                        window.history.pushState('', 'Riversand MDMCenter', "/" + this.tenantId);
                        this.shadowRoot.querySelector("#tenantRoute").set('route.prefix', this.tenantId);
                    }

                    var userDetail = {};
                    userDetail.roleId = this.roleId.split(',')[0];
                    userDetail.userName = this.userName;
                    userDetail.tenantId = this.tenantId;
                    userDetail.userFullName = this.fullName
                    userDetail.isAuthenticated = true;

                    //this._userDetails = undefined;
                    this._userDetails = userDetail;
                    this._onUserDetailsChange();
                    var pageurl =  location.href.substring(location.href.lastIndexOf('/') + 1, location.href.length);
                    if(pages.indexOf(pageurl) !== -1) {
                        this.page = pageurl;
                        this.changePageRoutePath(pageurl);
                    } else {
                        this.page = 'dashboard';
                        this.changePageRoutePath('dashboard');
                    }
                }
            },
            properties: {
                cols: {
                    type: Number,
                    value: 2
                },
                page: {
                    type: String,
                    notify: true,
                    value: function () {
                        return "";
                    }
                },
                menuItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                disclaimerMessages: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                appRepository: {
                    type: Object,
                    notify: true
                },
                globalSettings: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                activeItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                toastText: {
                    type: String
                },
                queryParams: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {};
                    }
                },
                tenantId: {
                    type: String,
                    notify: true,
                    value: "t1"
                },
                roleId: {
                    type: String,
                    notify: true,
                    value: ""
                },
                userId: {
                    type: String,
                    notify: true,
                    value: ""
                },
                fullName: {
                    type: String,
                    value: ""
                },
                userName: {
                    type: String,
                    notify: true,
                    value: ""
                },
                ownershipData: {
                    type: String,
                    notify: true,
                    value: ""
                },
                isAuthenticated: {
                    type: Boolean,
                    value: false
                },
                tenantLogo: {
                    type: String,
                    value: ""
                },
                tenantLogoText: {
                    type: String,
                    value: ""
                },
                mainLogo: {
                    type: String,
                    value: "../src/images/mainlogo.svg"
                },
                _userDetails: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                _authResponse: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: '_onAuthResponseChange'
                },
                _appViewOpened: {
                    type: Boolean,
                    value: false
                },
                _userStoreRequest: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {
                                    "name": "app-user-store_rock-user-store",
                                    "contexts": [
                                        {
                                            "app": "app-user-store",
                                            "service": "_ALL",
                                            "component": "rock-user-store",
                                            "subComponent": "_ALL"
                                        }
                                    ],
                                    "filters": {
                                        "typesCriterion": ["uiConfig"]
                                    }
                                },
                                "fields": {
                                    "jsonData": true
                                }
                            }
                        };
                    }
                },
                _loadUserStore: {
                    type: Boolean,
                    computed: "_isUserStoreNeeded(tenantId, isAuthenticated)"
                },
                _preLoadConfig: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    computed: 'getConfig("dataobject-preload")',
                    observer: '_onPreLoadChange'
                },
                noPreload: {
                    type: String,
                    value: "false"
                },
                contextData: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                }
            },
            _onPreLoadChange: function () {
                if (this.noPreload && this.noPreload.toLowerCase() == "true") {
                    this._onPreloadCompleted();
                } else {
                    if (this.isAuthenticated && this._preLoadConfig && !_.isEmpty(this._preLoadConfig)) {
                        this._startPreload();
                    }
                }
            },
            ready: function () {
                console.log('main-app is ready');

                Polymer.setPassiveTouchGestures(true);

                this._handleDocumentClick = this._handleDocumentClick.bind(this);

                document.addEventListener("click", this._handleDocumentClick);
            },
            detached() {
                document.removeEventListener("click", this._handleDocumentClick);
            },
            _handleDocumentClick(e) {
                //Collapsing the drawer not required when action is performed on the nav menu
                var navMenuFound = false;
                e.path = e.Path || e.composedPath();
                for (var key = 0; key < e.path.length; key++) {
                    if (e.path[key].tagName) {
                        if (e.path[key].tagName.toUpperCase() == "ROCK-NAVMENU") {
                            navMenuFound = true;
                            break;
                        }
                    }
                }

                var drawerLayout = this.shadowRoot.querySelector("#drawerLayout");
                
                if (drawerLayout && drawerLayout.$.contentContainer.style.width != "45px") {
                    if (e.__domApi.rootTarget.id != "trigger" && e.__domApi.rootTarget.className.indexOf("menu-trigger") == -1 && e.__domApi.rootTarget.className.indexOf("iron-selected") == -1) {
                        var navMenu = this.shadowRoot.querySelector("rock-navmenu");
                        if (navMenu) {
                            if (navMenuFound && navMenu.doNotCollapse) {
                                return;
                            }
                            navMenu.$.toggleItem.click();
                        }
                    }
                }
            },
            observers: [
                '_routePageChanged(routeData.page)',
                '_pageChanged(page,appRepository,menuItems,queryParams)',
                '_onContextDataChange(contextData.*, tenantId)'
            ],
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior,
                RUFBehaviors.ComponentConfigBehavior
            ],
            changePageRoutePath: function (newPath, action) {
                if (newPath) {
                    this.set('pageRoute.path', newPath);
                    window.dispatchEvent(new CustomEvent('location-changed'));
                }
                this.openAction = action;
            },

            _onContextDataChange: function() {
                if(!_.isEmpty(this.contextData)) {
                    var contextData = DataHelper.cloneObject(this.contextData);
                    var userContext = ContextHelper.getFirstUserContext(contextData);
                    if(this.tenantId && userContext) { //tenant specific global settings
                        userContext.tenantId = this.tenantId
                    }
                    this.requestConfig('global-settings', contextData);
                }
            },

            onConfigLoaded: function(componentConfig) {
                if (componentConfig && componentConfig.config) {
                    var globalSettings = componentConfig.config;
                    this.initGlobalSettings(globalSettings);
                    this._renderTenantLogo(globalSettings.themeSettings);
                    var themeProvider = this.shadowRoot.querySelector("bedrock-style-theme-provider");
                    if(themeProvider){
                        themeProvider.initiateTheme(globalSettings.themeSettings);
                    }
                }
            },

            onLogoClick: function () {
                var drawer = this.drawerLayout;
                //ToDo: remove hard coded style and use class toggle
                drawer.setAttribute("menu-expanded", "");
                drawer.style.width = "266px";
            },
            // Scroll page to top and expand header
            scrollPageToTop: function () {
                document.getElementById('mainContainer').scrollTop = 0;
            },
            onMenuClick: function (e, customArgs) {
                //   debugger;
                //   this.page = customArgs.item.name;
                //   this.$.contentViewManager.openView(customArgs.item.name, customArgs.item);
            },
            onMenuCloseClick: function (e, customArgs) {
                this.shadowRoot.querySelector('#contentViewManager').closeView(customArgs.item.data_route, customArgs.item.queryParams);
            },
            onRefreshClick: function () {
                location.reload();
            },
            onViewOpen: function (e, customArgs) {

                var queryParams;

                if (!customArgs || !customArgs.config) {
                    return;
                }

                if (!isEmpty(this.queryParams)) {
                    queryParams = this.queryParams;
                }
                for (var i = 0; i < this.menuItems.length; i++) {
                    if (this.menuItems[i].data_route == customArgs.config.data_route) {
                        if (!queryParams) {
                            return;
                        } else if (JSON.stringify(queryParams) == JSON.stringify(this.menuItems[i].queryParams)) {
                            return;
                        }
                    }
                    if (this.menuItems[i].menuItems) {
                        for (var j = 0; j < this.menuItems[i].menuItems.length; j++) {
                            if (this.menuItems[i].menuItems[j].data_route == customArgs.config.data_route) {
                                if (!queryParams) {
                                    return;
                                } else if (JSON.stringify(queryParams) == JSON.stringify(this.menuItems[i].menuItems[
                                    j].queryParams)) {
                                    return;
                                }
                            }
                        }
                    }
                }
                for (i = 0; i < this.activeItems.length; i++) {
                    if (this.activeItems[i].data_route == customArgs.config.data_route) {
                        if (!queryParams) {
                            return;
                        } else if (JSON.stringify(queryParams) == JSON.stringify(this.activeItems[i].queryParams)) {
                            return;
                        }
                    }
                }
                var config = DataHelper.cloneObject(customArgs.config);
                config.queryParams = queryParams;
                this.push("activeItems", config);
            },
            onViewOpened: function (e, customArgs) {
                
                var loader = document.getElementById("loader");
                if (loader) {
                    loader.parentNode.removeChild(loader);
                    loader = null;
                }

                var app = customArgs.previousView ? customArgs.previousView : customArgs.contentView;
                if (this.activeItems.length && app && app.getAppCurrentStatus) {
                    var activeItem = this.activeItems[this.activeItems.length - 1];
                    if (activeItem.component.name == app.localName) {
                        var activeItem = this.pop("activeItems");
                        activeItem.appStatus = app.getAppCurrentStatus(activeItem);
                        this.push("activeItems", activeItem);
                    }
                }
                var cElement = customElements.get('app-common');
                if (!cElement) {
                    Polymer.Async.timeOut.after(2000).run(() => {
                        Polymer.RenderStatus.afterNextRender(this, () => {
                            Polymer.importHref(Polymer.ResolveUrl.resolveUrl('../../src/elements/app-common/app-common.html'),null,null,true);
                        });
                    });
                }
            },
            onViewClose: function (e, customArgs) {
                var viewIndex;
                for (var i = 0; i < this.activeItems.length; i++) {
                    var viewName = ComponentHelper.getViewNameWithQueryParams(this.activeItems[i].queryParams, this.activeItems[i].data_route);
                    if (viewName == customArgs.viewName) {
                        viewIndex = i;
                        break;
                    }
                }
                if (viewIndex || viewIndex == 0) {
                    this.splice("activeItems", viewIndex, 1);
                }
            },
            showUserNotifications: function () {
                this.shadowRoot.querySelector('#popoverUserNotifications').show();
                this.shadowRoot.querySelector('#mdmUserNotifications').label = 0;
            },
            showSystemNotifications: function () {
                this.shadowRoot.querySelector('#popoverSystemNotifications').show();
                this.shadowRoot.querySelector('#mdmSystemNotifications').label = 0;
            },
            getIsDirty: function () {
                var contentViewManager = this.shadowRoot.querySelector('#contentViewManager');
                if (contentViewManager && contentViewManager.getIsDirty) {
                    var isDirty = contentViewManager.getIsDirty();
                    return isDirty;
                }
            },
            _onAuthResponseChange: function () {
                if (this._authResponse && this._authResponse.isSuccessful) {
                    this._userDetails = this._authResponse.userDetails;
                    this._onUserDetailsChange();
                } else if (this._authResponse.errorDetails) {
                    alert(this._authResponse.errorDetails.message);
                }
            },
            _onUserDetailsChange: function () {
                if (!isEmpty(this._userDetails)) {
                    this.isAuthenticated = this._userDetails.isAuthenticated;
                    this.tenantId = this._userDetails.tenantId;
                    this.roleId = this._userDetails.roleId;

                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId,
                        "tenant": this.tenantId
                    }

                    this.set('contextData.' + this.CONTEXT_TYPE_USER, [userContext]);
                }
            },
            _routePageChanged: function (page) {
                if (page) {
                    this.page = page || '';
                }
            },
            _pageChanged: function (page, appRepository, menuItems, queryParams) {
                this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(0), () => {
                    if (page != undefined && queryParams != undefined && appRepository /*&& menuItems && menuItems.length*/) {
                        if (page == "") {
                            var menu = menuItems.filter(
                                function (menu) {
                                    return menu.isLandingPage == true
                                }
                            );
                            if (menu && menu.length > 0) {
                                page = menu[0].data_route;
                            }
                            Polymer.dom.flush();
                        }
                        var contentViewManager = this.shadowRoot.querySelector('#contentViewManager');
                        if (contentViewManager) {
                            contentViewManager.openView(page, this.appRepository[page], this.queryParams, this.openAction);
                        }
                    }
                    this.dispatchEvent(new CustomEvent('bedrock-event', {
                        detail: {
                            name: "route-changed",
                            data: {
                                route: this.route
                            }
                        },
                        bubbles: true,
                        composed: true
                    }));
                });
            },
            _onUserStoreGetResponse: function (e) {
                //console.log('Received configs ', JSON.stringify(e, null, 2));
                this.set('userStore', e.detail.response.content.configObjects[0].data.contexts[0].jsonData.config);
            },
            _renderTenantLogo: function(_tenantConfig){
                if (_tenantConfig) {
                    this.tenantLogo = _tenantConfig.headerLogoUrl;
                    this.tenantLogoText = _tenantConfig.footerTitle;

                    if (!_.isEmpty(_tenantConfig.mainLogoUrl)) {
                        this.mainLogo = _tenantConfig.mainLogoUrl;
                    }

                    var preloadElement = document.querySelector("#mainAppSpinner");
                    if (preloadElement) {
                        preloadElement.tenantLogoText = this.tenantLogoText;
                    }

                } else {
                    alert("Configuration not found for User:" + this._userDetails.userName);
                    //RUFUtilities.Logger.error("Configuration not found for user");
                }
            },
            _isUserStoreNeeded: function (tenantId, isAuthenticated) {
                if (tenantId && tenantId != "" && !isAuthenticated) {
                    return true;
                } else {
                    return false;
                }
            },
            _startPreload: function () {
                var contextData = {};
                contextData[ContextHelper.CONTEXT_TYPE_USER] = [
                    {   'user': this._userDetails.userName, 
                        'role': this._userDetails.roleId ,
                        "tenant": this.tenantId
                    }
                ];

                var liquidDataObjectPreLoad = this.shadowRoot.querySelector('#liquidDataObjectPreLoad');
                liquidDataObjectPreLoad.contextData = contextData;
                liquidDataObjectPreLoad.generateRequest();
                this._appViewOpened = false;
            },
            _onRequestTrackerChange: function (e) {
                var loadingTexts = ["Loading configurations...", "Loading apps...", "Launching your app..."];
                var preloadElement = document.querySelector("#mainAppSpinner");
                if (preloadElement) {
                    preloadElement.indeterminate = false;
                    var progressMaxValue = preloadElement.progressMaxValue;
                    preloadElement.progressValue = (progressMaxValue / e.detail.all.sent) * e.detail.all.received;
                    var loadingTextsIndex = parseInt(preloadElement.progressValue / 300);
                    if (loadingTextsIndex >= 0) {
                        var lastIndex = loadingTexts.length - 1;
                        if (loadingTextsIndex > lastIndex) {
                            loadingTextsIndex = lastIndex;
                        }

                        preloadElement.loadingText = loadingTexts[loadingTextsIndex];
                    }
                }
            },
            _onPreloadCompleted: function (e) {
                var preloadElement = document.querySelector("#mainAppSpinner");
                if (preloadElement) {
                    preloadElement.active = false;
                }
                this._appViewOpened = true;        
            },
            _onViewMinimize: function (e, customArgs) {
                this._updateActiveItemsAppStatus(customArgs);
            },
            _onAppStatusChanged: function (e, customArgs) {
                this._updateActiveItemsAppStatus(customArgs);
            },
            _updateActiveItemsAppStatus: function (customArgs) {
                var viewIndex;
                for (var i = 0; i < this.activeItems.length; i++) {
                    var viewName = ComponentHelper.getViewNameWithQueryParams(this.activeItems[i].queryParams, this.activeItems[i].data_route);
                    if (viewName == customArgs.viewName) {
                        viewIndex = i;
                        break;
                    }
                }
                var appInstance = customArgs.contentView.shadowRoot.querySelector(".view-component");
                if (viewIndex >= 0 && appInstance && appInstance.getAppCurrentStatus) {
                    var appStatus = appInstance.getAppCurrentStatus(this.activeItems[viewIndex]);
                    var activeItems = this.activeItems;
                    activeItems[viewIndex].appStatus = appStatus;
                    this.activeItems = [];
                    this.set("activeItems", activeItems);
                }
            },
            _updateActiveItemsAppStatusTitle: function (customArgs) {
                var activeItems = DataHelper.cloneObject(this.activeItems);
                for (var j = 0; j < activeItems.length; j++) {
                    if (JSON.stringify(activeItems[j].queryParams) == JSON.stringify(customArgs.detail.queryParams)) {
                        activeItems[j].appStatus.title = customArgs.detail.title;
                        break;
                    }
                }
                if (activeItems.length > 0) {
                    this.activeItems = [];
                    this.set("activeItems", activeItems);
                }
            }
        });
    </script>
</dom-module>
