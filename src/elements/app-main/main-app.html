<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/app-route/app-location.html">
<link rel="import" href="../../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-if.html">

<!-- All bundle elements are included here to get them downloaded on main app load -->
<link rel="import" href="../bedrock-init/bedrock-init.html">
<link rel="import" href="../bedrock-elements/bedrock-elements.html">
<link rel="import" href="../liquid-elements/liquid-elements.html">
<link rel="import" href="../pebble-elements/pebble-elements.html">
<link rel="import" href="../pebble-badge/pebble-badge.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-toggle-button/pebble-toggle-button.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../rock-elements/rock-elements.html">
<link rel="import" href="../app-core-elements/app-core-elements.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-styles-variables.html">
<link rel="import" href="../bedrock-style-manager/bedrock-style-theme-provider.html">

<script src="globals.js"></script>


<!--
`main-app`
Main os app for riversand ui framework

@demo demo/index.html 
-->
<dom-module id="main-app">
   <template>
            <style include="bedrock-styles-variables bedrock-style-common">
                app-header {
                    color: var(--top-header-font-color, #ffffff);
                    width: 100%;
                    height: var(--app-header-height);
                    padding: 0 10px;
                    background: var(--top-header-background);
                    z-index: 2;
                }

                app-header div[align="left"] {
                    width: 400px;
                    padding-left: 35px;
                    float: left;
                    height: 40px;
                    display: -ms-flexbox;
                    display: -webkit-flex;
                    display: flex;
                    align-items: center;
                }

                app-header div[align="right"] {
                    width: auto;
                    float: right;
                    font-size: 0;
                    height: 40px;
                    display: -ms-flexbox;
                    display: -webkit-flex;
                    display: flex;
                    align-items: center;
                }

                paper-progress {
                    width: 100%;
                    position: relative !important;
                    --paper-progress-height: 7px;
                    margin-left: 10px;
                }

                app-header paper-icon-button {
                    --paper-icon-button-ink-color: var(--top-header-icon-color, #ffffff);
                }

                app-drawer {
                    margin-top: 40px;
                    z-index: 999;
                }

                #navMenu {
                    --paper-menu: {
                        background: var(--left-nav-background, var(--secondary-color));
                        overflow: hidden;
                    }
                }

                app-toolbar {
                    color: var(--palette-white, #fff);
                    height: var(--app-header-height);
                    padding-right: 0;
                    padding-left: 0;
                    display: block;
                }
            pebble-vertical-divider {
                background: var(--top-header-vertical-divider-color, #ffffff);
                --pebble-vertical-divider-height: 18px;
                border-right: none;
                opacity: 1;
            }
            pebble-toggle-button {
                --pebble-toggle-button-checked-bar-color: #ffffff;
                --pebble-toggle-button-checked-button-color: #ffffff;
                --pebble-toggle-button-checked-ink-color: #ffffff;

                --pebble-toggle-button-unchecked-bar-color: #a9a9a9;
                --pebble-toggle-button-unchecked-button-color: #a9a9a9;
                --pebble-toggle-button-unchecked-ink-color: #a9a9a9;
            }
            pebble-toggle-button {
            --pebble-toggle-button-unchecked-button:{
                background-color: #a9a9a9 !important;
            };
        }

        pebble-dialog {		
                     --dialog-component: {		
                         width: 400px;		
                         top: 20% !important;		
                     }		
                 }

            pebble-button#cancel {
                --pebble-button-paper-style: {
                    color: var(--secondary-button-text-color, #75808b);
                    background-color: var(--secondary-button-color, #ffffff);
                    border: 1px solid var(--secondary-button-border-color, #c1cad4);
                    font-weight: var(--font-bold, bold);
                    height: 30px;
                };
            }

            pebble-button#continue {
                --pebble-button-paper-style: {
                    color: var(--button-text-color, #ffffff);
                    background-color: var(--success-button-color, #09c021);
                    border-color: var(--success-button-color, #09c021);
                    font-weight: var(--font-bold, bold);
                    height: 30px;
                };
            }

                app-toolbar a {
                    text-decoration: none;
                }

                pebble-vertical-divider {
                    background: var(--top-header-vertical-divider-color, #ffffff);
                    --pebble-vertical-divider-height: 18px;
                    border-right: none;
                    opacity: 1;
                }

                drawer-list {
                    margin: 0 20px;
                }

                .drawer-list a {
                    display: block;
                    padding: 0 16px;
                    text-decoration: none;
                    color: var(--app-secondary-color);
                    line-height: 40px;
                }

                .drawer-list a.iron-selected {
                    color: var(--border-black, #000);
                    font-weight: var(--font-bold, bold);
                }

                #middle-container {
                    height: 100%;
                    margin-left: 45px;
                    padding-bottom: 23px;
                    padding-top: 40px;
                }

                rock-notification {
                    height: 20px;
                    display: inline-block;
                    vertical-align: middle;
                    margin: 0px 5px 0 5px;
                    --header-badge: {
                        background: var(--header-notification-color, #ffffff);
                        color: var(--header-notification-text-color);
                        border-color: var(--header-notification-color, #ffffff);
                    };
                }

                #popoverUserNotifications,
                #popoverSystemNotifications {
                    margin-top: 9px;
                    --pebble-popover-width: 542px;
                    --pebble-popover-max-width: 556px;
                    --pebble-popover-max-height: 366px;
                    --popover: {
                        padding-top: 15px !important;
                        padding-bottom: 15px !important;
                    }
                }

                #userNotificationsList,
                #systemNotificationsList {
                    --notification-font-size: var(--default-font-size, 14px);
                    --profile-flex-verticle-max-width: 500px;
                    --desc-box-styles: {
                        text-align: left;
                    }
                }

                #appProgress {
                    --paper-progress-container: {
                        z-index: -1;
                    }
                }

                .rock-header-style {
                    --search-icon-fill-color: #09c021;
                    position: relative;
                    display: inline-block;
                    vertical-align: middle;
                }

                app-drawer {
                    --app-drawer-content-container: {
                        background-color: transparent !important;
                        -webkit-transition: all 0.3s;
                        -moz-transition: all 0.3s;
                        -o-transition: all 0.3s;
                        transition: all 0.3s;
                    }
                }

                app-header-layout {
                    z-index: inherit !important;
                }

                app-header-layout {
                    --layout-vertical: {
                        @apply --layout;
                        -ms-flex-direction: column;
                        -webkit-flex-direction: column;
                        flex-direction: column;
                        z-index: inherit !important;
                    }
                }

                pebble-main-logo,
                pebble-tenant-logo {
                    display: inline-grid;
                    display: -ms-inline-grid;
                    vertical-align: middle;
                }

                app-header pebble-button {
                    display: inline-block;
                    vertical-align: middle;
                    height: 20px;
                    margin-top: 2px;
                }

                app-header iron-icon {
                    width: 20px;
                    height: 20px;
                }

                rock-profile {
                    --pebble-icon: {
                        width: 8px;
                        margin-left: 10px;
                    }
                }
                pebble-icon{
                    --pebble-icon:{
                        fill:var(--white, #fff);
                    };
                }

                pebble-actions {
                    position: relative;
                    display: inline-block;
                    vertical-align: middle;
                    --pebble-actions-button: {
                        height: 24px;
                        font-size: var(--default-font-size, 14px)!important;
                        top: 0px;
                        color: var(--palette-white, #fff);
                        background: transparent;
                        border: none;
                    }

                    --pebble-actions-button-drop-down-icon: {
                        height: 20px;
                        width: 20px;
                        fill: var(--palette-white, #fff);
                    }

                    --pebble-actions-button-icon: {
                        fill: var(--palette-white, #fff);
                        height: 16px;
                        width: 16px;
                        margin-left: 10px;
                        margin-right: 10px;
                    }

                    --pebble-icon: {
                        fill: var(--palette-white, #fff);
                        padding-top: 0px;
                        padding-right: 0px;
                        padding-bottom: 0px;
                        padding-left: 0px;
                        margin-top: 0;
                        margin-right: 0;
                        margin-bottom: 0;
                        margin-left: 0;
                    }

                    --pebble-button: {
                        position: relative;
                        height: 24px;
                    }

                    --paper-button-focus-before: {
                        opacity: 1;
                        -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=100)";
                    }

                    --paper-button-before: {
                        position: absolute;
                        content: "";
                        left: 0;
                        right: 0;
                        top: -11px;
                        bottom: -5px;
                        background-color: rgba(0, 0, 0, 0.2);
                        opacity: 0;
                        -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
                        z-index: -1;
                    }

                }

                .search-wrap {
                    float: left;
                }

                .quick-wrap {
                    float: left;
                }

                [visibility-hidden] {
                    visibility: hidden;
                }

                pebble-horizontal-divider {
                    background-color: var(--palette-pale-grey-three, #e7ebf0);
                    margin-right: 20px;
                    margin-left: 20px
                }

                .popup-title {
                    margin: 0px;
                    font-size: var(--default-font-size, 14px);
                    font-weight: var(--font-medium, 500);
                    text-align: left;
                    @apply --popup-item;
                }

                pebble-button {
                    --pebble-button-left-icon: {
                        width: var(--default-icon-size, 20px) !important;
                        height: var(--default-icon-size, 20px) !important;
                    }

                }

                app-header {
                    position: fixed;
                    left: 0;
                    top: 0;
                    right: 0;
                }
            </style>
        <bedrock-style-theme-provider></bedrock-style-theme-provider>
        <bedrock-init locale-resource-path="/src/resources/locales.json" default-language="en"></bedrock-init>
        <liquid-dataobject-preload id="liquidDataObjectPreLoad" on-preload-request-tracker-change="_onRequestTrackerChange" on-dataobject-preload-completed="_onPreloadCompleted"
            on-error="_onPreloadCompleted" pre-load-config="[[_preLoadConfig]]"></liquid-dataobject-preload>
        <app-location id="tenantRoute" route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:tenant" data="{{baseRouteData}}" query-params="{{tenantRouteQueryParams}}" tail="{{pageRoute}}"></app-route>
        <app-route route="{{pageRoute}}" pattern="/:page" data="{{routeData}}" query-params="{{queryParams}}" tail="{{subRoute}}"></app-route>
        <app-route route="{{subRoute}}" pattern="/:id" data="{{subRouteData}}"></app-route>
        <!--<app-localstorage-document id="userDetailsStorage" key="userdetails" data="{{_userDetails}}" session-only="true"></app-localstorage-document>-->
        <template is="dom-if" if="[[!isAuthenticated]]">
            <rock-login is-authenticated="{{isAuthenticated}}" auth-response="{{_authResponse}}" user-store="{{userStore}}"></rock-login>
        </template>
        <template is="dom-if" if="[[isAuthenticated]]">
            <liquid-config-aggregate-get id="aggregareConfigGet" verbose operation="getbyids" request-id="req1" app-name="main-app" context-data="[[contextData]]"
                on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <app-header-layout id="headerLayout" fullbleed visibility-hidden>
                <app-header fixed effects="waterfall">
                    <app-toolbar>
                        <div align="left">
                            <pebble-main-logo logo-url="[[mainLogo]]" on-logo-click="onLogoClick"></pebble-main-logo>
                            <pebble-vertical-divider class="m-r-5 m-l-5"></pebble-vertical-divider>
                            <pebble-tenant-logo logo-url="[[tenantLogo]]" logo-text="[[tenantLogoText]]" on-logo-click="onLogoClick"></pebble-tenant-logo>
                        </div>
                        <div id="toastArea" align="center"></div>
                        <rock-profile id="userProfile" src="../src/images/no-photo.jpg" user-details="[[_userDetails]]" icon="pebble-xs-icons:ExpandMoreWhite"></rock-profile>
                        <div align="right">
                            <div class="search-wrap">
                                <rock-header-search class="rock-header-style" search-config="[[getConfig('header-search')]]">
                                </rock-header-search>
                            </div>
                            <div class="quick-wrap">
                                <pebble-actions id="quick-actions" class="m-l-10" button-icon="pebble-md-icons:Quickactions" button-text="Quick Actions"
                                    actions-data="[[getConfig('pebble-actions')]]">
                                </pebble-actions>
                            </div>
                            <pebble-icon icon="pebble-lg-icons:Help" class="icon-button pebble-lg-icons m-r-5 m-l-5 tooltip-bottom" onclick="window.open('https://docs.riversand.com/rdp/index.html')"
                                data-tooltip="Help"></pebble-icon>
                            <!-- User Notifications Section -->
                            <rock-notification id="mdmUserNotifications" label="0" on-click="showUserNotifications" class="tooltip-bottom" data-tooltip="Notifications"></rock-notification>
                            <pebble-popover id="popoverUserNotifications" for="mdmUserNotifications" auto-fit-on-attach no-overlap display-arrow-as-per-target
                                horizontal-align="right">
                                <div class="popup-title p-b-5">Notifications</div>
                                <pebble-horizontal-divider></pebble-horizontal-divider>
                                <rock-notification-list id="userNotificationsList" show-line-index="1">
                                </rock-notification-list>
                            </pebble-popover>
                            <!-- System Notifications Section -->
                            <rock-notification id="mdmSystemNotifications" label="0" on-click="showSystemNotifications" icon="pebble-lg-icons:SystemNotifications"
                                class="tooltip-bottom" data-tooltip="System Notifications"></rock-notification>
                            <pebble-popover id="popoverSystemNotifications" for="mdmSystemNotifications" auto-fit-on-attach no-overlap display-arrow-as-per-target
                                horizontal-align="right">
                                <div class="popup-title p-b-5">System Notifications</div>
                                <pebble-horizontal-divider></pebble-horizontal-divider>
                                <rock-notification-list id="systemNotificationsList" show-line-index="1">
                                </rock-notification-list>
                            </pebble-popover>
                            <template is="dom-if" if="[[_isHotlineAllowed(hotlineSettings)]]">
                                <pebble-toggle-button class="tooltip-bottom m-l-5" data-tooltip="Hotline" checked="{{hotlineModeEnabled}}"></pebble-toggle-button>
                            </template>
                        </div>
                        <div class="clearfix"></div>
                    </app-toolbar>
                    <paper-progress id="appProgress" class="middle fit" value="0" min="0" max="1000"></paper-progress>
                </app-header>
                <div id="middle-container">
                    <rock-content-view-manager id="contentViewManager" on-open="onViewOpen" on-opened="onViewOpened" on-close="onViewClose" on-minimize="_onViewMinimize"></rock-content-view-manager>
                </div>
                <rock-disclaimer messages="{{disclaimerMessages}}" user-details="{{_userDetails}}" view-opened="{{_appViewOpened}}"></rock-disclaimer>
            </app-header-layout>
            <bedrock-pubsub target-id="" event-name="pebble-actions-action-click" handler="_onActionItemTap"></bedrock-pubsub>
        </template>
        <app-drawer id="drawerLayout" on-app-drawer-transitioned="onAppDrawerTransitioned" persistent opened has-scrolling-region
            visibility-hidden>
            <template is="dom-if" if="[[isAuthenticated]]">
                <rock-navmenu id="navMenu" page="{{page}}" query-params="{{queryParams}}" menu-items="{{menuItems}}" active-items="{{activeItems}}"
                    route="{{routeData}}" on-menu-click="onMenuClick" on-menu-close-click="onMenuCloseClick"></rock-navmenu>
            </template>
        </app-drawer>
        <template is="dom-if" if="[[isAuthenticated]]">
            <pebble-toast id="pebbleAppToast" vertical-align="top">
                [[toastText]]
            </pebble-toast>
        </template>
        <template is="dom-if" if="{{_loadUserStore}}">
            <liquid-config-get auto id="getUserStore" operation="getbyids" request-id="req2" request-data="[[_userStoreRequest]]" on-response="_onUserStoreGetResponse"></liquid-config-get>
        </template>
        <bedrock-notification-receiver></bedrock-notification-receiver>
        <bedrock-dataobject-notification-handler></bedrock-dataobject-notification-handler>
        <bedrock-pubsub event-name="app-status-changed" handler="_onAppStatusChanged" app-id="main-app"></bedrock-pubsub>
        <bedrock-pubsub event-name="app-status-updated" handler="_updateActiveItemsAppStatusTitle" app-id="main-app"></bedrock-pubsub>        
        <pebble-dialog id="hotlineDialog" modal small vertical-offset=1 50 horizontal-align="auto" vertical-align="auto" no-cancel-on-outside-click
            no-cancel-on-esc-key dialog-title="Hotline">
            <p>Hotline mode timer is about to expire! Click 'Continue' to keep working in Hotline mode or 'Cancel' if you are
                finished.
            </p>
            <div class="buttons">
                <pebble-button id="continue" class="btn btn-success" button-text="Continue" on-tap="_onHotlineContinue"></pebble-button>
                <pebble-button id="cancel" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_onHotlineCancel"></pebble-button>
            </div>
        </pebble-dialog>
    </template>
    <script>
        function isEmpty(obj) {
            for (var x in obj) {
                return false;
            }
            return true;
        }
        Polymer({
            is: 'main-app',
            attached: function () {
                if (this.isAuthenticated) {
                    if (this.route.path == "/") {
                        window.history.pushState('', 'Riversand MDMCenter', "/" + this.tenantId);
                        this.shadowRoot.querySelector("#tenantRoute").set('route.prefix', this.tenantId);
                    }

                    var userDetail = {};
                    userDetail.roleId = this.roleId.split(',')[0];
                    userDetail.userName = this.userName;
                    userDetail.tenantId = this.tenantId;
                    userDetail.userFullName = this.fullName
                    userDetail.isAuthenticated = true;

                    this._userDetails = undefined;
                    this._userDetails = userDetail;

                    RUFUtilities.Logger.trace("Authentication successful");
                    RUFUtilities.Logger.info("Preload started");
                }
                Polymer.Async.microTask.run(() => {
                    var paperProgress = this.shadowRoot.querySelector('#appProgress');
                    if (_.isEmpty(Globals.progressBar) && paperProgress) {
                        Globals.progressBar = paperProgress;
                    }
                });
                RUFUtilities.Logger.debug("Main app attached");
            },
            /**
             * Fired when route is changed.
             *
             * @event route-changed (pub-sub event)
             * @param {Object} detail
             * @param {Object} detail.item item to be collapsed
             */
            properties: {
                cols: {
                    type: Number,
                    value: 2
                },
                page: {
                    type: String,
                    notify: true,
                    value: function () {
                        return "";
                    }
                },
                menuItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                disclaimerMessages: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                appRepository: {
                    type: Object,
                    notify: true
                },
                globalSettings: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                activeItems: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [];
                    }
                },
                toastText: {
                    type: String
                },
                queryParams: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {};
                    }
                },
                tenantId: {
                    type: String,
                    notify: true,
                    value: "t1"
                },

                roleId: {
                    type: String,
                    notify: true,
                    value: ""
                },

                userId: {
                    type: String,
                    notify: true,
                    value: ""
                },

                fullName: {
                    type: String,
                    value: ""
                },

                userName: {
                    type: String,
                    notify: true,
                    value: ""
                },

                ownershipData: {
                    type: String,
                    notify: true,
                    value: ""
                },

                isAuthenticated: {
                    type: Boolean,
                    value: false
                },
                tenantLogo: {
                    type: String,
                    value: ""
                },
                tenantLogoText: {
                    type: String,
                    value: ""
                },
                mainLogo: {
                    type: String,
                    value: "../src/images/mainlogo.svg"
                },
                _userDetails: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: '_onUserDetailsChange'
                },
                _authResponse: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    observer: '_onAuthResponseChange'
                },
                _appViewOpened: {
                    type: Boolean,
                    value: false
                },
                _userStoreRequest: {
                    type: Object,
                    value: function () {
                        return {
                            "params": {
                                "query": {
                                    "name": "app-user-store_rock-user-store",
                                    "contexts": [
                                        {
                                            "app": "app-user-store",
                                            "service": "_ALL",
                                            "component": "rock-user-store",
                                            "subComponent": "_ALL"
                                        }
                                    ],
                                    "filters": {
                                        "typesCriterion": ["uiConfig"]
                                    }
                                },
                                "fields": {
                                    "jsonData": true
                                }
                            }
                        };
                    }
                },
                _loadUserStore: {
                    type: Boolean,
                    computed: "_isUserStoreNeeded(tenantId, isAuthenticated)"
                },
                _preLoadConfig: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    computed: 'getConfig("dataobject-preload")',
                    observer: '_onPreLoadChange'
                },
                noPreload: {
                    type: String,
                    value: "false"
                },
                hotlineModeEnabled: {
                    type: Boolean,
                    value: false,
                    observer: '_onHotlineChange'
                },
                hotlineSettings: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }
            },
            _onPreLoadChange: function () {
                if (this.noPreload && this.noPreload.toLowerCase() == "true") {
                    this._onPreloadCompleted();
                } else {
                    if (this.isAuthenticated && this._preLoadConfig && !_.isEmpty(this._preLoadConfig)) {
                        this._startPreload();
                    }
                }
            },
            ready: function () {
                var _this = this;
                document.addEventListener("click", function (e) {
                    var mainAppHost = _this.$;

                    //Collapsing the drawer not required when action is performed on the nav menu
                    var navMenuFound = false;
                    e.path =  e.composedPath();
                    for(var key=0; key<e.path.length; key++){
                        if(e.path[key].tagName){
                            if(e.path[key].tagName.toUpperCase() == "ROCK-NAVMENU"){
                                navMenuFound=true;
                                break;
                            }
                        }
                    }

                    if (mainAppHost.drawerLayout && mainAppHost.drawerLayout.$.contentContainer.style.width != "45px") {
                        if (e.__domApi.rootTarget.id != "trigger" && e.__domApi.rootTarget.className.indexOf("menu-trigger") == -1 && e.__domApi.rootTarget.className.indexOf("iron-selected") == -1) {
                            var navMenu = _this.shadowRoot.querySelector("rock-navmenu");
                            if (navMenu) {                                
                                if(navMenuFound && navMenu.doNotCollapse){
                                    return;
                                }
                                navMenu.$.toggleItem.click();
                            }
                        }
                    }
                });
            },
            observers: [
                '_routePageChanged(routeData.page)',
                '_pageChanged(page,appRepository,menuItems,queryParams)'
            ],
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior
            ],

            changePageRoutePath: function (newPath, action) {
                if (newPath) {
                    this.set('pageRoute.path', newPath);
                    window.dispatchEvent(new CustomEvent('location-changed'));
                }
                this.openAction = action;
            },

            onLogoClick: function () {
                var drawer = this.drawerLayout;
                //ToDo: remove hard coded style and use class toggle
                drawer.setAttribute("menu-expanded", "");
                drawer.style.width = "266px";
            },
            // Scroll page to top and expand header
            scrollPageToTop: function () {
                document.getElementById('mainContainer').scrollTop = 0;
            },
            onMenuClick: function (e, customArgs) {
                //   debugger;
                //   this.page = customArgs.item.name;
                //   this.$.contentViewManager.openView(customArgs.item.name, customArgs.item);
            },
            onMenuCloseClick: function (e, customArgs) {
                this.shadowRoot.querySelector('#contentViewManager').closeView(customArgs.item.data_route, customArgs.item.queryParams);
            },            
            onRefreshClick: function () {
                location.reload();
            },
            onViewOpen: function (e, customArgs) {
                var queryParams;

                if (!customArgs || !customArgs.config) {
                    return;
                }

                if (!isEmpty(this.queryParams)) {
                    queryParams = this.queryParams;
                }
                for (var i = 0; i < this.menuItems.length; i++) {
                    if (this.menuItems[i].data_route == customArgs.config.data_route) {
                        if (!queryParams) {
                            return;
                        } else if (JSON.stringify(queryParams) == JSON.stringify(this.menuItems[i].queryParams)) {
                            return;
                        }
                    }
                    if (this.menuItems[i].menuItems) {
                        for (var j = 0; j < this.menuItems[i].menuItems.length; j++) {
                            if (this.menuItems[i].menuItems[j].data_route == customArgs.config.data_route) {
                                if (!queryParams) {
                                    return;
                                } else if (JSON.stringify(queryParams) == JSON.stringify(this.menuItems[i].menuItems[
                                    j].queryParams)) {
                                    return;
                                }
                            }
                        }
                    }
                }
                for (i = 0; i < this.activeItems.length; i++) {
                    if (this.activeItems[i].data_route == customArgs.config.data_route) {
                        if (!queryParams) {
                            return;
                        } else if (JSON.stringify(queryParams) == JSON.stringify(this.activeItems[i].queryParams)) {
                            return;
                        }
                    }
                }
                var config = DataHelper.cloneObject(customArgs.config);
                config.queryParams = queryParams;
                this.push("activeItems", config);
            },
            onViewOpened: function (e, customArgs) {
                var app = customArgs.previousView ? customArgs.previousView : customArgs.contentView;
                if (this.activeItems.length && app && app.getAppCurrentStatus) {
                    var activeItem = this.activeItems[this.activeItems.length - 1];
                    if (activeItem.component.name == app.localName) {
                        var activeItem = this.pop("activeItems");
                        activeItem.appStatus = app.getAppCurrentStatus(activeItem);
                        this.push("activeItems", activeItem);
                    }
                }
            },
            onViewClose: function (e, customArgs) {
                var viewIndex;
                for (var i = 0; i < this.activeItems.length; i++) {
                    var viewName = ComponentHelper.getViewNameWithQueryParams(this.activeItems[i].queryParams, this.activeItems[i].data_route);
                    if (viewName == customArgs.viewName) {
                        viewIndex = i;
                        break;
                    }
                }
                if (viewIndex || viewIndex == 0) {
                    this.splice("activeItems", viewIndex, 1);
                }
            },
            showUserNotifications: function () {
                this.shadowRoot.querySelector('#popoverUserNotifications').show();
                this.shadowRoot.querySelector('#mdmUserNotifications').label = 0;
            },
            showSystemNotifications: function () {
                this.shadowRoot.querySelector('#popoverSystemNotifications').show();
                this.shadowRoot.querySelector('#mdmSystemNotifications').label = 0;
            },
            getIsDirty: function () {
                var contentViewManager = this.shadowRoot.querySelector('#contentViewManager');
                if (contentViewManager && contentViewManager.getIsDirty) {
                    var isDirty = contentViewManager.getIsDirty();
                    return isDirty;
                }
            },
            // When auth response changes
            _onAuthResponseChange: function () {
                if (this._authResponse && this._authResponse.isSuccessful) {
                    this._userDetails = this._authResponse.userDetails;
                } else if (this._authResponse.errorDetails) {
                    alert(this._authResponse.errorDetails.message);
                }
            },
            // app-localstorage-document - session user details 
            _onUserDetailsChange: function () {
                if (!isEmpty(this._userDetails)) {
                    this.isAuthenticated = this._userDetails.isAuthenticated;
                    this.tenantId = this._userDetails.tenantId;
                    this.roleId = this._userDetails.roleId;

                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    }

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
                }
            },
            _routePageChanged: function (page) {
                if (page) {
                    this.page = page || '';
                }
            },
            _pageChanged: function (page, appRepository, menuItems, queryParams) {
                this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(0), () => {
                    if (page != undefined && queryParams != undefined && appRepository && menuItems && menuItems.length) {
                        if (page == "") {
                            var menu = menuItems.filter(
                                function (menu) {
                                    return menu.isLandingPage == true
                                }
                            );
                            if (menu && menu.length > 0) {
                                page = menu[0].data_route;
                            }
                            Polymer.dom.flush();
                        }
                        var contentViewManager = this.shadowRoot.querySelector('#contentViewManager');
                        if (contentViewManager) {
                            contentViewManager.openView(page, this.appRepository[page], this.queryParams, this.openAction);
                            var navMenu = this.shadowRoot.querySelector('#navMenu');
                            if (navMenu && navMenu._collapseExpandDrawer) {
                                //Do not collapse the drawer when close item is clicked
                                if(navMenu.doNotCollapse){
                                    navMenu.doNotCollapse = false;
                                    return;
                                }
                                navMenu._collapseExpandDrawer(true);
                            }
                        }
                    }
                    this.dispatchEvent(new CustomEvent('bedrock-event', {
                        detail: {
                            name: "route-changed",
                            data: {
                                route: this.route
                            }
                        },
                        bubbles: true,
                        composed: true
                    }));
                });
            },
            _onActionItemTap: function (e, detail, sender) {
                if (detail && detail.data) {

                    //Want to open same path, then close the existing and reopen newly
                    if (this.pageRoute.path == ("/" + detail.data.dataRoute)) {
                        ComponentHelper.closeBusinessFunction();
                    }

                    var mainApp = document.querySelector("main-app");

                    var dataRoute = detail.data.dataRoute;
                    var contextData = detail.data.contextData;
                    var type = contextData && contextData.itemContext ? contextData.itemContext.type : '';

                    ComponentHelper.setQueryParamsWithoutEncode({ "type": type });
                    mainApp.changePageRoutePath(dataRoute);
                }
            },
            _onUserStoreGetResponse: function (e) {
                //console.log('Received configs ', JSON.stringify(e, null, 2));
                this.set('userStore', e.detail.response.content.configObjects[0].data.contexts[0].jsonData.config);
            },
            _onApplicationConfigReceived: function (e) {
                //console.log('Received configs ', JSON.stringify(e, null, 2));
                this.set('applicationConfig', e.detail);
                this.set('menuItems', []);
                this.set('menuItems', this.getConfig('rock-navmenu'));
                this.set('appRepository', this.getConfig('app-repository'));
                this.set('disclaimerMessages', this.getConfig('rock-disclaimer'));
                this.set('hotlineSettings', this.getConfig('hotline-settings'));

                var globalSettings = this.getConfig('global-settings');
                this.initGlobalSettings(globalSettings);

                var _tenantConfig = this.getConfig('tenant-config');
                if (_tenantConfig) {
                    this.tenantLogo = _tenantConfig.logoUrl;
                    this.tenantLogoText = _tenantConfig.tenantName;

                    if (!_.isEmpty(_tenantConfig.mainLogoUrl)) {
                        this.mainLogo = _tenantConfig.mainLogoUrl;
                    }

                    document.querySelector("#mainAppSpinner").tenantLogoText = this.tenantLogoText;
                    this.shadowRoot.querySelector("#headerLayout").removeAttribute("visibility-hidden");

                } else {
                    alert("Configuration not found for User:" + this._userDetails.userName);
                    RUFUtilities.Logger.error("Configuration not found for user");
                }
            },
            _isUserStoreNeeded: function (tenantId, isAuthenticated) {
                if (tenantId && tenantId != "" && !isAuthenticated) {
                    return true;
                } else {
                    return false;
                }
            },

            _startPreload: function () {
                var contextData = {};
                contextData[ContextHelper.CONTEXT_TYPE_USER] = [{ 'user': this._userDetails.userName, 'role': this._userDetails.roleId }];

                var liquidDataObjectPreLoad = this.shadowRoot.querySelector('#liquidDataObjectPreLoad');
                liquidDataObjectPreLoad.contextData = contextData;
                liquidDataObjectPreLoad.generateRequest();
                this._appViewOpened = false;
            },

            _onRequestTrackerChange: function (e) {
                var loadingTexts = ["Loading configurations...", "Loading apps...", "Launching your app..."];
                var preloadElement = document.querySelector("#mainAppSpinner");
                var progressMaxValue = preloadElement.progressMaxValue;
                preloadElement.progressValue = (progressMaxValue / e.detail.all.sent) * e.detail.all.received;
                var loadingTextsIndex = parseInt(preloadElement.progressValue / 300);
                if (loadingTextsIndex >= 0) {
                    preloadElement.loadingText = loadingTexts[loadingTextsIndex];
                }
            },

            _onPreloadCompleted: function (e) {
                document.querySelector("#mainAppSpinner").active = false;
                document.querySelector("main-app").removeAttribute("visibility-hidden");
                this.shadowRoot.querySelector("#drawerLayout").removeAttribute("visibility-hidden");
                this._appViewOpened = true;
            },

            _onViewMinimize: function (e, customArgs) {
                this._updateActiveItemsAppStatus(customArgs);
            },

            _onAppStatusChanged: function (e, customArgs) {
                this._updateActiveItemsAppStatus(customArgs);
            },

            _updateActiveItemsAppStatus: function (customArgs) {
                var viewIndex;
                for (var i = 0; i < this.activeItems.length; i++) {
                    var viewName = ComponentHelper.getViewNameWithQueryParams(this.activeItems[i].queryParams, this.activeItems[i].data_route);
                    if (viewName == customArgs.viewName) {
                        viewIndex = i;
                        break;
                    }
                }
                var appInstance = customArgs.contentView.shadowRoot.querySelector(".view-component");
                if (viewIndex >= 0 && appInstance && appInstance.getAppCurrentStatus) {
                    var appStatus = appInstance.getAppCurrentStatus(this.activeItems[viewIndex]);
                    var activeItems = this.activeItems;
                    activeItems[viewIndex].appStatus = appStatus;
                    this.activeItems = [];
                    this.set("activeItems", activeItems);
                }
            },

            _updateActiveItemsAppStatusTitle: function (customArgs) {
                var activeItems = DataHelper.cloneObject(this.activeItems);
                for(var j=0; j<activeItems.length;j++) {
                    if(JSON.stringify(activeItems[j].queryParams) == JSON.stringify(customArgs.detail.queryParams)){                           
                        activeItems[j].appStatus.title = customArgs.detail.title;
                        break;
                    }
                }                     
                if(activeItems.length > 0) {
                    this.activeItems = [];
                    this.set("activeItems", activeItems);
                }               
            },
            
            _onHotlineChange: function() {
                if (this.hotlineModeEnabled) {
                    this._triggerHotlineTimer();
                } else {
                    this.cancelDebouncer("hotlineTimer");
                }
            },

            _triggerHotlineTimer: function () {
                var timer = 1800000; // Default 30 min
                if (this.hotlineSettings && this.hotlineSettings.timer) {
                    timer = this.hotlineSettings.timer;
                }

                this.debounce('hotlineTimer', function () {
                    if (this.hotlineModeEnabled) {
                        this._setDialog(true);
                    }
                }, timer);
            },

            _onHotlineContinue: function () {
                this._setDialog(false);
                this._triggerHotlineTimer();
            },

            _onHotlineCancel: function () {
                this._setDialog(false);
                this.hotlineModeEnabled = false;
            },

            _setDialog: function (openDialog) {
                var hotlineDialog = this.$$('#hotlineDialog');
                if (hotlineDialog) {
                    if (openDialog) {
                        hotlineDialog.open();
                    } else {
                        hotlineDialog.close();
                    }
                }
            },

            _isHotlineAllowed: function () {
                if (_.isEmpty(this.hotlineSettings)) {
                    return false;
                }

                if (this.hotlineSettings.isAllowed) {
                    return true;
                }

                return false;
            }
        });
    </script>
</dom-module>