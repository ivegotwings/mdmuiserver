<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-save/liquid-config-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-bulk-file-upload/pebble-bulk-file-upload.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<!--
<b><i>Content development is under progress... </b></i> 
@demo demo/index.html
-->


<dom-module id="rock-asset-upload">
    <template>
        <style include="bedrock-style-common">
            .placeHolder {
                width: 880px;
                --height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }

            #content-actions {
                padding-top: 30px;
                position: fixed;
                bottom: 0;
                background: rgba(255, 255, 255, 0.80);
                text-align: center;
                width: 100%;
                z-index: 9999;
            }

            #content-label {
                box-shadow: 0 1px 7px 0 var(--palette-cloudy-blue, #c1cad4);
                padding: 15px;
                margin: 10px;
            }

            #image-container {
                width: 30px;
                height: 35px;
                vertical-align: middle;
            }

            import-log {
                vertical-align: middle;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
                color: var(--palette-steel-grey, #75808b);
            }
        </style>

        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-config-get id="getUserProfile" operation="getbyids" request-id="req2" request-data="[[_profileRequest]]" on-response="_onProfileGetResponse"></liquid-config-get>

        <liquid-rest id="assetUploadService" url="" method="POST" request-data={{_assetUploadRequest}} on-liquid-response="_onAssetUploadLiquidSuccess" on-liquid-error="_onAssetUploadLiquidFailure"></liquid-rest>

        <div id="content-asset-upload" hidden>
            <p class="title"><strong>Profile Name:</strong> [[importProfileName]]</p>
            <div class="placeHolder p-10">
                <pebble-bulk-file-upload accept="image/*" target="/data/file-upload"></pebble-bulk-file-upload>
                <bedrock-pubsub on-bedrock-event-pebble-bulk-file-upload-success="_onFileUploadSuccess" name="bedrock-event-pebble-bulk-file-upload-success"></bedrock-pubsub>
            </div>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-asset-upload",

                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    importProfileName: {
                        type: String
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the contexts which are retrieved from the "Microsoft's Excel".
                     */
                    contexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _assetUploadRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _entitiesData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _entities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _fileName: {
                        type: String
                    },
                    _currentBatchNumber: {
                        type: Number,
                        value: 0
                    },
                    _batchSize: {
                        type: Number,
                        value: 10
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _newEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _faultedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _currentEntityIndex: {
                        type: Number
                    },
                    _currentAction: {
                        type: String,
                        value: "create"
                    },
                    _profileName: {
                        type: String,
                    },
                    _profileRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    _profileSaveRequest: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    businessFunctionData: {
                        type: Object,
                        value: function() { return {}; }
                    }
                },
                observers: [
                    '_contextChanged(contextData)'
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                ready: function () {
                },
                _contextChanged: function (contextData) {
                    //Question: Is context based upload supported?
                    if (contextData != undefined) {
                        this.importProfileName = 'imageMetadataConfig';
                        var req = {
                            "params": {
                                "query": {
                                    "id": this.importProfileName,
                                    "filters": {
                                        "typesCriterion": [
                                            "metadataConfig"
                                        ]
                                    },
                                    "contexts": [{
                                        "app": "DAM",
                                        "service": "assetMetadataService",
                                        "list": "self"
                                        }]
                                    },
                                    "fields": {
                                         "jsonData": true
                                    }
                                }
                            };
                        this.set("_profileRequest", req);
                        this.shadowRoot.querySelector("#getUserProfile").generateRequest();
                    }                      
                },
                _onProfileGetResponse: function(e) {
                    var response = e.detail.response;
                    var isProfileExist = false;
                    if(response && response.status && response.status.toLowerCase() == "success" && response.content && response.content.configObjects) {
                        if(response.content.configObjects.length > 0) {
                            var configObjects = response.content.configObjects;
                            var assetUploadProfile = configObjects.find(obj => obj.id == this.importProfileName);
                            if(assetUploadProfile) {
                                this._showView("asset-upload");
                                isProfileExist = true;                                
                            }
                        }
                    }

                    if(!isProfileExist) {
                        this.showErrorToast("Asset upload profile '" + this.importProfileName + "' is missing. Please contact your administrator");
                    }
                },
                _onFileUploadSuccess: function (e, detail, sender) {
                    this._isDirty = true;
                    this._loading = true;
                    var assetUploadRequest = {
                        "filesData": detail,
                        "profileName": this.importProfileName
                    };
                    this.set("_assetUploadRequest", assetUploadRequest);
                    var liq = this.shadowRoot.querySelector("#assetUploadService");
                    if (liq) {
                        liq.url = "/asset/upload";
                        liq.generateRequest();
                    }
                },
                _onAssetUploadLiquidSuccess: function (e) {
                    var response = e.detail.response;
                    if(response && response.response && response.response.status && response.response.status.toLowerCase() == "success") {
                        var data = {
                            "messages": [
                                {
                                    "message": "Asset upload is in process."
                                },
                                {
                                    "message": "You can view the status of the processing in the File Upload Status Dashboard"
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Take Me back to Where I started"
                                },
                                {
                                    "name": "nextAction",
                                    "text": "Take me to File Upload Status",
                                    "dataRoute": "dashboard"
                                }
                            ]
                        };
                        this.businessFunctionData = data;
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName,
                            data: { "skipNext": false }
                        };
                        setTimeout(() =>{
                            this._loading = false;
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 5000);
                    } else {
                        this.logWarning("AssetUploadFail","response",JSON.stringify(e.detail.response));
                        this.showErrorToast("Unable to upload. Please check the service or contact your administrator.");
                        this._isDirty = false;
                        this._loading = false;
                        this.shadowRoot.querySelector('pebble-bulk-file-upload').reset();
                    }
                },
                _onAssetUploadLiquidFailure: function (e) {
                    this.logWarning("AssetUploadLiquidFailure","response",JSON.stringify(e.detail));
                    this.showErrorToast("Unable to upload. Please check the service or contact your administrator.");
                    this._loading = false;
                    this._isDirty = false;
                    this.shadowRoot.querySelector('pebble-bulk-file-upload').reset();
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                getIsDirty: function () {
                    return this._isDirty;
                },
                _showView: function (viewName) {
                    if (viewName) {
                        var contentView = this.shadowRoot.querySelector("#content-" + viewName);
                        if (contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },
            });
        })();
    </script>
</dom-module>