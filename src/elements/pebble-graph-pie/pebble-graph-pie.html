<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<script src="https://d3js.org/d3.v3.min.js"></script>

<!--
<script src="//cdnjs.cloudflare.com/ajax/libs/polymer/0.5.0/polymer.js"></script>
`<pebble-graph-pie>` Represents an element that displays a pie chart.

### Example

    <template is="dom-bind">
	  </template>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------

@group rock Elements
@element rock-entity-todo
@demo demo/index.html
-->
<dom-module id="pebble-graph-pie">
  <polymer-element name="pebble-graph-pie">
    <template>
      <style is="custom-style" include="iron-flex iron-flex-alignment">
        :host {
            display: block;
            height: 500px;
        }

        *:focus {
          outline: 0;
        }

        text {
          fill: white;
        }

        .controls {
          display: inline-block;
          margin: 0 0 0 20px;
        }

            svg {
              float: right;
              margin: -5% 3% 0 0;
            }

        .arc path {
          stroke: #fff;
        }

        .legend {
          font-size: 12px;
        }
        rect {
          stroke-width: 2;
        }
  
        </style>
      <paper-button id="pie-button" on-tap="handleTap" raised >Reset Pie</paper-button>
      <svg id="svg"></svg>
    </template>
    <script>
      Polymer({
        is: 'pebble-graph-pie',

        properties: {
          /**
           * Fired when user selects or deselects an item.
           *
           * @event selection-changed (pub-sub event)
           * @param {Object} selectedItem
           */

          /*
           *
           */
          data: {
            type: Array,
            value: [],
            observer: "_onDataChanged"
          }
        },

        behaviors: [
          RUFBehaviors.UIBehavior,
        ],

        createElements: function () {
          var width = 800,
            height = 500,
            radius = Math.min(width, height) / 2.1;

          this.color = d3.scale.ordinal().range(["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"]);

          this.arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

          this.pie = d3.layout.pie()
            .sort( function(d) { return null; } )
            .value(function (d) {
              return d.value;
            });

          this.svg = d3.select(this.$.svg)
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            
        },

        drawChart: function () {
          arr = [];
          var width = 500,
          height = 500,
          radius = Math.min(width, height) / 2.1;
          var legendRectSize = 18;
          var legendSpacing = 4;
          var me = this;
          me.data.forEach(function (d) {
            d.value = +d.value;
          });

          me.g = me.svg.selectAll("g.arc")
            .data(me.pie(me.data))
            .enter().append("g")
            .attr("class", "arc");

          me.g.append("path")
            .attr("d", me.arc)
            .style('outline', 0)
            .style("fill", function (d) {
              return me.color(d.data.key);
            })

          var legend = me.svg.selectAll('.legend')
          .data(me.color.domain())
          .enter()
          .append('g')
          .attr('class', 'legend')
          .attr('transform', function(d, i) {
            var height = legendRectSize + legendSpacing;
            var offset =  height * me.color.domain().length / 2;
            var horz = 15 * legendRectSize;
            var vert = i * height - offset;
            return 'translate(' + horz + ',' + vert + ')';
          });

          legend.append('rect')
            .attr('width', legendRectSize)
            .attr('height', legendRectSize)
            .style('fill', me.color)
            .style('stroke', me.color)
            /*.style('stroke-width', 3);*/

          legend.append('text')
            .attr('x', legendRectSize + legendSpacing)
            .attr('y', legendRectSize - legendSpacing)
            .text(function(d) { return d; });

          legend.on("click", function(d, index){              
              var g = me.g[0][index];
              var d = d3.select(me.g[0][index]).datum();
              d3.select(g)
                  .transition()
                  .duration(400)
                  .attr("transform",function(d){
                      if (!d.data._expanded){
                          d.data._expanded = true;
                          me._fireSelectionEvent(d);
                          var a = d.startAngle + (d.endAngle - d.startAngle)/2 - Math.PI/2;
                          var x = Math.cos(a) * 20;
                          var y = Math.sin(a) * 20;
                          return 'translate(' + x + ',' + y + ')';                
                      } else {
                          d.data._expanded = false;
                          me._fireSelectionEvent2(d);
                          return 'translate(0,0)';                
                      }                
                });
            });

          me.g.on("click", function (d) {
              d3.select(this)
                  .transition()
                  .duration(400)
                  .attr("transform",function(d){
                      if (!d.data._expanded){
                          d.data._expanded = true;
                          me._fireSelectionEvent(d);
                          var a = d.startAngle + (d.endAngle - d.startAngle)/2 - Math.PI/2;
                          var x = Math.cos(a) * 20;
                          var y = Math.sin(a) * 20;
                          return 'translate(' + x + ',' + y + ')';                
                      } else {
                          d.data._expanded = false;
                          me._fireSelectionEvent2(d);
                          return 'translate(0,0)';                
                      }                
                });
            });

          me.g.filter(function(d) { return d.endAngle - d.startAngle > .2; }).append("text")
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .attr("transform", function(d) { 
              d.outerRadius = radius; 
              d.innerRadius = radius/2; 
              return "translate(" + me.arc.centroid(d) + ")rotate(" + angle(d) + ")";
            })
            .style("fill", "White")
            .style("font", "bold 12px Arial")
            .text(function(d) { return d.data.key + " - " + d.data.value; });

          function angle(d) {
            var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
            return a > 90 ? a - 180 : a;
          }
        },


        handleTap: function(d) {
              d3.selectAll('.arc')
                  .transition()
                  .duration(400)
                  .attr("transform",'translate(0,0)');
                  location.reload();
        },
        _fireSelectionEvent: function (d) {
          //console.log('firing tap event with data ', JSON.stringify(d));
          this.fireBedrockEvent('selection-changed', d, { bubbles: true });
          arr.push(d.data);
          console.log('dynamic array includes ', JSON.stringify(arr));
        },   

        _fireSelectionEvent2: function (d) {  
        //console.log('firing tap event with data ', JSON.stringify(d));
        arr.splice(d.data, 1);
        console.log('dynamic array includes ', JSON.stringify(arr));
        }, 

        refreshChart: function () {
          var me = this;
          me.g.data(me.pie(me.data))
            .select("path").attr("d", me.arc);

          me.g.select("text")
            .attr("transform", function (d) {
              return "translate(" + me.arc.centroid(d) + ")";
            });
        },

        _onDataChanged: function () {
          if (this.data && this.data.length > 0) {
            this.createElements();
            this.drawChart();
          }
        },
                
      });
    </script>
  </polymer-element>
</dom-module>