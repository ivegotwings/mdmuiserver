<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<!--<link rel="import" href="../../../bower_components/d3/d3.html">-->
<script src="https://d3js.org/d3.v3.min.js"></script>

<!--
<script src="//cdnjs.cloudflare.com/ajax/libs/polymer/0.5.0/polymer.js"></script>
`<pebble-graph-pie>` Represents an element that displays a pie chart.

### Example

    <template is="dom-bind">
	  </template>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------

@group rock Elements
@element rock-entity-todo
@demo demo/index.html
-->
<dom-module id="pebble-graph-pie">
<polymer-element name="pebble-graph-pie">
    <template>
         <style is="custom-style" include="iron-flex iron-flex-alignment">
            :host {
                display: block;
                height: 500px;
            }
            *:focus {
              outline:0;
            }
            text {
              fill: white;
            }
            .controls {
              display: inline-block;
              margin: 0 0 0 20px;
            }
            svg {
              float: right;
              margin: 0 15% 0 0;
            }
            .arc path {
              stroke: #fff;
            }
        </style>
        <svg id="svg"></svg>
    </template>
    <script>
        Polymer({
         is: 'pebble-graph-pie',
         properties: {
           data: {
             type: Array,
             value: []
           },
         },    
              createElements: function () {
              var width = 500,
                  height = 500,
                  radius = Math.min(width, height) / 2;
              this.color = d3.scale.ordinal()
                  .range(["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"]);
              this.arc = d3.svg.arc()
                  .outerRadius(radius - 10)
                  .innerRadius(0);
              this.pie = d3.layout.pie()
                  .sort(null)
                  .value(function(d) { return d.amount; });
              this.svg = d3.select(this.$.svg)
                  .attr("width", width)
                  .attr("height", height)
                  .append("g")
                  .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
            },
            drawChart: function () {
              var me = this;
              me.data.forEach(function(d) {
                d.amount = +d.amount;
              });
              me.g = me.svg.selectAll(".arc")
                  .data(me.pie(me.data))
                  .enter().append("g")
                  .attr("class", "arc")
              me.g.append("path")
                  .attr("d", me.arc)
                  .style('outline', 0)
                  .style("fill", function(d) { return me.color(d.data.type); })
                  .on("click", function(d) {
                        d3.select(this)
                        .style('outline', 0)
                      })
                  .on("blur", function(d) {
                        d3.select(this)
                        .attr('opacity', 1)
                        .style('outline', 0)
                      })
              me.g.append("text")
                  .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; })
                  .attr("dy", ".35em")
                  .style("text-anchor", "middle")
                  .text(function(d) { return d.data.type; });
              me.g.append("text")
                  .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; })
                  .attr("dy", 30)
                  .style("text-anchor", "middle")
                  .text(function(d) { return d.data.amount; });
            },
            refreshChart: function () {
              var me = this;              
              me.g.data(me.pie(me.data))
                .select("path").attr("d", me.arc);
              me.g.select("text")
                .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; });
            },
            
            hresponse: function (data) {
              var me = this;
              me.drawChart();
              me.data = data;
              //console.log(JSON.stringify(data))
            },
            attached: function () {
              this.createElements();
              this.hresponse();
            },
            urlChanged: function (oldValue, newValue) {
              if(newValue && oldValue) {
              this.hresponse();
              }
            }
        });
    </script>
</polymer-element>
</dom-module>

