<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../pebble-iframe/pebble-iframe.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html" />

<dom-module id="rock-analytics-widget">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem"></style>
        <div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <template is="dom-if" if="{{urlUnavailable}}">
                    <div class="msg default-message">
                        Analytics system is unavailable.
                        <template is="dom-if" if="{{iframeloadfailed}}">
                            <span> Try reloading after some time.</span>
                        </template>
                    </div>
                </template>
            </div>
            <div class="base-grid-structure-child-2">
                <template is="dom-if" if="{{!urlUnavailable}}">
                    <pebble-iframe timeout="[[timeout]]" source="[[url]]"></pebble-iframe>
                </template>
            </div>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-analytics-widget",

                properties: {
                    url: {
                        type: String,
                        value: ''
                    },
                    timeout: {
                        type: Number,
                        value: 30000
                    }
                },

                ready: function () {
                    this.urlUnavailable = _.isEmpty(this.url);
                    this.addEventListener('iframe-load-failed', function () {
                        this.urlUnavailable = true;
                        this.iframeloadfailed = true;
                    });
                    this.addEventListener('iframe-load-success', function () {
                        this.urlUnavailable = false;
                        this.iframeloadfailed = false;
                    });
                },

                refresh: function () {
                    let iframe = this.shadowRoot.querySelector('pebble-iframe').shadowRoot.querySelector(
                        'iframe');
                    let iframecontainer = this.shadowRoot.querySelector('pebble-iframe');
                    let parentNode = iframe.parentNode;
                    parentNode.removeChild(iframe);
                    let newframe = document.createElement('iframe');
                    newframe.setAttribute('src', this.url);
                    newframe.setAttribute('frameborder', "0");
                    iframecontainer.refresh();
                    let frame = Polymer.dom(iframecontainer.shadowRoot).querySelector(
                        '.intrinsic-container').appendChild(
                        newframe);
                    frame.onload = iframecontainer.onLoad();
                }
            });
        })();
    </script>
</dom-module>