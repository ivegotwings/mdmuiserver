<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="./LiquidRequest.html">
<link rel="import" href="./LiquidResponse.html">

<link rel="import" href="./LiquidOperationBase.html">
<link rel="import" href="./FalcorManager.html">
<link rel="import" href="./LiquidOperationInitiateSearch.html">

<script>

    class LiquidOperationGetEntityIdsFromSearchResult extends LiquidOperationBase {
        constructor () {
            super();
        }

        static async execute (liquidRequest, liquidResponse) {
            super.execute(liquidRequest, liquidResponse);
            let options = liquidRequest.options;
            let response = {
                "status": "success",
                "content": {}
            };

            let responsePkg = await this._callSearchResultRecordSize(liquidRequest, liquidResponse);

            if (responsePkg) {
                response.content = await this.format(responsePkg, options);
            }

            liquidResponse.response = response;
            return true;
        }

        static async _callSearchResultRecordSize (liquidRequest, liquidResponse) {
            let options = liquidRequest.options;
            let pathKeys = SharedUtils.DataObjectFalcorUtil.getPathKeys();
            let utils = SharedUtils.DataObjectFalcorUtil;
            let requestId = liquidRequest.requestId;
            let dataIndex = options.dataIndex;
            let requestData = liquidRequest.requestData;

            let searchResultFields = ["requestId", "maxRecords", "totalRecords", "resultRecordSize"];
            let searchResultPath = [pathKeys.root, dataIndex, pathKeys.searchResults, requestId, searchResultFields];

            let responsePkg = await FalcorManager.get(dataIndex, [searchResultPath]);

            if (!utils.isValidObjectPath(responsePkg, "json." + pathKeys.root + "." + dataIndex + "." + pathKeys.searchResults + "." + requestId + ".resultRecordSize")) {
                responsePkg = {};
                responsePkg.json = {};
                responsePkg.json[pathKeys.root] = {};
                responsePkg.json[pathKeys.root][options.dataIndex] = {};
                responsePkg.json[pathKeys.root][options.dataIndex][pathKeys.searchResults] = {};
                responsePkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId] = {};
                responsePkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId]["resultRecordSize"] = 0;
                responsePkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId]["totalRecords"] = 0;
                responsePkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId]["maxRecords"] = 0;
            }

            return responsePkg;
        }

        static async format (responsePkg, options) {
            await super.format(responsePkg, options);
            return await LiquidOperationInitiateSearch.format(responsePkg, options);
        }
    }

</script>