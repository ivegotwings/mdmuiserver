<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-datachannel/bedrock-datachannel.html">

<script>
    class FalcorManager {
        static async get (dataIndex, paths) {
            let model = RUFBehaviors.DataChannel.getModel(dataIndex);
            let res = undefined;

            if (model) {
                res = await model.get.apply(model, paths);
                if(res) {
                    this._removeFalcorKeys(res);
                }
            }

            return res;
        }

        static async getLocal (dataIndex, paths) {
            let model = RUFBehaviors.DataChannel.getModel(dataIndex);
            let localModel = model.withoutDataSource();

            let res = undefined;

            if (localModel) {
                res = await localModel.get.apply(localModel, paths);
                if(res) {
                    this._removeFalcorKeys(res);
                }
            }

            return res;
        }

        static async call (dataIndex, functionPath, args, refSuffixes, thisPaths) {
            let model = RUFBehaviors.DataChannel.getModel(dataIndex);
            let res = undefined;

            if (model) {
                res = await model.call(functionPath, args, refSuffixes, thisPaths);
                if(res) {
                    this._removeFalcorKeys(res);
                }
            }

            return res;
        }

        static async set (dataIndex, jsonGraphEnvelope) {
            let model = RUFBehaviors.DataChannel.getModel(dataIndex);

            if (model) {
                let res = await model.set(jsonGraphEnvelope);
                if(res) {
                    this._removeFalcorKeys(res);
                }
            }
        }

        static _removeFalcorKeys (obj) {
            for (let prop in obj) {
                if (prop === "$__path") {
                    delete obj[prop];
                } else if (typeof obj[prop] === "object") {
                    this._removeFalcorKeys(obj[prop]);
                }
            }
        }
    }
</script>