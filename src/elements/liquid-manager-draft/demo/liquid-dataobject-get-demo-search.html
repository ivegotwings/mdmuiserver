<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../LiquidDataObjectManager.html">
<link rel="import" href="../LiquidRequest.html">
<link rel="import" href="../LiquidResponse.html">

<script type="text/javascript" src="/src/shared/runtime-version-manager.js"></script>
<script type="text/javascript" src="/src/shared/module-version-manager.js"></script>

<dom-module id="liquid-dataobject-get-demo-search">
    <template>
        <div>Response from initiate search: {{initiateSearchResponseStatus}}</div>
    </template>
    <script>
        let versionInfo = {
            'buildVersion': "1.1.1",
            'runtimeVersion': "1.1.1-1",
            'moduleVersions': {
                "entityData": "1.1.1"
            }
        };

        if (SharedUtils && SharedUtils.RuntimeVersionManager) {
            RuntimeVersionManager.setVersion(versionInfo.runtimeVersion);
            console.log('runtime version: ', RuntimeVersionManager.getVersion());
        }

        if (SharedUtils && SharedUtils.ModuleVersionManager) {
        	ModuleVersionManager.initialize(versionInfo.moduleVersions);
        	console.log('module versions: ', JSON.stringify(ModuleVersionManager.getAll()));
        }
        
        (function () {
            'use strict';

            Polymer({
                is: 'liquid-dataobject-get-demo-search',
                properties: {
                    initiateSearchRequestData: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "filters": {
                                            "attributesCriterion": [],
                                            "typesCriterion": ["locale"]
                                        }
                                    },
                                    "fields": {
                                        "attributes": [
                                            "_ALL"
                                        ]
                                    },
                                    "options": {
                                    }
                                }
                            };
                        }
                    },
                    initiateSearchResponseStatus: {
                        type: String,
                        value: "GOD KNOWS!!"
                    },
                    resultedEntities: {
                        type: Object,
                        value: function () { return []; },
                        notify: true
                    },
                    pageSize: {
                        type: Number,
                        value: 100
                    }
                },
                generateRequest: async function () {
                    console.log('sending request...');
                    
                    let liquidRequest = new LiquidRequest("initiatesearch", this.initiateSearchRequestData);

                    let liquidDataObjectManager = new LiquidDataObjectManager();
                    let liquidInitiateSearchResponse = await liquidDataObjectManager.initiateRequest(liquidRequest);

                    this.initiateSearchResponseStatus = liquidInitiateSearchResponse.response.status;
                    console.log('initiate search result entities received with detail', liquidInitiateSearchResponse.response.content.totalRecords, liquidInitiateSearchResponse);
                    
                    liquidRequest.requestId = liquidInitiateSearchResponse.response.content.requestId;
                    liquidRequest.operation = "getsearchresultrange";

                    let liquidGetSearchResultRangeResponse = await liquidDataObjectManager.initiateRequest(liquidRequest);

                    this.liquidGetSearchResultRangeResponseStatus = liquidGetSearchResultRangeResponse.response.status;
                    console.log('get search result range received with detail', liquidGetSearchResultRangeResponse.response.content.totalRecords, liquidGetSearchResultRangeResponse);

                    liquidRequest.operation = "searchandgetrecordsize";
                    let liquidGetSearchResultRecordSizeResponse = await liquidDataObjectManager.initiateRequest(liquidRequest);
                    this.liquidGetSearchResultRecordSizeResponseStatus = liquidGetSearchResultRangeResponse.response.status;
                    console.log('get search result record size received with detail', liquidGetSearchResultRecordSizeResponse.response.content.totalRecords, liquidGetSearchResultRecordSizeResponse);

                    //var getDetailOptions = { 'from': 0, 'to': this.pageSize -1 };

                    //this._makeGetSearchResultDetailCall(getDetailOptions);
                },
                
                _makeGetSearchResultDetailCall: async function (options) {
                    var liqGetSearchResultDetail = this.shadowRoot.querySelector('#liqGetSearchResultDetail');

                    var searchResultId = this.initiateSearchResponse.content.requestId;
                    var totalRecords = this.initiateSearchResponse.content.totalRecords;

                    if(options.from < totalRecords) {
                        var reqData = this.initiateSearchRequestData;
                        reqData.params.options = options;

                        liqGetSearchResultDetail.requestId = searchResultId;
                        liqGetSearchResultDetail.requestData = reqData;

                        liqGetSearchResultDetail.generateRequest();
                    }
                },
                _onGetSearchResultDetailResponse: function (e) {
                    console.log('search result entities received with detail', e.detail, null, 4);

                    this.resultedEntities.push.apply(this.resultedEntities, e.detail.response.entities);

                    var requestedOptions = e.detail.request.requestData.params.options;

                    if(requestedOptions) {
                        requestedOptions.from = requestedOptions.to + 1;
                        requestedOptions.to = requestedOptions.from + (this.pageSize - 1);

                        this._makeGetSearchResultDetailCall(requestedOptions);
                    }
                }
            });
        })();
    </script>
</dom-module>