<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="./LiquidRequest.html">
<link rel="import" href="./LiquidResponse.html">

<link rel="import" href="./LiquidOperationBase.html">
<link rel="import" href="./FalcorManager.html">
<link rel="import" href="./LiquidOperationInitiateSearch.html">

<script>
    class LiquidOperationGetSearchResultRange extends LiquidOperationBase {
        constructor () {
            super();
        }

        static async execute (liquidRequest, liquidResponse) {
            super.execute(liquidRequest, liquidResponse);
            let options = liquidRequest.options;
            let response = {
                "status": "success",
                "content": {}
            };

            let responsePkg = await this._callSearchResultRange(liquidRequest, liquidResponse);

            if (responsePkg) {
                response.content = await this.format(responsePkg, options);
            }

            liquidResponse.response = response;
            return true;
        }

        static async _callSearchResultRange (liquidRequest, liquidResponse) {
            let options = liquidRequest.options;
            let pathKeys = SharedUtils.DataObjectFalcorUtil.getPathKeys();
            let utils = SharedUtils.DataObjectFalcorUtil;
            let requestId = liquidRequest.requestId;
            let dataIndex = options.dataIndex;
            let requestData = liquidRequest.requestData;

            let rangeFound = false;

            let searchResultFields = ["requestId", "maxRecords", "totalRecords", "resultRecordSize"];
            let searchResultPath = [pathKeys.root, dataIndex, pathKeys.searchResults, requestId, searchResultFields];

            let responsePkg = await FalcorManager.get(dataIndex, [searchResultPath]);

            if (utils.isValidObjectPath(responsePkg, "json." + pathKeys.root + "." + dataIndex + "." + pathKeys.searchResults + "." + requestId + ".resultRecordSize")) {
                let searchResultPkg = responsePkg.json[pathKeys.root][options.dataIndex][pathKeys.searchResults][requestId];
                let resultSize = searchResultPkg["resultRecordSize"];

                let from = requestData.params.options && requestData.params.options.from !== undefined ? requestData.params.options.from : 0;
                let to = requestData.params.options && requestData.params.options.to !== undefined ? requestData.params.options.to : resultSize - 1;

                if (from == -1) {
                    from = 0;
                } else if (from >= resultSize) {
                    from = -1;
                }

                if (to == -1) {
                    to = resultSize - 1; //todo: return all records..??? how to stop this??
                }

                let to1 = (to + 1) < resultSize ? to : resultSize - 1;

                if (from != -1) {
                    let searchResultItemsPath = [pathKeys.root, dataIndex, pathKeys.searchResults, requestId, pathKeys.searchResultItems, [{"from": from, "to": to1}]];
                    let itemsPkg = await FalcorManager.get(options.dataIndex, [searchResultItemsPath]);

                    searchResultPkg[pathKeys.searchResultItems] = itemsPkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId][pathKeys.searchResultItems];
                    rangeFound = true;
                } 
            }

            if (!rangeFound) { 
                responsePkg = {};
                responsePkg.json = {};
                responsePkg.json[pathKeys.root] = {};
                responsePkg.json[pathKeys.root][options.dataIndex] = {};
                responsePkg.json[pathKeys.root][options.dataIndex][pathKeys.searchResults] = {};
                responsePkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId] = {};
                responsePkg.json[pathKeys.root][dataIndex][pathKeys.searchResults][requestId][pathKeys.searchResultItems] = {};
            }

            return responsePkg;
        }

        static async format (responsePkg, options) {
            await super.format(responsePkg, options);
            return await LiquidOperationInitiateSearch.format(responsePkg, options);
        }
    }

</script>