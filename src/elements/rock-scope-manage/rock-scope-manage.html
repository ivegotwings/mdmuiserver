<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-card/pebble-card.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">

<link rel="import" href="../rock-scope-selector/rock-scope-selector.html">
<link rel="import" href="../rock-attribute-split-list/rock-attribute-split-list.html">
<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-scope-manage">
    <template>
        <style include="bedrock-style-common bedrock-styles-scroll-bar">
            :host {
                display: block;
                height: 100%;
            }

            .message {
                text-align: center;
            }

            .buttonSection {
                text-align: center;
            }

            #card {
                height: auto;
                padding-bottom: 20px;
            }

            .scope-manage-attribute-list-wrapper {
                min-height: 320px;
            }

            pebble-card {
                --pebble-card-widget-box: {
                    height: 100%;
                    padding-bottom: 10px;
                    margin-top: 0px;
                    margin-right: 0px;
                    margin-bottom: 0px;
                    margin-left: 0px;
                    min-width: auto;
                }
            }

            .card-content {
                height: 100%;
            }

            #cancelButton {
                margin-left: 15px;
            }

            pebble-checkbox {
                margin-left: 5px;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <div class="message">[[_message]]</div>
            </div>
            <div class="base-grid-structure-child-2 relative">
                <div class="button-siblings">
                    <div class="base-grid-structure">
                        <div class="base-grid-structure-child-1">
                            <pebble-card id="card" no-header>
                                <rock-scope-selector id="scopeSelector" selected-scope="[[selectedItems]]" context-data="[[contextData]]" show-title allow-manage-scope
                                    show-settings slot="pebble-card-content">
                                </rock-scope-selector>
                                <bedrock-pubsub event-name="rock-scope-click" handler="_onScopeTagClicked"></bedrock-pubsub>
                                <bedrock-pubsub event-name="rock-scope-edit" handler="_onScopeEditClicked"></bedrock-pubsub>
                                <bedrock-pubsub event-name="rock-scope-loaded" handler="_onScopeLoad"></bedrock-pubsub>
                            </pebble-card>
                        </div>
                        <div class="base-grid-structure-child-2">
                            <pebble-card no-header class="full-height">
                                <pebble-accordion id="accordion" is-collapsed="{{!_isOpened}}" header-text="[[_getHeaderText(_selectedScope)]]" slot="pebble-card-content">
                                    <div slot="accordion-content" class="full-height overflow-auto-y">
                                        <template is="dom-if" if="[[_isOpened]]">
                                            <div class="scope-manage-attribute-list-wrapper full-height">
                                                <rock-attribute-split-list id="splitList" context-data="[[contextData]]" retain-selected-items="[[retainSelectedItems]]"
                                                    selected-items="{{selectedItems}}" config="[[splitListConfig]]"></rock-attribute-split-list>
                                            </div>
                                        </template>
                                    </div>
                                </pebble-accordion>
                            </pebble-card>
                        </div>
                    </div>
                </div>
                <div id="buttonContainer" class="buttonContainer-static">
                    <pebble-button id="cancelButton" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
                    <pebble-button id="DownloadAll" class="btn btn-secondary m-r-5" button-text="Download All Attributes" on-tap="_downloadAll"
                        elevation=1 raised></pebble-button>
                    <pebble-button id="Download" class="focus btn btn-success" button-text="Download" on-tap="_download" elevation=1 raised></pebble-button>
                </div>
            </div>
        </div>
    </template>
    <script>
        class RockScopeManage
            extends Polymer.mixinBehaviors([
                RUFBehaviors.UIBehavior,
                RUFBehaviors.ComponentContextBehavior,
                RUFBehaviors.ComponentConfigBehavior
            ], Polymer.Element) {
            static get is() { return 'rock-scope-manage' }

            ready() {
                super.ready();
            }
            static get properties() {
                return {
                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onContextDataChange'
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },
                    splitListConfig: {
                        type: Object
                    },
                    selectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    retainSelectedItems: {
                        type: Boolean,
                        value: false
                    },
                    _selectedScope: {
                        type: String,
                        value: ""
                    },
                    _isOpened: {
                        type: Boolean,
                        value: true
                    }
                }
            }


            _onContextDataChange() {
                if (!_.isEmpty(this.contextData)) {
                    let context = DataHelper.cloneObject(this.contextData);
                    //App specific
                    let appName = ComponentHelper.getCurrentActiveAppName();
                    if (appName) {
                        context[ContextHelper.CONTEXT_TYPE_APP] = [{
                            "app": appName
                        }];
                    }
                    this.requestConfig('rock-scope-manage', context);
                }
            }
            onConfigLoaded(componentConfig) {
                if (DataHelper.isValidObjectPath(componentConfig, "config.splitListConfig.tabular.fields")) {
                    let splitListConfig = componentConfig.config.splitListConfig;
                    let fields = DataHelper.convertObjectToArray(splitListConfig.tabular.fields);
                    splitListConfig.tabular.fields = fields;
                    this.set("splitListConfig", splitListConfig);
                } else {
                    this.logError("rock-scope-manage - Split list config is not available/proper in config", componentConfig);
                }
            }
            _onScopeTagClicked(e, detail) {
                if (detail && detail.data) {
                    this.selectedItems = [];
                    this.selectedItems = detail.data.scope;
                    this._download();
                }
            }
            _onScopeEditClicked(e, detail) {
                if (detail && detail.data) {
                    this.set("_selectedScope", detail.data);
                    if (!this._isOpened) {
                        this.$.accordion.showContainer();
                        this.$.accordion._transitionEnd();
                    }
                    this.selectedItems = [];
                    this.async(function () {
                        this.selectedItems = detail.data.scope;
                        if (!this.retainSelectedItems) {
                            let splitlist = this.shadowRoot.querySelector("#splitList");
                            if (splitlist) {
                                splitlist.rerenderGrid();
                            }
                        }
                    });
                }
            }
            _onScopeLoad() {
                this._selectedScope = undefined;
                if (typeof this.$.accordion.hideContainer === 'function') {
                    this.$.accordion.hideContainer();
                }
            }
            _save() {
                if (this._selectedScope) {
                    let detail = {
                        "name": this._selectedScope.name,
                        "accesstype": this._selectedScope.accesstype,
                        "selectedScope": this._selectedScope
                    };
                    this.$.scopeSelector.triggerSaveProcess(detail);
                } else {
                    this.$.scopeSelector.isManageScopes = true;
                }
            }
            _downloadAll() {
                this.selectedItems = [];
                let eventDetail = {
                    name: "onNext"
                };
                this.fireBedrockEvent("onNext", eventDetail, { "ignoreId": true });
            }
            _download() {
                if (!this.selectedItems || !this.selectedItems.length) {
                    this.showWarningToast("Select at least 1 attribute for download");
                    return;
                }
                let eventDetail = {
                    name: "onNext"
                };
                this.fireBedrockEvent("onNext", eventDetail, { "ignoreId": true });
            }
            _onCancelTap() {
                let eventDetail = {
                    name: "onCancel"
                };
                this.fireBedrockEvent("onCancel", eventDetail, { "ignoreId": true });
            }
            _getHeaderText(_selectedScope) {
                return this._selectedScope ? "Editing scope:  " + this._selectedScope.name : "Select attributes for download";
            }
        }
        customElements.define(RockScopeManage.is, RockScopeManage)
    </script>
</dom-module>