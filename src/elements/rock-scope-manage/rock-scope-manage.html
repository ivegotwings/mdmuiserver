<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-card/pebble-card.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-accordion/pebble-accordion.html">

<link rel="import" href="../rock-scope-selector/rock-scope-selector.html">
<link rel="import" href="../rock-attribute-split-list/rock-attribute-split-list.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-scope-manage">
    <template>
        <style include="pebble-styles-shared">

            .message {
                text-align: center;
            }

            .buttonSection {
                text-align: center;
            }

            #card{
                height: 100%;
                padding-bottom:20px;
            }
            pebble-card{
                --pebble-card-widget-box:{
                    height:100%;
                    padding-bottom: 10px;
                    margin:0 0 0 0;
                    min-width:auto;
                }
            }
            .card-content
            {
                height: 100%;
                overflow: hidden;
            }
            #buttonContainer{
                margin-top:20px;
                text-align: center;
            }
            #splitList{
                    --table-height: 300px!important;
            }
            #cancelButton{
                margin-left: 15px;
            }

        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div class="message">[[_message]]</div>
        <pebble-card id="card" no-header>
            <rock-scope-selector id="scopeSelector" selected-scope="[[selectedItems]]" context-data="[[contextData]]" show-title allow-manage-scope show-settings>
            </rock-scope-selector>
            <bedrock-pubsub event-name="rock-scope-click" handler="_onScopeTagClicked"></bedrock-pubsub>
            <bedrock-pubsub event-name="rock-scope-edit" handler="_onScopeEditClicked"></bedrock-pubsub>
        </pebble-card>
        <pebble-card  no-header>
            <pebble-accordion id="accordion" is-collapsed="{{!_isOpened}}" header-text="[[_getHeaderText(_selectedScope)]]" default-icon="expand-less" open-icon="expand-more" class="custom-style">
                   <template is="dom-if" if="[[_isOpened]]">
                        <rock-attribute-split-list select-all-fields="{{selectAllFields}}" id="splitList" retain-selected-items="[[retainSelectedItems]]" selected-items="{{selectedItems}}" config="[[splitListConfig]]"></rock-attribute-split-list>

                   </template>
            </pebble-accordion>
        </pebble-card>
        <div id="buttonContainer" >
            <pebble-button id="cancelButton" class="btn btn-secondary m-r-10" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
            <pebble-button id="Download" class="focus btn btn-success" button-text="Download" on-tap="_download" elevation=1 raised></pebble-button>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-scope-manage',

                properties: {

                    /**
                     * <b><i>Content development is under progress... </b></i>
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _message: {
                        type: String
                    },
                    splitListConfig:{
                        type:Object
                    },
                    selectedItems:{
                        type:Array,
                        value:function () {
                            return [];
                        }
                    },
                    retainSelectedItems: {
                        type:Boolean,
                        value:false
                    },
                    _selectedScope:{
                        type:String,
                        value:""
                    },
                    _isOpened:{
                        type:Boolean,
                        value:false
                    },
                    selectAllFields:{
                        type:Boolean,
                        value:false
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                observers: [],
                ready:function () {
                   this.splitListConfig=this.getParentAppConfig("rock-scope-manage","","splitListConfig");
                },

                _onScopeTagClicked: function (e, detail) {
                    if(detail && detail.data ) {
                        this.selectedItems=[];
                        this.selectedItems = detail.data.scope;
                        this._download();
                    }
                },
                _onScopeEditClicked: function (e,detail) {
                    if(detail && detail.data){
                        this.set("_selectedScope",detail.data);
                        this.$.accordion.showContainer();
                        this.selectedItems=[];
                        this.selectedItems = detail.data.scope;
                        if(!this.retainSelectedItems){
                            var splitlist=this.$$("#splitList");
                            if(splitlist) {
                                splitlist.rerenderGrid();
                            }
                        }
                    }
                },
                _save:function () {
                    if( this._selectedScope) {
                        var detail = {
                            "name": this._selectedScope.name,
                            "accesstype": this._selectedScope.accesstype,
                            "selectedScope": this._selectedScope
                        };
                        this.$.scopeSelector.triggerSaveProcess(detail);
                    } else {
                        this.$.scopeSelector.isManageScopes=true;
                    }
                },
                _download:function () {
                    if(this.selectAllFields){
                       this.selectedItems=[{"name":"_ALL"}];
                    } else if(!this.selectedItems || !this.selectedItems.length ){
                        this.showWarningToast("Please select at least 1 attribute for download");
                        return;
                    }
                    var eventDetail = {
                        name:"onNext"
                    };
                    this.fireBedrockEvent("onNext",eventDetail,{"ignoreId":true});
                },
                _onCancelTap:function () {
                    var eventDetail = {
                        name:"onCancel"
                    };
                    this.fireBedrockEvent("onCancel",eventDetail,{"ignoreId":true});
                },
                _getHeaderText:function (_selectedScope) {
                    return this._selectedScope? "Editing scope:  "+ this._selectedScope.name:"Select attributes for download";
                }
            });
        })();
    </script>
</dom-module>