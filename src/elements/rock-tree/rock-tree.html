
<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="rock-tree-list.html" />
<link rel="import" href="../rock-search-bar/rock-search-bar.html" />

<!--

@element rock-tree
Element providing a tree list
@homepage index.html
@demo demo/index.html
-->



<dom-module id="rock-tree">
    <template>
        <style>
         ul{
             margin-left:0;
             margin-bottom:0;
             padding-left:1rem
         }
         :host{width:100%}
        </style>
        <rock-search-bar  placeholder="Enter Search text" query="{{searchKeyword}}" ></rock-search-bar>
        <ul style="margin-top:40px;">
            <template is="dom-repeat" items="{{nav}}">
                <rock-tree-list nav-item="[[item]]" selected="{{selected}}" search-keyword="{{searchKeyword}}" item-path="[[index]]" selected-elem="{{selectedElem}}"></rock-tree-list>
            </template>
        </ul>
    </template>
</dom-module>
<script>
  Polymer({
    is: 'rock-tree',

    properties: {

      /**
      * The name of the currently selected item.
      */
      selected: {
        type: String,
        notify: true,
        observer: '_selectedChange'
      },
      /**
      * A reference to the selected element.
      *
      */
      selectedElem: {
        type: Object,
        notify: true
      },

      /**
      * The user's active search. Triggers a navigation rebuild.
      *
      * @property searchKeyword
      * @type String
      */
      searchKeyword: {
        type: String,
        value: '',
        notify:true
      },
      /**
      * The initial navigation in array form.
      *
      */
      initialNav: {
        type: Array,
        value: function() {return [];}
      },

      /**
      * A model of the current navigation (with search filters or other mutations
      * applied by this component's methods). Calculated with changes from the base
      * property `initialNav` which is defined by this component's parent.
      *
      */
      nav: {
        type: Object,
        notify: true
      }
    },

    /** Observe property changes */
    observers: [
      '_computedNav(initialNav, searchKeyword)'
    ],

    /** Bind events to handler methods */
    listeners: {
      'rock-tree-list-selected-item-changed' : '_launchSelectedChange'
    },
    /**
     * Checks whether there's anything in the search keyword
     */
    _isSearchKeywordTrue: function() {
      return this.searchKeyword;
    },

    /**
    * Called when the "rock-tree-list-selected-item-changed" event is fired. This event
    * is triggered by an item being clicked on.
    *
    */
    _launchSelectedChange: function(selectedItemEvt) {
      var item = selectedItemEvt.detail;
     //todo use this to get selected item
    },
    /**
    * Called when the search Keyword is changed to call the filter on the nav.
    * To ensure we don't do this on every single key down, we have a debounce in place.
    *
    */
    _computedNav: function(navArr, searchKeyword) {
      if (searchKeyword === '') {
        this.set('nav', this.initialNav);
        return;
      }
      this.debounce('navBuild', function() {
        this.set('nav', this._buildNav(navArr, searchKeyword));
      }, 50);
    },

    /**
    * Called when a search keyword is entered, and builds (and returns) a new nav
    * object that only contains the search query.
    *
    */
    _buildNav: function(navArr, searchKeyword) {
      var foundItems = [],
      lowercaseArray;
      for (var i = 0, len=navArr.length; i < len; i++) {
        //build our initial object and populate it.
        var currentObj = {};
        currentObj.text = navArr[i].text;
        currentObj.icon = navArr[i].icon;
        currentObj.src = navArr[i].src;
        currentObj.selected = navArr[i].selected;
        currentObj.opened = true;
        //if the item has children (ie children), recurse and if another array with children is returned, insert that into the object.
        if (navArr[i].children) {
          var tempArr = this._buildNav(navArr[i].children, searchKeyword);
          if (tempArr.length) {
            currentObj['children'] = tempArr;
          }
        }
        //lowercase both the search keyword, and link text, and compare - if there's a match, push it into the array.
        if (navArr[i].text.toLowerCase().indexOf(searchKeyword.toLowerCase()) !== -1 && !navArr[i].children ||
        currentObj.children) {
          foundItems.push(currentObj);
        }
        lowercaseArray=[];
      }
      //returns a rebuilt, filtered nav
      return foundItems;
    }

  });
</script>
