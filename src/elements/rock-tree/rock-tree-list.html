<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html" />
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">


<!--
`rock-tree-list`
Individual tree list which combines to make rock-tree

@demo demo/index.html
-->
<dom-module id="rock-tree-list">
  <template>
    <style include="shared-styles"></style>
    <style>
    :host{
    --iron-icon-width: 1.4em;
    --iron-icon-height: 1.4em;
    }
  li {
      list-style: none;
      margin: 0.5em 0 0.5em 0;
  }
  .flex {
      display: flex;
     align-items:center;
  }

  a:hover {
      color: #0a9ec1
  }
  a:active {
      color: #086e87
  }

   li:hover {
      color: #0a9ec1
  }
  li:active {
      color: #086e87
  }
  ul {
      margin-left: 0;
      margin-bottom: 0.2rem;
      margin-top: 0.2rem;
      padding-left: 1rem
  }

  .arrow-down,
  .arrow-right {
      width: 0;
      height: 0;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-left: 8px solid ;
      padding-right: 2px;
      margin-right:5px;
  }
  .selected {
      color: #0a9ec1!important
  }
  .arrow-down {
      -webkit-transform: rotate(90deg);
      transform: rotate(90deg)
  }

</style>
    <template is="dom-if" if="{{!_hasKids(navItem)}}">
      <li>
        <iron-icon  src="[[navItem.src]]" icon="[[navItem.icon]]" hidden="{{_iconPassed(navItem)}}"></iron-icon>
        <a class$="{{_isItemSelected(navItem.selected)}} nav-lnk" data-name$="{{_removeSpaces(navItem)}}" on-tap="_itemClick"  item-path="0">{{navItem.text}}</a></li>
    </template>
    <template is="dom-if" if="{{_hasKids(navItem)}}">
      <li on-click="_toggle" class="flex  nav-group-lnk">
        <div id="arrow" class$="{{_arrowClass(navItem.opened)}} arrow" data-name$="{{_removeSpaces(navItem)}}"></div>
        <iron-icon   src="[[navItem.src]]" icon="[[navItem.icon]]" hidden="{{_iconPassed(navItem)}}" ></iron-icon>
        <div  data-name$="{{_removeSpaces(navItem)}}">{{navItem.text}}</div>
      </li>
      <iron-collapse id$="collapse_{{_removeSpaces(navItem)}}" opened$="{{navItem.opened}}">
        <ul>
          <template is="dom-repeat" items="{{navItem.children}}">
            <template is="dom-if" if="{{_hasKids(item)}}">
              <iron-icon  id="icon" src="[[item.src]]" icon="[[item.icon]]" hidden="{{_iconPassed(item)}}"></iron-icon>
              <rock-tree-list nav-item="{{item}}" selected="{{selected}}" search-keyword="{{searchKeyword}}" item-path="[[itemPath]].[[index]]" ></rock-tree-list>
            </template>
            <template is="dom-if" if="{{!_hasKids(item)}}">
              <li>
                <iron-icon   src="[[item.src]]" icon="[[item.icon]]" hidden="{{_iconPassed(item)}}" ></iron-icon>
                <a class$="{{_isItemSelected(item.selected)}} nav-lnk"  data-name$="{{_removeSpaces(item)}}" on-tap="_itemClick" item-path="[[itemPath]].[[index]]">{{item.text}}</a></li>
            </template>
          </template>
        </ul>
      </iron-collapse>
    </template>
  </template>
  <script>

  Polymer({

    is: 'rock-tree-list',

    properties: {
      navItem: {
        type: Object,
        value: function() {return {};},
        notify: true
      },
      selected: {
        type: String,
        notify: true
      },
      searchKeyword: {
        type: String,
        value: ''
      }
    },
    listeners: {
       'rock-tree-list-selected-item-changed' : '_openIronCollapseMenus'
    },
    /**
    *  If item.opened is true, return arrow-down, else arrow-right
    *
    **/
    _arrowClass: function(item) {
      return (item) ? 'arrow-down' : 'arrow-right';
    },
    /**
    * called when the rock-tree-list-selected-item-changed event is picked up from inside the component, or its children.
    * Finds the iron collapse element and sets it to show.
     */
    _openIronCollapseMenus: function(e) {
      var menu = Polymer.dom(this.root).querySelector('iron-collapse');
      if (menu) {
        menu.show();
      }
    },
    /*
    * This event is fired when an item is clicked. it passes (in an object): selectedItem, itemType and path.
    * @event rock-tree-list-selected-item-changed
     */
    /*
    *
    * Called on item click - sets the selected path on the selected property. If the searchkeyword has something in , sets the selectedElem to the element itself, so we can refer back to it on reset, if needed.
    * Also fires the rock-tree-list-selected-item-changed event.
     */
    _itemClick: function(evt) {
      var target = evt.target,
          repoName = target.getAttribute('data-name'),
          path = (target.itemPath) ? target.itemPath : (target.getAttribute('item-path') === "0") ? "0" : '';
        this.set('selected', path);
        this.fire('rock-tree-list-selected-item-changed', {selectedItem: repoName,  path:path});
        evt.preventDefault();
    },
    /*
    *
    * Does what the name implies - remove spaces, and lowercases the string passed to it.
    * Used to create the iron-collapse ids, and click targets.
     */
    _removeSpaces: function(name) {
      return name.text.toLowerCase().replace(/ /g, "_");
    },
    /*
    *
    * Called when a menu is clicked on - it toggles the menu, and ensures the arrows on the menu are correct.
    * @method _toggle
     */
    _toggle: function(evt) {
      var arrow = this.$$('#arrow'),
          name = arrow.getAttribute('data-name'),
          //find out if the clicked item has arrow right or down
          arrowRight = arrow.classList.contains('arrow-right'),
          arrowDown = arrow.classList.contains('arrow-down'),
          flipArrowRight = !arrowRight,
          flipArrowDown = !arrowDown;

      this.$$('#collapse_' + name).toggle();

      // and if they do have one of those, set the existing one to false, and missing one to true.
      this.toggleClass('arrow-right', flipArrowRight, arrow);
      this.toggleClass('arrow-down', flipArrowDown, arrow);
    },
    /*
    *
    * Checks whether the selected item has its selected property set to true.
     */
    _isItemSelected: function(selectedItem) {
      return (selectedItem) ? 'selected' : '';
    },
    /*
    *
    * checks whether the item has children.
     */
    _hasKids: function(item) {
      return item.children &&  item.children.length>0;
    },
    _iconPassed:function(item){
      if(item.icon || item.src) {
        return false;
      }
      return true;
    }
  });

</script>
</dom-module>