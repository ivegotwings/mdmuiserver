<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<!--
`rock-image-viewer` Represents an element that displays an image.


@group pebble Elements
@element rock-image-viewer
@demo demo/index.html
-->

<dom-module id="rock-image-viewer">
    <template>
        <style>
            :host {
                display: inline-block;
                overflow: hidden;
                position: relative;
                --iron-image-width: var(--pebble-image-width);
                --iron-image-height: var(--pebble-image-height);
            }
            pebble-image-viewer{
                width:100%;
                height:100%;
            }
        </style>

        <pebble-image-viewer alt="[alt]"  error="{{error}}" fade="[[fade]]" height="[[height]]"
                             loaded="{{loaded}}" loading="{{loading}}" placeholder="[[placeholder]]" position="[[position]]"
                             preload="[[preload]]" prevent-load="[[preventLoad]]" sizing="[[sizing]]" src="[[src]]"
                             width="[[width]]">
        </pebble-image-viewer>
        <liquid-rest id="getThumbnail" url="/pass-through/binaryobjectservice/get" method="POST"  on-liquid-response="_onGetThumbnailResponse">
        </liquid-rest>

    </template>

    <script>
        Polymer({
            is: 'rock-image-viewer',

            properties: {
                /**
                 * Indicates the URL of a primary image.
                 * @type String
                 * @default null
                 */
                src: {
                    type: String,
                    value: "",
                    observer:'_generateGetThumbnailRequest'
                },

                /**
                 * Indicates a short text that is alternative for an image.
                 * @type String
                 * @default null
                 */
                alt: {
                    type: String,
                    value: null
                },

                /**
                 * Specifies whether or not image is prevented from loading.
                 * If it is set to <b>true</b>, then the image is prevented from loading and any placeholder is
                 * shown. This may be useful to prevent 404 requests when binding to the src property that is
                 * known to be invalid.
                 * @type Boolean
                 * @default false
                 */
                preventLoad: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates the sizing option for the image. Valid values are `contain` or `cover` or `null`.
                 * If the value is `contain`,then the full aspect ratio of the image is contained within the
                 * element and is letterboxed. If the value is `cover`, then the image is cropped in order to
                 * fully cover the bounds of the element. If the value is `null`, then the image takes natural size.
                 * @type String
                 * @default null
                 */
                sizing: {
                    type: String,
                    value: null,
                    reflectToAttribute: true
                },

                /**
                 * Specifies whether or not preloading of image is enabled.
                 * If it is set to <b>true</b>, then any change to the `src` property causes the `placeholder`
                 * image to be shown until the new image is loaded.
                 * @type Boolean
                 * @default false
                 */
                preload: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates a placeholder to place a background image.
                 * This image is used as a background or placeholder until the src image is
                 * loaded.  Use of a data-URI for placeholder is encouraged for instant rendering.
                 * @type String
                 * @default null
                 */
                placeholder: {
                    type: String,
                    value: ""
                },

                /**
                 * Specifies whether or not image load has an animation.
                 * If it is set to <b>true</b>, then it causes an image to
                 * fade into place.
                 * @type Boolean
                 * @default false
                 */
                fade: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Specifies whether or not an image is loaded.
                 * If it is set to <b>true</b>, then the image is loaded.
                 * @type Boolean
                 * @default false
                 */
                loaded: {
                    notify: true,
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates a value that tracks the loading state of the image when the `preload`
                 * option is used.
                 * @type Boolean
                 * @default false
                 */
                loading: {
                    notify: true,
                    type: Boolean,
                    value: false
                },

                /**
                 * Specifies that the last set `src` is failed to load.
                 * @type Boolean
                 * @default false
                 */
                error: {
                    notify: true,
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates the width of image. It can be specified via binding or via CSS.
                 * @type number
                 * @default null
                 */
                width: {
                    type: Number
                },

                /**
                 * Indicates the height of image. It can be specified via binding or via CSS.
                 * set via CSS.
                 *
                 * @attribute height
                 * @type number
                 * @default null
                 */
                height: {
                    type: Number
                },

                /**
                 * Indicates the outline of the image thumbnail.
                 * Only `circle` is valid value for this.
                 * If it is set to <b>null</b>, then the outline is box based on the thumbnail dimensions and element style.
                 * @attribute shape
                 * @type String
                 * @default null
                 */
                shape: {
                    type: String,
                    value: null
                },

                /**
                 * Indicates the URL of the background image for primary image.
                 * Background image pops up once thumbnail is clicked.
                 * Thumbnail is clickable if background image source is provided.
                 * @attribute shape
                 * @type String
                 * @default null
                 */
                bigImageSrc: {
                    type: String,
                    value: null
                },

                /**
                 * Indicates the expected alignment of background image with the primary image place holder.
                 * Valid values are `topleft`, `topright`, `bottomleft`, and `bottomright`.
                 * Position is set according to the implied value.
                 * If it is set to <b>null</b>, then the image pop-ups at center with `no-cancel-on-outside-click`, `no-cancel-on-esc-key`, and `with-backdrop`.
                 * Use `--dailog-layout` mixin to set the background image size & styles.
                 * @attribute alignment
                 * @type String
                 * @default null
                 */
                alignment: {
                    type: String,
                    value: 'null'
                } ,
                thumbnailId:{
                    type:String,
                    value:"",
                    observer:'_generateGetThumbnailRequest'
                }
            },
            _generateGetThumbnailRequest:function () {
                if(this.thumbnailId) {
                    var req = {
                        "params": {
                            "query": {
                                "id": this.thumbnailId,
                                "filters": {}
                            },
                            "fields": {}
                        }
                    };
                    req.params.query.filters.typesCriterion = ["imagerendition"];
                    req.params.fields.attributes = ["blob"];
                    var getThumbnailLiquid = this.$$("#getThumbnail");
                    if (getThumbnailLiquid) {
                        getThumbnailLiquid.requestData = req;
                        getThumbnailLiquid.generateRequest();
                    }
                }
            },
            _onGetThumbnailResponse:function (e) {
                var thumbnail;
                if (e.detail && e.detail.response && e.detail.response.response) {
                    var response = e.detail.response.response;
                    if (response.status.toLowerCase() == "success") {
                        var binaryObjects=response.binaryObjects;
                        if(binaryObjects) {
                            var binaryObject=binaryObjects[0];
                            if (binaryObject.data) {
                                thumbnail= binaryObject.data.blob;
                            }
                        }
                    }
                    if(thumbnail) {
                        this.set("src", "data:image;base64," + thumbnail);
                    }
                }
            },

        });
    </script>
</dom-module>
