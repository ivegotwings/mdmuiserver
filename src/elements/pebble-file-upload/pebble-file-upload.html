<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<!--
`pebble-file-upload`
A material design file upload element with drag and drop feature

- It can upload any file
- Can take additional data through properties
Example:
<pebble-file-upload></pebble-file-upload>
TODO:
###Attributes
- small, medium and large sizes

@demo demo/index.html
-->

<dom-module id="pebble-file-upload">
    <template>
        <style include="pebble-styles-shared">
            :host {
                display: block;
                margin: 0 24px;
                @apply(--pebble-file-upload);
            }

            .drop-zone, .progress-zone {
                padding: 40px 0px;
                border: 2px dotted var(--pebble-file-upload-zone-border-color, #D3DAE1);
                @apply(--layout-vertical);
                @apply(--layout-center-center);
                @apply(--pebble-file-upload-zone);
                height: 200px;
            }

            .drop-zone.active {
                border-color: var(--pebble-file-upload-zone-border-color-active, red);
            }

            #main {
                height: 100%;
                background-color: #F9FBFD;
                color: #96A1AB
            }

            #file {
                display: none;
            }

            .with-file {
                opacity: 0;
            }

            .without-file {
                opacity: 1;
            }

            h3 {
                margin-top: 10px;
                margin-bottom: 10px;
            }

            .cancel-icon > iron-icon {
                font-size: 11px;
            }

            .iconButton {
                --iron-icon-height: 12px;
                --iron-icon-width: 12px;
                --iron-icon-fill-color: #EF345D;
                font-size: 11px;
                height: 5px;
                width: 2px;
                float: right;
            }

            #image-container {
                width: 60px;
                height: 50px;
                /*background: #ddd;*/
                /*margin : 10px;*/
            }

            #progress-container {
                width: 80%;
                height: 50px;
                margin-top: 3%;
                margin-bottom: 3%;
            }

            .progress-div {
                display: inline-flex;
            }

        </style>

        <div id="main" class="layout vertical">
            <section id="dropSection" hidden$=[[hasFile]] class$="[[_dropSectionClass]]">
                <iron-icon icon="icons:cloud-upload" class="upload-icon"></iron-icon>
                <h3>Drag &amp; Drop</h3>
                <span>Your files to assets, or <a href="#" on-tap="_selectFile">Browse</a></span>
                <input type="file" id="file" on-change="_manualSelected" multiple$="[[multiple]]" accept$="[[accept]]">
            </section>
            <section id="progressSection" class="progress-zone" hidden$=[[!hasFile]]>
                <div class="progress-div">
                    <pebble-image-viewer alt="Product image." id="image-container" sizing="contain"
                                         src="/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg"></pebble-image-viewer>
                    <div id="progress-container">
                        {{file.name}}

                        <paper-progress value$="{{progress}}" error$="{{error}}"></paper-progress>
                        <template is="dom-if" if$="[[!complete]]">
                            <span>Uploading</span>
                        </template>
                        <template is="dom-if" if$="[[complete]]">
                            <template is="dom-if" if$="[[error]]">
                                <span>Error occured</span>
                            </template>
                            <template is="dom-if" if$="[[!error]]">
                                <span>uploaded</span>
                            </template>
                        </template>

                    </div>
                    <div>
                        <pebble-button class="iconButton" icon="icons:cancel" on-tap="_cancelUpload"></pebble-button>
                    </div>
                </div>
            </section>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-file-upload',
                listeners: {
                    'dragenter': '_onDragEnter',
                    'dragleave': '_onDragLeave',
                    'dragover': '_onDragOver',
                    'drop': '_onDrop'
                },


                /**
                 * Fired when the file has been accepted and ready to use.
                 *
                 * @event file-accepted
                 * @param {File} file A file entry
                 */

                properties: {
                    /**
                     * `target` is the target url to upload the files to.
                     * Additionally by adding '<name>' in your url, it will be replaced by
                     * the file name.
                     */
                    target: {
                        type: String,
                        value: ''
                    },
                    // True when file is dragged over the element.
                    dragging: {
                        type: Boolean,
                        value: false,
                        readOnly: true,
                        notify: true
                    },
                    // Computed css class name for drop section
                    _dropSectionClass: {
                        type: String,
                        computed: '_computeDropSectionClassName(dragging)'
                    },

                    /**
                     * A set of comma-separated strings, each of which is a valid MIME type,
                     * with no parameters.
                     *
                     * Currently this will not work for files dropped into the element.
                     */
                    accept: {
                        type: String
                    },

                    /**
                     * `fileDataName` is the name for the file data in the `formData` object.
                     */
                    fileDataName: {
                        type: String,
                        value: 'file'
                    },

                    progress: {
                        type: Number,
                        value: 10
                    },

                    error: {
                        type: Boolean,
                        value: false
                    },

                    complete: {
                        type: Boolean,
                        value: false
                    },


                    /**
                     *  denotes the max size of file that can be uploaded. It should be in bytes. default limit is 1 MB
                     **/
                    sizeLimit: {
                        type: Number,
                        value: 1048576
                    },

                    /**
                     * `withCredentials` indicates whether or not use xhr's withCredentials on upload
                     */
                    withCredentials: {
                        type: Boolean,
                        value: false
                    },

                    // A file object(s) dropped into the element.
                    file: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    //True if the element received file(s).
                    hasFile: {
                        type: Boolean,
                        value: false,
                        computed: '_computeHasFile(file)'
                    },

                    /**
                     * `headers` is a key value map of header names and values
                     */
                    headers: {
                        type: Object,
                        value: {}
                    },
                },

                _setDragging: function (dragging) {
                    this.dragging = dragging;
                },

                /**
                 *  Handler for opening a file selector
                 */
                _selectFile: function (e) {
                    e.preventDefault();
                    this.$.file.click();
                },

                // Handler for dragenter event.
                _onDragEnter: function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this._setDragging(true);
                },

                _onDragLeave: function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this._setDragging(false);
                },
                _onDragOver: function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this._setDragging(true);
                },
                // Handler for drop event.
                _onDrop: function (event) {
                    this._setDragging(false);
                    event.stopPropagation();
                    event.preventDefault();


                    // Check if multiple upload is allowed
                    if (this.file) {
                        return;
                    }

                    var file = event.dataTransfer.files[0];

                    // Check if filetype is accepted
                    var mimeType = ((file.type !== '') ? file.type.match(/^[^\/]*\//)[0] : null);
                    var fileType = file.name.match(/\.[^\.]*$/)[0];
                    if ((this.accept !== '' && !(this.accept.indexOf(mimeType) > -1) || this.accept.indexOf(fileType) > -1) || file.size > this.sizeLimit) {
                        return;
                    }

                    this.set('error', false);
                    this.set('complete', false);
                    this.set('progress', 0);
                    this.set('file', file);
                    this._uploadFile(file);
                },

                /**
                 * A handler called when the user manually selected the file (not by drag and drop)
                 */
                _manualSelected: function () {
                    var input = this.$.file;

                    if (!input.files.length) {
                        this.set('file', undefined);
                    } else {
                        var file = Array.from(input.files)[0];
                        if (file.size < this.sizeLimit) {
                            this.progress = 0;
                            this.error = false;
                            this.complete = false;
                            this._uploadFile(file);
                            this.set('file', file);
                        }
                    }
                },

                /**
                 *  This function uploads file to the server.
                 * @param file
                 * @private
                 */
                _uploadFile: function (file) {
                    if (!file) {
                        return;
                    }
                    var self = this;

                    var formData = new FormData();

                    // Add additional data to send with the POST variable
                    var addData = this.additional;
                    for (var key in addData) {
                        if (addData.hasOwnProperty(key)) {
                            formData.append(key, addData[key]);
                        }
                    }

                    // Add the file data last to support POSTing to Amazon Web Services S3.
                    formData.append(this.fileDataName, file, file.name);
                    var xhr = file.xhr = new XMLHttpRequest();
                    xhr.withCredentials = this.withCredentials;
                    xhr.upload.onprogress = function (e) {
                        var done = e.loaded, total = e.total;
                        self.set('progress', Math.floor((done / total) * 1000) / 10);
                    };

                    var url = this.target.replace('<name>', file.name);
                    xhr.open('POST', url, true);
                    for (key in this.headers) {
                        if (this.headers.hasOwnProperty(key)) {
                            xhr.setRequestHeader(key, this.headers[key]);
                        }
                    }
                    xhr.onload = function (e) {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            var eventData = {
                                name : "pebble-file-upload-success",
                                data : {
                                    "fileName": file.name
                                }
                            };
                            self.fire('bedrock-event',eventData);
                            self.fire('success', {xhr: xhr});
                            self.set('complete', true);
                            self.set('progress', 100);
                        } else {
                            var eventData = {
                                name : "pebble-file-upload-error",
                                data : {
                                    "error": xhr.response
                                }
                            };
                            self.fire('bedrock-event',eventData);
                            self.set('error', true);
                            self.set('complete', true);
                            self.set('progress', 100);
                            // self.updateStyles();
                            self.fire('error', {xhr: xhr});
                        }
                    };
                    xhr.send(formData);

                },

                /**
                 *  handles cancel of an uploaded file
                 * @param e
                 * @private
                 */
                _cancelUpload: function (e) {
                    e.preventDefault();
                    console.log("called cancel button tap");
                    if (this.file.xhr) {
                        this.file.xhr.abort();
                    }
                    this.file = undefined;
                    this.$.file.value = null;
                    this.set('error', false);
                    this.set('complete', false);
                    this.set('progress', 0);
                },

                /**
                 * Computes class name for dragging section.
                 */
                _computeDropSectionClassName: function (dragging) {
                    var cls = 'drop-zone';
                    if (dragging) {
                        cls += ' active';
                    }
                    return cls;
                },

                /**
                 *  Compute if the element received a file
                 */
                _computeHasFile: function (file) {
                    return !!file;
                },

                /**
                 * Resets the state of the element to the default view.
                 */
                reset: function () {
                    if (this.file.xhr) {
                        this.file.xhr.abort();
                    }
                    this.file = null;
                    this.$.file.value = null;
                    this.set('error', false);
                    this.set('complete', false);
                    this.set('progress', 0);
                }
            });
        })();
    </script>
</dom-module>
