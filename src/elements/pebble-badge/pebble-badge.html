<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../../../bower_components/paper-styles/typography.html">

<!--
`<pebble-badge>` Represents a circular text badge. This shows up on the top right corner of an 
element and indicates a status or a notification. It labels an anchor element specified in the 
`for` attribute. If that does not exist, it centers to the parent node that contains it.

Badges can contain an icon by the addition of the `icon` attribute and setting
it to the identification of the desired icon. However, you must set the
`label` attribute to keep the element accessible. Also note that you have to import
the `pebble-icons` that include the icons you want to use. See the [pebble-icon](../elements/pebble-icon)
for more information on how to import and use icon sets.

### Example

    <div style="display:inline-block">
      <span>Inbox</span>
      <pebble-badge label="3"></pebble-badge>
    </div>

    <div>
      <pebble-button id="btn">Status</pebble-button>
      <pebble-badge icon="favorite" for="btn" label="favorite icon"></pebble-badge>
    </div>

    <div>
      <paper-icon-button id="account-box" icon="account-box" alt="account-box"></paper-icon-button>
      <pebble-badge icon="social:mood" for="account-box" label="mood icon"></pebble-badge>
    </div>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--pebble-badge-background` | The background color of the badge | `--accent-color`
`--pebble-badge-opacity` | The opacity of the badge | `1.0`
`--pebble-badge-text-color` | The color of the badge text | `white`
`--pebble-badge-width` | The width of the badge circle | `20px`
`--pebble-badge-height` | The height of the badge circle | `20px`
`--pebble-badge-margin-left` | Optional spacing added to the left of the badge. | `0px`
`--pebble-badge-margin-bottom` | Optional spacing added to the bottom of the badge. | `0px`
`--pebble-badge` | Mixin applied to the badge | `{}`

### Accessibility

See the docs for `Polymer.IronResizableBehavior` for accessibility features implemented by this element.

@group Pebble Elements
@element pebble-badge
@demo demo/index.html
-->

<dom-module id="pebble-badge">
  <template>
    <style>
      :host {
        display: block;
        position: absolute;
        outline: none;
      }

      :host([hidden]), [hidden] {
        display: none !important;
      }

      iron-icon {
        width: var(--iron-icon-width, 12px);
        height: var(--iron-icon-height, 12px);
      }

      .badge {
        @apply(--layout);
        @apply(--layout-center-center);
        @apply(--paper-font-common-base);

        font-weight: normal;
        font-size: 11px;
        border-radius: 50%;
        margin-top: var(--pebble-badge-margin-top, 0px);
        margin-left: var(--pebble-badge-margin-left, 0px);
        margin-bottom: var(--pebble-badge-margin-bottom, 0px);
        width: var(--pebble-badge-width, 18px);
        height: var(--pebble-badge-height, 18px);
        background-color: var(--white,#fff);
        border:1px solid var(--paper-menu-background-color,#036bc3);
        opacity: var(--pebble-badge-opacity, 1.0);
        color: var(--paper-menu-background-color, #036bc3);

        @apply(--pebble-badge);
      }
    </style>

    <div class="badge">
      <iron-icon hidden$="{{!_computeIsIconBadge(icon)}}" icon="{{icon}}"></iron-icon>
      <span id="badge-text" hidden$="{{_computeIsIconBadge(icon)}}">{{label}}</span>
    </div>
  </template>

  <script>
    Polymer({
      is: 'pebble-badge',

      hostAttributes: {
        role: 'status',
        tabindex: 0
      },

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'iron-resize': 'updatePosition'
      },

      properties: {
        /**
         * Indicates an identification of the element that the badge is anchored to. This element
         * must be a sibling of the badge.
         */
        for: {
          type: String,          
          observer: '_forChanged'
        },

        /**
         * Indicates that the label is shown in the badge. The label is centered and it
         * must have lesser characters.
         */
        label: {
          type: String,          
          observer: '_labelChanged'
        },

        /**
         * Indicates an identification of the pebble-icon. When you give this icon, the badge content uses an
         * `<pebble-icon>` element that displays the given icon identification rather than the
         * label text. However, you can continue to use the label text for
         * accessibility purposes.
         */
        icon: {
          type: String,
          value: ''      
        }
      },

      attached: function() {
        this._updateTarget();
      },

      attributeChanged: function (name) {
        if (name === 'hidden') {
          this.updatePosition();
        }
      },

      _forChanged: function() {
        // The first time the property is set is before the badge is attached,
        // which means we're not ready to position it yet.
        if (!this.isAttached) {
          return;
        }
        this._updateTarget();
      },

      _labelChanged: function() {
        this.setAttribute('aria-label', this.label);
      },

      _updateTarget: function() {
        this._target = this.target;
        this.async(this.notifyResize, 1);
      },

      _computeIsIconBadge: function(icon) {
        return icon.length > 0;
      },

      /**
       * Can be used to return the target element that this badge is anchored to. It is
       * either the element given by the `for` attribute or the immediate parent
       * of the badge.
       */
      get target () {
        var parentNode = Polymer.dom(this).parentNode;
        // If the parentNode is a document fragment, then we need to use the host.
        var ownerRoot = Polymer.dom(this).getOwnerRoot();
        var target;

        if (this.for) {
          target = Polymer.dom(ownerRoot).querySelector('#' + this.for);
        } else {
          target = parentNode.nodeType == Node.DOCUMENT_FRAGMENT_NODE ?
              ownerRoot.host : parentNode;
        }

        return target;
      },

      /**
       * Can be used to re-position the badge relative to its anchor element. This is called
       * automatically when the badge is attached or an `iron-resize` event is
       * fired. For example: if the window is resized or your target is a
       * custom element that implements IronResizableBehavior.
       *
       * Invoke this function in all other conditions when the anchor's positions changes. 
       * For example: If its visibility changes or when you do 
       * a page re-layout manually.
       */
      updatePosition: function() {
        if (!this._target)
          return;

        if (!this.offsetParent)
          return;

        var parentRect = this.offsetParent.getBoundingClientRect();
        var targetRect = this._target.getBoundingClientRect();
        var thisRect = this.getBoundingClientRect();

        this.style.left = targetRect.left - parentRect.left +
            (targetRect.width - thisRect.width / 2) + 'px';
        this.style.top = targetRect.top - parentRect.top -
            (thisRect.height / 2) + 'px';
      }
    })
  </script>
</dom-module>
