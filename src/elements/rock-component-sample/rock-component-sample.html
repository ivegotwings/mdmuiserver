<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/format-helper.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">

<link rel="import" href="../rock-component-config-behavior/rock-component-config-behavior.html">

<script type="text/javascript" src="/src/shared/runtime-version-manager.js"></script>
<script type="text/javascript" src="/src/shared/module-version-manager.js"></script>

<!--

@group rock Elements
@element rock-component-sample
@demo demo/index.html
-->
<dom-module id="rock-component-sample">
    <template>
        <liquid-entity-model-composite-get on-entity-model-composite-get-response="_onCompositeModelGetResponse"></liquid-entity-model-composite-get>
        <liquid-entity-data-get operation="getbyids" on-response="_onHeaderAttributesGetResponse"></liquid-entity-data-get>
        <liquid-entity-govern-data-get operation="getbyids" on-response="_onRunningInstanceReceived" on-error="_onRunningInstanceGetFailed"></liquid-entity-govern-data-get>
    </template>
    <script>

        let versionInfo = {
            'buildVersion': "1.1.1",
            'runtimeVersion': "1.1.1-1",
            'moduleVersions': {
                "entityData": "1.1.1"
            }
        };

        if (SharedUtils && SharedUtils.RuntimeVersionManager) {
            RuntimeVersionManager.setVersion(versionInfo.runtimeVersion);
            console.log('runtime version: ', RuntimeVersionManager.getVersion());
        }

        if (SharedUtils && SharedUtils.ModuleVersionManager) {
        	ModuleVersionManager.initialize(versionInfo.moduleVersions);
        	console.log('module versions: ', JSON.stringify(ModuleVersionManager.getAll()));
        }
        

        class RockComponentSample
            extends Polymer.mixinBehaviors([RUFBehaviors.ComponentContextBehavior, RUFBehaviors.ComponentConfigBehavior], Polymer.Element) {

            static get is() { return 'rock-component-sample' }

            ready() {
                super.ready();
            }

            static get properties() {
                return {};
            }

            /**
            *  
            */
            connectedCallback() {
                super.connectedCallback();
                this.setNoStorageFlag();

                let appContext = {
                    "app": "app-entity-manage"
                };

                let domainContext = {
                    "domain": "thing"
                };

                let dataContext = {
                    "country": "Germany"
                };

                let valueContext = {
                    "source": "internal",
                    "locale": "en-US"
                };

                let itemContext = {
                    "id": "RDWSanityTestRel02",
                    "type": "product"
                };

                let userContext = {
                    "roles": "admin",
                    "defaultRole": "admin",
                    "user": "rdwadmin@riversand.com_user",
                    "tenant": "rdw"
                };

                this.contextData[ContextHelper.CONTEXT_TYPE_APP] = [appContext];
                this.contextData[ContextHelper.CONTEXT_TYPE_DOMAIN] = [domainContext];
                this.contextData[ContextHelper.CONTEXT_TYPE_DATA] = [dataContext];
                this.contextData[ContextHelper.CONTEXT_TYPE_VALUE] = [valueContext];
                this.contextData[ContextHelper.CONTEXT_TYPE_ITEM] = [itemContext];
                this.contextData[ContextHelper.CONTEXT_TYPE_USER] = [userContext];
                
                this.requestConfig('rock-entity-header', this.contextData);
            }

            /**
            *
            */
            disconnectedCallback() {
                super.disconnectedCallback();
            }

            onConfigLoaded(componentConfig) {
                console.log('config received ', JSON.stringify(componentConfig, null, 2));
                //console.log('my config ', JSON.stringify(this.componentConfig, null, 2));
            }

            setNoStorageFlag() {
                let dataStorageEnabled = "true";

                let url = window.location.href;
                if(url.indexOf('nostorage=1') !== -1)
                dataStorageEnabled = "false";

                localStorage.setItem("data-storage-enabled", dataStorageEnabled);
            }
        }

        customElements.define(RockComponentSample.is, RockComponentSample);
    </script>
</dom-module>