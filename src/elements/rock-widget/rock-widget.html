<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">

<link rel="import" href="../pebble-card/pebble-card.html">


<!--
` <rock-widget> ` Represents an element that renders a material design JSON configured card.
  The config can have details about the component that a button, a widget, and an icon can  use.
  The widgets are usually used on the dashboard type of Apps.


@demo demo/index.html 
-->
<dom-module id="rock-widget">
    <template>
        <style include="bedrock-style-common">
            #card{
                height: 100%;
                padding-bottom: 20px;
            }

            pebble-card {
                --pebble-card-widget-box: {
                    height: 100%;
                    padding-bottom: 0;
                    margin-top: 0px;
                    margin-right: 0px;
                    margin-bottom: 0px;
                    margin-left: 0px;
                    min-width: auto;
                }
            }

            .card-content {
                height: calc(100% - 52px);
                overflow: hidden;
            }
        </style>
        <pebble-card id="card" heading="[[_heading]]" header-icon="[[_headerIcon]]" non-maximizable="[[nonMaximizable]]" non-closable="[[nonClosable]]"
            non-draggable="[[nonDraggable]]" icon-buttons="[[_iconButtons]]" on-icon-button-click="_onIconButtonClick">
            <div class="card-content" id="content">
            </div>
            <div class="card-actions" id="actions" hidden$="[[_isHideButtons(_buttons)]]">
            </div>
        </pebble-card>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-widget',

                //ready: function() {
                //  this._removeComponent();
                //  this._renderComponent();
                //},

                properties: {
                    /**
                     * Indicates the configuration for the widget.
                     */
                    config: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_configChanged'
                    },
                    /**
                     * If set as true , it indicates the component is in read only mode
                     */
                    readonly: {
                        type: Boolean,
                        value: false,
                        observer: '_onReadonly'
                    },
                    /**
                    * <b><i>Content development is under progress... </b></i> 
                    */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    /**
                     * 
                     * 
                     */
                    widgetId: {
                        type: String,
                        value: ""
                    },
                    /**
                     * This is a private property and it is not used directly. This is bound to config.component.
                     * Indicates the component that is shown in the card. It is a JSON with information about the component.
                     * 
                     */
                    _component: {
                        type: Object,                        
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * This is a private property and it is not used directly. This is bound to config.buttons.
                     * Indicates the action buttons that are shown in bottom action area of the card.
                     * 
                     */
                    _buttons: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        observer: '_buttonsChanged'
                    },
                    /**
                     * This is a private property and is not used directly. This is bound to config.buttons.
                     * Indicates title of the card.
                     * 
                     */
                    _heading: {
                        type: String,
                        value: "Widget title"
                    },
                    /**
                     * This is a private property and it is not used directly. This is bound to config.buttons.
                     * Indicates the url of the title image of the card.
                     * 
                     */
                    _headerIcon: {
                        type: String,
                        value: "pebble-icons:Dashboard"
                    },
                    /**
                     * Specifies whether or not the card container is closed.
                     * If it is set to <b>true</b>, then the card container is not closable.
                     *
                     */
                    nonClosable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Specifies whether or not the card container is maximized.
                     * If it set to <b>true</b>, then the card container is not maximized.
                     */
                    nonMaximizable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Specifies whether or not the card container's position is draggable.
                     * If it is set to <b>true</b>, then the card is not draggable.
                     *
                     */
                    nonDraggable: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Indicates the list of actions available for the `more icon` on top right corner of the card.
                     * Sample: {
                            "name": "refreshIcon",
                            "label": "Refresh",
                            "icon": "pebble-md-icons:ToolbarRefresh",
                            "showInMoreActions": false
                        }
                     */
                    _iconButtons: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                getControlIsDirty: function () {
                    var component = this.$$('#content').firstElementChild;
                    if (component && component.getControlIsDirty) {
                        return component.getControlIsDirty();
                    }
                },

                _onIconButtonClick: function (e, detail) {
                    var currentComponent = this.shadowRoot.querySelector(this._component.name);
                    var componentRefreshMethod = currentComponent ? typeof (currentComponent.refresh) : undefined;
                    if (componentRefreshMethod == "function") {
                        currentComponent.refresh();
                    } else {
                        this.refresh();
                    }
                },

                _renderComponent: function () {
                    if (this.$.content && this._component && this._component.path) {
                        ComponentHelper.loadContent(this.$.content, this._component, this);
                    }
                },

                _renderButtons: function () {
                    if (this._buttons && this._buttons.length > 0) {
                        for (var i = 0; i < this._buttons.length; i++) {
                            var b = this._buttons[i];
                            var dynamicButton = document.createElement('paper-button');
                            dynamicButton.name = b.name;
                            dynamicButton.innerText = b.label;
                            dynamicButton.setAttribute("click-handler", b.onClick);
                            this.listen(dynamicButton, "click", "_onButtonClick");
                            //dynamicButton.setAttribute("raised","");
                            Polymer.dom(this.$.actions).appendChild(dynamicButton);
                        }
                    }
                },

                _removeComponent: function () {
                    var contentElement = this.$.content;
                    if (contentElement) {
                        ComponentHelper.clearNode(contentElement);
                    }
                },

                _removeButtons: function () {
                    var actionsElement = this.$.actions;
                    if (actionsElement) {
                        ComponentHelper.clearNode(actionsElement);
                    }
                },

                _componentChanged: function () {
                    if(_.isEmpty(this._component))
                        return;
                    this._removeComponent();
                    this._renderComponent();
                },

                _buttonsChanged: function () {
                    this._removeButtons();
                    this._renderButtons();
                },

                _configChanged: function () {
                    //this._removeComponent();
                    //this._removeButtons();

                    //this._renderComponent();
                    //this._renderButtons();
                    
                    //setting all data before rendering.
                    //this will prevent the observer being trigged multiple times
                    let curcomponent = this.config.component;
                    curcomponent.properties = curcomponent.properties || {};
                    curcomponent.properties["context-data"] = this.contextData;
                    this._component = curcomponent;
                    this._componentChanged();
                    this._buttons = this.config.buttons;
                    this._heading = this.config.heading;
                    this._headerIcon = this.config.headerIcon;
                    this._iconButtons = this.config.iconButtons;
                },

                _onButtonClick: function (e) {
                    if (e.target && e.target) {
                        var clickHandler = e.target.getAttribute("click-handler");
                        if (clickHandler) {
                            var c = this.querySelector(".view-component");
                            if (c && c[clickHandler]) {
                                c[clickHandler].apply(c, [{
                                    "widget": this
                                }]);
                            } else if (window[clickHandler]) {
                                window[clickHandler].apply(window, [{
                                    "widget": this
                                }]);
                            }
                        }
                    }
                },

                _isHideButtons: function (buttons) {
                    if (buttons && buttons.length > 0) {
                        return false;
                    } else {
                        return true;
                    }
                },
                ready: function () {
                    var _this = this;
                    setTimeout(function () {
                        _this.fireBedrockEvent("rock-widget-loaded", { widgetId: _this.widgetId, config: _this.config }, { ignoreId: true });
                    }, 0);
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                refresh: function () {
                    this._renderComponent();
                },
                
                _onReadonly: function () {
                    var content = this.shadowRoot.querySelector('#content');
                    if(content && content.firstElementChild) {
                        content.firstElementChild.readonly = this.readonly;
                    }
                }  
            });
        })();
    </script>
</dom-module>