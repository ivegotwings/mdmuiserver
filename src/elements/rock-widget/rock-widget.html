<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../pebble-card/pebble-card.html">
<!--
` <rock-widget> ` Represents a card that a JSON config can configure.
  The config can have details about the component that a button, a widget, and an icon can  use.
  Widgets are normally used on dashboard type of apps.


@demo demo/index.html 
-->
<dom-module id="rock-widget">
  <template>
    <style include="pebble-styles-shared"></style>
    <pebble-card id="card" heading="[[_heading]]" header-icon="[[_headerIcon]]" non-maximizable="[[nonMaximizable]]" non-closable="[[nonClosable]]"
      non-draggable="[[nonDraggable]]" icon-buttons="[[iconButtons]]">
      <div class="card-content" id="content">
      </div>
      <div class="card-actions" id="actions" hidden$="[[_isHideButtons(_buttons)]]">
      </div>
    </pebble-card>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rock-widget',
        
        //ready: function() {
        //  this._removeComponent();
        //  this._renderComponent();          
        //},
        
        properties: {
          /**
           * Indicates the configuration for the widget.
           * Sample JSON: {
                            "heading": "External component like Google Map",  
                            "headerIcon": "icons:language",
                            "component": {
                              "name": "google-map",
                              "path": "../../../../bower_components/google-map/google-map.html",
                              "properties": {
                                "style": "height:400px;min-width:720px;",
                                "latitude": "29.733488",
                                "longitude": "-95.5486638",
                                "zoom": "19",
                                "api-key": "AIzaSyD2v1KKuHzr3AamgY6e3AYYGiAiocYrZZA"
                              }
                            },
                            "buttons": [ {"name":"goBangalore", "label": "Go Bangalore", "onClick": "goBangalore"},
                                        {"name":"goHouston", "label": "Go Houston", "onClick": "goHouston"},
                                        {"name":"getLost", "label": "Get Lost", "onClick": "getLost"} ]
                          }
					 */
          config: {
            type: Object,
            value: function(){
              return {};
            },
            observer: '_configChanged'
          },
          /**
           * This is a private property and it is not used directly. This is bound to config.component.
           * Indicates the component that is shown in the card. It is a JSON with information about the component.
           * 
					 */
          _component: {
            type: Object,
            value: function() {
              return {};
            },
            observer: '_componentChanged'
          },
          /**
           * This is a private property and it is not used directly. This is bound to config.buttons.
           * Indicates the action buttons that are shown in bottom action area of the card.
           * 
					 */
          _buttons: {
            type: Array,
            value: function() {
              return [];
            },
            observer: '_buttonsChanged'
          },
          /**
           * This is a private property and is not used directly. This is bound to config.buttons.
           * Indicates title of the card.
           * 
					 */
          _heading: {
            type: String,
            value: "Widget title"
          },
         /**
           * This is a private property and it is not used directly. This is bound to config.buttons.
           * Indicates the url of the title image of the card.
           * 
           */
          _headerIcon: {
            type: String,
            value: "icons:dashboard"
          },
         /**
           * Specifies whether or not the card container is closed.
					 * If it is set to <b>true</b>, then the card container is not closable.
           *
					 */
          nonClosable : {
            type: Boolean,
            value: false
          },
					/**
           * Specifies whether or not the card container is maximized.
					 * If it set to <b>true</b>, then the card container is not maximized.
				   */
          nonMaximizable : {
            type: Boolean,
            value: false
          },
					/**
          * Specifies whether or not the card container's position is dragged.
					* If it is set to <b>true</b>, then the card is not draggable.
          *
					*/
          nonDraggable : {
            type: Boolean,
            value: false
          },
					/**
          * Indicates the list of actions available in "more" icon on top right corner of the card.
          *
					*/
          iconButtons: {
            type: Array,
            value: function() { return null; }
          }
        },

        _renderComponent: function(){
          if(this.$.content && this._component && this._component.path) {
            this.importHref(this._component.path, 
              function (e) {
                //component file import successful
                var dynamicEl = document.createElement(this._component.name);
                for (var property in this._component.properties) {
                  if (this._component.properties.hasOwnProperty(property)) {
                    var val = this._component.properties[property];
                    if (typeof val == "object") {
                      dynamicEl.setAttribute(property, JSON.stringify(val));
                    }
                    else {
                      dynamicEl.setAttribute(property, val);
                    }
                  }
                }
                dynamicEl.setAttribute("id", "widget-" + this._component.name);
                dynamicEl.setAttribute("class", dynamicEl.getAttribute("class") + " widget-component");
                Polymer.dom(this.$.content).appendChild(dynamicEl);
              },
              function (e) {
                //component file import failed
                //TODO: log this
              }
            );
          }
        },

         _renderButtons: function(){
          if(this._buttons && this._buttons.length > 0) {
            for(var i = 0;i<this._buttons.length;i++) {
              var b = this._buttons[i];
              var dynamicButton = document.createElement('paper-button');
              dynamicButton.name = b.name;
              dynamicButton.innerText = b.label;
              dynamicButton.setAttribute("click-handler", b.onClick);
              this.listen(dynamicButton, "click", "_onButtonClick");
              //dynamicButton.setAttribute("raised","");
              Polymer.dom(this.$.actions).appendChild(dynamicButton);
            }
          }
        },

        _removeComponent: function(){
          var contentElement = this.$.content;
          if(contentElement) {
            while (contentElement.firstChild) {
              Polymer.dom(contentElement).removeChild(contentElement.firstChild);
            }
          }
        },

        _removeButtons: function(){
          var actionsElement = this.$.actions;
          if(actionsElement) {
            while (actionsElement.firstChild) {
              Polymer.dom(actionsElement).removeChild(actionsElement.firstChild);
            }
          }
        },

        _componentChanged: function(){
          this._removeComponent();
          this._renderComponent();
        },

        _buttonsChanged: function(){
          this._removeButtons();
          this._renderButtons();
        },

        _configChanged: function() {
          //this._removeComponent();
          //this._removeButtons();
          
          //this._renderComponent();
          //this._renderButtons();
          this._component = this.config.component;
          this._buttons = this.config.buttons;
          this._heading = this.config.heading;
          this._headerIcon = this.config.headerIcon;
        },

        _onButtonClick: function(e){
          if(e.target && e.target){
            var clickHandler = e.target.getAttribute("click-handler");
            if(clickHandler){
              var c = this.querySelector("#component");
              if(c && c[clickHandler]){
                c[clickHandler].apply(c, [{"widget":this}]);
              }
              else if(window[clickHandler]){
                window[clickHandler].apply(window, [{"widget":this}]);
              }
            } 
          }
        },

        _isHideButtons: function(buttons) {
          if(buttons && buttons.length > 0) {
            return false;
          }
          else {
            return true;
          }
        }

      });
    })();
  </script>
</dom-module>