<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/attribute-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">


<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="../liquid-config-get/liquid-config-get.html">
<link rel="import" href="../liquid-config-save/liquid-config-save.html">

<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-classification-tree/rock-classification-tree.html">
<link rel="import" href="../rock-context-mappings/rock-context-mappings-grid.html">
<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-entity-snapshots">
    <template>
        <style include="bedrock-style-common">
            
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        
        <template is="dom-if" if="[[_isGridConfigLoaded(_gridConfig)]]">
            <pebble-data-table id="snapshots-grid"  items="{{_gridData}}" multi-selection selected-items="{{_selectedItems}}">
                    <data-table-column slot="column-slot" name="Actions">
                        <template>
                            <div id="inputExcelDiv" slot="cell-slot-content" index="[[index]]">
                                <pebble-textbox readonly class="column-text" row-id="[[index]]" no-label-float value="[[item.excelColumn]]"
                                    title="Rollback"></pebble-textbox>
                            </div>
                        </template>
                    </data-table-column>
                    <!-- dynamic column -->
                    <template is="dom-repeat" items="[[_gridConfig]]" as="col" index-as="colIndex">
						<data-table-column slot="column-slot" name="[[col.header]]" column-index="{{colIndex}}" column-object="[[col]]">
                            <template>
                                <div id="inputExcelDiv" slot="cell-slot-content" index="[[index]]">
                                    <span>[[_columnValue(item, column.columnIndex)]]</span>
                                </div>
                            </template>
                        </data-table-column>
                    </template>
                    
                </pebble-data-table>
            </template>
            <div id="buttonContainer" align="center">
                <pebble-button id="cancel" class="btn btn-secondary m-r-5" button-text="Cancel" on-tap="_onCancelTap" elevation=1 raised></pebble-button>
                <pebble-button id="save" class="focus btn btn-success" button-text="Compare" on-tap="_onNextTap" elevation=1 raised></pebble-button>
            </div>
    
        <liquid-rest id="getEntitySnapshots" url="/data/pass-through-snapshot/getsnapshot" method="POST" on-liquid-response="_onSnapshotsReponse">
        </liquid-rest>

    </template>
    <script>
        'use strict';
            
        class RockEntitySnapshots
                    extends Polymer.mixinBehaviors([
                        RUFBehaviors.UIBehavior,
                        RUFBehaviors.ComponentContextBehavior
                    ], Polymer.Element) {
            static get is() { return 'rock-entity-snapshots' }
            
            static get properties() {
                return {
                    entitySnapshotRequest:{
                        type:Object,
                        value:function(){
                            return {};
                        }
                    },
                    _gridConfig:{
                        type:Object,
                        value:function(){
                            return {}
                        }
                    },
                    _gridData:{
                        type:Array,
                        value: function(){
                            return [];
                        }
                    },
                    _selectedItems: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },                    
                    maximamSnapshotCount:{
                        type:Number,
                        value:5
                    }
                }

            }

            connectedCallback(){
                super.connectedCallback();
                this._gridConfig = [{
                                        "name": "version",
                                        "header": "Version"
                                    },{
                                        "name": "label",
                                        "header": "Label"
                                    },{
                                        "name": "published",
                                        "header": "Published"
                                    }]
                var liquidRest = this.shadowRoot.querySelector("#getEntitySnapshots");
                liquidRest.requestData = this._getEntitySnapshotRequest();
                liquidRest.requestData.params.options.snapshotGetMode = "all";
                liquidRest.generateRequest();
            }
            _isGridConfigLoaded(){
                return (this._gridConfig && !_.isEmpty(this._gridConfig))
            }

            _getEntitySnapshotRequest(){
                var contextData = DataHelper.cloneObject(this.contextData);
                var req = DataRequestHelper.createEntityGetRequest(contextData)
                
                req.params.fields.attributes = ["originalObjectId", "originalObjectType", "snapshotLabel", "version"]
                req.params.fields.properties = ["modifiedDate"];
                req.params.options.maxRecords = 100;
                req.params.sort = {
                    "properties": [
                                    {
                                        "modifiedDate": "_DESC",
                                        "sortType": "_DATETIME"
                                    }
                                ]
                }
                return req;
            }

            _onSnapshotsReponse (ev) {
                var entities = [{
                    version:"Current Version"
                }];
                if(DataHelper.isValidObjectPath(ev, "detail.response.response.entities")){
                    var responseEntities = ev.detail.response.response.entities;
                    responseEntities.forEach((entity) => {
                        if(DataHelper.isValidObjectPath(entity, "data.contexts")){
                            var contexts = entity.data.contexts;
                            var modifiedDate;
                            if(entity.properties && entity.properties.modifiedDate){
                                modifiedDate = entity.properties.modifiedDate
                            }
                            if(contexts && contexts.length){
                                contexts.forEach((contextObj) => {
                                    if(contextObj && contextObj.context && contextObj.context.snapshot){
                                        var obj = {};
                                        obj.label = AttributeHelper.getFirstAttributeValue(contextObj.attributes["snapshotLabel"]);
                                        obj.version =  AttributeHelper.getFirstAttributeValue(contextObj.attributes["version"]);
                                        obj.snapshotId = entity.id;
                                        obj.type = entity.type;
                                        obj.published = modifiedDate;
                                        entities.push(obj)
                                    }
                                })
                            }
                        }
                        
                    })
                    
                }
                this.set("_gridData", entities)
            }

            _onCancelTap (e) {
                var eventName = "onCancel";
                var eventDetail = {
                    name: eventName
                }

                this.fireBedrockEvent(eventName, eventDetail, {
                    ignoreId: true
                });
            }

            _onNextTap (e) {

                //Check selectedItems
                if(this._selectedItems && (this._selectedItems.length < 2 || this._selectedItems.length > this.maximamSnapshotCount)){
                    this.showWarningToast("Please select minimun 2 snapshots to compare.")
                    return;
                }
                var data = {selectedItems: this._selectedItems};
                var eventName = "onNext";
                var eventDetail = {
                    name: eventName                        
                }
                this.businessFunctionData = data;
                this.fireBedrockEvent(eventName, eventDetail, {
                    ignoreId: true
                });
            }

            _columnValue (gridData, index) {
                if(gridData && !_.isEmpty(gridData)) {
                    var columnName = this._gridConfig[index].name;
                    return gridData[columnName];
                }
                return ""
            }
        }
            
        customElements.define(RockEntitySnapshots.is, RockEntitySnapshots);

    </script>
</dom-module>
