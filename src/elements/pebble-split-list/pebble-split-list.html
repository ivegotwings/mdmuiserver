<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-padding-margin.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-icons.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-grid-layout.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-heading.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-data-table/data-table-column.html">
 

<!--
`pebble-split-list`

@demo demo/index.html 
-->

<dom-module id="pebble-split-list">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem bedrock-style-heading bedrock-style-grid-layout bedrock-style-icons bedrock-style-padding-margin">
            :host {
                display: block;
                height: 100%;
            }

            .container {
                padding-right: 15px;
                padding-left: 15px;
                margin-right: auto;
                margin-left: auto;
            }

            .leftContainer {
                width: 45%;
                float: left;
                border: solid 1px var(--default-border-color, #c1cad4);
                border-radius: 3px;
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);

            }

            .centerContainer {
                width: 10%;
                float: left;
                vertical-align: middle;
                padding: 25px;
                text-align: center;
            }

            .rightContainer {
                width: 45%;
                float: left;
                border: solid 1px var(--default-border-color, #c1cad4);
                border-radius: 3px;
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);

            }

            .row {
                margin-right: -15px;
                margin-left: -15px;
            }

            #firstButton {
                margin-top: 40%;
            }

            .check-filter {
                flex-basis: 25px!important;
                flex-grow: 0!important;
                overflow: visible!important;
                position: relative;
                padding: 0;
            }

            /* IE edge specific fix for .check-filter */

            _:-ms-lang(x),
            _:-webkit-full-screen,
            .check-filter {
                padding: 10px 0 0 0;
            }

            .moveButtons {
                margin-top: 5px;
                text-align: center;
            }

            pebble-data-table {
                height: 100%;
                overflow-x: hidden;
            }

            h4 {
                margin-left: 10px;
            }

            pebble-data-table data-table-cell[header] {
                --paper-font-caption: {
                    height: 5px;
                };
                --pebble-icon-opacity: {
                    opacity: 1;
                    color: var(--link-text-color, #139ee7);
                };
            }

            pebble-data-table data-table-cell span {
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                display: block;
            }

            data-table-cell,
            data-table-cell[header] {
                padding-top: 3px;
                /*height: auto;*/
                min-width: 0!important;
            }

            data-table-cell:not([header]) [slot=cell-slot-content] {
                width: 100%;
            }

            data-table-cell[header] {
                font-size: var(--font-size-sm, 12px);
                color: var(--palette-cerulean, #036bc3);
                text-transform: uppercase;
                cursor: default;
            }

            data-table-cell:not([header]) {
                min-height: 40px!important;
                height: auto !important;
            }

            data-table-checkbox {
                border-right: none;
                padding: 0 0 0 10px;
                height: auto;
                flex-basis: 25px;
                background: var(--palette-white, #ffffff);
            }
        </style>
        <div class="container full-height">
            <div class="row full-height">
                <div class="leftContainer">
                    <div class="base-grid-structure">
                        <div class="base-grid-structure-child-1">
                            <h4>Available Fields</h4>
                        </div>
                        <div class="base-grid-structure-child-2">
                            <pebble-data-table id="{{leftDataTableId}}" disable-select-all deleted-items="{{deletedItems}}" page-size="[[pageSize]]" size="{{size}}" selection-enabled multi-selection="[[config.tabular.settings.isMultiSelect]]" r-data-source="[[rDataSource]]" items="{{items}}">
                                <template is="dom-repeat" items="[[config.tabular.fields]]" as="col" index-as="colIndex">
                                    <data-table-column slot="column-slot" name="[[col.header]]" column-index="{{colIndex}}" filter-by="[[_isFilterEnabled(col)]]" sort-by="[[_isSortable(col)]]" icon="pebble-icon:action-edit" class="pebble-icon-size-16" column-object="[[col]]">
                                        <template>
                                            <div slot="cell-slot-content" class="cell" title$="[[_columnValue(item,colIndex)]]">
                                                <span>[[_columnValue(item, colIndex)]]</span>
                                            </div>
                                        </template>
                                    </data-table-column>
                                </template>
                            </pebble-data-table>
                        </div>
                    </div>
                </div>
                <div class="centerContainer">
                    <pebble-button id="firstButton" class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:action-scope-take-all" on-tap="_moveRightAll"></pebble-button>
                    <pebble-button id="secondButton" class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:action-scope-take-selection" on-tap="_moveRight"></pebble-button>
                    <pebble-button id="thirdButton" class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:action-scope-release-selection" on-tap="_moveLeft"></pebble-button>
                    <pebble-button id="fourthButton" class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:action-scope-release-all" on-tap="_moveLeftAll"></pebble-button>
                </div>
                <div class="rightContainer">
                    <div class="base-grid-structure">
                        <div class="base-grid-structure-child-1">
                            <h4>Selected Fields</h4>
                        </div>
                        <div class="base-grid-structure-child-2">
                            <pebble-data-table id="{{rightDataTableId}}" selection-enabled multi-selection="[[config.tabular.settings.isMultiSelect]]" items="[[selectedItems]]">
                                <template is="dom-repeat" items="[[config.tabular.fields]]" as="col" index-as="colIndex">
                                    <data-table-column slot="column-slot" name="[[col.header]]" column-index="{{colIndex}}" filter-by="[[_isFilterEnabled(col)]]" sort-by="[[_isSortable(col)]]" icon="pebble-icon:action-edit" class="pebble-icon-size-16" column-object="[[col]]">
                                        <template>
                                            <div slot="cell-slot-content" class="cell" title$="[[_columnValue(item,colIndex)]]">
                                                <span>[[_columnValue(item, colIndex)]]</span>
                                            </div>
                                        </template>
                                    </data-table-column>
                                </template>
                            </pebble-data-table>
                        </div>
                    </div>
                    <template is="dom-if" if="[[moveUpDownEnabled]]">
                        <div class="moveButtons">
                            <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:action-less" on-tap="_moveUpRight"></pebble-button>
                            <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:action-expand" on-tap="_moveDownRight"></pebble-button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <script>
        class PebbleSplitList extends Polymer.mixinBehaviors([RUFBehaviors.UIBehavior], Polymer.Element) {
            static get is() {
                return "pebble-split-list";
            }

            static get properties() {
                return {
                    items: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },

                    selectedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },

                    retainSelectedItems: {
                        type: Boolean,
                        value: false
                    },

                    moveUpDownEnabled: {
                        type: Boolean,
                        value: false
                    },

                    pageSize: {
                        type: Number,
                        value: 50
                    },

                    deletedItems: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },

                    rDataSourceId: {
                        type: String
                    },

                    config: {
                        type: Object
                    },

                    size: {
                        type: Number,
                        notify: true
                    },

                    rDataSource: {
                        type: Function,
                        notify: true
                    },
                    
                    /** Set a uniqueId if more than 1 set of split list tables are used in a screen to prevent filtering and sorting mismatches **/
                    uniqueId: {
                        type: String
                    },

                    leftDataTableId: {
                        type: String
                    },

                    rightDataTableId: {
                        type: String
                    },

                    leftTableObj: {
                        type: Object
                    },

                    rightTableObj: {
                        type: Object
                    }
                };
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();                          
            }

            disconnectedCallback() {
                super.disconnectedCallback();
            }

            ready() {
                super.ready(); 
                let leftDataTableId = "leftDataTable";
                let rightDataTableId = "rightDataTable";
                if(this.uniqueId) {
                    leftDataTableId = leftDataTableId+"-"+this.uniqueId;
                    rightDataTableId = rightDataTableId+"-"+this.uniqueId;
                }
                this.set("leftDataTableId", leftDataTableId);
                this.set("rightDataTableId", rightDataTableId);                   
                this.leftTableObj = this.shadowRoot.querySelector('#'+this.leftDataTableId);
                this.rightTableObj = this.shadowRoot.querySelector('#'+this.rightDataTableId);
            }

            _columnValue(gridData, index) {
                if (gridData) {
                    let columnName = this.config.tabular.fields[index].name;
                    return gridData[columnName];
                }
            }

            _isFilterEnabled(col) {
                return col.filterable ? col.name : undefined;
            }

            _isSortable(col) {
                return col.sortable ? col.name : undefined;
            }

            _moveRight() {
                let leftGrid = this.leftTableObj;
                if (leftGrid) {
                    let selectedItems = leftGrid.getSelectedItems();
                    for (let i = 0; i < selectedItems.length; i++) {
                        if (this.selectedItems.indexOf(selectedItems[i]) === -1) {
                            this.push("selectedItems", selectedItems[i]);
                        }
                    }
                    leftGrid.clearSelection();
                    if (!this.retainSelectedItems) {
                        leftGrid.deleteItems(selectedItems);
                    }
                    this.fireBedrockEvent("moveToRight", selectedItems);
                }
            }

            _moveRightAll() {
                let leftGrid = this.leftTableObj;
                if (leftGrid) {
                    let items = leftGrid.getData();
                    for (let i = 0; i < items.length; i++) {
                        if (this.selectedItems.indexOf(items[i]) === -1) {
                            this.push("selectedItems", items[i]);
                        }
                    }
                    leftGrid.clearSelection();
                    if (!this.retainSelectedItems) {
                        leftGrid.deleteItems(items);
                    }
                    this.fireBedrockEvent("moveAllToRight", items);
                }
            }

            _moveLeft() {
                let rightGrid = this.rightTableObj;
                let leftGrid = this.leftTableObj;
                if (rightGrid) {
                    let selectedItems = rightGrid.getSelectedItems();
                    if (!this.retainSelectedItems) {
                        for (let i = selectedItems.length - 1; i >= 0; i--) {
                            let index = this.deletedItems.indexOf(selectedItems[i]);
                            this.splice("deletedItems", index, 1);
                        }
                        this.restoreDeletedItems(leftGrid, selectedItems, this.rDataSource);
                    }
                    for (let i = 0; i < selectedItems.length; i++) {
                        let index = this.selectedItems.indexOf(selectedItems[i]);
                        this.splice("selectedItems", index, 1);
                    }
                    rightGrid.clearSelection();
                    this.fireBedrockEvent("moveToLeft", selectedItems);
                }
            }

            _moveLeftAll() {
                let rightGrid = this.rightTableObj;
                let leftGrid = this.leftTableObj;
                let items = rightGrid.getData();
                if (!this.retainSelectedItems) {
                    this.deletedItems = [];
                    this.restoreDeletedItems(leftGrid, items, this.rDataSource);
                }
                for (let i = 0; i < items.length; i++) {
                    let index = this.selectedItems.indexOf(items[i]);
                    this.splice("selectedItems", index, 1);
                }
                rightGrid.clearSelection();
                this.fireBedrockEvent("moveAllToLeft", items);
            }

            _moveUpRight() {
                let rightGrid = this.rightTableObj;
                let selectedItems = rightGrid.getSelectedItems();
                let _this = this;
                let sortedSelectedItems = selectedItems.sort(function (item1, item2) {
                    return _this.selectedItems.indexOf(item1) - _this.selectedItems.indexOf(item2);
                })
                for (let i = 0; i < sortedSelectedItems.length; i++) {
                    let index = this.selectedItems.indexOf(sortedSelectedItems[i]);
                    if (index > 0) {
                        let temp = this.selectedItems[index - 1];
                        this.selectedItems[index - 1] = this.selectedItems[index];
                        this.selectedItems[index] = temp;
                    }
                }
                let items = this.selectedItems;
                this.selectedItems = [];
                this.selectedItems = items;
            }

            _moveDownRight() {
                let rightGrid = this.rightTableObj;
                let selectedItems = rightGrid.getSelectedItems();
                let _this = this;
                let sortedSelectedItems = selectedItems.sort(function (item1, item2) {
                    return _this.selectedItems.indexOf(item2) - _this.selectedItems.indexOf(item1);
                });
                for (let i = 0; i < sortedSelectedItems.length; i++) {
                    let index = this.selectedItems.indexOf(sortedSelectedItems[i]);
                    if (index < this.selectedItems.length - 1) {
                        let temp = this.selectedItems[index + 1];
                        this.selectedItems[index + 1] = this.selectedItems[index];
                        this.selectedItems[index] = temp;
                    }
                }
                let items = this.selectedItems;
                this.selectedItems = [];
                this.selectedItems = items;
            }

            getSelectedItems() {
                return this.selectedItems;
            }

            getLeftItems() {
                let leftGrid = this.leftTableObj;
                return leftGrid.getData();
            }

            getRightItems() {
                let rightGrid = this.rightTableObj;
                return rightGrid.getData();
            }

            restoreDeletedItems(grid, items, dataSource) {
                if (typeof dataSource === 'function') {
                    this.rerenderGrid();
                } else {
                    for (let i = items.length - 1; i >= 0; i--) {
                        if (this.items.indexOf(items[i]) === -1) {
                            this.unshift("items", items[i]);
                        }
                    }
                }
            }

            rerenderGrid() {
                let grid = this.leftTableObj;
                if (this.rDataSourceId) {
                    let dataSourceElement = ComponentHelper.getParentElement(this).$$('#' + this.rDataSourceId);
                    if (dataSourceElement) {
                        dataSourceElement.resetDataSource();
                    }
                }
                grid.clearCache();
                grid._currentPage = 0;
            }
            
            /**
             * Function to enable or disable the grid items and grid buttons based on the sent flag
             * If disableItems is sent as true, then disable the grid items and grid buttons 
             */ 
            resetGridItems(disableItems) {

                if(!disableItems){
                    disableItems = false;
                }
               
                let leftGridItems = _.union(this.leftTableObj.getData(),this.leftTableObj.getCachedItems());
                let rightGridItems = _.union(this.rightTableObj.getData(),this.rightTableObj.getCachedItems());

                for(let item in leftGridItems) {
                    leftGridItems[item].disabled = disableItems; 
                }
                for(let item in rightGridItems) {
                    rightGridItems[item].disabled = disableItems; 
                } 
                
                let splitListBtn1 = this.shadowRoot.querySelector('#firstButton');
                let splitListBtn2 = this.shadowRoot.querySelector('#secondButton');
                let splitListBtn3 = this.shadowRoot.querySelector('#thirdButton');
                let splitListBtn4 = this.shadowRoot.querySelector('#fourthButton');

                if(disableItems) {
                    splitListBtn1.setAttribute("disabled",disableItems);
                    splitListBtn2.setAttribute("disabled",disableItems);
                    splitListBtn3.setAttribute("disabled",disableItems);
                    splitListBtn4.setAttribute("disabled",disableItems);
                } else {
                    splitListBtn1.removeAttribute("disabled");
                    splitListBtn2.removeAttribute("disabled");
                    splitListBtn3.removeAttribute("disabled");
                    splitListBtn4.removeAttribute("disabled");
                }
            }
        }

        customElements.define(PebbleSplitList.is, PebbleSplitList);
    </script>
</dom-module>