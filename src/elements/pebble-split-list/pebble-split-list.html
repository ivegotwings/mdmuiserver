<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-data-table/data-table-column.html">



<!--
`pebble-split-list`

@demo demo/index.html 
-->

<dom-module id="pebble-split-list">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem">
            .container{
                padding-right: 15px;
                padding-left: 15px;
                margin-right: auto;
                margin-left: auto;
            }
            .leftContainer{
                width:45%;
                float: left;
                border: solid 1px var(--default-border-color, #c1cad4);
                border-radius: 3px;
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);

            }

            .centerContainer{
                width: 10%;
                float: left;
                vertical-align: middle;
                padding: 25px;
                text-align: center;
            }
            .rightContainer{
                width: 45%;
                float: left;
                border: solid 1px var(--default-border-color, #c1cad4);
                border-radius: 3px;
                box-shadow: 1px 2px 5px -1px var(--default-border-color, #c1cad4);

            }
            .row{
                margin-right: -15px;
                margin-left: -15px;
            }
            #firstButton{
               margin-top:40%;
            }
            .check-filter {
                flex-basis: 25px!important;
                flex-grow: 0!important;
                overflow: visible!important;
                position: relative;
                padding: 0;
            }
            /* IE edge specific fix for .check-filter */
           _:-ms-lang(x), _:-webkit-full-screen, .check-filter { 
                    padding:10px 0 0 0;
            }
            .moveButtons{
                margin-top:5px;
                text-align: center;
            }
            pebble-data-table{
                height: var(--table-height,100%);
                overflow-x: hidden;
            }
            h4{
                margin-left: 10px;
            }

            pebble-data-table data-table-cell[header] {
                --paper-font-caption:{
                    height:5px;
                };                
                --pebble-icon-opacity:{
					opacity:1;
                    color: var(--link-text-color, #139ee7);
				};
            }
            pebble-data-table data-table-cell span{
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                display: block;
            } 
            data-table-cell,
			data-table-cell[header] {
				padding-top: 3px;
				/*height: auto;*/
				min-width: 0!important;
			}
            data-table-cell:not([header]) [slot=cell-slot-content] {
				width: 100%;
			}
            data-table-cell[header] {
				font-size: var(--font-size-sm, 12px);
				color: var(--palette-cerulean, #036bc3);				
				text-transform: uppercase;
				cursor: default;	
			}	

			data-table-cell:not([header]) {
				min-height: 40px!important;
				height: auto !important;
			}
            data-table-checkbox {
				border-right: none;
				padding: 0 0 0 10px;
				height: auto;
				flex-basis: 25px;
				background:var(--palette-white, #ffffff);
			}
        </style>
        <div class="container">
            <div class="row">
                <div class="leftContainer">
                        <h4>Available Fields</h4>
                    <pebble-data-table id="leftDataTable" disable-select-all deleted-items="{{deletedItems}}" page-size="[[pageSize]]"  size="{{size}}" selection-enabled multi-selection="[[config.tabular.settings.isMultiSelect]]" r-data-source="[[rDataSource]]"  items="{{items}}">
                        <template is="dom-repeat" items="[[config.tabular.fields]]" as="col" index-as="colIndex">
                            <data-table-column slot="column-slot" name="[[col.header]]" column-index="{{colIndex}}" filter-by="[[_isFilterEnabled(col)]]" sort-by="[[_isSortable(col)]]"
                                               icon="pebble-icon:Edit" class="pebble-icon-size-16" column-object="[[col]]">
                                <template>
                                    <div slot="cell-slot-content" class="cell tooltip-bottom" data-tooltip$="[[_columnValue(item,column.columnIndex)]]">
                                        <span>[[_columnValue(item, column.columnIndex)]]</span>
                                    </div>
                                </template>
                            </data-table-column>
                        </template>
                    </pebble-data-table>
                </div>
                <div class="centerContainer">
                    <pebble-button id="firstButton" class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:Lastpage" on-tap="_moveRightAll"></pebble-button>
                    <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:RightArrow" on-tap="_moveRight"></pebble-button>
                    <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:LeftArrow" on-tap="_moveLeft"></pebble-button>
                    <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:Firstpage" on-tap="_moveLeftAll"></pebble-button>
                </div>
                <div class="rightContainer">
                    <h4>Selected Fields</h4>
                    <pebble-data-table  id="rightDataTable"  selection-enabled multi-selection="[[config.tabular.settings.isMultiSelect]]"  items="[[selectedItems]]" >
                        <template is="dom-repeat" items="[[config.tabular.fields]]" as="col" index-as="colIndex">
                            <data-table-column slot="column-slot" name="[[col.header]]" column-index="{{colIndex}}" filter-by="[[_isFilterEnabled(col)]]" sort-by="[[_isSortable(col)]]"
                                               icon="pebble-icon:Edit" class="pebble-icon-size-16" column-object="[[col]]">
                                <template>
                                    <div slot="cell-slot-content" class="cell tooltip-bottom" data-tooltip$="[[_columnValue(item,column.columnIndex)]]">
                                        <span>[[_columnValue(item, column.columnIndex)]]</span>
                                    </div>
                                </template>
                            </data-table-column>
                        </template>
                    </pebble-data-table>
                    <template is="dom-if" if="[[moveUpDownEnabled]]">
                        <div  class="moveButtons">
                            <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:Less" on-tap="_moveUpRight"></pebble-button>
                            <pebble-button class="btn btn-outline-primary auto-width m-b-10" icon="pebble-icon:Expand" on-tap="_moveDownRight"></pebble-button>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pebble-split-list',
                properties: {
                    items:{
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify:true
                    },
                    selectedItems:{
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify:true
                    },
                    retainSelectedItems: {
                        type:Boolean,
                        value:false
                    },
                    moveUpDownEnabled:{
                        type:Boolean,
                        value:false
                    },
                    pageSize:{
                        type:Number,
                        value:50
                    },
                    deletedItems:{
                        type:Array,
                        value:function () {
                            return [];
                        },
                        notify:true
                    },
                    rDataSourceId:{
                        type:String
                    },
                    config:{
                        type:Object
                    },
                    size:{
                        type:Number,
                        notify:true
                    },
                    rDataSource: {
						type: Function,
						notify: true
					},
                },
                behaviors:[
                    RUFBehaviors.UIBehavior
                ],
                ready:function () {
                   console.log(this.config);
                },
                _columnValue: function (gridData, index) {
                    if(gridData) {
                        var columnName = this.config.tabular.fields[index].name;
                        return gridData[columnName];
                    }
                },
                _isFilterEnabled: function (col) {
                    return col.filterable ? col.name : undefined;
                },
                _isSortable: function (col) {
                    return col.sortable ? col.name : undefined;
                },
                _moveRight:function () {
                    var leftGrid=this.$.leftDataTable;
                    if(leftGrid){
                        var selectedItems=leftGrid.getSelectedItems();
                        for(var i=0;i<selectedItems.length;i++) {
                            if(this.selectedItems.indexOf(selectedItems[i])===-1) {
                                this.push("selectedItems", selectedItems[i]);
                            }
                        }
                        leftGrid.clearSelection();
                        if(!this.retainSelectedItems){
                            leftGrid.deleteItems(selectedItems);
                        }
                        this.fireBedrockEvent("moveToRight",selectedItems);
                    }
                },
                _moveRightAll:function () {
                    var leftGrid=this.$.leftDataTable;
                    if(leftGrid){
                        var items=leftGrid.getData();
                        for(var i=0;i<items.length;i++) {
                            if(this.selectedItems.indexOf(items[i])===-1) {
                                this.push("selectedItems", items[i]);
                            }
                        }
                        leftGrid.clearSelection();
                        if(!this.retainSelectedItems){
                            leftGrid.deleteItems(items);
                        }
                        this.fireBedrockEvent("moveAllToRight",items);
                    }
                },
                _moveLeft:function () {
                    var rightGrid=this.$.rightDataTable;
                    var leftGrid=this.$.leftDataTable;
                    if(rightGrid){
                        var selectedItems=rightGrid.getSelectedItems();
                        if(!this.retainSelectedItems){
                            for(var i=selectedItems.length-1;i>=0;i--) {
                                var index = this.deletedItems.indexOf(selectedItems[i]);
                                this.splice("deletedItems", index, 1);
                            }
                            this.restoreDeletedItems(leftGrid,selectedItems,this.rDataSource);
                        }
                        for(var i=0;i<selectedItems.length;i++) {
                            var index=this.selectedItems.indexOf(selectedItems[i]);
                            this.splice("selectedItems",index,1 );
                        }
                        rightGrid.clearSelection();
                        this.fireBedrockEvent("moveToLeft",selectedItems);
                    }
                },
                _moveLeftAll:function () {
                    var rightGrid=this.$.rightDataTable;
                    var leftGrid=this.$.leftDataTable;
                    var items=rightGrid.getData();
                    if(!this.retainSelectedItems){
                        this.deletedItems=[];
                        this.restoreDeletedItems(leftGrid,items,this.rDataSource);
                    }
                    for(var i=0;i<items.length;i++){
                        var index=this.selectedItems.indexOf(items[i]);
                        this.splice("selectedItems",index,1 );
                    }
                    rightGrid.clearSelection();
                    this.fireBedrockEvent("moveAllToLeft",items);
                },
                _moveUpRight: function () {
                    var rightGrid=this.$.rightDataTable;
                    var selectedItems=rightGrid.getSelectedItems();
                    var _this = this;
                    var sortedSelectedItems=selectedItems.sort(function (item1,item2) {
                             return _this.selectedItems.indexOf(item1)-_this.selectedItems.indexOf(item2);
                    })
                    for(var i=0;i<sortedSelectedItems.length;i++){
                        var index=this.selectedItems.indexOf(sortedSelectedItems[i]);
                        if(index>0){
                            var temp=this.selectedItems[index-1];
                            this.selectedItems[index-1]=this.selectedItems[index];
                            this.selectedItems[index]=temp;
                        }
                    }
                    var items=this.selectedItems;
                    this.selectedItems=[];
                    this.selectedItems=items;
                },
                _moveDownRight: function () {
                    var rightGrid=this.$.rightDataTable;
                    var selectedItems=rightGrid.getSelectedItems();
                    var _this = this;
                    var sortedSelectedItems=selectedItems.sort(function (item1,item2) {
                             return _this.selectedItems.indexOf(item2)-_this.selectedItems.indexOf(item1);
                    });
                    for(var i=0;i<sortedSelectedItems.length;i++){
                        var index=this.selectedItems.indexOf(sortedSelectedItems[i]);
                        if(index<this.selectedItems.length-1){
                            var temp=this.selectedItems[index+1];
                            this.selectedItems[index+1]=this.selectedItems[index];
                            this.selectedItems[index]=temp;
                        }
                    }
                    var items=this.selectedItems;
                    this.selectedItems=[];
                    this.selectedItems=items;
                },
                getSelectedItems:function () {
                    return this.selectedItems;
                },
                getLeftItems:function () {
                    var leftGrid=this.$.leftDataTable;
                    return leftGrid.getData();
                },
                restoreDeletedItems:function (grid,items,dataSource) {
                    if(typeof dataSource === 'function'){
                       this.rerenderGrid();
                    } else{
                        for(var i=items.length-1;i>=0;i--) {
                            if (this.items.indexOf(items[i]) === -1) {
                                this.unshift("items", items[i]);
                            }
                        }
                    }
                },
                rerenderGrid: function () {
                    var grid=this.$.leftDataTable;
                    if (this.rDataSourceId) {
                        var dataSourceElement =ComponentHelper.getComponentContainer(this).$$('#' + this.rDataSourceId);
                        if (dataSourceElement) {
                            dataSourceElement.resetDataSource();
                        }
                    }
                    grid.clearCache();
                    grid._currentPage=0;
                },



            });
        })();
    </script>

</dom-module>