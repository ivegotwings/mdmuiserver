<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">

<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-vertical-divider/pebble-vertical-divider.html">



<link rel="import" href="../rock-layout/rock-layout.html">
<link rel="import" href="../rock-layout/rock-titlebar/rock-titlebar.html">
<link rel="import" href="../rock-layout/rock-header/rock-header.html">
<link rel="import" href="../rock-layout/rock-header-sidebar/rock-header-sidebar.html">
<link rel="import" href="../rock-search-bar/rock-search-bar.html">
<link rel="import" href="../rock-entity-quick-manage/rock-entity-quick-manage.html" />
<link rel="import" href="../rock-widget-panel/rock-widget-panel.html">
<link rel="import" href="../rock-footer/rock-footer.html">
<link rel="import" href="../rock-job-attribute-detail/rock-job-attribute-detail.html">
<link rel="import" href="../rock-job-entity-detail-grid/rock-job-entity-detail-grid.html">
<dom-module id="app-job-detail">

    <template>
        <style include="pebble-styles-shared"></style>
        <style include="iron-flex"></style>
        <style is="custom-style">
            rock-search-bar {
                display: inline-flex;
                display: -webkit-inline-flex;
                width: calc( 100% - 10px);
                height: 30px;
                border: 0;
                overflow: inherit!important;
                margin-bottom: 6px;
            }

            rock-search-bar::shadow .input-panel iron-icon {
                fill: #fff;
            }

            rock-search-filter::shadow paper-menu-button {
                padding: 0;
            }


            rock-search-filter::shadow paper-menu-button paper-menu {
                background: var(--palette-white, #fff);
            }

            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button:not([raised]) {
                font-weight: normal;
            }

            :host {
                --pebble-popover-max-width: 100%;
            }

            pebble-popover paper-item {
                cursor: pointer;
                font-size: var(--default-font-size, 14px);
                padding: 0 0 0 0;
                min-height: 40px;
            }


            pebble-button::shadow paper-button::shadow iron-icon {
                color: var(--palette-white, #fff) !important;
            }

            pebble-popover paper-item iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                color: var(--palette-white, #fff);
            }


            rock-header {
                padding: 20px 20px 20px 20px;
            }

            rock-search-filter::shadow paper-menu-button pebble-button::shadow paper-button iron-icon {
                color: var(--white, #fff) !important;
            }

            .quick-manage-container {
                height: auto;
                width: 50%;
                display: block;
            }

            pebble-vertical-divider {
                --pebble-vertical-divider-color: #c1cad4;
                height: 100%;
                border: 0px;
                min-height: 0px;
                width: 2px;
                margin: 20px 0;
            }
            .quick-manage{
                padding: 0 20px 0 0;
            }

            .container {
                width: 100%;
            }
        </style>
        <rock-layout>
            <liquid-config-aggregate-get id="getAppConfig"  operation="getbyids" request-id="req1" app-name="app-job-detail"
                                         context-data="[[contextData]]" on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
            <rock-titlebar icon="pebble-md-icons:Advancesearch" title="Job Details" closable minimizable>
            </rock-titlebar>
            <rock-header>
                <div class="fixed-content">
                    <div class="layout horizontal">
                        <div class="flex">
                            <!-- search bar-->
                            <bedrock-pubsub event-name="rock-search" handler="_onSearch" target-id="searchBar"></bedrock-pubsub>
                            <bedrock-pubsub event-name="rock-search-clear" handler="_onSearchClear" target-id="searchBar"></bedrock-pubsub>
                            <rock-search-bar id="searchBar" placeholder="Enter Search text"></rock-search-bar>
                        </div>
                    </div>
                    <div class="layout horizontal p-t-10">
                        <div class="flex searchFilterTag">
                            <!-- Search Filter Tags -->
                            <rock-entity-search-filter id="searchFilter" _selected-search-filters="{{_selectedSearchFilters}}" context-data="{{contextData}}"
                                                       types-criterion="[[_typesCriterion]]" tags="{{tags}}"></rock-entity-search-filter>
                        </div>
                    </div>
                </div>
            </rock-header>
            <div class="layout horizontal">
                <div id="entityGridContainer" class$="[[_applyClass(_quickManageEnabled)]]">
                    <rock-job-entity-detail-grid id="jobEntityGrid" context-data="[[contextData]]" grid-config="[[getConfig('rock-job-entity-detail-grid')]]"
                                             search-filters="[[_selectedSearchFilters]]" search-query="[[_searchQuery]]"
                                             total-records="{{_gridFullLength}}" selected-entity="{{selectedEntity}}"></rock-job-entity-detail-grid>
                </div>
                <template is="dom-if" if="[[_quickManageEnabled]]">
                    <!--<div>-->
                        <!--<pebble-vertical-divider></pebble-vertical-divider>-->
                    <!--</div>-->
                    <div class="quick-manage-container quick-manage">
                        <rock-entity-quick-manage id="entityQuickManage" context-data="[[contextData]]" current-index="{{_currentIndex}}" total-records="[[_gridFullLength]]"
                                                  selected-entity="[[selectedEntity]]" tab-config="{{getConfig('rock-entity-quick-manage', '', 'rock-tabs')}}"
                                                  toolbar-config="{{getConfig('rock-entity-quick-manage', '', 'pebble-toolbar')}}" fixes="{{getConfig('rock-entity-quick-manage', '', 'rock-entity-tofix')}}"></rock-entity-quick-manage>
                        <bedrock-pubsub event-name="on-attribute-save" handler="_onAttributeSave"></bedrock-pubsub>
                        <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-previous" handler="_onClickPrevious"></bedrock-pubsub>
                        <bedrock-pubsub target-id="entityQuickManage" event-name="on-tap-next" handler="_onClickNext"></bedrock-pubsub>
                    </div>
                </template>
            </div>
        </rock-layout>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'app-job-detail',
                attached: function () {
                    var userContext = {
                        "role": this.roleId,
                        "user": this.userId
                    };

                    this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
                },
                properties: {
                    _quickManageEnabled: {
                        type: Boolean,
                        value: false
                    },
                    selectedEntity:{
                        type:Object,
                        value:function () {
                            return {};
                        },
                        observer:'_onGridSelectionChange'
                    },
                    _searchQuery: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    _currentIndex: {
                        type: Number,
                        value: -1
                    },
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.AppContextBehavior
                ],
                _onApplicationConfigReceived: function (e) {
                    //console.log('Received configs ', JSON.stringify(e, null, 2));
                    this.set('applicationConfig', e.detail);
                },
                _computeClass:function (selectedEntity) {
                    return _.isEmpty(selectedEntity)?'container':'jobAttributeDetailContainer';
                },
                _entitySelected:function (selectedEntity) {
                    return !_.isEmpty(selectedEntity);
                },
                _onSearch:function (e,detail) {
                    this._searchQuery=detail;
                },
                _onSearchClear:function (e) {
                    this._searchQuery="";
                },
                _applyClass: function () {
                    if (this._quickManageEnabled) {
                        return "quick-manage-container";
                    }

                    return "container";
                },
                _getGrid:function () {
                    return ElementHelper.getElement(this, "#jobEntityGrid");
                },
                _onClickPrevious: function (e, detail, sender) {
                    if (this._currentIndex > 0) {
                        this._selectEntity(this._currentIndex - 1, 'previous');
                    }
                },
                _onClickNext: function (e, detail, sender) {
                    if (this._currentIndex < this._gridFullLength) {
                        this._selectEntity(this._currentIndex + 1);
                    }
                },
                _selectEntity: function (index, nav) {
                    if (!(index < 0)) {
                        var grid = this._getGrid();
                        var gridData = grid.getData();

                        if (gridData.length > 0 && index < this._gridFullLength) {
                            if (gridData[index] && !_.isEmpty(gridData[index])) {
                                this._selectedEntity = gridData[index];

                                var itemContext = {
                                    'id': this._selectedEntity.id,
                                    'type': this._selectedEntity.type
                                };
                                this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);

                                this._currentIndex = index;
                                grid.clearSelection();
                                grid.selectItem(gridData[index]);

                                //On previous click already data got loaded, so directly we can set scroll index
                                //but for next, data will loaded as per page size, so scroll as per allow scroll
                                if (nav == 'previous' || this._isAllowedToScroll()) {
                                    grid.scrollToIndex(this._currentIndex);
                                }
                            } else {
                                var nextScrollIndex = grid.totalRecords + grid.pageSize;
                                // Todo: nextScrollIndex will be based on the grid total count
                                grid.scrollToIndex(nextScrollIndex);

                                this.async(function () {
                                    this._selectEntity(index);
                                }, 10);
                            }
                        }
                    }
                },
                _isAllowedToScroll: function () {
                    var grid = this._getGrid();
                    return ((this._currentIndex) % grid.pageSize) == 0;
                },
                _onGridSelectionChange: function (selectedEntity) {
                    if (!_.isEmpty(selectedEntity)) {
                        this._quickManageEnabled=true;
                        var itemContext = {
                            'id': selectedEntity.id,
                            'type': selectedEntity.type
                        };
                        var grid=this._getGrid();
                        this._currentIndex = grid.getSelectedItemIndex();
                        this.updateContext(this.CONTEXT_TYPE_ITEM, [itemContext]);
                        grid.notifyResize();
                    }
                }
            });
        })();
    </script>
</dom-module>