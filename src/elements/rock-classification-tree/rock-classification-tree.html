<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/element-helper.html">

<link rel="import" href="../pebble-tree/pebble-tree.html">


<!--
`rock-classification-tree` component is used to render classification in a tree.

@demo demo/index.html
-->

<dom-module id="rock-classification-tree">
    <template>
        <liquid-entity-data-get id="initiateSearch" operation="initiatesearch" request-data="{{request}}" last-response="{{initiateSearchResponse}}"
                                on-error="_onGetSearchError"  on-response="_onInitiateSearchResponse" exclude-in-progress></liquid-entity-data-get>
        <liquid-entity-data-get id="getSearchResultDetail" operation="getsearchresultdetail" request-data="{{request}}" request-id="[[initiateSearchResponse.content.requestId]]"
                                last-response="{{getEntitySearchResultsResponse}}" on-error="_onGetSearchError" on-response="_onGetSearchResultDetailResponse" exclude-in-progress></liquid-entity-data-get>
        <pebble-tree id="contextTree" data="{{classifications}}" default-child-depth="10" selected-items="{{selectedItems}}"  multi-select></pebble-tree>
    </template>
    <script>
        Polymer({
            is: 'rock-classification-tree',
            properties: {

                request: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                /**
                 * Specifies whether or not to generate console logs.
                 */
                verbose: {
                    type: Boolean,
                    value: false
                },
                _dataFormatter: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                contextData:{
                    type:Object,
                    value:function () {
                        return {};
                    },
                    observer:'_contextChanged'
                },
                rootClassificationId:{
                    type:String,
                    value:"_root_classification"
                },
                _currentNode:{
                    type:Object,
                    value:function () {
                        return {};
                    }
                },
                taxonomy:{
                    type:String
                },
                selectedItems:{
                    type:Array,
                    value:function () {
                        return [];
                    },
                    notify:true
                }
            },

            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior
            ],
            listeners: {
                'tree-node-expanded': '_treeNodeExpanded'
            },
            observers:[
              '_contextRecieved(contextData,taxonomy)'
            ],

            _contextRecieved:function () {
                if(this.taxonomy && !_.isEmpty(this.contextData)) {
                    this.generateRequest();
                }
            },
            generateRequest: function (parentClassificationId){
                if(!parentClassificationId){
                    parentClassificationId=this.rootClassificationId;
                }
                var contextData=DataHelper.cloneObject(this.contextData);
                contextData[this.CONTEXT_TYPE_ITEM]=[{type:"classification"}];
                contextData[this.CONTEXT_TYPE_VALUE]=[];
                var req=DataRequestHelper.createEntityGetRequest(contextData);
                var relCreiterion=[];
                var classificationCriteria={"belongsTo":{"relTo":{"id":parentClassificationId,"type":"classification"},"attributes":[]}};
                relCreiterion.push(classificationCriteria);
                if(this.taxonomy){
                    var taxonomyCriteria={"belongsTo":{"relTo":{"id":this.taxonomy,"type":"taxonomy"},"attributes":[]}};
                    relCreiterion.push(taxonomyCriteria);
                }
                req.params.query.filters.relationshipsCriterion=relCreiterion;
                this.set('request',req);
                this.$$("#initiateSearch").generateRequest();
            },
            _onInitiateSearchResponse: function (e) {
                this._currentRecord=0;
                this._totalRecords=this.initiateSearchResponse.content.totalRecords;
                this._classificationsList=[];
                this._makeNextBatchSearchDetailCall();
            },
            _makeNextBatchSearchDetailCall: function() {
                var start = this._currentRecord;
                var end = this._currentRecord+19;
                if(start > this._totalRecords) {
                    return;
                }
                if(end > this._totalRecords) {
                    end = this._totalRecords - 1;
                }
                var getDetailOptions = { 'from': start, 'to':end };
                this.set('request.params.options', getDetailOptions);
                var liqGetSearchResultDetail = this.$$('#getSearchResultDetail');
                liqGetSearchResultDetail.generateRequest();
            },
            _onGetSearchResultDetailResponse: function (e) {
                var res=e.detail.response;
                var classifications=res.content.entities;
                for(var i in classifications){
                    classifications[i].text=classifications[i].name;
                    classifications[i].value=classifications[i].id;
                    classifications[i].children=[];
                }
                this._classificationsList =this._classificationsList.concat(classifications);
                this._currentRecord+=20;
                if(this._currentRecord<this._totalRecords){
                    this._makeNextBatchSearchDetailCall();
                } else {
                    if (!this._currentNode || _.isEmpty(this._currentNode)) {
                        this.classifications = this._classificationsList;
                    } else {
                        if (!this._classificationsList.length) {
                            this._currentNode.changeToLeafMode();
                        }
                        this._currentNode.set('nodeData.children', this._classificationsList);
                        this._currentNode.refreshChildList();
                    }
                }
            },

            _treeNodeExpanded:function (e) {
                this._currentNode = e.detail;
                if (!this._currentNode.nodeData.children || this._currentNode.nodeData.children.length == 0) {
                    this.generateRequest(this._currentNode.nodeData.value);
                    this._currentNode._loading=true;
                }
            }


        });
    </script>
</dom-module>