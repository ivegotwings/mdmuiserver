<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-helpers/data-request-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-helpers/liquid-response-helper.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-dataobject-utils/liquid-dataobject-utils.html">
<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-entity-govern-data-get/liquid-entity-govern-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="assets-search-grid-datasource.html">

<!--
`rock-assets-search-grid` Represents a component that renders the asset entities in the grid.

@demo demo/index.html
-->

<dom-module id="rock-assets-search-grid">

    <template>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="{{attributeModelRequest}}" on-entity-model-composite-get-response="_onCompositeModelGetResponse"></liquid-entity-model-composite-get>
        <liquid-entity-govern-data-get name="governDataGet" operation="initiatesearch" request-data="{{_governDataRequest}}" on-response="_onGovernDataResponse"></liquid-entity-govern-data-get>
        <liquid-rest id="getThumbnail" url="/binaryobjectservice/get" method="POST" on-liquid-response="_onGetThumbnailResponse">
        </liquid-rest>
        <liquid-rest id="getDownloadUrl" url="/data/binarystreamobjectservice/prepareDownload" method="POST" on-liquid-response="_onGetDownloadUrlResponse">
        </liquid-rest>
        <template is="dom-if" if="[[_isWorkflowRequest(_loadGrid, _loadWithoutWorkflow)]]">
            <assets-search-grid-datasource id="searchGrid" request="{{request}}" asset-search-data-source="{{rDataSource}}" asset-search-dataFormatter="{{dataFormatter}}"
                current-record-size="{{currentRecordSize}}" result-record-size="{{resultRecordSize}}" total-count="{{totalCount}}"></assets-search-grid-datasource>
            <rock-grid id="entityGrid" r-data-source="{{rDataSource}}" r-data-source-id="searchGrid" current-record-size="{{currentRecordSize}}"
                result-record-size="{{resultRecordSize}}" config="{{gridConfig}}" attribute-models="{}" page-size="[[pageSize]]"
                selected-item="{{selectedItem}}" total-count="{{totalCount}}" max-configured-count="[[maxConfiguredCount]]" is-workflow-criterion$="[[_isWorkflowCriterion(workflowCriterion)]]"></rock-grid>
            <bedrock-pubsub event-name="grid-download-item" handler="_onDownload" target-id="entityGrid"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-upload-item" handler="_onUpload" target-id="entityGrid"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-custom-toolbar-event" handler="_onCustomToolbarEvent" target-id="entityGrid"></bedrock-pubsub>
            <bedrock-pubsub event-name="download-original-asset" handler="_onOriginalAssetDownloadAction" target-id="entityGrid"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-bulk-delete-items" handler="_showConfirmationDialog" target-id="entityGrid"></bedrock-pubsub>
            <bedrock-pubsub event-name="grid-bulk-edit-items" handler="_onBulkEdit" target-id="entityGrid"></bedrock-pubsub>
        </template>

        <pebble-dialog id="confirmationDialog" dialog-title="Confirmation" modal alert-box show-cancel show-ok no-cancel-on-outside-click
            no-cancel-on-esc-key>
            <p>Are you sure you want to delete?</p>
        </pebble-dialog>
        <bedrock-pubsub event-name="on-buttonok-clicked" handler="_onBulkDelete" target-id="confirmationDialog"></bedrock-pubsub>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rock-assets-search-grid',
                properties: {
                    /**
                     * Indicates the request object that 
                     * is passed to the data element to retrieve the attribute model data.
                     *
                     */
                    attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the context data.
                     * 
                     */
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the configuration object that is passed to the grid.
                     */
                    gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the request object to initiate the search.
                     * 
                     */
                    request: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "contexts": [],
                                        "valueContexts": [],
                                        "filters": {
                                            "attributesCriterion": [],
                                            "typesCriterion": []
                                        }
                                    },
                                    "fields": {
                                        "attributes": []
                                    },
                                    "options": {
                                        "from": 0,
                                        "to": 0
                                    }
                                }
                            };
                        }
                    },
                    /**
                     * Specifies the filters that are used to filter the search.
                     */
                    searchFilters: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Specifies the query object that are used to initiate the search.
                     */
                    searchQuery: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    /**
                     * Specifies the workflow criterion for the search.
                     */
                    workflowCriterion: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the workflow criterion for the search.
                     */
                    governDataCriterion: {
                        type: Object,
                        notify: true,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the format of the data that are passed to the remote data.
                     */
                    dataFormatter: {
                        notify: true,
                        value: function () {
                            return this._getAttributeFormattedData.bind(this);
                        }
                    },
                    /**
                     * Indicates the attribute models.
                     * 
                     */
                    attributeModels: {
                        type: Object,
                        value: function () {
                            return {}
                        }
                    },
                    /**
                     * Indicates the number of items fetched at a time from the data source.
                     */
                    pageSize: {
                        type: Number,
                        notify: true,
                        value: 50
                    },

                    /**
                     * Indicates the total record size of the current grid.
                     */
                    totalCount: {
                        notify: true,
                        type: Number,
                        value: 0
                    },

                    resultRecordSize: {
                        notify: true,
                        type: Number,
                        value: 0
                    },

                    /**
                     * Indicates the selected item.
                     */
                    selectedItem: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },
                    /**
                     * Indicates the maximum count which is shown in the grid title. 
                     * If the entities' count is greater than `this` count, then the 
                    * number of entities are not shown.
                    * For example, if maxConfiguredCount is 200 and you have 250 entities,
                    * `maxConfiguredCount` is shown as "200+".
                    *
                    */
                    maxConfiguredCount: {
                        type: Number,
                        value: function () {
                            return DataObjectFalcorUtil.getPathKeys().dataIndexInfo.entityData.dataSubIndexInfo.data.maxRecordsToReturn;
                        }
                    },
                    _governDataRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _loadGrid: {
                        type: Boolean
                    },

                    _loadWithoutWorkflow: {
                        type: Boolean
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    /**
                      * <b><i>Content development is under progress... </b></i> 
                      */
                    typesCriterion: {
                        type: Array,
                        value: function () { return []; }
                    }
                },

                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                /**
                 * Can be used to refresh the grid.
                 *
                 */
                refresh: function () {
                    this._onGridConfigChange(this.gridConfig);
                },

                /**
                 * Can be used to get the grid data.
                 */
                getData: function () {
                    return this._getEntityGrid().getData();
                },

                /**
                 * Can be used to set the multi-selection for the grid.
                 */
                setMultiSelection: function (flag) {
                    if (this.shadowRoot.querySelector('#entityGrid') && flag != undefined) {
                        this._getEntityGrid().setMultiSelection(flag);
                    }
                },

                /**
                 * Can be used to clear the current selection state.
                 */
                clearSelection: function () {
                    this._getEntityGrid().clearSelection();
                },

                /**
                 *  Can be used to select an item.
                 */
                selectItem: function (item) {
                    this._getEntityGrid().selectItem(item);
                },

                /**
                 * Can be used to set scroll position dynamically.
                 */
                scrollToIndex: function (index) {
                    this._getEntityGrid().scrollToIndex(index);
                },

                /**
                 * Can be used to get the selected item index.
                 */
                getSelectedItemIndex: function () {
                    return this._getEntityGrid().getSelectedItemIndex();
                },

                _addWorkflowDetailsToConfig: function () {
                    if (!(this.workflowCriterion && this.workflowCriterion.workflowName && this.workflowCriterion.workflowActivityName)) {
                        return;
                    }
                    var title = this.workflowCriterion.workflowActivityExternalName + " (" + this.workflowCriterion.workflowName + ")";
                    if (this.governDataCriterion && this.governDataCriterion.businessConditionExternalName) {
                        var status = this.governDataCriterion.status;
                        if (!status) {
                            status = "failed";
                        }
                        title += " - " + this.governDataCriterion.businessConditionExternalName + " (" + status + ")"
                        if (this.governDataCriterion.userId) {
                            var userText = this.governDataCriterion.userId == "_UNASSIGNED" ? "Unassigned" : "Assigned to me";
                            title += " - " + userText;
                        }
                    }
                    this.set('gridConfig.workflowTitle', title);
                },
                /**
                 * Can be used to reload the grid.
                 */
                reloadGrid: function () {
                    if (!_.isEmpty(this.workflowCriterion)) {
                        this._addWorkflowDetailsToConfig();
                        var governDataLiquid = this.shadowRoot.querySelector("[name=governDataGet]");
                        if (governDataLiquid) {
                            var workflowActivityName = this.workflowCriterion.workflowActivityName;
                            var contexts = [];
                            var excludeNonContextual = false;
                            if (!_.isEmpty(this.governDataCriterion)) {
                                var userId = this.governDataCriterion.userId;
                                var businessConditionName = this.governDataCriterion.businessConditionName;
                                var businessConditionNames = this.governDataCriterion.businessConditionNames;
                                var passedBusinessConditions = this.governDataCriterion.status == "passed";
                                if (!(businessConditionName || businessConditionNames)) {
                                    contexts.push({
                                        "workflow": this.workflowCriterion.workflowShortName
                                    });
                                    excludeNonContextual = true;
                                }
                            }

                            var options = {
                                "contexts": contexts,
                                "typesCriterion": this.typesCriterion,
                                "userId": userId,
                                "workflowActivityName": workflowActivityName,
                                "businessConditionName": businessConditionName,
                                "businessConditionNames": businessConditionNames,
                                "attributes": "",
                                "excludeNonContextual": excludeNonContextual,
                                "passedBusinessConditions": passedBusinessConditions
                            }

                            var req = DataRequestHelper.createGovernGetRequest(options);

                            if (!_.isEmpty(req)) {
                                this._governDataRequest = req;
                                governDataLiquid.generateRequest();
                            }
                        }
                    } else {
                        this._loadGrid = true;
                        this._loadWithoutWorkflow = true;
                        this._reloadGrid(undefined);
                    }
                },

                _onGridConfigChange: function (gridConfig) {
                    if (gridConfig != undefined) {
                        if (_.isEmpty(this.contextData) || _.isEmpty(gridConfig)) {
                            return;
                        }
                        if (!_.isEmpty(this.contextData)) {
                            if (Object.keys(this.contextData).length == 1 && this.contextData[ContextHelper.CONTEXT_TYPE_USER]) {
                                return;
                            }
                        }
                        if (!gridConfig.dataRequest) {
                            return;
                        }


                        var contextData = DataHelper.cloneObject(this.contextData);

                        this._updateItemContexts(contextData);
                        this.set('gridConfig.dataContexts', contextData[ContextHelper.CONTEXT_TYPE_DATA]);
                        this.set('gridConfig.valueContexts', contextData[ContextHelper.CONTEXT_TYPE_VALUE]);
                        contextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
                        var compositeModelGetRequest = DataRequestHelper.createEntityModelCompositeGetRequest(contextData);
                        if (compositeModelGetRequest) {
                            this.set("attributeModelRequest", compositeModelGetRequest);
                            var liquidModelGet = this.shadowRoot.querySelector("[name=compositeAttributeModelGet]");
                            if (liquidModelGet) {
                                liquidModelGet.generateRequest();
                            }
                        }
                    }
                },

                _onCompositeModelGetResponse: function (e) {
                    if (!this._typeThumbnailMapping) {
                        this._typeThumbnailMapping = {};
                    }
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        var entityModels = e.detail.response.content.entityModels;
                        for (var i = 0; i < entityModels.length; i++) {
                            var entityModel = entityModels[i];
                            var properties = entityModel.properties;
                            if (properties && properties.hasOwnProperty("defaultThumbnailId")) {
                                this._typeThumbnailMapping[entityModel.name] = properties.defaultThumbnailId;
                            }
                        }
                        this.attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response
                            .content.entityModels[0], this.contextData);
                        this.reloadGrid();
                    }
                },
                _onGovernDataResponse: function (e) {
                    var response = e.detail.response;
                    var ids = [0];
                    if (response) {
                        if (response.content && response.content.items) {
                            var items = response.content.items;
                            if (items.length > 0) {
                                ids = [...new Set(items.map((obj) => obj.id))];
                            }
                        }
                    }
                    this._loadWithoutWorkflow = undefined;
                    this._loadWithoutWorkflow = false;
                    this._loadGrid = true;
                    this._reloadGrid(ids);
                },

                _getAttributeNamesFromTileConfig: function (config) {
                    var tileItems = config.itemConfig;
                    var attributeNames = config.dataRequest.attributes;
                    if (!attributeNames) {
                        attributeNames = [];
                    }
                    attributeNames.push(tileItems.image);
                    attributeNames.push(tileItems.title);
                    attributeNames.push(tileItems.id);
                    attributeNames.push(tileItems.subtitle);
                    attributeNames.push("type");
                    for (var i in tileItems.fields) {
                        var field = tileItems.fields[i];
                        attributeNames.push(field.name);
                    }
                    return _.uniq(attributeNames);
                },

                _getAttributeFormattedData: function (data) {
                    var formattedEntities = [];
                    var attributes = this._getAttributeNamesFromTileConfig(this.gridConfig);
                    if (data && data.content) {
                        var entities = data.content.entities;
                        if (entities && entities.length > 0) {
                            formattedEntities = DataTransformHelper.transformEntitiesToSimpleSchema(entities, attributes, this.attributeModels);
                        }
                    }
                    for (var i = 0; i < formattedEntities.length; i++) {
                        var type = formattedEntities[i].type;
                        if (!formattedEntities[i].thumbnailid) {
                            formattedEntities[i].thumbnailid = "";
                            if (this._typeThumbnailMapping && this._typeThumbnailMapping[type]) {
                                formattedEntities[i].thumbnailid = this._typeThumbnailMapping[type];
                            }
                        }

                    }

                    if (formattedEntities.length == 0 && this.getData().length <= 0) {
                        this.fireBedrockEvent('empty-grid');
                    } else {
                        this.fireBedrockEvent('grid-with-data');
                    }

                    return formattedEntities;
                },

                _updateItemContexts: function (contextData) {
                    var itemContexts = [];
                    if (!this.gridConfig.dataRequest) {
                        return;
                    }
                    var attributeNames = this.gridConfig.dataRequest.attributes;
                    if (attributeNames.indexOf("thumbnailid") == -1) {
                        attributeNames.push("thumbnailid");
                    }
                    if (attributeNames.indexOf("property_objectkey") == -1) {
                        attributeNames.push("property_objectkey");
                    }
                    for (var i in this.typesCriterion) {
                        var itemContext = {};
                        itemContext.attributeNames = attributeNames;
                        itemContext.type = this.typesCriterion[i];
                        itemContexts.push(itemContext);
                    }
                    contextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
                },

                _reloadGrid: function (ids) {

                    var contextData = DataHelper.cloneObject(this.contextData);

                    this._updateItemContexts(contextData);
                    this.request = DataRequestHelper.createEntityGetRequest(contextData);
                    if (!_.isEmpty(ids)) {
                        this.request.params.query.ids = ids;
                    }

                    if (this.searchFilters && !_.isEmpty(this.searchFilters)) {
                        this.request.params.query.filters.attributesCriterion = this.searchFilters;
                    }

                    this._setSearchCriteria();

                    var grid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid');

                    if (grid) {
                        grid.reRenderGrid();
                    }
                },

                _setSearchCriteria: function () {
                    // reset search criteria
                    delete this.request.params.query.filters.keywordsCriterion;
                    var entityIdList = this.request.params.query.ids;
                    var searchCriteria;

                    if (this.searchQuery && this.searchQuery != "") {
                        searchCriteria = DataHelper.getSearchCriteria(this.searchQuery);
                        if (searchCriteria && searchCriteria.isIdSearch) {
                            var filteredIds = searchCriteria.ids || [];
                            if (entityIdList && entityIdList.length > 0) {
                                filteredIds = searchCriteria.ids.filter(function (searchCriteriaId) {
                                    if (entityIdList.indexOf(searchCriteriaId) >= 0) {
                                        return searchCriteriaId;
                                    }
                                });
                            }
                            this.request.params.query.ids = filteredIds;
                        } else {
                            this.request.params.query.filters.keywordsCriterion = searchCriteria
                        }
                    }
                },

                _getEntityGrid: function () {
                    return ElementHelper.getElement(this, "#entityGrid");
                },

                _isWorkflowRequest: function (loadGrid, loadWithoutWorkflow) {
                    if (_.isEmpty(this.workflowCriterion) && !loadWithoutWorkflow) {
                        return false;
                    }
                    return true;
                },

                _isWorkflowCriterion: function () {
                    if (_.isEmpty(this.workflowCriterion)) {
                        return false;
                    }

                    return true;
                },

                _onOriginalAssetDownloadAction: function (e, detail) {
                    if (detail) {
                        var fileName = detail.property_objectkey;
                        if (fileName) {
                            this._generateOriginalAssetsDownloadRequest([fileName]);
                        }
                    }
                },
                _generateOriginalAssetsDownloadRequest: function (objectkeys) {
                    var binaryStreamObjects = [];
                    objectkeys.forEach(function (item) {
                        if (item) {
                            binaryStreamObjects.push(
                                {
                                    "binaryStreamObject":
                                        {
                                            "id": item,
                                            "type": "binarystreamobject",
                                            "data": {}
                                        }
                                }
                            )
                        }
                    }, this);
                    var req = binaryStreamObjects;
                    var downloadUrlLiquid = this.shadowRoot.querySelector("#getDownloadUrl");
                    if (downloadUrlLiquid) {
                        downloadUrlLiquid.requestData = req;
                        downloadUrlLiquid.generateRequest();
                    }
                },
                _onCustomToolbarEvent: function (e, detail) {
                    if (detail && detail.name == "originalAssetDownload") {
                        this._originalAssetsDownload();
                    }
                },
                _originalAssetsDownload: function () {
                    var rockGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid');
                    var selectedItems = rockGrid.getSelectedItems();
                    if (selectedItems && selectedItems.length) {
                        if (selectedItems.length > 5) {
                            this.showInformationToast("Simultaneous download of maximum 5 assets are allowed.");
                            return;
                        }
                        var objectKeys = [];
                        selectedItems.forEach(function (item) {
                            if (item && item.property_objectkey) {
                                objectKeys.push(item.property_objectkey)
                            }
                        }, this);
                        if (objectKeys.length) {
                            this._generateOriginalAssetsDownloadRequest(objectKeys);
                        }
                    } else {
                        this.showInformationToast("Please select at least one asset from grid to download.");
                    }
                },
                _showConfirmationDialog: function (e, detail) {
                    var selectedItems = this.getSelectedItems();
                    if (!selectedItems || selectedItems.length == 0) {
                        this.showInformationToast("Please select at least one entity from grid to delete.");
                        return;
                    }

                    this._deleteComponentName = detail.componentName;
                    this.shadowRoot.querySelector("#confirmationDialog").open();
                },
                _onBulkDelete: function () {
                    var selectedItems = this.getSelectedItems();
                    var selectionMode = this.getSelectionMode();
                    var selectionQuery = this.getSelectedItemsAsQuery();

                    //Safer code - Already delete button is hidden
                    if (selectionMode == "query") {
                        this.showInformationToast("Cannot perform delete based on 'All Search Criteria', please select the entities manually to perform this operation.");
                        return;
                    }

                    if (this.contextData) {
                        const detail = {
                            name: this._deleteComponentName,
                            contextData: this.contextData,
                            sharedData: {
                                "context-data": this.contextData,
                                "selection-query": selectionQuery,
                                "selection-mode": selectionMode,
                                "selected-entities": selectedItems
                            }
                        };

                        ComponentHelper.fireBedrockEvent("business-dialog-opened", detail, { ignoreId: true });
                    } else {
                        this.showInformationToast("Context not available, cannot perform delete operation.");
                    }
                },
                _onGetDownloadUrlResponse: function (e) {
                    const a = document.createElement('a');
                    a.download = "";

                    LiquidResponseHelper.downloadURLResponseMapper(e, downloadURL => {
                        a.href = downloadURL;
                        a.click();
                    });
                },
                _onUpload: function () {
                    const detail = {
                        name: 'rock-entity-upload',
                        contextData: this.contextData,
                        sharedData: {
                            "context-data": this.contextData
                        }
                    };

                    ComponentHelper.fireBedrockEvent("business-dialog-opened", detail, { ignoreId: true });
                },
                _onDownload: function (e, detail) {
                    var selectedItems = this.getSelectedItems();
                    var selectionMode = this.getSelectionMode();
                    var selectionQuery = this.getSelectedItemsAsQuery();

                    if (selectedItems && selectedItems.length && this.contextData) {
                        var selectedItemsCount = selectionMode == "query" ? this.totalCount : selectedItems.length;
                        
                        const detail = {
                            name: 'rock-entity-download',
                            contextData: this.contextData,
                            sharedData: {
                                "context-data": this.contextData,
                                "selection-query": selectionQuery,
                                "selection-mode": selectionMode,
                                "selected-entities": selectedItems,
                                "selected-items-count": selectedItemsCount
                            }
                        };

                        ComponentHelper.fireBedrockEvent("business-dialog-opened", detail, { ignoreId: true });
                    } else {
                        this.showInformationToast("Please select at least one entity from grid to download.");
                    }
                },
                /**
                  * <b><i>Content development is under progress... </b></i> 
                  */
                getSelectedItems: function () {
                    var rockGrid = Polymer.dom(this).node.shadowRoot.querySelector('rock-grid');
                    return rockGrid.getSelectedItems();
                },
                getSelectedItemsAsQuery: function () {
                    return this._getEntityGrid().getSelectedItemsAsQuery();
                },
                getSelectionMode: function () {
                    return this._getEntityGrid().getSelectionMode();
                },
                _onBulkEdit: function (e, detail) {
                    var selectedItems = this.getSelectedItems();
                    var selectionMode = this.getSelectionMode();
                    var selectionQuery = this.getSelectedItemsAsQuery();
                    if (selectedItems && selectedItems.length && this.contextData) {
                        var itemContexts = [];
                        if (this.typesCriterion && this.typesCriterion.length) {
                            for (var i = 0; i < this.typesCriterion.length; i++) {
                                var type = this.typesCriterion[i];
                                if (!(itemContexts.find(obj => obj.type === type))) {
                                    var itemContext = { "type": type };
                                    itemContexts.push(itemContext);
                                }
                            }
                        }
                        var clonedContextData = DataHelper.cloneObject(this.contextData);
                        clonedContextData[ContextHelper.CONTEXT_TYPE_ITEM] = itemContexts;
                        clonedContextData[ContextHelper.CONTEXT_TYPE_DATA] = [];
                        
                        const detail = {
                            name: 'rock-entity-bulk-edit',
                            configName: 'wizardConfig',
                            contextData: this.contextData,
                            sharedData: {
                                "context-data": clonedContextData,
                                "workflow-criterion": this.workflowCriterion,
                                "selection-query": selectionQuery,
                                "selection-mode": selectionMode,
                                "selected-entities": selectedItems,
                                "edit-attributes-only": true
                            }
                        };

                        ComponentHelper.fireBedrockEvent("business-dialog-opened", detail, { ignoreId: true });
                    } else {
                        this.showInformationToast("Please select at least one entity from grid to edit.");
                    }
                },
            });
        })();
    </script>
</dom-module>