<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<!-- <link rel="import" href="themes/bedrock-style-theme-default.json"> -->

<dom-module id="bedrock-style-theme-provider">
    <template>
        <iron-ajax auto url="{{themeURL}}" method="GET" handle-as="json" on-response="handleResponse" async></iron-ajax>
    </template>
    <script>
        class BedrockStyleThemeProvider
            extends Polymer.mixinBehaviors([
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior
            ], Polymer.Element) {
            static get is() { return 'bedrock-style-theme-provider' }

            static get properties() {
                return {

                    themeURL: {
                        name: {
                            type: String
                        }
                    }
                }
            }

            constructor() {
                super();
                let userContext = {
                    "roles": this.roles,
                    "user": this.userId,
                    "defaultRole": this.defaultRole
                }
                this.contextData[this.CONTEXT_TYPE_USER] = [userContext];

            }
            initiateTheme(themeSettings) {
                if (themeSettings && themeSettings.themeName) {
                    this.themeURL = '/src/elements/bedrock-style-manager/themes/bedrock-style-theme-' + themeSettings.themeName + '.json';
                } else {
                    this.themeURL = '/src/elements/bedrock-style-manager/themes/bedrock-style-theme-default.json';
                }
            }
            handleResponse(e) {
                if (e && e.detail && e.detail.response) {
                    let themeConfig = e.detail.response;
                    let mainApp = RUFUtilities.mainApp;
                    let updateStyleStructure = this._createStyleStructure(themeConfig)
                    mainApp.updateStyles(updateStyleStructure);
                }
            }
            _createStyleStructure(themeConfig) {
                let styleStructure = {};
                for (let key in themeConfig) {
                    if (themeConfig.hasOwnProperty(key)) {
                        let updatedStyleKey = '--mdm-' + key;
                        styleStructure[updatedStyleKey] = themeConfig[key];
                    }
                }
                styleStructure['--window-inner-height'] = "" + window.innerHeight + "px"

                return styleStructure;
            }
        }
        customElements.define(BedrockStyleThemeProvider.is, BedrockStyleThemeProvider)
    </script>
</dom-module>