<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-app-context-behavior/bedrock-app-context-behavior.html">
<link rel="import" href="../liquid-config-aggregate-get/liquid-config-aggregate-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">
<link rel="import" href="themes/bedrock-style-theme-default.json">


<dom-module id="bedrock-style-theme-provider">
    <template>
        <liquid-config-aggregate-get id="tenantConfigGet" verbose operation="getbyids" request-id="req1" app-name="main-app" context-data="[[contextData]]"
            on-config-get-response="_onApplicationConfigReceived"></liquid-config-aggregate-get>
        <iron-ajax auto url="{{themeURL}}" method="GET" handle-as="json" on-response="handleResponse"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'bedrock-style-theme-provider',
            properties: {
                themeURL: {
                    name: {
                        type: String
                    }
                }
            },
            behaviors: [
                RUFBehaviors.UIBehavior,
                RUFBehaviors.AppContextBehavior
            ],
            created: function () {
                var userContext = {
                    "role": this.roleId,
                    "user": this.userId
                }
                this.contextData[this.CONTEXT_TYPE_USER] = [userContext];
            },
            handleResponse: function (e) {
                if (e && e.detail && e.detail.response) {
                    var themeConfig = e.detail.response;
                    var mainApp = document.querySelector("main-app");
                    var updateStyleStructure = this._createStyleStructure(themeConfig)
                    mainApp.updateStyles(updateStyleStructure);
                }
            },
            _createStyleStructure: function (themeConfig) {
                var styleStructure = {};
                for (var key in themeConfig) {
                    if (themeConfig.hasOwnProperty(key)) {
                        var updatedStyleKey = '--mdm-'+key;
                        styleStructure[updatedStyleKey] = themeConfig[key];
                    }
                }
                return styleStructure;
            },
            _onApplicationConfigReceived: function (e) {
                this.set('applicationConfig', e.detail);
                var _tenantConfig = this.getConfig('tenant-config');
                if (_tenantConfig && _tenantConfig.themeName) {
                    this.themeURL = '/src/elements/bedrock-style-manager/themes/' + _tenantConfig.themeName + '.json';
                } else {
                    this.themeURL = '/src/elements/bedrock-style-manager/themes/bedrock-style-theme-default.json';
                }
            }
        });
    </script>
</dom-module>