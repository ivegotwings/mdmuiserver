<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">

<link rel="import" href="../liquid-entity-model-composite-get/liquid-entity-model-composite-get.html">
<link rel="import" href="../liquid-entity-data-save/liquid-entity-data-save.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-file-upload/pebble-file-upload.html">
<link rel="import" href="../pebble-dialog/pebble-dialog.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-image-viewer/pebble-image-viewer.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-checkbox/pebble-checkbox.html">
<link rel="import" href="../pebble-button/pebble-button.html">

<link rel="import" href="../rock-grid/rock-grid.html">
<link rel="import" href="../rock-classification-tree/rock-classification-tree.html">

<dom-module id="rock-entity-create-import">
    <template>
        <style include="pebble-styles-shared">
            .placeHolder {
                width: 880px;
                height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }

            #multiEntityUpperGrid::shadow iron-data-table {
                height: 135px;
            }

            #upperGridHeader {
                font-size: 12px;
                margin: 10px;
            }

            #content-actions {
                padding-top: 30px;
                position: fixed;
                bottom: 0;
                background: rgba(255, 255, 255, 0.80);
                text-align: center;
                width: 100%;
                z-index: 9999;
            }

            #content-label {
                box-shadow: 0 1px 7px 0 #c1cad4;
                padding: 15px;
                margin: 10px;
            }

            #image-container {
                width: 30px;
                height: 35px;
                vertical-align: middle;
            }

            import-log {
                vertical-align: middle;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
                color: var(--palette-steel-grey, #75808b);
            }

            pebble-button[disabled] {
                pointer-events: none;
                color: #c1cad4;
                background-color: #c1cad4;
                border-color: #c1cad4;
            }

            #showReviewChk {
                padding-right: 15%;
                --pebble-checkbox-label-color: #75808b;
            }

            .confirmSave {
                font-size: 12px;
            }

            #categoryTreeContainer {
                height: 550px;
                overflow: auto;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <liquid-rest id="entityMatchService" url="/pass-through/matchservice/search" method="POST" request-data={{_entityMatchRequest}}
            on-liquid-response="_onMatchSuccess" on-liquid-error="_onMatchFailure">
        </liquid-rest>
        <iron-ajax auto url="config\gridConfig.json" handle-as="json" last-response="{{_gridConfig}}"></iron-ajax>
        <liquid-rest id="copService" url="" method="POST" request-data={{_copRequest}} on-liquid-response="_onCOPSuccess" on-liquid-error="_onCOPFailure"></liquid-rest>
        <liquid-entity-model-composite-get name="compositeAttributeModelGet" request-data="[[attributeModelRequest]]" on-response="_onCompositeModelResponse"></liquid-entity-model-composite-get>
        <liquid-entity-data-save name="entitiesSaveDataService" operation="" request-data="{{_saveRequest}}" on-response="_onSaveResponse"></liquid-entity-data-save>
        <div id="content-entity-import" hidden>
            <p class="title"><strong>Profile Name:</strong> [[_profileName]]</p>
            <div align="right">
                <pebble-checkbox id="showReviewChk" on-change="_onPreviewChange">Show Data Preview</pebble-checkbox>
            </div>
            <div class="placeHolder p-10">
                <p class="title">
                    <a href="#" class="btn-link" on-tap="_exportDialogOpen">Download</a> a system template or just upload
                    an existing data file
                </p>
                <!-- TODO -->
                <!-- Currently pebble dialog is coming out of app and sitting on body so css has been added inline needs to resolve it with some proper way. -->                
                <pebble-dialog id="exportDialog" modal show-close-icon>
                    <div id="exportSmartExcelContent" style="height:550px">
                        <div>
                            Select one or more classifications to download the smart excel template. You can select the classification at any level and the data required for all child classifications will be shown in the template.
                        </div>
                        <div id="categoryTreeContainer" style="height:500px; overflow:auto;">
                            <rock-classification-tree id="contextTree" multi-select="true" taxonomy="productsetuptaxonomy" context-data="{{contextData}}"
                                selected-items="{{_selectedCategories}}"></rock-classification-tree>
                        </div>
                        <div id="exportActions" class="p-b-10" align="center">
                            <pebble-button style="color: #75808b;background-color: #ffffff;display: inline-block;font-weight: 400;line-height: 1.25;text-align: center;white-space: nowrap;overflow: hidden;vertical-align: middle;user-select: none;border: 1px solid #c1cad4;font-size: 14px;border-radius: 3px;transition: all .2s ease-in-out;box-sizing: border-box;text-transform: capitalize;height: 33px;width: 100px;padding-top: 6px;" 
                                id="cancel" button-text="Cancel" raised on-tap="_onCancelDownloadSelection"></pebble-button>
                            <pebble-button style="color: #fff;background-color: #09c021;border-color: #09c021;display: inline-block;font-weight: 400;line-height: 1.25;text-align: center;white-space: nowrap;overflow: hidden;vertical-align: middle;user-select: none;border: 1px solid transparent;font-size: 14px;border-radius: 3px;transition: all .2s ease-in-out;box-sizing: border-box;text-transform: capitalize;height: 33px;width: 100px;padding-top: 6px;" 
                                id="download" button-text="Download" raised on-tap="_exportSelectedCategory"></pebble-button>
                        </div>
                    </div>
                </pebble-dialog>
                <!-- screen for import -->
                <pebble-file-upload accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" target="/file-upload"></pebble-file-upload>
                <bedrock-pubsub on-bedrock-event-pebble-file-upload-success="_onFileUploadSuccess"></bedrock-pubsub>
            </div>
        </div>
        <div id="content-label" hidden>
            <pebble-image-viewer alt="Product image." id="image-container" sizing="contain" src="/src/images/Microsoft Excel 50, 100, 500 px/Microsoft Excel_100.svg"></pebble-image-viewer>
            <span class="import-log"><strong>[[_fileName]]</strong> uploaded <strong>[[_entities.length]]</strong> items with <strong>[[attributeNames.length]]</strong> attributes.</span>
        </div>
        <div id="content-mapping-grid" hidden>
            <!-- screen for multi entity create function- probably grid -->
            <div id="upperGridHeader"><b>[[attributeNames.length]] Attributes</b> ([[_managedAttrs]] Managed, [[_mappedAttrs]] Mapped, [[_newAttrs]]
                New). Last Updated on <b>[[_currentDateTime.date]]</b> at <b>[[_currentDateTime.time]]</b></div>
            <rock-grid id="multiEntityUpperGrid" page-size="2" no-header></rock-grid>
            <bedrock-pubsub on-bedrock-event-save-item="_onSaveItem"></bedrock-pubsub>
        </div>
        <div id="content-entities-grid" hidden>
            <rock-grid id="entitiesGrid" data="{{_gridData}}" page-size="10" no-header></rock-grid>
            <span class="confirmSave">Please review the data above. Save process cannot be cancelled once started.</span>
        </div>
        <div id="content-actions" class="p-b-10" align="center" hidden>
            <pebble-button class="action-button btn btn-secondary m-r-5" id="skip" button-text="Cancel" raised on-tap="_onSkipTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>
        <liquid-rest id="copDownloadService" url="" method="POST" handle-as="blob" request-data={{_copDownloadRequest}} on-liquid-response="_onCOPDownloadSuccess"
            on-liquid-error="_onCOPDownloadFailure"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-entity-create-import",

                properties: {
                    importProfileName: {
                        type: String
                    },
                    processProfileName: {
                        type: String
                    },
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Indicates the names of the attributes that are retrived from excel
                     */
                    attributeNames: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Indicates the contexts which are retrived from excel
                     */
                    contexts: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    /**
                     * Indicates the mode in which the attributes are rendered.
                     */
                    mode: {
                        type: String,
                        value: "edit",
                        notify: true
                    },
                    /**
                     * Specifies the request object for attribute model request.
                     */
                    attributeModelRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    /**
                     * Specifies the response object for attribute models.
                     */
                    attributeModelResponse: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _attributeValues: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _gridConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _managedAttrs: {
                        type: Number,
                        value: 0
                    },
                    _mappedAttrs: {
                        type: Number,
                        value: 0
                    },
                    _newAttrs: {
                        type: Number,
                        value: 0
                    },
                    _currentDateTime: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _copRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _copDownloadRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },
                    _entitiesData: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _entities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _saveRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _attributeModels: {
                        type: Object
                    },
                    _fileName: {
                        type: String
                    },
                    _currentBatchNumber: {
                        type: Number,
                        value: 0
                    },
                    _batchSize: {
                        type: Number,
                        value: 10
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    _entityMatchRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _matchedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _newEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _faultedEntities: {
                        type: Array,
                        value: function () { return []; }
                    },
                    _currentEntityIndex: {
                        type: Number
                    },
                    _currentAction: {
                        type: String,
                        value: "create"
                    },
                    _showPreview: {
                        type: Boolean,
                        value: false
                    },
                    _isDirty: {
                        type: Boolean,
                        value: false
                    },
                    _profileName: {
                        type: String,
                    },
                    _selectedCategories: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },
                observers: [
                    '_contextChanged(attributeNames, contextData, contexts)'
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                ready: function () {
                    this._showView("entity-import");
                    this._profileName = this.processProfileName;
                },
                _contextChanged: function (attributeNames, contextData, contexts) {
                    this._profileName = this.processProfileName;
                    if (attributeNames && attributeNames.length > 0 && !_.isEmpty(contextData)) {
                        var itemContext = this.getFirstItemContext();
                        //this contexts is coming from COP returned entities
                        this.contextData[ContextHelper.CONTEXT_TYPE_DATA] = contexts;

                        itemContext.attributeNames = attributeNames;

                        var t = DataRequestHelper.createEntityModelCompositeGetRequest(this.contextData);

                        this.set("attributeModelRequest", t);

                        var liquidModelGet = this.$$("[name=compositeAttributeModelGet]");
                        if (liquidModelGet) {
                            liquidModelGet.generateRequest();
                        }
                    }
                },
                _onCompositeModelResponse: function (e) {
                    if (e && e.detail && DataHelper.validateGetAttributeModelsResponse_New(e.detail.response)) {
                        if (!this._attributeModels) {
                            var attributeModels = DataTransformHelper.transformAttributeModels(e.detail.response.content.entityModels[0], this.contextData);
                            if (!_.isEmpty(attributeModels)) {
                                this.set("_attributeModels", attributeModels);
                                this._populateEntityGrid();
                            } else {
                                this.showErrorToast("Unable to fetch attribute models. Please check the service or contact your administrator.");
                                this._loading = false;
                            }
                        }
                    } else {
                        this.showErrorToast("Unable to fetch attribute models. Please check the service or contact your administrator.");
                        this._loading = false;
                    }
                },
                _showView: function (viewName) {
                    if (viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if (contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },

                _hideView: function (viewName) {
                    if (viewName) {
                        var contentView = this.$$("#content-" + viewName);
                        if (contentView) {
                            contentView.setAttribute("hidden", "");
                        }
                    }
                },
                _populateMultiEntityUpperGrid: function () {
                    //Fetch the attributes from COP and pass to this.attributeNames
                    //Based on attributeNames change, attributeModelRequest will be set
                    //Using attributeModelGetServiceFetch, attribute models will be provided

                    //Prepare grid configuration and data based on COP and Liquid details                    
                    this._prepareMultiEntityUpperGridConfiguration();
                    this._prepareMultiEntityUpperGridData();
                    this._prepareUpperGridHeader();

                    //Set config and data to grid
                    this.$$('#multiEntityUpperGrid').config = this._gridConfig;
                    this.$$('#multiEntityUpperGrid').data = this._gridData;

                    this.async(function () {
                        var gridTable = this.$$('#multiEntityUpperGrid').$$('#pebbleGridContainer').querySelector('iron-data-table');
                        var firstRow = gridTable.querySelectorAll('data-table-row')[1];
                        var secondRow = gridTable.querySelectorAll('data-table-row')[2];

                        // Section start, will be removed this logic once rock-grid updated
                        var firstRowButtons = firstRow.querySelectorAll('pebble-button');
                        if (firstRowButtons.length > 0) {
                            firstRowButtons[0].remove();
                            firstRowButtons[1].remove();
                        }
                        // Section end

                        firstRow.querySelectorAll('data-table-cell')[1].style['font-weight'] = 'bold';
                        secondRow.querySelectorAll('data-table-cell')[1].style['font-weight'] = 'bold';

                        // Attributes matched from managed list is black
                        // Attributes matched from inferred list is green
                        // Attributes are not matched (new), then red                        

                    }, 100);
                },

                _prepareMultiEntityUpperGridConfiguration: function () {
                    this._gridConfig.tabular.columns.push({
                        "header": "Mapping",
                        "name": "mapping"
                    });
                    for (var idx = 0; idx < this.attributeNames.length; idx++) {
                        this._gridConfig.tabular.columns.push({
                            "header": "Column " + (idx + 1),
                            "name": this.attributeNames[idx],
                            "displayType": "textbox"
                        });
                    }
                },

                _prepareMultiEntityUpperGridData: function () {
                    this._gridData = []; //Clear the data
                    var gridRow = {};
                    gridRow["id"] = 1;
                    gridRow["mapping"] = "Excel column name";
                    //First row
                    for (var idx = 0; idx < this.attributeNames.length; idx++) {
                        gridRow[this.attributeNames[idx]] = this.attributeNames[idx];
                    }
                    this._gridData.push(gridRow);

                    gridRow = {};
                    gridRow["id"] = 2;
                    gridRow["mapping"] = "Mapped attribute name";

                    //Second row - Capture the details from data model 
                    for (var idx = 0; idx < this.attributeNames.length; idx++) {
                        if (this._findAttribute(this.attributeNames[idx])) {
                            this._mappedAttrs++;
                            gridRow[this.attributeNames[idx]] = this._findAttribute(this.attributeNames[idx]).name;
                        } else {
                            this._newAttrs++;
                        }
                    }
                    this._gridData.push(gridRow);

                    //Current Datetime
                    var datetime = new Date();
                    this._currentDateTime = {
                        "date": moment(datetime).format('MM/DD/YYYY'),
                        "time": moment(datetime).format('hh:mm A')
                    }
                },

                _findAttribute: function (attribute) {
                    for (var i = 0; i < this._attributeValues.length; i++) {
                        for (var j = 0; j < this._attributeValues[i].attributes.length; j++) {
                            if (this._attributeValues[i].attributes[j].name == attribute) {
                                return this._attributeValues[i].attributes[j];
                            }
                        }
                    }
                },

                _prepareUpperGridHeader: function () {
                    //Total managed attributes                    
                    for (var i = 0; i < this._attributeValues.length; i++) {
                        this._managedAttrs = this._managedAttrs + this._attributeValues[i].attributes.length;
                    }
                },

                _onSaveItem: function (e, details, sender) {
                    //Save logic comes here
                },

                _onFileUploadSuccess: function (e, detail, sender) {
                    if (this.importProfileName == undefined || this.importProfileName.length == 0) {
                        this.showErrorToast("Import profile name not found. Please check the config.");
                        return;
                    }
                    this._isDirty = true;
                    this._loading = true;
                    //this._populateMultiEntityUpperGrid();
                    var fileName = detail.fileName;
                    this.set("_fileName", detail.originalFileName);
                    var copRequest = {
                        "fileName": fileName,
                        "profileName": this._profileName
                    };
                    this.set("_copRequest", copRequest);
                    var liqCOP = this.$$("#copService");
                    if (liqCOP) {
                        if (this._showPreview) {
                            liqCOP.url = "/cop/transform";
                        } else {
                            liqCOP.url = "/cop/process";
                        }
                        liqCOP.generateRequest();
                    }
                    this.async(function () {
                        //Clear file upload
                        this.$$('pebble-file-upload').reset();
                    });
                },
                _onCOPSuccess: function (e) {
                    var response = e.detail.response;
                    if (response && response.response && response.response.entities
                        && response.response.entities.length > 0) {
                        this._hideView("entity-import");
                        this._hideButtons();
                        this._showView("label");
                        this._showView("entities-grid");
                        this._entities = response.response.entities;

                        var maxNoOfRows = this._gridConfig.tabular.settings.maxNoOfRows;
                        if (maxNoOfRows && this._entities.length > maxNoOfRows) {
                            this.showErrorToast("Imported more entities than specified maximum number of entities. Please review the file imported or contact your administrator.", 3000);
                            this._loading = false;
                            this._isDirty = false;
                            return;
                        }
                        var attributeNames = EntityHelper.getAttributeNamesFromEntities(this._entities);
                        if (attributeNames && attributeNames.length > 0) {
                            var contexts = EntityHelper.getContextsFromEntities(this._entities);
                            if (contexts && contexts.length > 0) {
                                this.set("contexts", contexts);
                            }
                            //setting contexts first and then attributeNames, because there is an observer on both
                            //setting attributeNames first would send unnecessary request for model
                            this.set("attributeNames", attributeNames);
                        } else {
                            this.showErrorToast("Unable to fetch attributes from excel. Please check excel file imported or contact your administrator.");
                            this._loading = false;
                            this._isDirty = false;
                        }
                    } else if (response && response.dataObjectOperationResponse && response.dataObjectOperationResponse.status && response.dataObjectOperationResponse.status.toLowerCase() == "success") {
                        var data = {
                            "messages": [
                                {
                                    "message": "Entities will be created using the uploaded file."
                                },
                                {
                                    "message": "You can view the status of the processing in the File  Upload Status Dashboard"
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Take Me back to Where I started"
                                },
                                {
                                    "name": "nextAction",
                                    "text": "Take me to File Upload Status",
                                    "dataRoute": "dashboard"
                                }
                            ]
                        };
                        ComponentHelper.getParentElement(this).businessFunctionData = data;
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName,
                            data: { "skipNext": true }
                        };
                        this.async(function () {
                            this._loading = false;
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 5000);
                    } else {
                        console.warn("Unexpected COP response:" + e.detail.response);
                        this.showErrorToast("Unable to transform excel to json. Please check the service or contact your administrator.");
                        this._isDirty = false;
                        this._loading = false;
                    }
                },
                _onCOPFailure: function (e) {
                    console.warn('COP transformation failed with error ', e.detail);
                    this.showErrorToast("Unable to transform excel to json. Please check the service or contact your administrator.");
                    this._loading = false;
                    this._isDirty = false;
                },
                _populateEntityGrid: function () {
                    var entitiesGrid = this.$$('#entitiesGrid');
                    if (entitiesGrid) {
                        entitiesGrid.config = {};
                        entitiesGrid.data = [];
                        entitiesGrid.attributeModels = {};
                        this._prepareEntityGridConfig();
                        entitiesGrid.config = this._gridConfig;
                        this._prepareEntityGridData();
                        entitiesGrid.data = this._gridData;
                        this._loading = false;
                        this._showView("actions");
                    }
                },
                _prepareEntityGridConfig: function () {
                    if (this._attributeModels) {
                        var keys = Object.keys(this._attributeModels);
                        if (keys && keys.length > 0) {
                            for (var i = 0; i < keys.length; i++) {
                                var model = this._attributeModels[keys[i]];
                                this._gridConfig.tabular.columns.push({
                                    "header": model.externalName,
                                    "name": model.name,
                                    "sortable": true
                                });
                            }
                        }
                    }
                },
                _prepareEntityGridData: function () {
                    for (var i = 0; i < this._entities.length; i++) {
                        var entity = this._entities[i];
                        var entityId = DataHelper.getRandomString();
                        var attributes = EntityHelper.getAllAttributes(entity);
                        var keys = Object.keys(attributes);
                        if (keys && keys.length > 0) {
                            var rowData = {
                                "rowId": entityId
                            };
                            for (var j = 0; j < keys.length; j++) {
                                var key = keys[j];
                                if (this._attributeModels[key]) {
                                    rowData[key] = attributes[key].values[0].value;
                                }
                            }
                            this._gridData.push(rowData);
                        }
                    }
                },
                _onSaveTap: function (e) {
                    this._disableActions();
                    this._loading = true;
                    //get all entities from grid and process save
                    var gridData = this.$$("#entitiesGrid").data;
                    this._entities = DataTransformHelper.prepareEntitiesForCreate(gridData, this.contextData, this._attributeModels);
                    this._currentEntityIndex = 0;
                    this._generateMatchServiceRequest();
                },
                _generateMatchServiceRequest: function () {
                    if (this._currentEntityIndex < this._entities.length) {
                        var entity = this._entities[this._currentEntityIndex];
                        this.set('_entityMatchRequest', {
                            "entity": entity
                        });
                        if (this.$$("#entityMatchService")) {
                            this.$$("#entityMatchService").generateRequest();
                        }
                    } else {
                        this._currentAction = "create";
                        this._createEntities();
                    }
                },
                _onMatchSuccess: function (e, detail) {
                    if (detail.response) {
                        var response = detail.response.response;
                        if ((response.dataObjectOperationResponse && response.dataObjectOperationResponse.status &&
                            response.dataObjectOperationResponse.status.toLowerCase() == "error") ||
                            (response.status && response.status.toLowerCase() == "error")) {
                            console.warn("Failed in entity match service with error: ", detail);
                            this.showErrorToast("There is a problem in match service. Please contact administrator.");
                            this._isDirty = false;
                            return;
                        }

                        if (response.status && response.status.toLowerCase() == "success") {
                            if (response.entities) {
                                if (response.entities.length == 1) {
                                    var matchedEntity = response.entities[0];
                                    var entity = this._entities[this._currentEntityIndex];
                                    entity.id = matchedEntity.id;
                                    this._matchedEntities.push(entity);
                                } else if (response.entities.length > 1) {
                                    this._faultedEntities.push(this._entities[this._currentEntityIndex]);
                                }
                            } else {
                                this._newEntities.push(this._entities[this._currentEntityIndex]);
                            }
                            this._currentEntityIndex++;
                            this._generateMatchServiceRequest();
                        }
                    }
                },
                _onMatchFailure: function (e, detail) {
                    console.warn("Failed in entity match service with error: ", detail);
                    this.showErrorToast("There is a problem in match service. Please contact administrator.");
                    this._isDirty = false;
                },
                _createEntities: function () {
                    var batchEntities = this._getNextBatch(this._newEntities, this._currentBatchNumber, this._batchSize);
                    if (batchEntities && batchEntities.length > 0) {
                        var clientState = {};
                        clientState.notificationInfo = {};
                        clientState.notificationInfo.showNotificationToUser = false;

                        this._saveRequest = {
                            "clientState": clientState,
                            "entities": batchEntities
                        };
                        var liquidSave = this.$$("[name=entitiesSaveDataService]");
                        if (liquidSave) {
                            liquidSave.operation = this._currentAction;
                            liquidSave.generateRequest();
                        }
                    } else {
                        this._currentBatchNumber = 0;
                        this._currentAction = "update";
                        this._updateEntities();
                    }
                },
                _updateEntities: function () {
                    var batchEntities = this._getNextBatch(this._matchedEntities, this._currentBatchNumber, this._batchSize);
                    if (batchEntities && batchEntities.length > 0) {
                        var clientState = {};
                        clientState.notificationInfo = {};
                        clientState.notificationInfo.showNotificationToUser = false;

                        this._saveRequest = {
                            "clientState": clientState,
                            "entities": batchEntities
                        };
                        var liquidSave = this.$$("[name=entitiesSaveDataService]");
                        if (liquidSave) {
                            liquidSave.operation = this._currentAction;
                            liquidSave.generateRequest();
                        }
                    } else {
                        this._loading = false;

                        var msg = "Created " + this._newEntities.length + " entities and updated " + this._matchedEntities.length + " entities.";
                        if (this._faultedEntities.length > 0) {
                            msg = msg + " Found " + this._faultedEntities.length + " entities faulted.";
                        }
                        this.showSuccessToast(msg, 3000);

                        var data = {
                            "messages": [
                                {
                                    "message": msg
                                }
                            ],
                            "actions": [
                                {
                                    "name": "closeFunction",
                                    "text": "Take Me back to Where I started"
                                },
                                {
                                    "name": "nextAction",
                                    "text": "Take me to User Dashboard",
                                    "dataRoute": "dashboard"
                                }
                            ]
                        };
                        ComponentHelper.getParentElement(this).businessFunctionData = data;
                        var eventName = "onSave";
                        var eventDetail = {
                            name: eventName,
                            data: { "skipNext": true }
                        };
                        this.async(function () {
                            this.fireBedrockEvent(eventName, eventDetail, {
                                ignoreId: true
                            });
                        }, 5000);
                    }
                },
                _onSaveResponse: function (e) {
                    this._currentBatchNumber++;
                    if (this._currentAction == "create") {
                        this._createEntities();
                    } else if (this._currentAction == "update") {
                        this._updateEntities();
                    }
                },
                _onSkipTap: function (e) {
                    //raise event with name given for onbackAction in configuration
                    var data;
                    var eventName = "onCancel";
                    var eventDetail = {
                        name: eventName,
                        data: data
                    }
                    this.fireBedrockEvent(eventName, eventDetail, {
                        ignoreId: true
                    });
                },
                _hideButtons: function () {
                    var parentEl = ComponentHelper.getParentElement(this);
                    if (parentEl && parentEl.hideCreateButtons) {
                        parentEl.hideCreateButtons();
                    }
                },
                _getNextBatch: function (entities, currentBatchNumber, batchSize) {
                    var start = currentBatchNumber * batchSize;
                    var end = ((currentBatchNumber + 1) * batchSize) - 1;
                    if (start > entities.length) {
                        return;
                    }
                    if (end > entities.length) {
                        end = entities.length - 1;
                    }
                    return entities.slice(start, end + 1);
                },
                _disableActions: function () {
                    var saveButton = this.$$("#next");
                    var cancelButton = this.$$("#skip")
                    saveButton.setAttribute("disabled", true);
                    cancelButton.setAttribute("disabled", true);
                },
                _onPreviewChange: function (e) {
                    var chkbox = e.currentTarget;
                    if (chkbox.checked) {
                        this._showPreview = true;
                        this._profileName = this.importProfileName;
                    } else {
                        this._showPreview = false;
                        this._profileName = this.processProfileName;
                    }
                },
                getIsDirty: function () {
                    return this._isDirty;
                },
                _exportDialogOpen: function () {
                    var exportDialog = this.$$("#exportDialog");

                    if (exportDialog) {
                        exportDialog.dialogTitle = "Download Smart Excel Template";
                        this._selectedCategories = [];
                        exportDialog.open();
                    }
                },
                _onCancelDownloadSelection: function () {
                    var exportDialog = document.querySelector("#exportDialog");

                    if (exportDialog) {
                        exportDialog.close();
                    }
                },
                _exportSelectedCategory: function (e) {
                    var copDownloadLiquid = this.$$("#copDownloadService");
                    if (copDownloadLiquid && this._selectedCategories && this._selectedCategories.length) {
                        var contexts = [];
                        var firstItemContext = this.getFirstItemContext();
                        var fileName = "CategoryTemplate";

                        this._selectedCategories.forEach(function (category) {
                            contexts.push({
                                "taxonomy": "productsetuptaxonomy",
                                "classification": category.valuePath
                            });
                        }, this);

                        if(this._selectedCategories.length == 1) {
                            fileName = this._selectedCategories[0].value;
                        }

                        if (firstItemContext && contexts.length) {
                            this._copDownloadRequest = {
                                "params": {
                                    "query": {
                                        "contexts": contexts,
                                        "filters": {
                                            "typesCriterion": [
                                                "entityManageModel"
                                            ]
                                        },
                                        "id": firstItemContext.type + "_entityManageModel"
                                    },
                                    "fields": {
                                        "attributes": ["_ALL"],
                                        "relationships": ["_ALL"]
                                    }
                                },
                                "fileName": fileName
                            };

                            copDownloadLiquid.url = "/cop/downloadModelExcel";
                            copDownloadLiquid.generateRequest();
                        }
                    }
                },
                _onCOPDownloadSuccess: function (e) {
                    if (e.detail && e.detail.response) {
                        var response = e.detail.response;
                        if(response) {
                            var fileName = response.fileName + ".xlsx";
                            window.open('/file-download?fileName='+ fileName);                          
                        }
                    }
                },
                _onCOPDownloadFailure: function (e) {
                    console.error('File download failed : ', JSON.stringify(e.detail.response));
                }
            });
        })();
    </script>
</dom-module>