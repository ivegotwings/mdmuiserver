<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<!--
`pebble-tag-item` Represents a tag item which is used in filters. It also indicates some selections.

### Example

        <pebble-tag-item id="ex1" 
                         name="Brand" 
                         show-icon 
                         icon="settings" 
                         show-expand-icon 
                         show-remove-icon 
                         index="0">
        </pebble-tag-item>

### Styling
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--tag-container` | Mixin applied to tag container | {}
`--tag-name` | Mixin applied to tag display name | {}
`--tag-value` | Mixin applied to tag display value | {}
`--expand-more-icon-styles` | Mixin applied to expand icon | {}
`--close-icon-styles` | Mixin applied to close icon | {}
`--expand-icon-section` | Mixin applied to expand section | {}
`--close-icon-section` | Mixin applied to close section | {}

@group Pebble Elements
@element pebble-tag-item
@demo demo/index.html
-->
<dom-module id="pebble-tag-item">
    <template>
        <style include="pebble-styles-app"></style>
        <style>
            :host {
                display: inline-flex;
                display: -webkit-inline-flex;
                box-sizing: border-box;
                margin-right:var(--default-margin-right,6px);
                vertical-align: top;
                --default-tag-border:#d2d7dd;                
                font-size: var(--default-font-size, 14px);
            }           
            .tag-value {
                font-size:var(--font-size-sm);
                line-height: var(--default-tag-height,21px);
                display:inline-flex;
            }
            .tag-item-container {                
                @apply(--tag-style);
                float:left;
                margin: 4px 0;
                border-left-color: var(--tag-color);
                @apply(--tag-container);
            }           
                       
            .name {
                color:var(--text-primary-color, #1a2028);
                @apply(--tag-name);                
            }
            .value {
                padding-left: 4px;
                color:var(--text-primary-color, #1a2028);                
                @apply(--tag-value);                
            }            
            .expand-more {
                padding-left: 4px;
                @apply(--expand-icon-section);
            }
            .expand-more pebble-icon {
                cursor: pointer;
                @apply(--expand-more-icon-styles);
            }
            .close-icon {
                @apply(--close-icon-section);
            }
            .close-icon pebble-icon {
                cursor: pointer;
                @apply(--close-icon-styles);
            }
        </style>
        <div id="pebble-tag" class="tag-item-container border">
            <template is="dom-if" if="{{_displayIcon(showIcon)}}">
                <pebble-icon id="icon" src="[[src]]" icon="[[icon]]"></pebble-icon>
            </template>
            <span class="tag-value" on-tap="_onTapEvent">
                <span class="name">{{longName}}</span>
                <template is="dom-if" if="{{value}}">
                    <span class="value">
                       : {{_getDisplayValue(value)}}
                    </span>
                </template>
                <template is="dom-if" if="{{showExpandIcon}}">
                    <span class="expand-more">
                        <pebble-icon icon="pebble-icons:ExpandMore"></pebble-icon>
                    </span>
                </template>
            </span>
            <template is="dom-if" if="{{showRemoveIcon}}">
                <span class="close-icon">                    
                    <pebble-icon on-tap="_removeItem" icon="pebble-icons:TagCancel"></pebble-icon>
                </span>
            </template>
        </div>        
    </template>
    <script>
        Polymer({
            is: 'pebble-tag-item',
            properties: {
                /**
                 * Fired when the tag is to be removed from the tag list.
                 *
                 * @event tag-item-remove
                 */

                /**
                 * Fired when the tag is not editable and on tap of tag.
                 *
                 * @event tag-item-tap
                 */
                               
                /**
                 * Indicates the value of the attribute shown in the tag.
                 */
                index: {
                    type: Number,                    
                    notify: true
                },                

                /**
                 * Indicates the display value of the attribute
                 */
                displayValue: {
                    type: String,
                    value: "",
                    notify: true
                },

                /**
                 * Indicates the display value params
                 */
                displayParams: {
                    type: Array,
                    value: function() { return []; },
                    notify: true
                },

                /**
                 * Indicates the value of the attribute shown in the tag.
                 */
                value: {
                    type: Object,
                    value: function(){ return {}; },
                    notify: true
                },

                /**
                 * Indicates the name of the attribute shown in the tag.
                 */
                name: {
                    type: String,
                    value: null,
                    notify: true
                },
                /**
                 * Indicates the long name of the attribute shown in the tag.
                 */
                longName: {
                    type: String,
                    value: null,
                    notify: true
                },
                /**
                 * Indicates the color of the tag.
                 */
                tagColor: {
                    type: String,
                    notify: true,
                    observer: '_colorChanged'
                },
                /**
                 * Indicates to capture more options
                 */
                options: {
                    type: Object,
                    value: function() { return {}; }
                },

                /**
                * Specifies whether or not to show remove icon on tag.
                */
                showRemoveIcon: {
                    type: Boolean,
                    value: false
                },                
                /**
                 * Specifies the icon name or index in the set of icons available in
                 * the icon set. Note that you must not specify the `src` property when the `icon` property is specified.
                 */
                icon: {
                    type: String,
                    value: ''
                },
                /**
                 * Indicates the URL of an image for the icon. Note that you must not specify the `src` property when the `icon` property is specified.
                 */
                src: {
                    type: String,
                    value: ''
                },
                /**
                * Specifies whether or not to show icon on tag.
                */
                showIcon: {
                    type: Boolean,
                    value: false
                },
                /**
                * Specifies whether or not to show expand icon on tag.
                */
                showExpandIcon: {
                    type: Boolean,
                    value: false
                }              
            },

            behaviors: [
                RUFBehaviors.UIBehavior
            ],

            attached: function () {
                if (!this.longName && this.name) {
                    this.longName = this.name;
                }

                if (!this.displayType) {
                    this.displayType = "textArea";
                }
                this.fireBedrockEvent('tag-item-attached', this._getCurrentTag(), { ignoreId: true });

            },

            /**
             * This method is called when someone taps on the tag. If tag is editable, then the tag is switched to edit mode otherwise tag-item-select event is fired
             */
            _onTapEvent: function (e) {
                this.fireBedrockEvent('tag-item-tap', this._getCurrentTag(), { ignoreId: true });
            },

            /**
             * Handler for removing the tag item
             */
            _removeItem: function () {
                this.fireBedrockEvent('tag-item-remove', this._getCurrentTag(), { ignoreId: true });
            },

            _getCurrentTag: function(){
                return {                    
                    "name": this.name,
                    "longName": this.longName,
                    "value": this.value,
                    "index": this.index,
                    "options": this.options                    
                };
            },
                      
            /**
             * Handler for checking if tagColor attribute is changed and if changed, change the color of the tag to the new color
             */
            _colorChanged: function () {
                if (this.tagColor) {
                    this.customStyle['--tag-color'] = this.tagColor;                    
                }
                this.updateStyles();                
            },

            _displayIcon: function() {
                if(this.showIcon && (this.icon || this.src))
                {
                    return true;
                }

                return false;
            },

            _getDisplayValue: function() {
                this.displayValue = ""; //Clear the display value
                var seperator = " - ";

                if(!this.displayParams || this.displayParams.length == 0) //Set default params
                {
                    this.displayParams = ["eq"];
                }

                if(this.value && !_.isEmpty(this.value))
                {                    
                    for(var i = 0; i < this.displayParams.length; i++)
                    {
                        this.displayValue += this.value[this.displayParams[i]] + seperator;
                    }
                    
                    if(this.displayValue && this.displayValue.indexOf(seperator) != -1)
                    {
                        // Remove last seperator and return value
                        return this.displayValue.slice(0, (this.displayValue.length - seperator.length));
                    }
                }

                return "";
            }

        });
    </script>
</dom-module>