<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-externalref-falcor/bedrock-externalref-falcor.html">

<script>
    /*
     * <i><b>Content development is under progress... </b></i>
     * @demo demo/index.html
     * @polymerBehavior RUFBehaviors.AppContextBehavior
     */
    window.RUFBehaviors = window.RUFBehaviors || {};

    RUFBehaviors.AppContextBehavior = {
        /**
          * Content is not appearing - Content development is under progress. 
          */
        attached: function () {
            //We cannot addd <bedrock-pubsub... component in the behavior hence we need to listen event dynamically by accessing the element directly..
            // Someday, we should find way to get bedrock event hook without dealing with control directly...
            var eventName = 'rock-dimension-selector-data-changed-' + this.id;
            var dimensionSelectors = this.shadowRoot.querySelector("rock-dimension-selector");
            if (dimensionSelectors) {
                if (dimensionSelectors.length) {
                    for (var i = 0; i < dimensionSelectors.length; i++) {
                        this.listen(dimensionSelectors[i], eventName, '_onDimensionsChanged');
                    }
                } else {
                    this.listen(dimensionSelectors, eventName, '_onDimensionsChanged');
                }
            }
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        ready: function () {
            this._setDefaultContexts();
        },
        properties: {
            /**
              * Content is not appearing - Content development is under progress. 
              */
            contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            valContextKeys: {
                type: Object,
                value: function () {
                    return ['source', 'locale'];
                }
            },
            /**
          * Content is not appearing - Content development is under progress. 
          */
            CONTEXT_TYPE_DOMAIN: {
                type: String,
                value: 'DomainContexts'
            },
            /**
           * Content is not appearing - Content development is under progress. 
           */
            CONTEXT_TYPE_DATA: {
                type: String,
                value: 'Contexts'
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            CONTEXT_TYPE_VALUE: {
                type: String,
                value: 'ValContexts'
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            CONTEXT_TYPE_ITEM: {
                type: String,
                value: 'ItemContexts'
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            CONTEXT_TYPE_APP: {
                type: String,
                value: 'AppContexts'
            },
            /**
              * Content is not appearing - Content development is under progress. 
              */
            CONTEXT_TYPE_USER: {
                type: String,
                value: 'UserContexts'
            }
        },
        _setDefaultContexts: function () {
        },
        _onDimensionsChanged: function (e) {
            var newDimensions = e.detail.dimensions;
            this._updateFromDimensionSelector(newDimensions);
        },
        _updateFromDimensionSelector: function (newDimensions) {
            if (!newDimensions) {
                return;
            }

            var selDataContextsFlat = {};
            var selValContextsFlat = {};
            var self = this;

            // scope out data contexts vs val contexts
            Object.keys(newDimensions).map(function (dimName) {

                var dimValues = newDimensions[dimName];
                if (self._valContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selValContextsFlat[dimName] = dimValues;
                } else {
                    selDataContextsFlat[dimName] = dimValues;
                }
            });

            //TODO:: UI needs to start supporting classification selection as part of dimension selector..till then system would run only for classification as "_ALL"
            // if(!selDataContextsFlat['classification']) {
            //     selDataContextsFlat['classification'] = ['_ALL'];
            // }

            if (!_.isNull(selDataContextsFlat) && !_.isEmpty(selDataContextsFlat)) {
                var contextToBeDeleted = [];
                Object.keys(selDataContextsFlat).map(function (dimName) {
                    var dimValues = selDataContextsFlat[dimName];
                    if (!(dimValues && dimValues.length)) {
                        contextToBeDeleted.push(dimName);
                    }
                });
                for (var i = 0; i < contextToBeDeleted.length; i++) {
                    delete selDataContextsFlat[contextToBeDeleted[i]];
                }
                this.contextData[this.CONTEXT_TYPE_DATA] = _.createCartesianObjects(selDataContextsFlat);
            }

            if (!_.isNull(selValContextsFlat) && !_.isEmpty(selValContextsFlat)) {
                var valContextToBeDeleted = [];
                Object.keys(selValContextsFlat).map(function (dimName) {
                    var dimValues = selValContextsFlat[dimName];
                    if (!(dimValues && dimValues.length)) {
                        valContextToBeDeleted.push(dimName);
                    }
                });
                for (var i = 0; i < valContextToBeDeleted.length; i++) {
                    delete selDataContextsFlat[valContextToBeDeleted[i]];
                }
                this.contextData[this.CONTEXT_TYPE_VALUE] = _.createCartesianObjects(selValContextsFlat);
            }

            this._publishChangeEvent();
        },
        _publishChangeEvent: function (additionalInfo) {
            var contextChangedEvent = {
                'contextData': this.contextData
            };

            if (additionalInfo) {
                contextChangedEvent.additionalInfo = additionalInfo;
            }

            // Id check is done to make sure we fire event only after host element is ready with all its rendering...
            if (this.id != "") {
                ComponentHelper.fireBedrockEvent("app-context-changed", contextChangedEvent, {
                    ignoreId: true
                }, this);
            }
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        updateContext: function (contextType, contexts, additionalInfo) {
            this.contextData[contextType] = contexts;
            this._publishChangeEvent(additionalInfo);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getContexts: function (contextType) {
            return this.contextData[contextType] !== undefined ? this.contextData[contextType] : [];
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getDomainContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_DOMAIN);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getDataContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_DATA);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getItemContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_ITEM);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getValueContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_VALUE);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getUserContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_USER);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getAppContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_APP);
        },
        /**
          * Content is not appearing - Content development is under progress. 
          */
        getConfigContexts: function () {
            //enhance this..
            var configContexts = _.createCartesianObjects(this._contextData);
            return configContexts;
        }
    };

</script>