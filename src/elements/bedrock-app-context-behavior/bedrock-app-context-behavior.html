<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../bedrock-externalref-falcor/bedrock-externalref-falcor.html">

<script>
    /*
    * @demo demo/index.html
    * @polymerBehavior RUFBehaviors.AppContextBehavior
    */
    var RUFBehaviors = RUFBehaviors || {};
    
    RUFBehaviors.AppContextBehavior = {
        attached: function () { },
        ready: function () { 
            this._setDefaultContexts();
        },
        listeners: {
            'rock-dimension-selector-data-changed': '_onDimensionsChanged',
        },
        properties: {
            contextData: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            _valContextKeys: {
                type: Object,
                value: function () {
                    return ['source', 'locale'];
                }
            },
            CONTEXT_TYPE_DATA: {
                type: String,
                value: 'Contexts'
            },
            CONTEXT_TYPE_VALUE: {
                type: String,
                value: 'ValContexts'
            },
            CONTEXT_TYPE_ITEM: {
                type: String,
                value: 'ItemContexts'
            },
            CONTEXT_TYPE_APP_INSTANCE: {
                type: String,
                value: 'AppInstanceContexts'
            },
            CONTEXT_TYPE_USER: {
                type: String,
                value: 'UserContexts'
            }
        },
        _setDefaultContexts: function () {
            //TODO:: this default context should be either come form dimension selector or from user pref
            var valueContexts = [{'locale': 'en-US', 'source': 'internal'}];
            this.updateContext(this.CONTEXT_TYPE_VALUE, valueContexts);
        },
        _onDimensionsChanged: function(e) {
            var newDimensions = e.detail.dimensions;
            this._updateFromDimensionSelector(newDimensions);
        },
        _updateFromDimensionSelector: function(newDimensions) {
            if(!newDimensions) {
                return;
            }
            
            var selDataContextsFlat = {};
            var selValContextsFlat = {};

            // scope out data contexts vs val contexts
            for(var i = 0; i < newDimensions.length; i++) {
                var selectedDimensionData = newDimensions[i];
                
                var dimName = Object.keys(selectedDimensionData)[0];
                var dimValues = selectedDimensionData[dimName];

                if(this._valContextKeys.indexOf(dimName) > -1) { // is this val context?
                    selValContextsFlat[dimName] = dimValues;
                }
                else {
                    selDataContextsFlat[dimName] = dimValues;
                }   
            }

            if(!this._isNullOrEmpty(selDataContextsFlat)) {
                this.contextData[this.CONTEXT_TYPE_DATA] = _.createCartesianObjects(selDataContextsFlat);
            }

            if(!this._isNullOrEmpty(selValContextsFlat)) {
                this.contextData[this.CONTEXT_TYPE_VALUE] = _.createCartesianObjects(selValContextsFlat);
            }

            this._publishChangeEvent();
        },
        _publishChangeEvent: function() {
            var contextChangedEvent = {
                'detail': {
                    'contextData': this.contextData
                }
            };

            ComponentHelper.fireBedrockEvent("app-context-changed", contextChangedEvent, null, this);
        },
        updateContext: function(contextType, contexts) {
            this.contextData[contextType] = contexts;
            this._publishChangeEvent();
        },
        getContexts: function(contextType) {
            return this.contextData[contextType] !== undefined ? this.contextData[contextType] : [];
        },
        getDataContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_DATA);
        },
        getItemContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_ITEM);
        },
        getValueContexts: function () {
            return this.getContexts(this.CONTEXT_TYPE_VALUE);
        },
        getUserContexts: function() {
            return this.getContexts(this.CONTEXT_TYPE_USER);
        },
        getAppInstanceContexts : function() {
            return this.getContexts(this.CONTEXT_TYPE_APP_INSTANCE);
        },
        getConfigContexts: function() {
            var configContexts = _.createCartesianObjects(this._contextData);
            return configContexts;
        }
    };

</script>