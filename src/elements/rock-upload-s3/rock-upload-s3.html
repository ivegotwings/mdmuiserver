<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/data-transform-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-common.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-style-gridsystem.html">

<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-bulk-file-upload/pebble-bulk-file-upload.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->

<dom-module id="rock-upload-s3">
    <template>
        <style include="bedrock-style-common bedrock-style-gridsystem">
            .placeHolder {
                max-height: 400px;
                margin: 0 auto;
                box-shadow: 0 0 10px 0 var(--cloudy-blue-color, #c1cad4);
                position: relative;
            }

            #content-actions {
                padding-top: 30px;
                position: fixed;
                bottom: 0;
                background: rgba(255, 255, 255, 0.80);
                text-align: center;
                width: 100%;
                z-index: 9999;
            }

            #content-label {
                box-shadow: 0 1px 7px 0 var(--cloudy-blue-color, #c1cad4);
                padding: 15px;
                margin: 10px;
            }

            #image-container {
                width: 30px;
                height: 35px;
                vertical-align: middle;
            }

            import-log {
                vertical-align: middle;
            }

            .title {
                font-size: var(--default-font-size, 14px);
                text-align: center;
                color: var(--palette-steel-grey, #75808b);
            }
        </style>

        <pebble-spinner active="[[_loading]]"></pebble-spinner>

        <liquid-rest id="prepareUploadLiquid" url="/data/binarystreamobjectservice/prepareUpload" method="POST" request-data={{_prepareUploadRequest}}
            on-liquid-response="_onPrepareUploadLiquidSuccess" on-liquid-error="_onPrepareUploadLiquidFailure"></liquid-rest>
        <liquid-rest id="createUploadedFilesLiquid" url="/data/binarystreamobjectservice/create" method="POST" request-data={{_createUploadedFilesRequest}}
            on-liquid-response="_onCreateUploadedFilesLiquidSuccess" on-liquid-error="_onCreateUploadedFilesLiquidFailure"></liquid-rest>

        <div id="content-upload">
            <div class="placeHolder col-8 p-20">
                <bedrock-pubsub on-bedrock-event-pebble-bulk-file-upload-started="_onUploadStarted" name="bedrock-event-pebble-bulk-file-upload-started"></bedrock-pubsub>
                <pebble-bulk-file-upload method="PUT" accept="" no-auto="true" s3-upload="true" max-file-size="5000000000" max-files=350></pebble-bulk-file-upload>
                <bedrock-pubsub on-bedrock-event-pebble-bulk-file-upload-success="_onUploadSuccess" name="bedrock-event-pebble-bulk-file-upload-success"></bedrock-pubsub>
                <bedrock-pubsub on-bedrock-event-pebble-bulk-file-upload-failed="_onUploadFailed" name="bedrock-event-pebble-bulk-file-upload-failed"></bedrock-pubsub>
            </div>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-upload-s3",

                properties: {
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    target: {
                        type: String,
                        value: ''
                    },
                    _prepareUploadRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _createUploadedFilesRequest: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    _loading: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * Indicates an array of files that are either processed or uploaded.
                     **/
                    files: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                    businessFunctionData: {
                        type: Object,
                        value: function () { return {}; }
                    }
                },
                behaviors: [
                    RUFBehaviors.UIBehavior
                ],
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                ready: function () {
                },
                _onUploadStarted: function (e, uploadedFiles, sender) {
                    var prepareUploadRequest = [];
                    this.files = [];
                    Object.keys(uploadedFiles).forEach(key => {
                        var file = uploadedFiles[key]
                        if(!file.error) {
                            this.files.push(file);
                            
                            //Generate unique file name...
                            var s3ObjectKey = this._generateS3ObjectKey(file.name);
                            file.s3ObjectKey = s3ObjectKey;

                            var originalFileName = file.name;

                            var binaryStreamObject = {
                                "binaryStreamObject": {
                                    "id": DataHelper.generateUUID(),
                                    "type": "binarystreamobject",
                                    "properties": {
                                        "objectKey": s3ObjectKey,
                                        "originalFileName": originalFileName
                                    },
                                    "data": {}
                                }
                            };

                            prepareUploadRequest.push(binaryStreamObject);
                        }
                    });

                    if(prepareUploadRequest.length > 0) {
                        this.set("_prepareUploadRequest", prepareUploadRequest);
                        var liq = this.shadowRoot.querySelector("#prepareUploadLiquid");
                        if (liq) {
                            liq.generateRequest();
                        }
                    }
                },
                _onPrepareUploadLiquidSuccess: function (e) {
                    var response = e.detail.response;
                    var canUpload = false;

                    if (response && response.response) {
                        var binarystreamobjects = response.response.binaryStreamObjects;
                        if (binarystreamobjects) {
                            for (let binarystreamobject of binarystreamobjects) {
                                var data = binarystreamobject.data;

                                if (data && data.properties && data.properties.uploadURL && data.properties.uploadURL.length > 0) {
                                    for (let file of this.files) {
                                        if (file.s3ObjectKey == data.properties.objectKey) {
                                            file.uploadTarget = data.properties.uploadURL;
                                            canUpload = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (canUpload) {
                        this.shadowRoot.querySelector('pebble-bulk-file-upload').uploadFiles(this.files);
                    }
                    else {
                        console.warn("Unexpected response:" + e.detail.response);
                        this.showErrorToast("Unable to upload. Please check the service or contact your administrator.");
                        this._isDirty = false;
                        this._loading = false;
                        this.shadowRoot.querySelector('pebble-bulk-file-upload').reset();
                    }
                },
                _onPrepareUploadLiquidFailure: function (e) {
                    console.warn('Upload failed with error ', e.detail);
                    this.showErrorToast("Unable to upload. Please check the service or contact your administrator.");
                    this._loading = false;
                    this._isDirty = false;
                    this.shadowRoot.querySelector('pebble-bulk-file-upload').reset();
                },
                 _onUploadSuccess: function (e, succeededFilesData, sender) {
                    this._isDirty = true;
                    this._loading = true;

                    var data = {
                        "messages": [
                            {
                                "message": "Asset upload is in process."
                            },
                            {
                                "message": "You can view the status of the processing in the File Upload Status Dashboard"
                            }
                        ],
                        "actions": [
                            {
                                "name": "closeFunction",
                                "text": "Take Me back to Where I started"
                            },
                            {
                                "name": "nextAction",
                                "text": "Take me to File Upload Status",
                                "dataRoute": "dashboard"
                            }
                        ]
                    };
                    this.businessFunctionData = data;
                    var eventName = "onSave";
                    var eventDetail = {
                        name: eventName,
                        data: { "skipNext": false }
                    };
                    setTimeout(() =>{
                        this._loading = false;
                        this.fireBedrockEvent(eventName, eventDetail, {
                            ignoreId: true
                        });
                    }, 5000);
                },
                _onUploadFailed: function (e, errorMessage, sender) {
                    this.showErrorToast(errorMessage);
                },
                // _onUploadSuccess: function (e, succeededFilesData, sender) {
                //     this._isDirty = true;
                //     this._loading = true;

                //     //TODO:: Need to give appropriate message in case only few files upload succeeded...
                //     var createRequest = this._generateCreateRequest(succeededFilesData);

                //     this.set("_createUploadedFilesRequest", createRequest);
                //     var liq = this.shadowRoot.querySelector("#createUploadedFilesLiquid");
                //     if (liq) {
                //         liq.generateRequest();
                //     }
                // },
                // _onCreateUploadedFilesLiquidSuccess: function (e) {
                //     var response = e.detail.response;
                //     if (response && response.response && response.response.status && response.response.status.toLowerCase() == "success") {
                //         var data = {
                //             "messages": [
                //                 {
                //                     "message": "Asset upload is in process."
                //                 },
                //                 {
                //                     "message": "You can view the status of the processing in the File Upload Status Dashboard"
                //                 }
                //             ],
                //             "actions": [
                //                 {
                //                     "name": "closeFunction",
                //                     "text": "Take Me back to Where I started"
                //                 },
                //                 {
                //                     "name": "nextAction",
                //                     "text": "Take me to File Upload Status",
                //                     "dataRoute": "dashboard"
                //                 }
                //             ]
                //         };
                //         this.businessFunctionData = data;
                //         var eventName = "onSave";
                //         var eventDetail = {
                //             name: eventName,
                //             data: { "skipNext": false }
                //         };
                //         this.async(function () {
                //             this._loading = false;
                //             this.fireBedrockEvent(eventName, eventDetail, {
                //                 ignoreId: true
                //             });
                //         }, 5000);
                //     } else {
                //         console.warn("Unexpected response:" + e.detail.response);
                //         this.showErrorToast("Unable to upload. Please check the service or contact your administrator.");
                //         this._isDirty = false;
                //         this._loading = false;
                //         this.shadowRoot.querySelector('pebble-bulk-file-upload').reset();
                //     }
                // },
                _onCreateUploadedFilesLiquidFailure: function (e) {
                    console.warn('Asset upload failed with error ', e.detail);
                    this.showErrorToast("Unable to upload. Please check the service or contact your administrator.");
                    this._loading = false;
                    this._isDirty = false;
                    this.shadowRoot.querySelector('pebble-bulk-file-upload').reset();
                },
          /**
            * <b><i>Content development is under progress... </b></i> 
            */
                getIsDirty: function () {
                    return this._isDirty;
                },
                _generateS3ObjectKey: function (fileName) {
                    var s3ObjectKey;
                    var indexOfExtension = fileName.lastIndexOf(".");
                    var fileNameText = fileName.substr(0, indexOfExtension);
                    var fileExt = fileName.substr(indexOfExtension, fileName.length);

                    var uuid = DataHelper.generateUUID();
                    s3ObjectKey = uuid + fileExt;
                    return s3ObjectKey;
                },
                _generateCreateRequest: function (succeededFilesData) {
                    var createRequest = [];
                    for (let fileData of succeededFilesData) {
                        var uuid = DataHelper.generateUUID();
                        var s3ObjectKey = fileData.fileName;

                        var fileObject;
                        for (let file of this.files) {
                            if (file.s3ObjectKey == s3ObjectKey) {
                                fileObject = file;
                                break;
                            }
                        }

                        var originalFileName = s3ObjectKey;
                        var fullObjectPath = s3ObjectKey;
                        
                        if (fileObject) {
                            originalFileName = fileObject.name;
                            fullObjectPath = fileObject.fullObjectPath;
                        }


                        var binaryStreamObject = {
                            "binaryStreamObject": {
                                "id": uuid,
                                "type": "binarystreamobject",
                                "properties": {
                                    "objectKey": s3ObjectKey,
                                    "fullObjectPath": fullObjectPath,
                                    "originalFileName": originalFileName
                                }
                            }
                        };

                        createRequest.push(binaryStreamObject);
                    }

                    return createRequest;
                },
                _showView: function (viewName) {
                    if (viewName) {
                        var contentView = this.shadowRoot.querySelector("#content-" + viewName);
                        if (contentView) {
                            contentView.removeAttribute("hidden");
                        }
                    }
                },
            });
        })();
    </script>
</dom-module>