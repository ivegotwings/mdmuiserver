<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/component-helper.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/entity-helper.html">
<link rel="import" href="../bedrock-helpers/message-helper.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">

<link rel="import" href="../rock-grid-data-sources/entity-govern-grid-datasource.html">

<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-styles-shared/pebble-styles-shared.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">

<dom-module id="rock-govern-data-grid">
    <template>
        <style include="pebble-styles-shared"></style>
        <style is="custom-style">
            pebble-data-table {
				--pebble-data-table-header: {
					height: 45px;
				}
				--pebble-data-table-row-odd: {
					background-color: var(--secondary-button-color, #ffffff);
				}
			}

			pebble-data-table[loading] {
				pointer-events: none;
			}
			
			pebble-data-table data-table-row[header],
			pebble-data-table data-table-row[header] /deep/ label {
				font-weight: var(--font-bold, bold);
				color: var(--palette-cerulean, #036bc3);
				border-bottom: none;
				text-transform: uppercase;
				font-size: var(--table-head-font-size, 11px);
			}
            
            data-table-checkbox {
				border-right: none;
				padding: 0 10px 0 0;
				height: auto;
				flex-basis: 25px;
			}

			data-table-checkbox[header] {
				min-height: 32px!important;
				height: auto!important;
				justify-content: flex-start;
			}
            data-table-cell,
			data-table-cell[header] {
				padding: 0 0 0 10px;
				height: auto;
			}

			data-table-cell a {
				width: 100%;
			}
            data-table-cell[header] {
				font-size: var(--font-size-sm, 12px);
				color: var(--palette-cerulean, #036bc3);
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
			}

			data-table-cell[header]:hover {
				color: var(--palette-steel-grey, #75808b);
			}

			data-table-cell:not([header]) {
				min-height: 48px!important;
				height: auto !important;
			}
            .cell {
				font-size: 14px;
				display: inline-block;
				width: 100%;
				vertical-align: middle;
				max-height: 100px;
				overflow-y: auto;
			}
            .entity-icon-outer {
                width: 15px;
                margin-right: 8px;
                float: left;
            }

            .entity-icon-outer pebble-icon {
                margin-top: -1px;
            }

            .entity-content.Invalid {
                color: #F6444A;
            }

            .entity-content.unknown {
                color: var(--text-primary-color, #1a2028);
            }
            pebble-button[disabled] {
                pointer-events: none;
                color: #c1cad4;
                background-color: #c1cad4;
                border-color: #c1cad4;
            }
            .check-filter{
				flex-basis: 25px!important;
				flex-grow: 0!important;
				overflow: visible!important;
				position: relative;
				padding: 0;
			}
            #container {
                padding: 20px 10px 0px 10px;
            }
            .grid-header {
                font-size: 14px;
                font-weight: bold;
                padding-bottom: 10px;
            }
        </style>
        <div id="container">
            <span class="grid-header">[[title]]</span>
            <entity-govern-grid-datasource id="governGridDataSource" context-data="[[contextData]]" 
                data-source="{{dataSource}}" request="{{request}}" data-formatter="{{dataFormatter}}" 
                business-conditions-data="{{businessConditionsData}}" current-record-size="{{gridDataSize}}" 
                total-records="{{totalRecords}}" total-count="{{totalCount}}" business-conditions-for-entity-types="{{businessConditionsForEntityTypes}}"></entity-govern-grid-datasource>
            <pebble-data-table id="govern-grid" data-source="[[dataSource]]" size="[[gridDataSize]]" 
                page-size="20" selected-items="{{selectedItems}}" selected-item="{{selectedItem}}" multi-selection>
                <data-table-column name="Entity Name" data-tooltip="Entity Name" class="tooltip-bottom">
                    <template>
                        <a href$="[[_getLink(item)]]">
                            <div index="[[index]]" class="cell">[[item.entityName]]</div>
                        </a>
                    </template>
                </data-table-column>
                <data-table-column name="Workflow Name" data-tooltip="Workflow Name" class="tooltip-bottom">
                    <template>
                        <div index="[[index]]" class="cell">[[item.workflowName]]</div>
                    </template>
                </data-table-column>
                <data-table-column name="Activity Name" data-tooltip="Activity Name" class="tooltip-bottom">
                    <template>
                        <div index="[[index]]" class="cell">[[item.activityName]]</div>
                    </template>
                </data-table-column>
                <data-table-column name="Assigned To" data-tooltip="Assigned To" class="tooltip-bottom">
                    <template>
                        <div index="[[index]]" class="cell">[[item.assignedUser]]</div>
                    </template>
                </data-table-column>
                <data-table-column name="Previous Step Comments" data-tooltip="Previous Step Comments" class="tooltip-bottom">
                    <template>
                        <div index="[[index]]" class="cell">[[item.previousStepComments]]</div>
                    </template>
                </data-table-column>
                <data-table-column name="Actions" data-tooltip="Actions" class="tooltip-bottom">
                    <template>
                        <template is="dom-repeat" items="[[item.actions]]" as="action">
                            <pebble-button class="action-button btn btn-secondary" index="[[index]]" raised button-text="[[action.actionText]]" on-tap="_onWfActionTap" disabled="[[_isDisabled(item)]]"></pebble-button>
                        </template>
                    </template>
                </data-table-column>
                <template is="dom-repeat" id="columns-template" items="[[businessConditionsData]]" as="businessCondition" index-as="colIndex">
                    <data-table-column name="[[businessCondition.name]]" class="tooltip-bottom" data-tooltip="[[businessCondition.name]]" column-object="[[businessCondition]]" column-index="{{colIndex}}">
                        <template>
                            <div class="entity-icon-outer">
                                <pebble-icon icon="[[_getIconByType(item, column.columnObject)]]" class="pebble-sm-icons"></pebble-icon>
                            </div>
                            <div class$="cell entity-content [[_getClassByType(item, column.columnObject)]]">[[_columnValue(item, column.columnObject)]]</div>
                        </template>
                    </data-table-column>
                </template>
            </pebble-data-table>
        </div>
    </template>
    <script>
         (function (){
             'use strict';

            Polymer({
                is: "rock-govern-data-grid",

                properties: {
                    request: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },
                    businessConditionsData: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        observer: '_businessConditionsChanged'
                    },
                    /**
                     * Specifies the format of the data that are passed to the `remote-data`.
                     */
                    dataFormatter: {
                        notify: true,
                        value: function () {
                            return this._prepareGridData.bind(this);
                        }
                    },
                    dataSource: {
						type: Object,
						notify: true
					},
                    /**
					 * Indicates the title for the grid.
					 */
					title: {
						type: String,
						notify: true
					},
                    /**
					 * Indicates the total record size of the grid.
					 * The above description depicts on how to increase this `recordSize`.
					 */
					totalRecords: {
						notify: true,
						type: Number,
						value: 0
					},
                    /**
					 * Indicates the total record size of the data available for the grid.
					 *
					 */
					totalCount: {
						notify: true,
						type: Number,
						value: 0
					},
                    businessConditionsForEntityTypes: {
                        type: Object,
                        value: function () { return {}; }
                    },
                    /**
					 * Indicates an array that contains the selected items when `multiSelection` is set to true.
					 * It indicates null if no item is selected.
					 */
					selectedItems: {
						type: Array,
						value: function () {
							return [];
						},
						notify: true
					},
                    /**
					 * Indicates the currently selected item when `multiSelection` is set to false.
					 * It indicates null if no item is selected.
					 */
					selectedItem: {
						type: Object,
						//value : {},
						notify: true,
						reflectToAttribute: true
					},
                },
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],
                observers: [
                    '_computeTitle(totalCount, totalRecords)'
                ],
                listeners: {
					'selecting-item': '_onSelectingItem',
					'deselecting-item': '_onDeselectingItem',
					'selecting-all-items': '_onSelectingAllItems',
					'deselecting-all-items': '_onDeselectingAllItems'
				},
                _getIronDataTable: function () {
					return ElementHelper.getElement(this, "pebble-data-table");
				},
                _onSelectingItem: function (e) {
					this.fireBedrockEvent("govern-grid-selecting-item", e.detail);
				},
				_onDeselectingItem: function (e) {
					this.fireBedrockEvent("govern-grid-deselecting-item", e.detail);
				},
				_onSelectingAllItems: function (e) {
					this.fireBedrockEvent("govern-grid-selecting-all-items", e.detail);
				},
				_onDeselectingAllItems: function (e) {
					this.fireBedrockEvent("govern-grid-deselecting-all-items", e.detail);
				},
                reRenderGrid: function() {
                    var datasourceElement = this.$$("#governGridDataSource");
                    var grid = this.$$("#govern-grid");

                    if(datasourceElement && grid) {
                        datasourceElement.resetDataSource();
                        grid._resetData(this.dataSource);
                    }
                },
                getData: function () {
                    var filteredData = [];
                    var ironDataTable = this._getIronDataTable();
                    if (ironDataTable) {
                        var allData = ironDataTable.$.list.items;
                        if (allData && allData.length > 0) {
                            var lastPageData = allData.slice(allData.length - this.pageSize, allData.length);
                            var lastPageFilteredData = lastPageData.filter(function (element) {
                                if (element != undefined) {
                                    var keys = Object.keys(element);
                                    if (!(keys.length <= 0 || (keys.length == 1 && keys[0] == "errors"))) {
                                        return element;
                                    }
                                }
                            });
                            if (allData.length > this.pageSize) {
                                filteredData = allData.slice(0, allData.length - this.pageSize);
                                if (lastPageFilteredData && lastPageFilteredData.length) {
                                    lastPageFilteredData.forEach(function (item) {
                                        filteredData.push(item);
                                    }, this);
                                }
                            } else {
                                filteredData = lastPageFilteredData;
                            }
                        }
                    }
                    return filteredData;
				},
                /**
				 * Can be used to clear the current selection state.
				 */
				clearSelection: function () {
                    var ironDataTable = this._getIronDataTable();
                    ironDataTable.clearSelection();
				},
                /**
				 * Can be used to select the list item at the given index.
				 *
				 * @method selectItem
				 * @param {(Object|number)} item The item object or its index
				 */
				selectItem: function (item) {
                    var ironDataTable = this._getIronDataTable();
                    ironDataTable.selectItem(item);
				},
                /**
				 * Can be used to reset the grid size.
				 */
				notifyResize: function () {
					var ironDataTable = this._getIronDataTable();
					ironDataTable.notifyResize()
				},

				/**
				 * Can be used to set the scroll position dynamically.
				 */
				scrollToIndex: function (index) {
                    var ironDataTable = this._getIronDataTable();
					ironDataTable.$$('#list').scrollToIndex(index);
				},

				/**
				 * Can be used to get the selected grid row.
				 */
				getSelectedGridRow: function () {
					var ironDataTable = this._getIronDataTable();
					return ironDataTable.querySelector('data-table-row[selected]');
				},

				/**
				 * Can be used to get the selected item index.
				 */
				getSelectedItemIndex: function () {
					if (this.getData().length > 0 && this.selectedItem) {
						return this.getData().indexOf(this.selectedItem);
					}
					return -1;
				},
                /**
				 * Can be used to change the mode to edit mode.
				 *
				 */

				getSelectionMode: function () {
					if (this.selectionInfo && this.selectionInfo.mode) {
						return this.selectionInfo.mode;
					}
					return 'count';//default value
				},
                getSelectedItemsAsQuery: function (e) {
					var queryObject = {};
					var dataSourceElement = this.$$("#governGridDataSource");
					var selectionMode = this.getSelectionMode();

					if (dataSourceElement && dataSourceElement.request && dataSourceElement.request.params) {
						var searchQueryParams = dataSourceElement.request.params;
						if (selectionMode == 'query') {
							queryObject = DataHelper.cloneObject(searchQueryParams.query);
						} else if (selectionMode == 'count') {
							var selectedItems = this.getSelectedItems();
							if (selectedItems && selectedItems.length > 0) {
								var entityIds = [];
								for (var i = 0; i < selectedItems.length; i++) {
									entityIds.push(selectedItems[i].id);
								}
								queryObject.ids = entityIds;
								queryObject.filters = {};
								queryObject.filters.typesCriterion = searchQueryParams.query.filters.typesCriterion;
							}
						}
					}
					return queryObject;
				},
                /**
				 * Can be used to return the array of `selectedItems`.
				 * When `multiSelection` is set to true, then the array contains the selected items.
				 * @return {Array<object>} The `selectedItems` is an array of objects and other properties as below.
				 * If `selectedItems.inverted` is `true`, then the array contains deselected items.
				 * The `selectedItems.filters` contains an array of filters that are active when the selection changes.
				 */
				getSelectedItem: function () {
					var ironDataTable = this._getIronDataTable();
					return ironDataTable.selectedItem;
				},
				/**
				  * <b><i>Content development is under progress... </b></i> 
				  */
				getSelectedItems: function () {
					if (!this.selectedItems.inverted) {
						return this.selectedItems;
					} else {
						var items = this.getData();
						this.selectedItems.forEach(function (item) {
							var index = items.indexOf(item);
							if (index > -1) {
								items.splice(index, 1);
							}
						});
						return items;
					}
				},
                _prepareGridData: function(data) {
                    var entitiesGovernData = data.entitiesGovernData;
                    var gridData = [];
                    if(!_.isEmpty(entitiesGovernData)) {
                        for(var i=0; i<entitiesGovernData.length; i++) {
                            var entityGovernData = entitiesGovernData[i];
                            var rowData = {
                                "id": entityGovernData.id,
                                "entityName": entityGovernData.name,
                                "type": entityGovernData.type,
                                "workflowName": entityGovernData.workflowLongName,
                                "activityName": entityGovernData.activityLongName,
                                "assignedUser": entityGovernData.assignedUser,
                                "allowedRoles": entityGovernData.allowedRoles,
                                "actions": entityGovernData.actions,
                                "previousStepComments": entityGovernData.previousStepComments,
                                "businessConditions": entityGovernData.businessConditions,
                                "linkTemplate": "entity-manage?id={id}&type={type}"
                            };
                            gridData.push(rowData);
                        }
                    }
                    return gridData;
                },
                _columnValue: function(entity, businessCondition) {
                    var status = "";
                    if(!_.isEmpty(entity) && !_.isEmpty(businessCondition)) {
                        var entityType = entity.type;
                        var entityBusinessCondition = undefined
                        if(entity.businessConditions && entity.businessConditions.length > 0) {
                            entityBusinessCondition = entity.businessConditions.find(obj => obj.id == businessCondition.id);
                        }
                        if(entityBusinessCondition) {
                            status = entityBusinessCondition.status;
                        } else {
                             var entityTypeBusinessConditions = this.businessConditionsForEntityTypes && 
                                                                this.businessConditionsForEntityTypes[entityType] && 
                                                                this.businessConditionsForEntityTypes[entityType].businessConditions ? 
                                                                this.businessConditionsForEntityTypes[entityType].businessConditions : [];
                            if(!_.isEmpty(entityTypeBusinessConditions) && entityTypeBusinessConditions.indexOf(businessCondition.id) != -1) {
                                status = "unknown";
                            }
                        }
                    }
                    return this._getBusinessConditionStatus(status);
                },
                _getBusinessConditionStatus: function(status) {
                    if(typeof(status) === "boolean") {
                        if(status) {
                            return "Valid";
                        } else {
                            return "Invalid";
                        }
                    } else if(status == "unknown") {
                        return "Not Checked";
                    } else {
                        return "-NA-"
                    }
                },
                _getLink: function (item) {
					if(!_.isEmpty(item)) {
                        var _this = this;
                        return item.linkTemplate.replace(/\{\S+?\}/g,
                            function (match) {
                                var attrName = match.replace("{", "").replace("}", "");
                                if (attrName.toLowerCase() == "id") {
                                    return encodeURIComponent(item.id);
                                }
                                if (attrName.toLowerCase() == "type") {
                                    return encodeURIComponent(item.type);
                                }

                                return encodeURIComponent(match);
                            });
                    }
				},
                _getIconByType: function (entity, businessCondition) {
                    var type = this._columnValue(entity, businessCondition);
                    if(type == "Invalid") {
                        return 'pebble-sm-icons:errorcheck';
                    } else if(type == "Valid") {
                        return 'pebble-sm-icons:successCheck';
                    } else if(type == "Not Checked"){
                        return 'pebble-sm-icons:indeterminate';
                    } else {
                        return "";
                    }
                },
                _getClassByType: function(entity,  businessCondition) {
                    var type = this._columnValue(entity, businessCondition);
                    if(type == "Invalid") {
                        return "Invalid";
                    } else if(type == "Valid") {
                        return "";
                    } else if(type == "Not Checked"){
                        return "unknown";
                    } else {
                        return "";
                    }
                },
                _isDisabled: function(entity) {
                    if(entity && entity.allowedRoles && entity.allowedRoles instanceof Array && this.roleId) {
                        if(entity.allowedRoles.indexOf(this.roleId) != -1) {
                            return false;
                        }
                    }
                    return true;
                },
                _computeTitle: function(totalCount, totalRecords) {
                    var title = "Showing 1 - " + totalRecords + " items of total " + totalCount + " results ";
                    this.set("title", title);
                },
                _businessConditionsChanged: function(businessConditionsData) {
                    this.$$("#columns-template").render();
                }
            });
         })();
    </script>
</dom-module>