<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">

<link rel="import" href="../liquid-entity-data-get/liquid-entity-data-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-value-mappings-grid">
    <template>
        <style include="bedrock-style-common">
            :host {
                --paper-input-container: {
                    bottom: 8px;
                    position: relative;
                }
                ;
                --item-length-overflow: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            pebble-popover {
                --pebble-popover-width: 260px;
            }

            pebble-textbox {
                --pebble-textbox-paper-input-style: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }

            #inputDiv pebble-textbox {
                --pebble-textbox-paper-input-style: {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    width: 90%;
                }
            }

            #inputDiv {
                width: 250px;
            }

            .attributes-text .context-text {
                line-height: 56px;
            }

            #iconDiv {
                align-self: flex-end;
                -webkit-align-self: flex-end;
                padding: 0 15px;
                margin-left: -32px;
                cursor: pointer;
                margin-bottom: 10px;
            }

            .actionButton {
                height: 20px;
                width: 20px;
            }

            pebble-data-table {
                height: 340px;
            }

            pebble-data-table data-table-row[header] {
                font-weight: var(--font-bold, bold);
                color: var(--palette-cerulean, #036bc3);
                border-bottom: none;
                text-transform: uppercase;
                font-size: var(--table-head-font-size, 11px);
            }

            pebble-data-table data-table-row:not([header]) {
                color: var(--palette-dark, #1a2028);
                font-size: var(--default-font-size, 12px);
                height: 100%;
                background-color: var(--palette-white, #ffffff);
            }

            pebble-data-table data-table-row:not([header]):hover,
            pebble-data-table data-table-row[selected] {
                background-color: var(--table-row-selected-color, #c1cad4) !important;
            }

            pebble-data-table data-table-row:not([header]):hover data-table-checkbox,
            pebble-data-table data-table-row[selected] data-table-checkbox {
                background-color: var(--palette-white, #ffffff) !important;
            }

            pebble-data-table data-table-checkbox {
                flex-basis: 16px !important;
                padding: 0 !important;
            }

            pebble-data-table data-table-row data-table-cell.check-filter {
                flex: 0 0 16px !important;
                padding: 0!important;
            }

            pebble-data-table data-table-row[header] {
                --pebble-direction-icon-button: {
                    opacity: 0.7 !important;
                }
            }

            pebble-data-table data-table-row data-table-cell {
                padding: 0 0 0 10px!important;
            }

            #gridManage {
                text-align: right;
                margin-right: 10px;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <div id="gridManage">
            <pebble-button class="iconButton m-r-5" title="Add" id="add" icon="pebble-icon:Add" raised on-tap="_onAddTap"></pebble-button>
            <pebble-button class="iconButton m-r-5" title="Delete" id="delete" icon="pebble-icon:Delete" raised on-tap="_onDeleteTap"></pebble-button>
        </div>
        <div id="grid-container">
            <!-- <template is="dom-if" if="[[_isDataAvailable(_gridData)]]"> -->
            <pebble-data-table id="mapping-grid" items="{{_gridData}}" multi-selection>
                <data-table-column slot="column-slot" name="Given Value">
                    <template>
                        <pebble-textbox slot="cell-slot-content" class="column-text" id="given-value_[[index]]" row-id="[[index]]" value="{{item.givenValue}}"
                            title="{{item.givenValue}}" on-change="_onGivenValueChange"></pebble-textbox>
                    </template>
                </data-table-column>
                <data-table-column slot="column-slot" name="Governed Value">
                    <template>
                        <div id="inputDiv" slot="cell-slot-content" on-tap="_onAttributeTap" index="[[index]]">
                            <pebble-textbox readonly class="attributes-text" id="govern-text_[[index]]" row-id="[[index]]" value="[[item.governedValue]]"
                                title="[[item.governedValue]]"></pebble-textbox>
                        </div>
                        <div id="iconDiv" slot="cell-slot-content">
                            <pebble-icon-updated class="dropdown-icon pebble-icon-size-10" id="txtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-icon:Down"
                                on-tap="_showReferenceLOV"></pebble-icon-updated>
                        </div>
                    </template>
                </data-table-column>
            </pebble-data-table>
            <!-- </template> -->
            <bedrock-pubsub event-name="entity-lov-selection-changed" handler="_onReferenceSelection" target-id="rockReferenceLov"></bedrock-pubsub>
            <pebble-popover class="reference-popover" id="referencePopover" for="" no-overlap vertical-align="auto" horizontal-align="auto">
                <rock-entity-lov id="rockReferenceLov" request-data="[[_lovRequestData]]" title-pattern="{entity.name}"></rock-entity-lov>
            </pebble-popover>
        </div>
        <div id="actions-container" class="m-t-20" align="center">
            <pebble-button class="action-button btn btn-secondary m-r-5" id="cancel" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
            <pebble-button class="action-button-focus dropdownText btn btn-success m-r-5" id="next" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
        </div>
        <liquid-entity-data-get id="initiateSearch" operation="initiatesearch" request-data="{{_valueMappingRequest}}" last-response="{{initiateSearchResponse}}"
            on-error="_onGetSearchError" on-response="_onInitiateSearchResponse"></liquid-entity-data-get>
        <liquid-entity-data-get id="getSearchResultDetail" operation="getsearchresultdetail" request-data="{{_valueMappingRequest}}"
            request-id="[[initiateSearchResponse.content.requestId]]" last-response="{{getEntitySearchResultsResponse}}" on-error="_onGetSearchError"
            on-response="_onGetSearchResultDetailResponse"></liquid-entity-data-get>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-value-mappings-grid",

                properties: {
                    contextData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    mappingsData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    _isDirty: {
                        type: Boolean,
                        value: false
                    },

                    _gridData: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _valueMappingRequest: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "valueContexts": [],
                                        "contexts": [],
                                        "filters": {
                                            "typesCriterion": []
                                        }
                                    },
                                    "fields": {
                                        "attributes": [
                                            "_ALL"
                                        ]
                                    }
                                }
                            }
                        }
                    },

                    _lovRequestData: {
                        type: Object,
                        value: function () {
                            return {
                                "params": {
                                    "query": {
                                        "valueContexts": [],
                                        "filters": {
                                            "typesCriterion": []
                                        }
                                    },
                                    "fields": {
                                        "attributes": [
                                            "_ALL"
                                        ]
                                    }
                                }
                            }
                        }
                    },

                    _deletedMappings: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    }
                },
                observers: [
                    "_onMappingsDataChange(mappingsData, contextData)"
                ],
                behaviors: [
                    RUFBehaviors.UIBehavior,
                    RUFBehaviors.ComponentContextBehavior
                ],

                _onMappingsDataChange: function () {
                    if (!_.isEmpty(this.contextData) && !_.isEmpty(this.mappingsData)) {
                        this._valueMappingRequest.params.query.valueContexts = this.contextData.ValContexts;
                        var userContext = ContextHelper.getFirstUserContext(this.contextData);
                        this._valueMappingRequest.params.query.contexts.push({
                            "suppliername": userContext.tenant,
                            "attributename": this.mappingsData.attribute
                        });
                        this._valueMappingRequest.params.query.filters.typesCriterion.push(this.mappingsData.valueMappingTypeName);

                        var liqGetInitiateSearch = this.shadowRoot.querySelector("#initiateSearch");
                        if (liqGetInitiateSearch) {
                            liqGetInitiateSearch.generateRequest();
                        }

                        //Set LOV request
                        this._lovRequestData.params.query.valueContexts = this.contextData.ValContexts;
                        this._lovRequestData.params.query.filters.typesCriterion.push(this.mappingsData.attribute);
                    }
                },

                _onInitiateSearchResponse: function (e) {
                    var liqGetSearchResultDetail = this.shadowRoot.querySelector('#getSearchResultDetail');
                    if (liqGetSearchResultDetail) {
                        liqGetSearchResultDetail.generateRequest();
                    }
                },

                _onGetSearchResultDetailResponse: function (e, detail) {
                    //console.log('response str', JSON.stringify(detail.response.content.entities[0].data.contexts, null, 4));
                    if (DataHelper.isValidObjectPath(detail, "response.content.entities")) {
                        var entities = detail.response.content.entities;
                        var gridData = [];
                        for (var i = 0; i < entities.length; i++) {
                            if (entities[i].data && entities[i].data.contexts && entities[i].data.contexts.length > 0) {
                                var dataContexts = entities[i].data.contexts[0]; // Which contains attributes
                                var attributeValue = "";
                                if (DataHelper.isValidObjectPath(dataContexts, "attributes.attributevalue.values")) {
                                    attributeValue = dataContexts.attributes.attributevalue.values[0];
                                }

                                if (DataHelper.isValidObjectPath(dataContexts, "attributes.mappedvalue.values")) {
                                    if (dataContexts.attributes.mappedvalue.values.length > 0) {
                                        //Prepare row data and push to grid
                                        var mappedValues = dataContexts.attributes.mappedvalue.values;
                                        for (var j = 0; j < mappedValues.length; j++) {
                                            gridData.push({
                                                "givenValue": mappedValues[j].value,
                                                "governedValue": attributeValue.value,
                                                "source": "system",
                                                "action": ""
                                            });
                                        }
                                    }
                                }
                            }
                        }

                        this.set("_gridData", gridData);
                    }
                },

                _isDataAvailable: function (data) {
                    if (data && data.length > 0) {
                        return true;
                    }
                    return false;
                },

                _onCancelTap: function () {
                    var eventName = "value-mapping-cancel";
                    var eventDetail = {
                        "name": eventName,
                    };
                    this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                },

                _showReferenceLOV: function (e) {
                    var rowId = e.currentTarget.rowId;
                    if (rowId >= 0) {
                        var lov = this.shadowRoot.querySelector("#rockReferenceLov");
                        var popover = this.shadowRoot.querySelector("#referencePopover");
                        if (lov && popover) {
                            lov.currentRowId = rowId;
                            popover.for = "govern-text_" + rowId;
                            popover.show();
                        }
                    }
                },

                _onReferenceSelection: function (e, detail) {
                    var lov = this.shadowRoot.querySelector("#rockReferenceLov");
                    if (lov) {
                        var rowId = lov.currentRowId;
                        if (rowId >= 0) {
                            var governTxtbox = this.root.querySelector("#govern-text_" + rowId);
                            if (!governTxtbox) {
                                governTxtbox = this.shadowRoot.querySelector("#govern-text_" + rowId);
                            }
                            if (governTxtbox) {
                                var row = this._getParentRow(governTxtbox)
                                if (row) {
                                    row.item.attributeModel = detail.data;
                                    if (row.item["action"] != "new") {
                                        row.item["action"] = "updated";
                                    }
                                    row.item["governedValue"] = detail.data.title;
                                    governTxtbox.value = detail.data.title;
                                    governTxtbox.title = detail.data.title;
                                }
                            }
                        }
                    }
                    var popover = this.shadowRoot.querySelector("#referencePopover");
                    if (popover) {
                        popover.for = "";
                        popover.hide();
                    }
                },

                _onAddTap: function () {
                    this.push("_gridData", {
                        "givenValue": "",
                        "governedValue": "",
                        "source": "ui",
                        "action": "new"
                    });
                },

                _onDeleteTap: function () {
                    var grid = this.shadowRoot.querySelector("#mapping-grid");
                    if (grid) {
                        var selectedItems = grid.getSelectedItems();
                        if (selectedItems.length == 0) {
                            //Show message if needed - Please select an item for delete
                            return;
                        }
                        var gridData = [];
                        for (var i = 0; i < this._gridData.length; i++) {
                            var isDelete = false;
                            for (var j = 0; j < selectedItems.length; j++) {
                                if (this._gridData[i].givenValue.toLowerCase() == selectedItems[j].givenValue.toLowerCase()) {
                                    isDelete = true;
                                    break;
                                }
                            }

                            if (!isDelete) {
                                gridData.push(this._gridData[i]);
                            } else {
                                if (this._gridData[i].action != "new") {
                                    this._gridData[i].action = "deleted";
                                    this._deletedMappings.push(this._gridData[i]);
                                }
                            }
                        }

                        this.set("_gridData", gridData);
                    }
                },

                _getParentRow: function (element) {
                    if (element) {
                        if (element.is == "data-table-row") {
                            return element;
                        } else {
                            return this._getParentRow(element.parentNode);
                        }
                    }
                    return undefined;
                },

                _onGivenValueChange: function (e, detail) {
                    var rowId = e.currentTarget.rowId;
                    if (rowId >= 0) {
                        var givenTxtbox = this.root.querySelector("#given-value_" + rowId);
                        if (!givenTxtbox) {
                            givenTxtbox = this.shadowRoot.querySelector("#given-value_" + rowId);
                        }
                        if (givenTxtbox) {
                            var row = this._getParentRow(givenTxtbox)
                            if (row) {
                                if (row.item["action"] != "new") {
                                    row.item["action"] = "updated";
                                }
                            }
                        }
                    }
                },

                _onSaveTap: function () {
                    //take the _gridData & _deletedMappings details and do the save value mappings, 
                    //on saveMappings response trigger below event
                    var eventName = "value-mapping-save";
                    var eventDetail = {
                        "name": eventName,
                    };
                    this.fireBedrockEvent(eventName, eventDetail, { ignoreId: true });
                }
            });
        })();
    </script>
</dom-module>