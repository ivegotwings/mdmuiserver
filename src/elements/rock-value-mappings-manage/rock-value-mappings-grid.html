<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../bedrock-ui-behavior/bedrock-ui-behavior.html">
<link rel="import" href="../bedrock-pubsub/bedrock-pubsub.html">
<link rel="import" href="../bedrock-component-context-behavior/bedrock-component-context-behavior.html">
<link rel="import" href="../bedrock-helpers/data-helper.html">
<link rel="import" href="../bedrock-helpers/context-helper.html">

<link rel="import" href="../liquid-entity-model-get/liquid-entity-model-get.html">
<link rel="import" href="../liquid-rest/liquid-rest.html">

<link rel="import" href="../pebble-icons/pebble-icons.html">
<link rel="import" href="../pebble-icon/pebble-icon.html">
<link rel="import" href="../pebble-spinner/pebble-spinner.html">
<link rel="import" href="../pebble-button/pebble-button.html">
<link rel="import" href="../pebble-popover/pebble-popover.html">
<link rel="import" href="../pebble-data-table/pebble-data-table.html">
<link rel="import" href="../pebble-textbox/pebble-textbox.html">
<link rel="import" href="../pebble-toast/pebble-toast.html">
<link rel="import" href="../pebble-actions/pebble-actions.html">

<link rel="import" href="../rock-entity-lov/rock-entity-lov.html">
<link rel="import" href="../rock-dimension-selector/rock-dimension-selector.html">
<link rel="import" href="../bedrock-style-manager/styles/bedrock-mapping-grid-style.html">
<link rel="import" href="../bedrock-mapping-grid-behavior/bedrock-mapping-grid-behavior.html">

<!--
<b><i>Content development is under progress... </b></i>

@demo demo/index.html
-->
<dom-module id="rock-value-mappings-grid">
    <template>
        <style include="bedrock-mapping-grid-style">
            :host {
                display: block;
                height: 100%;
            }
            .button-siblings{
                height:calc(100% - 50px);
            }
            pebble-actions {
                text-transform: none;
            }
        </style>
        <pebble-spinner active="[[_loading]]"></pebble-spinner>
        <!--Common toast is hidden under the dialog, so used this toast-->
        <pebble-toast id="valueMappingToast" vertical-align="top" auto-close>
            [[toastText]]
        </pebble-toast>
        <div class="base-grid-structure">
            <div class="base-grid-structure-child-1">
                <div id="grid-heading">
                    <strong>Value Mapping for [[_attributeTitle]]</strong>
                </div>
                <div id="context-header">
                    <span class="pull-right">
                        <rock-dimension-selector id="valueDimensionSelector" context-data="[[contextData]]" app-name="app-business-function-mapping"
                            domain="[[mappingData.domain]]" all-single-select show-confirmation$="[[_isMappingChanged]]" confirmation-message="[[_dirtyCheckConfirmationMessage]]"></rock-dimension-selector>
                        <bedrock-pubsub event-name="dimension-selector-data-changed" handler="_onDimensionsChanged" target-id="valueDimensionSelector"></bedrock-pubsub>
                        <bedrock-pubsub event-name="dimension-selector-confirmation-ok" handler="_onDimensionConfirmationOK" target-id="valueDimensionSelector"></bedrock-pubsub>
                    </span>
                </div>
                <div id="gridManage">
                    <span class="gridCountMsg">[[_getGridRecordsCountMessage(_gridData)]]</span>
                    <span class="pull-right">
                        <pebble-icon class="pebble-icon-size-16 tooltip-bottom m-r-10" id="add" icon="pebble-icon:action-add" data-tooltip="Add"
                            raised on-tap="_onAddTap"></pebble-icon>
                        <pebble-icon class="pebble-icon-size-16 tooltip-bottom" id="delete" icon="pebble-icon:action-delete" data-tooltip="Delete"
                            raised on-tap="_onDeleteTap"></pebble-icon>
                    </span>
                </div>
            </div>
            <div class="base-grid-structure-child-2">
                <div id="grid-container" class="full-height">
                    <div class="button-siblings">
                        <pebble-data-table id="mapping-grid" items="{{_gridData}}" multi-selection>
                            <data-table-column slot="column-slot" name="Given Value">
                                <template>
                                    <pebble-textbox slot="cell-slot-content" class="column-text" id="given-value_[[index]]" no-label-float row-id="[[index]]"
                                        value="{{item.givenValue}}" title="{{item.givenValue}}" on-change="_onGivenTextChange"></pebble-textbox>
                                </template>
                            </data-table-column>
                            <data-table-column slot="column-slot" name="Governed Value">
                                <template>
                                    <div id="inputDiv" slot="cell-slot-content" index="[[index]]">
                                        <pebble-textbox readonly="[[_isReferenceField]]" class="attributes-text" id="govern-text_[[index]]" no-label-float row-id="[[index]]"
                                            value="[[item.governedValue]]" title="[[item.governedValue]]" on-change="_onGovernTextChange"></pebble-textbox>
                                    </div>
                                    <template is="dom-if" if="[[_isReferenceField]]">
                                        <div id="iconDiv" slot="cell-slot-content">
                                            <pebble-icon class="dropdown-icon pebble-icon-size-10" id="txtDropdownIcon_[[index]]" row-id="[[index]]" icon="pebble-icon:navigation-action-down"
                                                on-tap="_showReferenceLOV"></pebble-icon>
                                        </div>
                                    </template>
                                </template>
                            </data-table-column>
                        </pebble-data-table>
                        <bedrock-pubsub event-name="entity-lov-selection-changed" handler="_onReferenceSelection" target-id="rockReferenceLov"></bedrock-pubsub>
                        <pebble-popover class="reference-popover" id="referencePopover" for="" no-overlap vertical-align="auto" horizontal-align="auto">
                            <rock-entity-lov id="rockReferenceLov" request-data="[[_lovRequestData]]" title-pattern="{entity.name}" multi-select="[[multiSelect]]"></rock-entity-lov>
                        </pebble-popover>
                    </div>
                    <div id="actions-container" class="m-t-10" align="center">
                        <pebble-button class="action-button btn btn-secondary m-r-10" id="cancel" button-text="Cancel" raised on-tap="_onCancelTap"></pebble-button>
                        <pebble-button class="action-button btn btn-success m-r-10" id="save" button-text="Save" raised on-tap="_onSaveTap"></pebble-button>
                        <pebble-button class="action-button btn btn-success m-r-10" id="saveandback" button-text="Save & Continue" raised on-tap="_onSaveAndGobackTap"></pebble-button>
                    </div>
                </div>

            </div>
        </div>

        <!--Dirty check dialog-->
        <pebble-dialog id="value-mappings-dirty-check-Dialog" dialog-title="Confirmation" modal alert-box show-cancel show-ok no-cancel-on-outside-click
            no-cancel-on-esc-key>
            <p>[[_dirtyCheckConfirmationMessage]]</p>
        </pebble-dialog>
        <bedrock-pubsub event-name="on-buttonok-clicked" handler="_discardValueChanges" target-id="value-mappings-dirty-check-Dialog"></bedrock-pubsub>

        <liquid-entity-model-get name="liquidAttributeModelGet" operation="getbyids" on-response="_onAttributeModelGetResponse" on-error="_onAttributeModelError"></liquid-entity-model-get>
        <liquid-entity-model-get name="liquidReferenceManageModelGet" operation="getbyids" on-response="_onReferenceManageModelGetResponse"
            on-error="_onReferenceManageModelGetError"></liquid-entity-model-get>
        <liquid-rest id="getMappings" url="/data/cop/getMappings" method="POST" on-liquid-response="_onGetMappingsResponse" on-liquid-error="_onMappingsError"></liquid-rest>
        <liquid-rest id="saveMappings" url="/data/cop/saveMappings" method="POST" on-liquid-response="_onMappingsSaveResponse" on-liquid-error="_onMappingsError"></liquid-rest>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: "rock-value-mappings-grid",

                properties: {
                    copContext: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _isDirty: {
                        type: Boolean,
                        value: false
                    },

                    _lovRequestData: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _attributeTitle: {
                        type: String,
                        value: null
                    },

                    _attributeModel: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _isReferenceField: {
                        type: Boolean,
                        value: false
                    },

                    _referenceLOVRequest: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    _refChangeDeletedMappings: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    multiSelect: {
                        type: Boolean,
                        value: false
                    },

                    saveActions: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    saveContinueActions: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    selectedRole: {
                        type: String,
                        value: ""
                    },

                    selectedOptions: {
                        type: Object,
                        value: function () {
                            return { "role": "_DEFAULT", "ownershipData": "_DEFAULT", "saveType": "self" }
                        }
                    }
                },

                behaviors: [
                    RUFBehaviors.MappingGridBehavior
                ],

                get referenceLOV() {
                    this._referenceLOV = this._referenceLOV || this.shadowRoot.querySelector("#rockReferenceLov");
                    return this._referenceLOV;
                },

                get referencePopoverEl() {
                    this._referencePopoverEl = this._referencePopoverEl || this.shadowRoot.querySelector("#referencePopover");
                    return this._referencePopoverEl;
                },

                get valueMappingToast() {
                    this._valueMappingToast = this._valueMappingToast || this.shadowRoot.querySelector("#valueMappingToast");
                    return this._valueMappingToast;
                },

                get mappingGrid() {
                    this._mappingGrid = this._mappingGrid || this.shadowRoot.querySelector("#mapping-grid");
                    return this._mappingGrid;
                },

                get liquidReferenceManageModelGet() {
                    this._liquidReferenceManageModelGet = this._liquidReferenceManageModelGet || this.shadowRoot.querySelector("[name=liquidReferenceManageModelGet]");
                    return this._liquidReferenceManageModelGet;
                },

                get dimensionSelector() {
                    this._dimensionSelector = this._dimensionSelector || this.shadowRoot.querySelector("#valueDimensionSelector");
                    return this._dimensionSelector;
                },

                _onMappingsDataChange: function () {
                    if (!_.isEmpty(this.contextData) && !_.isEmpty(this.mappingData) && !_.isEmpty(this.mappingConfig) && !_.isEmpty(this.copContext)) {
                        this._loading = true;
                        this._taxonomies = this.mappingData.taxonomies;
                        this._contexts = this.mappingData.contexts;

                        var attributeMappingSelectedDimensions = {};
                        for (var i = 0; i < this._contexts.length; i++) {
                            attributeMappingSelectedDimensions[this._contexts[i]] = this.mappingData.selectedDimensions[this._contexts[i]];
                        }

                        var valueMappingContexts = this._getAdditionalContexts();
                        this._allContexts = this._contexts.concat(valueMappingContexts);
                        //Load dimensions based on mapping information
                        if (this.dimensionSelector) {
                            this.dimensionSelector.dynamicDimensionsConfig = {
                                "selectedDimensions": attributeMappingSelectedDimensions,
                                "readonlyDimensions": this._contexts,
                                "contextDimensions": valueMappingContexts
                            }
                        }

                        var types = [this.mappingData.attribute];
                        var attributes = ['externalName'];

                        const attributeModelRequest = DataRequestHelper.createGetAttributeModelRequest(types, attributes);

                        if (this.liquidAttributeModelGetLiq) {
                            this.liquidAttributeModelGetLiq.requestData = attributeModelRequest;
                            this.liquidAttributeModelGetLiq.generateRequest();
                        }
                    }
                },

                _getAdditionalContexts: function () {
                    var additionalContexts = [];
                    if (this.mappingData.valueMappingContext) {
                        var mappingContexts = (this.mappingData.valueMappingContext instanceof Array) ? this.mappingData.valueMappingContext : [this.mappingData.valueMappingContext];
                        mappingContexts.forEach(function (context) {
                            if (!(context.startsWith("[") && context.endsWith("]"))) {
                                additionalContexts.push(context);
                            }
                        }, this);
                    }

                    return additionalContexts;
                },

                _onAttributeModelGetResponse: function (e, detail) {
                    var response = e.detail.response;
                    if (response.content && !_.isEmpty(response.content.entityModels)) {
                        this._attributeModel = response.content.entityModels[0];
                        this._attributeTitle = this._attributeModel.properties.externalName;

                        //Set LOV request
                        if (this._attributeModel.properties.referenceEntityInfo) {
                            this._isReferenceField = true;
                            var refInfo = this._attributeModel.properties.referenceEntityInfo;
                            var types = [refInfo[0].refEntityType];
                            this._referenceLOVRequest = DataRequestHelper.createGetReferenceRequest(this.contextData, types);

                            //Before setting the reference request to LOV, set LOV title pattern
                            var ids = [refInfo[0].refEntityType];
                            var referenceModelRequest = DataRequestHelper.createGetManageModelRequest(ids);

                            if (this.liquidReferenceManageModelGet) {
                                this.liquidReferenceManageModelGet.requestData = referenceModelRequest;
                                this.liquidReferenceManageModelGet.generateRequest();
                            }
                        } else {
                            //Get Mappings
                            this._getMappings();
                        }
                    }
                },

                // This is to set title pattern, success/error - process will not stop
                _onReferenceManageModelGetResponse: function (e, detail) {
                    if (detail && detail.response && detail.response.status == "success") {
                        if (DataHelper.isValidObjectPath(detail, "response.content.entityModels.0.data.attributes")) {
                            var attributes = detail.response.content.entityModels[0].data.attributes;
                            var lov = this.referenceLOV;

                            for (var key in attributes) {
                                if (attributes[key].properties.isExternalName) {
                                    if (lov) {
                                        lov.titlePattern = "{" + key + "}";
                                    }
                                    break;
                                }
                            }
                        }
                    }
                    this.set("_lovRequestData", this._referenceLOVRequest);
                    this._getMappings();
                },

                //Issue in setting title pattern, no need to stop the process
                _onReferenceManageModelGetError: function (e, detail) {
                    this.set("_lovRequestData", this._referenceLOVRequest);
                    this._getMappings();
                },

                _getMappings: function () {
                    //To-do: Contexts hardcoded here, will be removed once context header logic is implemented
                    this.selectedContexts = this._prepareContexts(this._allContexts);
                    var types = [this.mappingData.valueMappingTypeName];

                    var req = DataRequestHelper.createMappingsGetRequest(this.contextData, this.copContext, this.selectedContexts, types, this.selectedOptions, "valueMapping");
                    req.params.query.contexts[0]["Ownership Data"] = this.selectedOptions.ownershipData;
                    delete req.params.query.contexts[0].service;

                    this._sendMappingRequest(req);
                },

                _onAttributeModelError: function (e, detail) {
                    this.logError("Entity attribute model get error", detail);
                    this._showToast("error", "Error", "Unable to get entity attribute model, please contact administrator.");
                    this._loading = false;
                },

                _onGetMappingsResponse: function (e, detail) {
                    if (!this._isValidResponseStatus(detail)) {
                        this._showToast("error", "Error", "Unable to fetch value mappings, please contact administrator.");
                        this._loading = false;
                        return;
                    }

                    var response = detail.response.response;
                    var gridData = [];
                    if (response.entities) {
                        if (response.entities.length > 0) {
                            this._valueMappingEntities = this._getContextSpecificValueMappings(response.entities);

                            var index = 0;
                            for (var i = 0; i < this._valueMappingEntities.length; i++) {
                                if (DataHelper.isValidObjectPath(this._valueMappingEntities[i], "data.contexts.0.attributes")) {
                                    var mappingAttributes = this._valueMappingEntities[i].data.contexts[0].attributes;
                                    if (mappingAttributes.attributevalue && mappingAttributes.mappedvalue) {
                                        var attrValue = mappingAttributes.attributevalue.values[0].value;
                                        for (var j = 0; j < mappingAttributes.mappedvalue.values.length; j++) {
                                            gridData.push({
                                                "givenValue": mappingAttributes.mappedvalue.values[j].value,
                                                "governedValue": attrValue,
                                                "source": "system",
                                                "action": "",
                                                "index": index
                                            });
                                            index++;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    this.set("_gridData", gridData);
                    this._loading = false;
                },

                _getContextSpecificValueMappings: function (mappingEntities) {
                    var contextSpecificMappings = [];
                    if (mappingEntities && mappingEntities.length) {
                        for (var i = 0; i < mappingEntities.length; i++) {
                            if (DataHelper.isValidObjectPath(mappingEntities[i], "data.contexts.0.context")) {
                                var context = mappingEntities[i].data.contexts[0].context;
                                var isMatched = true;
                                for (var j = 0; j < this.selectedContexts.length; j++) {
                                    if (context[this.selectedContexts[j].type] != this.selectedContexts[j].value) {
                                        isMatched = false;
                                        break;
                                    }
                                }

                                if (isMatched) {
                                    contextSpecificMappings.push(mappingEntities[i]);
                                }
                            }
                        }
                    }

                    return contextSpecificMappings;
                },

                _onCancelTap: function () {
                    this.currentEventName = "value-mapping-cancel";
                    RUFBehaviors.MappingGridBehaviorImpl._triggerDirtyCheck.call(this, "value");
                },

                _discardValueChanges: function () {
                    RUFBehaviors.MappingGridBehaviorImpl._triggerEvent.call(this);
                },

                _showReferenceLOV: function (e) {
                    var rowId = e.currentTarget.rowId;
                    if (rowId >= 0) {
                        var lov = this.referenceLOV;
                        var popover = this.referencePopoverEl;
                        if (lov && popover) {
                            lov.currentRowId = rowId;
                            popover.for = "govern-text_" + rowId;
                            popover.show();
                            lov.reset();
                        }
                    }
                },

                _onReferenceSelection: function (e, detail) {
                    var lov = this.referenceLOV;
                    if (lov) {
                        var rowId = lov.currentRowId;
                        if (rowId >= 0) {
                            this._setGovernValue(rowId, detail.data);
                        }
                    }
                    var popover = this.referencePopoverEl;
                    if (popover) {
                        popover.for = "";
                        popover.hide();
                    }
                },

                //Triggers for non reference field
                _onGovernTextChange: function (e, detail) {
                    var governText = {
                        "title": e.target.value
                    }
                    this._setGovernValue(e.target.rowId, governText);
                },

                _setGovernValue: function (rowId, data) {
                    var governTxtbox = this.root.querySelector("#govern-text_" + rowId);
                    if (!governTxtbox) {
                        governTxtbox = this.shadowRoot.querySelector("#govern-text_" + rowId);
                    }
                    if (governTxtbox) {
                        var row = this._getParentRow(governTxtbox)
                        this._setRowAsDeletedOnSelectionChange(DataHelper.cloneObject(row.item));
                        if (row) {
                            row.item.attributeModel = data;
                            if (row.item["action"] != "new") {
                                row.item["action"] = "updated";
                            }
                            row.item["governedValue"] = data.title;
                            governTxtbox.value = data.title;
                            governTxtbox.title = data.title;
                            this._isMappingChanged = true;
                        }
                    }
                },

                _setRowAsDeletedOnSelectionChange: function (row) {
                    row.action = "deleted";
                    this._refChangeDeletedMappings.push(row);
                },

                _onAddTap: function () {
                    RUFBehaviors.MappingGridBehaviorImpl._onAddTap.call(this, {
                        "givenValue": "",
                        "governedValue": "",
                    });
                },

                _onDeleteTap: function () {
                    RUFBehaviors.MappingGridBehaviorImpl._onDeleteTap.call(this, (gridDataItem, selectedItem) => {
                        return gridDataItem.givenValue === selectedItem.givenValue
                    });
                },

                _getParentRow: function (element) {
                    if (element) {
                        if (element.is == "data-table-row") {
                            return element;
                        } else {
                            return this._getParentRow(element.parentNode);
                        }
                    }
                    return undefined;
                },

                _onGivenTextChange: function (e, detail) {
                    var rowId = e.currentTarget.rowId;
                    if (rowId >= 0) {
                        var givenTxtbox = this.root.querySelector("#given-value_" + rowId);
                        if (!givenTxtbox) {
                            givenTxtbox = this.shadowRoot.querySelector("#given-value_" + rowId);
                        }
                        if (givenTxtbox) {
                            var row = this._getParentRow(givenTxtbox)
                            if (row) {
                                if (row.item["action"] != "new") {
                                    row.item["action"] = "updated";
                                }
                                this._isMappingChanged = true;
                            }
                        }
                    }
                },

                _isDuplicateGridDataAvailable: function () {
                    var uniqueGivenValues = [...new Set(this._gridData.map((obj) => obj.givenValue))];

                    return this._gridData.length != uniqueGivenValues.length;
                },

                _onSaveAndGobackTap: function () {
                    this.isSaveAndGoback = true;
                    this._onSaveTap();
                },

                _onSaveTap: function () {
                    if (this._isDuplicateGridDataAvailable()) {
                        this._showToast("error", "Error", "Please provide unique given values.");
                        return;
                    }
                    this._loading = true;
                    var mappings = this._transformGridDataToSaveMappings();
                    var saveRequests = [];
                    if (!_.isEmpty(mappings)) {
                        for (var key in mappings) {
                            var saveRequest = DataRequestHelper.createMappingsSaveRequest(this.contextData, this.copContext, this.selectedContexts, this.mappingData.valueMappingTypeName, this.selectedOptions, "valueMapping");
                            saveRequest.entity.data.contexts[0].attributes = mappings[key];
                            saveRequest.entity.data.contexts[0].context["Ownership Data"] = this.selectedOptions.ownershipData;
                            delete saveRequest.entity.data.contexts[0].context.service;

                            if (mappings[key].action == "delete") {
                                saveRequest.entity.action = "delete";

                                var attributes = saveRequest.entity.data.contexts[0].attributes;
                                delete attributes.action;
                                for (var attrkey in attributes) {
                                    if (attributes[attrkey]) {
                                        attributes[attrkey].action = "delete";
                                    }
                                }
                            }

                            saveRequest.entity.id = this._getValueMappingId(key);
                            saveRequests.push(saveRequest);
                        }

                        var saveMappings = this.shadowRoot.querySelector("#saveMappings");
                        if (saveMappings) {
                            this._generatedRequestCount = 0;
                            for (var i = 0; i < saveRequests.length; i++) {
                                saveMappings.requestData = saveRequests[i];
                                this._generatedRequestCount++;
                                saveMappings.generateRequest();
                            }
                        }
                    } else {
                        this._showToast("success", "Success", "There are no changes in mappings to save.");
                        this._loading = false;
                    }
                },

                _showToast: function (toastType, heading, toastMessage) {
                    if (this.valueMappingToast) {
                        this.valueMappingToast.toastType = toastType;
                        this.valueMappingToast.heading = heading;
                        this.toastText = toastMessage
                        this.valueMappingToast.show();
                    }
                },

                _getValueMappingId: function (key) {
                    if (this._valueMappingEntities && this._valueMappingEntities.length > 0) {
                        for (var i = 0; i < this._valueMappingEntities.length; i++) {
                            if (DataHelper.isValidObjectPath(this._valueMappingEntities, i + ".data.contexts.0.attributes")) {
                                var mappingAttributes = this._valueMappingEntities[i].data.contexts[0].attributes;
                                if (!_.isEmpty(mappingAttributes) && mappingAttributes.attributevalue.values[0].value == key) {
                                    return this._valueMappingEntities[i].id;
                                }
                            }
                        }
                    }

                    //Generate guid and send
                    return DataHelper.generateUUID();
                },

                _onMappingsSaveResponse: function (e, detail) {
                    if (DataHelper.isValidObjectPath(detail, "response.response.status") &&
                        detail.response.response.status.toLowerCase() == "success") {
                        this.isSuccess = true;
                    } else {
                        this.isFailed = true;
                    }

                    if (--this._generatedRequestCount == 0) {
                        if (this.isSuccess && !this.isFailed) {
                            this._resetMappings();
                            if (this.isSaveAndGoback) {
                                this._onCancelTap();
                                this.showSuccessToast("Value mappings submitted successfully.");
                                this.isSaveAndGoback = false;
                            } else {
                                this._showToast("success", "Success", "Value mappings submitted successfully.");
                            }
                        } else if (!this.isSuccess && this.isFailed) {
                            this._showToast("error", "Error", "Unable to save value mappings, please contact administrator.");
                        } else {
                            this._resetMappings();
                            if (this.isSaveAndGoback) {
                                this._onCancelTap();
                                this.showWarningToast("Value mappings processed with errors.");
                                this.isSaveAndGoback = false;
                            } else {
                                this._showToast("warning", "Warning", "Value mappings processed with errors.");
                            }
                        }
                        this._loading = false;
                    }
                },

                _resetMappings: function () {
                    this._deletedMappings = [];
                    this._refChangeDeletedMappings = [];
                    this._isMappingChanged = false;
                    for (var i = 0; i < this._gridData.length; i++) {
                        this._gridData[i].action = "";
                    }
                },

                _transformGridDataToSaveMappings: function () {
                    var mappings = {};
                    var self = this;
                    //For updated and new
                    this._gridData.forEach(function (row) {
                        if (row.action == "updated" || row.action == "new") {
                            if (row.givenValue && row.governedValue) {
                                var value = self._populateMappingValue(row.givenValue);
                                if (mappings[row.governedValue]) {
                                    mappings[row.governedValue].mappedvalue.values.push(value);
                                } else {
                                    var attrValue = self._populateMappingValue(row.governedValue);
                                    mappings[row.governedValue] = {
                                        "attributevalue": {
                                            "values": [attrValue]
                                        },
                                        "mappedvalue": {
                                            "values": [value]
                                        }
                                    }
                                }
                            }
                        }
                    });

                    //Deleted mappings on reference change
                    for (var i = 0; i < this._refChangeDeletedMappings.length; i++) {
                        var isFound = false;
                        for (var key in mappings) {
                            if (this._refChangeDeletedMappings[i] &&
                                this._refChangeDeletedMappings[i].governedValue == key) {
                                isFound = true;
                                break;
                            }
                        }

                        if (!isFound) {
                            this._deletedMappings.push(this._refChangeDeletedMappings[i]);
                        }
                    }

                    //For delete
                    this._deletedMappings.forEach(function (row) {
                        if (row.givenValue && row.governedValue) {
                            var value = self._populateMappingValue(row.givenValue);
                            value.action = "delete";
                            if (mappings[row.governedValue]) {
                                mappings[row.governedValue].mappedvalue.values.push(value);
                            } else {
                                var attrValue = self._populateMappingValue(row.governedValue);
                                mappings[row.governedValue] = {
                                    "action": "delete",
                                    "attributevalue": {
                                        "values": [attrValue]
                                    },
                                    "mappedvalue": {
                                        "values": [value]
                                    }
                                }
                            }
                        }
                    });


                    //Modified above having untouched mappings
                    this._gridData.forEach(function (row) {
                        if (row.action == "" && row.givenValue && row.governedValue) {
                            if (mappings[row.governedValue]) {
                                var value = self._populateMappingValue(row.givenValue);
                                if (mappings[row.governedValue].action == "delete") {
                                    for (var i = 0; i < mappings[row.governedValue].mappedvalue.values.length; i++) {
                                        mappings[row.governedValue].mappedvalue.values[i].action = "delete";
                                    }
                                    delete mappings[row.governedValue].action;
                                    mappings[row.governedValue].mappedvalue.values.push(value);
                                } else {
                                    mappings[row.governedValue].mappedvalue.values.push(value);
                                }
                            }
                        }
                    });

                    return mappings;
                },

                _populateMappingValue: function (value) {
                    const { source, locale } = ContextHelper.getFirstValueContext(this.contextData);

                    return { source, locale, value };
                },

                _getGridRecordsCountMessage: function () {
                    if (!this._gridData || this._gridData.length == 0) {
                        return "Showing 0 results";
                    }

                    return "Showing 1 - " + this._gridData.length + " items of total " + this._gridData.length + " results";
                },

                _onDimensionsChanged: function (e, detail) {
                    RUFBehaviors.MappingGridBehaviorImpl._onDimensionsChanged.call(this, e, detail);
                }
            });
        })();
    </script>
</dom-module>