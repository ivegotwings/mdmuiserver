<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ruf-ui-card/ruf-ui-card.html">
<link rel="import" href="../paper-button/paper-button.html">

<!--
` <ruf-ui-widget> ` Represents a card which is configurable by a JSON config.
  The config can have details about the component to be used within widget, buttons and icons.
  Widgets are normally used on dashboard type of apps.

@demo demo/index.html 
-->

<dom-module id="ruf-ui-widget">
  <template>
    <style include="shared-styles"></style>

    <ruf-ui-card id="card" heading="[[_heading]]" header-icon="[[_headerIcon]]">
      <div class="card-content" id="content">

      </div>
      <div class="card-actions" id="actions">
      </div>
    </ruf-ui-card>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'ruf-ui-widget',
        
        //ready: function() {
        //  this._removeComponent();
        //  this._renderComponent();          
        //},
        
        properties: {
          /**
           * Indicates the configuration for the widget.
           * 
					 */
          config: {
            type: Object,
            value: function(){
              return {};
            },
            observer: '_configChanged'
          },
          /**
           * This is a private property and should not be used directly. This is bound to config.component.
           * Indicates the component to be shown in the card. It is a JSON with information about the component.
           * 
					 */
          _component: {
            type: Object,
            value: function() {
              return {};
            },
            observer: '_componentChanged'
          },
          /**
           * This is a private property and should not be used directly. This is bound to config.buttons.
           * Indicates the action buttons to be shown in bottom action area of the card.
           * 
					 */
          _buttons: {
            type: Array,
            value: function() {
              return [];
            },
            observer: '_buttonsChanged'
          },
          /**
           * This is a private property and should not be used directly. This is bound to config.buttons.
           * Indicates title of the card.
           * 
					 */
          _heading: {
            type: String,
            value: "Widget title"
          },
          /**
           * This is a private property and should not be used directly. This is bound to config.buttons.
           * Indicates the url of the title image of the card.
           * 
           */
          _headerIcon: {
            type: String,
            value: "icons:dashboard"
          }
        },

        _renderComponent: function(){
          if(this._component && this._component.path) {
            this.importHref(this._component.path, 
              function (e) {
                //component file import successful
                var dynamicEl = document.createElement(this._component.name);
                for (var property in this._component.properties) {
                  if (this._component.properties.hasOwnProperty(property)) {
                    var val = this._component.properties[property];
                    if (typeof val == "object") {
                      dynamicEl.setAttribute(property, JSON.stringify(val));
                    }
                    else {
                      dynamicEl.setAttribute(property, val);
                    }
                  }
                }
                dynamicEl.setAttribute("id", "component");
                dynamicEl.setAttribute("class", dynamicEl.getAttribute("class") + " widget-component");
                Polymer.dom(this.$.content).appendChild(dynamicEl);
              },
              function (e) {
                //component file import failed
                //TODO: log this
              }
            );
          }
        },

         _renderButtons: function(){
          if(this._buttons) {
            //debugger;
            for(var i = 0;i<this._buttons.length;i++) {
              var b = this._buttons[i];
              var dynamicButton = document.createElement('paper-button');
              dynamicButton.name = b.name;
              dynamicButton.innerText = b.label;
              dynamicButton.setAttribute("click-handler", b.onClick);
              this.listen(dynamicButton, "click", "_onButtonClick");
              //dynamicButton.setAttribute("raised","");
              Polymer.dom(this.$.actions).appendChild(dynamicButton);
            }
          }
        },

        _removeComponent: function(){
          var contentElement = this.$.content;
          while (contentElement.firstChild) {
            Polymer.dom(contentElement).removeChild(contentElement.firstChild);
          }
        },

         _removeButtons: function(){
          var actionsElement = this.$.actions;
          while (actionsElement.firstChild) {
            Polymer.dom(actionsElement).removeChild(actionsElement.firstChild);
          }
        },

        _componentChanged: function(){
          this._removeComponent();
          this._renderComponent();
        },

        _buttonsChanged: function(){
          this._removeButtons();
          this._renderButtons();
        },

        _configChanged: function() {
          //this._removeComponent();
          //this._removeButtons();
          
          //this._renderComponent();
          //this._renderButtons();
          this._component = this.config.component;
          this._buttons = this.config.buttons;
          this._heading = this.config.heading;
          this._headerIcon = this.config.headerIcon;
        },

        _onButtonClick: function(e){
          if(e.target && e.target){
            var clickHandler = e.target.getAttribute("click-handler");
            if(clickHandler){
              var c = this.querySelector("#component");
              if(c && c[clickHandler]){
                c[clickHandler].apply(c, [{"widget":this}]);
              }
              else if(window[clickHandler]){
                window[clickHandler].apply(window, [{"widget":this}]);
              }
            } 
          }
        }

      });
    })();
  </script>

</dom-module>